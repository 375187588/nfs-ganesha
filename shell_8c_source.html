<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>nfs-ganesha: shell.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nfs-ganesha&#160;<span id="projectnumber">1.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>shell.c</h1>  </div>
</div>
<div class="contents">
<a href="shell_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
<a name="l00005"></a>00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
<a name="l00006"></a>00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00010"></a>00010 <span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
<a name="l00011"></a>00011 <span class="comment"> * License as published by the Free Software Foundation; either</span>
<a name="l00012"></a>00012 <span class="comment"> * version 3 of the License, or (at your option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00017"></a>00017 <span class="comment"> * Lesser General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<a name="l00020"></a>00020 <span class="comment"> * License along with this library; if not, write to the Free Software</span>
<a name="l00021"></a>00021 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ---------------------------------------</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00094"></a>00094 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span><span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00096"></a>00096 <span class="preprocessor">#endif</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00098"></a>00098 <span class="preprocessor">#ifdef _SOLARIS</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="preprocessor">#include &quot;solaris_port.h&quot;</span>
<a name="l00100"></a>00100 <span class="preprocessor">#endif</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>
<a name="l00102"></a>00102 <span class="preprocessor">#include &quot;<a class="code" href="shell_8h.html" title="Internal routines for the shell.">shell.h</a>&quot;</span>
<a name="l00103"></a>00103 <span class="preprocessor">#include &quot;<a class="code" href="shell__utils_8h.html" title="Miscellaneous build-in commands for shell.">shell_utils.h</a>&quot;</span>
<a name="l00104"></a>00104 <span class="preprocessor">#include &quot;<a class="code" href="shell__vars_8h.html" title="variables management for the shell.">shell_vars.h</a>&quot;</span>
<a name="l00105"></a>00105 <span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00106"></a>00106 <span class="preprocessor">#include &quot;<a class="code" href="commands_8h.html" title="Header file for processing user&amp;#39;s command line.">commands.h</a>&quot;</span>
<a name="l00107"></a>00107 <span class="preprocessor">#include &quot;<a class="code" href="cmd__tools_8h.html" title="Header file for functions used by several layers.">cmd_tools.h</a>&quot;</span>
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="preprocessor">#include &quot;abstract_mem.h&quot;</span>
<a name="l00110"></a>00110 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00111"></a>00111 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00114"></a>00114 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="preprocessor">#ifdef HAVE_LIBREADLINE</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span><span class="preprocessor">#include &lt;readline/readline.h&gt;</span>
<a name="l00118"></a>00118 <span class="preprocessor">#include &lt;readline/history.h&gt;</span>
<a name="l00119"></a>00119 <span class="preprocessor">#endif</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>
<a name="l00121"></a>00121 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00122"></a>00122 <span class="preprocessor">#include &quot;<a class="code" href="shell_8h.html" title="Internal routines for the shell.">shell.h</a>&quot;</span>
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="shell_8c.html#a6f47cadd2e292d89353544ae32672e9b">00124</a> <span class="preprocessor">#define MAX_OUTPUT_LEN  (1024*1024)     </span><span class="comment">/* 1MB */</span>
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">00126</a> <span class="preprocessor">#define TRACEBUFFSIZE 1024</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span>
<a name="l00128"></a><a class="code" href="shell_8c.html#ae42811a75f9b628dda3bc808b0964bef">00128</a> <span class="preprocessor">#define PROMPTSIZE 64</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>
<a name="l00130"></a><a class="code" href="shell_8c.html#ae751cf5f3c0928b64ffd28ab9b1fe17d">00130</a> <a class="code" href="structlayer__def____.html">layer_def_t</a> <a class="code" href="commands_8h.html#ae751cf5f3c0928b64ffd28ab9b1fe17d">layer_list</a>[] = {
<a name="l00131"></a>00131   {<span class="stringliteral">&quot;FSAL&quot;</span>, commands_FSAL, <span class="stringliteral">&quot;File system abstraction layer&quot;</span>, <a class="code" href="commands_8h.html#a8d06115f7aed032f29bab10e1bafc79e">fsal_layer_SetLogLevel</a>}
<a name="l00132"></a>00132   ,
<a name="l00133"></a>00133   {<span class="stringliteral">&quot;Cache_inode&quot;</span>, commands_Cache_inode, <span class="stringliteral">&quot;Cache inode layer&quot;</span>, <a class="code" href="commands_8h.html#a7440aeb3677f16a9616c85a5c6734c53">Cache_inode_layer_SetLogLevel</a>}
<a name="l00134"></a>00134   ,
<a name="l00135"></a>00135   {<span class="stringliteral">&quot;NFS&quot;</span>, commands_NFS,
<a name="l00136"></a>00136    <span class="stringliteral">&quot;NFSv2, NFSv3, MNTv1, MNTv3 protocols (direct calls, not through RPCs)&quot;</span>,
<a name="l00137"></a>00137    <a class="code" href="commands_8h.html#ab887a5c5a0911df2c6be04b92c3a9693">nfs_layer_SetLogLevel</a>}
<a name="l00138"></a>00138   ,
<a name="l00139"></a>00139   {<span class="stringliteral">&quot;NFS_remote&quot;</span>, commands_NFS_remote,
<a name="l00140"></a>00140    <span class="stringliteral">&quot;NFSv2, NFSv3, MNTv1, MNTv3 protocols (calls through RPCs)&quot;</span>,
<a name="l00141"></a>00141    <a class="code" href="commands_8h.html#aafddec7649e50bfe452db28ba44df4b7">nfs_remote_layer_SetLogLevel</a>}
<a name="l00142"></a>00142   ,
<a name="l00143"></a>00143   {<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}      <span class="comment">/* End of layer list */</span>
<a name="l00144"></a>00144 };
<a name="l00145"></a>00145 
<a name="l00146"></a><a class="code" href="shell_8h.html#a1e3eb6c0416edacc075dcb2c77cba33d">00146</a> <span class="keywordtype">char</span> *<a class="code" href="shell_8c.html#a1e3eb6c0416edacc075dcb2c77cba33d">shell_special_vars</a>[] = {
<a name="l00147"></a>00147   <span class="stringliteral">&quot;INPUT&quot;</span>,                      <span class="comment">/* a filename or &lt;stdin&gt; */</span>
<a name="l00148"></a>00148   <span class="stringliteral">&quot;INTERACTIVE&quot;</span>,                <span class="comment">/* Indicates if we are in interactive mode */</span>
<a name="l00149"></a>00149   <span class="stringliteral">&quot;LAYER&quot;</span>,                      <span class="comment">/* The current layer */</span>
<a name="l00150"></a>00150   <span class="stringliteral">&quot;STATUS&quot;</span>,                     <span class="comment">/* Last command status */</span>
<a name="l00151"></a>00151   <span class="stringliteral">&quot;?&quot;</span>,                          <span class="comment">/* idem */</span>
<a name="l00152"></a>00152   <span class="stringliteral">&quot;VERBOSE&quot;</span>,                    <span class="comment">/* shel verbose mode */</span>
<a name="l00153"></a>00153   <span class="stringliteral">&quot;DEBUG_LEVEL&quot;</span>,                <span class="comment">/* layer debug level */</span>
<a name="l00154"></a>00154   <span class="stringliteral">&quot;DBG_LVL&quot;</span>,                    <span class="comment">/* idem */</span>
<a name="l00155"></a>00155   <span class="stringliteral">&quot;PROMPT&quot;</span>,                     <span class="comment">/* shell prompt string */</span>
<a name="l00156"></a>00156   <span class="stringliteral">&quot;LINE&quot;</span>,                       <span class="comment">/* line number */</span>
<a name="l00157"></a>00157 
<a name="l00158"></a>00158   <span class="comment">/* end of special vars list */</span>
<a name="l00159"></a>00159   <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>
<a name="l00160"></a>00160 };
<a name="l00161"></a>00161 
<a name="l00162"></a><a class="code" href="shell__utils_8h.html#a089ef543a695145d27ee13a0de2de5ff">00162</a> <a class="code" href="structcommand__def____.html">command_def_t</a> <a class="code" href="shell_8c.html#a089ef543a695145d27ee13a0de2de5ff">shell_utils</a>[] = {
<a name="l00163"></a>00163   {<span class="stringliteral">&quot;chomp&quot;</span>, <a class="code" href="shell__utils_8c.html#a130d242ced379ff25933763aee359d57">util_chomp</a>, <span class="stringliteral">&quot;removes final newline character&quot;</span>},
<a name="l00164"></a>00164   {<span class="stringliteral">&quot;cmp&quot;</span>, <a class="code" href="shell__utils_8c.html#a754defd5bd4e132367311c66a24cad37">util_cmp</a>, <span class="stringliteral">&quot;compares two expressions&quot;</span>},
<a name="l00165"></a>00165   {<span class="stringliteral">&quot;diff&quot;</span>, <a class="code" href="shell__utils_8c.html#a6bbfa47494a1c3e97da846d9f13f3b37">util_diff</a>, <span class="stringliteral">&quot;lists differences between two expressions&quot;</span>},
<a name="l00166"></a>00166   {<span class="stringliteral">&quot;eq&quot;</span>, <a class="code" href="shell__utils_8c.html#a754defd5bd4e132367311c66a24cad37">util_cmp</a>, <span class="stringliteral">&quot;test if two expressions are equal&quot;</span>},
<a name="l00167"></a>00167   {<span class="stringliteral">&quot;meminfo&quot;</span>, <a class="code" href="shell__utils_8c.html#ab2d1ea3efaa7218132667586f0460f3d">util_meminfo</a>, <span class="stringliteral">&quot;prints information about memory use&quot;</span>},
<a name="l00168"></a>00168   {<span class="stringliteral">&quot;ne&quot;</span>, <a class="code" href="shell__utils_8c.html#a754defd5bd4e132367311c66a24cad37">util_cmp</a>, <span class="stringliteral">&quot;test if two expressions are different&quot;</span>},
<a name="l00169"></a>00169   {<span class="stringliteral">&quot;shell&quot;</span>, <a class="code" href="shell__utils_8c.html#a58578fd669f6ac47e240d06a8217cafc">util_shell</a>, <span class="stringliteral">&quot;executes a real shell command&quot;</span>},
<a name="l00170"></a>00170   {<span class="stringliteral">&quot;sleep&quot;</span>, <a class="code" href="shell__utils_8c.html#a1cf2ea68f1bafc25b6735846c43c92d5">util_sleep</a>, <span class="stringliteral">&quot;suspends script execution for some time&quot;</span>},
<a name="l00171"></a>00171   {<span class="stringliteral">&quot;timer&quot;</span>, <a class="code" href="shell__utils_8c.html#a68219f713469884b52e536b92ef7ba66">util_timer</a>, <span class="stringliteral">&quot;timer management command&quot;</span>},
<a name="l00172"></a>00172   {<span class="stringliteral">&quot;wc&quot;</span>, <a class="code" href="shell__utils_8c.html#a4b9d29ad580c7f91d4e3defd0b571343">util_wc</a>, <span class="stringliteral">&quot;counts the number of char/words/lines in a string&quot;</span>},
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   {<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}            <span class="comment">/* End of command list */</span>
<a name="l00175"></a>00175 };
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="comment">/* ------------------------------------------*</span>
<a name="l00178"></a>00178 <span class="comment"> *        Barrier management.</span>
<a name="l00179"></a>00179 <span class="comment"> * ------------------------------------------*/</span>
<a name="l00180"></a>00180 
<a name="l00181"></a><a class="code" href="shell_8c.html#ae172479c6020b4423ab780e5c8564f8e">00181</a> <span class="preprocessor">#define P_shell( _mutex_ ) pthread_mutex_lock( &amp;_mutex_ )</span>
<a name="l00182"></a><a class="code" href="shell_8c.html#ac466c2b8b870c7e053fd39d73e4c35f4">00182</a> <span class="preprocessor"></span><span class="preprocessor">#define V_shell( _mutex_ ) pthread_mutex_unlock( &amp;_mutex_ )</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>
<a name="l00184"></a>00184 <span class="comment">/* variables for managing barriers */</span>
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="comment">/* barrier protection */</span>
<a name="l00187"></a>00187 <span class="keyword">static</span> pthread_mutex_t barrier_mutex = PTHREAD_MUTEX_INITIALIZER;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment">/* condition for crossing barrier */</span>
<a name="l00190"></a>00190 <span class="keyword">static</span> pthread_cond_t barrier_cond = PTHREAD_COND_INITIALIZER;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192 <span class="comment">/* total number of threads to wait for */</span>
<a name="l00193"></a>00193 <span class="keyword">static</span> <span class="keywordtype">int</span> total_nb_threads = -1;       <span class="comment">/* -1 = not initialized */</span>
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="comment">/* number of threads that reached the barrier */</span>
<a name="l00196"></a>00196 <span class="keyword">static</span> <span class="keywordtype">int</span> nb_waiting_threads = 0;
<a name="l00197"></a>00197 
<a name="l00202"></a><a class="code" href="shell_8h.html#ae15db0838c4622e178a261efb83bf2b1">00202</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#ae15db0838c4622e178a261efb83bf2b1">shell_BarrierInit</a>(<span class="keywordtype">int</span> nb_threads)
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204 
<a name="l00205"></a>00205   <a class="code" href="shell_8c.html#ae172479c6020b4423ab780e5c8564f8e">P_shell</a>(barrier_mutex);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="keywordflow">if</span>(total_nb_threads == -1)
<a name="l00208"></a>00208     {
<a name="l00209"></a>00209       total_nb_threads = nb_threads;
<a name="l00210"></a>00210       <a class="code" href="shell_8c.html#ac466c2b8b870c7e053fd39d73e4c35f4">V_shell</a>(barrier_mutex);
<a name="l00211"></a>00211       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213   <span class="keywordflow">else</span>
<a name="l00214"></a>00214     {
<a name="l00215"></a>00215       <a class="code" href="shell_8c.html#ac466c2b8b870c7e053fd39d73e4c35f4">V_shell</a>(barrier_mutex);
<a name="l00216"></a>00216       printf(<span class="stringliteral">&quot;ganeshell: Error: Barrier already initialized\n&quot;</span>);
<a name="l00217"></a>00217       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 <span class="keyword">static</span> <span class="keywordtype">int</span> shell_BarrierWait()
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <a class="code" href="shell_8c.html#ae172479c6020b4423ab780e5c8564f8e">P_shell</a>(barrier_mutex);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   <span class="comment">/* not used in a single thread environment */</span>
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="keywordflow">if</span>(total_nb_threads == -1)
<a name="l00229"></a>00229     {
<a name="l00230"></a>00230       <a class="code" href="shell_8c.html#ac466c2b8b870c7e053fd39d73e4c35f4">V_shell</a>(barrier_mutex);
<a name="l00231"></a>00231       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234   <span class="comment">/* increase number of waiting threads */</span>
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   nb_waiting_threads++;
<a name="l00237"></a>00237 
<a name="l00238"></a>00238   <span class="comment">/* test for condition */</span>
<a name="l00239"></a>00239 
<a name="l00240"></a>00240   <span class="keywordflow">if</span>(nb_waiting_threads == total_nb_threads)
<a name="l00241"></a>00241     {
<a name="l00242"></a>00242       <span class="comment">/* reset the number of waiting threads */</span>
<a name="l00243"></a>00243       nb_waiting_threads = 0;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245       <span class="comment">/* wake up all threads */</span>
<a name="l00246"></a>00246       pthread_cond_broadcast(&amp;barrier_cond);
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249   <span class="keywordflow">else</span>
<a name="l00250"></a>00250     pthread_cond_wait(&amp;barrier_cond, &amp;barrier_mutex);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252   <span class="comment">/* leaves the critical section */</span>
<a name="l00253"></a>00253 
<a name="l00254"></a>00254   <a class="code" href="shell_8c.html#ac466c2b8b870c7e053fd39d73e4c35f4">V_shell</a>(barrier_mutex);
<a name="l00255"></a>00255 
<a name="l00256"></a>00256   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 <span class="comment">/* ------------------------------------------*</span>
<a name="l00261"></a>00261 <span class="comment"> *        Thread safety management.</span>
<a name="l00262"></a>00262 <span class="comment"> * ------------------------------------------*/</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="comment">/* threads keys */</span>
<a name="l00265"></a>00265 <span class="keyword">static</span> pthread_key_t thread_key;
<a name="l00266"></a>00266 <span class="keyword">static</span> pthread_once_t once_key = PTHREAD_ONCE_INIT;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 <span class="comment">/* init pthtread_key for current thread */</span>
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 <span class="keyword">static</span> <span class="keywordtype">void</span> init_keys(<span class="keywordtype">void</span>)
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272   <span class="keywordflow">if</span>(pthread_key_create(&amp;thread_key, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) == -1)
<a name="l00273"></a>00273     printf(<span class="stringliteral">&quot;Error %d creating pthread key for thread %p : %s\n&quot;</span>,
<a name="l00274"></a>00274            errno, (caddr_t) pthread_self(), strerror(errno));
<a name="l00275"></a>00275 
<a name="l00276"></a>00276   <span class="keywordflow">return</span>;
<a name="l00277"></a>00277 }                               <span class="comment">/* init_keys */</span>
<a name="l00278"></a>00278 
<a name="l00283"></a>00283 <span class="keyword">static</span> <a class="code" href="structshell__state____.html">shell_state_t</a> *GetShellContext()
<a name="l00284"></a>00284 {
<a name="l00285"></a>00285 
<a name="l00286"></a>00286   <a class="code" href="structshell__state____.html">shell_state_t</a> *p_current_thread_vars;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288   <span class="comment">/* first, we init the keys if this is the first time */</span>
<a name="l00289"></a>00289   <span class="keywordflow">if</span>(pthread_once(&amp;once_key, init_keys) != 0)
<a name="l00290"></a>00290     {
<a name="l00291"></a>00291       printf(<span class="stringliteral">&quot;Error %d calling pthread_once for thread %p : %s\n&quot;</span>,
<a name="l00292"></a>00292              errno, (caddr_t) pthread_self(), strerror(errno));
<a name="l00293"></a>00293       <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00294"></a>00294     }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296   p_current_thread_vars = (<a class="code" href="structshell__state____.html">shell_state_t</a> *) pthread_getspecific(thread_key);
<a name="l00297"></a>00297 
<a name="l00298"></a>00298   <span class="comment">/* we allocate the thread context if this is the first time */</span>
<a name="l00299"></a>00299   <span class="keywordflow">if</span>(p_current_thread_vars == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00300"></a>00300     {
<a name="l00301"></a>00301 
<a name="l00302"></a>00302       <span class="comment">/* allocates thread structure */</span>
<a name="l00303"></a>00303       p_current_thread_vars = gsh_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structshell__state____.html">shell_state_t</a>));
<a name="l00304"></a>00304 
<a name="l00305"></a>00305       <span class="comment">/* panic !!! */</span>
<a name="l00306"></a>00306       <span class="keywordflow">if</span>(p_current_thread_vars == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00307"></a>00307         {
<a name="l00308"></a>00308           printf(<span class="stringliteral">&quot;%p:ganeshell: Not enough memory\n&quot;</span>, (caddr_t) pthread_self());
<a name="l00309"></a>00309           <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00310"></a>00310         }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312       <span class="comment">/* Clean thread context */</span>
<a name="l00313"></a>00313 
<a name="l00314"></a>00314       memset(p_current_thread_vars, 0, <span class="keyword">sizeof</span>(<a class="code" href="structshell__state____.html">shell_state_t</a>));
<a name="l00315"></a>00315 
<a name="l00316"></a>00316       <span class="comment">/* setting default values */</span>
<a name="l00317"></a>00317 
<a name="l00318"></a>00318       p_current_thread_vars-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a> = stdin;
<a name="l00319"></a>00319       p_current_thread_vars-&gt;<a class="code" href="structshell__state____.html#ac19530794ea54d353fd0311833918b58">interactive</a> = <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00320"></a>00320       p_current_thread_vars-&gt;<a class="code" href="structshell__state____.html#a6d0f8ff17a863ff9b78024b332d4f002">layer</a> = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00321"></a>00321       p_current_thread_vars-&gt;<a class="code" href="structshell__state____.html#aecc070dc56b42065153b28df3b48731d">status</a> = 0;
<a name="l00322"></a>00322       p_current_thread_vars-&gt;<a class="code" href="structshell__state____.html#af1e01f5e2ea55d14d3e2dbafb9313262">verbose</a> = 0;
<a name="l00323"></a>00323       p_current_thread_vars-&gt;<a class="code" href="structshell__state____.html#a0dbfbd99cd492b36f310c006616a7fc9">debug_level</a> = <a class="code" href="log_8h.html#afc14b587b4225c84f4796397df9489e2a55b2caf073543a9a191f9ef941c07144">NIV_EVENT</a>;
<a name="l00324"></a>00324       p_current_thread_vars-&gt;<a class="code" href="structshell__state____.html#af791667e865551ff1ef99e5bd7fb5ebd">line</a> = 0;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326       <span class="comment">/* set the specific value */</span>
<a name="l00327"></a>00327       pthread_setspecific(thread_key, (<span class="keywordtype">void</span> *)p_current_thread_vars);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331   <span class="keywordflow">return</span> p_current_thread_vars;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 }                               <span class="comment">/* GetShellContext */</span>
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 <span class="comment">/*------------------------------------------------------------------</span>
<a name="l00336"></a>00336 <span class="comment"> *                    Main shell routines.</span>
<a name="l00337"></a>00337 <span class="comment"> *-----------------------------------------------------------------*/</span>
<a name="l00338"></a>00338 
<a name="l00344"></a><a class="code" href="shell_8h.html#ac0d310f037d01a4a5b18a3d1cf98dd60">00344</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#ac0d310f037d01a4a5b18a3d1cf98dd60">shell_Init</a>(<span class="keywordtype">int</span> <a class="code" href="main_8c.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>, <span class="keywordtype">char</span> *input_file, <span class="keywordtype">char</span> *prompt, <span class="keywordtype">int</span> shell_index)
<a name="l00345"></a>00345 {
<a name="l00346"></a>00346 
<a name="l00347"></a>00347   <span class="keywordtype">int</span> rc;
<a name="l00348"></a>00348   <span class="keywordtype">char</span> localmachine[256];
<a name="l00349"></a>00349   <a class="code" href="structshell__state____.html">shell_state_t</a> *context;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351   <span class="comment">/* Init logging */</span>
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   <a class="code" href="log_8h.html#a603806b370608a510a7db12cd482dc2a">SetNamePgm</a>(<span class="stringliteral">&quot;ganeshell&quot;</span>);
<a name="l00354"></a>00354   <span class="comment">/*if (verbose) */</span>
<a name="l00355"></a>00355   <a class="code" href="log_8h.html#ad27b493349e9ab97cbbcc125fc8ea9d5">SetDefaultLogging</a>(<span class="stringliteral">&quot;STDERR&quot;</span>);
<a name="l00356"></a>00356   <span class="comment">/*else</span>
<a name="l00357"></a>00357 <span class="comment">     SetDefaultLogging( &quot;/dev/null&quot; ) ; */</span>
<a name="l00358"></a>00358 
<a name="l00359"></a>00359   <a class="code" href="log_8h.html#aca6ef6a917e3178e7d309664cb668bec">SetNameFunction</a>(<span class="stringliteral">&quot;shell&quot;</span>);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361   <span class="comment">/* getting the hostname */</span>
<a name="l00362"></a>00362   <span class="keywordflow">if</span>(gethostname(localmachine, <span class="keyword">sizeof</span>(localmachine)) != 0)
<a name="l00363"></a>00363     {
<a name="l00364"></a>00364       fprintf(stderr, <span class="stringliteral">&quot;Error %d calling gethostname.\n&quot;</span>, errno);
<a name="l00365"></a>00365       <span class="keywordflow">return</span> errno;
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367   <span class="keywordflow">else</span>
<a name="l00368"></a>00368     <a class="code" href="log_8h.html#af6eab31f9b059f44e3222af8d78cbd8b">SetNameHost</a>(localmachine);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   <a class="code" href="log_8h.html#a9c6fd2b1fc6d60ab2f80b2799b0fa81e">InitLogging</a>();
<a name="l00371"></a>00371 
<a name="l00372"></a>00372   <span class="comment">/* retrieve/initialize shell context */</span>
<a name="l00373"></a>00373 
<a name="l00374"></a>00374   context = GetShellContext();
<a name="l00375"></a>00375 
<a name="l00376"></a>00376   <span class="comment">/* Initializes verbose mode. */</span>
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   <span class="keywordflow">if</span>((rc = <a class="code" href="shell_8c.html#afd975f5d6931ed03c6a3f65c6c2a0a2b">shell_SetVerbose</a>(context, (verbose ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;0&quot;</span>))))
<a name="l00379"></a>00379     <span class="keywordflow">return</span> rc;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   <span class="keywordflow">if</span>((rc = <a class="code" href="shell_8c.html#a9566cc8471ed064191fab46360448790">shell_SetDbgLvl</a>(context, <span class="stringliteral">&quot;NIV_EVENT&quot;</span>)))
<a name="l00382"></a>00382     <span class="keywordflow">return</span> rc;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="comment">/* Then, initializes input file. */</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="keywordflow">if</span>((rc = <a class="code" href="shell_8c.html#a9b5002423a565157f01c09748f87cf75">shell_SetInput</a>(context, input_file)))
<a name="l00387"></a>00387     <span class="keywordflow">return</span> rc;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389   <span class="comment">/* Initialize prompt */</span>
<a name="l00390"></a>00390 
<a name="l00391"></a>00391   <span class="keywordflow">if</span>((rc = <a class="code" href="shell_8c.html#abaa1753ce1fbddda297f2c4234f90082">shell_SetPrompt</a>(context, prompt)))
<a name="l00392"></a>00392     <span class="keywordflow">return</span> rc;
<a name="l00393"></a>00393 
<a name="l00394"></a>00394   <span class="comment">/* Initialize Shell id */</span>
<a name="l00395"></a>00395 
<a name="l00396"></a>00396   <span class="keywordflow">if</span>((rc = <a class="code" href="shell_8c.html#a74327c02354c2791d81e49b207b82882">shell_SetShellId</a>(context, shell_index)))
<a name="l00397"></a>00397     <span class="keywordflow">return</span> rc;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 <span class="comment">/* reads a line from input, and prints a prompt in interactive mode. */</span>
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 
<a name="l00406"></a>00406 <span class="preprocessor">#ifdef HAVE_LIBREADLINE</span>
<a name="l00407"></a>00407 <span class="preprocessor"></span><span class="comment">/* the same as previous, except it doesnt not trunc line at # sign */</span>
<a name="l00408"></a>00408 
<a name="l00409"></a>00409 <span class="keyword">static</span> <span class="keywordtype">char</span> *skipblanks2(<span class="keywordtype">char</span> *str)
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411 
<a name="l00412"></a>00412   <span class="keywordtype">char</span> *curr = str;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414   <span class="keywordflow">while</span>(1)
<a name="l00415"></a>00415     {
<a name="l00416"></a>00416 
<a name="l00417"></a>00417       <span class="keywordflow">switch</span> (*curr)
<a name="l00418"></a>00418         {
<a name="l00419"></a>00419           <span class="comment">/* end of lines */</span>
<a name="l00420"></a>00420         <span class="keywordflow">case</span> <span class="charliteral">&#39;\0&#39;</span>:
<a name="l00421"></a>00421           <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <span class="keywordflow">case</span> <span class="charliteral">&#39; &#39;</span>:
<a name="l00424"></a>00424         <span class="keywordflow">case</span> <span class="charliteral">&#39;\t&#39;</span>:
<a name="l00425"></a>00425         <span class="keywordflow">case</span> <span class="charliteral">&#39;\r&#39;</span>:
<a name="l00426"></a>00426         <span class="keywordflow">case</span> <span class="charliteral">&#39;\n&#39;</span>:
<a name="l00427"></a>00427           curr++;
<a name="l00428"></a>00428           <span class="keywordflow">break</span>;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430         <span class="keywordflow">default</span>:
<a name="l00431"></a>00431           <span class="keywordflow">return</span> curr;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433         }                       <span class="comment">/* switch */</span>
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     }                           <span class="comment">/* while */</span>
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 }                               <span class="comment">/* skipblanks2 */</span>
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 <span class="preprocessor">#endif</span>
<a name="l00441"></a>00441 <span class="preprocessor"></span>
<a name="l00442"></a>00442 <span class="keyword">static</span> <span class="keywordtype">char</span> *shell_readline(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">char</span> *s, <span class="keywordtype">int</span> n, FILE * stream,
<a name="l00443"></a>00443                             <span class="keywordtype">int</span> interactive)
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445 
<a name="l00446"></a>00446   <span class="keywordtype">char</span> *retval = <a class="code" href="shell_8c.html#a44bbab19233a13358d0ea0ecc8250575">shell_GetPrompt</a>(context);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 <span class="preprocessor">#ifdef HAVE_LIBREADLINE</span>
<a name="l00449"></a>00449 <span class="preprocessor"></span>
<a name="l00450"></a>00450   <span class="keywordtype">char</span> *l;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452   <span class="keywordflow">if</span>(interactive)
<a name="l00453"></a>00453     {
<a name="l00454"></a>00454       <span class="comment">/* use readline */</span>
<a name="l00455"></a>00455       l = readline((retval ? retval : <span class="stringliteral">&quot;&quot;</span>));
<a name="l00456"></a>00456       <span class="keywordflow">if</span>(l)
<a name="l00457"></a>00457         {
<a name="l00458"></a>00458           strncpy(s, l, n);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460           <span class="comment">/* add line to history, if it is not empty */</span>
<a name="l00461"></a>00461           l = skipblanks2(l);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463           <span class="keywordflow">if</span>(l != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00464"></a>00464             add_history(l);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466           <span class="keywordflow">return</span> s;
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468       <span class="keywordflow">else</span>
<a name="l00469"></a>00469         <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471   <span class="keywordflow">else</span>
<a name="l00472"></a>00472     <span class="keywordflow">return</span> fgets(s, n, stream);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 <span class="preprocessor">#else</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(interactive)
<a name="l00476"></a>00476     printf(<span class="stringliteral">&quot;%s&quot;</span>, (retval ? retval : <span class="stringliteral">&quot;&quot;</span>));
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   <span class="keywordflow">return</span> fgets(s, n, stream);
<a name="l00479"></a>00479 <span class="preprocessor">#endif</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span>
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 
<a name="l00486"></a><a class="code" href="shell_8h.html#a271d58bff569ae83aaca4c6545537c82">00486</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a271d58bff569ae83aaca4c6545537c82">shell_Launch</a>()
<a name="l00487"></a>00487 {
<a name="l00488"></a>00488 
<a name="l00489"></a>00489   <span class="keywordtype">char</span> cmdline[<a class="code" href="shell_8h.html#a09a3b394b8602092d58347b791158062">MAX_LINE_LEN</a> + 1];
<a name="l00490"></a>00490   <span class="keywordtype">char</span> *arglist[<a class="code" href="shell_8h.html#a29b7451465deac204c5f7cb1f9c6e1fc">MAX_ARGS</a>];
<a name="l00491"></a>00491   <span class="keywordtype">int</span> alloctab[<a class="code" href="shell_8h.html#a29b7451465deac204c5f7cb1f9c6e1fc">MAX_ARGS</a>];
<a name="l00492"></a>00492   <span class="keywordtype">int</span> argcount;
<a name="l00493"></a>00493   <span class="keywordtype">int</span> rc = 0;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495   <a class="code" href="structshell__state____.html">shell_state_t</a> *context = GetShellContext();
<a name="l00496"></a>00496 
<a name="l00497"></a>00497   <span class="keywordflow">while</span>(shell_readline(context, cmdline, <a class="code" href="shell_8h.html#a09a3b394b8602092d58347b791158062">MAX_LINE_LEN</a>,
<a name="l00498"></a>00498                        context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a>, context-&gt;<a class="code" href="structshell__state____.html#ac19530794ea54d353fd0311833918b58">interactive</a>) != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00499"></a>00499     {
<a name="l00500"></a>00500 
<a name="l00501"></a>00501       <span class="comment">/* Increments line number */</span>
<a name="l00502"></a>00502 
<a name="l00503"></a>00503       <a class="code" href="shell_8c.html#a45ff35a9de18915830a83de3bd62f2a1">shell_SetLine</a>(context, <a class="code" href="shell_8c.html#a70c732e9d24a5285ce46c7812e213bd0">shell_GetLine</a>(context) + 1);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505       <span class="comment">/* Parse command line */</span>
<a name="l00506"></a>00506 
<a name="l00507"></a>00507       <span class="keywordflow">if</span>(<a class="code" href="shell_8c.html#a4e27122a4ac0f624fd479497156da7fe">shell_ParseLine</a>(cmdline, arglist, &amp;argcount))
<a name="l00508"></a>00508         <span class="keywordflow">continue</span>;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510       <span class="comment">/* nothing to do if the line is empty. */</span>
<a name="l00511"></a>00511       <span class="keywordflow">if</span>(argcount == 0)
<a name="l00512"></a>00512         <span class="keywordflow">continue</span>;
<a name="l00513"></a>00513 
<a name="l00514"></a>00514       <span class="comment">/* Evaluates arguments */</span>
<a name="l00515"></a>00515 
<a name="l00516"></a>00516       <span class="keywordflow">if</span>(<a class="code" href="shell_8c.html#a08079380ae3f2e90dd30c836469eb476">shell_SolveArgs</a>(argcount, arglist, alloctab))
<a name="l00517"></a>00517         <span class="keywordflow">continue</span>;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519       <span class="comment">/* Execute command */</span>
<a name="l00520"></a>00520       rc = <a class="code" href="shell_8c.html#a10dd9a60b110b6c798b902af2378e212">shell_Execute</a>(argcount, arglist, stdout);
<a name="l00521"></a>00521 
<a name="l00522"></a>00522       <span class="comment">/* clean allocated strings */</span>
<a name="l00523"></a>00523       <a class="code" href="shell_8c.html#a9bb7a4a254006386f1135857f11d01e4">shell_CleanArgs</a>(argcount, arglist, alloctab);
<a name="l00524"></a>00524 
<a name="l00525"></a>00525       <span class="comment">/* set command status */</span>
<a name="l00526"></a>00526       <a class="code" href="shell_8c.html#a203bdb77c7bc5de688f3eabc1b70c16a">shell_SetStatus</a>(context, rc);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529   <span class="keywordflow">return</span> rc;
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 <span class="comment">/*------------------------------------------------------------------</span>
<a name="l00533"></a>00533 <span class="comment"> *                Parsing and execution routines.</span>
<a name="l00534"></a>00534 <span class="comment"> *-----------------------------------------------------------------*/</span>
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 <span class="comment">/* address of the first non blank char if any, null else.*/</span>
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 <span class="keyword">static</span> <span class="keywordtype">char</span> *skipblanks(<span class="keywordtype">char</span> *str)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540 
<a name="l00541"></a>00541   <span class="keywordtype">char</span> *curr = str;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543   <span class="keywordflow">while</span>(1)
<a name="l00544"></a>00544     {
<a name="l00545"></a>00545 
<a name="l00546"></a>00546       <span class="keywordflow">switch</span> (*curr)
<a name="l00547"></a>00547         {
<a name="l00548"></a>00548           <span class="comment">/* end of lines */</span>
<a name="l00549"></a>00549         <span class="keywordflow">case</span> <span class="charliteral">&#39;\0&#39;</span>:
<a name="l00550"></a>00550         <span class="keywordflow">case</span> <span class="charliteral">&#39;#&#39;</span>:
<a name="l00551"></a>00551           <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         <span class="keywordflow">case</span> <span class="charliteral">&#39; &#39;</span>:
<a name="l00554"></a>00554         <span class="keywordflow">case</span> <span class="charliteral">&#39;\t&#39;</span>:
<a name="l00555"></a>00555         <span class="keywordflow">case</span> <span class="charliteral">&#39;\r&#39;</span>:
<a name="l00556"></a>00556         <span class="keywordflow">case</span> <span class="charliteral">&#39;\n&#39;</span>:
<a name="l00557"></a>00557           curr++;
<a name="l00558"></a>00558           <span class="keywordflow">break</span>;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="keywordflow">default</span>:
<a name="l00561"></a>00561           <span class="keywordflow">return</span> curr;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563         }                       <span class="comment">/* switch */</span>
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     }                           <span class="comment">/* while */</span>
<a name="l00566"></a>00566 
<a name="l00567"></a>00567 }                               <span class="comment">/* skipblanks */</span>
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 <span class="comment">/* adress of the first blank char</span>
<a name="l00570"></a>00570 <span class="comment"> * outside a string.</span>
<a name="l00571"></a>00571 <span class="comment"> */</span>
<a name="l00572"></a>00572 <span class="keyword">static</span> <span class="keywordtype">char</span> *nextblank(<span class="keywordtype">char</span> *str)
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574 
<a name="l00575"></a>00575   <span class="keywordtype">int</span> dquote_string = 0;
<a name="l00576"></a>00576   <span class="keywordtype">int</span> squote_string = 0;
<a name="l00577"></a>00577   <span class="keywordtype">int</span> bquote_string = 0;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579   <span class="keywordtype">int</span> escaped = 0;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   <span class="keywordtype">char</span> *curr = str;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583   <span class="keywordflow">while</span>(1)
<a name="l00584"></a>00584     {
<a name="l00585"></a>00585 
<a name="l00586"></a>00586       <span class="keywordflow">switch</span> (*curr)
<a name="l00587"></a>00587         {
<a name="l00588"></a>00588 
<a name="l00589"></a>00589           <span class="comment">/* end of lines */</span>
<a name="l00590"></a>00590         <span class="keywordflow">case</span> <span class="charliteral">&#39; &#39;</span>:
<a name="l00591"></a>00591         <span class="keywordflow">case</span> <span class="charliteral">&#39;\t&#39;</span>:
<a name="l00592"></a>00592           <span class="keywordflow">if</span>(!dquote_string &amp;&amp; !squote_string &amp;&amp; !bquote_string)
<a name="l00593"></a>00593             <span class="keywordflow">return</span> curr;
<a name="l00594"></a>00594           <span class="keywordflow">else</span>
<a name="l00595"></a>00595             curr++;
<a name="l00596"></a>00596           <span class="keywordflow">break</span>;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         <span class="keywordflow">case</span> <span class="charliteral">&#39;\0&#39;</span>:
<a name="l00599"></a>00599         <span class="keywordflow">case</span> <span class="charliteral">&#39;\n&#39;</span>:
<a name="l00600"></a>00600           <span class="keywordflow">return</span> curr;
<a name="l00601"></a>00601           <span class="keywordflow">break</span>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603         <span class="keywordflow">case</span> <span class="charliteral">&#39;\\&#39;</span>:
<a name="l00604"></a>00604           <span class="comment">/* escape sequence */</span>
<a name="l00605"></a>00605           escaped = 1;
<a name="l00606"></a>00606           curr++;
<a name="l00607"></a>00607           <span class="keywordflow">break</span>;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609         <span class="keywordflow">case</span> <span class="charliteral">&#39;&quot;&#39;</span>:
<a name="l00610"></a>00610           <span class="comment">/* start or end of double quoted string */</span>
<a name="l00611"></a>00611           <span class="keywordflow">if</span>(dquote_string)
<a name="l00612"></a>00612             dquote_string = 0;
<a name="l00613"></a>00613           <span class="keywordflow">else</span>
<a name="l00614"></a>00614             (dquote_string) = 1;
<a name="l00615"></a>00615           curr++;
<a name="l00616"></a>00616           <span class="keywordflow">break</span>;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618         <span class="keywordflow">case</span> <span class="charliteral">&#39;\&#39;&#39;</span>:
<a name="l00619"></a>00619           <span class="comment">/* start or end of single quoted string */</span>
<a name="l00620"></a>00620           <span class="keywordflow">if</span>(squote_string)
<a name="l00621"></a>00621             squote_string = 0;
<a name="l00622"></a>00622           <span class="keywordflow">else</span>
<a name="l00623"></a>00623             (squote_string) = 1;
<a name="l00624"></a>00624           curr++;
<a name="l00625"></a>00625           <span class="keywordflow">break</span>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         <span class="keywordflow">case</span> <span class="charliteral">&#39;`&#39;</span>:
<a name="l00628"></a>00628           <span class="comment">/* start or end of back-quoted string */</span>
<a name="l00629"></a>00629           <span class="keywordflow">if</span>(bquote_string)
<a name="l00630"></a>00630             bquote_string = 0;
<a name="l00631"></a>00631           <span class="keywordflow">else</span>
<a name="l00632"></a>00632             (bquote_string) = 1;
<a name="l00633"></a>00633           curr++;
<a name="l00634"></a>00634           <span class="keywordflow">break</span>;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         <span class="keywordflow">default</span>:
<a name="l00637"></a>00637           curr++;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         }                       <span class="comment">/* switch */</span>
<a name="l00640"></a>00640 
<a name="l00641"></a>00641       <span class="comment">/* escape ? */</span>
<a name="l00642"></a>00642 
<a name="l00643"></a>00643       <span class="keywordflow">if</span>(escaped &amp;&amp; (*curr != <span class="charliteral">&#39;\0&#39;</span>))
<a name="l00644"></a>00644         {
<a name="l00645"></a>00645           escaped = 0;
<a name="l00646"></a>00646           curr++;
<a name="l00647"></a>00647         }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649     }                           <span class="comment">/* while */</span>
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 }                               <span class="comment">/* nextblank */</span>
<a name="l00652"></a>00652 
<a name="l00664"></a><a class="code" href="shell_8h.html#a4e27122a4ac0f624fd479497156da7fe">00664</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a4e27122a4ac0f624fd479497156da7fe">shell_ParseLine</a>(<span class="keywordtype">char</span> *in_out_line, <span class="keywordtype">char</span> **out_arglist, <span class="keywordtype">int</span> *p_argcount)
<a name="l00665"></a>00665 {
<a name="l00666"></a>00666 
<a name="l00667"></a>00667   <span class="keywordtype">char</span> *curr_pos = in_out_line;
<a name="l00668"></a>00668   (*p_argcount) = 0;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670   <span class="comment">/* While there is something after the Oblivion... */</span>
<a name="l00671"></a>00671 
<a name="l00672"></a>00672   <span class="keywordflow">while</span>((curr_pos = skipblanks(curr_pos)))
<a name="l00673"></a>00673     {
<a name="l00674"></a>00674       out_arglist[(*p_argcount)] = curr_pos;
<a name="l00675"></a>00675       (*p_argcount)++;
<a name="l00676"></a>00676       curr_pos = nextblank(curr_pos);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678       <span class="keywordflow">if</span>(*curr_pos == <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00679"></a>00679         <span class="keywordflow">break</span>;
<a name="l00680"></a>00680       <span class="keywordflow">else</span>
<a name="l00681"></a>00681         *curr_pos = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683       curr_pos++;
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 }                               <span class="comment">/* shell_ParseLine */</span>
<a name="l00689"></a>00689 
<a name="l00695"></a>00695 <span class="keyword">static</span> <span class="keywordtype">int</span> unescape(<span class="keywordtype">char</span> *str)
<a name="l00696"></a>00696 {
<a name="l00697"></a>00697 
<a name="l00698"></a>00698   <span class="keywordtype">char</span> *src = str;
<a name="l00699"></a>00699   <span class="keywordtype">char</span> *tgt = str;
<a name="l00700"></a>00700 
<a name="l00701"></a>00701   <span class="keywordflow">while</span>(*src != <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00702"></a>00702     {
<a name="l00703"></a>00703       <span class="keywordflow">if</span>(*src == <span class="charliteral">&#39;\\&#39;</span>)
<a name="l00704"></a>00704         {
<a name="l00705"></a>00705           src++;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707           <span class="comment">/* escaped null char */</span>
<a name="l00708"></a>00708           <span class="keywordflow">if</span>(*src == <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00709"></a>00709             {
<a name="l00710"></a>00710 <span class="preprocessor">#ifdef _DEBUG_SHELL</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span>              printf(<span class="stringliteral">&quot;UNESCAPE ERROR &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; [%s][%c][%c]\n&quot;</span>, str, *src, *tgt);
<a name="l00712"></a>00712 <span class="preprocessor">#endif</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span>              <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l00714"></a>00714             }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716         }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718       <span class="keywordflow">if</span>(tgt != src)
<a name="l00719"></a>00719         *tgt = *src;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721       src++;
<a name="l00722"></a>00722       tgt++;
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725   <span class="comment">/* final zero */</span>
<a name="l00726"></a>00726   <span class="keywordflow">if</span>(tgt != src)
<a name="l00727"></a>00727     *tgt = *src;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l00730"></a>00730 
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00738"></a>00738 <span class="keyword">static</span> <span class="keywordtype">int</span> remove_quotes(<span class="keywordtype">char</span> quote, <span class="keywordtype">char</span> **pstr)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740 
<a name="l00741"></a>00741   <span class="keywordtype">size_t</span> len = strlen(*pstr);
<a name="l00742"></a>00742 
<a name="l00743"></a>00743   <span class="keywordflow">if</span>(len &lt;= 1)
<a name="l00744"></a>00744     <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l00745"></a>00745   <span class="keywordflow">if</span>((*pstr)[len - 1] != quote)
<a name="l00746"></a>00746     <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748   (*pstr)[len - 1] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00749"></a>00749   (*pstr)[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751   (*pstr)++;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 
<a name="l00768"></a><a class="code" href="shell_8h.html#a08079380ae3f2e90dd30c836469eb476">00768</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a08079380ae3f2e90dd30c836469eb476">shell_SolveArgs</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **in_out_argv, <span class="keywordtype">int</span> *out_allocated)
<a name="l00769"></a>00769 {
<a name="l00770"></a>00770 
<a name="l00771"></a>00771   <span class="keywordtype">int</span> i;
<a name="l00772"></a>00772   <span class="keywordtype">int</span> <a class="code" href="subr_8c.html#a1f2a342148fd3d57e387199914dd94c8">error</a> = 0;
<a name="l00773"></a>00773   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l00774"></a>00774 
<a name="l00775"></a>00775   <a class="code" href="structshell__state____.html">shell_state_t</a> *context = GetShellContext();
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 <span class="preprocessor">#ifdef _DEBUG_SHELL</span>
<a name="l00778"></a>00778 <span class="preprocessor"></span>  printf(<span class="stringliteral">&quot;SOLVE:&quot;</span>);
<a name="l00779"></a>00779   <span class="keywordflow">for</span>(i = 0; i &lt; argc; i++)
<a name="l00780"></a>00780     printf(<span class="stringliteral">&quot;[%s]&quot;</span>, in_out_argv[i]);
<a name="l00781"></a>00781   printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00782"></a>00782 <span class="preprocessor">#endif</span>
<a name="l00783"></a>00783 <span class="preprocessor"></span>
<a name="l00784"></a>00784   <span class="keywordflow">for</span>(i = 0; i &lt; argc; i++)
<a name="l00785"></a>00785     {
<a name="l00786"></a>00786 
<a name="l00787"></a>00787       out_allocated[i] = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789       <span class="comment">/* double quotes */</span>
<a name="l00790"></a>00790 
<a name="l00791"></a>00791       <span class="keywordflow">if</span>(in_out_argv[i][0] == <span class="charliteral">&#39;&quot;&#39;</span>)
<a name="l00792"></a>00792         {
<a name="l00793"></a>00793 
<a name="l00794"></a>00794           <span class="keywordflow">if</span>(remove_quotes(<span class="charliteral">&#39;&quot;&#39;</span>, &amp;(in_out_argv[i])))
<a name="l00795"></a>00795             {
<a name="l00796"></a>00796               <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, <span class="stringliteral">&quot;Syntax error: Missing closing quotes&quot;</span>);
<a name="l00797"></a>00797               error = <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l00798"></a>00798               <span class="keywordflow">break</span>;
<a name="l00799"></a>00799             }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801           <span class="keywordflow">if</span>(unescape(in_out_argv[i]))
<a name="l00802"></a>00802             {
<a name="l00803"></a>00803               <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, <span class="stringliteral">&quot;Syntax error: Invalid escape sequence&quot;</span>);
<a name="l00804"></a>00804               error = <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l00805"></a>00805               <span class="keywordflow">break</span>;
<a name="l00806"></a>00806             }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808         }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810       <span class="comment">/* single quotes */</span>
<a name="l00811"></a>00811 
<a name="l00812"></a>00812       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(in_out_argv[i][0] == <span class="charliteral">&#39;\&#39;&#39;</span>)
<a name="l00813"></a>00813         {
<a name="l00814"></a>00814 
<a name="l00815"></a>00815           <span class="keywordflow">if</span>(remove_quotes(<span class="charliteral">&#39;\&#39;&#39;</span>, &amp;(in_out_argv[i])))
<a name="l00816"></a>00816             {
<a name="l00817"></a>00817               <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, <span class="stringliteral">&quot;Syntax error: Missing closing quote&quot;</span>);
<a name="l00818"></a>00818               error = <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l00819"></a>00819               <span class="keywordflow">break</span>;
<a name="l00820"></a>00820             }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822           <span class="keywordflow">if</span>(unescape(in_out_argv[i]))
<a name="l00823"></a>00823             {
<a name="l00824"></a>00824               <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, <span class="stringliteral">&quot;Syntax error: Invalid escape sequence&quot;</span>);
<a name="l00825"></a>00825               error = <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l00826"></a>00826               <span class="keywordflow">break</span>;
<a name="l00827"></a>00827             }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829         }
<a name="l00830"></a>00830 
<a name="l00831"></a>00831       <span class="comment">/* var name */</span>
<a name="l00832"></a>00832 
<a name="l00833"></a>00833       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(in_out_argv[i][0] == <span class="charliteral">&#39;$&#39;</span>)
<a name="l00834"></a>00834         {
<a name="l00835"></a>00835 
<a name="l00836"></a>00836           <span class="keywordtype">char</span> *value = <a class="code" href="shell__vars_8c.html#a29bc337d24deebcc1d223335830f03a4">get_var_value</a>(&amp;(in_out_argv[i][1]));
<a name="l00837"></a>00837 
<a name="l00838"></a>00838           <span class="keywordflow">if</span>(value)
<a name="l00839"></a>00839             in_out_argv[i] = value;
<a name="l00840"></a>00840           <span class="keywordflow">else</span>
<a name="l00841"></a>00841             {
<a name="l00842"></a>00842               snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l00843"></a>00843                        <span class="stringliteral">&quot;Undefined variable \&quot;%s\&quot;&quot;</span>, &amp;(in_out_argv[i][1]));
<a name="l00844"></a>00844               <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l00845"></a>00845               error = <a class="code" href="shell_8h.html#add182c422eb915de7f9c9913f405b55b">SHELL_NOT_FOUND</a>;
<a name="l00846"></a>00846               <span class="keywordflow">break</span>;
<a name="l00847"></a>00847             }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849         }
<a name="l00850"></a>00850 
<a name="l00851"></a>00851       <span class="comment">/* command */</span>
<a name="l00852"></a>00852 
<a name="l00853"></a>00853       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(in_out_argv[i][0] == <span class="charliteral">&#39;`&#39;</span>)
<a name="l00854"></a>00854         {
<a name="l00855"></a>00855 
<a name="l00856"></a>00856           <span class="keywordtype">char</span> *arglist[<a class="code" href="shell_8h.html#a29b7451465deac204c5f7cb1f9c6e1fc">MAX_ARGS</a>];
<a name="l00857"></a>00857           <span class="keywordtype">int</span> argcount;
<a name="l00858"></a>00858           <span class="keywordtype">int</span> rc, status;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860           <span class="comment">/* remove quotes */</span>
<a name="l00861"></a>00861 
<a name="l00862"></a>00862           <span class="keywordflow">if</span>(remove_quotes(<span class="charliteral">&#39;`&#39;</span>, &amp;(in_out_argv[i])))
<a name="l00863"></a>00863             {
<a name="l00864"></a>00864               <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, <span class="stringliteral">&quot;Syntax error: Missing closing backquote&quot;</span>);
<a name="l00865"></a>00865               error = <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l00866"></a>00866               <span class="keywordflow">break</span>;
<a name="l00867"></a>00867             }
<a name="l00868"></a>00868 
<a name="l00869"></a>00869           <span class="keywordflow">if</span>(unescape(in_out_argv[i]))
<a name="l00870"></a>00870             {
<a name="l00871"></a>00871               <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, <span class="stringliteral">&quot;Syntax error: Invalid escape sequence&quot;</span>);
<a name="l00872"></a>00872               error = <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l00873"></a>00873               <span class="keywordflow">break</span>;
<a name="l00874"></a>00874             }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876           <span class="comment">/* Parse command line */</span>
<a name="l00877"></a>00877 
<a name="l00878"></a>00878           <span class="keywordflow">if</span>(<a class="code" href="shell_8c.html#a4e27122a4ac0f624fd479497156da7fe">shell_ParseLine</a>(in_out_argv[i], arglist, &amp;argcount))
<a name="l00879"></a>00879             {
<a name="l00880"></a>00880               error = <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l00881"></a>00881               <span class="keywordflow">break</span>;
<a name="l00882"></a>00882             }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884           <span class="comment">/* nothing to do if the command is empty. */</span>
<a name="l00885"></a>00885 
<a name="l00886"></a>00886           <span class="keywordflow">if</span>(argcount == 0)
<a name="l00887"></a>00887             {
<a name="l00888"></a>00888 
<a name="l00889"></a>00889               <span class="comment">/* empty output */</span>
<a name="l00890"></a>00890               in_out_argv[i][0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00891"></a>00891 
<a name="l00892"></a>00892               <span class="comment">/* command status */</span>
<a name="l00893"></a>00893               <a class="code" href="shell_8c.html#a203bdb77c7bc5de688f3eabc1b70c16a">shell_SetStatus</a>(context, 0);
<a name="l00894"></a>00894 
<a name="l00895"></a>00895             }
<a name="l00896"></a>00896           <span class="keywordflow">else</span>
<a name="l00897"></a>00897             {
<a name="l00898"></a>00898 
<a name="l00899"></a>00899               <span class="keywordtype">int</span> fd[2];
<a name="l00900"></a>00900               FILE *output_stream;
<a name="l00901"></a>00901               <span class="keywordtype">int</span> alloctab[<a class="code" href="shell_8h.html#a29b7451465deac204c5f7cb1f9c6e1fc">MAX_ARGS</a>];
<a name="l00902"></a>00902 
<a name="l00903"></a>00903               <span class="keywordtype">char</span> output_string[<a class="code" href="shell_8c.html#a6f47cadd2e292d89353544ae32672e9b">MAX_OUTPUT_LEN</a>];
<a name="l00904"></a>00904 
<a name="l00905"></a>00905               <span class="comment">/* Evaluates arguments */</span>
<a name="l00906"></a>00906 
<a name="l00907"></a>00907               <span class="keywordflow">if</span>(<a class="code" href="shell_8c.html#a08079380ae3f2e90dd30c836469eb476">shell_SolveArgs</a>(argcount, arglist, alloctab))
<a name="l00908"></a>00908                 {
<a name="l00909"></a>00909                   error = <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l00910"></a>00910                   <span class="keywordflow">break</span>;
<a name="l00911"></a>00911                 }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913               <span class="comment">/* create pipe for command output */</span>
<a name="l00914"></a>00914 
<a name="l00915"></a>00915               <span class="keywordflow">if</span>(pipe(fd))
<a name="l00916"></a>00916                 {
<a name="l00917"></a>00917 
<a name="l00918"></a>00918                   snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Can&#39;t create pipe: %s (%d)&quot;</span>,
<a name="l00919"></a>00919                            strerror(errno), errno);
<a name="l00920"></a>00920                   <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922                   <span class="comment">/* clean allocated strings */</span>
<a name="l00923"></a>00923                   <a class="code" href="shell_8c.html#a9bb7a4a254006386f1135857f11d01e4">shell_CleanArgs</a>(argcount, arglist, alloctab);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925                   error = errno;
<a name="l00926"></a>00926                   <span class="keywordflow">break</span>;
<a name="l00927"></a>00927 
<a name="l00928"></a>00928                 }
<a name="l00929"></a>00929 
<a name="l00930"></a>00930               <span class="comment">/* opening output stream */</span>
<a name="l00931"></a>00931 
<a name="l00932"></a>00932               output_stream = fdopen(fd[1], <span class="stringliteral">&quot;a&quot;</span>);
<a name="l00933"></a>00933 
<a name="l00934"></a>00934               <span class="keywordflow">if</span>(output_stream == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00935"></a>00935                 {
<a name="l00936"></a>00936 
<a name="l00937"></a>00937                   snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Can&#39;t open pipe stream: %s (%d)&quot;</span>,
<a name="l00938"></a>00938                            strerror(errno), errno);
<a name="l00939"></a>00939                   <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941                   <span class="comment">/* clean allocated strings */</span>
<a name="l00942"></a>00942                   <a class="code" href="shell_8c.html#a9bb7a4a254006386f1135857f11d01e4">shell_CleanArgs</a>(argcount, arglist, alloctab);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944                   <span class="comment">/* close pipe */</span>
<a name="l00945"></a>00945                   close(fd[1]);
<a name="l00946"></a>00946                   close(fd[0]);
<a name="l00947"></a>00947 
<a name="l00948"></a>00948                   error = errno;
<a name="l00949"></a>00949                   <span class="keywordflow">break</span>;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951                 }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953               <span class="comment">/* @todo : thread for pipe reading */</span>
<a name="l00954"></a>00954 
<a name="l00955"></a>00955               <span class="comment">/* Execute command */</span>
<a name="l00956"></a>00956 
<a name="l00957"></a>00957               status = <a class="code" href="shell_8c.html#a10dd9a60b110b6c798b902af2378e212">shell_Execute</a>(argcount, arglist, output_stream);
<a name="l00958"></a>00958 
<a name="l00959"></a>00959               <span class="comment">/* closing ouput stream. */</span>
<a name="l00960"></a>00960 
<a name="l00961"></a>00961               fclose(output_stream);
<a name="l00962"></a>00962               close(fd[1]);
<a name="l00963"></a>00963 
<a name="l00964"></a>00964               <span class="comment">/* clean allocated strings */</span>
<a name="l00965"></a>00965               <a class="code" href="shell_8c.html#a9bb7a4a254006386f1135857f11d01e4">shell_CleanArgs</a>(argcount, arglist, alloctab);
<a name="l00966"></a>00966 
<a name="l00967"></a>00967               <span class="comment">/* read the output from pipe */</span>
<a name="l00968"></a>00968 
<a name="l00969"></a>00969               rc = read(fd[0], output_string, <a class="code" href="shell_8c.html#a6f47cadd2e292d89353544ae32672e9b">MAX_OUTPUT_LEN</a>);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971               <span class="comment">/* close pipe */</span>
<a name="l00972"></a>00972               close(fd[0]);
<a name="l00973"></a>00973 
<a name="l00974"></a>00974               <span class="keywordflow">if</span>(rc == -1)
<a name="l00975"></a>00975                 {
<a name="l00976"></a>00976                   snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Cannot read from pipe: %s (%d)&quot;</span>,
<a name="l00977"></a>00977                            strerror(errno), errno);
<a name="l00978"></a>00978                   <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l00979"></a>00979 
<a name="l00980"></a>00980                   error = errno;
<a name="l00981"></a>00981                   <span class="keywordflow">break</span>;
<a name="l00982"></a>00982                 }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984               <span class="comment">/* allocate and fill output buffer */</span>
<a name="l00985"></a>00985 
<a name="l00986"></a>00986               in_out_argv[i] = gsh_malloc(rc + 1);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988               <span class="keywordflow">if</span>(in_out_argv[i] == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00989"></a>00989                 {
<a name="l00990"></a>00990                   <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, <span class="stringliteral">&quot;Malloc error&quot;</span>);
<a name="l00991"></a>00991                   error = -1;
<a name="l00992"></a>00992                   <span class="keywordflow">break</span>;
<a name="l00993"></a>00993                 }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995               memcpy(in_out_argv[i], output_string, rc);
<a name="l00996"></a>00996 
<a name="l00997"></a>00997               out_allocated[i] = <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00998"></a>00998 
<a name="l00999"></a>00999               in_out_argv[i][rc] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01000"></a>01000 
<a name="l01001"></a>01001               <span class="comment">/* set command status */</span>
<a name="l01002"></a>01002 
<a name="l01003"></a>01003               <a class="code" href="shell_8c.html#a203bdb77c7bc5de688f3eabc1b70c16a">shell_SetStatus</a>(context, status);
<a name="l01004"></a>01004 
<a name="l01005"></a>01005             }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007         }
<a name="l01008"></a>01008       <span class="comment">/*  normal arg  */</span>
<a name="l01009"></a>01009       <span class="keywordflow">else</span>
<a name="l01010"></a>01010         {
<a name="l01011"></a>01011           <span class="keywordflow">if</span>(unescape(in_out_argv[i]))
<a name="l01012"></a>01012             {
<a name="l01013"></a>01013               <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, <span class="stringliteral">&quot;Syntax error: Invalid escape sequence&quot;</span>);
<a name="l01014"></a>01014               error = <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l01015"></a>01015               <span class="keywordflow">break</span>;
<a name="l01016"></a>01016             }
<a name="l01017"></a>01017 
<a name="l01018"></a>01018         }                       <span class="comment">/* in_out_argv[i][0] */</span>
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     }                           <span class="comment">/* for */</span>
<a name="l01021"></a>01021 
<a name="l01022"></a>01022   <span class="comment">/* the case when we exited the for because of an error. */</span>
<a name="l01023"></a>01023 
<a name="l01024"></a>01024   <span class="keywordflow">if</span>(error)
<a name="l01025"></a>01025     {
<a name="l01026"></a>01026       <span class="comment">/* free allocated strings */</span>
<a name="l01027"></a>01027       <a class="code" href="shell_8c.html#a9bb7a4a254006386f1135857f11d01e4">shell_CleanArgs</a>(i + 1, in_out_argv, out_allocated);
<a name="l01028"></a>01028       <span class="keywordflow">return</span> <a class="code" href="subr_8c.html#a1f2a342148fd3d57e387199914dd94c8">error</a>;
<a name="l01029"></a>01029     }
<a name="l01030"></a>01030 
<a name="l01031"></a>01031   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033 }                               <span class="comment">/* shell_SolveArgs */</span>
<a name="l01034"></a>01034 
<a name="l01045"></a><a class="code" href="shell_8h.html#a9bb7a4a254006386f1135857f11d01e4">01045</a> <span class="keywordtype">void</span> <a class="code" href="shell_8c.html#a9bb7a4a254006386f1135857f11d01e4">shell_CleanArgs</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **in_out_argv, <span class="keywordtype">int</span> *in_allocated)
<a name="l01046"></a>01046 {
<a name="l01047"></a>01047 
<a name="l01048"></a>01048   <span class="keywordtype">int</span> i;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050   <span class="keywordflow">for</span>(i = 0; i &lt; argc; i++)
<a name="l01051"></a>01051     {
<a name="l01052"></a>01052 
<a name="l01053"></a>01053       <span class="keywordflow">if</span>(in_allocated[i])
<a name="l01054"></a>01054         {
<a name="l01055"></a>01055           gsh_free(in_out_argv[i]);
<a name="l01056"></a>01056           in_out_argv[i] = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01057"></a>01057           in_allocated[i] = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01058"></a>01058         }
<a name="l01059"></a>01059 
<a name="l01060"></a>01060     }
<a name="l01061"></a>01061 
<a name="l01062"></a>01062   <span class="keywordflow">return</span>;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 
<a name="l01076"></a><a class="code" href="shell_8h.html#a10dd9a60b110b6c798b902af2378e212">01076</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a10dd9a60b110b6c798b902af2378e212">shell_Execute</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv, FILE * output)
<a name="l01077"></a>01077 {
<a name="l01078"></a>01078 
<a name="l01079"></a>01079   <span class="comment">/* pointer to the command to be launched */</span>
<a name="l01080"></a>01080   int (*command_func) (int, <span class="keywordtype">char</span> **, FILE *) = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01081"></a>01081 
<a name="l01082"></a>01082   <span class="keywordtype">int</span> i;
<a name="l01083"></a>01083   <span class="keywordtype">int</span> rc;
<a name="l01084"></a>01084   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01085"></a>01085 
<a name="l01086"></a>01086   <a class="code" href="structshell__state____.html">shell_state_t</a> *context = GetShellContext();
<a name="l01087"></a>01087 
<a name="l01088"></a>01088   <span class="comment">/* First, look at shell internal commands */</span>
<a name="l01089"></a>01089 
<a name="l01090"></a>01090   <span class="keywordflow">for</span>(i = 0; shell_commands[i].command_name; i++)
<a name="l01091"></a>01091     {
<a name="l01092"></a>01092       <span class="keywordflow">if</span>(!strcmp(argv[0], shell_commands[i].command_name))
<a name="l01093"></a>01093         {
<a name="l01094"></a>01094           command_func = shell_commands[i].command_func;
<a name="l01095"></a>01095           <span class="keywordflow">break</span>;
<a name="l01096"></a>01096         }
<a name="l01097"></a>01097     }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099   <span class="comment">/* If not found, look at shell utils commands */</span>
<a name="l01100"></a>01100 
<a name="l01101"></a>01101   <span class="keywordflow">if</span>(!command_func)
<a name="l01102"></a>01102     {
<a name="l01103"></a>01103 
<a name="l01104"></a>01104       <span class="keywordflow">for</span>(i = 0; shell_utils[i].<a class="code" href="structcommand__def____.html#a6470cd228728d90e6d137beb7b1e7b1a">command_name</a>; i++)
<a name="l01105"></a>01105         {
<a name="l01106"></a>01106           <span class="keywordflow">if</span>(!strcmp(argv[0], shell_utils[i].command_name))
<a name="l01107"></a>01107             {
<a name="l01108"></a>01108               command_func = shell_utils[i].<a class="code" href="structcommand__def____.html#a69f8d07ba9009b5a333eed7ff5a20c17">command_func</a>;
<a name="l01109"></a>01109               <span class="keywordflow">break</span>;
<a name="l01110"></a>01110             }
<a name="l01111"></a>01111         }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115   <span class="comment">/* If not found, look at layer commands */</span>
<a name="l01116"></a>01116 
<a name="l01117"></a>01117   <span class="keywordflow">if</span>(!command_func)
<a name="l01118"></a>01118     {
<a name="l01119"></a>01119       <a class="code" href="structlayer__def____.html">layer_def_t</a> *current_layer = <a class="code" href="shell_8c.html#a87cc52ddf5ce6b0b8b6ea2655fe846cf">shell_GetLayer</a>(context);
<a name="l01120"></a>01120 
<a name="l01121"></a>01121       <span class="keywordflow">if</span>(current_layer)
<a name="l01122"></a>01122         {
<a name="l01123"></a>01123 
<a name="l01124"></a>01124           <span class="keywordflow">for</span>(i = 0; current_layer-&gt;<a class="code" href="structlayer__def____.html#afd47e95d6f7af78b82d58856a08d5838">command_list</a>[i].<a class="code" href="structcommand__def____.html#a6470cd228728d90e6d137beb7b1e7b1a">command_name</a>; i++)
<a name="l01125"></a>01125             {
<a name="l01126"></a>01126               <span class="keywordflow">if</span>(!strcmp(argv[0], current_layer-&gt;<a class="code" href="structlayer__def____.html#afd47e95d6f7af78b82d58856a08d5838">command_list</a>[i].<a class="code" href="structcommand__def____.html#a6470cd228728d90e6d137beb7b1e7b1a">command_name</a>))
<a name="l01127"></a>01127                 {
<a name="l01128"></a>01128                   command_func = current_layer-&gt;<a class="code" href="structlayer__def____.html#afd47e95d6f7af78b82d58856a08d5838">command_list</a>[i].<a class="code" href="structcommand__def____.html#a69f8d07ba9009b5a333eed7ff5a20c17">command_func</a>;
<a name="l01129"></a>01129 
<a name="l01130"></a>01130                   <span class="comment">/* set layer&#39;s debug level */</span>
<a name="l01131"></a>01131                   current_layer-&gt;<a class="code" href="structlayer__def____.html#a30ae5403c54841f30e5f22361c8b1ee5">setlog_func</a>(<a class="code" href="shell_8c.html#ae8266753e0ec315e4f060c49f70dfc24">shell_GetDbgLvl</a>(context));
<a name="l01132"></a>01132 
<a name="l01133"></a>01133                   <span class="keywordflow">break</span>;
<a name="l01134"></a>01134                 }
<a name="l01135"></a>01135             }                   <span class="comment">/* for */</span>
<a name="l01136"></a>01136 
<a name="l01137"></a>01137         }
<a name="l01138"></a>01138       <span class="comment">/* if current_layer */</span>
<a name="l01139"></a>01139     }
<a name="l01140"></a>01140 
<a name="l01141"></a>01141   <span class="comment">/* if command_func */</span>
<a name="l01142"></a>01142   <span class="comment">/* command not found */</span>
<a name="l01143"></a>01143   <span class="keywordflow">if</span>(!command_func)
<a name="l01144"></a>01144     {
<a name="l01145"></a>01145       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;%s: command not found&quot;</span>, argv[0]);
<a name="l01146"></a>01146       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01147"></a>01147       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#add182c422eb915de7f9c9913f405b55b">SHELL_NOT_FOUND</a>;
<a name="l01148"></a>01148     }
<a name="l01149"></a>01149 
<a name="l01150"></a>01150   <span class="comment">/* verbose trace */</span>
<a name="l01151"></a>01151 
<a name="l01152"></a>01152   <span class="keywordflow">if</span>(<a class="code" href="shell_8c.html#a20edf96684135c0d368f0b2c868e2271">shell_GetVerbose</a>(context))
<a name="l01153"></a>01153     {
<a name="l01154"></a>01154       tracebuff[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01155"></a>01155       <span class="keywordflow">for</span>(i = 0; i &lt; argc; i++)
<a name="l01156"></a>01156         {
<a name="l01157"></a>01157           <span class="comment">/* + 1 = size of the additional char ( + or space) */</span>
<a name="l01158"></a>01158           <span class="keywordtype">size_t</span> len1 = strlen(tracebuff) + 1;
<a name="l01159"></a>01159           <span class="keywordtype">size_t</span> len2 = strlen(argv[i]);
<a name="l01160"></a>01160 
<a name="l01161"></a>01161           <span class="keywordflow">if</span>(len1 &gt; <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a> - 1)
<a name="l01162"></a>01162             <span class="keywordflow">break</span>;
<a name="l01163"></a>01163 
<a name="l01164"></a>01164           <span class="keywordflow">if</span>(i != 0)
<a name="l01165"></a>01165             <a class="code" href="FSAL__XFS_2fsal__rcp_8c.html#adb8723e585ed29f2370cddf90f6891bc">strcat</a>(tracebuff, <span class="stringliteral">&quot; &quot;</span>);
<a name="l01166"></a>01166           <span class="keywordflow">else</span>
<a name="l01167"></a>01167             <a class="code" href="FSAL__XFS_2fsal__rcp_8c.html#adb8723e585ed29f2370cddf90f6891bc">strcat</a>(tracebuff, <span class="stringliteral">&quot;+&quot;</span>);
<a name="l01168"></a>01168 
<a name="l01169"></a>01169           <span class="keywordflow">if</span>(len1 + len2 &gt; <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a> - 1)
<a name="l01170"></a>01170             {
<a name="l01171"></a>01171               <span class="keywordflow">if</span>(<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a> - 6 - len1 &gt; 0)
<a name="l01172"></a>01172                 strncat(tracebuff, argv[i], <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a> - 6 - len1);
<a name="l01173"></a>01173 
<a name="l01174"></a>01174               <a class="code" href="FSAL__XFS_2fsal__rcp_8c.html#adb8723e585ed29f2370cddf90f6891bc">strcat</a>(tracebuff, <span class="stringliteral">&quot;[...]&quot;</span>);
<a name="l01175"></a>01175               <span class="keywordflow">break</span>;
<a name="l01176"></a>01176             }
<a name="l01177"></a>01177           <span class="keywordflow">else</span>
<a name="l01178"></a>01178             {
<a name="l01179"></a>01179               <a class="code" href="FSAL__XFS_2fsal__rcp_8c.html#adb8723e585ed29f2370cddf90f6891bc">strcat</a>(tracebuff, argv[i]);
<a name="l01180"></a>01180             }
<a name="l01181"></a>01181 
<a name="l01182"></a>01182         }
<a name="l01183"></a>01183     }
<a name="l01184"></a>01184   <a class="code" href="shell_8c.html#ab3fcf0204b77c7bf2d1464eaff1a1b6f">shell_PrintTrace</a>(context, tracebuff);
<a name="l01185"></a>01185 
<a name="l01186"></a>01186   <span class="comment">/* execute the command */</span>
<a name="l01187"></a>01187 
<a name="l01188"></a>01188   rc = command_func(argc, argv, output);
<a name="l01189"></a>01189 
<a name="l01190"></a>01190   <span class="comment">/* verbose trace */</span>
<a name="l01191"></a>01191 
<a name="l01192"></a>01192   snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;%s returned %d&quot;</span>, argv[0], rc);
<a name="l01193"></a>01193   <a class="code" href="shell_8c.html#ab3fcf0204b77c7bf2d1464eaff1a1b6f">shell_PrintTrace</a>(context, tracebuff);
<a name="l01194"></a>01194 
<a name="l01195"></a>01195   <span class="keywordflow">return</span> rc;
<a name="l01196"></a>01196 
<a name="l01197"></a>01197 }                               <span class="comment">/* shell_Execute */</span>
<a name="l01198"></a>01198 
<a name="l01199"></a>01199 <span class="comment">/*------------------------------------------------------------------</span>
<a name="l01200"></a>01200 <span class="comment"> *                 Shell ouput routines.</span>
<a name="l01201"></a>01201 <span class="comment"> *-----------------------------------------------------------------*/</span>
<a name="l01202"></a>01202 
<a name="l01207"></a><a class="code" href="shell_8h.html#a18ca6567e360fb3becf28c1e64b8c617">01207</a> <span class="keywordtype">void</span> <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">char</span> *error_msg)
<a name="l01208"></a>01208 {
<a name="l01209"></a>01209 
<a name="l01210"></a>01210   <span class="keywordtype">char</span> *input_name = <a class="code" href="shell__vars_8c.html#a29bc337d24deebcc1d223335830f03a4">get_var_value</a>(<span class="stringliteral">&quot;INPUT&quot;</span>);
<a name="l01211"></a>01211 
<a name="l01212"></a>01212   fprintf(stderr, <span class="stringliteral">&quot;******* ERROR in %s line %d: %s\n&quot;</span>,
<a name="l01213"></a>01213           (input_name ? input_name : <span class="stringliteral">&quot;?&quot;</span>), <a class="code" href="shell_8c.html#a70c732e9d24a5285ce46c7812e213bd0">shell_GetLine</a>(context), error_msg);
<a name="l01214"></a>01214 
<a name="l01215"></a>01215 }
<a name="l01216"></a>01216 
<a name="l01221"></a><a class="code" href="shell_8h.html#ab3fcf0204b77c7bf2d1464eaff1a1b6f">01221</a> <span class="keywordtype">void</span> <a class="code" href="shell_8c.html#ab3fcf0204b77c7bf2d1464eaff1a1b6f">shell_PrintTrace</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">char</span> *msg)
<a name="l01222"></a>01222 {
<a name="l01223"></a>01223 
<a name="l01224"></a>01224   <span class="keywordtype">char</span> *input_name;
<a name="l01225"></a>01225 
<a name="l01226"></a>01226   <span class="keywordflow">if</span>(<a class="code" href="shell_8c.html#a20edf96684135c0d368f0b2c868e2271">shell_GetVerbose</a>(context))
<a name="l01227"></a>01227     {
<a name="l01228"></a>01228       input_name = <a class="code" href="shell__vars_8c.html#a29bc337d24deebcc1d223335830f03a4">get_var_value</a>(<span class="stringliteral">&quot;INPUT&quot;</span>);
<a name="l01229"></a>01229 
<a name="l01230"></a>01230       fprintf(stderr, <span class="stringliteral">&quot;%s l.%d: %s\n&quot;</span>,
<a name="l01231"></a>01231               (input_name ? input_name : <span class="stringliteral">&quot;?&quot;</span>), <a class="code" href="shell_8c.html#a70c732e9d24a5285ce46c7812e213bd0">shell_GetLine</a>(context), msg);
<a name="l01232"></a>01232     }
<a name="l01233"></a>01233 
<a name="l01234"></a>01234 }
<a name="l01235"></a>01235 
<a name="l01236"></a>01236 <span class="comment">/*------------------------------------------------------------------</span>
<a name="l01237"></a>01237 <span class="comment"> *                 Shell state management routines.</span>
<a name="l01238"></a>01238 <span class="comment"> *-----------------------------------------------------------------*/</span>
<a name="l01239"></a>01239 
<a name="l01246"></a><a class="code" href="shell_8h.html#a451b3514751a63ed4efd5d209e2e268b">01246</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a451b3514751a63ed4efd5d209e2e268b">shell_SetLayer</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">char</span> *layer_name)
<a name="l01247"></a>01247 {
<a name="l01248"></a>01248 
<a name="l01249"></a>01249   <a class="code" href="structlayer__def____.html">layer_def_t</a> *layer = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01250"></a>01250   <span class="keywordtype">int</span> i, rc;
<a name="l01251"></a>01251   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01252"></a>01252 
<a name="l01253"></a>01253   <span class="comment">/* search for layer */</span>
<a name="l01254"></a>01254 
<a name="l01255"></a>01255   <span class="keywordflow">for</span>(i = 0; layer_list[i].<a class="code" href="structlayer__def____.html#ae3ce826183c3bd6b126511808dd1e449">layer_name</a>; i++)
<a name="l01256"></a>01256     {
<a name="l01257"></a>01257       <span class="keywordflow">if</span>(!strcasecmp(layer_name, layer_list[i].layer_name))
<a name="l01258"></a>01258         {
<a name="l01259"></a>01259           layer = &amp;layer_list[i];
<a name="l01260"></a>01260           <span class="keywordflow">break</span>;
<a name="l01261"></a>01261         }
<a name="l01262"></a>01262     }
<a name="l01263"></a>01263 
<a name="l01264"></a>01264   <span class="comment">/* saves current layer */</span>
<a name="l01265"></a>01265 
<a name="l01266"></a>01266   <span class="keywordflow">if</span>(layer)
<a name="l01267"></a>01267     {
<a name="l01268"></a>01268       <span class="comment">/* saves layer pointer */</span>
<a name="l01269"></a>01269 
<a name="l01270"></a>01270       context-&gt;<a class="code" href="structshell__state____.html#a6d0f8ff17a863ff9b78024b332d4f002">layer</a> = layer;
<a name="l01271"></a>01271 
<a name="l01272"></a>01272       <span class="comment">/* stores layer name into vars  */</span>
<a name="l01273"></a>01273 
<a name="l01274"></a>01274       rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;LAYER&quot;</span>, layer-&gt;<a class="code" href="structlayer__def____.html#ae3ce826183c3bd6b126511808dd1e449">layer_name</a>);
<a name="l01275"></a>01275 
<a name="l01276"></a>01276       <span class="keywordflow">if</span>(rc != 0)
<a name="l01277"></a>01277         {
<a name="l01278"></a>01278           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01279"></a>01279                    <span class="stringliteral">&quot;Error %d setting LAYER value to %s&quot;</span>, rc, layer-&gt;<a class="code" href="structlayer__def____.html#ae3ce826183c3bd6b126511808dd1e449">layer_name</a>);
<a name="l01280"></a>01280           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01281"></a>01281         }
<a name="l01282"></a>01282 
<a name="l01283"></a>01283       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Current layer is now %s&quot;</span>, layer-&gt;<a class="code" href="structlayer__def____.html#ae3ce826183c3bd6b126511808dd1e449">layer_name</a>);
<a name="l01284"></a>01284       <a class="code" href="shell_8c.html#ab3fcf0204b77c7bf2d1464eaff1a1b6f">shell_PrintTrace</a>(context, tracebuff);
<a name="l01285"></a>01285 
<a name="l01286"></a>01286       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01287"></a>01287 
<a name="l01288"></a>01288     }
<a name="l01289"></a>01289   <span class="keywordflow">else</span>
<a name="l01290"></a>01290     {
<a name="l01291"></a>01291       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Layer not found: %s&quot;</span>, layer_name);
<a name="l01292"></a>01292       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01293"></a>01293       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#add182c422eb915de7f9c9913f405b55b">SHELL_NOT_FOUND</a>;
<a name="l01294"></a>01294     }
<a name="l01295"></a>01295 
<a name="l01296"></a>01296 }                               <span class="comment">/* shell_SetLayer */</span>
<a name="l01297"></a>01297 
<a name="l01302"></a><a class="code" href="shell_8h.html#a87cc52ddf5ce6b0b8b6ea2655fe846cf">01302</a> <a class="code" href="structlayer__def____.html">layer_def_t</a> *<a class="code" href="shell_8c.html#a87cc52ddf5ce6b0b8b6ea2655fe846cf">shell_GetLayer</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context)
<a name="l01303"></a>01303 {
<a name="l01304"></a>01304 
<a name="l01305"></a>01305   <span class="keywordflow">return</span> context-&gt;<a class="code" href="structshell__state____.html#a6d0f8ff17a863ff9b78024b332d4f002">layer</a>;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307 }
<a name="l01308"></a>01308 
<a name="l01313"></a><a class="code" href="shell_8h.html#a203bdb77c7bc5de688f3eabc1b70c16a">01313</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a203bdb77c7bc5de688f3eabc1b70c16a">shell_SetStatus</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">int</span> returned_status)
<a name="l01314"></a>01314 {
<a name="l01315"></a>01315 
<a name="l01316"></a>01316   <span class="keywordtype">int</span> rc;
<a name="l01317"></a>01317   <span class="keywordtype">char</span> str_int[64];
<a name="l01318"></a>01318   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01319"></a>01319 
<a name="l01320"></a>01320   context-&gt;<a class="code" href="structshell__state____.html#aecc070dc56b42065153b28df3b48731d">status</a> = returned_status;
<a name="l01321"></a>01321 
<a name="l01322"></a>01322   snprintf(str_int, 64, <span class="stringliteral">&quot;%d&quot;</span>, returned_status);
<a name="l01323"></a>01323 
<a name="l01324"></a>01324   rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;STATUS&quot;</span>, str_int);
<a name="l01325"></a>01325 
<a name="l01326"></a>01326   <span class="keywordflow">if</span>(rc != 0)
<a name="l01327"></a>01327     {
<a name="l01328"></a>01328       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01329"></a>01329                <span class="stringliteral">&quot;Error %d setting STATUS value to %s&quot;</span>, rc, str_int);
<a name="l01330"></a>01330       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01331"></a>01331     }
<a name="l01332"></a>01332 
<a name="l01333"></a>01333   rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;?&quot;</span>, str_int);
<a name="l01334"></a>01334 
<a name="l01335"></a>01335   <span class="keywordflow">if</span>(rc != 0)
<a name="l01336"></a>01336     {
<a name="l01337"></a>01337       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Error %d setting ? value to %s&quot;</span>, rc, str_int);
<a name="l01338"></a>01338       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01339"></a>01339     }
<a name="l01340"></a>01340 
<a name="l01341"></a>01341   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01342"></a>01342 
<a name="l01343"></a>01343 }
<a name="l01344"></a>01344 
<a name="l01349"></a><a class="code" href="shell_8h.html#abad4a8ae0b0a2e36b9285c330a6fb973">01349</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#abad4a8ae0b0a2e36b9285c330a6fb973">shell_GetStatus</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context)
<a name="l01350"></a>01350 {
<a name="l01351"></a>01351   <span class="keywordflow">return</span> context-&gt;<a class="code" href="structshell__state____.html#aecc070dc56b42065153b28df3b48731d">status</a>;
<a name="l01352"></a>01352 }
<a name="l01353"></a>01353 
<a name="l01358"></a><a class="code" href="shell_8h.html#afd975f5d6931ed03c6a3f65c6c2a0a2b">01358</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#afd975f5d6931ed03c6a3f65c6c2a0a2b">shell_SetVerbose</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">char</span> *str_verbose)
<a name="l01359"></a>01359 {
<a name="l01360"></a>01360 
<a name="l01361"></a>01361   <span class="keywordtype">int</span> rc;
<a name="l01362"></a>01362   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01363"></a>01363 
<a name="l01364"></a>01364   <span class="keywordflow">if</span>(!strcasecmp(str_verbose, <span class="stringliteral">&quot;ON&quot;</span>) ||
<a name="l01365"></a>01365      !strcasecmp(str_verbose, <span class="stringliteral">&quot;TRUE&quot;</span>) ||
<a name="l01366"></a>01366      !strcasecmp(str_verbose, <span class="stringliteral">&quot;YES&quot;</span>) || !strcmp(str_verbose, <span class="stringliteral">&quot;1&quot;</span>))
<a name="l01367"></a>01367     {
<a name="l01368"></a>01368       context-&gt;<a class="code" href="structshell__state____.html#af1e01f5e2ea55d14d3e2dbafb9313262">verbose</a> = <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01369"></a>01369 
<a name="l01370"></a>01370       rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;VERBOSE&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>);
<a name="l01371"></a>01371 
<a name="l01372"></a>01372       <span class="keywordflow">if</span>(rc != 0)
<a name="l01373"></a>01373         {
<a name="l01374"></a>01374           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01375"></a>01375                    <span class="stringliteral">&quot;Error %d setting VERBOSE value to %s&quot;</span>, rc, <span class="stringliteral">&quot;1&quot;</span>);
<a name="l01376"></a>01376           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01377"></a>01377         }
<a name="l01378"></a>01378 
<a name="l01379"></a>01379       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381     }
<a name="l01382"></a>01382   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(str_verbose, <span class="stringliteral">&quot;OFF&quot;</span>) ||
<a name="l01383"></a>01383           !strcasecmp(str_verbose, <span class="stringliteral">&quot;FALSE&quot;</span>) ||
<a name="l01384"></a>01384           !strcasecmp(str_verbose, <span class="stringliteral">&quot;NO&quot;</span>) || !strcmp(str_verbose, <span class="stringliteral">&quot;0&quot;</span>))
<a name="l01385"></a>01385     {
<a name="l01386"></a>01386       context-&gt;<a class="code" href="structshell__state____.html#af1e01f5e2ea55d14d3e2dbafb9313262">verbose</a> = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01387"></a>01387 
<a name="l01388"></a>01388       rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;VERBOSE&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l01389"></a>01389 
<a name="l01390"></a>01390       <span class="keywordflow">if</span>(rc != 0)
<a name="l01391"></a>01391         {
<a name="l01392"></a>01392           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01393"></a>01393                    <span class="stringliteral">&quot;Error %d setting VERBOSE value to %s&quot;</span>, rc, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l01394"></a>01394           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01395"></a>01395         }
<a name="l01396"></a>01396 
<a name="l01397"></a>01397       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01398"></a>01398 
<a name="l01399"></a>01399     }
<a name="l01400"></a>01400   <span class="keywordflow">else</span>
<a name="l01401"></a>01401     {
<a name="l01402"></a>01402       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Unexpected value for VERBOSE: %s&quot;</span>, str_verbose);
<a name="l01403"></a>01403       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01404"></a>01404 
<a name="l01405"></a>01405       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l01406"></a>01406     }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408 }
<a name="l01409"></a>01409 
<a name="l01414"></a><a class="code" href="shell_8h.html#a20edf96684135c0d368f0b2c868e2271">01414</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a20edf96684135c0d368f0b2c868e2271">shell_GetVerbose</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context)
<a name="l01415"></a>01415 {
<a name="l01416"></a>01416   <span class="keywordflow">return</span> context-&gt;<a class="code" href="structshell__state____.html#af1e01f5e2ea55d14d3e2dbafb9313262">verbose</a>;
<a name="l01417"></a>01417 }
<a name="l01418"></a>01418 
<a name="l01423"></a><a class="code" href="shell_8h.html#a9566cc8471ed064191fab46360448790">01423</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a9566cc8471ed064191fab46360448790">shell_SetDbgLvl</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">char</span> *str_debug_level)
<a name="l01424"></a>01424 {
<a name="l01425"></a>01425   <span class="keywordtype">int</span> level_debug;
<a name="l01426"></a>01426   <span class="keywordtype">int</span> rc;
<a name="l01427"></a>01427   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01428"></a>01428 
<a name="l01429"></a>01429   level_debug = <a class="code" href="log_8h.html#ad6c63af5bd82d8eed2586f8c1af13871">ReturnLevelAscii</a>(str_debug_level);
<a name="l01430"></a>01430 
<a name="l01431"></a>01431   <span class="keywordflow">if</span>(level_debug != -1)
<a name="l01432"></a>01432     {
<a name="l01433"></a>01433       <span class="comment">/* set shell state */</span>
<a name="l01434"></a>01434       context-&gt;<a class="code" href="structshell__state____.html#a0dbfbd99cd492b36f310c006616a7fc9">debug_level</a> = level_debug;
<a name="l01435"></a>01435 
<a name="l01436"></a>01436       <span class="comment">/* call to logfunctions */</span>
<a name="l01437"></a>01437       <a class="code" href="log_8h.html#a61640e4aaca7a9df83a05849f6d001a9">SetLevelDebug</a>(level_debug);
<a name="l01438"></a>01438 
<a name="l01439"></a>01439       <span class="comment">/* set shell vars */</span>
<a name="l01440"></a>01440 
<a name="l01441"></a>01441       rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;DEBUG_LEVEL&quot;</span>, str_debug_level);
<a name="l01442"></a>01442 
<a name="l01443"></a>01443       <span class="keywordflow">if</span>(rc != 0)
<a name="l01444"></a>01444         {
<a name="l01445"></a>01445           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01446"></a>01446                    <span class="stringliteral">&quot;Error %d setting DEBUG_LEVEL value to %s&quot;</span>, rc, str_debug_level);
<a name="l01447"></a>01447           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01448"></a>01448         }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450       rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;DBG_LVL&quot;</span>, str_debug_level);
<a name="l01451"></a>01451 
<a name="l01452"></a>01452       <span class="keywordflow">if</span>(rc != 0)
<a name="l01453"></a>01453         {
<a name="l01454"></a>01454           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01455"></a>01455                    <span class="stringliteral">&quot;Error %d setting DBG_LVL value to %s&quot;</span>, rc, str_debug_level);
<a name="l01456"></a>01456           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01457"></a>01457         }
<a name="l01458"></a>01458 
<a name="l01459"></a>01459       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01460"></a>01460 
<a name="l01461"></a>01461     }
<a name="l01462"></a>01462   <span class="keywordflow">else</span>
<a name="l01463"></a>01463     {
<a name="l01464"></a>01464 
<a name="l01465"></a>01465       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01466"></a>01466                <span class="stringliteral">&quot;Unexpected value for DEBUG_LEVEL: %s&quot;</span>, str_debug_level);
<a name="l01467"></a>01467       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01468"></a>01468 
<a name="l01469"></a>01469       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l01470"></a>01470     }
<a name="l01471"></a>01471 
<a name="l01472"></a>01472 }                               <span class="comment">/* shell_SetDbgLvl */</span>
<a name="l01473"></a>01473 
<a name="l01478"></a><a class="code" href="shell_8h.html#ae8266753e0ec315e4f060c49f70dfc24">01478</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#ae8266753e0ec315e4f060c49f70dfc24">shell_GetDbgLvl</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context)
<a name="l01479"></a>01479 {
<a name="l01480"></a>01480   <span class="keywordflow">return</span> context-&gt;<a class="code" href="structshell__state____.html#a0dbfbd99cd492b36f310c006616a7fc9">debug_level</a>;
<a name="l01481"></a>01481 }
<a name="l01482"></a>01482 
<a name="l01491"></a><a class="code" href="shell_8h.html#a9b5002423a565157f01c09748f87cf75">01491</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a9b5002423a565157f01c09748f87cf75">shell_SetInput</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">char</span> *file_name)
<a name="l01492"></a>01492 {
<a name="l01493"></a>01493 
<a name="l01494"></a>01494   FILE *stream;
<a name="l01495"></a>01495   <span class="keywordtype">int</span> rc;
<a name="l01496"></a>01496   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01497"></a>01497 
<a name="l01498"></a>01498   <span class="keywordflow">if</span>(file_name)
<a name="l01499"></a>01499     {
<a name="l01500"></a>01500       <span class="keywordflow">if</span>((stream = fopen(file_name, <span class="stringliteral">&quot;r&quot;</span>)) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01501"></a>01501         {
<a name="l01502"></a>01502           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Can&#39;t open \&quot;%s\&quot;: %s (%d)&quot;</span>,
<a name="l01503"></a>01503                    file_name, strerror(errno), errno);
<a name="l01504"></a>01504           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01505"></a>01505           <span class="keywordflow">return</span> errno;
<a name="l01506"></a>01506         }
<a name="l01507"></a>01507 
<a name="l01508"></a>01508       <span class="comment">/* close previous filestream and reset line number */</span>
<a name="l01509"></a>01509       <span class="keywordflow">if</span>(context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a> != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01510"></a>01510         {
<a name="l01511"></a>01511           <span class="comment">/* don&#39;t close stdin */</span>
<a name="l01512"></a>01512           <span class="keywordflow">if</span>(context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a> != stdin)
<a name="l01513"></a>01513             fclose(context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a>);
<a name="l01514"></a>01514 
<a name="l01515"></a>01515           <a class="code" href="shell_8c.html#a45ff35a9de18915830a83de3bd62f2a1">shell_SetLine</a>(context, 0);
<a name="l01516"></a>01516         }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518       <span class="comment">/* set filestream */</span>
<a name="l01519"></a>01519       context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a> = stream;
<a name="l01520"></a>01520 
<a name="l01521"></a>01521       rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;INPUT&quot;</span>, file_name);
<a name="l01522"></a>01522 
<a name="l01523"></a>01523       <span class="keywordflow">if</span>(rc != 0)
<a name="l01524"></a>01524         {
<a name="l01525"></a>01525           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01526"></a>01526                    <span class="stringliteral">&quot;Error %d setting INPUT value to \&quot;%s\&quot;&quot;</span>, rc, file_name);
<a name="l01527"></a>01527           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01528"></a>01528         }
<a name="l01529"></a>01529 
<a name="l01530"></a>01530       <span class="comment">/* set interative mode to FALSE */</span>
<a name="l01531"></a>01531 
<a name="l01532"></a>01532       context-&gt;<a class="code" href="structshell__state____.html#ac19530794ea54d353fd0311833918b58">interactive</a> = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534       rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;INTERACTIVE&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l01535"></a>01535 
<a name="l01536"></a>01536       <span class="keywordflow">if</span>(rc != 0)
<a name="l01537"></a>01537         {
<a name="l01538"></a>01538           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01539"></a>01539                    <span class="stringliteral">&quot;Error %d setting INTERACTIVE value to %s&quot;</span>, rc, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l01540"></a>01540           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01541"></a>01541         }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Using script file \&quot;%s\&quot;&quot;</span>, file_name);
<a name="l01544"></a>01544       <a class="code" href="shell_8c.html#ab3fcf0204b77c7bf2d1464eaff1a1b6f">shell_PrintTrace</a>(context, tracebuff);
<a name="l01545"></a>01545 
<a name="l01546"></a>01546       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01547"></a>01547 
<a name="l01548"></a>01548     }
<a name="l01549"></a>01549   <span class="keywordflow">else</span>
<a name="l01550"></a>01550     {
<a name="l01551"></a>01551       stream = stdin;
<a name="l01552"></a>01552 
<a name="l01553"></a>01553       <span class="comment">/* close previous filestream and reset line number */</span>
<a name="l01554"></a>01554       <span class="keywordflow">if</span>(context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a> != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01555"></a>01555         {
<a name="l01556"></a>01556           <span class="comment">/* don&#39;t close stdin */</span>
<a name="l01557"></a>01557           <span class="keywordflow">if</span>(context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a> != stdin)
<a name="l01558"></a>01558             fclose(context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a>);
<a name="l01559"></a>01559           <a class="code" href="shell_8c.html#a45ff35a9de18915830a83de3bd62f2a1">shell_SetLine</a>(context, 0);
<a name="l01560"></a>01560         }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562       <span class="comment">/* set filestream */</span>
<a name="l01563"></a>01563       context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a> = stream;
<a name="l01564"></a>01564 
<a name="l01565"></a>01565       rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;INPUT&quot;</span>, <span class="stringliteral">&quot;&lt;stdin&gt;&quot;</span>);
<a name="l01566"></a>01566 
<a name="l01567"></a>01567       <span class="keywordflow">if</span>(rc != 0)
<a name="l01568"></a>01568         {
<a name="l01569"></a>01569           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01570"></a>01570                    <span class="stringliteral">&quot;Error %d setting INPUT value to %s&quot;</span>, rc, <span class="stringliteral">&quot;&lt;stdin&gt;&quot;</span>);
<a name="l01571"></a>01571           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01572"></a>01572         }
<a name="l01573"></a>01573 
<a name="l01574"></a>01574       <span class="comment">/* set interative mode to TRUE */</span>
<a name="l01575"></a>01575 
<a name="l01576"></a>01576       context-&gt;<a class="code" href="structshell__state____.html#ac19530794ea54d353fd0311833918b58">interactive</a> = <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578       rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;INTERACTIVE&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>);
<a name="l01579"></a>01579 
<a name="l01580"></a>01580       <span class="keywordflow">if</span>(rc != 0)
<a name="l01581"></a>01581         {
<a name="l01582"></a>01582           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01583"></a>01583                    <span class="stringliteral">&quot;Error %d setting INTERACTIVE value to %s&quot;</span>, rc, <span class="stringliteral">&quot;1&quot;</span>);
<a name="l01584"></a>01584           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01585"></a>01585         }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;Using standard input&quot;</span>);
<a name="l01588"></a>01588       <a class="code" href="shell_8c.html#ab3fcf0204b77c7bf2d1464eaff1a1b6f">shell_PrintTrace</a>(context, tracebuff);
<a name="l01589"></a>01589 
<a name="l01590"></a>01590       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     }
<a name="l01593"></a>01593 
<a name="l01594"></a>01594 }                               <span class="comment">/* shell_SetInput */</span>
<a name="l01595"></a>01595 
<a name="l01600"></a><a class="code" href="shell_8h.html#a9b53e69fbe0514fd49aa9f8da1a2a331">01600</a> FILE *<a class="code" href="shell_8c.html#a9b53e69fbe0514fd49aa9f8da1a2a331">shell_GetInputStream</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context)
<a name="l01601"></a>01601 {
<a name="l01602"></a>01602   <span class="keywordflow">if</span>(context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a>)
<a name="l01603"></a>01603     <span class="keywordflow">return</span> context-&gt;<a class="code" href="structshell__state____.html#ab9848d436ad635a7af41cf75e012f403">input_stream</a>;
<a name="l01604"></a>01604   <span class="keywordflow">else</span>
<a name="l01605"></a>01605     <span class="keywordflow">return</span> stdin;
<a name="l01606"></a>01606 }
<a name="l01607"></a>01607 
<a name="l01612"></a><a class="code" href="shell_8h.html#abaa1753ce1fbddda297f2c4234f90082">01612</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#abaa1753ce1fbddda297f2c4234f90082">shell_SetPrompt</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">char</span> *str_prompt)
<a name="l01613"></a>01613 {
<a name="l01614"></a>01614   <span class="keywordtype">int</span> rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;PROMPT&quot;</span>, str_prompt);
<a name="l01615"></a>01615   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01616"></a>01616 
<a name="l01617"></a>01617   <span class="keywordflow">if</span>(rc != 0)
<a name="l01618"></a>01618     {
<a name="l01619"></a>01619       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01620"></a>01620                <span class="stringliteral">&quot;Error %d setting PROMPT value to \&quot;%s\&quot;&quot;</span>, rc, str_prompt);
<a name="l01621"></a>01621       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01622"></a>01622     }
<a name="l01623"></a>01623 
<a name="l01624"></a>01624   <span class="keywordflow">return</span> rc;
<a name="l01625"></a>01625 }
<a name="l01626"></a>01626 
<a name="l01631"></a><a class="code" href="shell_8h.html#a44bbab19233a13358d0ea0ecc8250575">01631</a> <span class="keywordtype">char</span> *<a class="code" href="shell_8c.html#a44bbab19233a13358d0ea0ecc8250575">shell_GetPrompt</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context)
<a name="l01632"></a>01632 {
<a name="l01633"></a>01633   <span class="keywordflow">return</span> <a class="code" href="shell__vars_8c.html#a29bc337d24deebcc1d223335830f03a4">get_var_value</a>(<span class="stringliteral">&quot;PROMPT&quot;</span>);
<a name="l01634"></a>01634 }
<a name="l01635"></a>01635 
<a name="l01640"></a><a class="code" href="shell_8h.html#a74327c02354c2791d81e49b207b82882">01640</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a74327c02354c2791d81e49b207b82882">shell_SetShellId</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">int</span> shell_index)
<a name="l01641"></a>01641 {
<a name="l01642"></a>01642   <span class="keywordtype">int</span> rc;
<a name="l01643"></a>01643   <span class="keywordtype">char</span> str[64];
<a name="l01644"></a>01644   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01645"></a>01645 
<a name="l01646"></a>01646   snprintf(str, 64, <span class="stringliteral">&quot;%d&quot;</span>, shell_index);
<a name="l01647"></a>01647 
<a name="l01648"></a>01648   rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;SHELLID&quot;</span>, str);
<a name="l01649"></a>01649 
<a name="l01650"></a>01650   <span class="keywordflow">if</span>(rc != 0)
<a name="l01651"></a>01651     {
<a name="l01652"></a>01652       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01653"></a>01653                <span class="stringliteral">&quot;Error %d setting SHELLID value to \&quot;%s\&quot;&quot;</span>, rc, str);
<a name="l01654"></a>01654       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01655"></a>01655     }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01658"></a>01658 }
<a name="l01659"></a>01659 
<a name="l01664"></a><a class="code" href="shell_8h.html#a45ff35a9de18915830a83de3bd62f2a1">01664</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a45ff35a9de18915830a83de3bd62f2a1">shell_SetLine</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context, <span class="keywordtype">int</span> lineno)
<a name="l01665"></a>01665 {
<a name="l01666"></a>01666   <span class="keywordtype">int</span> rc;
<a name="l01667"></a>01667   <span class="keywordtype">char</span> str_line[64];
<a name="l01668"></a>01668   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01669"></a>01669 
<a name="l01670"></a>01670   context-&gt;<a class="code" href="structshell__state____.html#af791667e865551ff1ef99e5bd7fb5ebd">line</a> = lineno;
<a name="l01671"></a>01671 
<a name="l01672"></a>01672   snprintf(str_line, 64, <span class="stringliteral">&quot;%d&quot;</span>, lineno);
<a name="l01673"></a>01673 
<a name="l01674"></a>01674   rc = <a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(<span class="stringliteral">&quot;LINE&quot;</span>, str_line);
<a name="l01675"></a>01675 
<a name="l01676"></a>01676   <span class="keywordflow">if</span>(rc != 0)
<a name="l01677"></a>01677     {
<a name="l01678"></a>01678       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01679"></a>01679                <span class="stringliteral">&quot;Error %d setting LINE value to \&quot;%s\&quot;&quot;</span>, rc, str_line);
<a name="l01680"></a>01680       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(context, tracebuff);
<a name="l01681"></a>01681     }
<a name="l01682"></a>01682 
<a name="l01683"></a>01683   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01684"></a>01684 
<a name="l01685"></a>01685 }
<a name="l01686"></a>01686 
<a name="l01691"></a><a class="code" href="shell_8h.html#a70c732e9d24a5285ce46c7812e213bd0">01691</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a70c732e9d24a5285ce46c7812e213bd0">shell_GetLine</a>(<a class="code" href="structshell__state____.html">shell_state_t</a> * context)
<a name="l01692"></a>01692 {
<a name="l01693"></a>01693   <span class="keywordflow">return</span> context-&gt;<a class="code" href="structshell__state____.html#af791667e865551ff1ef99e5bd7fb5ebd">line</a>;
<a name="l01694"></a>01694 }
<a name="l01695"></a>01695 
<a name="l01696"></a>01696 <span class="comment">/*------------------------------------------------------------------</span>
<a name="l01697"></a>01697 <span class="comment"> *                      Shell commands.</span>
<a name="l01698"></a>01698 <span class="comment"> *-----------------------------------------------------------------*/</span>
<a name="l01699"></a>01699 
<a name="l01700"></a><a class="code" href="shell_8h.html#a899a09f6793b7f4710e8e99a60a8bc5e">01700</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a899a09f6793b7f4710e8e99a60a8bc5e">shellcmd_help</a>(<span class="keywordtype">int</span> argc,     <span class="comment">/* IN : number of args in argv */</span>
<a name="l01701"></a>01701                   <span class="keywordtype">char</span> **argv,  <span class="comment">/* IN : arg list               */</span>
<a name="l01702"></a>01702                   FILE * output <span class="comment">/* IN : output stream          */</span>
<a name="l01703"></a>01703     )
<a name="l01704"></a>01704 {
<a name="l01705"></a>01705 
<a name="l01706"></a>01706   <span class="keywordtype">int</span> i;
<a name="l01707"></a>01707   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01708"></a>01708   <a class="code" href="structlayer__def____.html">layer_def_t</a> *current_layer = <a class="code" href="shell_8c.html#a87cc52ddf5ce6b0b8b6ea2655fe846cf">shell_GetLayer</a>(GetShellContext());
<a name="l01709"></a>01709 
<a name="l01710"></a>01710   <span class="comment">/* check args */</span>
<a name="l01711"></a>01711 
<a name="l01712"></a>01712   <span class="keywordflow">if</span>(argc &gt; 1)
<a name="l01713"></a>01713     {
<a name="l01714"></a>01714       <span class="keywordflow">for</span>(i = 1; i &lt; argc; i++)
<a name="l01715"></a>01715         {
<a name="l01716"></a>01716           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01717"></a>01717                    <span class="stringliteral">&quot;%s: Unexpected argument \&quot;%s\&quot;&quot;</span>, argv[0], argv[i]);
<a name="l01718"></a>01718           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l01719"></a>01719         }
<a name="l01720"></a>01720     }
<a name="l01721"></a>01721 
<a name="l01722"></a>01722   <span class="comment">/* List shell build-in commands */</span>
<a name="l01723"></a>01723 
<a name="l01724"></a>01724   fprintf(output, <span class="stringliteral">&quot;Shell built-in commands:\n&quot;</span>);
<a name="l01725"></a>01725 
<a name="l01726"></a>01726   <span class="keywordflow">for</span>(i = 0; shell_commands[i].command_name; i++)
<a name="l01727"></a>01727     {
<a name="l01728"></a>01728       fprintf(output, <span class="stringliteral">&quot;   %15s: %s\n&quot;</span>, shell_commands[i].command_name,
<a name="l01729"></a>01729               shell_commands[i].command_help);
<a name="l01730"></a>01730     }
<a name="l01731"></a>01731 
<a name="l01732"></a>01732   <span class="comment">/* List shell tools commands */</span>
<a name="l01733"></a>01733 
<a name="l01734"></a>01734   fprintf(output, <span class="stringliteral">&quot;\nShell tools commands:\n&quot;</span>);
<a name="l01735"></a>01735 
<a name="l01736"></a>01736   <span class="keywordflow">for</span>(i = 0; shell_utils[i].<a class="code" href="structcommand__def____.html#a6470cd228728d90e6d137beb7b1e7b1a">command_name</a>; i++)
<a name="l01737"></a>01737     {
<a name="l01738"></a>01738       fprintf(output, <span class="stringliteral">&quot;   %15s: %s\n&quot;</span>, shell_utils[i].command_name,
<a name="l01739"></a>01739               shell_utils[i].command_help);
<a name="l01740"></a>01740     }
<a name="l01741"></a>01741 
<a name="l01742"></a>01742   <span class="comment">/* Layer list */</span>
<a name="l01743"></a>01743 
<a name="l01744"></a>01744   fprintf(output, <span class="stringliteral">&quot;\nLayers list:\n&quot;</span>);
<a name="l01745"></a>01745 
<a name="l01746"></a>01746   <span class="keywordflow">for</span>(i = 0; layer_list[i].<a class="code" href="structlayer__def____.html#ae3ce826183c3bd6b126511808dd1e449">layer_name</a>; i++)
<a name="l01747"></a>01747     {
<a name="l01748"></a>01748       fprintf(output, <span class="stringliteral">&quot;   %15s: %s\n&quot;</span>, layer_list[i].layer_name,
<a name="l01749"></a>01749               layer_list[i].layer_description);
<a name="l01750"></a>01750     }
<a name="l01751"></a>01751 
<a name="l01752"></a>01752   <span class="comment">/* Layer commands */</span>
<a name="l01753"></a>01753 
<a name="l01754"></a>01754   <span class="keywordflow">if</span>(current_layer)
<a name="l01755"></a>01755     {
<a name="l01756"></a>01756 
<a name="l01757"></a>01757       fprintf(output, <span class="stringliteral">&quot;\n%s layer commands:\n&quot;</span>, current_layer-&gt;<a class="code" href="structlayer__def____.html#ae3ce826183c3bd6b126511808dd1e449">layer_name</a>);
<a name="l01758"></a>01758 
<a name="l01759"></a>01759       <span class="keywordflow">for</span>(i = 0; current_layer-&gt;<a class="code" href="structlayer__def____.html#afd47e95d6f7af78b82d58856a08d5838">command_list</a>[i].<a class="code" href="structcommand__def____.html#a6470cd228728d90e6d137beb7b1e7b1a">command_name</a>; i++)
<a name="l01760"></a>01760         {
<a name="l01761"></a>01761           fprintf(output, <span class="stringliteral">&quot;   %15s: %s\n&quot;</span>, current_layer-&gt;<a class="code" href="structlayer__def____.html#afd47e95d6f7af78b82d58856a08d5838">command_list</a>[i].<a class="code" href="structcommand__def____.html#a6470cd228728d90e6d137beb7b1e7b1a">command_name</a>,
<a name="l01762"></a>01762                   current_layer-&gt;<a class="code" href="structlayer__def____.html#afd47e95d6f7af78b82d58856a08d5838">command_list</a>[i].<a class="code" href="structcommand__def____.html#a4251bac8477b9c896e6f411ea2081bd9">command_help</a>);
<a name="l01763"></a>01763         }
<a name="l01764"></a>01764 
<a name="l01765"></a>01765     }
<a name="l01766"></a>01766 
<a name="l01767"></a>01767   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01768"></a>01768 
<a name="l01769"></a>01769 }                               <span class="comment">/* shellcmd_help */</span>
<a name="l01770"></a>01770 
<a name="l01771"></a><a class="code" href="shell_8h.html#aad4894a22c4fb42b1c283550b645a08e">01771</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#aad4894a22c4fb42b1c283550b645a08e">shellcmd_if</a>(<span class="keywordtype">int</span> argc,       <span class="comment">/* IN : number of args in argv */</span>
<a name="l01772"></a>01772                 <span class="keywordtype">char</span> **argv,    <span class="comment">/* IN : arg list               */</span>
<a name="l01773"></a>01773                 FILE * output   <span class="comment">/* IN : output stream          */</span>
<a name="l01774"></a>01774     )
<a name="l01775"></a>01775 {
<a name="l01776"></a>01776 
<a name="l01777"></a>01777   <span class="keywordtype">int</span> i, rc;
<a name="l01778"></a>01778   <span class="keywordtype">int</span> index_test = -1;
<a name="l01779"></a>01779   <span class="keywordtype">int</span> longueur_test = -1;
<a name="l01780"></a>01780   <span class="keywordtype">int</span> index_cmd1 = -1;
<a name="l01781"></a>01781   <span class="keywordtype">int</span> longueur_cmd1 = -1;
<a name="l01782"></a>01782   <span class="keywordtype">int</span> index_cmd2 = -1;
<a name="l01783"></a>01783   <span class="keywordtype">int</span> longueur_cmd2 = -1;
<a name="l01784"></a>01784 
<a name="l01785"></a>01785   <span class="keyword">const</span> <span class="keywordtype">char</span> *help_if =
<a name="l01786"></a>01786       <span class="stringliteral">&quot;Usage: if command0 ? command1 [: command2]\n&quot;</span>
<a name="l01787"></a>01787       <span class="stringliteral">&quot;   Execute command1 if command0 returns a null status.\n&quot;</span>
<a name="l01788"></a>01788       <span class="stringliteral">&quot;   Else, execute command2 (if any).\n&quot;</span>
<a name="l01789"></a>01789       <span class="stringliteral">&quot;Ex: if eq -n $STATUS 0 ? print \&quot;status=0\&quot; : print \&quot;status&lt;&gt;0\&quot; \n&quot;</span>;
<a name="l01790"></a>01790 
<a name="l01791"></a>01791   <span class="comment">/* first, check that there is a test */</span>
<a name="l01792"></a>01792   <span class="keywordflow">if</span>(argc &gt; 1)
<a name="l01793"></a>01793     {
<a name="l01794"></a>01794 
<a name="l01795"></a>01795       index_test = 1;
<a name="l01796"></a>01796 
<a name="l01797"></a>01797       i = index_test + 1;
<a name="l01798"></a>01798 
<a name="l01799"></a>01799       <span class="comment">/* look for command 1 */</span>
<a name="l01800"></a>01800 
<a name="l01801"></a>01801       <span class="keywordflow">while</span>((i &lt; argc) &amp;&amp; strcmp(argv[i], <span class="stringliteral">&quot;?&quot;</span>))
<a name="l01802"></a>01802         i++;
<a name="l01803"></a>01803 
<a name="l01804"></a>01804       <span class="keywordflow">if</span>(i + 1 &lt; argc)
<a name="l01805"></a>01805         {
<a name="l01806"></a>01806           longueur_test = i - index_test;
<a name="l01807"></a>01807           index_cmd1 = i + 1;
<a name="l01808"></a>01808 
<a name="l01809"></a>01809           i = index_cmd1 + 1;
<a name="l01810"></a>01810 
<a name="l01811"></a>01811           <span class="comment">/* look for command 2 */</span>
<a name="l01812"></a>01812 
<a name="l01813"></a>01813           <span class="keywordflow">while</span>((i &lt; argc) &amp;&amp; strcmp(argv[i], <span class="stringliteral">&quot;:&quot;</span>))
<a name="l01814"></a>01814             i++;
<a name="l01815"></a>01815 
<a name="l01816"></a>01816           <span class="keywordflow">if</span>(i + 1 &lt; argc)
<a name="l01817"></a>01817             {
<a name="l01818"></a>01818               longueur_cmd1 = i - index_cmd1;
<a name="l01819"></a>01819               index_cmd2 = i + 1;
<a name="l01820"></a>01820               longueur_cmd2 = argc - index_cmd2;
<a name="l01821"></a>01821             }
<a name="l01822"></a>01822           <span class="keywordflow">else</span>
<a name="l01823"></a>01823             {
<a name="l01824"></a>01824               longueur_cmd1 = argc - index_cmd1;
<a name="l01825"></a>01825             }
<a name="l01826"></a>01826 
<a name="l01827"></a>01827         }
<a name="l01828"></a>01828       <span class="keywordflow">else</span>
<a name="l01829"></a>01829         {
<a name="l01830"></a>01830           longueur_test = argc - index_test;
<a name="l01831"></a>01831         }
<a name="l01832"></a>01832 
<a name="l01833"></a>01833     }
<a name="l01834"></a>01834 
<a name="l01835"></a>01835   <span class="comment">/* test or cmd1 missing */</span>
<a name="l01836"></a>01836 
<a name="l01837"></a>01837   <span class="keywordflow">if</span>((longueur_test &lt;= 0) || (longueur_cmd1 &lt;= 0))
<a name="l01838"></a>01838     {
<a name="l01839"></a>01839       fprintf(output, help_if, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01840"></a>01840       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l01841"></a>01841     }
<a name="l01842"></a>01842 
<a name="l01843"></a>01843   <span class="comment">/* executes test */</span>
<a name="l01844"></a>01844 
<a name="l01845"></a>01845   rc = <a class="code" href="shell_8c.html#a10dd9a60b110b6c798b902af2378e212">shell_Execute</a>(longueur_test, &amp;(argv[index_test]), output);
<a name="l01846"></a>01846 
<a name="l01847"></a>01847   <span class="comment">/* if rc is not null, executes command 1 */</span>
<a name="l01848"></a>01848   <span class="keywordflow">if</span>(rc)
<a name="l01849"></a>01849     {
<a name="l01850"></a>01850       <span class="keywordflow">return</span> <a class="code" href="shell_8c.html#a10dd9a60b110b6c798b902af2378e212">shell_Execute</a>(longueur_cmd1, &amp;(argv[index_cmd1]), output);
<a name="l01851"></a>01851     }
<a name="l01852"></a>01852   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(longueur_cmd2 &gt; 0)
<a name="l01853"></a>01853     {
<a name="l01854"></a>01854       <span class="keywordflow">return</span> <a class="code" href="shell_8c.html#a10dd9a60b110b6c798b902af2378e212">shell_Execute</a>(longueur_cmd2, &amp;(argv[index_cmd2]), output);
<a name="l01855"></a>01855     }
<a name="l01856"></a>01856 
<a name="l01857"></a>01857   <span class="keywordflow">return</span> 0;
<a name="l01858"></a>01858 
<a name="l01859"></a>01859 }                               <span class="comment">/* shellcmd_if */</span>
<a name="l01860"></a>01860 
<a name="l01861"></a><a class="code" href="shell_8h.html#a65d6f4320066d4ebbd24d495c3197db3">01861</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a65d6f4320066d4ebbd24d495c3197db3">shellcmd_interactive</a>(<span class="keywordtype">int</span> argc,      <span class="comment">/* IN : number of args in argv */</span>
<a name="l01862"></a>01862                          <span class="keywordtype">char</span> **argv,   <span class="comment">/* IN : arg list               */</span>
<a name="l01863"></a>01863                          FILE * output  <span class="comment">/* IN : output stream          */</span>
<a name="l01864"></a>01864     )
<a name="l01865"></a>01865 {
<a name="l01866"></a>01866   <span class="keywordtype">int</span> i;
<a name="l01867"></a>01867   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01868"></a>01868 
<a name="l01869"></a>01869   <span class="comment">/* check args */</span>
<a name="l01870"></a>01870 
<a name="l01871"></a>01871   <span class="keywordflow">if</span>(argc &gt; 1)
<a name="l01872"></a>01872     {
<a name="l01873"></a>01873       <span class="keywordflow">for</span>(i = 1; i &lt; argc; i++)
<a name="l01874"></a>01874         {
<a name="l01875"></a>01875           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01876"></a>01876                    <span class="stringliteral">&quot;%s: Unexpected argument \&quot;%s\&quot;&quot;</span>, argv[0], argv[i]);
<a name="l01877"></a>01877           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l01878"></a>01878         }
<a name="l01879"></a>01879     }
<a name="l01880"></a>01880 
<a name="l01881"></a>01881   <span class="comment">/* set input as stdin */</span>
<a name="l01882"></a>01882 
<a name="l01883"></a>01883   <span class="keywordflow">return</span> <a class="code" href="shell_8c.html#a9b5002423a565157f01c09748f87cf75">shell_SetInput</a>(GetShellContext(), <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01884"></a>01884 
<a name="l01885"></a>01885 }                               <span class="comment">/* shellcmd_interactive */</span>
<a name="l01886"></a>01886 
<a name="l01887"></a><a class="code" href="shell_8h.html#a2c49685b957c7ac4d00a3ec0f0054225">01887</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a2c49685b957c7ac4d00a3ec0f0054225">shellcmd_set</a>(<span class="keywordtype">int</span> argc,      <span class="comment">/* IN : number of args in argv */</span>
<a name="l01888"></a>01888                  <span class="keywordtype">char</span> **argv,   <span class="comment">/* IN : arg list               */</span>
<a name="l01889"></a>01889                  FILE * output  <span class="comment">/* IN : output stream          */</span>
<a name="l01890"></a>01890     )
<a name="l01891"></a>01891 {
<a name="l01892"></a>01892 
<a name="l01893"></a>01893   <span class="keywordtype">int</span> i;
<a name="l01894"></a>01894   <span class="keywordtype">char</span> *varname;
<a name="l01895"></a>01895   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l01896"></a>01896   <span class="keywordtype">char</span> varvalue[<a class="code" href="shell_8c.html#a6f47cadd2e292d89353544ae32672e9b">MAX_OUTPUT_LEN</a>];
<a name="l01897"></a>01897 
<a name="l01898"></a>01898   <span class="comment">/* check args */</span>
<a name="l01899"></a>01899 
<a name="l01900"></a>01900   <span class="keywordflow">if</span>(argc &lt; 3)
<a name="l01901"></a>01901     {
<a name="l01902"></a>01902       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01903"></a>01903                <span class="stringliteral">&quot;%s: Usage: %s &lt;var_name&gt; &lt;expr1&gt; [&lt;expr2&gt; ...&lt;exprN&gt;]&quot;</span>, argv[0], argv[0]);
<a name="l01904"></a>01904       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l01905"></a>01905 
<a name="l01906"></a>01906       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l01907"></a>01907     }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909   varname = argv[1];
<a name="l01910"></a>01910 
<a name="l01911"></a>01911   varvalue[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01912"></a>01912 
<a name="l01913"></a>01913   <span class="comment">/* concatenation of strings */</span>
<a name="l01914"></a>01914 
<a name="l01915"></a>01915   <span class="keywordflow">for</span>(i = 2; i &lt; argc; i++)
<a name="l01916"></a>01916     <span class="keywordflow">if</span>(<a class="code" href="cmd__tools_8c.html#a848f9515f036e0d86c6369fd03f80774">concat</a>(varvalue, argv[i], <a class="code" href="shell_8c.html#a6f47cadd2e292d89353544ae32672e9b">MAX_OUTPUT_LEN</a>) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01917"></a>01917       {
<a name="l01918"></a>01918         <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), <span class="stringliteral">&quot;Output too large.&quot;</span>);
<a name="l01919"></a>01919         <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l01920"></a>01920       }
<a name="l01921"></a>01921 
<a name="l01922"></a>01922   <span class="comment">/* special variables */</span>
<a name="l01923"></a>01923 
<a name="l01924"></a>01924   <span class="keywordflow">if</span>(!strcmp(varname, <span class="stringliteral">&quot;INPUT&quot;</span>))
<a name="l01925"></a>01925     {
<a name="l01926"></a>01926       <span class="keywordflow">return</span> <a class="code" href="shell_8c.html#a9b5002423a565157f01c09748f87cf75">shell_SetInput</a>(GetShellContext(), varvalue);
<a name="l01927"></a>01927     }
<a name="l01928"></a>01928   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(varname, <span class="stringliteral">&quot;INTERACTIVE&quot;</span>))
<a name="l01929"></a>01929     {
<a name="l01930"></a>01930       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l01931"></a>01931                <span class="stringliteral">&quot;%s: cannot set \&quot;%s\&quot;: set the value of \&quot;INPUT\&quot; or use the \&quot;interactive\&quot; command instead.&quot;</span>,
<a name="l01932"></a>01932                argv[0], varname);
<a name="l01933"></a>01933       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l01934"></a>01934 
<a name="l01935"></a>01935       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l01936"></a>01936 
<a name="l01937"></a>01937     }
<a name="l01938"></a>01938   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(varname, <span class="stringliteral">&quot;LAYER&quot;</span>))
<a name="l01939"></a>01939     {
<a name="l01940"></a>01940       <span class="keywordflow">return</span> <a class="code" href="shell_8c.html#a451b3514751a63ed4efd5d209e2e268b">shell_SetLayer</a>(GetShellContext(), varvalue);
<a name="l01941"></a>01941     }
<a name="l01942"></a>01942   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(varname, <span class="stringliteral">&quot;STATUS&quot;</span>) || !strcmp(varname, <span class="stringliteral">&quot;?&quot;</span>))
<a name="l01943"></a>01943     {
<a name="l01944"></a>01944       <span class="keywordflow">return</span> <a class="code" href="shell_8c.html#a203bdb77c7bc5de688f3eabc1b70c16a">shell_SetStatus</a>(GetShellContext(), <a class="code" href="cmd__tools_8c.html#a688b18dd9abbd7f9b3bab90531c0a066">my_atoi</a>(varvalue));
<a name="l01945"></a>01945     }
<a name="l01946"></a>01946   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(varname, <span class="stringliteral">&quot;VERBOSE&quot;</span>))
<a name="l01947"></a>01947     {
<a name="l01948"></a>01948       <span class="keywordflow">return</span> <a class="code" href="shell_8c.html#afd975f5d6931ed03c6a3f65c6c2a0a2b">shell_SetVerbose</a>(GetShellContext(), varvalue);
<a name="l01949"></a>01949     }
<a name="l01950"></a>01950   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(varname, <span class="stringliteral">&quot;DEBUG_LEVEL&quot;</span>) || !strcmp(varname, <span class="stringliteral">&quot;DBG_LVL&quot;</span>))
<a name="l01951"></a>01951     {
<a name="l01952"></a>01952       <span class="keywordflow">return</span> <a class="code" href="shell_8c.html#a9566cc8471ed064191fab46360448790">shell_SetDbgLvl</a>(GetShellContext(), varvalue);
<a name="l01953"></a>01953     }
<a name="l01954"></a>01954   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(varname, <span class="stringliteral">&quot;PROMPT&quot;</span>))
<a name="l01955"></a>01955     {
<a name="l01956"></a>01956       <span class="keywordflow">return</span> <a class="code" href="shell_8c.html#abaa1753ce1fbddda297f2c4234f90082">shell_SetPrompt</a>(GetShellContext(), varvalue);
<a name="l01957"></a>01957     }
<a name="l01958"></a>01958   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(varname, <span class="stringliteral">&quot;LINE&quot;</span>))
<a name="l01959"></a>01959     {
<a name="l01960"></a>01960       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;%s: cannot set \&quot;%s\&quot;.&quot;</span>, argv[0], varname);
<a name="l01961"></a>01961       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l01962"></a>01962       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l01963"></a>01963     }
<a name="l01964"></a>01964   <span class="keywordflow">else</span>
<a name="l01965"></a>01965     {
<a name="l01966"></a>01966 
<a name="l01967"></a>01967       <span class="comment">/* other variables */</span>
<a name="l01968"></a>01968 
<a name="l01969"></a>01969       <span class="keywordflow">if</span>(!<a class="code" href="shell__vars_8c.html#af857dc4843a1ef1f36d21b6060578470">is_authorized_varname</a>(varname))
<a name="l01970"></a>01970         {
<a name="l01971"></a>01971           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;%s: Invalid variable name \&quot;%s\&quot;.&quot;</span>, argv[0],
<a name="l01972"></a>01972                    varname);
<a name="l01973"></a>01973           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l01974"></a>01974           <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l01975"></a>01975         }
<a name="l01976"></a>01976 
<a name="l01977"></a>01977       <span class="keywordflow">if</span>(<a class="code" href="shell__vars_8c.html#a42c616a19301305c64bfd5abc4b45add">set_var_value</a>(varname, varvalue))
<a name="l01978"></a>01978         {
<a name="l01979"></a>01979           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;%s: Error setting the value of \&quot;%s\&quot;.&quot;</span>,
<a name="l01980"></a>01980                    argv[0], varname);
<a name="l01981"></a>01981           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l01982"></a>01982           <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l01983"></a>01983         }
<a name="l01984"></a>01984 
<a name="l01985"></a>01985       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l01986"></a>01986 
<a name="l01987"></a>01987     }
<a name="l01988"></a>01988 
<a name="l01989"></a>01989   <span class="comment">/* should never happen */</span>
<a name="l01990"></a>01990   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l01991"></a>01991 
<a name="l01992"></a>01992 }                               <span class="comment">/* shellcmd_set */</span>
<a name="l01993"></a>01993 
<a name="l01994"></a><a class="code" href="shell_8h.html#a15fa32a0d835185c2c4a70a37ba0c700">01994</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a15fa32a0d835185c2c4a70a37ba0c700">shellcmd_unset</a>(<span class="keywordtype">int</span> argc,    <span class="comment">/* IN : number of args in argv */</span>
<a name="l01995"></a>01995                    <span class="keywordtype">char</span> **argv, <span class="comment">/* IN : arg list               */</span>
<a name="l01996"></a>01996                    FILE * output        <span class="comment">/* IN : output stream          */</span>
<a name="l01997"></a>01997     )
<a name="l01998"></a>01998 {
<a name="l01999"></a>01999 
<a name="l02000"></a>02000   <span class="keywordtype">int</span> i, arg_idx;
<a name="l02001"></a>02001   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l02002"></a>02002   <span class="keywordtype">int</span> <a class="code" href="subr_8c.html#a1f2a342148fd3d57e387199914dd94c8">error</a> = <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l02003"></a>02003 
<a name="l02004"></a>02004   <span class="keywordflow">if</span>(argc &lt;= 1)
<a name="l02005"></a>02005     {
<a name="l02006"></a>02006       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>, <span class="stringliteral">&quot;%s: Missing argument: &lt;var name&gt;&quot;</span>, argv[0]);
<a name="l02007"></a>02007       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l02008"></a>02008 
<a name="l02009"></a>02009       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l02010"></a>02010     }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012   <span class="keywordflow">for</span>(arg_idx = 1; arg_idx &lt; argc; arg_idx++)
<a name="l02013"></a>02013     {
<a name="l02014"></a>02014 
<a name="l02015"></a>02015       <span class="comment">/* check if it is not a special var */</span>
<a name="l02016"></a>02016 
<a name="l02017"></a>02017       <span class="keywordflow">for</span>(i = 0; <a class="code" href="shell_8c.html#a1e3eb6c0416edacc075dcb2c77cba33d">shell_special_vars</a>[i] != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; i++)
<a name="l02018"></a>02018         {
<a name="l02019"></a>02019 
<a name="l02020"></a>02020           <span class="keywordflow">if</span>(!strcmp(<a class="code" href="shell_8c.html#a1e3eb6c0416edacc075dcb2c77cba33d">shell_special_vars</a>[i], argv[arg_idx]))
<a name="l02021"></a>02021             {
<a name="l02022"></a>02022 
<a name="l02023"></a>02023               snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l02024"></a>02024                        <span class="stringliteral">&quot;%s: This special variable cannot be deleted: \&quot;%s\&quot;&quot;</span>, argv[0],
<a name="l02025"></a>02025                        argv[arg_idx]);
<a name="l02026"></a>02026               <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l02027"></a>02027 
<a name="l02028"></a>02028               <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l02029"></a>02029 
<a name="l02030"></a>02030             }
<a name="l02031"></a>02031 
<a name="l02032"></a>02032         }
<a name="l02033"></a>02033 
<a name="l02034"></a>02034       <span class="comment">/* unset the variable */</span>
<a name="l02035"></a>02035 
<a name="l02036"></a>02036       <span class="keywordflow">if</span>(<a class="code" href="shell__vars_8c.html#a228c7f788656a8815ca10a5e942d3705">free_var</a>(argv[arg_idx]))
<a name="l02037"></a>02037         {
<a name="l02038"></a>02038           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l02039"></a>02039                    <span class="stringliteral">&quot;%s: Variable not found: \&quot;%s\&quot;&quot;</span>, argv[0], argv[arg_idx]);
<a name="l02040"></a>02040           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l02041"></a>02041 
<a name="l02042"></a>02042           error = <a class="code" href="shell_8h.html#add182c422eb915de7f9c9913f405b55b">SHELL_NOT_FOUND</a>;
<a name="l02043"></a>02043           <span class="comment">/* however, continue */</span>
<a name="l02044"></a>02044         }
<a name="l02045"></a>02045 
<a name="l02046"></a>02046     }
<a name="l02047"></a>02047 
<a name="l02048"></a>02048   <span class="keywordflow">return</span> <a class="code" href="subr_8c.html#a1f2a342148fd3d57e387199914dd94c8">error</a>;
<a name="l02049"></a>02049 
<a name="l02050"></a>02050 }                               <span class="comment">/* shellcmd_unset */</span>
<a name="l02051"></a>02051 
<a name="l02052"></a><a class="code" href="shell_8h.html#a10a8c42cadb842e426fea11044c8ca09">02052</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a10a8c42cadb842e426fea11044c8ca09">shellcmd_print</a>(<span class="keywordtype">int</span> argc,    <span class="comment">/* IN : number of args in argv */</span>
<a name="l02053"></a>02053                    <span class="keywordtype">char</span> **argv, <span class="comment">/* IN : arg list               */</span>
<a name="l02054"></a>02054                    FILE * output        <span class="comment">/* IN : output stream          */</span>
<a name="l02055"></a>02055     )
<a name="l02056"></a>02056 {
<a name="l02057"></a>02057 
<a name="l02058"></a>02058   <span class="keywordtype">int</span> i;
<a name="l02059"></a>02059 
<a name="l02060"></a>02060   <span class="comment">/* print args */</span>
<a name="l02061"></a>02061   <span class="keywordflow">for</span>(i = 1; i &lt; argc; i++)
<a name="l02062"></a>02062     fprintf(output, <span class="stringliteral">&quot;%s&quot;</span>, argv[i]);
<a name="l02063"></a>02063 
<a name="l02064"></a>02064   fprintf(output, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02065"></a>02065 
<a name="l02066"></a>02066   <span class="keywordflow">return</span> 0;
<a name="l02067"></a>02067 
<a name="l02068"></a>02068 }                               <span class="comment">/* shellcmd_print */</span>
<a name="l02069"></a>02069 
<a name="l02070"></a><a class="code" href="shell_8h.html#a1ad9c62ea92ab2d02f5f2eb5d5c1fcb6">02070</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#a1ad9c62ea92ab2d02f5f2eb5d5c1fcb6">shellcmd_varlist</a>(<span class="keywordtype">int</span> argc,  <span class="comment">/* IN : number of args in argv */</span>
<a name="l02071"></a>02071                      <span class="keywordtype">char</span> **argv,       <span class="comment">/* IN : arg list               */</span>
<a name="l02072"></a>02072                      FILE * output      <span class="comment">/* IN : output stream          */</span>
<a name="l02073"></a>02073     )
<a name="l02074"></a>02074 {
<a name="l02075"></a>02075   <span class="keywordtype">int</span> i;
<a name="l02076"></a>02076   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l02077"></a>02077 
<a name="l02078"></a>02078   <span class="comment">/* check args */</span>
<a name="l02079"></a>02079 
<a name="l02080"></a>02080   <span class="keywordflow">if</span>(argc &gt; 1)
<a name="l02081"></a>02081     {
<a name="l02082"></a>02082       <span class="keywordflow">for</span>(i = 1; i &lt; argc; i++)
<a name="l02083"></a>02083         {
<a name="l02084"></a>02084           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l02085"></a>02085                    <span class="stringliteral">&quot;%s: Unexpected argument \&quot;%s\&quot;&quot;</span>, argv[0], argv[i]);
<a name="l02086"></a>02086           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l02087"></a>02087         }
<a name="l02088"></a>02088     }
<a name="l02089"></a>02089 
<a name="l02090"></a>02090   <a class="code" href="shell__vars_8c.html#a108be7d3668f688da7ac24d2e95f89c6">print_varlist</a>(output, <a class="code" href="shell_8c.html#a20edf96684135c0d368f0b2c868e2271">shell_GetVerbose</a>(GetShellContext()));
<a name="l02091"></a>02091 
<a name="l02092"></a>02092   <span class="keywordflow">return</span> 0;
<a name="l02093"></a>02093 
<a name="l02094"></a>02094 }                               <span class="comment">/* shellcmd_varlist */</span>
<a name="l02095"></a>02095 
<a name="l02096"></a><a class="code" href="shell_8h.html#aaa214b88c7f47effc68fad8d6d833305">02096</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#aaa214b88c7f47effc68fad8d6d833305">shellcmd_time</a>(<span class="keywordtype">int</span> argc,     <span class="comment">/* IN : number of args in argv */</span>
<a name="l02097"></a>02097                   <span class="keywordtype">char</span> **argv,  <span class="comment">/* IN : arg list               */</span>
<a name="l02098"></a>02098                   FILE * output <span class="comment">/* IN : output stream          */</span>
<a name="l02099"></a>02099     )
<a name="l02100"></a>02100 {
<a name="l02101"></a>02101 
<a name="l02102"></a>02102   <span class="keyword">const</span> <span class="keywordtype">char</span> help_time[] =
<a name="l02103"></a>02103       <span class="stringliteral">&quot;Usage: time command [args ...]\n&quot;</span>
<a name="l02104"></a>02104       <span class="stringliteral">&quot;   Measure the time for executing a command.\n&quot;</span> <span class="stringliteral">&quot;Ex: time shell ls\n&quot;</span>;
<a name="l02105"></a>02105 
<a name="l02106"></a>02106   <span class="keyword">struct </span>timeval timer_start;
<a name="l02107"></a>02107   <span class="keyword">struct </span>timeval timer_stop;
<a name="l02108"></a>02108   <span class="keyword">struct </span>timeval timer_tmp;
<a name="l02109"></a>02109 
<a name="l02110"></a>02110   <span class="keywordtype">int</span> rc;
<a name="l02111"></a>02111 
<a name="l02112"></a>02112   <span class="comment">/* first, check that there is a test */</span>
<a name="l02113"></a>02113   <span class="keywordflow">if</span>(argc &lt; 2)
<a name="l02114"></a>02114     {
<a name="l02115"></a>02115       fprintf(output, help_time);
<a name="l02116"></a>02116       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae57f36c670720db06c26bf88a9f17a5b">SHELL_SYNTAX_ERROR</a>;
<a name="l02117"></a>02117     }
<a name="l02118"></a>02118 
<a name="l02119"></a>02119   <span class="keywordflow">if</span>(gettimeofday(&amp;timer_start, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) == -1)
<a name="l02120"></a>02120     {
<a name="l02121"></a>02121       fprintf(output, <span class="stringliteral">&quot;Error retrieving system time.\n&quot;</span>);
<a name="l02122"></a>02122       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l02123"></a>02123     }
<a name="l02124"></a>02124 
<a name="l02125"></a>02125   rc = <a class="code" href="shell_8c.html#a10dd9a60b110b6c798b902af2378e212">shell_Execute</a>(argc - 1, &amp;(argv[1]), output);
<a name="l02126"></a>02126 
<a name="l02127"></a>02127   <span class="keywordflow">if</span>(gettimeofday(&amp;timer_stop, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) == -1)
<a name="l02128"></a>02128     {
<a name="l02129"></a>02129       fprintf(output, <span class="stringliteral">&quot;Error retrieving system time.\n&quot;</span>);
<a name="l02130"></a>02130       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l02131"></a>02131     }
<a name="l02132"></a>02132 
<a name="l02133"></a>02133   timer_tmp = <a class="code" href="nfs__stat_8h.html#acf045ccad77a69933c72ecf0f7beeb14">time_diff</a>(timer_start, timer_stop);
<a name="l02134"></a>02134   fprintf(output, <span class="stringliteral">&quot;\nExecution time for command \&quot;%s\&quot;: &quot;</span>, argv[1]);
<a name="l02135"></a>02135   <a class="code" href="cmd__tools_8h.html#a1424b3bf6847b8179a9e3b25a9c4863b">print_timeval</a>(output, timer_tmp);
<a name="l02136"></a>02136 
<a name="l02137"></a>02137   <span class="keywordflow">return</span> rc;
<a name="l02138"></a>02138 
<a name="l02139"></a>02139 }                               <span class="comment">/* shellcmd_time */</span>
<a name="l02140"></a>02140 
<a name="l02141"></a><a class="code" href="shell_8h.html#ad21971f2f359ed0dab17c56affe4666e">02141</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#ad21971f2f359ed0dab17c56affe4666e">shellcmd_quit</a>(<span class="keywordtype">int</span> argc,     <span class="comment">/* IN : number of args in argv */</span>
<a name="l02142"></a>02142                   <span class="keywordtype">char</span> **argv,  <span class="comment">/* IN : arg list               */</span>
<a name="l02143"></a>02143                   FILE * output <span class="comment">/* IN : output stream          */</span>
<a name="l02144"></a>02144     )
<a name="l02145"></a>02145 {
<a name="l02146"></a>02146   <span class="keywordtype">int</span> i;
<a name="l02147"></a>02147   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l02148"></a>02148 
<a name="l02149"></a>02149   <span class="comment">/* check args */</span>
<a name="l02150"></a>02150 
<a name="l02151"></a>02151   <span class="keywordflow">if</span>(argc &gt; 1)
<a name="l02152"></a>02152     {
<a name="l02153"></a>02153       <span class="keywordflow">for</span>(i = 1; i &lt; argc; i++)
<a name="l02154"></a>02154         {
<a name="l02155"></a>02155           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l02156"></a>02156                    <span class="stringliteral">&quot;%s: Unexpected argument \&quot;%s\&quot;&quot;</span>, argv[0], argv[i]);
<a name="l02157"></a>02157           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l02158"></a>02158         }
<a name="l02159"></a>02159     }
<a name="l02160"></a>02160 
<a name="l02161"></a>02161   exit(0);
<a name="l02162"></a>02162   <span class="keywordflow">return</span> 0;
<a name="l02163"></a>02163 
<a name="l02164"></a>02164 }                               <span class="comment">/* shellcmd_quit */</span>
<a name="l02165"></a>02165 
<a name="l02166"></a><a class="code" href="shell_8h.html#ac90cbb87117d5e2de6759b6689d93d81">02166</a> <span class="keywordtype">int</span> <a class="code" href="shell_8c.html#ac90cbb87117d5e2de6759b6689d93d81">shellcmd_barrier</a>(<span class="keywordtype">int</span> argc,  <span class="comment">/* IN : number of args in argv */</span>
<a name="l02167"></a>02167                      <span class="keywordtype">char</span> **argv,       <span class="comment">/* IN : arg list               */</span>
<a name="l02168"></a>02168                      FILE * output      <span class="comment">/* IN : output stream          */</span>
<a name="l02169"></a>02169     )
<a name="l02170"></a>02170 {
<a name="l02171"></a>02171   <span class="keywordtype">int</span> i;
<a name="l02172"></a>02172   <span class="keywordtype">char</span> tracebuff[<a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>];
<a name="l02173"></a>02173 
<a name="l02174"></a>02174   <span class="comment">/* check args */</span>
<a name="l02175"></a>02175 
<a name="l02176"></a>02176   <span class="keywordflow">if</span>(argc &gt; 1)
<a name="l02177"></a>02177     {
<a name="l02178"></a>02178       <span class="keywordflow">for</span>(i = 1; i &lt; argc; i++)
<a name="l02179"></a>02179         {
<a name="l02180"></a>02180           snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l02181"></a>02181                    <span class="stringliteral">&quot;%s: Unexpected argument \&quot;%s\&quot;&quot;</span>, argv[0], argv[i]);
<a name="l02182"></a>02182           <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l02183"></a>02183         }
<a name="l02184"></a>02184     }
<a name="l02185"></a>02185 
<a name="l02186"></a>02186   <span class="comment">/* call shell_BarrierWait */</span>
<a name="l02187"></a>02187 
<a name="l02188"></a>02188   <span class="keywordflow">if</span>(shell_BarrierWait())
<a name="l02189"></a>02189     {
<a name="l02190"></a>02190       snprintf(tracebuff, <a class="code" href="shell_8c.html#a28e936757f32aa866a183f44f124ef9c">TRACEBUFFSIZE</a>,
<a name="l02191"></a>02191                <span class="stringliteral">&quot;%s: barrier cannot be used in a single thread/script environment.&quot;</span>,
<a name="l02192"></a>02192                argv[0]);
<a name="l02193"></a>02193       <a class="code" href="shell_8c.html#a18ca6567e360fb3becf28c1e64b8c617">shell_PrintError</a>(GetShellContext(), tracebuff);
<a name="l02194"></a>02194       <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#a7664f5e184e9b41ac92e033f7b8d885d">SHELL_ERROR</a>;
<a name="l02195"></a>02195     }
<a name="l02196"></a>02196 
<a name="l02197"></a>02197   <span class="keywordflow">return</span> <a class="code" href="shell_8h.html#ae7ec926bd777cab05e33c25429d2f68e">SHELL_SUCCESS</a>;
<a name="l02198"></a>02198 
<a name="l02199"></a>02199 }                               <span class="comment">/* shellcmd_quit */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 21 2012 for nfs-ganesha by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
