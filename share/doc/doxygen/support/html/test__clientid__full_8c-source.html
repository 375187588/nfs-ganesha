<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Support routines layer: test_clientid_full.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>test_clientid_full.c</h1><a href="test__clientid__full_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00003 <span class="preprocessor">#endif</span>
00004 <span class="preprocessor"></span>
00005 
00006 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00007 <span class="preprocessor">#include &lt;string.h&gt;</span>
00008 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00009 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00010 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>     <span class="comment">/* for having FNDELAY */</span>
00011 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span> <span class="comment">/* for having setrlimit */</span>
00012 <span class="preprocessor">#include &lt;signal.h&gt;</span> <span class="comment">/* for sigaction */</span>
00013 <span class="preprocessor">#include &lt;gssapi/gssapi.h&gt;</span>
00014 <span class="preprocessor">#ifdef HAVE_KRB5</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include &lt;gssapi/gssapi_krb5.h&gt;</span> <span class="comment">/* For krb5_gss_register_acceptor_identity */</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#ifdef _USE_GSSRPC</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#include &lt;gssrpc/types.h&gt;</span>
00019 <span class="preprocessor">#include &lt;gssrpc/rpc.h&gt;</span>
00020 <span class="preprocessor">#include &lt;gssrpc/auth.h&gt;</span>
00021 <span class="preprocessor">#include &lt;gssrpc/pmap_clnt.h&gt;</span>
00022 <span class="preprocessor">#else</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include &lt;rpc/types.h&gt;</span>
00024 <span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00025 <span class="preprocessor">#include &lt;rpc/auth.h&gt;</span>
00026 <span class="preprocessor">#include &lt;rpc/pmap_clnt.h&gt;</span>
00027 <span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#include "log_functions.h"</span>
00029 <span class="preprocessor">#include "stuff_alloc.h"</span>
00030 <span class="preprocessor">#include "fsal.h"</span>
00031 <span class="preprocessor">#include "nfs23.h"</span>
00032 <span class="preprocessor">#include "nfs4.h"</span>
00033 <span class="preprocessor">#include "mount.h"</span>
00034 <span class="preprocessor">#include "nfs_core.h"</span>
00035 <span class="preprocessor">#include "cache_inode.h"</span>
00036 <span class="preprocessor">#include "cache_content.h"</span>
00037 <span class="preprocessor">#include "nfs_file_handle.h"</span>
00038 <span class="preprocessor">#include "nfs_exports.h"</span>
00039 <span class="preprocessor">#include "nfs_tools.h"</span>
00040 <span class="preprocessor">#include "nfs_proto_functions.h"</span>
00041 <span class="preprocessor">#include "nfs_dupreq.h"</span>
00042 <span class="preprocessor">#include "config_parsing.h"</span>
00043 <span class="preprocessor">#include "SemN.h"</span>
00044 
00045 
<a name="l00046"></a><a class="code" href="test__clientid__full_8c.html#a0">00046</a> <span class="keywordtype">int</span> <a class="code" href="test__clientid__full_8c.html#a0">nfs_client_id_compute</a>( <span class="keywordtype">char</span>      * name,
00047                            clientid4 * pclientid )
00048 {
00049   <span class="keywordtype">char</span>         padded_name[CLIENT_ID_MAX_LEN] ;
00050   clientid4    computed_value = 0 ;
00051   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i              = 0  ;
00052   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset         = 0 ;
00053   uint64_t     extract        = 0 ;
00054   uint64_t     sum            = 0 ;
00055   uint64_t     i1 ;
00056   uint64_t     i2 ;
00057   uint64_t     i3 ;
00058   uint64_t     i4 ;
00059   uint64_t     i5 ;
00060   uint64_t     i6 ;
00061   uint64_t     i7 ;
00062   uint64_t     i8 ;
00063   uint64_t     i9 ;
00064   uint64_t     l  ;
00065 
00066   <span class="keywordflow">if</span>( name == NULL || pclientid == NULL )
00067     <span class="keywordflow">return</span> CLIENT_ID_INVALID_ARGUMENT ;
00068 
00069   memset( padded_name, 0, CLIENT_ID_MAX_LEN ) ;
00070 
00071   <span class="comment">/* Copy the string to the padded one */</span>
00072   <span class="keywordflow">for</span>( i = 0 ; i &lt; <a class="code" href="nfs__state__id_8c.html#a3">strnlen</a>( name, CLIENT_ID_MAX_LEN ) ; padded_name[i] = name[i], i++ ) ;
00073 
00074 <span class="preprocessor">#ifdef WITH_PRINTF_DEBUG_CLIENT_ID_COMPUTE</span>
00075 <span class="preprocessor"></span>  printf( <span class="stringliteral">"%s :"</span>, padded_name ) ; 
00076 <span class="preprocessor">#endif</span>
00077 <span class="preprocessor"></span>
00078   <span class="comment">/* For each 9 character pack:</span>
00079 <span class="comment">   *   - keep the 7 first bit (the 8th is often 0: ascii string) </span>
00080 <span class="comment">   *   - pack 7x9 bit to 63 bits using xor</span>
00081 <span class="comment">   *   - xor the last 8th bit to a single 0 , or-ed with the rest</span>
00082 <span class="comment">   * Proceeding with the next 9 bytes pack will produce a new value that is xored with the </span>
00083 <span class="comment">   * one of the previous iteration */</span>
00084 
00085   <span class="keywordflow">for</span>( offset = 0 ; offset &lt; CLIENT_ID_MAX_LEN ; offset += 9 )
00086     {
00087       <span class="comment">/* input name is ascii string, remove 8th bit on each byte, not significant */</span>
00088       i1 = padded_name[offset+0] &amp; 0x7F ;
00089       i2 = ( padded_name[offset+1] &amp; 0x7F ) &lt;&lt; 7 ; 
00090       i3 = ( padded_name[offset+2] &amp; 0x7F ) &lt;&lt; 14 ; 
00091       i4 = ( padded_name[offset+3] &amp; 0x7F ) &lt;&lt; 21 ; 
00092       i5 = ( padded_name[offset+4] &amp; 0x7F ) &lt;&lt; 28 ; 
00093       i6 = ( padded_name[offset+5] &amp; 0x7F ) &lt;&lt; 35 ; 
00094       i7 = ( padded_name[offset+6] &amp; 0x7F ) &lt;&lt; 42 ; 
00095       i8 = ( padded_name[offset+7] &amp; 0x7F ) &lt;&lt; 49 ; 
00096       i9 = ( padded_name[offset+8] &amp; 0x7F ) &lt;&lt; 56 ; 
00097 
00098   sum = (uint64_t)padded_name[offset+0] +
00099         (uint64_t)padded_name[offset+1] +
00100         (uint64_t)padded_name[offset+2] +
00101         (uint64_t)padded_name[offset+3] +
00102         (uint64_t)padded_name[offset+4] +
00103         (uint64_t)padded_name[offset+5] +
00104         (uint64_t)padded_name[offset+6] +
00105         (uint64_t)padded_name[offset+7] +
00106         (uint64_t)padded_name[offset+8] +
00107         (uint64_t)padded_name[offset+9] ;
00108 
00109 <span class="preprocessor">#ifdef WITH_PRINTF_DEBUG_CLIENT_ID_COMPUTE</span>
00110 <span class="preprocessor"></span>      printf( <span class="stringliteral">"|%llx |%llx |%llx |%llx |%llx |%llx |%llx |%llx |%llx | = "</span>,
00111              i1, i2, i3, i4, i5, i6, i7, i8, i9 ) ;
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor"></span>
00114       <span class="comment">/* Get xor combibation of all the 8h bit */</span>
00115       l = ( padded_name[offset+0] &amp; 0x80 ) ^
00116           ( padded_name[offset+1] &amp; 0x80 ) ^
00117           ( padded_name[offset+2] &amp; 0x80 ) ^
00118           ( padded_name[offset+3] &amp; 0x80 ) ^
00119           ( padded_name[offset+4] &amp; 0x80 ) ^
00120           ( padded_name[offset+5] &amp; 0x80 ) ^
00121           ( padded_name[offset+6] &amp; 0x80 ) ^
00122           ( padded_name[offset+7] &amp; 0x80 ) ^
00123           ( padded_name[offset+8] &amp; 0x80 ) ^
00124           ( padded_name[offset+9] &amp; 0x80 ) ;
00125     
00126       extract = i1 ^ i2 ^ i3 ^ i4 ^ i5 ^ i6 ^ i7 ^ i8 ^ i9 | l ;
00127 
00128 <span class="preprocessor">#ifdef WITH_PRINTF_DEBUG_CLIENT_ID_COMPUTE</span>
00129 <span class="preprocessor"></span>      printf( <span class="stringliteral">"%llx "</span>, extract ) ; 
00130 <span class="preprocessor">#endif</span>
00131 <span class="preprocessor"></span>
00132       computed_value ^= extract ;
00133       computed_value ^= sum ;
00134     }
00135 <span class="preprocessor">#ifdef WITH_PRINTF_DEBUG_CLIENT_ID_COMPUTE</span>
00136 <span class="preprocessor"></span>  printf( <span class="stringliteral">"\n"</span> ) ; 
00137 <span class="preprocessor">#endif</span>
00138 <span class="preprocessor"></span>
00139   *pclientid = computed_value ;
00140 
00141   <span class="keywordflow">return</span> CLIENT_ID_SUCCESS ;
00142 } <span class="comment">/* nfs_client_id_compute */</span>
00143                                                  
<a name="l00144"></a><a class="code" href="test__clientid__full_8c.html#a1">00144</a> <a class="code" href="test__clientid__full_8c.html#a1">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[] ) 
00145 {
00146     <span class="keywordtype">char</span> name[CLIENT_ID_MAX_LEN] ;
00147     clientid4 clientid ; 
00148     <span class="keywordtype">int</span> i ; 
00149 
00150     <span class="keywordflow">if</span>( argc == 1 )  
00151         exit( 0 ) ;
00152 
00153     <span class="keywordflow">for</span>( i = 1; i &lt; argc ; i++ )
00154       {
00155         strncpy( name, argv[i], CLIENT_ID_MAX_LEN ) ;   
00156   
00157         <a class="code" href="test__clientid__full_8c.html#a0">nfs_client_id_compute</a>( name, &amp;clientid ) ;
00158         printf( <span class="stringliteral">"--------&gt; #%s#  #%llx#\n"</span>, name, clientid ) ;
00159       }
00160 }
00161 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:40 2008 for Support routines layer by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
