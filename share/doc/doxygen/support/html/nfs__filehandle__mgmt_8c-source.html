<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Support routines layer: nfs_filehandle_mgmt.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>nfs_filehandle_mgmt.c</h1><a href="nfs__filehandle__mgmt_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *</span>
00003 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
00004 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
00005 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * Ce logiciel est un serveur implementant le protocole NFS.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * Ce logiciel est régi par la licence CeCILL soumise au droit français et</span>
00011 <span class="comment"> * respectant les principes de diffusion des logiciels libres. Vous pouvez</span>
00012 <span class="comment"> * utiliser, modifier et/ou redistribuer ce programme sous les conditions</span>
00013 <span class="comment"> * de la licence CeCILL telle que diffusée par le CEA, le CNRS et l'INRIA</span>
00014 <span class="comment"> * sur le site "http://www.cecill.info".</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * En contrepartie de l'accessibilité au code source et des droits de copie,</span>
00017 <span class="comment"> * de modification et de redistribution accordés par cette licence, il n'est</span>
00018 <span class="comment"> * offert aux utilisateurs qu'une garantie limitée.  Pour les mêmes raisons,</span>
00019 <span class="comment"> * seule une responsabilité restreinte pèse sur l'auteur du programme,  le</span>
00020 <span class="comment"> * titulaire des droits patrimoniaux et les concédants successifs.</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> * A cet égard  l'attention de l'utilisateur est attirée sur les risques</span>
00023 <span class="comment"> * associés au chargement,  à l'utilisation,  à la modification et/ou au</span>
00024 <span class="comment"> * développement et à la reproduction du logiciel par l'utilisateur étant</span>
00025 <span class="comment"> * donné sa spécificité de logiciel libre, qui peut le rendre complexe à</span>
00026 <span class="comment"> * manipuler et qui le réserve donc à des développeurs et des professionnels</span>
00027 <span class="comment"> * avertis possédant  des  connaissances  informatiques approfondies.  Les</span>
00028 <span class="comment"> * utilisateurs sont donc invités à charger  et  tester  l'adéquation  du</span>
00029 <span class="comment"> * logiciel à leurs besoins dans des conditions permettant d'assurer la</span>
00030 <span class="comment"> * sécurité de leurs systèmes et ou de leurs données et, plus généralement,</span>
00031 <span class="comment"> * à l'utiliser et l'exploiter dans les mêmes conditions de sécurité.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> * Le fait que vous puissiez accéder à cet en-tête signifie que vous avez</span>
00034 <span class="comment"> * pris connaissance de la licence CeCILL, et que vous en avez accepté les</span>
00035 <span class="comment"> * termes.</span>
00036 <span class="comment"> *</span>
00037 <span class="comment"> * ---------------------</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> * Copyright CEA/DAM/DIF (2005)</span>
00040 <span class="comment"> *  Contributor: Philippe DENIEL  philippe.deniel@cea.fr</span>
00041 <span class="comment"> *               Thomas LEIBOVICI thomas.leibovici@cea.fr</span>
00042 <span class="comment"> *</span>
00043 <span class="comment"> *</span>
00044 <span class="comment"> * This software is a server that implements the NFS protocol.</span>
00045 <span class="comment"> * </span>
00046 <span class="comment"> *</span>
00047 <span class="comment"> * This software is governed by the CeCILL  license under French law and</span>
00048 <span class="comment"> * abiding by the rules of distribution of free software.  You can  use,</span>
00049 <span class="comment"> * modify and/ or redistribute the software under the terms of the CeCILL</span>
00050 <span class="comment"> * license as circulated by CEA, CNRS and INRIA at the following URL</span>
00051 <span class="comment"> * "http://www.cecill.info".</span>
00052 <span class="comment"> *</span>
00053 <span class="comment"> * As a counterpart to the access to the source code and  rights to copy,</span>
00054 <span class="comment"> * modify and redistribute granted by the license, users are provided only</span>
00055 <span class="comment"> * with a limited warranty  and the software's author,  the holder of the</span>
00056 <span class="comment"> * economic rights,  and the successive licensors  have only  limited</span>
00057 <span class="comment"> * liability.</span>
00058 <span class="comment"> *</span>
00059 <span class="comment"> * In this respect, the user's attention is drawn to the risks associated</span>
00060 <span class="comment"> * with loading,  using,  modifying and/or developing or reproducing the</span>
00061 <span class="comment"> * software by the user in light of its specific status of free software,</span>
00062 <span class="comment"> * that may mean  that it is complicated to manipulate,  and  that  also</span>
00063 <span class="comment"> therefore means  that it is reserved for developers  and  experienced</span>
00064 <span class="comment"> * professionals having in-depth computer knowledge. Users are therefore</span>
00065 <span class="comment"> * encouraged to load and test the software's suitability as regards their</span>
00066 <span class="comment"> * requirements in conditions enabling the security of their systems and/or</span>
00067 <span class="comment"> * data to be ensured and,  more generally, to use and operate it in the</span>
00068 <span class="comment"> * same conditions as regards security.</span>
00069 <span class="comment"> *</span>
00070 <span class="comment"> * The fact that you are presently reading this means that you have had</span>
00071 <span class="comment"> * knowledge of the CeCILL license and that you accept its terms.</span>
00072 <span class="comment"> * ---------------------------------------</span>
00073 <span class="comment"> */</span>
00074 
00137 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00138 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00139 <span class="preprocessor">#endif</span>
00140 <span class="preprocessor"></span>
00141 
00142 
00143 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00144 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00145 <span class="preprocessor">#include &lt;ctype.h&gt;</span>  <span class="comment">/* for having isalnum */</span>
00146 <span class="preprocessor">#include &lt;stdlib.h&gt;</span> <span class="comment">/* for having atoi */</span>
00147 <span class="preprocessor">#include &lt;dirent.h&gt;</span> <span class="comment">/* for having MAXNAMLEN */</span>
00148 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
00149 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00150 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
00151 <span class="preprocessor">#include &lt;string.h&gt;</span>
00152 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00153 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00154 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>  <span class="comment">/* for having FNDELAY */</span>
00155 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
00156 <span class="preprocessor">#include &lt;grp.h&gt;</span>
00157 <span class="preprocessor">#ifdef _USE_GSSRPC</span>
00158 <span class="preprocessor"></span><span class="preprocessor">#include &lt;gssrpc/types.h&gt;</span>
00159 <span class="preprocessor">#include &lt;gssrpc/rpc.h&gt;</span>
00160 <span class="preprocessor">#include &lt;gssrpc/auth.h&gt;</span>
00161 <span class="preprocessor">#include &lt;gssrpc/pmap_clnt.h&gt;</span>
00162 <span class="preprocessor">#else</span>
00163 <span class="preprocessor"></span><span class="preprocessor">#include &lt;rpc/types.h&gt;</span>
00164 <span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00165 <span class="preprocessor">#include &lt;rpc/auth.h&gt;</span>
00166 <span class="preprocessor">#include &lt;rpc/pmap_clnt.h&gt;</span>
00167 <span class="preprocessor">#endif</span>
00168 <span class="preprocessor"></span><span class="preprocessor">#include "log_functions.h"</span>
00169 <span class="preprocessor">#include "stuff_alloc.h"</span>
00170 <span class="preprocessor">#include "nfs_core.h"</span> 
00171 <span class="preprocessor">#include "nfs23.h"</span>
00172 <span class="preprocessor">#include "nfs4.h"</span>
00173 <span class="preprocessor">#include "fsal.h"</span>
00174 <span class="preprocessor">#include "nfs_tools.h"</span>
00175 <span class="preprocessor">#include "nfs_exports.h"</span>
00176 <span class="preprocessor">#include "nfs_file_handle.h"</span>
00177 
00178 <span class="keyword">extern</span> time_t          ServerBootTime ;
00179 <span class="keyword">extern</span> nfs_parameter_t nfs_param ;
00180 
00181   
<a name="l00194"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a2">00194</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a2">nfs4_FhandleToFSAL</a>( nfs_fh4 * pfh4, fsal_handle_t * pfsalhandle, fsal_op_context_t * pcontext ) 
00195 {
00196   fsal_status_t      fsal_status ;
00197   file_handle_v4_t * pfile_handle ;
00198   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>      checksum ;
00199   
00200 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE</span>
00201 <span class="preprocessor"></span>   <a class="code" href="nfs__filehandle__mgmt_8c.html#a22">print_fhandle4</a>( *pfh4 ) ;
00202 <span class="preprocessor">#endif</span>
00203 <span class="preprocessor"></span>
00204   <span class="comment">/* Verify the len */</span>
00205   <span class="keywordflow">if</span>( pfh4-&gt;nfs_fh4_len !=  <span class="keyword">sizeof</span>( file_handle_v4_t ) )
00206     <span class="keywordflow">return</span> 0 ; <span class="comment">/* Corrupted FH */</span>
00207 
00208   <span class="comment">/* Cast the fh as a non opaque structure */</span>
00209   pfile_handle = (file_handle_v4_t *)(pfh4-&gt;nfs_fh4_val) ;
00210 
00211   <span class="comment">/* Check the cksum */</span>
00212   memcpy( (<span class="keywordtype">char</span> *)&amp;checksum, &amp;(pfile_handle-&gt;checksum), <span class="keyword">sizeof</span>( checksum ) ) ;
00213   <span class="keywordflow">if</span>( checksum != <a class="code" href="nfs__filehandle__mgmt_8c.html#a17">nfs4_FhandleCheckSum</a>( pfile_handle ) )
00214     <span class="keywordflow">return</span> 0 ; <span class="comment">/* Corrupted FH */</span>
00215 
00216   <span class="comment">/* The filehandle should not be related to pseudo fs */</span>
00217   <span class="keywordflow">if</span>( pfile_handle-&gt;pseudofs_id != 0 ||  pfile_handle-&gt;pseudofs_flag != FALSE )
00218     <span class="keywordflow">return</span> 0 ; <span class="comment">/* Bad FH */</span>
00219 
00220   <span class="comment">/* Fill in the fs opaque part */</span>
00221   fsal_status = FSAL_ExpandHandle( pcontext-&gt;export_context, FSAL_DIGEST_NFSV4,  (caddr_t)&amp;(pfile_handle-&gt;fsopaque), pfsalhandle ) ;
00222   <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00223     <span class="keywordflow">return</span> 0 ; <span class="comment">/* Corrupted FH */</span>
00224 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE</span>
00225 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a24">print_buff</a>( (<span class="keywordtype">char</span> *)pfsalhandle, <span class="keyword">sizeof</span>( fsal_handle_t ) ) ;
00226 <span class="preprocessor">#endif</span>
00227 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 1 ;
00228 } <span class="comment">/* nfs4_FhandleToFSAL */</span>
00229 
00230 
00231 
<a name="l00244"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a3">00244</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a3">nfs3_FhandleToFSAL</a>( nfs_fh3 * pfh3, fsal_handle_t * pfsalhandle, fsal_op_context_t * pcontext ) 
00245 {
00246   fsal_status_t      fsal_status ;
00247   file_handle_v3_t * pfile_handle ;
00248   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>      checksum ;
00249 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE  </span>
00250 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a20">print_fhandle3</a>( *pfh3 ) ;
00251 <span class="preprocessor">#endif</span>
00252 <span class="preprocessor"></span>  <span class="comment">/* Verify the len */</span>
00253   <span class="keywordflow">if</span>( pfh3-&gt;data.data_len !=  <span class="keyword">sizeof</span>( file_handle_v3_t ) )
00254     <span class="keywordflow">return</span> 0 ; <span class="comment">/* Corrupted FH */</span>
00255 
00256   <span class="comment">/* Cast the fh as a non opaque structure */</span>
00257   pfile_handle = (file_handle_v3_t *)(pfh3-&gt;data.data_val) ;
00258 
00259 
00260   <span class="comment">/* Check the cksum */</span>
00261   memcpy( (<span class="keywordtype">char</span> *)&amp;checksum, pfile_handle-&gt;checksum, <span class="keyword">sizeof</span>( checksum ) ) ;
00262   <span class="keywordflow">if</span>( checksum != <a class="code" href="nfs__filehandle__mgmt_8c.html#a16">nfs3_FhandleCheckSum</a>( pfile_handle ) )
00263     <span class="keywordflow">return</span> 0 ; <span class="comment">/* Corrupted FH */</span>
00264 
00265   <span class="comment">/* Fill in the fs opaque part */</span>
00266   fsal_status = FSAL_ExpandHandle( pcontext-&gt;export_context, FSAL_DIGEST_NFSV3, (caddr_t)&amp;(pfile_handle-&gt;fsopaque), pfsalhandle ) ;
00267   <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00268     <span class="keywordflow">return</span> 0 ; <span class="comment">/* Corrupted FH */</span>
00269 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE</span>
00270 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a24">print_buff</a>( (<span class="keywordtype">char</span> *)pfsalhandle, <span class="keyword">sizeof</span>( fsal_handle_t ) ) ;
00271 <span class="preprocessor">#endif</span>
00272 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 1 ;
00273 } <span class="comment">/* nfs3_FhandleToFSAL */</span>
00274 
00275 
00276 
<a name="l00289"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a4">00289</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a4">nfs2_FhandleToFSAL</a>( fhandle2 * pfh2, fsal_handle_t * pfsalhandle, fsal_op_context_t * pcontext ) 
00290 { 
00291   fsal_status_t      fsal_status ;
00292   file_handle_v2_t * pfile_handle ;
00293   
00294   <span class="comment">/* Cast the fh as a non opaque structure */</span>
00295   pfile_handle = (file_handle_v2_t *)pfh2 ;
00296 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE</span>
00297 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a18">print_fhandle2</a>( *pfh2 ) ;
00298 <span class="preprocessor">#endif</span>
00299 <span class="preprocessor"></span>  <span class="comment">/* Check the cksum */</span>
00300   <span class="keywordflow">if</span>( pfile_handle-&gt;checksum != <a class="code" href="nfs__filehandle__mgmt_8c.html#a15">nfs2_FhandleCheckSum</a>( pfile_handle ) )
00301     <span class="keywordflow">return</span> 0 ; <span class="comment">/* Corrupted FH */</span>
00302 
00303   <span class="comment">/* Fill in the fs opaque part */</span>
00304   fsal_status = FSAL_ExpandHandle( pcontext-&gt;export_context, FSAL_DIGEST_NFSV2, (caddr_t)&amp;(pfile_handle-&gt;fsopaque), pfsalhandle ) ;
00305   <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00306     <span class="keywordflow">return</span> 0 ; <span class="comment">/* Corrupted FH */</span>
00307 
00308 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE</span>
00309 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a24">print_buff</a>( (<span class="keywordtype">char</span> *)pfsalhandle, <span class="keyword">sizeof</span>( fsal_handle_t ) ) ;
00310 <span class="preprocessor">#endif</span>
00311 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 1 ;
00312 } <span class="comment">/* nfs2_FhandleToFSAL */</span>
00313 
<a name="l00327"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a5">00327</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a5">nfs4_FSALToFhandle</a>( nfs_fh4 * pfh4, fsal_handle_t * pfsalhandle, compound_data_t * data )
00328 {
00329   fsal_status_t     fsal_status ;
00330   file_handle_v4_t  file_handle ;
00331   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>     cksum ;
00332   
00333   <span class="comment">/* zero-ification of the buffer to be used as handle */</span>
00334   memset( pfh4-&gt;nfs_fh4_val, 0, <span class="keyword">sizeof</span>( file_handle_v4_t ) ) ; 
00335 
00336   <span class="comment">/* Fill in the fs opaque part */</span>
00337   fsal_status = FSAL_DigestHandle( &amp;data-&gt;pexport-&gt;FS_export_context, FSAL_DIGEST_NFSV4, pfsalhandle, (caddr_t)&amp;file_handle.fsopaque ) ;
00338   <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00339     <span class="keywordflow">return</span> 0 ;
00340 
00341   <span class="comment">/* keep track of the export id */</span>
00342   file_handle.exportid = data-&gt;pexport-&gt;id ;
00343 
00344   <span class="comment">/* A very basic checksum */</span>
00345   memset( (<span class="keywordtype">char</span> *)&amp;file_handle.checksum, 0, 16 ) ; <span class="comment">/* NFS checksum is 16 bytes long */</span>
00346   cksum =  <a class="code" href="nfs__filehandle__mgmt_8c.html#a17">nfs4_FhandleCheckSum</a>( &amp;file_handle ) ;
00347   memcpy( (<span class="keywordtype">char</span> *)&amp;file_handle.checksum, &amp;cksum, <span class="keyword">sizeof</span>( cksum ) ) ;
00348   
00349   <span class="comment">/* No Pseudo fs here */</span>
00350   file_handle.pseudofs_id = 0 ;
00351   file_handle.pseudofs_flag = FALSE ;
00352 
00353   <span class="comment">/* if FH expires, set it there */</span>
00354   <span class="keywordflow">if</span>( <a class="code" href="exports_8c.html#a60">nfs_param</a>.nfsv4_param.fh_expire == TRUE )
00355    {
00356       printf( <span class="stringliteral">"Un fh expirable a ete cree\n"</span> ) ;
00357       file_handle.srvboot_time  = ServerBootTime ;
00358    }    
00359   <span class="keywordflow">else</span>
00360    {
00361       <span class="comment">/* Non expirable FH */</span>
00362       file_handle.srvboot_time  = 0 ;
00363    }
00364 
00365   <span class="comment">/* Set the len */</span>
00366   pfh4-&gt;nfs_fh4_len = <span class="keyword">sizeof</span>( file_handle_v4_t ) ;
00367 
00368   <span class="comment">/* Set the data */</span>
00369   memcpy( pfh4-&gt;nfs_fh4_val, &amp;file_handle, <span class="keyword">sizeof</span>( file_handle_v4_t ) ) ;
00370  
00371   
00372   <span class="keywordflow">return</span> 1 ;
00373 } <span class="comment">/* nfs4_FSALToFhandle */</span>
00374 
00375 
<a name="l00389"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a6">00389</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a6">nfs3_FSALToFhandle</a>( nfs_fh3 * pfh3, fsal_handle_t * pfsalhandle, exportlist_t * pexport ) 
00390 {
00391   fsal_status_t     fsal_status ;
00392   file_handle_v3_t  file_handle ;
00393   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>     cksum ;
00394   
00395 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE</span>
00396 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a24">print_buff</a>( (<span class="keywordtype">char</span> *)pfsalhandle, <span class="keyword">sizeof</span>( fsal_handle_t ) ) ;
00397 <span class="preprocessor">#endif</span>
00398 <span class="preprocessor"></span>  
00399   <span class="comment">/* zero-ification of the buffer to be used as handle */</span>
00400   memset( pfh3-&gt;data.data_val, 0, NFS3_FHSIZE ) ;
00401   memset( (caddr_t)&amp;file_handle, 0, <span class="keyword">sizeof</span>( file_handle_v3_t ));
00402   
00403   <span class="comment">/* Fill in the fs opaque part */</span>
00404   fsal_status = FSAL_DigestHandle( &amp;pexport-&gt;FS_export_context, FSAL_DIGEST_NFSV3, pfsalhandle, (caddr_t)&amp;file_handle.fsopaque ) ;
00405   <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00406     <span class="keywordflow">return</span> 0 ;
00407   
00408   <span class="comment">/* keep track of the export id */</span>
00409   file_handle.exportid = pexport-&gt;id ;
00410   
00411   <span class="comment">/* A very basic checksum */</span>
00412   memset( (<span class="keywordtype">char</span> *)&amp;file_handle.checksum, 0, 16 ) ; <span class="comment">/* NFSv3 checksum is 16 bytes long */</span>
00413   cksum =  <a class="code" href="nfs__filehandle__mgmt_8c.html#a16">nfs3_FhandleCheckSum</a>( &amp;file_handle ) ;
00414   memcpy( (<span class="keywordtype">char</span> *)&amp;file_handle.checksum, &amp;cksum, <span class="keyword">sizeof</span>( cksum ) ) ;
00415 
00416   <span class="comment">/* Set the len */</span>
00417   pfh3-&gt;data.data_len = <span class="keyword">sizeof</span>( file_handle_v3_t ) ;
00418   
00419   <span class="comment">/* Set the data */</span>
00420   memcpy( pfh3-&gt;data.data_val, &amp;file_handle, <span class="keyword">sizeof</span>( file_handle_v3_t ) ) ;
00421   
00422 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE  </span>
00423 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a20">print_fhandle3</a>( *pfh3 ) ;
00424 <span class="preprocessor">#endif</span>
00425 <span class="preprocessor"></span>  
00426   <span class="keywordflow">return</span> 1 ;
00427 } <span class="comment">/* nfs3_FSALToFhandle */</span>
00428 
00429 
<a name="l00443"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a7">00443</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a7">nfs2_FSALToFhandle</a>( fhandle2 * pfh2, fsal_handle_t * pfsalhandle, exportlist_t * pexport ) 
00444 {
00445   fsal_status_t    fsal_status ;
00446   file_handle_v2_t file_handle ;
00447   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>    checksum ;
00448 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE</span>
00449 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a24">print_buff</a>( (<span class="keywordtype">char</span> *)pfsalhandle, <span class="keyword">sizeof</span>( fsal_handle_t ) ) ;
00450 <span class="preprocessor">#endif</span>
00451 <span class="preprocessor"></span>  
00452   <span class="comment">/* zero-ification of the buffer to be used as handle */</span>
00453   memset( pfh2, 0, NFS2_FHSIZE ) ;
00454   
00455   <span class="comment">/* Fill in the fs opaque part */</span>
00456   fsal_status = FSAL_DigestHandle( &amp;pexport-&gt;FS_export_context, FSAL_DIGEST_NFSV2, pfsalhandle, (caddr_t)&amp;file_handle.fsopaque ) ;
00457   <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00458     <span class="keywordflow">return</span> 0 ;
00459 
00460    <span class="comment">/* keep track of the export id */</span>
00461   file_handle.exportid = pexport-&gt;id ;
00462   
00463   <span class="comment">/* A very basic checksum */</span>
00464   checksum =  <a class="code" href="nfs__filehandle__mgmt_8c.html#a15">nfs2_FhandleCheckSum</a>( &amp;file_handle ) ;
00465   memcpy( (<span class="keywordtype">char</span> *)&amp;file_handle.checksum, &amp;checksum, <span class="keyword">sizeof</span>( checksum ) ) ;
00466 
00467   <span class="comment">/* Set the last byte */</span>
00468   file_handle.lastbyte = 0 ;
00469 
00470   <span class="comment">/* Set the data */</span>
00471   memcpy( (caddr_t)pfh2, &amp;file_handle, <span class="keyword">sizeof</span>( file_handle_v2_t ) ) ;
00472   
00473 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE</span>
00474 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a18">print_fhandle2</a>( *pfh2 ) ;
00475 <span class="preprocessor">#endif</span>
00476 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 1 ;
00477 } <span class="comment">/* nfs2_FSALToFhandle */</span>
00478 
00479 
<a name="l00491"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a8">00491</a> <span class="keywordtype">short</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a8">nfs4_FhandleToExportId</a>( nfs_fh4 * pfh4 ) 
00492 {
00493   file_handle_v4_t * pfile_handle = NULL ;
00494   
00495   pfile_handle = (file_handle_v4_t *)(pfh4-&gt;nfs_fh4_val) ;
00496 
00497   <span class="keywordflow">if</span>( pfile_handle == NULL )
00498         <span class="keywordflow">return</span> -1 ; <span class="comment">/* Badly formed arguments */</span>
00499   
00500   <span class="keywordflow">return</span> pfile_handle-&gt;exportid ;
00501 } <span class="comment">/* nfs4_FhandleToExportId */</span>
00502 
00503 
<a name="l00515"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a9">00515</a> <span class="keywordtype">short</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a9">nfs3_FhandleToExportId</a>( nfs_fh3 * pfh3 ) 
00516 {
00517   file_handle_v3_t * pfile_handle = NULL ;
00518 
00519   pfile_handle = (file_handle_v3_t *)(pfh3-&gt;data.data_val) ;
00520 
00521   <span class="keywordflow">if</span>( pfile_handle == NULL ) 
00522         <span class="keywordflow">return</span> -1 ;  <span class="comment">/* Badly formed argument */</span>
00523 
00524 <span class="preprocessor">#ifdef _DEBUG_FILEHANDLE  </span>
00525 <span class="preprocessor"></span>  <a class="code" href="nfs__filehandle__mgmt_8c.html#a24">print_buff</a>( (<span class="keywordtype">char</span> *)pfh3-&gt;data.data_val, pfh3-&gt;data.data_len ) ;
00526 <span class="preprocessor">#endif </span>
00527 <span class="preprocessor"></span>  <span class="keywordflow">return</span> pfile_handle-&gt;exportid ;
00528 } <span class="comment">/* nfs3_FhandleToExportId */</span>
00529 
00530 
<a name="l00542"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a10">00542</a> <span class="keywordtype">short</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a10">nfs2_FhandleToExportId</a>( fhandle2 * pfh2 ) 
00543 {
00544   file_handle_v2_t * pfile_handle = NULL ;
00545   
00546   pfile_handle = (file_handle_v2_t *)(*pfh2) ;
00547 
00548   <span class="keywordflow">if</span>( pfile_handle == NULL ) 
00549         <span class="keywordflow">return</span> -1 ; <span class="comment">/* Badly formed argument */</span>
00550   
00551   <span class="keywordflow">return</span> pfile_handle-&gt;exportid ;
00552 } <span class="comment">/* nfs2_FhandleToExportId */</span>
00553 
00554 
<a name="l00566"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a11">00566</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a11">nfs4_Is_Fh_Empty</a>( nfs_fh4 * pfh )
00567 {
00568   <span class="keywordflow">if</span>( pfh == NULL )
00569     <span class="keywordflow">return</span> NFS4ERR_NOFILEHANDLE ;
00570   
00571   <span class="keywordflow">if</span>( pfh-&gt;nfs_fh4_len == 0 )
00572     <span class="keywordflow">return</span> NFS4ERR_NOFILEHANDLE ;
00573   
00574   <span class="keywordflow">return</span> 0 ;
00575 } <span class="comment">/* nfs4_Is_Fh_Empty */</span>
00576 
00577 
<a name="l00589"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a12">00589</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a12">nfs4_Is_Fh_Pseudo</a>( nfs_fh4 * pfh )
00590 {
00591   file_handle_v4_t * pfhandle4;
00592 
00593   <span class="keywordflow">if</span>( pfh == NULL )
00594     <span class="keywordflow">return</span> 0 ; 
00595 
00596   pfhandle4 = (file_handle_v4_t *)(pfh-&gt;nfs_fh4_val) ;
00597   
00598   <span class="keywordflow">return</span>  pfhandle4-&gt;pseudofs_flag ;
00599 } <span class="comment">/* nfs4_Is_Fh_Pseudo */</span>
00600 
00601 
<a name="l00613"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a13">00613</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a13">nfs4_Is_Fh_Expired</a>( nfs_fh4 * pfh )
00614 {
00615   file_handle_v4_t * pfilehandle4 ;
00616 
00617   <span class="keywordflow">if</span>( pfh == NULL )
00618     <span class="keywordflow">return</span> NFS4ERR_BADHANDLE ;
00619  
00620   pfilehandle4 = (file_handle_v4_t *)pfh  ;
00621 
00622 
00623   <span class="keywordflow">if</span>( ( <a class="code" href="exports_8c.html#a60">nfs_param</a>.nfsv4_param.fh_expire == TRUE )
00624         &amp;&amp; ( pfilehandle4-&gt;srvboot_time != (<span class="keywordtype">unsigned</span> int)ServerBootTime ) )
00625    {
00626     printf( <span class="stringliteral">"============================================================---&gt; Un fh a expire\n"</span> ) ;
00627     
00628     <span class="keywordflow">if</span>( <a class="code" href="exports_8c.html#a60">nfs_param</a>.nfsv4_param.returns_err_fh_expired == TRUE )
00629         <span class="keywordflow">return</span> NFS4ERR_FHEXPIRED ; 
00630    }
00631 
00632   <span class="keywordflow">return</span> NFS4_OK ;
00633 } <span class="comment">/* nfs4_Is_Fh_Expired */</span>
00634 
<a name="l00646"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a14">00646</a> <span class="keywordtype">int</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a14">nfs4_Is_Fh_Invalid</a>( nfs_fh4 * pfh )
00647 {
00648   <span class="keywordflow">if</span>( pfh == NULL )
00649     <span class="keywordflow">return</span> NFS4ERR_BADHANDLE ;
00650 
00651   <span class="keywordflow">if</span>( pfh-&gt;nfs_fh4_len &gt; <span class="keyword">sizeof</span>(file_handle_v4_t))
00652     <span class="keywordflow">return</span> NFS4ERR_BADHANDLE ;
00653 
00654   <span class="keywordflow">if</span>( pfh-&gt;nfs_fh4_val == NULL )
00655     <span class="keywordflow">return</span> NFS4ERR_BADHANDLE ;
00656 
00657   <span class="keywordflow">return</span> NFS4_OK ;
00658 } <span class="comment">/* nfs4_Is_Fh_Invalid */</span>
00659 
00660 
<a name="l00672"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a15">00672</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a15">nfs2_FhandleCheckSum</a>( file_handle_v2_t * pfh )
00673 {
00674   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cksum ;
00675   
00676   cksum = (<span class="keywordtype">unsigned</span> long)pfh-&gt;exportid + (<span class="keywordtype">unsigned</span> long)pfh-&gt;fsopaque[1] + (<span class="keywordtype">unsigned</span> long)pfh-&gt;fsopaque[3] + (<span class="keywordtype">unsigned</span> long)pfh-&gt;fsopaque[5] ;
00677 
00678   <span class="keywordflow">return</span> cksum ;
00679 } <span class="comment">/* nfs2_FhandleCheckSum */</span>
00680 
<a name="l00692"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a16">00692</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a16">nfs3_FhandleCheckSum</a>( file_handle_v3_t * pfh )
00693 {
00694   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cksum ;
00695   
00696   cksum = (<span class="keywordtype">unsigned</span> long)pfh-&gt;exportid + (<span class="keywordtype">unsigned</span> long)pfh-&gt;fsopaque[1] + (<span class="keywordtype">unsigned</span> long)pfh-&gt;fsopaque[3] + (<span class="keywordtype">unsigned</span> long)pfh-&gt;fsopaque[5] ;
00697 
00698   <span class="keywordflow">return</span> cksum ;
00699 } <span class="comment">/* nfs3_FhandleCheckSum */</span>
00700 
<a name="l00712"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a17">00712</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a17">nfs4_FhandleCheckSum</a>( file_handle_v4_t * pfh )
00713 {
00714   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cksum ;
00715   
00716   cksum = (<span class="keywordtype">unsigned</span> long)pfh-&gt;exportid + (<span class="keywordtype">unsigned</span> long)pfh-&gt;fsopaque[1] + (<span class="keywordtype">unsigned</span> long)pfh-&gt;fsopaque[3] + (<span class="keywordtype">unsigned</span> long)pfh-&gt;fsopaque[5] ;
00717 
00718   <span class="keywordflow">return</span> cksum ;
00719 } <span class="comment">/* nfs4_FhandleCheckSum */</span>
00720 
00721 
<a name="l00733"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a18">00733</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a18">print_fhandle2</a>( fhandle2 fh )
00734 {
00735   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ;
00736 
00737   printf( <span class="stringliteral">"File Handle V2: "</span> ) ;
00738   <span class="keywordflow">for</span>( i = 0 ; i &lt; 32 ; i++ )
00739     printf( <span class="stringliteral">"%02X"</span>, fh[i] );
00740   printf( <span class="stringliteral">"\n"</span> ) ;
00741 } <span class="comment">/* print_fhandle2 */</span>
00742 
<a name="l00743"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a19">00743</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a19">sprint_fhandle2</a>( <span class="keywordtype">char</span> * str, fhandle2 fh )
00744 {
00745   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ;
00746 
00747   sprintf( str, <span class="stringliteral">"File Handle V2: "</span> ) ;
00748   <span class="keywordflow">for</span>( i = 0 ; i &lt; 32 ; i++ )
00749     sprintf( str, <span class="stringliteral">"%02X"</span>, fh[i] );
00750 } <span class="comment">/* sprint_fhandle2 */</span>
00751 
<a name="l00763"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a20">00763</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a20">print_fhandle3</a>( nfs_fh3 fh )
00764 {
00765   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ;
00766 
00767   printf( <span class="stringliteral">"  File Handle V3 : Len=%u "</span>, fh.data.data_len ) ;
00768   <span class="keywordflow">for</span>( i = 0 ; i &lt; fh.data.data_len ; i++ )
00769     printf( <span class="stringliteral">"%02X"</span>, fh.data.data_val[i] );
00770   printf( <span class="stringliteral">"\n"</span> ) ;
00771 } <span class="comment">/* print_fhandle3 */</span>
00772 
<a name="l00773"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a21">00773</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a21">sprint_fhandle3</a>( <span class="keywordtype">char</span> * str, nfs_fh3 fh )
00774 {
00775   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ;
00776 
00777   sprintf( str, <span class="stringliteral">"  File Handle V3 : Len=%u "</span>, fh.data.data_len ) ;
00778   <span class="keywordflow">for</span>( i = 0 ; i &lt; fh.data.data_len ; i++ )
00779     sprintf( str, <span class="stringliteral">"%02X"</span>, fh.data.data_val[i] );
00780 } <span class="comment">/* sprint_fhandle3 */</span>
00781 
00782 
<a name="l00794"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a22">00794</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a22">print_fhandle4</a>( nfs_fh4 fh )
00795 {
00796   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ;
00797 
00798   printf( <span class="stringliteral">"  File Handle V4 : Len=%u "</span>, fh.nfs_fh4_len ) ;
00799   <span class="keywordflow">for</span>( i = 0 ; i &lt; fh.nfs_fh4_len ; i++ )
00800     printf( <span class="stringliteral">"%02X"</span>, fh.nfs_fh4_val[i] );
00801   printf( <span class="stringliteral">"\n"</span> ) ;
00802 } <span class="comment">/* print_fhandle4 */</span>
00803 
<a name="l00804"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a23">00804</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a23">sprint_fhandle4</a>( <span class="keywordtype">char</span> * str, nfs_fh4 fh ) 
00805 {
00806   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ;
00807 
00808   sprintf( str, <span class="stringliteral">"  File Handle V4 : Len=%u "</span>, fh.nfs_fh4_len ) ;
00809   <span class="keywordflow">for</span>( i = 0 ; i &lt; fh.nfs_fh4_len ; i++ )
00810     sprintf( str, <span class="stringliteral">"%02X"</span>, fh.nfs_fh4_val[i] );
00811 } <span class="comment">/* sprint_fhandle4 */</span>
00812 
00813 
<a name="l00826"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a24">00826</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a24">print_buff</a>( <span class="keywordtype">char</span> * buff, <span class="keywordtype">int</span> len )
00827 {
00828   <span class="keywordtype">int</span> i = 0 ;
00829   
00830   printf( <span class="stringliteral">"  Len=%u Buff=%p Val: "</span>, len, buff ) ;
00831   <span class="keywordflow">for</span>( i = 0 ; i &lt; len ; i++ )
00832     printf( <span class="stringliteral">"%02X"</span>, buff[i] ) ;
00833   printf( <span class="stringliteral">"\n"</span> ) ;
00834 } <span class="comment">/* print_buff */</span>
00835 
<a name="l00836"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a25">00836</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a25">sprint_buff</a>( <span class="keywordtype">char</span> * str, <span class="keywordtype">char</span> * buff, <span class="keywordtype">int</span> len )
00837 {
00838   <span class="keywordtype">int</span> i = 0 ;
00839 
00840   sprintf( str, <span class="stringliteral">"  Len=%u Buff=%p Val: "</span>, len, buff ) ;
00841   <span class="keywordflow">for</span>( i = 0 ; i &lt; len ; i++ )
00842     sprintf( str, <span class="stringliteral">"%02X"</span>, buff[i] ) ;
00843 } <span class="comment">/* sprint_buff */</span>
00844 
<a name="l00856"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a26">00856</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a26">print_compound_fh</a>( compound_data_t * data )
00857 {
00858   printf( <span class="stringliteral">"Current FH  "</span> ) ;
00859   <a class="code" href="nfs__filehandle__mgmt_8c.html#a22">print_fhandle4</a>( data-&gt;currentFH ) ;
00860 
00861   printf( <span class="stringliteral">"Saved FH    "</span> ) ;
00862   <a class="code" href="nfs__filehandle__mgmt_8c.html#a22">print_fhandle4</a>( data-&gt;savedFH ) ;
00863 
00864   printf( <span class="stringliteral">"Public FH   "</span> ) ;
00865   <a class="code" href="nfs__filehandle__mgmt_8c.html#a22">print_fhandle4</a>( data-&gt;publicFH ) ;
00866 
00867   printf( <span class="stringliteral">"Root FH     "</span> ) ;
00868   <a class="code" href="nfs__filehandle__mgmt_8c.html#a22">print_fhandle4</a>( data-&gt;rootFH ) ;
00869 } <span class="comment">/* print_compoud_fh */</span> 
00870 
00871 
00872 
<a name="l00885"></a><a class="code" href="nfs__filehandle__mgmt_8c.html#a27">00885</a> <span class="keywordtype">void</span> <a class="code" href="nfs__filehandle__mgmt_8c.html#a27">nfs4_sprint_fhandle</a>( nfs_fh4 * fh4p, <span class="keywordtype">char</span> * outstr )
00886 {
00887   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ;
00888   <span class="keywordtype">char</span>         tmpstr[LEN_FH_STR] ;
00889 
00890   sprintf( outstr, <span class="stringliteral">"File handle V4 = { Length = %d  Val = "</span>, fh4p-&gt;nfs_fh4_len) ;
00891 
00892   <span class="keywordflow">for</span>( i = 0 ; i &lt; fh4p-&gt;nfs_fh4_len ; i++ )
00893     {
00894       sprintf(  &amp;(tmpstr[i*2]), <span class="stringliteral">"%02X"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)fh4p-&gt;nfs_fh4_val[i] );
00895     }
00896 
00897   sprintf( outstr, <span class="stringliteral">"File handle V4 = { Length = %d  Val = %s }"</span>, fh4p-&gt;nfs_fh4_len, tmpstr) ;
00898 
00899 } <span class="comment">/* nfs4_sprint_fhandle */</span>
00900 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:40 2008 for Support routines layer by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
