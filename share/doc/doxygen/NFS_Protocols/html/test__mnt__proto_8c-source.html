<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>NFS and Mount protocols layer: test_mnt_proto.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>test_mnt_proto.c</h1><a href="test__mnt__proto_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Ce logiciel est un serveur implementant le protocole NFS.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * Ce logiciel est régi par la licence CeCILL soumise au droit français et</span>
00012 <span class="comment"> * respectant les principes de diffusion des logiciels libres. Vous pouvez</span>
00013 <span class="comment"> * utiliser, modifier et/ou redistribuer ce programme sous les conditions</span>
00014 <span class="comment"> * de la licence CeCILL telle que diffusée par le CEA, le CNRS et l'INRIA</span>
00015 <span class="comment"> * sur le site "http://www.cecill.info".</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * En contrepartie de l'accessibilité au code source et des droits de copie,</span>
00018 <span class="comment"> * de modification et de redistribution accordés par cette licence, il n'est</span>
00019 <span class="comment"> * offert aux utilisateurs qu'une garantie limitée.  Pour les mêmes raisons,</span>
00020 <span class="comment"> * seule une responsabilité restreinte pèse sur l'auteur du programme,  le</span>
00021 <span class="comment"> * titulaire des droits patrimoniaux et les concédants successifs.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * A cet égard  l'attention de l'utilisateur est attirée sur les risques</span>
00024 <span class="comment"> * associés au chargement,  à l'utilisation,  à la modification et/ou au</span>
00025 <span class="comment"> * développement et à la reproduction du logiciel par l'utilisateur étant</span>
00026 <span class="comment"> * donné sa spécificité de logiciel libre, qui peut le rendre complexe à</span>
00027 <span class="comment"> * manipuler et qui le réserve donc à des développeurs et des professionnels</span>
00028 <span class="comment"> * avertis possédant  des  connaissances  informatiques approfondies.  Les</span>
00029 <span class="comment"> * utilisateurs sont donc invités à charger  et  tester  l'adéquation  du</span>
00030 <span class="comment"> * logiciel à leurs besoins dans des conditions permettant d'assurer la</span>
00031 <span class="comment"> * sécurité de leurs systèmes et ou de leurs données et, plus généralement,</span>
00032 <span class="comment"> * à l'utiliser et l'exploiter dans les mêmes conditions de sécurité.</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> * Le fait que vous puissiez accéder à cet en-tête signifie que vous avez</span>
00035 <span class="comment"> * pris connaissance de la licence CeCILL, et que vous en avez accepté les</span>
00036 <span class="comment"> * termes.</span>
00037 <span class="comment"> *</span>
00038 <span class="comment"> * ---------------------</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * Copyright CEA/DAM/DIF (2005)</span>
00041 <span class="comment"> *  Contributor: Philippe DENIEL  philippe.deniel@cea.fr</span>
00042 <span class="comment"> *               Thomas LEIBOVICI thomas.leibovici@cea.fr</span>
00043 <span class="comment"> *</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> * This software is a server that implements the NFS protocol.</span>
00046 <span class="comment"> * </span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> * This software is governed by the CeCILL  license under French law and</span>
00049 <span class="comment"> * abiding by the rules of distribution of free software.  You can  use,</span>
00050 <span class="comment"> * modify and/ or redistribute the software under the terms of the CeCILL</span>
00051 <span class="comment"> * license as circulated by CEA, CNRS and INRIA at the following URL</span>
00052 <span class="comment"> * "http://www.cecill.info".</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> * As a counterpart to the access to the source code and  rights to copy,</span>
00055 <span class="comment"> * modify and redistribute granted by the license, users are provided only</span>
00056 <span class="comment"> * with a limited warranty  and the software's author,  the holder of the</span>
00057 <span class="comment"> * economic rights,  and the successive licensors  have only  limited</span>
00058 <span class="comment"> * liability.</span>
00059 <span class="comment"> *</span>
00060 <span class="comment"> * In this respect, the user's attention is drawn to the risks associated</span>
00061 <span class="comment"> * with loading,  using,  modifying and/or developing or reproducing the</span>
00062 <span class="comment"> * software by the user in light of its specific status of free software,</span>
00063 <span class="comment"> * that may mean  that it is complicated to manipulate,  and  that  also</span>
00064 <span class="comment"> therefore means  that it is reserved for developers  and  experienced</span>
00065 <span class="comment"> * professionals having in-depth computer knowledge. Users are therefore</span>
00066 <span class="comment"> * encouraged to load and test the software's suitability as regards their</span>
00067 <span class="comment"> * requirements in conditions enabling the security of their systems and/or</span>
00068 <span class="comment"> * data to be ensured and,  more generally, to use and operate it in the</span>
00069 <span class="comment"> * same conditions as regards security.</span>
00070 <span class="comment"> *</span>
00071 <span class="comment"> * The fact that you are presently reading this means that you have had</span>
00072 <span class="comment"> * knowledge of the CeCILL license and that you accept its terms.</span>
00073 <span class="comment"> * ---------------------------------------</span>
00074 <span class="comment"> */</span>
00075 
00085 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00087 <span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>
00089 
00090 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00091 <span class="preprocessor">#include &lt;string.h&gt;</span>
00092 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00093 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00094 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>  <span class="comment">/* for having FNDELAY */</span>
00095 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span> <span class="comment">/* For getsockname */</span>
00096 <span class="preprocessor">#include "HashData.h"</span>
00097 <span class="preprocessor">#include "HashTable.h"</span>
00098 <span class="preprocessor">#ifdef _USE_GSSRPC</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#include &lt;gssrpc/types.h&gt;</span>
00100 <span class="preprocessor">#include &lt;gssrpc/rpc.h&gt;</span>
00101 <span class="preprocessor">#include &lt;gssrpc/auth.h&gt;</span>
00102 <span class="preprocessor">#include &lt;gssrpc/pmap_clnt.h&gt;</span>
00103 <span class="preprocessor">#else</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#include &lt;rpc/types.h&gt;</span>
00105 <span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00106 <span class="preprocessor">#include &lt;rpc/auth.h&gt;</span>
00107 <span class="preprocessor">#include &lt;rpc/pmap_clnt.h&gt;</span>
00108 <span class="preprocessor">#endif</span>
00109 <span class="preprocessor"></span>
00110 <span class="preprocessor">#include "log_functions.h"</span>
00111 <span class="preprocessor">#include "stuff_alloc.h"</span>
00112 <span class="preprocessor">#include "nfs23.h"</span>
00113 <span class="preprocessor">#include "nfs4.h"</span>
00114 <span class="preprocessor">#include "mount.h"</span>
00115 <span class="preprocessor">#include "nfs_core.h"</span>
00116 <span class="preprocessor">#include "cache_inode.h"</span>
00117 <span class="preprocessor">#include "cache_content.h"</span>
00118 <span class="preprocessor">#include "nfs_exports.h"</span>
00119 <span class="preprocessor">#include "nfs_creds.h"</span>
00120 <span class="preprocessor">#include "nfs_proto_functions.h"</span>
00121 <span class="preprocessor">#include "nfs_tools.h"</span>
00122 
00123 <span class="comment">/* prints an export list */</span>
<a name="l00124"></a><a class="code" href="test__mnt__proto_8c.html#a2">00124</a> <span class="keywordtype">void</span> <a class="code" href="test__mnt__proto_8c.html#a2">print_export_list</a>( exports export_list ){
00125 
00126   exports p_expnode = export_list;
00127   
00128   <span class="keywordflow">while</span>( p_expnode ){
00129    
00130    groups p_group;
00131      
00132    printf(<span class="stringliteral">"exportnode.ex_dir = \"%s\"\n"</span>,p_expnode-&gt;ex_dir);
00133    printf(<span class="stringliteral">"exportnode.ex_groups = {\n"</span>);
00134    
00135    p_group = p_expnode-&gt;ex_groups;
00136    <span class="keywordflow">while</span>(p_group){
00137      printf(<span class="stringliteral">"  \"%s\"\n"</span>,p_group-&gt;gr_name);
00138      p_group = p_group-&gt;gr_next;
00139    }
00140    printf(<span class="stringliteral">"}\n\n"</span>);
00141     
00142    p_expnode =  p_expnode-&gt;ex_next;
00143   }
00144 
00145 }
00146 
00147 <span class="comment">/* Test MNTPROC_NULL */</span>
<a name="l00148"></a><a class="code" href="test__mnt__proto_8c.html#a3">00148</a> <span class="keywordtype">int</span> <a class="code" href="test__mnt__proto_8c.html#a3">test_mnt_Null</a>(){
00149 
00150  <span class="keywordtype">int</span> rc;
00151  
00152  rc = <a class="code" href="mnt__Null_8c.html#a0">mnt_Null</a>( NULL,NULL,NULL,NULL,NULL,NULL,NULL);
00153  printf(<span class="stringliteral">"MNTPROC_NULL()=%d\n"</span>,rc);
00154  
00155  <span class="comment">/* Must return MNT3_OK */</span>
00156  <span class="keywordflow">if</span> (rc == MNT3_OK) {
00157    printf(<span class="stringliteral">"TEST MNT_NULL : OK\n"</span>);
00158    <span class="keywordflow">return</span> 0;
00159  } <span class="keywordflow">else</span> {
00160    printf(<span class="stringliteral">"TEST MNT_NULL : ERROR\n"</span>);
00161    <span class="keywordflow">return</span> rc;
00162  }
00163 }
00164 
<a name="l00165"></a><a class="code" href="test__mnt__proto_8c.html#a0">00165</a> <span class="preprocessor"># define NB_EXPORT_ENTRIES 5</span>
<a name="l00166"></a><a class="code" href="test__mnt__proto_8c.html#a4">00166</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="test__mnt__proto_8c.html#a4">test_mnt_Export</a>(){
00167   
00168   <span class="keywordtype">int</span> rc,i;
00169   <span class="keywordtype">int</span> error = 0;
00170   <span class="keyword">struct </span>addrinfo * p_tab;
00171   exportlist_t  export_entries[NB_EXPORT_ENTRIES];
00172   nfs_res_t     result;
00173   <span class="keywordtype">int</span> mysock;
00174   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size;
00175   <span class="keyword">struct </span>sockaddr_in in_addr;
00176   <span class="keyword">struct </span>sockaddr_in addr;
00177 
00178   
00179   <span class="comment">/* TEST 1 : using a NULL export_list */</span>
00180   
00181   rc=<a class="code" href="mnt__Export_8c.html#a1">mnt_Export</a>(NULL, NULL, NULL, NULL, NULL, NULL, &amp;result);
00182   <span class="comment">/* rc must be OK and result.res_mntexport must be NULL */</span>
00183   printf(<span class="stringliteral">"MNTPROC_EXPORT(NULL)=(%d,%p)\n"</span>,rc,result.res_mntexport );
00184   
00185   <span class="keywordflow">if</span> ((rc == MNT3_OK)&amp;&amp;(result.res_mntexport==NULL)){
00186     printf(<span class="stringliteral">"TEST MNT_EXPORT : OK\n\n"</span>);
00187   } <span class="keywordflow">else</span> {
00188     printf(<span class="stringliteral">"TEST MNT_EXPORT : ERROR\n\n"</span>);
00189     error++;
00190   }
00191   
00192   
00193   <span class="comment">/* TEST 2 : MNT_EXPORT complex */</span>
00194 
00195       
00196   <span class="keywordflow">if</span> ((mysock = socket(PF_INET,SOCK_STREAM,0))==-1){
00197     printf(<span class="stringliteral">"socket ERROR %d : %s\n"</span>,errno,strerror(errno));
00198   }
00199   
00200   in_addr.sin_family      = AF_INET ;
00201   in_addr.sin_addr.s_addr = INADDR_ANY ;
00202   in_addr.sin_port        = htons(5100)  ;
00203   
00204   <span class="keywordflow">if</span> (bind( mysock, (<span class="keyword">struct</span> sockaddr *)&amp;in_addr, <span class="keyword">sizeof</span>( in_addr ) ) == -1 ){
00205     printf(<span class="stringliteral">"bind ERROR %d : %s\n"</span>,errno,strerror(errno));
00206   }
00207 
00208   size = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>sockaddr);
00209   <span class="keywordflow">if</span> (getsockname(mysock,(<span class="keyword">struct</span> sockaddr *) &amp;addr,(socklen_t *)&amp;size)==-1){
00210     printf(<span class="stringliteral">"getsockname ERROR %d : %s\n"</span>,errno,strerror(errno));
00211   }
00212   <span class="comment">/* we don't use the resource, only its adress. */</span>
00213   close(mysock);
00214     
00215   <span class="comment">/* Building an export list */</span>
00216   
00217   <span class="keywordflow">for</span> (i=0;i&lt;NB_EXPORT_ENTRIES;i++){
00218     
00219     <span class="comment">/* pour alleger les notations */</span>
00220     exportlist_client_entry_t p_cli[5];
00221         
00222     <span class="comment">/* setting paths */</span>
00223     snprintf(export_entries[i].dirname,MAXPATHLEN,<span class="stringliteral">"/dirname-%d"</span>,i);
00224     snprintf(export_entries[i].fsname,MAXPATHLEN,<span class="stringliteral">"/fsname-%d"</span>,i);
00225     snprintf(export_entries[i].pseudopath,MAXPATHLEN,<span class="stringliteral">"/pseudopath-%d"</span>,i);
00226     snprintf(export_entries[i].fullpath,MAXPATHLEN,<span class="stringliteral">"/fullpath-%d"</span>,i);
00227     
00228     <span class="comment">/* linking to the next element. */</span>
00229     <span class="keywordflow">if</span> ((i+1)&lt;NB_EXPORT_ENTRIES)
00230       export_entries[i].next = &amp;(export_entries[i+1]);
00231     <span class="keywordflow">else</span>
00232       export_entries[i].next = NULL;
00233     
00234     <span class="comment">/* tests several clients list type */</span>
00235     <span class="keywordflow">switch</span>(i%4){
00236       
00237       <span class="keywordflow">case</span> 0:
00238         <span class="comment">/* empty list*/</span>
00239         export_entries[i].clients.num_clients=0;
00240         <span class="keywordflow">break</span>;
00241         
00242       <span class="keywordflow">case</span> 1:
00243         
00244         <span class="comment">/* one element list */</span>        
00245         export_entries[i].clients.num_clients=1;
00246         p_cli[0].type = HOSTIF_CLIENT;
00247         p_cli[0].client.hostif.clientaddr = addr.sin_addr.s_addr ;
00248         <span class="keywordflow">break</span>;
00249         
00250       <span class="keywordflow">case</span> 2:
00251         
00252         <span class="comment">/* two elements list */</span>
00253         export_entries[i].clients.num_clients=2;
00254        
00255         p_cli[0].type = HOSTIF_CLIENT;
00256         p_cli[0].client.hostif.clientaddr = addr.sin_addr.s_addr ;
00257         
00258         p_cli[1].type = NETGROUP_CLIENT;
00259         strcpy( p_cli[1].client.netgroup.netgroupname,<span class="stringliteral">"netgroup"</span>);
00260 
00261         <span class="keywordflow">break</span>;
00262         
00263       <span class="keywordflow">case</span> 3:
00264         <span class="comment">/* several elements list */</span>
00265 
00266         export_entries[i].clients.num_clients=5;
00267         
00268         p_cli[0].type = HOSTIF_CLIENT;
00269         p_cli[0].client.hostif.clientaddr = addr.sin_addr.s_addr ;
00270         
00271         p_cli[1].type = NETGROUP_CLIENT;
00272         strcpy( p_cli[1].client.netgroup.netgroupname,<span class="stringliteral">"netgroup"</span>);
00273 
00274         p_cli[2].type = WILDCARDHOST_CLIENT;
00275         strcpy(p_cli[2].client.wildcard.wildcard,<span class="stringliteral">"wilcard"</span>);
00276         
00277         
00278         p_cli[3].type = GSSPRINCIPAL_CLIENT;
00279         strcpy(p_cli[3].client.gssprinc.princname, <span class="stringliteral">"gssprincipal"</span> );
00280         
00281         p_cli[4].type = NETWORK_CLIENT;
00282         p_cli[4].client.network.netaddr = addr.sin_addr.s_addr ;
00283         p_cli[4].client.network.netmask    = 0xFFFFFF00;
00284                                         
00285         <span class="keywordflow">break</span>;
00286       <span class="keywordflow">default</span>:
00287         printf(<span class="stringliteral">"!!!!!***** TEST ERROR *****!!!!!\n"</span>);
00288         <span class="keywordflow">return</span> -1;
00289     }
00290     
00291   }
00292     
00293   rc=<a class="code" href="mnt__Export_8c.html#a1">mnt_Export</a>(NULL,export_entries , NULL, NULL, NULL, NULL, &amp;result);
00294   <span class="comment">/* rc must be OK and result.res_mntexport must be NULL */</span>
00295   printf(<span class="stringliteral">"MNTPROC_EXPORT(entries)=(%d,%p)\n"</span>,rc,result.res_mntexport );
00296   
00297   <span class="keywordflow">if</span> ((rc == MNT3_OK)&amp;&amp;(result.res_mntexport!=NULL)){
00298     printf(<span class="stringliteral">"TEST MNT_EXPORT : OK\n\n"</span>);
00299   } <span class="keywordflow">else</span> {
00300     printf(<span class="stringliteral">"TEST MNT_EXPORT : ERROR\n\n"</span>);
00301     error++;
00302   }
00303 
00304   <span class="comment">/* printing the export_list */</span>
00305   <a class="code" href="test__mnt__proto_8c.html#a2">print_export_list</a>( result.res_mntexport );
00306   
00307   <span class="keywordflow">return</span> (error);
00308   
00309 }
00310 
<a name="l00311"></a><a class="code" href="test__mnt__proto_8c.html#a1">00311</a> <span class="preprocessor">#define Maketest(func,name) do {                      \</span>
00312 <span class="preprocessor">  int rc;                                             \</span>
00313 <span class="preprocessor">  printf("\n======== TEST %s =========\n\n",name);    \</span>
00314 <span class="preprocessor">  rc = func();                                        \</span>
00315 <span class="preprocessor">  if (rc)                                             \</span>
00316 <span class="preprocessor">    printf("\n-------- %s : %d ---------\n",name,rc); \</span>
00317 <span class="preprocessor">  else                                                \</span>
00318 <span class="preprocessor">    printf("\n-------- %s : OK ---------\n",name); \</span>
00319 <span class="preprocessor">  } while (0)</span>
00320 <span class="preprocessor"></span>
<a name="l00321"></a><a class="code" href="test__mnt__proto_8c.html#a5">00321</a> <span class="keywordtype">int</span> <a class="code" href="test__mnt__proto_8c.html#a5">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv){
00322     
00323     SetNameFileLog( <span class="stringliteral">"/dev/tty"</span> ) ;
00324     SetNamePgm( <span class="stringliteral">"test_mnt_proto"</span> ) ;
00325     
00326 <span class="comment">/*    InitDebug( NIV_FULL_DEBUG ) ;*/</span>
00327     InitDebug( NIV_DEBUG ) ;
00328     
00329     <a class="code" href="test__mnt__proto_8c.html#a1">Maketest</a>(<a class="code" href="test__mnt__proto_8c.html#a3">test_mnt_Null</a>,<span class="stringliteral">"test_mnt_Null"</span>);
00330     <a class="code" href="test__mnt__proto_8c.html#a1">Maketest</a>(<a class="code" href="test__mnt__proto_8c.html#a4">test_mnt_Export</a>,<span class="stringliteral">"test_mnt_Export"</span>);
00331     
00332     exit(0);
00333   
00334 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:29 2008 for NFS and Mount protocols layer by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
