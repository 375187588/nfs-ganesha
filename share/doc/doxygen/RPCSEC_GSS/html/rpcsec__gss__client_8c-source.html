<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RPCSEC_GSS Library: rpcsec_gss_client.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>rpcsec_gss_client.c</h1><a href="rpcsec__gss__client_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * RPCSEC_GSS: basic client for tests</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * $Header: /cea/home/cvs/cvs/SHERPA/BaseCvs/GANESHA/src/RPCSEC_GSS/rpcsec_gss_client.c,v 1.1 2005/04/13 11:32:38 deniel Exp $</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * $Log: rpcsec_gss_client.c,v $</span>
00007 <span class="comment"> * Revision 1.1  2005/04/13 11:32:38  deniel</span>
00008 <span class="comment"> * Added the two test client and server</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> */</span>
00012 
00013 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00014 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00015 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00016 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
00017 <span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00018 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
00019 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00020 <span class="preprocessor">#include &lt;netinet/tcp.h&gt;</span>
00021 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00022 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00023 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00024 
00025 <span class="preprocessor">#include "Rpc.h"</span>
00026 <span class="preprocessor">#include "Pmap_clnt.h"</span>
00027 
<a name="l00028"></a><a class="code" href="rpcsec__gss__client_8c.html#a0">00028</a> <span class="preprocessor">#define TraduireAdresse( adresse, dest )                   \</span>
00029 <span class="preprocessor">           sprintf( dest, "%d.%d.%d.%d",                   \</span>
00030 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0xFF000000 ) &gt;&gt; 24, \</span>
00031 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x00FF0000 ) &gt;&gt; 16, \</span>
00032 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x0000FF00 ) &gt;&gt; 8,  \</span>
00033 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x000000FF ) )</span>
<a name="l00034"></a><a class="code" href="rpcsec__gss__client_8c.html#a1">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define TIMEOUT_SEC 25 </span>
<a name="l00035"></a><a class="code" href="rpcsec__gss__client_8c.html#a2">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_RPC_SERVICE 300400 </span>
<a name="l00036"></a><a class="code" href="rpcsec__gss__client_8c.html#a3">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define RECV_SIZE 2048</span>
<a name="l00037"></a><a class="code" href="rpcsec__gss__client_8c.html#a4">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define SEND_SIZE 2048</span>
<a name="l00038"></a><a class="code" href="rpcsec__gss__client_8c.html#a5">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define V1 1 </span>
<a name="l00039"></a><a class="code" href="rpcsec__gss__client_8c.html#a6">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define PROC_NULL  0 </span>
<a name="l00040"></a><a class="code" href="rpcsec__gss__client_8c.html#a7">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define PROC_PLUS1 1</span>
00041 <span class="preprocessor"></span>
<a name="l00042"></a><a class="code" href="rpcsec__gss__client_8c.html#a8">00042</a> <span class="preprocessor">#define DEFAULT_MECHANISM "kerberos_v5"</span>
<a name="l00043"></a><a class="code" href="rpcsec__gss__client_8c.html#a9">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_PRINCIPAL "toto/trekking.bruyeres.s"</span>
00044 <span class="preprocessor"></span>
00045 <span class="keyword">extern</span> gss_OID_desc krb5oid;
00046 
00047 <span class="comment">/* L'aide en ligne */</span>
<a name="l00048"></a><a class="code" href="rpcsec__gss__client_8c.html#a11">00048</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a14">options</a>[] = <span class="stringliteral">"hd:s:S:"</span> ;
<a name="l00049"></a><a class="code" href="rpcsec__gss__client_8c.html#a12">00049</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a15">utilisation</a>[] =
00050 <span class="stringliteral">"Utilisation: %s [-hds] message\n"</span>
00051 <span class="stringliteral">"\t[-h]                   affiche cet aide en ligbe\n"</span>
00052 <span class="stringliteral">"\t[-d &lt;machine&gt;]         indique la machine serveur\n"</span>
00053 <span class="stringliteral">"\t[-s &lt;service RPC&gt;]     indique le port ou le service a utiliser\n"</span> 
00054 <span class="stringliteral">"\t[-S &lt;service auth&gt;]    indique le principal a utiliser\n"</span> ;
00055 
00056 
00057 
00058 <span class="comment">/* Outil necessaire a RPCSEC_GSS */</span>
<a name="l00059"></a><a class="code" href="rpcsec__gss__client_8c.html#a13">00059</a> <span class="keywordtype">char</span> <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>[1024] ;
<a name="l00060"></a><a class="code" href="rpcsec__gss__client_8c.html#a14">00060</a> <span class="keywordtype">char</span> <a class="code" href="rpcsec__gss__client_8c.html#a14">server</a>[] = <span class="stringliteral">"server"</span> ;
00061 
<a name="l00062"></a><a class="code" href="rpcsec__gss__client_8c.html#a15">00062</a> CLIENT * <a class="code" href="rpcsec__gss__client__v4_8natif_8c.html#a15">Creer_RPCClient</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> adresse, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> programme, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> version, 
00063                           <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> port, <span class="keywordtype">int</span> sockfd )
00064 {
00065   <span class="keyword">struct </span>sockaddr_in adresse_rpc ;
00066   <span class="keywordtype">int</span>                sock = 0 ;
00067   CLIENT *           client ;
00068   <span class="keyword">struct </span>timeval     intervalle ;
00069   <span class="keywordtype">int</span>                rc ;
00070   <span class="keyword">struct </span>Rpc_gss_sec sec;
00071 
00072   memset( &amp;adresse_rpc, 0, <span class="keyword">sizeof</span>( adresse_rpc ) ) ;
00073   adresse_rpc.sin_port        = port ;
00074   adresse_rpc.sin_family      = AF_INET ;
00075   adresse_rpc.sin_addr.s_addr = adresse ;
00076 
00077   sock               = sockfd ;
00078   intervalle.tv_sec  = TIMEOUT_SEC ;
00079   intervalle.tv_usec = 0 ;
00080   
00081   <span class="keywordflow">if</span>( sock &gt; 0 )
00082     {
00083       <span class="keywordflow">if</span>( port &gt; 0 )
00084         {
00085           <span class="comment">/* En tcp, il faut que la socket soit connectee sur le service en face si on n'utilise pas RPC_ANYSOCK </span>
00086 <span class="comment">           * ATTENTION, ceci est une feature non documentee des RPC clientes (j'ai vu ca dans les sources) */</span>
00087           <span class="keywordflow">if</span>( connect( sock, (<span class="keyword">struct</span> sockaddr_in *)&amp;adresse_rpc, <span class="keyword">sizeof</span>( adresse_rpc ) ) &lt; 0 )
00088             fprintf( stderr, <span class="stringliteral">"connect impossible sur le serveur RPC\n"</span> ) ;
00089         }
00090       <span class="keywordflow">else</span>
00091         {
00092           <span class="comment">/* Dans ce cas, on ne connait pas le port en face, donc connect impossible, on prend RPC_ANYSOCK </span>
00093 <span class="comment">           * mais uniquement apres avoir ferme la socket 'sock' qui ne sert a rien ici */</span>
00094           close( sock ) ;
00095           sock = RPC_ANYSOCK ;
00096         }
00097     }
00098   
00099 
00100   <span class="comment">/* Creation et allocation du client */</span>
00101   <span class="keywordflow">if</span>( ( client = <a class="code" href="Clnt__tcp_8c.html#a11">Clnttcp_create</a>( &amp;adresse_rpc, programme, version,  
00102                                  &amp;sock, <a class="code" href="onc__rpc__client_8c.html#a4">SEND_SIZE</a>, <a class="code" href="onc__rpc__client_8c.html#a3">RECV_SIZE</a> ) ) == NULL )
00103     {
00104       <span class="keywordtype">char</span> erreur[100] ;
00105       <span class="keywordtype">char</span> entete[100] ;
00106       
00107       sprintf( entete, <span class="stringliteral">"Creation RPC %d|%d|0x%x:%d|%d"</span>, programme, version, adresse, port, sock ) ;
00108       strcpy( erreur, clnt_spcreateerror( entete ) ) ;
00109           fprintf( stderr, <span class="stringliteral">"%s"</span>, erreur ) ;
00110           
00111           <span class="keywordflow">return</span> NULL ;
00112         }
00113 
00114   <span class="comment">/* Authentification avec RPCSEC_GSS */</span>
00115   <span class="comment">/* sec.mech = (gss_OID)&amp;krb5oid ; */</span>
00116   sec.mech = GSS_C_NULL_OID ; 
00117   sec.qop =  GSS_C_QOP_DEFAULT ;
00118   <span class="comment">/* sec.svc = RPCSEC_GSS_SVC_NONE ;  */</span>
00119   <span class="comment">/* sec.svc = RPCSEC_GSS_SVC_INTEGRITY ; */</span>
00120   sec.svc = RPCSEC_GSS_SVC_PRIVACY ; 
00121         
00122   <span class="keywordflow">if</span>( ( client-&gt;cl_auth = Authgss_create_default( client, <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>, &amp;sec ) ) == NULL )
00123     {    
00124       fprintf( stderr, <span class="stringliteral">"Authentification du client impossible\n "</span> ) ;
00125       exit( 1 ) ;
00126     }
00127   fprintf( stderr, <span class="stringliteral">"Authentification du client reussie\n"</span> ) ;
00128   
00129   <span class="keywordflow">return</span> client ;
00130 } <span class="comment">/* Creer_RPCClient */</span>
00131 
<a name="l00132"></a><a class="code" href="rpcsec__gss__client_8c.html#a16">00132</a> <a class="code" href="server-gss_8c.html#a35">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[] ) 
00133 {
00134   <span class="keyword">struct </span>timeval   intervalle = { TIMEOUT_SEC, 0 };
00135   CLIENT *         client ;
00136   <span class="keywordtype">int</span>              c ;  
00137   <span class="keyword">struct </span>rpcent *  etc_rpc ;               <span class="comment">/* pour consulter /etc/rpc ou rpc.bynumber */</span>
00138   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>     adresse_serveur ;  <span class="comment">/* Au format NET */</span>
00139   <span class="keyword">struct </span>hostent * hp ;
00140   <span class="keywordtype">char</span>             nom_exec[MAXPATHLEN] ;
00141   <span class="keywordtype">char</span>             machine_locale[256] ;
00142   <span class="keywordtype">char</span> *           tempo_nom_exec  = NULL ;
00143   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>     <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> = DEFAULT_RPC_SERVICE ;
00144   <span class="keywordtype">int</span>              val = 2 ;
00145   <span class="keywordtype">int</span>              rc ;
00146   
00147    <span class="comment">/* On recupere le nom de l'executable */</span>
00148   <span class="keywordflow">if</span>( ( tempo_nom_exec = (<span class="keywordtype">char</span> *)strrchr( argv[0], <span class="charliteral">'/'</span> ) ) != NULL )
00149     strcpy( (<span class="keywordtype">char</span> *)nom_exec, tempo_nom_exec + 1 ) ;
00150   
00151   <span class="comment">/* Initialisation des valeurs */</span>
00152   strcpy( <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>, <a class="code" href="rpcsec__gss__client_8c.html#a9">DEFAULT_PRINCIPAL</a> ) ;
00153 
00154 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00155 <span class="preprocessor"></span>
00156   <span class="comment">/* Init Buddy allocator */</span>
00157 
00158   <span class="keywordflow">if</span> ( ( rc = BuddyInit( NULL )) != BUDDY_SUCCESS )
00159   {
00160     <span class="comment">/* can't use shell tracing functions there */</span>
00161     fprintf( stderr, <span class="stringliteral">"Error %d initializing Buddy allocator.\n"</span>,rc);
00162     exit( 1 ) ;
00163   }
00164 
00165 <span class="preprocessor">#endif</span>
00166 <span class="preprocessor"></span>
00167   <span class="keywordflow">while</span>( ( c = getopt( argc, argv, <a class="code" href="client-gss_8c.html#a14">options</a> ) ) != EOF )
00168     {
00169       <span class="keywordflow">switch</span>( c )
00170         {
00171         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00172           <span class="comment">/* Cette option permet de recuperer un nom pour la machine distante */</span>
00173           <span class="keywordflow">if</span>( isalpha( *optarg ) )
00174             {
00175               <span class="comment">/* Recuperation de l'adresse de la machine serveur */</span>
00176               <span class="keywordflow">if</span>( ( hp = gethostbyname( optarg ) ) == NULL )
00177                 {
00178                   printf( <span class="stringliteral">"gethostbyname impossible: errno = %d, h_errno = %d\n"</span>, errno, h_errno ) ;
00179                   exit( 1 ) ; 
00180                 }
00181               
00182               memcpy( &amp;adresse_serveur, hp-&gt;h_addr, hp-&gt;h_length ) ;
00183             }
00184           <span class="keywordflow">else</span>
00185             {
00186               adresse_serveur = inet_addr( optarg ) ;
00187             }
00188           <span class="keywordflow">break</span>;
00189 
00190         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00191           <span class="comment">/* Un nom ou un numero de service a ete indique */</span>
00192           <span class="keywordflow">if</span>( isalpha( (<span class="keywordtype">int</span>)*optarg ) )
00193             {
00194               <span class="comment">/* Ca commence pas par un chiffre donc c'est un nom service */</span>
00195               <span class="keywordflow">if</span>( ( etc_rpc = getrpcbyname( optarg ) ) == NULL )
00196                 {
00197                   fprintf( stderr, <span class="stringliteral">"Impossible de resoudre le service %s\n"</span>, optarg ) ;
00198                 }
00199               <span class="keywordflow">else</span>
00200                 {
00201                   <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> = etc_rpc-&gt;r_number ;
00202                 }
00203             }
00204           <span class="keywordflow">else</span>
00205             {
00206               <span class="comment">/* C'est un numero de service qui est indique */</span>
00207               <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> = atoi( optarg ) ;
00208             }
00209           break ;
00210 
00211         <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00212           <span class="comment">/* On indique un principal different */</span>
00213           strcpy( <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>, optarg ) ;
00214           break ;
00215           
00216         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00217         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00218         <span class="keywordflow">default</span>:
00219           <span class="comment">/* Affichage de l'aide en ligne */</span>
00220           fprintf( stderr, <a class="code" href="client-gss_8c.html#a15">utilisation</a>, nom_exec ) ;
00221           exit( 0 ) ;
00222           break ;
00223         }
00224     }
00225 
00226   printf( <span class="stringliteral">"Using principal=%s rpc=%u \n"</span>, <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>, <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> ) ;
00227 
00228   printf( <span class="stringliteral">"GSS_S_COMPLETE = %d     GSS_S_CONTINUE_NEEDED = %d\n"</span>, GSS_S_COMPLETE, GSS_S_CONTINUE_NEEDED ) ;
00229  
00230   <span class="keywordflow">if</span>( ( client = <a class="code" href="rpcsec__gss__client__v4_8natif_8c.html#a15">Creer_RPCClient</a>( adresse_serveur, <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a>, <a class="code" href="onc__rpc__client_8c.html#a5">V1</a>, 0 , RPC_ANYSOCK ) ) == NULL )
00231     {
00232       <span class="keywordtype">char</span> erreur[100] ;
00233       strcpy( erreur, clnt_spcreateerror( <span class="stringliteral">"Creation RPC"</span> ) ) ;
00234       exit( 1 ) ;
00235     }
00236 
00237   val = 1234 ;
00238   fprintf( stderr, <span class="stringliteral">"J'envoie la valeur %d\n"</span>, val ) ;
00239 
00240   printf( <span class="stringliteral">"About to do RPCSEC_GSS call\n"</span> ) ;
00241 
00242   <span class="keywordflow">if</span>( ( rc = Clnt_call( client, <a class="code" href="onc__rpc__client_8c.html#a7">PROC_PLUS1</a>, 
00243                         (Xdrproc_t)<a class="code" href="Xdr_8c.html#a6">Xdr_int</a>, (caddr_t)&amp;val, 
00244                         (Xdrproc_t)<a class="code" href="Xdr_8c.html#a6">Xdr_int</a>, (caddr_t)&amp;val, 
00245                         intervalle ) ) != RPC_SUCCESS )
00246     {
00247       <a class="code" href="Pmap__clnt_8c.html#a2">Clnt_perror</a>( client, <span class="stringliteral">"appel a  PROC_PLUS1\n"</span> ) ;
00248       exit ( 1 ) ;
00249     }
00250   
00251   
00252   printf( <span class="stringliteral">"RPCSEC_GSS call is ok.... now destroy authentication\n"</span> ) ;
00253 
00254   Clnt_destroy( client ) ;
00255 }
00256 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Dec 22 14:15:35 2006 for RPCSEC_GSS Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
