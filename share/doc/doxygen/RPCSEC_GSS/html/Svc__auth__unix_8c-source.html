<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RPCSEC_GSS Library: Svc_auth_unix.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>Svc_auth_unix.c</h1><a href="Svc__auth__unix_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * svc_auth_unix.c</span>
00003 <span class="comment"> * Handles UNIX flavor authentication parameters on the service side of rpc.</span>
00004 <span class="comment"> * There are two svc auth implementations here: AUTH_UNIX and AUTH_SHORT.</span>
00005 <span class="comment"> * _svcauth_unix does full blown unix style uid,gid+gids auth,</span>
00006 <span class="comment"> * _svcauth_short uses a shorthand auth to index into a cache of longhand auths.</span>
00007 <span class="comment"> * Note: the shorthand has been gutted for efficiency.</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Copyright (C) 1984, Sun Microsystems, Inc.</span>
00010 <span class="comment"> */</span>
00011 
00012 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00013 <span class="preprocessor">#include &lt;string.h&gt;</span>
00014 <span class="preprocessor">#include "Rpc.h"</span>
00015 
00016 <span class="keyword">extern</span> SVCAUTH Svc_auth_none;
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * Unix longhand authenticator</span>
00020 <span class="comment"> */</span>
<a name="l00021"></a><a class="code" href="Svc__auth__unix_8c.html#a1">00021</a> <span class="keyword">enum</span> Auth_stat <a class="code" href="Svc__auth_8c.html#a4">Svcauth_unix</a>( <span class="keyword">register</span> <span class="keyword">struct</span> Svc_req * rqst, <span class="keyword">register</span> <span class="keyword">struct</span> Rpc_msg * msg)
00022 {
00023         <span class="keyword">register</span> <span class="keyword">enum</span> Auth_stat stat;
00024         XDR xdrs;
00025         <span class="keyword">register</span> <span class="keyword">struct </span>Authunix_parms *aup;
00026         <span class="keyword">register</span> <span class="keywordtype">long</span>  *buf;
00027         <span class="keyword">struct </span>area {
00028                 <span class="keyword">struct </span>Authunix_parms area_aup;
00029                 <span class="keywordtype">char</span> area_machname[MAX_MACHINE_NAME+1];
00030                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> area_gids[NGRPS];
00031         } *area;
00032         u_int auth_len;
00033         u_int str_len, gid_len;
00034         <span class="keyword">register</span> u_int i;
00035 
00036         rqst-&gt;rq_xprt-&gt;xp_auth = &amp;Svc_auth_none;
00037         
00038         area = (<span class="keyword">struct </span>area *) rqst-&gt;rq_clntcred;
00039         aup = &amp;area-&gt;area_aup;
00040         aup-&gt;aup_machname = area-&gt;area_machname;
00041         aup-&gt;aup_gids = area-&gt;area_gids;
00042         auth_len = (u_int)msg-&gt;rm_call.cb_cred.oa_length;
00043         xdrmem_create(&amp;xdrs, msg-&gt;rm_call.cb_cred.oa_base, auth_len,XDR_DECODE);
00044         
00045 
00046   buf = XDR_INLINE(&amp;xdrs, auth_len);
00047 
00048 
00049         <span class="keywordflow">if</span> (buf != NULL) {
00050                 aup-&gt;aup_time = IXDR_GET_LONG(buf);
00051                 str_len = IXDR_GET_U_LONG(buf);
00052                 <span class="keywordflow">if</span> (str_len &gt; MAX_MACHINE_NAME) {
00053                         stat = AUTH_BADCRED;
00054                         <span class="keywordflow">goto</span> done;
00055                 }
00056                 memcpy(aup-&gt;aup_machname, (caddr_t)buf, (u_int)str_len);
00057                 aup-&gt;aup_machname[str_len] = 0;
00058                 str_len = RNDUP(str_len);
00059                 buf += str_len / <span class="keyword">sizeof</span> (int32_t);
00060                 aup-&gt;aup_uid = IXDR_GET_LONG(buf);
00061                 aup-&gt;aup_gid = IXDR_GET_LONG(buf);
00062                 gid_len = IXDR_GET_U_LONG(buf);
00063                 <span class="keywordflow">if</span> (gid_len &gt; NGRPS) {
00064                         stat = AUTH_BADCRED;
00065                         <span class="keywordflow">goto</span> done;
00066                 }
00067                 aup-&gt;aup_len = gid_len;
00068                 <span class="keywordflow">for</span> (i = 0; i &lt; gid_len; i++) {
00069                         aup-&gt;aup_gids[i] = IXDR_GET_LONG(buf);
00070                 }
00071                 <span class="comment">/*</span>
00072 <span class="comment">                 * five is the smallest unix credentials structure -</span>
00073 <span class="comment">                 * timestamp, hostname len (0), uid, gid, and gids len (0).</span>
00074 <span class="comment">                 */</span>
00075                 <span class="keywordflow">if</span> ((5 + gid_len) * BYTES_PER_XDR_UNIT + str_len &gt; auth_len) {
00076                         stat = AUTH_BADCRED;
00077                         <span class="keywordflow">goto</span> done;
00078                 }
00079         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (! <a class="code" href="Authuxprot_8c.html#a0">Xdr_Authunix_parms</a>(&amp;xdrs, aup)) {
00080                 xdrs.x_op = XDR_FREE;
00081                 (void)<a class="code" href="Authuxprot_8c.html#a0">Xdr_Authunix_parms</a>(&amp;xdrs, aup);
00082                 stat = AUTH_BADCRED;
00083                 <span class="keywordflow">goto</span> done;
00084         }
00085         rqst-&gt;rq_xprt-&gt;xp_verf.oa_flavor = AUTH_NULL;
00086         rqst-&gt;rq_xprt-&gt;xp_verf.oa_length = 0;
00087         stat = AUTH_OK;
00088 done:
00089         XDR_DESTROY(&amp;xdrs);
00090         <span class="keywordflow">return</span> (stat);
00091 }
00092 
00093 
00094 <span class="comment">/*</span>
00095 <span class="comment"> * Shorthand unix authenticator</span>
00096 <span class="comment"> * Looks up longhand in a cache.</span>
00097 <span class="comment"> */</span>
<a name="l00098"></a><a class="code" href="Svc__auth__unix_8c.html#a2">00098</a> <span class="keyword">enum</span> Auth_stat <a class="code" href="Svc__auth_8c.html#a5">Svcauth_short</a>(<span class="keyword">struct</span> Svc_req * rqst, <span class="keyword">struct</span> Rpc_msg * msg)
00099 {
00100         rqst-&gt;rq_xprt-&gt;xp_auth = &amp;Svc_auth_none;
00101         
00102         <span class="keywordflow">return</span> (AUTH_REJECTEDCRED);
00103 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Dec 22 14:15:35 2006 for RPCSEC_GSS Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
