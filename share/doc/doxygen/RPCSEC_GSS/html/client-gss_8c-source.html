<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RPCSEC_GSS Library: client-gss.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>client-gss.c</h1><a href="client-gss_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *</span>
00003 <span class="comment"> * Les sources du client du serveur </span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * $Header: /cea/home/cvs/cvs/SHERPA/BaseCvs/GANESHA/src/RPCSEC_GSS/client-gss.c,v 1.1 2005/04/13 13:45:49 deniel Exp $</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * $Log: client-gss.c,v $</span>
00008 <span class="comment"> * Revision 1.1  2005/04/13 13:45:49  deniel</span>
00009 <span class="comment"> * Adding basic gss client/server (for debugging purpose)</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> */</span>
00013 
<a name="l00014"></a><a class="code" href="client-gss_8c.html#a12">00014</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a12">rcsid</a>[] = <span class="stringliteral">"$Id: client-gss.c,v 1.1 2005/04/13 13:45:49 deniel Exp $"</span> ;
00015 
00016 <span class="comment">/* Un tas d'include pour avoir les bindings standards */</span>
00017 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00018 <span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00019 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00020 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00021 <span class="preprocessor">#include &lt;string.h&gt;</span>
00022 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00023 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00024 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00025 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00026 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00027 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00028 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
00029 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00030 <span class="preprocessor">#include &lt;netinet/tcp.h&gt;</span>
00031 
00032 <span class="preprocessor">#include &lt;gssapi/gssapi.h&gt;</span>  <span class="comment">/* Header de la gssapi */</span>
00033 <span class="preprocessor">#include &lt;gssapi/gssapi_generic.h&gt;</span>
00034 
<a name="l00035"></a><a class="code" href="client-gss_8c.html#a0">00035</a> <span class="preprocessor">#define TOKEN_NOOP              (1&lt;&lt;0)</span>
<a name="l00036"></a><a class="code" href="client-gss_8c.html#a1">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_CONTEXT           (1&lt;&lt;1)</span>
<a name="l00037"></a><a class="code" href="client-gss_8c.html#a2">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_DATA              (1&lt;&lt;2)</span>
<a name="l00038"></a><a class="code" href="client-gss_8c.html#a3">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_MIC               (1&lt;&lt;3)</span>
<a name="l00039"></a><a class="code" href="client-gss_8c.html#a4">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_CONTEXT_NEXT      (1&lt;&lt;4)</span>
<a name="l00040"></a><a class="code" href="client-gss_8c.html#a5">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_WRAPPED           (1&lt;&lt;5)</span>
<a name="l00041"></a><a class="code" href="client-gss_8c.html#a6">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_ENCRYPTED         (1&lt;&lt;6)</span>
<a name="l00042"></a><a class="code" href="client-gss_8c.html#a7">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_SEND_MIC          (1&lt;&lt;7)</span>
00043 <span class="preprocessor"></span>
00044 <span class="keywordtype">void</span> <a class="code" href="tools-gss_8h.html#a16">sperror_gss</a>( <span class="keywordtype">char</span> * str, OM_uint32 major, OM_uint32 minor ) ;
00045 <span class="keywordtype">int</span> <a class="code" href="tools-gss_8h.html#a17">write_tok</a>( <span class="keywordtype">int</span> s, gss_buffer_t tok ) ;
00046 <span class="keywordtype">int</span> <a class="code" href="tools-gss_8h.html#a18">read_tok</a>( <span class="keywordtype">int</span> s, gss_buffer_t tok ) ;
00047 
<a name="l00048"></a><a class="code" href="client-gss_8c.html#a8">00048</a> <span class="preprocessor">#define KRB5OID  "1.2.840.113554.1.2.2"</span>
00049 <span class="preprocessor"></span>
<a name="l00050"></a><a class="code" href="rpcsec__gss__client__v4_8natif_8c.html#a10">00050</a> gss_OID_desc <a class="code" href="client-gss_8c.html#a13">krb5oid</a> = {
00051         20, <a class="code" href="client-gss_8c.html#a8">KRB5OID</a>
00052 };
00053 
<a name="l00054"></a><a class="code" href="client-gss_8c.html#a9">00054</a> <span class="preprocessor">#define LENMSG            256 </span>
<a name="l00055"></a><a class="code" href="client-gss_8c.html#a10">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define TraduireAdresse( adresse, dest )                   \</span>
00056 <span class="preprocessor">           sprintf( dest, "%d.%d.%d.%d",                   \</span>
00057 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0xFF000000 ) &gt;&gt; 24, \</span>
00058 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x00FF0000 ) &gt;&gt; 16, \</span>
00059 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x0000FF00 ) &gt;&gt; 8,  \</span>
00060 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x000000FF ) )</span>
<a name="l00061"></a><a class="code" href="client-gss_8c.html#a11">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define SNAME_DEFAUT "toto"</span>
00062 <span class="preprocessor"></span>
00063 <span class="comment">/* les options pour getopt */</span>
<a name="l00064"></a><a class="code" href="client-gss_8c.html#a14">00064</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a14">options</a>[] = <span class="stringliteral">"hd:P:M:S:"</span> ;
00065 
00066 <span class="comment">/* L'aide en ligne */</span>
<a name="l00067"></a><a class="code" href="client-gss_8c.html#a15">00067</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a15">utilisation</a>[] =
00068 <span class="stringliteral">"Utilisation: %s [-hdPM] message\n"</span>
00069 <span class="stringliteral">"\t[-h]                   affiche cet aide en ligbe\n"</span>
00070 <span class="stringliteral">"\t[-d &lt;machine&gt;]         indique la machine serveur\n"</span>
00071 <span class="stringliteral">"\t[-P &lt;port ou service&gt;] le port ou le service ou le daemon ecoute\n"</span>
00072 <span class="stringliteral">"\t[-M &lt;Mecanisme Auth&gt;]  le mecanisme utilise par ls GSS-API\n"</span> 
00073 <span class="stringliteral">"\t[-S &lt;Mecanisme Auth&gt;]  le service utilise par ls GSS-API\n"</span> ;
00074 
00075 
00076 <span class="comment">/* Quelques variables d'etat pour la GSSAPI */</span>
<a name="l00077"></a><a class="code" href="client-gss_8c.html#a16">00077</a> OM_uint32         <a class="code" href="client-gss_8c.html#a16">deleg_flag</a> = 0 ;
<a name="l00078"></a><a class="code" href="client-gss_8c.html#a17">00078</a> gss_ctx_id_t    gss_context ;
<a name="l00079"></a><a class="code" href="client-gss_8c.html#a18">00079</a> gss_OID         g_mechOid ;
<a name="l00080"></a><a class="code" href="client-gss_8c.html#a19">00080</a> <span class="keywordtype">char</span>            <a class="code" href="client-gss_8c.html#a19">sname</a>[256] ;
00081 
00082 <span class="comment">/* Cette routine alloue une adresse et la lie a son point d'entree                   */</span>
00083 <span class="comment">/* La valeur retournee est le descripteur de socket ou une valeur negative si erreur */</span>
00084 <span class="comment">/* si port == 0, on choisit dynamiquement le port                                    */</span>
00085 <span class="comment">/* adresse et port sont au format NET */</span>
<a name="l00086"></a><a class="code" href="client-gss_8c.html#a23">00086</a> <span class="keywordtype">int</span> <a class="code" href="client-gss_8c.html#a23">CreerSocket</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> adresse, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> port )
00087 {
00088   <span class="keywordtype">int</span>                socket_fd ;
00089   <span class="keyword">struct </span>sockaddr_in addr ;
00090   
00091   <span class="comment">/* 1- On cree la socket  */</span>
00092   <span class="keywordflow">if</span>( ( socket_fd = socket( AF_INET, SOCK_STREAM, 0 ) ) == -1 )
00093     {
00094       printf( <span class="stringliteral">"socket creation error: %d = %s\n"</span>, errno, strerror( errno ) ) ;
00095       <span class="keywordflow">return</span> -1 ;
00096     }
00097 
00098   <span class="comment">/* 2- On remplit l'adresse */</span>
00099   memset( &amp;addr, 0, <span class="keyword">sizeof</span>( addr ) ) ;
00100   addr.sin_family      = AF_INET ;
00101   addr.sin_addr.s_addr = adresse ;
00102   addr.sin_port        = port  ;
00103 
00104   <span class="comment">/* 3- On bind la socket sur l'adresse */</span>
00105   <span class="keywordflow">if</span>( bind( socket_fd, (<span class="keyword">struct</span> sockaddr *)&amp;addr, <span class="keyword">sizeof</span>( addr ) ) == -1 )
00106     {
00107       printf( <span class="stringliteral">"Bind error: %d = %s\n"</span>, errno, strerror( errno ) ) ;
00108 
00109       <span class="keywordflow">return</span> -1 ;
00110     }
00111 
00112   <span class="comment">/* 4- on s'en va */</span>
00113   <span class="keywordflow">return</span> socket_fd ;
00114 } <span class="comment">/* CreerSocket */</span>
00115  
00116 
00117 <span class="comment">/*</span>
00118 <span class="comment"> * La routine de negociation avec le serveur sous GSSAPI </span>
00119 <span class="comment"> */</span>
<a name="l00120"></a><a class="code" href="client-gss_8c.html#a24">00120</a> <span class="keywordtype">int</span> <a class="code" href="client-gss_8c.html#a24">negociation_client</a>( <span class="keywordtype">int</span> sockfd, <span class="keywordtype">char</span> * service_name, gss_OID oid  ) 
00121 {
00122   gss_buffer_desc   send_tok ;
00123   gss_buffer_desc   recv_tok ;
00124   gss_buffer_desc * token_ptr ;
00125   
00126   gss_name_t      tname ;
00127   OM_uint32       maj_stat, min_stat, init_sec_min_stat ;
00128   OM_uint32       ret_flags ;
00129   <span class="keywordtype">int</span>             token_flags;
00130 
00131   <span class="keywordtype">char</span>            strerrgss[256] ;
00132   gss_buffer_desc empty_token = { 0, (<span class="keywordtype">void</span> *) <span class="stringliteral">""</span> };
00133   
00134   <span class="comment">/* Je dois construire le target name dans un format GSSAPI compliant */</span>
00135   fprintf( stderr, <span class="stringliteral">"Negociation pour acceder au service '%s'\n"</span>, service_name ) ;
00136   
00137   send_tok.value = service_name ;
00138   send_tok.length = strlen( service_name ) + 1 ;
00139 
00140   <span class="comment">/* Instanciation du nom GSSAPI du service */</span>
00141   <span class="keywordflow">if</span>( ( maj_stat = gss_import_name( &amp;min_stat, &amp;send_tok, 
00142                                     (gss_OID)GSS_C_NULL_OID, &amp;tname ) ) != GSS_S_COMPLETE )
00143     {
00144       <a class="code" href="tools-gss_8h.html#a16">sperror_gss</a>( strerrgss, maj_stat, min_stat ) ;
00145       fprintf( stderr, <span class="stringliteral">"gss_import_name: %s\n"</span>, strerrgss ) ;
00146       exit( 1 ) ;
00147     }
00148   
00149   <span class="comment">/* 0- On envoie un toekn vide pour commencer, juste histoire de donner des flags */</span>
00150   <span class="keywordflow">if</span> (<a class="code" href="tools-gss_8c.html#a26">send_token</a>(sockfd, <a class="code" href="client-gss_8c.html#a0">TOKEN_NOOP</a>|<a class="code" href="client-gss_8c.html#a4">TOKEN_CONTEXT_NEXT</a>, &amp;empty_token) &lt; 0)
00151     {
00152       fprintf( stderr, <span class="stringliteral">"send_token: errno=%d\n"</span>, errno ) ;
00153       (void) gss_release_name(&amp;min_stat, &amp;tname);
00154       exit( 1 ) ; 
00155     }
00156   
00157   <span class="comment">/* Boucle d'etablissement du contexte */</span>
00158   token_ptr = GSS_C_NO_BUFFER ;
00159   <a class="code" href="client-gss_8c.html#a17">gss_context</a> = GSS_C_NO_CONTEXT ;
00160   
00161   <span class="keywordflow">do</span>
00162     {
00163       <span class="comment">/* On cree un context que l'on va envoyer au serveur */</span>
00164       maj_stat = gss_init_sec_context( &amp;init_sec_min_stat, 
00165                                        GSS_C_NO_CREDENTIAL, 
00166                                        &amp;<a class="code" href="client-gss_8c.html#a17">gss_context</a>, 
00167                                        tname, 
00168                                        oid,  
00169                                        GSS_C_MUTUAL_FLAG | GSS_C_REPLAY_FLAG | <a class="code" href="client-gss_8c.html#a16">deleg_flag</a>, 
00170                                        0, 
00171                                        GSS_C_NO_CHANNEL_BINDINGS,         <span class="comment">/* no channel bindings */</span>
00172                                        token_ptr,    <span class="comment">/* ignore mech type    */</span>
00173                                        NULL, 
00174                                        &amp;send_tok, 
00175                                        (<span class="keywordtype">int</span> *)&amp;ret_flags, 
00176                                        NULL ) ;      <span class="comment">/* ignore time_rec     */</span>
00177       
00178       <span class="keywordflow">if</span>( token_ptr != GSS_C_NO_BUFFER )
00179         (void) gss_release_buffer( &amp;min_stat, &amp;recv_tok ) ;
00180 
00181       <span class="keywordflow">if</span>( send_tok.length != 0 )
00182         {
00183           fprintf( stderr, <span class="stringliteral">"Envoie du contexte initial, taille=%d\n"</span>, send_tok.length ) ;
00184           
00185           <span class="keywordflow">if</span>( <a class="code" href="tools-gss_8c.html#a26">send_token</a>( sockfd, <a class="code" href="client-gss_8c.html#a1">TOKEN_CONTEXT</a>, &amp;send_tok ) &lt; 0 )
00186             {
00187               fprintf( stderr, <span class="stringliteral">"Erreur a l'envoie du contexte initiale\n"</span> ) ;
00188               (void) gss_release_buffer(&amp;min_stat, &amp;send_tok);
00189               (void) gss_release_name(&amp;min_stat, &amp;tname);
00190               exit( 1 ) ;
00191             }
00192           
00193             
00194         }
00195       <span class="keywordflow">else</span> 
00196         fprintf( stderr, <span class="stringliteral">"Le contexte intiale a une taille nulle\n"</span> ) ;
00197 
00198       <span class="comment">/* Maintenant que send_tok est envoye, je le relache */</span>
00199       (void) gss_release_buffer(&amp;min_stat, &amp;send_tok);
00200       
00201       <span class="keywordflow">if</span>( maj_stat != GSS_S_COMPLETE &amp;&amp; maj_stat != GSS_S_CONTINUE_NEEDED )
00202         {
00203           <span class="comment">/* Une erreur a eu lieu dans gss_init_sec_context */</span>
00204 
00205           <a class="code" href="tools-gss_8h.html#a16">sperror_gss</a>( strerrgss, maj_stat, init_sec_min_stat ) ;
00206           fprintf( stderr, <span class="stringliteral">"gss_init_sec_context: %s\n"</span>, strerrgss ) ;
00207           (void) gss_release_buffer( &amp;min_stat, &amp;tname ) ;
00208           <span class="keywordflow">return</span> -1 ;
00209         }
00210       
00211       <span class="comment">/* Est ce que j'ai besoin de continuer ? */</span>
00212       <span class="keywordflow">if</span>( maj_stat == GSS_S_CONTINUE_NEEDED )
00213         {
00214           fprintf( stderr, <span class="stringliteral">"Another negociation pass is necessary \n"</span> ) ;
00215           
00216           <span class="comment">/* Je recupere dans recv_tok les infos venues du serveur */</span>
00217           <span class="keywordflow">if</span>( <a class="code" href="tools-gss_8h.html#a21">recv_token</a>( sockfd, &amp;token_flags, &amp;recv_tok ) &lt; 0 )
00218             {
00219               fprintf( stderr, <span class="stringliteral">"Badly received token\n"</span> ) ;
00220               gss_release_buffer( &amp;min_stat, &amp;tname ) ;
00221                   <span class="keywordflow">return</span> -1 ;
00222                 }
00223               
00224               <span class="comment">/* Sinon, on utilise ce token recue pour la passe d'apres */</span>
00225               token_ptr = &amp;recv_tok ;
00226         }
00227       
00228     } <span class="keywordflow">while</span>( maj_stat == GSS_S_CONTINUE_NEEDED ) ;
00229   
00230   fprintf( stdout, <span class="stringliteral">"Security context has been successfully negociated...\n"</span> ) ;
00231   
00232   
00233   <span class="comment">/* Un peu de menage */</span>
00234   (void) gss_release_name(&amp;min_stat, &amp;tname);
00235   
00236   <span class="keywordflow">return</span> 0 ;
00237 } <span class="comment">/* negociation */</span>
00238 
00239 
00240 
00241 <span class="comment">/* Le main .... Et Loire (desole) */</span>
<a name="l00242"></a><a class="code" href="client-gss_8c.html#a25">00242</a> <span class="keywordtype">int</span> <a class="code" href="server-gss_8c.html#a35">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[] ) 
00243 { 
00244   <span class="keywordtype">int</span>                c ;                     <span class="comment">/* pour getopt                  */</span>
00245   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       adresse_serveur ;  <span class="comment">/* Au format NET */</span>
00246   <span class="keyword">struct </span>hostent *   hp ;
00247   <span class="keywordtype">char</span>               nom_exec[MAXPATHLEN] ;
00248   <span class="keywordtype">char</span>               machine_locale[256] ;
00249   <span class="keywordtype">char</span> *             tempo_nom_exec  = NULL ;
00250   <span class="keyword">struct </span>sockaddr_in addr_serveur ;
00251   <span class="keywordtype">int</span>                sockfd ;
00252   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>     serveur_port ;
00253   <span class="keyword">struct </span>servent *   service ;
00254   <span class="keywordtype">char</span>               straddr[100] ;
00255   <span class="keywordtype">char</span>               msg[LENMSG] ;
00256   <span class="keywordtype">int</span>                rc = 0 ;
00257   gss_buffer_desc    tokoid ;
00258   OM_uint32          maj_stat, min_stat ;
00259   <span class="keywordtype">char</span>               strerrgss[256] ;
00260   <span class="keywordtype">char</span> *             mechstr = 0 ;
00261   <span class="keywordtype">char</span> *             cp ;
00262   
00263   <span class="comment">/* On recupere le nom de l'executable */</span>
00264   <span class="keywordflow">if</span>( ( tempo_nom_exec = strrchr( argv[0], <span class="charliteral">'/'</span> ) ) != NULL )
00265     strcpy( (<span class="keywordtype">char</span> *)nom_exec, tempo_nom_exec + 1 ) ;
00266 
00267   <span class="comment">/* Valeur par defaut */</span>
00268   strcpy( <a class="code" href="client-gss_8c.html#a19">sname</a>, <a class="code" href="client-gss_8c.html#a11">SNAME_DEFAUT</a> ) ;
00269   
00270   <span class="keywordflow">while</span>( ( c = getopt( argc, argv, <a class="code" href="client-gss_8c.html#a14">options</a> ) ) != EOF )
00271     {
00272       <span class="keywordflow">switch</span>( c )
00273         {
00274         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00275           <span class="comment">/* Cette option permet de recuperer un nom pour la machine distante */</span>
00276           <span class="keywordflow">if</span>( isalpha( *optarg ) )
00277             {
00278               <span class="comment">/* Recuperation de l'adresse de la machine serveur */</span>
00279               <span class="keywordflow">if</span>( ( hp = gethostbyname( optarg ) ) == NULL )
00280                 {
00281                   printf( <span class="stringliteral">"gethostbyname error: errno=%d h_errno=%d\n"</span>, errno, h_errno ) ;
00282                   exit( 1 ) ; 
00283                 }
00284               
00285               memcpy( &amp;adresse_serveur, hp-&gt;h_addr, hp-&gt;h_length ) ;
00286             }
00287           <span class="keywordflow">else</span>
00288             {
00289               adresse_serveur = inet_addr( optarg ) ;
00290             }
00291           <span class="keywordflow">break</span>;
00292 
00293         <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:
00294           <span class="comment">/* Je m'enregistre sur un port fixe (pour eviter le portmapper) */</span>
00295           <span class="comment">/* Le numero de port peut etre un numero de port ou un service  */</span>
00296           <span class="comment">/* On a une valeur au format NET                                */</span>
00297           <span class="keywordflow">if</span>( isalpha( *optarg ) )
00298             {
00299               <span class="comment">/* C'est un service car ca commence par une lettre */</span>
00300               <span class="keywordflow">if</span>( ( service = getservbyname( optarg, <span class="stringliteral">"tcp"</span> ) ) == NULL )
00301                 {
00302                   <span class="comment">/* Ca marche pas en tcp, j'essaye en udp */</span>
00303                   <span class="keywordflow">if</span>( ( service = getservbyname( optarg, <span class="stringliteral">"udp"</span> ) ) == NULL )
00304                     {
00305                       printf( <span class="stringliteral">"getservbyname error = %d\n"</span>, errno ) ;
00306                     }
00307                   <span class="keywordflow">else</span>
00308                     {
00309                       serveur_port = service-&gt;s_port ;
00310                     }
00311                 }
00312               <span class="keywordflow">else</span>
00313                 {
00314                   serveur_port = service-&gt;s_port ;
00315                 }
00316             }
00317           <span class="keywordflow">else</span>
00318             {
00319               <span class="comment">/* C'est un numero de port */</span>
00320               serveur_port = htons( (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)atoi( optarg ) ) ;
00321             }
00322           break ;
00323           
00324         <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00325           <span class="comment">/* Nom de service GSSAPI */</span>
00326           strcpy( <a class="code" href="client-gss_8c.html#a19">sname</a>, optarg ) ;
00327           break ;
00328           
00329         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00330         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00331         <span class="keywordflow">default</span>:
00332           <span class="comment">/* Affichage de l'aide en ligne */</span>
00333           fprintf( stderr, <a class="code" href="client-gss_8c.html#a15">utilisation</a>, nom_exec ) ;
00334           exit( 0 ) ;
00335           break ;
00336         } <span class="comment">/* switch( c ) */</span>
00337     } <span class="comment">/* while( getopt( ... ) ) */</span>
00338   
00339   <span class="keywordflow">if</span>( argc - optind != 1 )
00340     {
00341       fprintf( stderr, <a class="code" href="client-gss_8c.html#a15">utilisation</a>, nom_exec ) ;
00342       fprintf( stderr,<span class="stringliteral">"Un seul argument additionel: le message\n"</span> ) ;
00343       exit( 1 ) ;
00344     }
00345 
00346   <span class="comment">/* Je garde le message */</span>
00347   strncpy( msg, argv[optind], <a class="code" href="client-gss_8c.html#a9">LENMSG</a> ) ;
00348   
00349   
00350   <span class="comment">/* Obtention du nom de la machine */</span>
00351   <span class="keywordflow">if</span>( gethostname( machine_locale, <span class="keyword">sizeof</span>( machine_locale ) ) != 0 )
00352     {
00353       printf( <span class="stringliteral">"gethostbyname error: %d\n"</span>, errno ) ;
00354       exit( 1 ) ;
00355     }
00356 
00357   <span class="comment">/* Qui est ce que je veux contacter ? */</span>
00358   <a class="code" href="client-gss_8c.html#a10">TraduireAdresse</a>( adresse_serveur , straddr ) ;
00359   fprintf( stderr, <span class="stringliteral">"Trying to reach host %s:%d\n"</span>, straddr, ntohs( serveur_port ) ) ;
00360   
00361   <span class="comment">/* Je creer une socket */</span>
00362   <span class="keywordflow">if</span>( ( sockfd = <a class="code" href="client-gss_8c.html#a23">CreerSocket</a>( htonl( INADDR_ANY ) , 0 ) ) == -1 )
00363     {
00364       fprintf( stderr, <span class="stringliteral">"Allocation of a new socket is impossiblem exiting...\n"</span> ) ;
00365       exit( 1 ) ;
00366     }
00367 
00368   <span class="comment">/* Je me connecte sur le serveur */</span>
00369   addr_serveur.sin_family      = AF_INET ;
00370   addr_serveur.sin_port        = serveur_port ;
00371   addr_serveur.sin_addr.s_addr = adresse_serveur ;
00372   
00373   
00374   <span class="keywordflow">if</span>( connect( sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;addr_serveur, <span class="keyword">sizeof</span>( addr_serveur ) ) )
00375     {
00376       fprintf( stderr, <span class="stringliteral">"connect error: %d\n"</span>, errno ) ;
00377       exit( 1 ) ;
00378     }
00379 
00380   <span class="comment">/* Si je suis ici, j'ai un connect correct */</span>
00381   fprintf( stderr, <span class="stringliteral">"Connexion ok\n"</span> ) ;
00382 
00383   <span class="comment">/* Negociation avec la GSS-API */</span>
00384   <span class="comment">/* g_mechOid = (gss_OID)&amp;krb5oid ; */</span>
00385   <a class="code" href="client-gss_8c.html#a18">g_mechOid</a> = GSS_C_NULL_OID ;
00386 
00387   <span class="keywordflow">if</span>( <a class="code" href="client-gss_8c.html#a24">negociation_client</a>( sockfd, <a class="code" href="client-gss_8c.html#a19">sname</a>, <a class="code" href="client-gss_8c.html#a18">g_mechOid</a> ) &lt;0 )
00388     {
00389       fprintf( stderr, <span class="stringliteral">"bad negociation, exiting...\n"</span> ) ;
00390       exit( 1 ) ;
00391     }
00392   <span class="keywordflow">else</span>
00393     fprintf( stderr, <span class="stringliteral">"Negociation ok\n"</span> ) ;
00394   
00395   <span class="comment">/* Envoi du message */</span>
00396   <span class="keywordflow">if</span>( ( rc = write( sockfd, msg, <a class="code" href="client-gss_8c.html#a9">LENMSG</a> ) ) != LENMSG )
00397     {
00398        fprintf( stderr, <span class="stringliteral">"%d bytes sent instead of %d, errno=%d\n"</span>, rc, <a class="code" href="client-gss_8c.html#a9">LENMSG</a>, errno ) ;
00399       exit( 1 ) ;
00400     }
00401   
00402   fprintf( stderr, <span class="stringliteral">"Sending message #%s#\n"</span>, msg ) ;
00403 
00404   <span class="keywordflow">if</span>( ( rc = read( sockfd, msg, <a class="code" href="client-gss_8c.html#a9">LENMSG</a> ) ) != LENMSG )
00405     {
00406       fprintf( stderr, <span class="stringliteral">"%d bytes received instead of %d, errno=%d"</span>, rc, <a class="code" href="client-gss_8c.html#a9">LENMSG</a>, errno ) ;
00407       exit( 1 ) ;
00408     }
00409   
00410   fprintf( stderr, <span class="stringliteral">"Received message #%s#\n"</span>, msg ) ;  
00411 
00412   <span class="comment">/* fin */</span>
00413   close( sockfd ) ;
00414   
00415   <span class="keywordflow">return</span> 0 ;
00416 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Dec 22 14:15:35 2006 for RPCSEC_GSS Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
