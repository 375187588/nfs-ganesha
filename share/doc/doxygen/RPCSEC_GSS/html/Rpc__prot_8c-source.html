<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RPCSEC_GSS Library: Rpc_prot.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>Rpc_prot.c</h1><a href="Rpc__prot_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * Sun RPC is a product of Sun Microsystems, Inc. and is provided for</span>
00003 <span class="comment"> * unrestricted use provided that this legend is included on all tape</span>
00004 <span class="comment"> * media and as a part of the software program in whole or part.  Users</span>
00005 <span class="comment"> * may copy or modify Sun RPC without charge, but are not authorized</span>
00006 <span class="comment"> * to license or distribute it to anyone else except as part of a product or</span>
00007 <span class="comment"> * program developed by the user.</span>
00008 <span class="comment"> * </span>
00009 <span class="comment"> * SUN RPC IS PROVIDED AS IS WITH NO WARRANTIES OF ANY KIND INCLUDING THE</span>
00010 <span class="comment"> * WARRANTIES OF DESIGN, MERCHANTIBILITY AND FITNESS FOR A PARTICULAR</span>
00011 <span class="comment"> * PURPOSE, OR ARISING FROM A COURSE OF DEALING, USAGE OR TRADE PRACTICE.</span>
00012 <span class="comment"> * </span>
00013 <span class="comment"> * Sun RPC is provided with no support and without any obligation on the</span>
00014 <span class="comment"> * part of Sun Microsystems, Inc. to assist in its use, correction,</span>
00015 <span class="comment"> * modification or enhancement.</span>
00016 <span class="comment"> * </span>
00017 <span class="comment"> * SUN MICROSYSTEMS, INC. SHALL HAVE NO LIABILITY WITH RESPECT TO THE</span>
00018 <span class="comment"> * INFRINGEMENT OF COPYRIGHTS, TRADE SECRETS OR ANY PATENTS BY SUN RPC</span>
00019 <span class="comment"> * OR ANY PART THEREOF.</span>
00020 <span class="comment"> * </span>
00021 <span class="comment"> * In no event will Sun Microsystems, Inc. be liable for any lost revenue</span>
00022 <span class="comment"> * or profits or other special, indirect and consequential damages, even if</span>
00023 <span class="comment"> * Sun has been advised of the possibility of such damages.</span>
00024 <span class="comment"> * </span>
00025 <span class="comment"> * Sun Microsystems, Inc.</span>
00026 <span class="comment"> * 2550 Garcia Avenue</span>
00027 <span class="comment"> * Mountain View, California  94043</span>
00028 <span class="comment"> */</span>
00029 
00030 <span class="comment">/*</span>
00031 <span class="comment"> * rpc_prot.c</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> * Copyright (C) 1984, Sun Microsystems, Inc.</span>
00034 <span class="comment"> *</span>
00035 <span class="comment"> * This set of routines implements the rpc message definition,</span>
00036 <span class="comment"> * its serializer and some common rpc utility routines.</span>
00037 <span class="comment"> * The routines are meant for various implementations of rpc -</span>
00038 <span class="comment"> * they are NOT for the rpc client or rpc service implementations!</span>
00039 <span class="comment"> * Because authentication stuff is easy and is part of rpc, the opaque</span>
00040 <span class="comment"> * routines are also in this program.</span>
00041 <span class="comment"> */</span>
00042 
00043 <span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00044 
00045 <span class="preprocessor">#include "Rpc.h"</span>
00046 
<a name="l00047"></a><a class="code" href="Rpc__prot_8c.html#a0">00047</a> <span class="preprocessor">#define  Xdr_u_int32_t( x, a )  Xdr_u_int( x, (u_int *)a )</span>
00048 <span class="preprocessor"></span>
00049 <span class="comment">/* * * * * * * * * * * * * * XDR Authentication * * * * * * * * * * * */</span>
00050 
00051 <span class="comment">/*</span>
00052 <span class="comment"> * XDR an opaque authentication struct</span>
00053 <span class="comment"> * (see auth.h)</span>
00054 <span class="comment"> */</span>
<a name="l00055"></a><a class="code" href="Rpc__prot_8c.html#a2">00055</a> bool_t <a class="code" href="Rpc__prot_8c.html#a2">Xdr_opaque_auth</a>( XDR * xdrs, <span class="keyword">struct</span> opaque_auth * ap)
00056 {
00057 
00058         <span class="keywordflow">if</span> (<a class="code" href="Xdr_8c.html#a19">Xdr_enum</a>(xdrs, &amp;(ap-&gt;oa_flavor)))
00059                 <span class="keywordflow">return</span> (<a class="code" href="Xdr_8c.html#a21">Xdr_bytes</a>(xdrs, &amp;ap-&gt;oa_base,
00060                     &amp;ap-&gt;oa_length, MAX_AUTH_BYTES));
00061         <span class="keywordflow">return</span> (FALSE);
00062 }
00063 
00064 <span class="comment">/*</span>
00065 <span class="comment"> * XDR a DES block</span>
00066 <span class="comment"> */</span>
<a name="l00067"></a><a class="code" href="Rpc__prot_8c.html#a3">00067</a> bool_t <a class="code" href="Rpc__prot_8c.html#a3">Xdr_des_block</a>( XDR * xdrs, des_block * blkp)
00068 {
00069         <span class="keywordflow">return</span> (<a class="code" href="Xdr_8c.html#a20">Xdr_opaque</a>(xdrs, (caddr_t)blkp, <span class="keyword">sizeof</span>(des_block)));
00070 }
00071 
00072 <span class="comment">/* * * * * * * * * * * * * * XDR RPC MESSAGE * * * * * * * * * * * * * * * */</span>
00073 
00074 <span class="comment">/*</span>
00075 <span class="comment"> * XDR the MSG_ACCEPTED part of a reply message union</span>
00076 <span class="comment"> */</span>
<a name="l00077"></a><a class="code" href="Rpc__prot_8c.html#a4">00077</a> bool_t <a class="code" href="Rpc__prot_8c.html#a4">Xdr_accepted_reply</a>( XDR * xdrs, <span class="keyword">struct</span> accepted_reply * ar)
00078 {
00079 
00080         <span class="comment">/* personalized union, rather than calling xdr_union */</span>
00081         <span class="keywordflow">if</span> (! <a class="code" href="Rpc__prot_8c.html#a2">Xdr_opaque_auth</a>(xdrs, &amp;(ar-&gt;ar_verf)))
00082                 <span class="keywordflow">return</span> (FALSE);
00083         <span class="keywordflow">if</span> (! <a class="code" href="Xdr_8c.html#a19">Xdr_enum</a>(xdrs, (enum_t *)&amp;(ar-&gt;ar_stat)))
00084                 <span class="keywordflow">return</span> (FALSE);
00085 
00086         <span class="keywordflow">switch</span> (ar-&gt;ar_stat) {
00087         <span class="keywordflow">case</span> SUCCESS:
00088                 <span class="keywordflow">return</span> ((*(ar-&gt;ar_results.proc))(xdrs, ar-&gt;ar_results.where));
00089         <span class="keywordflow">case</span> PROG_MISMATCH:
00090                 <span class="keywordflow">if</span> (!<a class="code" href="Rpc__prot_8c.html#a0">Xdr_u_int32_t</a>(xdrs, &amp;(ar-&gt;ar_vers.low)))
00091                         <span class="keywordflow">return</span> (FALSE);
00092                 <span class="keywordflow">return</span> (<a class="code" href="Rpc__prot_8c.html#a0">Xdr_u_int32_t</a>(xdrs, &amp;(ar-&gt;ar_vers.high)));
00093         <span class="keywordflow">default</span>:
00094                 <span class="keywordflow">return</span> (TRUE);  <span class="comment">/* TRUE =&gt; open ended set of problems */</span>
00095         }
00096 }
00097 
00098 <span class="comment">/*</span>
00099 <span class="comment"> * XDR the MSG_DENIED part of a reply message union</span>
00100 <span class="comment"> */</span>
<a name="l00101"></a><a class="code" href="Rpc__prot_8c.html#a5">00101</a> bool_t <a class="code" href="Rpc__prot_8c.html#a5">Xdr_rejected_reply</a>( XDR * xdrs, <span class="keyword">struct</span> rejected_reply * rr)
00102 {
00103 
00104         <span class="comment">/* personalized union, rather than calling xdr_union */</span>
00105         <span class="keywordflow">if</span> (! <a class="code" href="Xdr_8c.html#a19">Xdr_enum</a>(xdrs, (enum_t *)&amp;(rr-&gt;rj_stat)))
00106                 <span class="keywordflow">return</span> (FALSE);
00107 
00108         <span class="keywordflow">switch</span> (rr-&gt;rj_stat) {
00109         <span class="keywordflow">case</span> RPC_MISMATCH:
00110                 <span class="keywordflow">if</span> (!<a class="code" href="Rpc__prot_8c.html#a0">Xdr_u_int32_t</a>(xdrs, &amp;(rr-&gt;rj_vers.low)))
00111                         <span class="keywordflow">return</span> (FALSE);
00112                 <span class="keywordflow">return</span> (<a class="code" href="Rpc__prot_8c.html#a0">Xdr_u_int32_t</a>(xdrs, &amp;(rr-&gt;rj_vers.high)));
00113         <span class="keywordflow">case</span> AUTH_ERROR:
00114                 <span class="keywordflow">return</span> (<a class="code" href="Xdr_8c.html#a19">Xdr_enum</a>(xdrs, (enum_t *)&amp;(rr-&gt;rj_why)));
00115         }
00116         <span class="keywordflow">return</span> (FALSE);
00117 }
00118 
00119 <span class="keyword">static</span> <span class="keyword">struct </span>Xdr_discrim reply_dscrm[3] = {
00120         { (int)MSG_ACCEPTED, <a class="code" href="Rpc__prot_8c.html#a4">Xdr_accepted_reply</a> },
00121         { (int)MSG_DENIED, <a class="code" href="Rpc__prot_8c.html#a5">Xdr_rejected_reply</a> },
00122         { __dontcare__, NULL_Xdrproc_t } };
00123 
00124 <span class="comment">/*</span>
00125 <span class="comment"> * XDR a reply message</span>
00126 <span class="comment"> */</span>
<a name="l00127"></a><a class="code" href="Rpc__prot_8c.html#a6">00127</a> bool_t <a class="code" href="Rpc__prot_8c.html#a6">Xdr_replymsg</a>( XDR * xdrs, <span class="keyword">struct</span> Rpc_msg * rmsg)
00128 {
00129         <span class="keywordflow">if</span> (<a class="code" href="Rpc__prot_8c.html#a0">Xdr_u_int32_t</a>(xdrs, &amp;(rmsg-&gt;rm_xid)) &amp;&amp; 
00130             <a class="code" href="Xdr_8c.html#a19">Xdr_enum</a>(xdrs, (enum_t *)&amp;(rmsg-&gt;rm_direction)) &amp;&amp;
00131             rmsg-&gt;rm_direction == REPLY)
00132                 <span class="keywordflow">return</span> (<a class="code" href="Xdr_8c.html#a23">Xdr_union</a>(xdrs, (enum_t *)&amp;(rmsg-&gt;rm_reply.rp_stat),
00133                    (caddr_t)&amp;(rmsg-&gt;rm_reply.ru), reply_dscrm, NULL_Xdrproc_t));
00134         <span class="keywordflow">return</span> (FALSE);
00135 }
00136 
00137 
00138 <span class="comment">/*</span>
00139 <span class="comment"> * Serializes the "static part" of a call message header.</span>
00140 <span class="comment"> * The fields include: rm_xid, rm_direction, rpcvers, prog, and vers.</span>
00141 <span class="comment"> * The rm_xid is not really static, but the user can easily munge on the fly.</span>
00142 <span class="comment"> */</span>
<a name="l00143"></a><a class="code" href="Rpc__prot_8c.html#a7">00143</a> bool_t <a class="code" href="Rpc__prot_8c.html#a7">Xdr_callhdr</a>( XDR * xdrs, <span class="keyword">struct</span> Rpc_msg * cmsg)
00144 {
00145 
00146         cmsg-&gt;rm_direction = CALL;
00147         cmsg-&gt;rm_call.cb_rpcvers = RPC_MSG_VERSION;
00148         <span class="keywordflow">if</span> (xdrs-&gt;x_op == XDR_ENCODE &amp;&amp;
00149             <a class="code" href="Rpc__prot_8c.html#a0">Xdr_u_int32_t</a>(xdrs, &amp;(cmsg-&gt;rm_xid)) &amp;&amp;
00150             <a class="code" href="Xdr_8c.html#a19">Xdr_enum</a>(xdrs, (enum_t *)&amp;(cmsg-&gt;rm_direction)) &amp;&amp;
00151             <a class="code" href="Rpc__prot_8c.html#a0">Xdr_u_int32_t</a>(xdrs, &amp;(cmsg-&gt;rm_call.cb_rpcvers)) &amp;&amp;
00152             <a class="code" href="Rpc__prot_8c.html#a0">Xdr_u_int32_t</a>(xdrs, &amp;(cmsg-&gt;rm_call.cb_prog)))
00153                 <span class="keywordflow">return</span> (<a class="code" href="Rpc__prot_8c.html#a0">Xdr_u_int32_t</a>(xdrs, &amp;(cmsg-&gt;rm_call.cb_vers)));
00154         <span class="keywordflow">return</span> (FALSE);
00155 }
00156 
00157 <span class="comment">/* ************************** Client utility routine ************* */</span>
00158 
00159 <span class="keyword">static</span> <span class="keywordtype">void</span> accepted( <span class="keyword">enum</span> accept_stat acpt_stat, <span class="keyword">struct</span> Rpc_err * error)
00160 {
00161 
00162         <span class="keywordflow">switch</span> (acpt_stat) {
00163 
00164         <span class="keywordflow">case</span> PROG_UNAVAIL:
00165                 error-&gt;re_status = RPC_PROGUNAVAIL;
00166                 <span class="keywordflow">return</span>;
00167 
00168         <span class="keywordflow">case</span> PROG_MISMATCH:
00169                 error-&gt;re_status = RPC_PROGVERSMISMATCH;
00170                 <span class="keywordflow">return</span>;
00171 
00172         <span class="keywordflow">case</span> PROC_UNAVAIL:
00173                 error-&gt;re_status = RPC_PROCUNAVAIL;
00174                 <span class="keywordflow">return</span>;
00175 
00176         <span class="keywordflow">case</span> GARBAGE_ARGS:
00177                 error-&gt;re_status = RPC_CANTDECODEARGS;
00178                 <span class="keywordflow">return</span>;
00179 
00180         <span class="keywordflow">case</span> SYSTEM_ERR:
00181                 error-&gt;re_status = RPC_SYSTEMERROR;
00182                 <span class="keywordflow">return</span>;
00183 
00184         <span class="keywordflow">case</span> SUCCESS:
00185                 error-&gt;re_status = RPC_SUCCESS;
00186                 <span class="keywordflow">return</span>;
00187         }
00188         <span class="comment">/* something's wrong, but we don't know what ... */</span>
00189         error-&gt;re_status = RPC_FAILED;
00190         error-&gt;re_lb.s1 = (long)MSG_ACCEPTED;
00191         error-&gt;re_lb.s2 = (long)acpt_stat;
00192 }
00193 
00194 <span class="keyword">static</span> <span class="keywordtype">void</span> rejected( <span class="keyword">enum</span> reject_stat rjct_stat, <span class="keyword">struct</span> Rpc_err * error)
00195 {
00196 
00197         <span class="keywordflow">switch</span> (rjct_stat) {
00198 
00199         <span class="keywordflow">case</span> RPC_MISMATCH:
00200                 error-&gt;re_status = RPC_VERSMISMATCH;
00201                 <span class="keywordflow">return</span>;
00202 
00203         <span class="keywordflow">case</span> AUTH_ERROR:
00204                 error-&gt;re_status = RPC_AUTHERROR;
00205                 <span class="keywordflow">return</span>;
00206         }
00207         <span class="comment">/* something's wrong, but we don't know what ... */</span>
00208         error-&gt;re_status = RPC_FAILED;
00209         error-&gt;re_lb.s1 = (long)MSG_DENIED;
00210         error-&gt;re_lb.s2 = (long)rjct_stat;
00211 }
00212 
00213 <span class="comment">/*</span>
00214 <span class="comment"> * given a reply message, fills in the error</span>
00215 <span class="comment"> */</span>
<a name="l00216"></a><a class="code" href="Rpc__prot_8c.html#a10">00216</a> <span class="keywordtype">void</span> <a class="code" href="Rpc__prot_8c.html#a10">_seterr_reply</a>( <span class="keyword">struct</span> Rpc_msg * msg, <span class="keyword">struct</span> Rpc_err * error)
00217 {
00218 
00219         <span class="comment">/* optimized for normal, SUCCESSful case */</span>
00220         <span class="keywordflow">switch</span> (msg-&gt;rm_reply.rp_stat) {
00221 
00222         <span class="keywordflow">case</span> MSG_ACCEPTED:
00223                 <span class="keywordflow">if</span> (msg-&gt;acpted_rply.ar_stat == SUCCESS) {
00224                         error-&gt;re_status = RPC_SUCCESS;
00225                         <span class="keywordflow">return</span>;
00226                 };
00227                 accepted(msg-&gt;acpted_rply.ar_stat, error);
00228                 <span class="keywordflow">break</span>;
00229 
00230         <span class="keywordflow">case</span> MSG_DENIED:
00231                 rejected(msg-&gt;rjcted_rply.rj_stat, error);
00232                 <span class="keywordflow">break</span>;
00233 
00234         <span class="keywordflow">default</span>:
00235                 error-&gt;re_status = RPC_FAILED;
00236                 error-&gt;re_lb.s1 = (long)(msg-&gt;rm_reply.rp_stat);
00237                 <span class="keywordflow">break</span>;
00238         }
00239         <span class="keywordflow">switch</span> (error-&gt;re_status) {
00240 
00241         <span class="keywordflow">case</span> RPC_VERSMISMATCH:
00242                 error-&gt;re_vers.low = msg-&gt;rjcted_rply.rj_vers.low;
00243                 error-&gt;re_vers.high = msg-&gt;rjcted_rply.rj_vers.high;
00244                 <span class="keywordflow">break</span>;
00245 
00246         <span class="keywordflow">case</span> RPC_AUTHERROR:
00247                 error-&gt;re_why = msg-&gt;rjcted_rply.rj_why;
00248                 <span class="keywordflow">break</span>;
00249 
00250         <span class="keywordflow">case</span> RPC_PROGVERSMISMATCH:
00251                 error-&gt;re_vers.low = msg-&gt;acpted_rply.ar_vers.low;
00252                 error-&gt;re_vers.high = msg-&gt;acpted_rply.ar_vers.high;
00253                 <span class="keywordflow">break</span>;
00254 
00255         <span class="keywordflow">default</span>:
00256                 <span class="keywordflow">break</span>;
00257         }
00258 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Dec 22 14:15:35 2006 for RPCSEC_GSS Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
