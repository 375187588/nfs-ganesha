<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RPCSEC_GSS Library: onc_rpc_server.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>onc_rpc_server.c</h1><a href="onc__rpc__server_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * RPCSEC_GSS: basic server for tests</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *  $Header: /cea/home/cvs/cvs/SHERPA/BaseCvs/GANESHA/src/RPCSEC_GSS/rpcsec_gss_server.c,v 1.1 2005/04/13 11:32:38 deniel Exp $</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * $Log: rpcsec_gss_server.c,v $</span>
00007 <span class="comment"> * Revision 1.1  2005/04/13 11:32:38  deniel</span>
00008 <span class="comment"> * Added the two test client and server</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> */</span>
00012 
00013 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00014 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00015 <span class="preprocessor">#include &lt;stdlib.h&gt;</span> 
00016 <span class="preprocessor">#include &lt;string.h&gt;</span> 
00017 
00018 <span class="preprocessor">#include &lt;sys/errno.h&gt;</span>
00019 <span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00020 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00021 
00022 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00023 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
00024 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00025 <span class="preprocessor">#include &lt;netinet/tcp.h&gt;</span>
00026 
00027 <span class="preprocessor">#include "Rpc.h"</span>
00028 <span class="preprocessor">#include "Pmap_clnt.h"</span>
00029 <span class="preprocessor">#include "gssapi/gssapi.h"</span>
00030 
<a name="l00031"></a><a class="code" href="onc__rpc__server_8c.html#a0">00031</a> <span class="preprocessor">#define LOGFILE_DEFAUT    "./toto-server.log"</span>
<a name="l00032"></a><a class="code" href="onc__rpc__server_8c.html#a1">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define TraduireAdresse( adresse, dest )                   \</span>
00033 <span class="preprocessor">           sprintf( dest, "%d.%d.%d.%d",                   \</span>
00034 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0xFF000000 ) &gt;&gt; 24, \</span>
00035 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x00FF0000 ) &gt;&gt; 16, \</span>
00036 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x0000FF00 ) &gt;&gt; 8,  \</span>
00037 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x000000FF ) )</span>
<a name="l00038"></a><a class="code" href="onc__rpc__server_8c.html#a2">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define TIMEOUT_SEC 25 </span>
<a name="l00039"></a><a class="code" href="onc__rpc__server_8c.html#a3">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_RPC_SERVICE 300400 </span>
<a name="l00040"></a><a class="code" href="onc__rpc__server_8c.html#a4">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define RECV_SIZE 2048</span>
<a name="l00041"></a><a class="code" href="onc__rpc__server_8c.html#a5">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define SEND_SIZE 2048</span>
<a name="l00042"></a><a class="code" href="onc__rpc__server_8c.html#a6">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define V1 1 </span>
<a name="l00043"></a><a class="code" href="onc__rpc__server_8c.html#a7">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define PROC_NULL  0 </span>
<a name="l00044"></a><a class="code" href="onc__rpc__server_8c.html#a8">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define PROC_PLUS1 1</span>
00045 <span class="preprocessor"></span>
00046 
00047 <span class="comment">/* les options pour getopt */</span>
<a name="l00048"></a><a class="code" href="onc__rpc__server_8c.html#a9">00048</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a14">options</a>[] = <span class="stringliteral">"hL:N:s:"</span> ;
00049 
00050 <span class="comment">/* L'aide en ligne */</span>
<a name="l00051"></a><a class="code" href="onc__rpc__server_8c.html#a10">00051</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a15">utilisation</a>[] = 
00052 <span class="stringliteral">"Utilisation: %s [-hLs] \n"</span>
00053 <span class="stringliteral">"\t[-h]                   affiche cet aide en ligne\n"</span>
00054 <span class="stringliteral">"\t[-L &lt;logfile&gt;]         indique le fichier de log\n"</span>
00055 <span class="stringliteral">"\t[-N &lt;NivDebug&gt;]        indique le niveau de debug pour les journaux\n"</span> 
00056 <span class="stringliteral">"\t[-s &lt;service RPC&gt;]     indique le port ou le service a utiliser\n"</span> ;
00057 
00058 <span class="comment">/* Des variables globales (en general ecrites une seule fois, relues plusieurs) */</span>
00059 <span class="keyword">static</span> <span class="keywordtype">char</span> logfile_name[MAXPATHLEN] ;    <span class="comment">/* Le chemin du fichier de log           */</span>
<a name="l00060"></a><a class="code" href="onc__rpc__server_8c.html#a12">00060</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> = DEFAULT_RPC_SERVICE ;
00061 
00062 
<a name="l00063"></a><a class="code" href="onc__rpc__server_8c.html#a13">00063</a> <span class="keywordtype">void</span> <a class="code" href="rpcsec__gss__server_8natif_8c.html#a17">dispatch</a>( <span class="keyword">struct</span> Svc_req * ptr_req, SVCXPRT * ptr_svc )
00064 {
00065   <span class="keywordtype">int</span> val ;
00066   <span class="keyword">struct </span>Rpc_gss_cred     * gc = NULL ;
00067   <span class="keyword">struct </span><a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> * gd = NULL ;
00068   gss_buffer_desc           mechname;
00069   gss_buffer_desc           clientname ;
00070   OM_uint32                 maj_stat = 0 ;
00071   OM_uint32                 min_stat = 0 ;
00072 
00073   printf( <span class="stringliteral">"For this cal, authentication type %u is used\n"</span>, ptr_req-&gt;rq_cred.oa_flavor ) ;
00074 
00075   <span class="keywordflow">switch</span>( ptr_req-&gt;rq_proc )
00076     {
00077     <span class="keywordflow">case</span> <a class="code" href="onc__rpc__client_8c.html#a6">PROC_NULL</a>:
00078        printf( <span class="stringliteral">"Appel a PROC_NULL\n"</span> ) ;
00079 
00080       <span class="keywordflow">if</span>( Svc_getargs( ptr_svc, <a class="code" href="Xdr_8c.html#a5">Xdr_void</a>, NULL ) == FALSE )
00081         <a class="code" href="Svc_8c.html#a16">Svcerr_decode</a>( ptr_svc ) ;
00082       <span class="keywordflow">if</span>( <a class="code" href="Svc_8c.html#a14">Svc_sendreply</a>( ptr_svc, <a class="code" href="Xdr_8c.html#a5">Xdr_void</a>, NULL ) == FALSE )
00083         <a class="code" href="Svc_8c.html#a16">Svcerr_decode</a>( ptr_svc ) ;
00084       break ;
00085       
00086     <span class="keywordflow">case</span> <a class="code" href="onc__rpc__client_8c.html#a7">PROC_PLUS1</a>:
00087       printf(  <span class="stringliteral">"Appel a PROC_PLUS1\n"</span> ) ;
00088 
00089 
00090       <span class="keywordflow">if</span>( Svc_getargs( ptr_svc, <a class="code" href="Xdr_8c.html#a6">Xdr_int</a>, (<span class="keywordtype">char</span> *)&amp;val ) == FALSE )
00091         <a class="code" href="Svc_8c.html#a16">Svcerr_decode</a>( ptr_svc ) ;
00092 
00093       printf( <span class="stringliteral">"Valeur recue = %d\n"</span>, val ) ;
00094 
00095       val = val + 1 ;  <span class="comment">/* Ce que fait cette fonction est spectaculaire ... :-)))) */</span>
00096       
00097       <span class="keywordflow">if</span>( <a class="code" href="Svc_8c.html#a14">Svc_sendreply</a>( ptr_svc, <a class="code" href="Xdr_8c.html#a6">Xdr_int</a>, (<span class="keywordtype">char</span> *)&amp;val ) == FALSE )
00098         <a class="code" href="Svc_8c.html#a16">Svcerr_decode</a>( ptr_svc ) ;
00099       
00100       break ;
00101     }
00102   
00103 } <span class="comment">/* dispatch */</span>
00104 
<a name="l00105"></a><a class="code" href="onc__rpc__server_8c.html#a14">00105</a> <a class="code" href="server-gss_8c.html#a35">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[] )
00106 {
00107   <span class="keywordtype">char</span>               nom_exec[MAXPATHLEN] ;
00108   <span class="keywordtype">char</span> *             tempo_nom_exec  = NULL ;
00109   <span class="keyword">struct </span>rpcent *    etc_rpc ;               <span class="comment">/* pour consulter /etc/rpc ou rpc.bynumber */</span>
00110   <span class="keywordtype">int</span>                c ;                     <span class="comment">/* pour getopt                  */</span>
00111   <span class="keyword">static</span> <span class="keywordtype">char</span>        machine_locale[256] ;
00112   SVCXPRT *          ptr_svc ;
00113   <span class="keywordtype">int</span>                rc ;
00114 
00115 
00116   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> req_time = 10000 ;
00117   u_int lo, hi ;
00118   
00119   bool_t ret ;
00120 
00121    printf( <span class="stringliteral">"-----&gt; u_short = %u uint32_t = %d\n"</span>, <span class="keyword">sizeof</span>( u_short) , <span class="keyword">sizeof</span>( uint32_t ) ) ;
00122  
00123   <span class="comment">/* Initialisation des valeurs par defaut */</span>
00124   strcpy( logfile_name, <a class="code" href="onc__rpc__server_8c.html#a0">LOGFILE_DEFAUT</a> ) ;
00125   
00126   <span class="comment">/* On recupere le nom de l'executable */</span>
00127   <span class="keywordflow">if</span>( ( tempo_nom_exec = strrchr( argv[0], <span class="charliteral">'/'</span> ) ) != NULL )
00128     strcpy( (<span class="keywordtype">char</span> *)nom_exec, tempo_nom_exec + 1 ) ;
00129   
00130   <span class="keywordflow">while</span>( ( c = getopt( argc, argv, <a class="code" href="client-gss_8c.html#a14">options</a> ) ) != EOF )
00131     {
00132       <span class="keywordflow">switch</span>( c ) 
00133         {
00134         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00135           <span class="comment">/* Un nom ou un numero de service a ete indique */</span>
00136           <span class="keywordflow">if</span>( isalpha( (<span class="keywordtype">int</span>)*optarg ) )
00137             {
00138               <span class="comment">/* Ca commence pas par un chiffre donc c'est un nom service */</span>
00139               <span class="keywordflow">if</span>( ( etc_rpc = getrpcbyname( optarg ) ) == NULL )
00140                 {
00141                   fprintf( stderr, <span class="stringliteral">"Impossible de resoudre le service %s\n"</span>, optarg ) ;
00142                 }
00143               <span class="keywordflow">else</span>
00144                 {
00145                   <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> = etc_rpc-&gt;r_number ;
00146                 }
00147             }
00148           <span class="keywordflow">else</span>
00149             {
00150               <span class="comment">/* C'est un numero de service qui est indique */</span>
00151               <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> = atoi( optarg ) ;
00152             }
00153           break ;
00154 
00155         <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
00156            printf( <span class="stringliteral">"Option -L unsupported for now\n"</span> ) ;
00157            break ;
00158 
00159         <span class="keywordflow">case</span> <span class="charliteral">'N'</span>:
00160            printf( <span class="stringliteral">"Option -N unsupported for now\n"</span> ) ;
00161            break ;
00162 
00163         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00164         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00165         <span class="keywordflow">default</span>:
00166           <span class="comment">/* Cette option affiche l'aide en ligne */</span>
00167           printf( <span class="stringliteral">"Unknown option %c\n"</span>, c ) ;
00168           printf( <a class="code" href="client-gss_8c.html#a15">utilisation</a>, argv[0] ) ;
00169           exit( 0 ) ;
00170           break ;
00171         }
00172     }
00173 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00174 <span class="preprocessor"></span>
00175   <span class="comment">/* Init Buddy allocator */</span>
00176 
00177   <span class="keywordflow">if</span> ( ( rc = BuddyInit( NULL )) != BUDDY_SUCCESS )
00178   {
00179     <span class="comment">/* can't use shell tracing functions there */</span>
00180     fprintf( stderr, <span class="stringliteral">"Error %d initializing Buddy allocator.\n"</span>,rc);
00181     exit( 1 ) ;
00182   }
00183 
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span>
00186   <span class="keywordflow">if</span>( argc != optind )
00187     {
00188       fprintf( stderr, <a class="code" href="client-gss_8c.html#a15">utilisation</a>, nom_exec ) ;
00189       fprintf( stderr, <span class="stringliteral">"Pas d'argument additionnel\n"</span> ) ;
00190       exit( 1 ) ;
00191     }
00192   
00193   <span class="comment">/* Obtention du nom de la machine */</span>
00194   <span class="keywordflow">if</span>( gethostname( machine_locale, <span class="keyword">sizeof</span>( machine_locale ) ) != 0 )
00195     {
00196       printf( <span class="stringliteral">"gethostbyname impossible: errno=%d, h_errno=%d\n"</span>, errno, h_errno ) ;
00197       exit( 1 ) ;
00198     }
00199  
00200   <span class="comment">/* Petit coucou initial */</span>
00201   printf( <span class="stringliteral">"Demarrage du serveur toto-server-rpc\n"</span> ) ;
00202   printf( <span class="stringliteral">"Le nom de la machine est %s\n"</span>, machine_locale ) ;
00203   printf( <span class="stringliteral">"J'utilise le service RPC %d\n"</span>, <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> ) ;
00204 
00205   <span class="comment">/* Creation du handler SVC */</span>
00206   <span class="keywordflow">if</span>( ( ptr_svc = <a class="code" href="Svc__tcp_8c.html#a14">Svctcp_create</a>( RPC_ANYSOCK, <a class="code" href="onc__rpc__client_8c.html#a4">SEND_SIZE</a> , <a class="code" href="onc__rpc__client_8c.html#a3">RECV_SIZE</a> ) ) == NULL )
00207     {
00208       printf( <span class="stringliteral">"svctcp_create impossible\n"</span> ) ;
00209       exit( 1 ) ;
00210     }
00211 
00212   <a class="code" href="Svc__tab__auth_8c.html#a3">Svcauth_gss_tab_creds_alloc</a>() ;
00213   
00214   <span class="comment">/* Si un enregistrement au portmapper avait eu lieu, je le latte */</span>
00215   <a class="code" href="Pmap__clnt_8c.html#a4">Pmap_unset</a>( <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a>, <a class="code" href="onc__rpc__client_8c.html#a5">V1</a> ) ;
00216 
00217   
00218    <span class="comment">/* Enregistrement du service */</span>
00219   printf( <span class="stringliteral">"Enregistrement sur le service %d\n"</span>, <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> ) ;
00220   <span class="keywordflow">if</span>( <a class="code" href="Svc_8c.html#a10">Svc_register</a>( ptr_svc, <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a>, <a class="code" href="onc__rpc__client_8c.html#a5">V1</a>, <a class="code" href="onc__rpc__server_8c.html#a13">dispatch</a>, IPPROTO_TCP ) == FALSE )
00221     {
00222       printf( <span class="stringliteral">"svc_register impossible\n"</span> ) ;
00223       exit( 1 ) ;
00224     }
00225 
00226   printf( <span class="stringliteral">"------------------\n"</span> ) ;
00227 
00228   <span class="comment">/* Silence, on tourne .... */</span>
00229   <a class="code" href="Svc__run_8c.html#a1">Svc_run</a>() ;
00230 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Dec 22 14:15:35 2006 for RPCSEC_GSS Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
