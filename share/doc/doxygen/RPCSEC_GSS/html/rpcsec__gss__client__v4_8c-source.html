<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RPCSEC_GSS Library: rpcsec_gss_client_v4.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>rpcsec_gss_client_v4.c</h1><a href="rpcsec__gss__client__v4_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * RPCSEC_GSS: basic client for tests</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * $Header: /cea/home/cvs/cvs/SHERPA/BaseCvs/GANESHA/src/RPCSEC_GSS/rpcsec_gss_client.c,v 1.1 2005/04/13 11:32:38 deniel Exp $</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * $Log: rpcsec_gss_client.c,v $</span>
00007 <span class="comment"> * Revision 1.1  2005/04/13 11:32:38  deniel</span>
00008 <span class="comment"> * Added the two test client and server</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> */</span>
00012 
00013 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00014 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00015 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00016 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
00017 <span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00018 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
00019 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00020 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00021 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
00022 <span class="preprocessor">#include &lt;netinet/tcp.h&gt;</span>
00023 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00024 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00025 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00026 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00027 <span class="preprocessor">#include &lt;string.h&gt;</span>
00028 
00029 <span class="preprocessor">#include "Rpc.h"</span>
00030 <span class="preprocessor">#include "Pmap_clnt.h"</span>
00031 <span class="preprocessor">#include "nfs4.h"</span>
00032 
<a name="l00033"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a0">00033</a> <span class="preprocessor">#define TraduireAdresse( adresse, dest )                   \</span>
00034 <span class="preprocessor">           sprintf( dest, "%d.%d.%d.%d",                   \</span>
00035 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0xFF000000 ) &gt;&gt; 24, \</span>
00036 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x00FF0000 ) &gt;&gt; 16, \</span>
00037 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x0000FF00 ) &gt;&gt; 8,  \</span>
00038 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x000000FF ) )</span>
<a name="l00039"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a1">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define TIMEOUT_SEC 5 </span>
<a name="l00040"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a2">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_RPC_SERVICE 100003 </span>
<a name="l00041"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a3">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define RECV_SIZE 2048</span>
<a name="l00042"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a4">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define SEND_SIZE 2048</span>
<a name="l00043"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a5">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define V4 4 </span>
<a name="l00044"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a6">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define PROC_NULL  0 </span>
<a name="l00045"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a7">00045</a> <span class="preprocessor"></span><span class="preprocessor">#define PROC_PLUS1 1</span>
00046 <span class="preprocessor"></span>
<a name="l00047"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a8">00047</a> <span class="preprocessor">#define DEFAULT_MECHANISM "kerberos_v5"</span>
<a name="l00048"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a9">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_PRINCIPAL "toto/trekking.bruyeres.s"</span>
00049 <span class="preprocessor"></span>
00050 <span class="keyword">extern</span> gss_OID_desc krb5oid;
00051 
00052 <span class="comment">/* L'aide en ligne */</span>
<a name="l00053"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a11">00053</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a14">options</a>[] = <span class="stringliteral">"hd:s:S:"</span> ;
<a name="l00054"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a12">00054</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a15">utilisation</a>[] =
00055 <span class="stringliteral">"Utilisation: %s [-hds] message\n"</span>
00056 <span class="stringliteral">"\t[-h]                   affiche cet aide en ligbe\n"</span>
00057 <span class="stringliteral">"\t[-d &lt;machine&gt;]         indique la machine serveur\n"</span>
00058 <span class="stringliteral">"\t[-s &lt;service RPC&gt;]     indique le port ou le service a utiliser\n"</span> 
00059 <span class="stringliteral">"\t[-S &lt;service auth&gt;]    indique le principal a utiliser\n"</span> ;
00060 
00061 
00062 
00063 <span class="comment">/* Outil necessaire a RPCSEC_GSS */</span>
<a name="l00064"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a13">00064</a> <span class="keywordtype">char</span> <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>[1024] ;
<a name="l00065"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a14">00065</a> <span class="keywordtype">char</span> <a class="code" href="rpcsec__gss__client_8c.html#a14">server</a>[] = <span class="stringliteral">"server"</span> ;
00066 
<a name="l00067"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a15">00067</a> CLIENT * <a class="code" href="rpcsec__gss__client__v4_8natif_8c.html#a15">Creer_RPCClient</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> adresse, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> programme, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> version, 
00068                           <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> port, <span class="keywordtype">int</span> sockfd )
00069 {
00070   <span class="keyword">struct </span>sockaddr_in adresse_rpc ;
00071   <span class="keywordtype">int</span>                sock = 0 ;
00072   CLIENT *           client ;
00073   <span class="keyword">struct </span>timeval     intervalle ;
00074   <span class="keywordtype">int</span>                rc ;
00075   <span class="keyword">struct </span>Rpc_gss_sec sec;
00076 
00077   memset( &amp;adresse_rpc, 0, <span class="keyword">sizeof</span>( adresse_rpc ) ) ;
00078   adresse_rpc.sin_port        = port ;
00079   adresse_rpc.sin_family      = AF_INET ;
00080   adresse_rpc.sin_addr.s_addr = adresse ;
00081 
00082   sock               = sockfd ;
00083   intervalle.tv_sec  = TIMEOUT_SEC ;
00084   intervalle.tv_usec = 0 ;
00085   
00086   <span class="keywordflow">if</span>( sock &gt; 0 )
00087     {
00088       <span class="keywordflow">if</span>( port &gt; 0 )
00089         {
00090           <span class="comment">/* En tcp, il faut que la socket soit connectee sur le service en face si on n'utilise pas RPC_ANYSOCK </span>
00091 <span class="comment">           * ATTENTION, ceci est une feature non documentee des RPC clientes (j'ai vu ca dans les sources) */</span>
00092           <span class="keywordflow">if</span>( connect( sock, (<span class="keyword">struct</span> sockaddr_in *)&amp;adresse_rpc, <span class="keyword">sizeof</span>( adresse_rpc ) ) &lt; 0 )
00093             fprintf( stderr, <span class="stringliteral">"connect impossible sur le serveur RPC\n"</span> ) ;
00094         }
00095       <span class="keywordflow">else</span>
00096         {
00097           <span class="comment">/* Dans ce cas, on ne connait pas le port en face, donc connect impossible, on prend RPC_ANYSOCK </span>
00098 <span class="comment">           * mais uniquement apres avoir ferme la socket 'sock' qui ne sert a rien ici */</span>
00099           close( sock ) ;
00100           sock = RPC_ANYSOCK ;
00101         }
00102     }
00103   
00104 
00105   <span class="comment">/* Creation et allocation du client */</span>
00106   <span class="keywordflow">if</span>( ( client = <a class="code" href="Clnt__tcp_8c.html#a11">Clnttcp_create</a>( &amp;adresse_rpc, programme, version,  
00107                                  &amp;sock, <a class="code" href="onc__rpc__client_8c.html#a4">SEND_SIZE</a>, <a class="code" href="onc__rpc__client_8c.html#a3">RECV_SIZE</a> ) ) == NULL )
00108     {
00109       <span class="keywordtype">char</span> erreur[100] ;
00110       <span class="keywordtype">char</span> entete[100] ;
00111       
00112       sprintf( entete, <span class="stringliteral">"Creation RPC %d|%d|0x%x:%d|%d"</span>, programme, version, adresse, port, sock ) ;
00113       strcpy( erreur, clnt_spcreateerror( entete ) ) ;
00114           fprintf( stderr, <span class="stringliteral">"%s"</span>, erreur ) ;
00115           
00116           <span class="keywordflow">return</span> NULL ;
00117         }
00118 
00119   <span class="comment">/* Authentification avec RPCSEC_GSS */</span>
00120   <span class="comment">/* sec.mech = (gss_OID)&amp;krb5oid ; */</span>
00121   sec.mech = GSS_C_NULL_OID ; 
00122   sec.qop =  GSS_C_QOP_DEFAULT ;
00123   <span class="comment">/* sec.svc = RPCSEC_GSS_SVC_NONE ;   */</span>
00124   <span class="comment">/* sec.svc = RPCSEC_GSS_SVC_INTEGRITY ; */</span>
00125   sec.svc = RPCSEC_GSS_SVC_PRIVACY ; 
00126         
00127   <span class="keywordflow">if</span>( ( client-&gt;cl_auth = Authgss_create_default( client, <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>, &amp;sec ) ) == NULL )
00128     {    
00129       fprintf( stderr, <span class="stringliteral">"Authentification du client impossible\n "</span> ) ;
00130       exit( 1 ) ;
00131     }
00132   fprintf( stderr, <span class="stringliteral">"Authentification du client reussie\n"</span> ) ;
00133   
00134   <span class="keywordflow">return</span> client ;
00135 } <span class="comment">/* Creer_RPCClient */</span>
00136 
<a name="l00137"></a><a class="code" href="rpcsec__gss__client__v4_8c.html#a16">00137</a> <a class="code" href="server-gss_8c.html#a35">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[] ) 
00138 {
00139   <span class="keyword">struct </span>timeval   intervalle = { TIMEOUT_SEC, 0 };
00140   CLIENT *         client ;
00141   <span class="keywordtype">int</span>              c ;  
00142   <span class="keyword">struct </span>rpcent *  etc_rpc ;               <span class="comment">/* pour consulter /etc/rpc ou rpc.bynumber */</span>
00143   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>     adresse_serveur ;  <span class="comment">/* Au format NET */</span>
00144   <span class="keyword">struct </span>hostent * hp ;
00145   <span class="keywordtype">char</span>             nom_exec[MAXPATHLEN] ;
00146   <span class="keywordtype">char</span>             machine_locale[256] ;
00147   <span class="keywordtype">char</span> *           tempo_nom_exec  = NULL ;
00148   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>     <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> = DEFAULT_RPC_SERVICE ;
00149   <span class="keywordtype">int</span>              val = 2 ;
00150   <span class="keywordtype">int</span>              rc ;
00151   <span class="keywordtype">int</span>              loop = 0 ;
00152  
00153   <span class="keyword">struct </span>COMPOUND4args compound4_args ;
00154   <span class="keyword">struct </span>COMPOUND4res  compound4_res ;
00155   
00156   
00157  
00158    <span class="comment">/* On recupere le nom de l'executable */</span>
00159   <span class="keywordflow">if</span>( ( tempo_nom_exec = (<span class="keywordtype">char</span> *)strrchr( argv[0], <span class="charliteral">'/'</span> ) ) != NULL )
00160     strcpy( (<span class="keywordtype">char</span> *)nom_exec, tempo_nom_exec + 1 ) ;
00161   
00162   <span class="comment">/* Initialisation des valeurs */</span>
00163   strcpy( <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>, <a class="code" href="rpcsec__gss__client_8c.html#a9">DEFAULT_PRINCIPAL</a> ) ;
00164 
00165 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00166 <span class="preprocessor"></span>
00167   <span class="comment">/* Init Buddy allocator */</span>
00168 
00169   <span class="keywordflow">if</span> ( ( rc = BuddyInit( NULL )) != BUDDY_SUCCESS )
00170   {
00171     <span class="comment">/* can't use shell tracing functions there */</span>
00172     fprintf( stderr, <span class="stringliteral">"Error %d initializing Buddy allocator.\n"</span>,rc);
00173     exit( 1 ) ;
00174   }
00175 
00176 <span class="preprocessor">#endif</span>
00177 <span class="preprocessor"></span>
00178   <span class="keywordflow">while</span>( ( c = getopt( argc, argv, <a class="code" href="client-gss_8c.html#a14">options</a> ) ) != EOF )
00179     {
00180       <span class="keywordflow">switch</span>( c )
00181         {
00182         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00183           <span class="comment">/* Cette option permet de recuperer un nom pour la machine distante */</span>
00184           <span class="keywordflow">if</span>( isalpha( *optarg ) )
00185             {
00186               <span class="comment">/* Recuperation de l'adresse de la machine serveur */</span>
00187               <span class="keywordflow">if</span>( ( hp = gethostbyname( optarg ) ) == NULL )
00188                 {
00189                   printf( <span class="stringliteral">"gethostbyname impossible: errno = %d, h_errno = %d\n"</span>, errno, h_errno ) ;
00190                   exit( 1 ) ; 
00191                 }
00192               
00193               memcpy( &amp;adresse_serveur, hp-&gt;h_addr, hp-&gt;h_length ) ;
00194             }
00195           <span class="keywordflow">else</span>
00196             {
00197               adresse_serveur = inet_addr( optarg ) ;
00198             }
00199           <span class="keywordflow">break</span>;
00200 
00201         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00202           <span class="comment">/* Un nom ou un numero de service a ete indique */</span>
00203           <span class="keywordflow">if</span>( isalpha( (<span class="keywordtype">int</span>)*optarg ) )
00204             {
00205               <span class="comment">/* Ca commence pas par un chiffre donc c'est un nom service */</span>
00206               <span class="keywordflow">if</span>( ( etc_rpc = getrpcbyname( optarg ) ) == NULL )
00207                 {
00208                   fprintf( stderr, <span class="stringliteral">"Impossible de resoudre le service %s\n"</span>, optarg ) ;
00209                 }
00210               <span class="keywordflow">else</span>
00211                 {
00212                   <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> = etc_rpc-&gt;r_number ;
00213                 }
00214             }
00215           <span class="keywordflow">else</span>
00216             {
00217               <span class="comment">/* C'est un numero de service qui est indique */</span>
00218               <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> = atoi( optarg ) ;
00219             }
00220           break ;
00221 
00222         <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00223           <span class="comment">/* On indique un principal different */</span>
00224           strcpy( <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>, optarg ) ;
00225           break ;
00226           
00227         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00228         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00229         <span class="keywordflow">default</span>:
00230           <span class="comment">/* Affichage de l'aide en ligne */</span>
00231           fprintf( stderr, <a class="code" href="client-gss_8c.html#a15">utilisation</a>, nom_exec ) ;
00232           exit( 0 ) ;
00233           break ;
00234         }
00235     }
00236 
00237   printf( <span class="stringliteral">"Using principal=%s rpc=%u \n"</span>, <a class="code" href="rpcsec__gss__client_8c.html#a13">princ</a>, <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a> ) ;
00238 
00239   printf( <span class="stringliteral">"GSS_S_COMPLETE = %d     GSS_S_CONTINUE_NEEDED = %d\n"</span>, GSS_S_COMPLETE, GSS_S_CONTINUE_NEEDED ) ;
00240  
00241   <span class="keywordflow">if</span>( ( client = <a class="code" href="rpcsec__gss__client__v4_8natif_8c.html#a15">Creer_RPCClient</a>( adresse_serveur, <a class="code" href="onc__rpc__server_8c.html#a12">rpc_service_num</a>, <a class="code" href="rpcsec__gss__client__v4_8c.html#a5">V4</a>, 0 , RPC_ANYSOCK ) ) == NULL )
00242     {
00243       <span class="keywordtype">char</span> erreur[100] ;
00244       strcpy( erreur, clnt_spcreateerror( <span class="stringliteral">"Creation RPC"</span> ) ) ;
00245       exit( 1 ) ;
00246     }
00247 
00248   compound4_args.tag.utf8string_len = 0 ; <span class="comment">/* No Tag */</span>
00249   compound4_args.minorversion = 0 ;
00250   compound4_args.argarray.argarray_len = 1 ;
00251   compound4_args.argarray.argarray_val = (<span class="keyword">struct </span>nfs_argop4 * )mem_alloc( <span class="keyword">sizeof</span>( <span class="keyword">struct</span> nfs_argop4 ) ) ;
00252   compound4_args.argarray.argarray_val[0].argop = NFS4_OP_PUTROOTFH ; <span class="comment">/* This operation requires no argument */</span>
00253 
00254   printf( <span class="stringliteral">"About to call NFS4_COMPOUND with a signe NFS4_OP_PUTROOTFH\n"</span> ) ;
00255 
00256   <span class="keywordflow">for</span>( loop = 0 ; loop &lt; 1 <span class="comment">/*30*/</span> ; loop ++ )
00257     <span class="keywordflow">if</span>( ( rc = Clnt_call( client, NFSPROC4_COMPOUND, 
00258                           (Xdrproc_t)Xdr_COMPOUND4args, (caddr_t)&amp;compound4_args, 
00259                           (Xdrproc_t)Xdr_COMPOUND4res, (caddr_t)&amp;compound4_res, 
00260                           intervalle ) ) != RPC_SUCCESS )
00261       {
00262         <a class="code" href="Pmap__clnt_8c.html#a2">Clnt_perror</a>( client, <span class="stringliteral">"appel a  NFSPROC4_COMPOUND\n"</span> ) ;
00263         exit ( 1 ) ;
00264       }
00265     <span class="keywordflow">else</span> printf( <span class="stringliteral">"Call %d is ok\n"</span>, loop ) ;
00266   
00267   printf( <span class="stringliteral">"Now destroying AUTH\n"</span> ) ;
00268   
00269   Clnt_destroy( client ) ;
00270 
00271   printf( <span class="stringliteral">"Regular exit\n"</span> ) ;
00272 }
00273 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Dec 22 14:15:35 2006 for RPCSEC_GSS Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
