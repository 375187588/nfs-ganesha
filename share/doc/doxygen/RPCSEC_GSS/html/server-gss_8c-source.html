<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RPCSEC_GSS Library: server-gss.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>server-gss.c</h1><a href="server-gss_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/* </span>
00002 <span class="comment"> *</span>
00003 <span class="comment"> * Les sources du serveur toto, mais avec de vrais morceaux de GSSAPI dedans</span>
00004 <span class="comment"> */</span>
00005 
<a name="l00006"></a><a class="code" href="server-gss_8c.html#a23">00006</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a12">rcsid</a>[] = <span class="stringliteral">"$Id: server-gss.c,v 1.1 2005/04/13 13:45:49 deniel Exp $"</span> ;
00007 
00008 <span class="comment">/* Un tas d'include pour avoir les bindings standards */</span>
00009 <span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00010 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00011 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00012 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00013 <span class="preprocessor">#include &lt;string.h&gt;</span>
00014 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00015 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00016 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00017 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00018 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00019 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00020 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
00021 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00022 <span class="preprocessor">#include &lt;netinet/tcp.h&gt;</span>
00023 
00024 <span class="preprocessor">#include &lt;gssapi/gssapi.h&gt;</span>  <span class="comment">/* Header de la gssapi */</span>
00025 <span class="preprocessor">#include &lt;gssapi/gssapi_generic.h&gt;</span>
00026 
00027 <span class="comment">/* Mes manies avec les ecritures d'adresse */</span>
<a name="l00028"></a><a class="code" href="server-gss_8c.html#a0">00028</a> <span class="preprocessor">#define TraduireAdresse( adresse, dest )                   \</span>
00029 <span class="preprocessor">           sprintf( dest, "%d.%d.%d.%d",                   \</span>
00030 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0xFF000000 ) &gt;&gt; 24, \</span>
00031 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x00FF0000 ) &gt;&gt; 16, \</span>
00032 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x0000FF00 ) &gt;&gt; 8,  \</span>
00033 <span class="preprocessor">                  ( ntohl( adresse ) &amp; 0x000000FF ) )</span>
00034 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="server-gss_8c.html#a1">00035</a> <span class="preprocessor">#define LOGFILE_DEFAUT     "./toto-server.log"</span>
<a name="l00036"></a><a class="code" href="server-gss_8c.html#a2">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_CONN           32</span>
<a name="l00037"></a><a class="code" href="server-gss_8c.html#a3">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define LENMSG             256</span>
<a name="l00038"></a><a class="code" href="server-gss_8c.html#a4">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define STRLEN             256</span>
<a name="l00039"></a><a class="code" href="server-gss_8c.html#a5">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define GSS_SERVICE_DEFAUT "toto" </span>
00040 <span class="preprocessor"></span>
00041 <span class="preprocessor">#define TOKEN_NOOP              (1&lt;&lt;0)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_CONTEXT           (1&lt;&lt;1)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_DATA              (1&lt;&lt;2)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_MIC               (1&lt;&lt;3)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_CONTEXT_NEXT      (1&lt;&lt;4)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_WRAPPED           (1&lt;&lt;5)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_ENCRYPTED         (1&lt;&lt;6)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_SEND_MIC          (1&lt;&lt;7)</span>
<a name="l00049"></a><a class="code" href="server-gss_8c.html#a14">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_NOOP              (1&lt;&lt;0)</span>
<a name="l00050"></a><a class="code" href="server-gss_8c.html#a15">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_CONTEXT           (1&lt;&lt;1)</span>
<a name="l00051"></a><a class="code" href="server-gss_8c.html#a16">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_DATA              (1&lt;&lt;2)</span>
<a name="l00052"></a><a class="code" href="server-gss_8c.html#a17">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_MIC               (1&lt;&lt;3)</span>
<a name="l00053"></a><a class="code" href="server-gss_8c.html#a18">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_CONTEXT_NEXT      (1&lt;&lt;4)</span>
<a name="l00054"></a><a class="code" href="server-gss_8c.html#a19">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_WRAPPED           (1&lt;&lt;5)</span>
<a name="l00055"></a><a class="code" href="server-gss_8c.html#a20">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_ENCRYPTED         (1&lt;&lt;6)</span>
<a name="l00056"></a><a class="code" href="server-gss_8c.html#a21">00056</a> <span class="preprocessor"></span><span class="preprocessor">#define TOKEN_SEND_MIC          (1&lt;&lt;7)</span>
00057 <span class="preprocessor"></span>
<a name="l00058"></a><a class="code" href="server-gss_8c.html#a22">00058</a> <span class="preprocessor">#define KEYTAB "/var/hpss/etc/hpss.keytab"</span>
00059 <span class="preprocessor"></span>
00060 <span class="keywordtype">int</span> <a class="code" href="tools-gss_8h.html#a21">recv_token</a>( <span class="keywordtype">int</span> s, <span class="keywordtype">int</span> * flags, gss_buffer_t tok) ;
00061 <span class="keywordtype">int</span> <a class="code" href="tools-gss_8c.html#a26">send_token</a>(<span class="keywordtype">int</span> s, <span class="keywordtype">int</span> flags, gss_buffer_t tok) ;
00062 
00063 <span class="keywordtype">void</span> <a class="code" href="tools-gss_8h.html#a16">sperror_gss</a>( <span class="keywordtype">char</span> * str, OM_uint32 major, OM_uint32 minor ) ;
00064 
00065 <span class="comment">/* les options pour getopt */</span>
<a name="l00066"></a><a class="code" href="server-gss_8c.html#a24">00066</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a14">options</a>[] = <span class="stringliteral">"hL:N:P:S:"</span> ;
00067 
00068 <span class="comment">/* L'aide en ligne */</span>
<a name="l00069"></a><a class="code" href="server-gss_8c.html#a25">00069</a> <span class="keywordtype">char</span> <a class="code" href="client-gss_8c.html#a15">utilisation</a>[] = 
00070 <span class="stringliteral">"Utilisation: %s [-hLPM] \n"</span>
00071 <span class="stringliteral">"\t[-h]                   affiche cet aide en ligne\n"</span>
00072 <span class="stringliteral">"\t[-L &lt;logfile&gt;]         indique le fichier de log\n"</span>
00073 <span class="stringliteral">"\t[-N &lt;NivDebug&gt;]        indique le niveau de debug pour les journaux\n"</span> 
00074 <span class="stringliteral">"\t[-P &lt;port ou service&gt;] indique le port ou le service a utiliser\n"</span>
00075 <span class="stringliteral">"\t[-S &lt;service Auth&gt;]    le service utilise par ls GSS-API\n"</span> ;
00076 
00077 <span class="comment">/* Des variables globales (en general ecrites une seule fois, relues plusieurs) */</span>
00078 <span class="keyword">static</span> <span class="keywordtype">char</span> logfile_name[MAXPATHLEN] ;    <span class="comment">/* Le chemin du fichier de log           */</span>
<a name="l00079"></a><a class="code" href="server-gss_8c.html#a27">00079</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="server-gss_8c.html#a27">binding_port</a> = 0 ;
<a name="l00080"></a><a class="code" href="server-gss_8c.html#a28">00080</a> <span class="keywordtype">char</span>        <a class="code" href="server-gss_8c.html#a28">gss_service</a>[STRLEN] ;
<a name="l00081"></a><a class="code" href="server-gss_8c.html#a29">00081</a> gss_cred_id_t creds;
00082 
00083 <span class="comment">/*</span>
00084 <span class="comment"> * La routine de negociation avec le client sous GSSAPI </span>
00085 <span class="comment"> */</span>
00086 
<a name="l00087"></a><a class="code" href="server-gss_8c.html#a33">00087</a> <span class="keywordtype">int</span> <a class="code" href="server-gss_8c.html#a33">obtention_creds</a>( <span class="keywordtype">char</span> * service_name, gss_cred_id_t * pcreds )
00088 {
00089      gss_buffer_desc name_buf;
00090      gss_name_t server_name;
00091      OM_uint32 maj_stat, min_stat;
00092      
00093      <span class="comment">/* Je prepare un buffer avec le nom du service a chercher */</span>
00094      name_buf.value = service_name;
00095      name_buf.length = strlen(name_buf.value) + 1; <span class="comment">/* ATtention au +1 */</span>
00096 
00097      
00098      <span class="keywordflow">if</span>( ( maj_stat = gss_import_name( &amp;min_stat, &amp;name_buf, 
00099                                        (gss_OID)GSS_C_NULL_OID, &amp;server_name ) ) != GSS_S_COMPLETE )
00100        {
00101          <span class="keywordtype">char</span> msg[256] ;
00102          
00103          <a class="code" href="tools-gss_8h.html#a16">sperror_gss</a>( msg, maj_stat, min_stat ) ;
00104          printf( <span class="stringliteral">"Importation par la GSS-API du nom %s impossible: %d|%d = %s\n"</span>, 
00105                                 service_name, maj_stat, min_stat, msg ) ;
00106          exit( 1 ) ;
00107        }
00108      <span class="keywordflow">else</span>
00109        printf( <span class="stringliteral">"Nom de service '%s' correctement importe\n"</span>, service_name ) ;
00110 
00111 <span class="preprocessor">#ifdef _WITH_DCE</span>
00112 <span class="preprocessor"></span>     <span class="comment">/* Specific DCE: dire ou trouver le keytab */</span>
00113      <span class="keywordflow">if</span>( ( maj_stat = gssdce_register_acceptor_identity( &amp;min_stat, server_name, NULL, <a class="code" href="server-gss_8c.html#a22">KEYTAB</a> ) ) != GSS_S_COMPLETE )
00114        {
00115          <span class="keywordtype">char</span> msg[256] ;
00116          
00117          <a class="code" href="tools-gss_8h.html#a16">sperror_gss</a>( msg, maj_stat, min_stat ) ;
00118          printf( <span class="stringliteral">"Erreur dans gssdce_register_acceptor_identity pour nom %s: %d|%d = %s\n"</span>, 
00119                                  service_name, maj_stat, min_stat, msg ) ;
00120 
00121          exit( 1 ) ;
00122        }
00123 <span class="preprocessor">#endif</span>
00124 <span class="preprocessor"></span>     <span class="comment">/* Obtention des creds avec ce nom gssapi-ifie */</span>
00125      <span class="keywordflow">if</span>( ( maj_stat = gss_acquire_cred( &amp;min_stat, 
00126                                         server_name,
00127                                         0, 
00128                                         GSS_C_NULL_OID_SET, 
00129                                         GSS_C_ACCEPT,
00130                                         pcreds, 
00131                                         NULL, 
00132                                         NULL ) ) != GSS_S_COMPLETE )
00133        {
00134          <span class="keywordtype">char</span> msg[256] ;
00135 
00136          <a class="code" href="tools-gss_8h.html#a16">sperror_gss</a>( msg, maj_stat, min_stat ) ;
00137          printf( <span class="stringliteral">"Obtentiond des creds pour le nom %s impossible: %d|%d = %s\n"</span>, 
00138                                 service_name, maj_stat, min_stat, msg ) ;
00139          exit( 1 ) ;
00140        }
00141      <span class="keywordflow">else</span>
00142        printf( <span class="stringliteral">"Obtention des creds Ok pour le service %s\n"</span>, service_name ) ;
00143      
00144        
00145      <span class="keywordflow">return</span> 0;
00146 } <span class="comment">/* obtention_creds */</span>
00147 
00148 
<a name="l00149"></a><a class="code" href="server-gss_8c.html#a34">00149</a> <span class="keywordtype">int</span> <a class="code" href="server-gss_8c.html#a34">negociation_server</a>( <span class="keywordtype">int</span> sockfd )
00150 {
00151   <span class="comment">/*   gss_ctx_id_t    *cont = GSS_C_NO_CONTEXT ; */</span>
00152   gss_ctx_id_t    mon_contexte = GSS_C_NO_CONTEXT ;
00153   gss_buffer_desc client_name ;
00154   gss_buffer_desc send_tok ;
00155   gss_buffer_desc recv_tok ;
00156   gss_name_t      tname ;
00157   gss_name_t      client ;
00158   gss_OID         doid ;
00159   gss_buffer_desc oid_name ;
00160   <span class="keywordtype">int</span>             token_flags;
00161   OM_uint32       maj_stat, min_stat ;
00162   OM_uint32       acc_sec_min_stat ;
00163   OM_uint32       ret_flags ;
00164 
00165   gss_ctx_id_t    toto = 0 ;
00166   
00167   printf( <span class="stringliteral">"Starting negociation\n"</span> ) ;
00168   
00169   <span class="comment">/* 0 - Un token recu  pour commencer */</span>
00170   <span class="keywordflow">if</span>( <a class="code" href="tools-gss_8h.html#a21">recv_token</a>( sockfd, &amp;token_flags, &amp;recv_tok ) &lt; 0 )
00171     <span class="keywordflow">return</span> -1 ;
00172 
00173   <span class="comment">/* On relache le token, seuls les flags m'interessent */</span>
00174   (void) gss_release_buffer(&amp;min_stat, &amp;recv_tok); 
00175 
00176   <span class="comment">/* Je regarde les flags */</span>
00177   <span class="keywordflow">if</span>(!(token_flags &amp; TOKEN_NOOP)) 
00178     {
00179       printf( <span class="stringliteral">"Bad token\n"</span> ) ;
00180       <span class="keywordflow">return</span> -1;
00181     }
00182   
00183   <span class="comment">/* Je prepare le contexte */</span>
00184   toto = GSS_C_NO_CONTEXT ;
00185   mon_contexte = GSS_C_NO_CONTEXT ;
00186  
00187   
00188   <span class="comment">/* Boucle principale d'authentification */</span>
00189   <span class="keywordflow">if</span> (token_flags &amp; TOKEN_CONTEXT_NEXT ) 
00190     {
00191       <span class="keywordflow">do</span>
00192         {
00193           <span class="comment">/* 1- Reception d'un token initial */</span>
00194           <span class="keywordflow">if</span>( <a class="code" href="tools-gss_8h.html#a21">recv_token</a>( sockfd, &amp;token_flags, &amp;recv_tok ) &lt; 0 )
00195             {
00196               printf( <span class="stringliteral">"Bad Token\n"</span> ) ;
00197               <span class="keywordflow">return</span> -1 ;
00198             }
00199           <span class="keywordflow">else</span>
00200             printf( <span class="stringliteral">"Received token size = %d\n"</span>, recv_tok.length ) ;
00201           
00202           <span class="comment">/* 2- on utilise ce token pour accepter un contexte, ce qui cree un token a envoyer */</span>
00203           maj_stat = gss_accept_sec_context( &amp;acc_sec_min_stat, 
00204                                              &amp;mon_contexte,
00205                                              <a class="code" href="server-gss_8c.html#a29">creds</a>, 
00206                                              &amp;recv_tok, 
00207                                              GSS_C_NO_CHANNEL_BINDINGS,
00208                                              &amp;client, 
00209                                              &amp;doid, 
00210                                              &amp;send_tok, 
00211                                              &amp;ret_flags, 
00212                                              NULL,     <span class="comment">/* ignore time_rec */</span>
00213                                              NULL ) ;  <span class="comment">/* ignore del_cred_handle */</span>
00214 
00215           <span class="comment">/* Je relache le recv_token, on n'en a plus besoin */</span>
00216           (void) gss_release_buffer( &amp;min_stat, &amp;recv_tok ) ; 
00217           
00218           <span class="comment">/* 3- Je donne le send_tok cree par l'appel precedent au client */</span>
00219           <span class="keywordflow">if</span>( <a class="code" href="tools-gss_8c.html#a26">send_token</a>( sockfd, <a class="code" href="client-gss_8c.html#a1">TOKEN_CONTEXT</a>, &amp;send_tok ) &lt; 0 )
00220             {
00221               printf( <span class="stringliteral">"Bad negociation, phase 2\n"</span> ) ;
00222               <span class="keywordflow">return</span> -1 ;
00223             }
00224           
00225           <span class="comment">/* Je relache le send_token, j'en aurait besoin pour une eventuelle passe ulterieure */</span>
00226           (void) gss_release_buffer(&amp;min_stat, &amp;send_tok); 
00227 
00228           <span class="comment">/* Maintenant je regarde s'il faut faire un nouveau tour de table a la negociation */</span>
00229           <span class="keywordflow">if</span>( maj_stat != GSS_S_COMPLETE &amp;&amp; maj_stat != GSS_S_CONTINUE_NEEDED  )
00230             {
00231               <span class="comment">/* Une erreur de negociation s'est produite */</span>
00232               <span class="keywordtype">char</span> msg[STRLEN] ;
00233               
00234               <a class="code" href="tools-gss_8h.html#a16">sperror_gss</a>( msg, maj_stat, acc_sec_min_stat ) ;
00235               printf( <span class="stringliteral">"Negociation impossible: %d|%d = %s\n"</span>, maj_stat, acc_sec_min_stat, msg ) ;
00236 
00237               <span class="comment">/* Je n'ai pas de contexte, faire le nettoyage qui s'impose */</span>
00238               <span class="keywordflow">if</span>( mon_contexte == GSS_C_NO_CONTEXT )
00239                 gss_delete_sec_context( &amp;min_stat, &amp;mon_contexte, GSS_C_NO_BUFFER ) ;
00240               
00241               <span class="keywordflow">return</span> -1 ;
00242             }
00243           <span class="keywordflow">else</span> <span class="keywordflow">if</span>( maj_stat == GSS_S_CONTINUE_NEEDED )
00244             {
00245               printf( <span class="stringliteral">"Negociation: A new pass is necessary...\n"</span> ) ;
00246             } 
00247             
00248         } <span class="keywordflow">while</span>( maj_stat == GSS_S_CONTINUE_NEEDED ) ;
00249       
00250       <span class="keywordflow">if</span>( ( maj_stat = gss_display_name( &amp;min_stat, client, &amp;client_name, &amp;doid ) ) != GSS_S_COMPLETE )
00251         {
00252           <span class="keywordtype">char</span> msg[STRLEN] ;
00253           
00254           <a class="code" href="tools-gss_8h.html#a16">sperror_gss</a>( msg, maj_stat, min_stat ) ;
00255           printf( <span class="stringliteral">"Bad negociation: untranslatable client name: %d|%d = %s\n"</span>, maj_stat, min_stat, msg ) ;
00256           (void)gss_release_name(&amp;min_stat, &amp;client);
00257           <span class="keywordflow">return</span> -1 ;
00258         }
00259 
00260       <span class="comment">/* Devine qui viens diner ..... */</span>
00261       printf( <span class="stringliteral">"Negociation Ok for client %s\n"</span>, client_name.value ) ;
00262       
00263       
00264     }
00265   
00266   <span class="keywordflow">return</span> 0 ;
00267 } <span class="comment">/* negociation */</span>
00268 
00269 
00270 <span class="comment">/* Le main */</span>
<a name="l00271"></a><a class="code" href="server-gss_8c.html#a35">00271</a> <span class="keywordtype">int</span> <a class="code" href="server-gss_8c.html#a35">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[] )
00272 {
00273   <span class="keywordtype">char</span>               nom_exec[MAXPATHLEN] ;
00274   <span class="keywordtype">char</span> *             tempo_nom_exec  = NULL ;
00275   <span class="keyword">static</span> <span class="keywordtype">char</span>        machine_locale[256] ;    <span class="comment">/* Le nom de la machine locale */</span>
00276   <span class="keywordtype">int</span>                c ;                     <span class="comment">/* pour getopt                  */</span>
00277   <span class="keyword">struct </span>servent *   service = NULL ;        <span class="comment">/* pour getservbyname           */</span>
00278   <span class="keyword">struct </span>sockaddr_in adresse ;
00279   <span class="keyword">struct </span>sockaddr_in adresse_client ;
00280   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>      longueur ;
00281   <span class="keywordtype">int</span>                socket_service ;
00282   <span class="keywordtype">int</span>                socket_ecoute ;
00283   <span class="keywordtype">int</span>                one = 1 ;
00284   <span class="keywordtype">char</span>               straddr[100] ;
00285   <span class="keywordtype">char</span>               msg[LENMSG] ;
00286   <span class="keywordtype">char</span>               msg_retour[LENMSG] ;
00287   <span class="keywordtype">int</span>                rc = 0 ;
00288   
00289   <span class="comment">/* Initialisation des valeurs par defaut */</span>
00290   strcpy( logfile_name, <a class="code" href="onc__rpc__server_8c.html#a0">LOGFILE_DEFAUT</a> ) ;
00291   strcpy( <a class="code" href="server-gss_8c.html#a28">gss_service</a>,  <a class="code" href="server-gss_8c.html#a5">GSS_SERVICE_DEFAUT</a> ) ;
00292 
00293   <span class="comment">/* On recupere le nom de l'executable */</span>
00294   <span class="keywordflow">if</span>( ( tempo_nom_exec = strrchr( argv[0], <span class="charliteral">'/'</span> ) ) != NULL )
00295     strcpy( (<span class="keywordtype">char</span> *)nom_exec, tempo_nom_exec + 1 ) ;
00296   
00297   <span class="keywordflow">while</span>( ( c = getopt( argc, argv, <a class="code" href="client-gss_8c.html#a14">options</a> ) ) != EOF )
00298     {
00299       <span class="keywordflow">switch</span>( c ) 
00300         {
00301         <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:
00302           <span class="comment">/* Je m'enregistre sur un port fixe (pour eviter le portmapper) */</span>
00303           <span class="comment">/* Le numero de port peut etre un numero de port ou un service  */</span>
00304           <span class="comment">/* On a une valeur au format NET                                */</span>
00305           <span class="keywordflow">if</span>( isalpha( *optarg ) )
00306             {
00307               <span class="comment">/* C'est un service car ca commence par une lettre */</span>
00308               <span class="keywordflow">if</span>( ( service = getservbyname( optarg, <span class="stringliteral">"tcp"</span> ) ) == NULL )
00309                 {
00310                   <span class="comment">/* Ca marche pas en tcp, j'essaye en udp */</span>
00311                   <span class="keywordflow">if</span>( ( service = getservbyname( optarg, <span class="stringliteral">"udp"</span> ) ) == NULL )
00312                     {
00313                       printf( <span class="stringliteral">"getservbyname error %d = %s\n"</span>, errno, strerror( errno ) ) ;
00314                     }
00315                   <span class="keywordflow">else</span>
00316                     {
00317                       <a class="code" href="server-gss_8c.html#a27">binding_port</a> = service-&gt;s_port ;
00318                     }
00319                 }
00320               <span class="keywordflow">else</span>
00321                 {
00322                   <a class="code" href="server-gss_8c.html#a27">binding_port</a> = service-&gt;s_port ;
00323                 }
00324             }
00325           <span class="keywordflow">else</span>
00326             {
00327               <span class="comment">/* C'est un numero de port */</span>
00328               <a class="code" href="server-gss_8c.html#a27">binding_port</a> = htons( (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)atoi( optarg ) ) ;
00329             }
00330           break ;
00331 
00332         <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00333           <span class="comment">/* Le nom de service */</span>
00334           strcpy( <a class="code" href="server-gss_8c.html#a28">gss_service</a>, optarg ) ;
00335           break ;
00336   
00337         <span class="keywordflow">case</span> <span class="charliteral">'N'</span>:
00338            fprintf( stderr, <span class="stringliteral">"Option -N not implemented\n"</span> ) ;
00339            break ;
00340 
00341         <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
00342            printf( stderr, <span class="stringliteral">"Option -L not implemented\n"</span> ) ;
00343            break ;        
00344         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00345         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00346         <span class="keywordflow">default</span>:
00347           <span class="comment">/* Affichage de l'aide en ligne */</span>
00348           fprintf( stderr, <a class="code" href="client-gss_8c.html#a15">utilisation</a>, nom_exec ) ;
00349           exit( 0 ) ;
00350           break ;
00351         } <span class="comment">/* switch( c ) */</span>
00352     } <span class="comment">/* while( getopt( ... ) ) */</span>
00353   
00354   <span class="keywordflow">if</span>( argc != optind )
00355     {
00356       fprintf( stderr, <a class="code" href="client-gss_8c.html#a15">utilisation</a>, nom_exec ) ;
00357       fprintf( stderr, <span class="stringliteral">"No additional arguments\n"</span> ) ;
00358       exit( 1 ) ;
00359     }
00360       
00361   <span class="comment">/* Initialisation des lgs sherpa */</span>
00362 
00363   <span class="comment">/* Obtention du nom de la machine */</span>
00364   <span class="keywordflow">if</span>( gethostname( machine_locale, <span class="keyword">sizeof</span>( machine_locale ) ) != 0 )
00365     {
00366       printf( <span class="stringliteral">"gethostname error: errno=%d h_errno=%d\n"</span>, errno, h_errno ) ;
00367       exit( 1 ) ;
00368     }
00369 
00370   <span class="comment">/* Petit coucou initial */</span>
00371   printf( <span class="stringliteral">"Stating Server\n"</span> );
00372   printf( <span class="stringliteral">"hostname is %s\n"</span>, machine_locale ) ;
00373   printf( <span class="stringliteral">"Service GSSAPI = %s\n"</span>, <a class="code" href="server-gss_8c.html#a28">gss_service</a> ) ;
00374   
00375   <span class="comment">/* Creation de la socket d'ecoute */</span>
00376   <span class="keywordflow">if</span>( ( socket_ecoute = socket( AF_INET, SOCK_STREAM, 0 ) ) == -1 )
00377     {
00378       printf( <span class="stringliteral">"Error while allocating the socket: %d = %s\n"</span>, errno, strerror( errno ) ) ;
00379       exit( 1 ) ;
00380     }
00381   
00382   <span class="comment">/* Quelques options bien utiles sur la socket */</span>
00383   <span class="keywordflow">if</span>( setsockopt( socket_ecoute,  SOL_SOCKET, SO_REUSEADDR, (<span class="keywordtype">char</span> *)&amp;one, <span class="keyword">sizeof</span>( one ) ) &lt; 0 )
00384     {
00385       printf( <span class="stringliteral">"Setsockopt error: errno = %d =&gt; %s\n"</span>, errno, strerror( errno ) ) ;
00386       exit( 1 ) ;
00387     }
00388   
00389   
00390   <span class="comment">/* Attachement sur le port dedie a ce service */</span>
00391   adresse.sin_family = AF_INET ;
00392   adresse.sin_port = binding_port  ;
00393   adresse.sin_addr.s_addr = INADDR_ANY  ; <span class="comment">/* pas de discrimination de provenance a ce niveau */</span>
00394 
00395   <span class="keywordflow">if</span>( bind( socket_ecoute, (<span class="keyword">struct</span> sockaddr *)&amp;adresse, <span class="keyword">sizeof</span>( adresse ) ) == -1 )
00396     {
00397       printf( <span class="stringliteral">"Bind error: errno = %d =&gt; %s\n"</span>, errno, strerror( errno ) ) ;
00398       exit( 1 ) ;
00399     }
00400   
00401    <span class="comment">/* Ecoute en attente de connexions */</span>
00402       
00403   <span class="keywordflow">if</span>( listen( socket_ecoute, <a class="code" href="server-gss_8c.html#a2">MAX_CONN</a> ) == -1 )
00404     {
00405       printf( <span class="stringliteral">"Listen error: errno = %d =&gt; %s\n"</span>, errno, strerror( errno ) ) ;
00406       exit( 1 ) ;
00407     }
00408 
00409   <span class="comment">/* Obtention des creds pour la GSSAPI */</span>
00410   <a class="code" href="server-gss_8c.html#a33">obtention_creds</a>( <a class="code" href="server-gss_8c.html#a28">gss_service</a>, &amp;<a class="code" href="server-gss_8c.html#a29">creds</a> ) ;
00411 
00412  
00413 
00414   <span class="comment">/* Boucle principale de l'accept */</span>
00415   printf( <span class="stringliteral">"Waiting to incoming request\n"</span> ) ;
00416   printf( <span class="stringliteral">"------------------------\n"</span> ) ;
00417   
00418   <span class="keywordflow">do</span>
00419     {
00420       longueur = <span class="keyword">sizeof</span>( adresse ) ;
00421       socket_service = accept( socket_ecoute, (<span class="keyword">struct</span> sockaddr *)&amp;adresse_client, &amp;longueur ) ;
00422       
00423       <span class="keywordflow">if</span>( socket_service == -1 &amp;&amp; errno == EINTR )
00424         continue ; <span class="comment">/* C'est pas une erreur trop grave, accept a ete interrompu par un signal */</span>
00425       <span class="keywordflow">else</span>
00426         <span class="keywordflow">if</span>( socket_service == -1 ) <span class="comment">/* Une erreur plus grave =&gt; on degage */</span>
00427           {
00428             printf( <span class="stringliteral">"Accept error: errno = %d =&gt; %s\n"</span>, errno, strerror( errno ) ) ;
00429             exit( 1 ) ;
00430           }
00431 
00432       <span class="comment">/* A ce stade, on a une socket de service valide */</span>
00433       <a class="code" href="client-gss_8c.html#a10">TraduireAdresse</a>( adresse_client.sin_addr.s_addr , straddr ) ;
00434       printf( <span class="stringliteral">"New connection, source = %s:%d\n"</span>, straddr, ntohs( adresse_client.sin_port ) ) ;
00435       
00436        <span class="comment">/* On negocie le contexte de securite avec le client a present */</span>
00437       <span class="keywordflow">if</span>( <a class="code" href="server-gss_8c.html#a34">negociation_server</a>( socket_service ) &lt; 0 )
00438         continue ;
00439       
00440   
00441       <span class="comment">/* Reception du message */</span>
00442       <span class="keywordflow">if</span>( ( rc = read( socket_service, msg, <a class="code" href="client-gss_8c.html#a9">LENMSG</a> ) ) != LENMSG )
00443         {
00444           fprintf( stderr, <span class="stringliteral">"read error %d = %s, %d bytes received instead of %d\n"</span>,
00445                    errno, strerror( errno ), rc, <a class="code" href="client-gss_8c.html#a9">LENMSG</a> ) ;
00446           exit( 1 ) ;
00447         }
00448       printf( <span class="stringliteral">"Received message : #%s#\n"</span> , msg ) ;
00449       
00450       <span class="comment">/* Je fais un message de retour */</span>
00451       sprintf( msg_retour, <span class="stringliteral">"---&gt;%s&lt;---\n"</span> ,  msg ) ;
00452       printf( <span class="stringliteral">"Sending message : #%s#\n"</span>, msg_retour ) ;
00453       
00454       <span class="keywordflow">if</span>( ( rc = write( socket_service, msg_retour, <a class="code" href="client-gss_8c.html#a9">LENMSG</a> ) ) != LENMSG )
00455         {
00456           fprintf( stderr, <span class="stringliteral">"write error %d = %s, %d bytes written instead of %d\n"</span>, 
00457                    errno, strerror( errno ), rc, <a class="code" href="client-gss_8c.html#a9">LENMSG</a> ) ;
00458           exit( 1 ) ;
00459         }
00460       
00461       <span class="comment">/* Fermeture de la socket qui vient de servir */</span>
00462       close( socket_service ) ;
00463       
00464     } <span class="keywordflow">while</span>( 1 ) ;
00465   
00466 }
00467 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Dec 22 14:15:35 2006 for RPCSEC_GSS Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
