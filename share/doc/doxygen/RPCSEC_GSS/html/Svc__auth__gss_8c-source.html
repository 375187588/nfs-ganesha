<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RPCSEC_GSS Library: Svc_auth_gss.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>Svc_auth_gss.c</h1><a href="Svc__auth__gss_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  Svc_auth_gss.c</span>
00003 <span class="comment">  </span>
00004 <span class="comment">  Copyright (c) 2000 The Regents of the University of Michigan.</span>
00005 <span class="comment">  All rights reserved.</span>
00006 <span class="comment"></span>
00007 <span class="comment">  Copyright (c) 2000 Dug Song &lt;dugsong@UMICH.EDU&gt;.</span>
00008 <span class="comment">  All rights reserved, all wrongs reversed.</span>
00009 <span class="comment"></span>
00010 <span class="comment">  Redistribution and use in source and binary forms, with or without</span>
00011 <span class="comment">  modification, are permitted provided that the following conditions</span>
00012 <span class="comment">  are met:</span>
00013 <span class="comment"></span>
00014 <span class="comment">  1. Redistributions of source code must retain the above copyright</span>
00015 <span class="comment">     notice, this list of conditions and the following disclaimer.</span>
00016 <span class="comment">  2. Redistributions in binary form must reproduce the above copyright</span>
00017 <span class="comment">     notice, this list of conditions and the following disclaimer in the</span>
00018 <span class="comment">     documentation and/or other materials provided with the distribution.</span>
00019 <span class="comment">  3. Neither the name of the University nor the names of its</span>
00020 <span class="comment">     contributors may be used to endorse or promote products derived</span>
00021 <span class="comment">     from this software without specific prior written permission.</span>
00022 <span class="comment"></span>
00023 <span class="comment">  THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
00024 <span class="comment">  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00025 <span class="comment">  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
00026 <span class="comment">  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
00027 <span class="comment">  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
00028 <span class="comment">  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
00029 <span class="comment">  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
00030 <span class="comment">  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
00031 <span class="comment">  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
00032 <span class="comment">  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
00033 <span class="comment">  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00034 <span class="comment"></span>
00035 <span class="comment">  $Id: Svc_auth_gss.c,v 1.4 2005/10/05 14:03:31 deniel Exp $</span>
00036 <span class="comment"> */</span>
00037 
00038 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00039 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00040 <span class="preprocessor">#include &lt;string.h&gt;</span>
00041 <span class="preprocessor">#include "Rpc.h"</span>
00042 <span class="preprocessor">#ifdef HAVE_KRB5</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;gssapi/gssapi.h&gt;</span>
00044 <span class="preprocessor">#include &lt;gssapi/gssapi_generic.h&gt;</span>
00045 <span class="preprocessor">#define GSS_C_NT_HOSTBASED_SERVICE gss_nt_service_name </span>
00046 <span class="preprocessor"></span><span class="preprocessor">#elif HAVE_HEIMDAL</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#include &lt;gssapi.h&gt;</span>
00048 <span class="preprocessor">#define gss_nt_service_name GSS_C_NT_HOSTBASED_SERVICE</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00050 <span class="preprocessor"></span>
00051 
00052 <span class="preprocessor">#ifndef OID_EQ</span>
<a name="l00053"></a><a class="code" href="Svc__auth__gss_8c.html#a0">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define g_OID_equal(o1,o2) \</span>
00054 <span class="preprocessor">   (((o1)-&gt;length == (o2)-&gt;length) &amp;&amp; \</span>
00055 <span class="preprocessor">    ((o1)-&gt;elements != 0) &amp;&amp; ((o2)-&gt;elements != 0) &amp;&amp; \</span>
00056 <span class="preprocessor">    (memcmp((o1)-&gt;elements,(o2)-&gt;elements,(int) (o1)-&gt;length) == 0))</span>
<a name="l00057"></a><a class="code" href="Svc__auth__gss_8c.html#a1">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define OID_EQ 1</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* OID_EQ */</span>
00059 
00060 <span class="preprocessor">#ifdef HAVE_KRB5</span>
00061 <span class="preprocessor"></span><span class="keyword">extern</span> SVCAUTH Svc_auth_none;
00062 <span class="keyword">extern</span> <span class="keyword">struct </span>SVCAUTH ** TabAuthData;
00063 
00064 
00065 <span class="comment">/*</span>
00066 <span class="comment"> * from mit-krb5-1.2.1 mechglue/mglueP.h:</span>
00067 <span class="comment"> * Array of context IDs typed by mechanism OID</span>
00068 <span class="comment"> */</span>
00069 <span class="keyword">typedef</span> <span class="keyword">struct </span>Gss_union_ctx_id_t {
00070   gss_OID                  mech_type;
00071   gss_ctx_id_t             internal_ctx_id;
00072 } gss_union_ctx_id_desc, * gss_union_ctx_id_t;
00073 
00074 
00075 
00076 <span class="keyword">static</span> bool_t     Svcauth_gss_destroy();
00077 <span class="keyword">static</span> bool_t   Svcauth_gss_wrap();
00078 <span class="keyword">static</span> bool_t   Svcauth_gss_unwrap();
00079 
00080 <span class="keyword">struct </span>Svc_auth_ops Svc_auth_gss_ops = {
00081         Svcauth_gss_wrap,
00082         Svcauth_gss_unwrap,
00083         Svcauth_gss_destroy
00084 };
00085 
00086 <span class="keyword">struct </span><a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> {
00087         bool_t                          established;    <span class="comment">/* context established  */</span>
00088         gss_ctx_id_t                ctx;                      <span class="comment">/* context id           */</span>
00089         <span class="keyword">struct </span>Rpc_gss_sec      sec;                  <span class="comment">/* security triple      */</span>
00090         gss_buffer_desc           cname;                    <span class="comment">/* GSS client name      */</span>
00091         u_int                             seq;                <span class="comment">/* sequence number      */</span>
00092         u_int                             win;                <span class="comment">/* sequence window      */</span>
00093         u_int                             seqlast;      <span class="comment">/* last sequence number */</span>
00094         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>          seqmask;      <span class="comment">/* bitmask of seqnums   */</span>
00095         gss_name_t                    client_name;      <span class="comment">/* unparsed name string */</span>
00096 };
00097 
00098 <span class="preprocessor">#ifdef DEBUG</span>
00099 <span class="preprocessor"></span>
00100 <span class="keywordtype">void</span> svc_log_status( <span class="keywordtype">char</span> *m, OM_uint32 maj_stat, OM_uint32 min_stat)
00101 {
00102         OM_uint32 min;
00103         gss_buffer_desc msg;
00104         <span class="keywordtype">int</span> msg_ctx = 0;
00105         FILE * tmplog ;
00106 
00107         <span class="keywordflow">if</span>( ( tmplog = fopen( RPCSEC_GSS_LOG, <span class="stringliteral">"a"</span> ) ) != NULL )
00108         {
00109         fprintf(tmplog, <span class="stringliteral">"Rpcsec_gss: %s: "</span>, m);
00110 
00111         gss_display_status(&amp;min, maj_stat, GSS_C_GSS_CODE, GSS_C_NULL_OID,
00112                            &amp;msg_ctx, &amp;msg);
00113         fprintf(tmplog, <span class="stringliteral">"%s - "</span>, (<span class="keywordtype">char</span> *)msg.value);
00114 
00115         gss_display_status(&amp;min, min_stat, GSS_C_MECH_CODE, GSS_C_NULL_OID, &amp;msg_ctx, &amp;msg);
00116         fprintf(tmplog, <span class="stringliteral">"%s\n"</span>, (<span class="keywordtype">char</span> *)msg.value);
00117 
00118         fclose( tmplog ) ;
00119         }
00120 }
00121 <span class="preprocessor">#else</span>
00122 <span class="preprocessor"></span>
00123 <span class="keywordtype">void</span> svc_log_status(<span class="keywordtype">char</span> *m, OM_uint32 maj_stat, OM_uint32 min_stat)
00124 {
00125 }
00126 
00127 <span class="preprocessor">#endif</span>
00128 <span class="preprocessor"></span>
00129 <span class="preprocessor">#define SVCAUTH_PRIVATE(auth) \</span>
00130 <span class="preprocessor">        ((struct Svc_rpc_gss_data *)(auth)-&gt;svc_ah_private)</span>
00131 <span class="preprocessor"></span>
00132 <span class="comment">/* Global server credentials. */</span>
00133 gss_cred_id_t             _svcauth_gss_creds = NULL;
00134 <span class="keyword">static</span> gss_name_t       _svcauth_gss_name = NULL;
00135 
00136 bool_t Svcauth_gss_set_svc_name( gss_name_t name )
00137 {
00138         OM_uint32       maj_stat, min_stat;
00139   gss_name_t tmpname ;
00140   
00141 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00142 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in Svcauth_gss_set_svc_name()\n"</span>);
00143 <span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>
00145         <span class="keywordflow">if</span> (_svcauth_gss_name != NULL) 
00146     {
00147       maj_stat = gss_release_name(&amp;min_stat, &amp;_svcauth_gss_name);
00148       
00149       <span class="keywordflow">if</span> (maj_stat != GSS_S_COMPLETE)
00150         {
00151           <span class="keywordflow">return</span> (FALSE);
00152         }
00153       _svcauth_gss_name = NULL;
00154     }
00155 
00156         maj_stat = gss_duplicate_name(&amp;min_stat, name, &amp;_svcauth_gss_name);
00157         <span class="keywordflow">if</span> (maj_stat != GSS_S_COMPLETE)
00158     {
00159       <span class="keywordflow">return</span> (FALSE);
00160     }
00161         <span class="keywordflow">return</span> (TRUE);
00162 }
00163 
00164 bool_t Svcauth_gss_get_svc_name( gss_name_t * pname )
00165 {
00166         OM_uint32       maj_stat, min_stat;
00167 
00168         <span class="keywordflow">if</span>( _svcauth_gss_name == NULL)
00169                 <span class="keywordflow">return</span> FALSE ;
00170 
00171         <span class="keywordflow">if</span>( ( maj_stat = gss_duplicate_name(&amp;min_stat, _svcauth_gss_name, pname ) ) != GSS_S_COMPLETE )
00172                 <span class="keywordflow">return</span> FALSE ;
00173  
00174         <span class="keywordflow">return</span> TRUE ;
00175 }
00176 
00177 bool_t Svcauth_gss_import_name( <span class="keywordtype">char</span> * service )
00178 {
00179         gss_name_t      name;
00180         gss_buffer_desc namebuf;
00181         OM_uint32       maj_stat, min_stat;
00182 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00183 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in svcauth_gss_import_name() ---&gt; #%s# \n"</span>, service );
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span>
00186         namebuf.value = service;
00187         namebuf.length = strlen(service);
00188 
00189         maj_stat = gss_import_name(&amp;min_stat, &amp;namebuf,
00190                              (gss_OID)GSS_C_NT_HOSTBASED_SERVICE, &amp;name);
00191   
00192         <span class="keywordflow">if</span> (maj_stat != GSS_S_COMPLETE)
00193     {
00194       <span class="keywordflow">return</span> (FALSE);
00195     }
00196 
00197         <span class="keywordflow">if</span> (Svcauth_gss_set_svc_name(name) != TRUE) 
00198     {
00199       gss_release_name(&amp;min_stat, &amp;name);
00200       <span class="keywordflow">return</span> (FALSE);
00201     }
00202 
00203         <span class="keywordflow">return</span> (TRUE);
00204 }
00205 
00206 <span class="keyword">static</span> bool_t Svcauth_gss_acquire_cred( <span class="keywordtype">void</span> )
00207 {
00208         OM_uint32       maj_stat, min_stat;
00209 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00210 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in svcauth_gss_acquire_cred()\n"</span>);
00211 <span class="preprocessor">#endif</span>
00212 <span class="preprocessor"></span>
00213   <span class="keywordflow">if</span>( _svcauth_gss_creds != NULL ) <span class="comment">/* BUGAZOMEU */</span>    {
00214 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00215 <span class="preprocessor"></span>      printf( <span class="stringliteral">"=======&gt; Ok Credentials deja obtenus\n"</span> ) ;
00216 <span class="preprocessor">#endif</span>
00217 <span class="preprocessor"></span>      <span class="keywordflow">return</span> TRUE ;
00218     }
00219   
00220         maj_stat = gss_acquire_cred( &amp;min_stat,
00221                                _svcauth_gss_name, 
00222                                0,
00223                                GSS_C_NULL_OID_SET, 
00224                                GSS_C_ACCEPT,
00225                                &amp;_svcauth_gss_creds, 
00226                                NULL, 
00227                                NULL);
00228         
00229         <span class="keywordflow">if</span> (maj_stat != GSS_S_COMPLETE) 
00230     {
00231       <span class="keywordflow">return</span> (FALSE);
00232     }
00233 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00234 <span class="preprocessor"></span>  printf( <span class="stringliteral">"=======&gt; Ok pour l'acquisition de credentials\n"</span> ) ;
00235 <span class="preprocessor">#endif</span>
00236 <span class="preprocessor"></span>  
00237         <span class="keywordflow">return</span> (TRUE);
00238 }
00239 
00240 <span class="keyword">static</span> bool_t Svcauth_gss_release_cred( <span class="keywordtype">void</span> )
00241 {
00242         OM_uint32       maj_stat, min_stat;
00243 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS        </span>
00244 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in Svcauth_gss_release_cred()\n"</span>);
00245 <span class="preprocessor">#endif</span>
00246 <span class="preprocessor"></span>        
00247         maj_stat = gss_release_cred(&amp;min_stat, &amp;_svcauth_gss_creds);
00248         
00249         <span class="keywordflow">if</span> (maj_stat != GSS_S_COMPLETE) 
00250     {
00251       <span class="keywordflow">return</span> (FALSE);
00252     }
00253         
00254         _svcauth_gss_creds = NULL;
00255         
00256         <span class="keywordflow">return</span> (TRUE);
00257 }
00258 
00259 <span class="keyword">static</span> bool_t Svcauth_gss_accept_sec_context(<span class="keyword">struct</span> Svc_req *rqst,
00260                                              <span class="keyword">struct</span> Rpc_gss_init_res *gr)
00261 {
00262         <span class="keyword">struct </span><a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> * gd;
00263         <span class="keyword">struct </span>Rpc_gss_cred     *     gc;
00264         gss_buffer_desc                 recv_tok, seqbuf, checksum;
00265         gss_OID                               mech;
00266         OM_uint32                             maj_stat = 0, min_stat = 0, ret_flags, seq;
00267 
00268 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00269 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in svcauth_gss_accept_context()\n"</span>);
00270 <span class="preprocessor">#endif</span>
00271 <span class="preprocessor"></span>        
00272         gd = <a class="code" href="rpcsec__gss__server_8c.html#a11">SVCAUTH_PRIVATE</a>(rqst-&gt;rq_xprt-&gt;xp_auth);
00273         gc = (<span class="keyword">struct </span>Rpc_gss_cred *)rqst-&gt;rq_clntcred;
00274         memset(gr, 0, <span class="keyword">sizeof</span>(*gr));
00275 
00276         <span class="comment">/* Deserialize arguments. */</span>
00277         memset(&amp;recv_tok, 0, <span class="keyword">sizeof</span>(recv_tok));
00278         
00279         <span class="keywordflow">if</span> (!Svc_getargs(rqst-&gt;rq_xprt, Xdr_Rpc_gss_init_args,
00280                    (caddr_t)&amp;recv_tok))
00281                 <span class="keywordflow">return</span> (FALSE);
00282 
00283         gr-&gt;gr_major = gss_accept_sec_context(&amp;gr-&gt;gr_minor,
00284                                         &amp;gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a>,
00285                                         _svcauth_gss_creds,
00286                                         &amp;recv_tok,
00287                                         GSS_C_NO_CHANNEL_BINDINGS,
00288                                         &amp;gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o8">client_name</a>,
00289                                         &amp;mech,
00290                                         &amp;gr-&gt;gr_token,
00291                                         &amp;ret_flags,
00292                                         NULL,
00293                                         NULL);
00294 
00295         
00296         <span class="keywordflow">if</span> (gr-&gt;gr_major != GSS_S_COMPLETE &amp;&amp;
00297             gr-&gt;gr_major != GSS_S_CONTINUE_NEEDED) 
00298     {
00299       gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a> = GSS_C_NO_CONTEXT;
00300       gss_release_buffer(&amp;min_stat, &amp;gr-&gt;gr_token);
00301       <span class="keywordflow">return</span> (FALSE);
00302     }
00303         <span class="comment">/* ANDROS: krb5 mechglue returns ctx of size 8 - two pointers, </span>
00304 <span class="comment">         * one to the mechanism oid, one to the internal_ctx_id */</span>
00305         <span class="keywordflow">if</span> ((gr-&gt;gr_ctx.value = mem_alloc(<span class="keyword">sizeof</span>(gss_union_ctx_id_desc))) == NULL) {
00306                 FILE * tmplog ;
00307 
00308                 <span class="keywordflow">if</span>( ( tmplog = fopen( RPCSEC_GSS_LOG, <span class="stringliteral">"a"</span> ) ) != NULL )
00309                 {
00310                 fprintf(tmplog, <span class="stringliteral">"svcauth_gss_accept_context: out of memory\n"</span>);
00311                 fclose( tmplog ) ;
00312                 }
00313                 <span class="keywordflow">return</span> (FALSE);
00314         }
00315         memcpy(gr-&gt;gr_ctx.value, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a>, <span class="keyword">sizeof</span>(gss_union_ctx_id_desc));
00316         gr-&gt;gr_ctx.length = <span class="keyword">sizeof</span>(gss_union_ctx_id_desc);
00317 
00318   <span class="comment">/*ANDROS: change for debugging linux kernel version...</span>
00319 <span class="comment">    gr-&gt;gr_win = sizeof(gd-&gt;seqmask) * 8;</span>
00320 <span class="comment">  */</span>
00321         gr-&gt;gr_win = 0x00000005;
00322         
00323         <span class="comment">/* Save client info. */</span>
00324         gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.mech = mech;
00325         gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.qop = GSS_C_QOP_DEFAULT;
00326         gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.svc = gc-&gt;gc_svc;
00327         gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o4">seq</a> = gc-&gt;gc_seq;
00328         gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o5">win</a> = gr-&gt;gr_win;
00329 
00330         <span class="keywordflow">if</span> (gr-&gt;gr_major == GSS_S_COMPLETE) {
00331 <span class="preprocessor">#ifdef _WITH_SPKM3</span>
00332 <span class="preprocessor"></span>        <span class="comment">/* spkm3: no src_name (anonymous) */</span>
00333                 <span class="keywordflow">if</span> (!<a class="code" href="Svc__auth__gss_8c.html#a0">g_OID_equal</a>(&amp;spkm3oid, mech)) 
00334       {
00335         maj_stat = gss_display_name(&amp;min_stat, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o8">client_name</a>,
00336                                     &amp;gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o3">cname</a>, &amp;gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.mech);
00337       } 
00338 <span class="preprocessor">#endif</span>
00339 <span class="preprocessor"></span>
00340                 <span class="keywordflow">if</span> (maj_stat != GSS_S_COMPLETE)
00341       {
00342         <span class="keywordflow">return</span> (FALSE);
00343                 }
00344 <span class="preprocessor">#ifdef DEBUG</span>
00345 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_KRB5</span>
00346 <span class="preprocessor"></span>                {
00347                         gss_buffer_desc mechname;
00348 
00349                         gss_oid_to_str(&amp;min_stat, mech, &amp;mechname);
00350                         
00351 
00352                         gss_release_buffer(&amp;min_stat, &amp;mechname);
00353                 }
00354 <span class="preprocessor">#elif HAVE_HEIMDAL</span>
00355 <span class="preprocessor"></span>                printf(<span class="stringliteral">"accepted context for %.*s with "</span>
00356            <span class="stringliteral">"&lt;mech {}, qop %d, svc %d&gt;"</span>,
00357            gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o3">cname</a>.length, (<span class="keywordtype">char</span> *)gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o3">cname</a>.value,
00358            gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.qop, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.svc);
00359 <span class="preprocessor">#endif</span>
00360 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>
00361                 seq = htonl(gr-&gt;gr_win);
00362                 seqbuf.value = &amp;seq;
00363                 seqbuf.length = <span class="keyword">sizeof</span>(seq);
00364 
00365                 maj_stat = gss_sign(&amp;min_stat, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a>, GSS_C_QOP_DEFAULT,
00366                                     &amp;seqbuf, &amp;checksum);
00367 
00368                 <span class="keywordflow">if</span> (maj_stat != GSS_S_COMPLETE)
00369                         <span class="keywordflow">return</span> (FALSE);
00370                 
00371                 rqst-&gt;rq_xprt-&gt;xp_verf.oa_flavor = RPCSEC_GSS;
00372                 rqst-&gt;rq_xprt-&gt;xp_verf.oa_base = checksum.value;
00373                 rqst-&gt;rq_xprt-&gt;xp_verf.oa_length = checksum.length;
00374         }
00375         <span class="keywordflow">return</span> (TRUE);
00376 }
00377 
00378 <span class="keyword">static</span> bool_t Svcauth_gss_validate( <span class="keyword">struct</span> <a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> *gd, <span class="keyword">struct</span> Rpc_msg *msg)
00379 {
00380         <span class="keyword">struct </span>opaque_auth      *oa;
00381         gss_buffer_desc          rpcbuf, checksum;
00382         OM_uint32                maj_stat, min_stat, qop_state;
00383         u_char                   rpchdr[128];
00384         int32_t                 *buf;
00385 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00386 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in Svcauth_gss_validate()\n"</span>);
00387 <span class="preprocessor">#endif</span>
00388 <span class="preprocessor"></span>        
00389         memset(rpchdr, 0, <span class="keyword">sizeof</span>(rpchdr));
00390 
00391         <span class="comment">/* XXX - Reconstruct RPC header for signing (from xdr_callmsg). */</span>
00392         buf = (int32_t *)rpchdr;
00393         IXDR_PUT_LONG(buf, msg-&gt;rm_xid);
00394         IXDR_PUT_ENUM(buf, msg-&gt;rm_direction);
00395         IXDR_PUT_LONG(buf, msg-&gt;rm_call.cb_rpcvers);
00396         IXDR_PUT_LONG(buf, msg-&gt;rm_call.cb_prog);
00397         IXDR_PUT_LONG(buf, msg-&gt;rm_call.cb_vers);
00398         IXDR_PUT_LONG(buf, msg-&gt;rm_call.cb_proc);
00399         
00400   oa = &amp;msg-&gt;rm_call.cb_cred;
00401         
00402   IXDR_PUT_ENUM(buf, oa-&gt;oa_flavor);
00403         IXDR_PUT_LONG(buf, oa-&gt;oa_length);
00404         <span class="keywordflow">if</span> (oa-&gt;oa_length) {
00405                 memcpy((caddr_t)buf, oa-&gt;oa_base, oa-&gt;oa_length);
00406                 buf += RNDUP(oa-&gt;oa_length) / <span class="keyword">sizeof</span>(int32_t);
00407         }
00408         rpcbuf.value = rpchdr;
00409         rpcbuf.length = (u_char *)buf - rpchdr;
00410 
00411         checksum.value = msg-&gt;rm_call.cb_verf.oa_base;
00412         checksum.length = msg-&gt;rm_call.cb_verf.oa_length;
00413 
00414         maj_stat = <a class="code" href="Release__gss__buffer_8c.html#a3">gss_verify_mic</a>(&amp;min_stat, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a>, &amp;rpcbuf, &amp;checksum,
00415                                   &amp;qop_state);
00416         
00417         <span class="keywordflow">if</span> (maj_stat != GSS_S_COMPLETE)
00418           {
00419             svc_log_status( <span class="stringliteral">"auth_validate"</span>, maj_stat, min_stat ) ;
00420             <span class="keywordflow">return</span> (FALSE);
00421           }
00422 
00423         <span class="keywordflow">return</span> (TRUE);
00424 }
00425 
00426 bool_t Svcauth_gss_nextverf( <span class="keyword">struct</span> Svc_req * rqst, u_int num)
00427 {
00428         <span class="keyword">struct </span><a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> * gd;
00429         gss_buffer_desc           signbuf, checksum;
00430         OM_uint32                             maj_stat, min_stat;
00431 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00432 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in Svcauth_gss_nextverf()\n"</span>);
00433 <span class="preprocessor">#endif</span>
00434 <span class="preprocessor"></span>
00435         <span class="keywordflow">if</span> (rqst-&gt;rq_xprt-&gt;xp_auth == NULL)
00436                 <span class="keywordflow">return</span> (FALSE);
00437         
00438         gd = <a class="code" href="rpcsec__gss__server_8c.html#a11">SVCAUTH_PRIVATE</a>(rqst-&gt;rq_xprt-&gt;xp_auth);
00439         
00440         signbuf.value = &amp;num;
00441         signbuf.length = <span class="keyword">sizeof</span>(num);
00442 
00443         maj_stat = <a class="code" href="Release__gss__buffer_8c.html#a2">gss_get_mic</a>(&amp;min_stat, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a>, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.qop,
00444                                &amp;signbuf, &amp;checksum);
00445 
00446         <span class="keywordflow">if</span> (maj_stat != GSS_S_COMPLETE)
00447     {
00448       svc_log_status( <span class="stringliteral">"next_verf"</span>, maj_stat, min_stat ) ;
00449       <span class="keywordflow">return</span> (FALSE);
00450     }
00451         rqst-&gt;rq_xprt-&gt;xp_verf.oa_flavor = RPCSEC_GSS;
00452         rqst-&gt;rq_xprt-&gt;xp_verf.oa_base = (caddr_t)checksum.value;
00453         rqst-&gt;rq_xprt-&gt;xp_verf.oa_length = (u_int)checksum.length;
00454         
00455         <span class="keywordflow">return</span> (TRUE);
00456 }
00457 
00458 <span class="keyword">enum</span> Auth_stat <a class="code" href="Svc__auth_8c.html#a6">Svcauth_gss</a>(<span class="keyword">struct</span> Svc_req *rqst, <span class="keyword">struct</span> Rpc_msg *msg)
00459 {
00460         XDR                                     xdrs;
00461         SVCAUTH                                 * auth;
00462         <span class="keyword">struct </span><a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> * gd;
00463         <span class="keyword">struct </span>Rpc_gss_cred     *     gc;
00464         <span class="keyword">struct </span>Rpc_gss_init_res   gr;
00465         <span class="keywordtype">int</span>                                 call_stat, offset;
00466         FILE * tmplog = NULL ;
00467 
00468 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00469 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in svcauth_gss()\n"</span>);
00470 <span class="preprocessor">#endif</span>
00471 <span class="preprocessor"></span>
00472         <span class="keywordflow">if</span>( <a class="code" href="Svc__tab__auth_8c.html#a2">TabAuthData</a>[rqst-&gt;rq_xprt-&gt;xp_sock] != NULL )
00473                 rqst-&gt;rq_xprt-&gt;xp_auth =  <a class="code" href="Svc__tab__auth_8c.html#a2">TabAuthData</a>[rqst-&gt;rq_xprt-&gt;xp_sock] ;
00474         
00475         <span class="comment">/* Initialize reply. */</span>
00476         rqst-&gt;rq_xprt-&gt;xp_verf = _null_auth;
00477 
00478         <span class="comment">/* Allocate and set up server auth handle. */</span>
00479         <span class="keywordflow">if</span> (rqst-&gt;rq_xprt-&gt;xp_auth == NULL ||
00480             rqst-&gt;rq_xprt-&gt;xp_auth == &amp;Svc_auth_none) {
00481                 <span class="keywordflow">if</span> ((auth = mem_calloc(<span class="keyword">sizeof</span>(*auth), 1)) == NULL) {
00482                       
00483                         <span class="keywordflow">if</span>( ( tmplog = fopen( RPCSEC_GSS_LOG, <span class="stringliteral">"a"</span> ) ) != NULL )
00484                         {
00485                         fprintf(tmplog, <span class="stringliteral">"svcauth_gss: out_of_memory\n"</span>);
00486                         fclose( tmplog ) ;
00487                         }
00488                         <span class="keywordflow">return</span> (AUTH_FAILED);
00489                 }
00490                 <span class="keywordflow">if</span> ((gd = mem_calloc(<span class="keyword">sizeof</span>(*gd), 1)) == NULL) {
00491                         <span class="keywordflow">if</span>( ( tmplog = fopen( RPCSEC_GSS_LOG, <span class="stringliteral">"a"</span> ) ) != NULL )
00492                         {
00493                         fprintf(tmplog, <span class="stringliteral">"svcauth_gss: out_of_memory\n"</span>);
00494                         fclose( tmplog ) ;
00495                         }
00496                         <span class="keywordflow">return</span> (AUTH_FAILED);
00497                 }
00498 
00499                 <span class="comment">/* Keep the gd in the TabGssData array */</span>
00500 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00501 <span class="preprocessor"></span>                printf( <span class="stringliteral">" - - - - - -&gt; rqst-&gt;rq_xprt-&gt;xp_sock=%u  TabAuthData[rqst-&gt;rq_xprt-&gt;xp_sock]=%p  auth=%p\n"</span>,
00502                         rqst-&gt;rq_xprt-&gt;xp_sock, 
00503                         TabAuthData[rqst-&gt;rq_xprt-&gt;xp_sock], auth ) ;
00504 <span class="preprocessor">#endif</span>
00505 <span class="preprocessor"></span>
00506                 <span class="keywordflow">if</span>( <a class="code" href="Svc__tab__auth_8c.html#a2">TabAuthData</a>[rqst-&gt;rq_xprt-&gt;xp_sock] == NULL ) 
00507                         <a class="code" href="Svc__tab__auth_8c.html#a2">TabAuthData</a>[rqst-&gt;rq_xprt-&gt;xp_sock] = auth ;
00508 
00509                 auth-&gt;svc_ah_ops = &amp;Svc_auth_gss_ops;
00510 <span class="preprocessor">#ifdef _AIX_5</span>
00511 <span class="preprocessor"></span>                (auth)-&gt;svc_ah_private = (<span class="keywordtype">char</span> *)gd ;  <span class="comment">/* SVCAUTH_PRIVATE(auth) as left value, will not compile on IBM   */</span>
00512 <span class="preprocessor">#else</span>
00513 <span class="preprocessor"></span>                <a class="code" href="rpcsec__gss__server_8c.html#a11">SVCAUTH_PRIVATE</a>(auth) = gd ;
00514 <span class="preprocessor">#endif</span>
00515 <span class="preprocessor"></span>                rqst-&gt;rq_xprt-&gt;xp_auth = auth;
00516         }
00517         <span class="keywordflow">else</span> gd = <a class="code" href="rpcsec__gss__server_8c.html#a11">SVCAUTH_PRIVATE</a>(rqst-&gt;rq_xprt-&gt;xp_auth);
00518 
00519 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00520 <span class="preprocessor"></span>        printf( <span class="stringliteral">"               --------&gt; Svcauth_gss : xp_sock=%u auth=%p gd=%p\n"</span>, rqst-&gt;rq_xprt-&gt;xp_sock, auth, gd ) ;       
00521 <span class="preprocessor">#endif</span>
00522 <span class="preprocessor"></span>
00523         <span class="comment">/* Deserialize client credentials. */</span>
00524         <span class="keywordflow">if</span> (rqst-&gt;rq_cred.oa_length &lt;= 0)
00525                 <span class="keywordflow">return</span> (AUTH_BADCRED);
00526         
00527         gc = (<span class="keyword">struct </span>Rpc_gss_cred *)rqst-&gt;rq_clntcred;
00528         memset(gc, 0, <span class="keyword">sizeof</span>(*gc));
00529         
00530         <a class="code" href="Xdr__mem_8c.html#a13">Xdrmem_create</a>( &amp;xdrs, rqst-&gt;rq_cred.oa_base,
00531                  rqst-&gt;rq_cred.oa_length, XDR_DECODE);
00532         
00533         <span class="keywordflow">if</span> (!Xdr_Rpc_gss_cred(&amp;xdrs, gc)) {
00534                 XDR_DESTROY(&amp;xdrs);
00535                 <span class="keywordflow">return</span> (AUTH_BADCRED);
00536         }
00537         XDR_DESTROY(&amp;xdrs);
00538 
00539         <span class="comment">/* Check version. */</span>
00540         <span class="keywordflow">if</span> (gc-&gt;gc_v != RPCSEC_GSS_VERSION)
00541                 <span class="keywordflow">return</span> (AUTH_BADCRED);
00542 
00543         <span class="comment">/* Check RPCSEC_GSS service. */</span>
00544 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00545 <span class="preprocessor"></span>        printf( <span class="stringliteral">"gc-&gt;gc_svc = %d RPCSEC_GSS_SVC_NONE=%d RPCSEC_GSS_SVC_INTEGRITY=%d RPCSEC_GSS_SVC_PRIVACY=%d\n"</span>, 
00546                 RPCSEC_GSS_SVC_NONE, RPCSEC_GSS_SVC_INTEGRITY, RPCSEC_GSS_SVC_PRIVACY ) ;
00547 <span class="preprocessor">#endif </span>
00548 <span class="preprocessor"></span>
00549         <span class="keywordflow">if</span> (gc-&gt;gc_svc != RPCSEC_GSS_SVC_NONE &amp;&amp;
00550             gc-&gt;gc_svc != RPCSEC_GSS_SVC_INTEGRITY &amp;&amp;
00551             gc-&gt;gc_svc != RPCSEC_GSS_SVC_PRIVACY)
00552                 <span class="keywordflow">return</span> (AUTH_BADCRED);
00553 
00554         <span class="comment">/* Check sequence number. */</span>
00555         <span class="keywordflow">if</span> (gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o0">established</a>)
00556     {
00557       <span class="keywordflow">if</span> (gc-&gt;gc_seq &gt; MAXSEQ)
00558         <span class="keywordflow">return</span> (RPCSEC_GSS_CTXPROBLEM);
00559       
00560       <span class="keywordflow">if</span> ((offset = gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o6">seqlast</a> - gc-&gt;gc_seq) &lt; 0) {
00561         gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o6">seqlast</a> = gc-&gt;gc_seq;
00562         offset = 0 - offset;
00563         gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o7">seqmask</a> &lt;&lt;= offset;
00564         offset = 0;
00565       }
00566       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (offset &gt;= gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o5">win</a> || (gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o7">seqmask</a> &amp; (1 &lt;&lt; offset))) {
00567         <span class="keywordflow">return</span> (RPCSEC_GSS_CTXPROBLEM);
00568       }
00569       gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o4">seq</a> = gc-&gt;gc_seq;
00570       gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o7">seqmask</a> |= (1 &lt;&lt; offset);
00571     }
00572         
00573         <span class="keywordflow">if</span> (gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o0">established</a> )
00574     {
00575       rqst-&gt;rq_clntname = (<span class="keywordtype">char</span> *)gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o8">client_name</a>;
00576       rqst-&gt;rq_svcname = (<span class="keywordtype">char</span> *)gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a>;
00577     }
00578 
00579         <span class="comment">/* Handle RPCSEC_GSS control procedure. */</span>
00580 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00581 <span class="preprocessor"></span>        printf( <span class="stringliteral">"-------------------&gt; gc-&gt;gc_proc=%d   RPCSEC_GSS_INIT=%d   RPCSEC_GSS_CONTINUE_INIT=%d   RPCSEC_GSS_DATA=%d   RPCSEC_GSS_DESTROY=%d\n"</span>, 
00582                 gc-&gt;gc_proc, RPCSEC_GSS_INIT, RPCSEC_GSS_CONTINUE_INIT, RPCSEC_GSS_DATA, RPCSEC_GSS_DESTROY ) ;
00583 <span class="preprocessor">#endif</span>
00584 <span class="preprocessor"></span>
00585         <span class="keywordflow">switch</span> (gc-&gt;gc_proc) {
00586 
00587         <span class="keywordflow">case</span> RPCSEC_GSS_INIT:
00588         <span class="keywordflow">case</span> RPCSEC_GSS_CONTINUE_INIT:
00589 
00590                 <span class="keywordflow">if</span> (rqst-&gt;rq_proc != NULLPROC)
00591                         <span class="keywordflow">return</span> (AUTH_FAILED);           <span class="comment">/* XXX ? */</span>
00592 
00593                 <span class="keywordflow">if</span> (_svcauth_gss_name == NULL) 
00594                  {
00595                     <span class="keywordflow">if</span> (!Svcauth_gss_import_name(<span class="stringliteral">"nfs"</span>))
00596                         <span class="keywordflow">return</span> (AUTH_FAILED);
00597                 }
00598 
00599                 <span class="keywordflow">if</span> (!Svcauth_gss_acquire_cred())
00600                         <span class="keywordflow">return</span> (AUTH_FAILED);
00601                 
00602                 <span class="keywordflow">if</span> (!Svcauth_gss_accept_sec_context(rqst, &amp;gr))
00603                         <span class="keywordflow">return</span> (AUTH_REJECTEDCRED);
00604 
00605                 <span class="keywordflow">if</span> (!Svcauth_gss_nextverf(rqst, htonl(gr.gr_win)))
00606                         <span class="keywordflow">return</span> (AUTH_FAILED);
00607                 
00608                 
00609                 call_stat = <a class="code" href="Svc_8c.html#a14">Svc_sendreply</a>(rqst-&gt;rq_xprt, Xdr_Rpc_gss_init_res,
00610                                           (caddr_t)&amp;gr);
00611 
00612                 <span class="keywordflow">if</span> (!call_stat)
00613                         <span class="keywordflow">return</span> (AUTH_FAILED);
00614 
00615                 <span class="keywordflow">if</span> (gr.gr_major == GSS_S_COMPLETE)
00616                         gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o0">established</a> = TRUE;
00617                 
00618                 <span class="keywordflow">break</span>;
00619                 
00620         <span class="keywordflow">case</span> RPCSEC_GSS_DATA:
00621                 <span class="keywordflow">if</span> (!Svcauth_gss_validate(gd, msg))
00622                         <span class="keywordflow">return</span> (RPCSEC_GSS_CREDPROBLEM);
00623                 
00624                 <span class="keywordflow">if</span> (!Svcauth_gss_nextverf(rqst, htonl(gc-&gt;gc_seq)))
00625                         <span class="keywordflow">return</span> (AUTH_FAILED);
00626                 <span class="keywordflow">break</span>;
00627                 
00628         <span class="keywordflow">case</span> RPCSEC_GSS_DESTROY:
00629                 <span class="keywordflow">if</span> (rqst-&gt;rq_proc != NULLPROC)
00630                         <span class="keywordflow">return</span> (AUTH_FAILED);           <span class="comment">/* XXX ? */</span>
00631                 
00632                 <span class="keywordflow">if</span> (!Svcauth_gss_validate(gd, msg))
00633                         <span class="keywordflow">return</span> (RPCSEC_GSS_CREDPROBLEM);
00634                 
00635                 <span class="keywordflow">if</span> (!Svcauth_gss_nextverf(rqst, htonl(gc-&gt;gc_seq)))
00636                         <span class="keywordflow">return</span> (AUTH_FAILED);
00637 
00638                 <span class="keywordflow">if</span> (!Svcauth_gss_release_cred())
00639                         <span class="keywordflow">return</span> (AUTH_FAILED);
00640                         
00641                 SVCAUTH_DESTROY(rqst-&gt;rq_xprt-&gt;xp_auth);
00642                 rqst-&gt;rq_xprt-&gt;xp_auth = &amp;Svc_auth_none;
00643 
00644                 <span class="keywordflow">break</span>;
00645 
00646         <span class="keywordflow">default</span>:
00647                 <span class="keywordflow">return</span> (AUTH_REJECTEDCRED);
00648                 <span class="keywordflow">break</span>;
00649         }
00650         <span class="keywordflow">return</span> (AUTH_OK);
00651 }
00652 
00653 bool_t Svcauth_gss_destroy( SVCAUTH * auth )
00654 {
00655         <span class="keyword">struct </span><a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> *gd;
00656         OM_uint32                min_stat;
00657 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00658 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in svcauth_gss_destroy()\n"</span>);
00659 <span class="preprocessor">#endif</span>
00660 <span class="preprocessor"></span>        
00661         gd = <a class="code" href="rpcsec__gss__server_8c.html#a11">SVCAUTH_PRIVATE</a>(auth);
00662         
00663         gss_delete_sec_context(&amp;min_stat, &amp;gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a>, GSS_C_NO_BUFFER);
00664         gss_release_buffer(&amp;min_stat, &amp;gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o3">cname</a>);
00665 
00666         <span class="keywordflow">if</span> (gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o8">client_name</a>)
00667                 gss_release_name(&amp;min_stat, &amp;gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o8">client_name</a>);
00668 
00670         mem_free((<span class="keywordtype">void</span> *)gd, <span class="keyword">sizeof</span>(*gd));
00671         mem_free((<span class="keywordtype">void</span> *)auth, <span class="keyword">sizeof</span>(*auth));
00672 
00673         <span class="keywordflow">return</span> (TRUE);
00674 }
00675 
00676 bool_t Svcauth_gss_wrap( SVCAUTH *auth, XDR *xdrs, Xdrproc_t xdr_func, caddr_t xdr_ptr )
00677 {
00678         <span class="keyword">struct </span><a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> *gd;
00679 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS        </span>
00680 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in svcauth_gss_wrap()\n"</span>);
00681 <span class="preprocessor">#endif</span>
00682 <span class="preprocessor"></span>
00683         gd = <a class="code" href="rpcsec__gss__server_8c.html#a11">SVCAUTH_PRIVATE</a>(auth);
00684         
00685         <span class="keywordflow">if</span> (!gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o0">established</a> || gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.svc == RPCSEC_GSS_SVC_NONE) {
00686                 <span class="keywordflow">return</span> ((*xdr_func)(xdrs, xdr_ptr));
00687         }
00688         <span class="keywordflow">return</span> (Xdr_Rpc_gss_data(xdrs, xdr_func, xdr_ptr,
00689                                  gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a>, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.qop,
00690                                  gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.svc, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o4">seq</a>));
00691 }
00692 
00693 bool_t Svcauth_gss_unwrap( SVCAUTH *auth, XDR *xdrs, Xdrproc_t xdr_func, caddr_t xdr_ptr )
00694 {
00695         <span class="keyword">struct </span><a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> *gd;
00696 <span class="preprocessor">#ifdef _DEBUG_RPCSEC_GSS</span>
00697 <span class="preprocessor"></span>        printf(<span class="stringliteral">"in svcauth_gss_unwrap()\n"</span>);
00698 <span class="preprocessor">#endif</span>
00699 <span class="preprocessor"></span>        
00700         gd = <a class="code" href="rpcsec__gss__server_8c.html#a11">SVCAUTH_PRIVATE</a>(auth);
00701 
00702         <span class="keywordflow">if</span> (!gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o0">established</a> || gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.svc == RPCSEC_GSS_SVC_NONE) {
00703                 <span class="keywordflow">return</span> ((*xdr_func)(xdrs, xdr_ptr));
00704         }
00705         <span class="keywordflow">return</span> (Xdr_Rpc_gss_data(xdrs, xdr_func, xdr_ptr,
00706                                  gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o1">ctx</a>, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.qop,
00707                                  gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o2">sec</a>.svc, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o4">seq</a>));
00708 }
00709 
00710 <span class="keywordtype">char</span> * Svcauth_gss_get_principal(SVCAUTH *auth)
00711 {
00712         <span class="keyword">struct </span><a class="code" href="structSvc__rpc__gss__data.html">Svc_rpc_gss_data</a> *gd;
00713         <span class="keywordtype">char</span> *pname;
00714 
00715         gd = <a class="code" href="rpcsec__gss__server_8c.html#a11">SVCAUTH_PRIVATE</a>(auth);
00716 
00717         <span class="keywordflow">if</span> (gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o3">cname</a>.length == 0)
00718                 <span class="keywordflow">return</span> (NULL);
00719 
00720         <span class="keywordflow">if</span> ((pname = malloc(gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o3">cname</a>.length + 1)) == NULL)
00721                 <span class="keywordflow">return</span> (NULL);
00722 
00723         memcpy(pname, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o3">cname</a>.value, gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o3">cname</a>.length);
00724         pname[gd-&gt;<a class="code" href="structSvc__rpc__gss__data.html#o3">cname</a>.length] = <span class="charliteral">'\0'</span>;
00725 
00726         <span class="keywordflow">return</span> (pname);
00727 }
00728 
00729 <span class="preprocessor">#else</span>
<a name="l00730"></a><a class="code" href="Svc__auth__gss_8c.html#a2">00730</a> <span class="preprocessor"></span><span class="keyword">enum</span> Auth_stat <a class="code" href="Svc__auth_8c.html#a6">Svcauth_gss</a>(<span class="keyword">struct</span> Svc_req *rqst, <span class="keyword">struct</span> Rpc_msg *msg)
00731 {
00732   <span class="keywordflow">return</span> AUTH_OK ;
00733 }
00734 
00735 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Dec 22 14:15:35 2006 for RPCSEC_GSS Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
