<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Cache inode layer: cache_inode_open_close.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>cache_inode_open_close.c</h1><a href="cache__inode__open__close_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00085 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00087 <span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>
00089 
00090 <span class="preprocessor">#include "fsal.h"</span>
00091 
00092 <span class="preprocessor">#include "LRU_List.h"</span>
00093 <span class="preprocessor">#include "log_functions.h"</span>
00094 <span class="preprocessor">#include "HashData.h"</span>
00095 <span class="preprocessor">#include "HashTable.h"</span>
00096 <span class="preprocessor">#include "cache_inode.h"</span>
00097 <span class="preprocessor">#include "cache_content.h"</span>
00098 <span class="preprocessor">#include "stuff_alloc.h"</span>
00099 
00100 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00101 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00102 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00103 <span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00104 <span class="preprocessor">#include &lt;time.h&gt;</span>
00105 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00106 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00107 
00108 
<a name="l00126"></a><a class="code" href="cache__inode__open__close_8c.html#a0">00126</a> cache_inode_status_t <a class="code" href="cache__inode__open__close_8c.html#a0">cache_inode_open</a>( cache_entry_t              * pentry,
00127                                        cache_inode_client_t       * pclient,
00128                                        fsal_openflags_t             openflags,
00129                                        fsal_op_context_t          * pcontext,
00130                                        cache_inode_status_t       * pstatus )
00131 {
00132   fsal_status_t   fsal_status ;
00133 
00134   <span class="keywordflow">if</span>( ( pentry == NULL ) || ( pclient == NULL ) || ( pcontext == NULL ) || ( pstatus == NULL ) )
00135      <span class="keywordflow">return</span> CACHE_INODE_INVALID_ARGUMENT ;
00136 
00137   <span class="keywordflow">if</span>( pentry-&gt;internal_md.type != REGULAR_FILE ) 
00138     {  
00139        *pstatus = CACHE_INODE_BAD_TYPE ;
00140        <span class="keywordflow">return</span> *pstatus ;
00141     }
00142 
00143   <span class="keywordflow">if</span>( pclient-&gt;use_cache == 0 )
00144     pentry-&gt;object.file.open_fd.last_op  = 0 ; <span class="comment">/* to force opening the file */</span>
00145 
00146 
00147   <span class="keywordflow">if</span>( ( pclient-&gt;use_cache == 1 ) &amp;&amp; 
00148       ( pentry-&gt;object.file.open_fd.fileno &gt;= 0 ) &amp;&amp;
00149       ( time( NULL ) - pentry-&gt;object.file.open_fd.last_op  &gt; pclient-&gt;retention ) )
00150     {
00151       fsal_status = FSAL_close( &amp;(pentry-&gt;object.file.open_fd.fd) ) ;
00152       <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00153          {
00154            *pstatus = <a class="code" href="cache__inode__misc_8c.html#a5">cache_inode_error_convert</a>( fsal_status ) ;
00155 
00156            <span class="keywordflow">return</span> *pstatus ;
00157          }
00158        pentry-&gt;object.file.open_fd.last_op = 0 ;
00159     }
00160 
00161 
00162   
00163   <span class="comment">/* Open file need to be close */</span>
00164   <span class="keywordflow">if</span>( ( pentry-&gt;object.file.open_fd.openflags != 0 ) &amp;&amp;
00165       ( pentry-&gt;object.file.open_fd.fileno &gt;= 0 )     &amp;&amp;
00166       ( pentry-&gt;object.file.open_fd.openflags != openflags ) )
00167     {
00168       fsal_status = FSAL_close( &amp;(pentry-&gt;object.file.open_fd.fd) ) ;
00169       <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00170          {
00171            *pstatus = <a class="code" href="cache__inode__misc_8c.html#a5">cache_inode_error_convert</a>( fsal_status ) ;
00172 
00173            <span class="keywordflow">return</span> *pstatus ;
00174          }
00175 
00176     }
00177         
00178 
00179   <span class="keywordflow">if</span>( pentry-&gt;object.file.open_fd.last_op  == 0 )
00180    {
00181      <span class="comment">/* opened file is not preserved yet */</span>
00182      fsal_status = FSAL_open( &amp;(pentry-&gt;object.file.handle),
00183                               pcontext,
00184                               openflags,
00185                               &amp;pentry-&gt;object.file.open_fd.fd,
00186                               &amp;(pentry-&gt;object.file.attributes) ) ;
00187 
00188      <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00189          {
00190            *pstatus = <a class="code" href="cache__inode__misc_8c.html#a5">cache_inode_error_convert</a>( fsal_status ) ;
00191 
00192            <span class="keywordflow">return</span> *pstatus ;
00193          }
00194 
00195      pentry-&gt;object.file.open_fd.fileno    = (int)FSAL_FILENO( &amp;(pentry-&gt;object.file.open_fd.fd) ) ; 
00196      pentry-&gt;object.file.open_fd.openflags = openflags ;
00197    }
00198 
00199    <span class="comment">/* regular exit */</span>
00200 
00201    pentry-&gt;object.file.open_fd.last_op = time( NULL ) ;
00202   *pstatus = CACHE_INODE_SUCCESS ;
00203   <span class="keywordflow">return</span> *pstatus ;
00204 
00205 } <span class="comment">/* cache_content_open */</span>
00206 
<a name="l00226"></a><a class="code" href="cache__inode__open__close_8c.html#a1">00226</a> cache_inode_status_t <a class="code" href="cache__inode__open__close_8c.html#a1">cache_inode_open_by_name</a>( cache_entry_t              * pentry_dir,
00227                                                fsal_name_t                * pname,
00228                                                cache_entry_t              * pentry_file,
00229                                                cache_inode_client_t       * pclient,
00230                                                fsal_openflags_t             openflags,
00231                                                fsal_op_context_t          * pcontext,
00232                                                cache_inode_status_t       * pstatus )
00233 {
00234   fsal_status_t   fsal_status ;
00235   fsal_size_t     save_filesize ;
00236   fsal_size_t     save_spaceused ;
00237   fsal_time_t     save_mtime ; 
00238 
00239   <span class="keywordflow">if</span>( ( pentry_dir == NULL ) || ( pname == NULL ) || ( pentry_file == NULL ) || 
00240       ( pclient == NULL ) || ( pcontext == NULL ) || ( pstatus == NULL ) )
00241      <span class="keywordflow">return</span> CACHE_INODE_INVALID_ARGUMENT ;
00242 
00243   <span class="keywordflow">if</span>( ( pentry_dir-&gt;internal_md.type != DIR_BEGINNING ) &amp;&amp; ( pentry_dir-&gt;internal_md.type != DIR_CONTINUE ) )
00244     {  
00245        *pstatus = CACHE_INODE_BAD_TYPE ;
00246        <span class="keywordflow">return</span> *pstatus ;
00247     }
00248 
00249   <span class="keywordflow">if</span>( pentry_file-&gt;internal_md.type != REGULAR_FILE ) 
00250     {  
00251        *pstatus = CACHE_INODE_BAD_TYPE ;
00252        <span class="keywordflow">return</span> *pstatus ;
00253     }
00254 
00255   <span class="keywordflow">if</span>( pclient-&gt;use_cache == 0 )
00256     pentry_file-&gt;object.file.open_fd.last_op  = 0 ; <span class="comment">/* to force opening the file */</span>
00257 
00258 
00259   <span class="keywordflow">if</span>( ( pclient-&gt;use_cache == 1 ) &amp;&amp; 
00260       ( pentry_file-&gt;object.file.open_fd.fileno &gt;= 0 ) &amp;&amp;
00261       ( time( NULL ) - pentry_file-&gt;object.file.open_fd.last_op  &gt; pclient-&gt;retention ) )
00262     {
00263       fsal_status = FSAL_close( &amp;(pentry_file-&gt;object.file.open_fd.fd) ) ;
00264       <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00265          {
00266            *pstatus = <a class="code" href="cache__inode__misc_8c.html#a5">cache_inode_error_convert</a>( fsal_status ) ;
00267 
00268            <span class="keywordflow">return</span> *pstatus ;
00269          }
00270        pentry_file-&gt;object.file.open_fd.last_op = 0 ;
00271     }
00272 
00273 
00274   
00275   <span class="comment">/* Open file need to be close */</span>
00276   <span class="keywordflow">if</span>( ( pentry_file-&gt;object.file.open_fd.openflags != 0 ) &amp;&amp;
00277       ( pentry_file-&gt;object.file.open_fd.fileno &gt;= 0 )     &amp;&amp;
00278       ( pentry_file-&gt;object.file.open_fd.openflags != openflags ) )
00279     {
00280       fsal_status = FSAL_close( &amp;(pentry_file-&gt;object.file.open_fd.fd) ) ;
00281       <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00282          {
00283            *pstatus = <a class="code" href="cache__inode__misc_8c.html#a5">cache_inode_error_convert</a>( fsal_status ) ;
00284 
00285            <span class="keywordflow">return</span> *pstatus ;
00286          }
00287 
00288     }
00289        
00290 
00291   <span class="keywordflow">if</span>( pentry_file-&gt;object.file.open_fd.last_op  == 0 )
00292    {
00293      <span class="comment">/* Keep coherency with the cache_content */</span> 
00294      <span class="keywordflow">if</span>( pentry_file-&gt;object.file.pentry_content != NULL ) 
00295       {
00296           save_filesize  = pentry_file-&gt;object.file.attributes.filesize ;
00297           save_spaceused = pentry_file-&gt;object.file.attributes.spaceused ;
00298           save_mtime     = pentry_file-&gt;object.file.attributes.mtime ; 
00299       }
00300 
00301      <span class="comment">/* opened file is not preserved yet */</span>
00302      fsal_status = FSAL_open_by_name( &amp;(pentry_dir-&gt;object.file.handle),
00303                                       pname,
00304                                       pcontext,
00305                                       openflags,
00306                                       &amp;pentry_file-&gt;object.file.open_fd.fd,
00307                                       &amp;(pentry_file-&gt;object.file.attributes) ) ;
00308 
00309      <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00310          {
00311            *pstatus = <a class="code" href="cache__inode__misc_8c.html#a5">cache_inode_error_convert</a>( fsal_status ) ;
00312 
00313            <span class="keywordflow">return</span> *pstatus ;
00314          }
00315 
00316 <span class="preprocessor">#ifdef _USE_PROXY</span>
00317 <span class="preprocessor"></span>
00318      <span class="comment">/* If proxy if used, we should keep the name of the file to do FSAL_rcp if needed */</span>
00319      <span class="keywordflow">if</span>( ( pentry_file-&gt;object.file.pname = (fsal_name_t *)Mem_Alloc( <span class="keyword">sizeof</span>( fsal_name_t ) ) ) == NULL )
00320         {
00321            *pstatus = CACHE_INODE_MALLOC_ERROR ;
00322         
00323             <span class="keywordflow">return</span> *pstatus ;
00324         }
00325 
00326      pentry_file-&gt;object.file.pentry_parent_open = pentry_dir ;
00327      pentry_file-&gt;object.file.pname-&gt;len = pname-&gt;len ;
00328      memcpy( (<span class="keywordtype">char</span> *)(pentry_file-&gt;object.file.pname-&gt;name), (<span class="keywordtype">char</span> *)(pname-&gt;name), FSAL_MAX_NAME_LEN ) ;
00329      
00330 <span class="preprocessor">#endif</span>
00331 <span class="preprocessor"></span>
00332      <span class="comment">/* Keep coherency with the cache_content */</span> 
00333      <span class="keywordflow">if</span>( pentry_file-&gt;object.file.pentry_content != NULL ) 
00334       {
00335           pentry_file-&gt;object.file.attributes.filesize  = save_filesize ;
00336           pentry_file-&gt;object.file.attributes.spaceused = save_spaceused ;
00337           pentry_file-&gt;object.file.attributes.mtime     = save_mtime; 
00338       }
00339 
00340      pentry_file-&gt;object.file.open_fd.fileno    = (int)FSAL_FILENO( &amp;(pentry_file-&gt;object.file.open_fd.fd) ) ; 
00341      pentry_file-&gt;object.file.open_fd.openflags = openflags ;
00342    }
00343 
00344    <span class="comment">/* regular exit */</span>
00345 
00346    pentry_file-&gt;object.file.open_fd.last_op = time( NULL ) ;
00347   *pstatus = CACHE_INODE_SUCCESS ;
00348   <span class="keywordflow">return</span> *pstatus ;
00349 
00350 } <span class="comment">/* cache_content_open_by_name */</span>
00351 
00352 
00353 
<a name="l00370"></a><a class="code" href="cache__inode__open__close_8c.html#a2">00370</a> cache_inode_status_t <a class="code" href="cache__inode__open__close_8c.html#a2">cache_inode_close</a>( cache_entry_t         * pentry,
00371                                         cache_inode_client_t  * pclient,
00372                                         cache_inode_status_t  * pstatus )
00373 {
00374   fsal_status_t fsal_status ;
00375 
00376   <span class="keywordflow">if</span>( ( pentry == NULL ) || ( pclient == NULL ) || ( pstatus == NULL ) )
00377      <span class="keywordflow">return</span> CACHE_CONTENT_INVALID_ARGUMENT ;
00378 
00379   <span class="keywordflow">if</span>( pentry-&gt;internal_md.type != REGULAR_FILE ) 
00380     {  
00381        *pstatus = CACHE_INODE_BAD_TYPE ;
00382        <span class="keywordflow">return</span> *pstatus ;
00383     }
00384 
00385   <span class="comment">/* if nothing is opened, do nothing */</span>
00386   <span class="keywordflow">if</span>(  pentry-&gt;object.file.open_fd.fileno &lt; 0 )
00387    {
00388      *pstatus = CACHE_INODE_SUCCESS ;
00389      <span class="keywordflow">return</span> *pstatus ;
00390    }
00391 
00392   <span class="keywordflow">if</span>( ( pclient-&gt;use_cache == 0 ) ||
00393       ( time( NULL) - pentry-&gt;object.file.open_fd.last_op &gt; pclient-&gt;retention ) || 
00394       ( pentry-&gt;object.file.open_fd.fileno &gt; (int)(pclient-&gt;max_fd_per_thread) ) )
00395    {
00396      pentry-&gt;object.file.open_fd.fileno  = -1 ;
00397      pentry-&gt;object.file.open_fd.last_op =  0 ;
00398 
00399      fsal_status = FSAL_close( &amp;(pentry-&gt;object.file.open_fd.fd) ) ;
00400      <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00401          {
00402            *pstatus = <a class="code" href="cache__inode__misc_8c.html#a5">cache_inode_error_convert</a>( fsal_status ) ;
00403 
00404            <span class="keywordflow">return</span> *pstatus ;
00405          }
00406    }
00407 
00408 <span class="preprocessor">#ifdef _USE_PROXY</span>
00409 <span class="preprocessor"></span>  <span class="comment">/* If proxy if used, free the name if needed */</span>
00410   <span class="keywordflow">if</span>( pentry-&gt;object.file.pname != NULL )
00411     {
00412        Mem_Free( (<span class="keywordtype">char</span> *)( pentry-&gt;object.file.pname ) ) ;
00413        pentry-&gt;object.file.pname = NULL ;
00414     }
00415   pentry-&gt;object.file.pentry_parent_open = NULL ;
00416 <span class="preprocessor">#endif</span>
00417 <span class="preprocessor"></span>
00418   *pstatus = CACHE_CONTENT_SUCCESS ;
00419 
00420   <span class="keywordflow">return</span> *pstatus ;
00421 } <span class="comment">/* cache_content_close */</span>
00422 
00423                                                       
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:52 2008 for Cache inode layer by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
