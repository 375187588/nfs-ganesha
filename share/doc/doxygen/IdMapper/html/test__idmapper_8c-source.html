<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Id Mapper: test_idmapper.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>test_idmapper.c</h1><a href="test__idmapper_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00005 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00006 <span class="preprocessor">#endif</span>
00007 <span class="preprocessor"></span>
00008 
00009 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00010 <span class="preprocessor">#include &lt;string.h&gt;</span>
00011 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00012 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00013 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>     <span class="comment">/* for having FNDELAY */</span>
00014 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span> <span class="comment">/* for having setrlimit */</span>
00015 <span class="preprocessor">#include &lt;signal.h&gt;</span> <span class="comment">/* for sigaction */</span>
00016 <span class="preprocessor">#include &lt;gssapi/gssapi.h&gt;</span>
00017 <span class="preprocessor">#ifdef HAVE_KRB5</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#include &lt;gssapi/gssapi_krb5.h&gt;</span> <span class="comment">/* For krb5_gss_register_acceptor_identity */</span>
00019 <span class="preprocessor">#endif</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#ifdef _USE_GSSRPC</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#include &lt;gssrpc/rpc.h&gt;</span>
00022 <span class="preprocessor">#include &lt;gssrpc/svc.h&gt;</span>
00023 <span class="preprocessor">#include &lt;gssrpc/pmap_clnt.h&gt;</span>
00024 <span class="preprocessor">#else</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00026 <span class="preprocessor">#include &lt;rpc/svc.h&gt;</span>
00027 <span class="preprocessor">#include &lt;rpc/pmap_clnt.h&gt;</span>
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#include "log_functions.h"</span>
00030 <span class="preprocessor">#include "stuff_alloc.h"</span>
00031 <span class="preprocessor">#include "fsal.h"</span>
00032 <span class="preprocessor">#include "nfs23.h"</span>
00033 <span class="preprocessor">#include "nfs4.h"</span>
00034 <span class="preprocessor">#include "mount.h"</span>
00035 <span class="preprocessor">#include "nfs_core.h"</span>
00036 <span class="preprocessor">#include "cache_inode.h"</span>
00037 <span class="preprocessor">#include "cache_content.h"</span>
00038 <span class="preprocessor">#include "nfs_file_handle.h"</span>
00039 <span class="preprocessor">#include "nfs_exports.h"</span>
00040 <span class="preprocessor">#include "nfs_tools.h"</span>
00041 <span class="preprocessor">#include "nfs_proto_functions.h"</span>
00042 <span class="preprocessor">#include "nfs_dupreq.h"</span>
00043 <span class="preprocessor">#include "config_parsing.h"</span>
00044 <span class="preprocessor">#include "SemN.h"</span>
00045 
00046 
<a name="l00047"></a><a class="code" href="test__idmapper_8c.html#a0">00047</a> nfs_parameter_t    nfs_param ;
00048         
<a name="l00049"></a><a class="code" href="test__idmapper_8c.html#a1">00049</a> <span class="keywordtype">int</span> <a class="code" href="test__idmapper_8c.html#a1">idmap_computer_hash_value</a>( <span class="keywordtype">char</span>      * name,
00050                                uint32_t  * phashval )
00051 {
00052   <span class="keywordtype">char</span>         padded_name[PWENT_MAX_LEN] ;
00053   uint32_t     computed_value = 0 ;
00054   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i              = 0  ;
00055   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset         = 0 ;
00056   uint64_t     extract        = 0 ;
00057   uint64_t     sum            = 0 ;
00058   uint64_t     i1 ;
00059   uint64_t     i2 ;
00060   uint64_t     i3 ;
00061   uint64_t     i4 ;
00062   uint64_t     i5 ;
00063   uint64_t     i6 ;
00064   uint64_t     i7 ;
00065   uint64_t     i8 ;
00066   uint64_t     l  ;
00067 
00068   <span class="keywordflow">if</span>( name == NULL || phashval == NULL )
00069     <span class="keywordflow">return</span> CLIENT_ID_INVALID_ARGUMENT ;
00070 
00071   memset( padded_name, 0, PWENT_MAX_LEN ) ;
00072 
00073   <span class="comment">/* Copy the string to the padded one */</span>
00074   <span class="keywordflow">for</span>( i = 0 ; i &lt; <a class="code" href="idmapper__cache_8c.html#a5">strnlen</a>( name, PWENT_MAX_LEN ) ; padded_name[i] = name[i], i++ ) ;
00075   
00076 
00077 <span class="preprocessor">#ifdef WITH_PRINTF_DEBUG_PWHASH_COMPUTE</span>
00078 <span class="preprocessor"></span>  printf( <span class="stringliteral">"%s \n"</span>, padded_name ) ;
00079 <span class="preprocessor">#endif</span>
00080 <span class="preprocessor"></span>
00081   <span class="comment">/* For each 9 character pack:</span>
00082 <span class="comment">   *   - keep the 7 first bit (the 8th is often 0: ascii string)</span>
00083 <span class="comment">   *   - pack 7x9 bit to 63 bits using xor</span>
00084 <span class="comment">   *   - xor the last 8th bit to a single 0 , or-ed with the rest</span>
00085 <span class="comment">   * Proceeding with the next 9 bytes pack will produce a new value that is xored with the</span>
00086 <span class="comment">   * one of the previous iteration */</span>
00087 
00088   <span class="keywordflow">for</span>( offset = 0 ; offset &lt; PWENT_MAX_LEN ; offset += 8 )
00089     {
00090       <span class="comment">/* input name is ascii string, remove 8th bit on each byte, not significant */</span>
00091       i1 = padded_name[offset+0]  ;
00092       i2 = ( padded_name[offset+1] ) &lt;&lt; 8 ;
00093       i3 = ( padded_name[offset+2] ) &lt;&lt; 16 ;
00094       i4 = ( padded_name[offset+3] ) &lt;&lt; 24 ;
00095       i5 = ( padded_name[offset+4] ) &lt;&lt; 32 ;
00096       i6 = ( padded_name[offset+5] ) &lt;&lt; 40 ;
00097       i7 = ( padded_name[offset+6] ) &lt;&lt; 48 ;
00098       i8 = ( padded_name[offset+7] ) &lt;&lt; 56 ;
00099 
00100   sum = (uint64_t)padded_name[offset+0] +
00101         (uint64_t)padded_name[offset+1] +
00102         (uint64_t)padded_name[offset+2] +
00103         (uint64_t)padded_name[offset+3] +
00104         (uint64_t)padded_name[offset+4] +
00105         (uint64_t)padded_name[offset+5] +
00106         (uint64_t)padded_name[offset+6] +
00107         (uint64_t)padded_name[offset+7] ;
00108 
00109 <span class="preprocessor">#ifdef WITH_PRINTF_DEBUG_PWHASH_COMPUTE</span>
00110 <span class="preprocessor"></span>      printf( <span class="stringliteral">"|%llx |%llx |%llx |%llx |%llx |%llx |%llx |%llx |%llx | = "</span>,
00111              i1, i2, i3, i4, i5, i6, i7, i8 ) ;
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor"></span>
00114       <span class="comment">/* Get xor combibation of all the 8h bit */</span>
00115       l = ( padded_name[offset+0]  ) ^
00116           ( padded_name[offset+1]  ) ^
00117           ( padded_name[offset+2]  ) ^
00118           ( padded_name[offset+3]  ) ^
00119           ( padded_name[offset+4]  ) ^
00120           ( padded_name[offset+5]  ) ^
00121           ( padded_name[offset+6]  ) ^
00122           ( padded_name[offset+7]  ) ;
00123 
00124       extract = i1 ^ i2 ^ i3 ^ i4 ^ i5 ^ i6 ^ i7 ^ i8  | l ;
00125 
00126 <span class="preprocessor">#ifdef WITH_PRINTF_DEBUG_PWHASH_COMPUTE</span>
00127 <span class="preprocessor"></span>      printf( <span class="stringliteral">"%llx "</span>, extract ) ;
00128 <span class="preprocessor">#endif</span>
00129 <span class="preprocessor"></span>
00130       computed_value ^= extract ;
00131       computed_value ^= sum ;
00132 <span class="preprocessor">#ifdef WITH_PRINTF_DEBUG_PWHASH_COMPUTE</span>
00133 <span class="preprocessor"></span>      printf( <span class="stringliteral">",%x\n  "</span>, computed_value ) ;
00134 <span class="preprocessor">#endif</span>
00135 <span class="preprocessor"></span>    }
00136 
00137   <span class="keywordflow">if</span>( computed_value &gt; 0x00000000FFFFFFFFLL )
00138     computed_value = (computed_value &gt;&gt; 32 ) ^ (computed_value &amp; 0x00000000FFFFFFFFLL ) ;
00139 
00140 <span class="preprocessor">#ifdef WITH_PRINTF_DEBUG_PWHASH_COMPUTE</span>
00141 <span class="preprocessor"></span>      printf( <span class="stringliteral">"===&gt;%x\n"</span>, computed_value ) ;
00142 <span class="preprocessor">#endif</span>
00143 <span class="preprocessor"></span>
00144   *phashval = computed_value ;
00145 
00146 
00147   <span class="keywordflow">return</span> CLIENT_ID_SUCCESS ;
00148 } <span class="comment">/* idmap_computer_hash_value */</span>
00149 
00150                                          
<a name="l00151"></a><a class="code" href="test__idmapper_8c.html#a2">00151</a> <a class="code" href="test__idmapper_8c.html#a2">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[] ) 
00152 {
00153     <span class="keywordtype">char</span> name[30] ;
00154     uint32_t valeur ; 
00155     <span class="keywordtype">int</span> i ; 
00156 
00157     <span class="keywordflow">if</span>( argc == 1 )  
00158         exit( 0 ) ;
00159 
00160     <span class="keywordflow">for</span>( i = 1; i &lt; argc ; i++ )
00161       {
00162         strncpy( name, argv[i],30 ) ;   
00163   
00164         <a class="code" href="test__idmapper_8c.html#a1">idmap_computer_hash_value</a>( name, &amp;valeur ) ;
00165         printf( <span class="stringliteral">"%s %x\n"</span>, name, valeur ) ;
00166       }
00167 }
00168 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:23 2008 for Id Mapper by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
