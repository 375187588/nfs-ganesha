<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: fsal_attrs.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_attrs.c</h1><a href="fsal__attrs_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 <span class="preprocessor">#include "HPSSclapiExt/hpssclapiext.h"</span>
00022 
<a name="l00044"></a><a class="code" href="fsal__attrs_8c.html#a0">00044</a> fsal_status_t <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>(
00045     fsal_handle_t         * filehandle,         <span class="comment">/* IN */</span>
00046     fsal_op_context_t     * p_context,          <span class="comment">/* IN */</span>
00047     fsal_attrib_list_t    * object_attributes   <span class="comment">/* IN/OUT */</span>
00048   )
00049 {
00050   
00051   <span class="keywordtype">int</span> rc;
00052   fsal_status_t status;
00053   ns_ObjHandle_t hpss_hdl;
00054   hpss_Attrs_t    hpss_attr;
00055 
00056   <span class="comment">/* sanity checks.</span>
00057 <span class="comment">   * note : object_attributes is mandatory in FSAL_getattrs.</span>
00058 <span class="comment">   */</span>
00059   <span class="keywordflow">if</span> (!filehandle || !p_context || !object_attributes)
00060     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_getattrs);
00061 
00062     
00063   <span class="comment">/* get attributes */</span>
00064   <span class="comment">/* We use  HPSSFSAL_GetRawAttrHandle for not chasing junctions</span>
00065 <span class="comment">   * nor solving symlinks. What's more, we want hpss_Attrs_t.</span>
00066 <span class="comment">   */</span>  
00067   
00068   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00069   
00070   rc = HPSSFSAL_GetRawAttrHandle(
00071         &amp;(filehandle-&gt;ns_handle),
00072         NULL,
00073         &amp;p_context-&gt;credential.hpss_usercred,
00074         FALSE, <span class="comment">/* don't solve junctions */</span>
00075         &amp;hpss_hdl,
00076         NULL,
00077         &amp;hpss_attr);
00078   
00079   ReleaseTokenFSCall();
00080   
00081   <span class="comment">/* The HPSS_ENOENT error actually means that handle is STALE */</span>
00082   <span class="keywordflow">if</span> ( rc == HPSS_ENOENT )
00083     Return( ERR_FSAL_STALE, -rc, INDEX_FSAL_getattrs);
00084   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc)
00085     Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_getattrs);
00086   
00087   
00088   <span class="comment">/* convert attributes */</span>
00089                                  
00090   status = <a class="code" href="fsal__convert_8c.html#a14">hpss2fsal_attributes</a>( &amp;hpss_hdl,
00091                                  &amp;hpss_attr,
00092                                  object_attributes );
00093                                  
00094   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status))
00095     Return(status.major,status.minor,INDEX_FSAL_getattrs);
00096   
00097   
00098   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_getattrs);
00099 
00100 }
00101 
00102 
00103 
00104 
<a name="l00138"></a><a class="code" href="fsal__attrs_8c.html#a1">00138</a> fsal_status_t <a class="code" href="fsal__attrs_8c.html#a1">FSAL_setattrs</a>(
00139     fsal_handle_t              * filehandle,          <span class="comment">/* IN */</span>
00140     fsal_op_context_t          * p_context,           <span class="comment">/* IN */</span>
00141     fsal_attrib_list_t         * attrib_set,          <span class="comment">/* IN */</span>
00142     fsal_attrib_list_t         * object_attributes    <span class="comment">/* [ IN/OUT ] */</span>
00143 ){
00144   
00145   <span class="keywordtype">int</span> rc;
00146   fsal_status_t       status;
00147   fsal_attrib_list_t  attrs ;
00148   
00149   hpss_fileattrbits_t  hpss_attr_mask;
00150   hpss_fileattr_t      hpss_fattr_in, hpss_fattr_out ;  
00151   
00152   <span class="comment">/* sanity checks.</span>
00153 <span class="comment">   * note : object_attributes is optional.</span>
00154 <span class="comment">   */</span>
00155   <span class="keywordflow">if</span> (!filehandle || !p_context || !attrib_set)
00156     Return( ERR_FSAL_FAULT ,0 , INDEX_FSAL_setattrs);
00157     
00158   <span class="comment">/* local copy of attributes */</span>  
00159   attrs = *attrib_set ;
00160   
00161   <span class="comment">/* First, check that FSAL attributes changes are allowed. */</span>
00162   
00163   <span class="comment">/* Is it allowed to change times ? */</span>  
00164   
00165   <span class="keywordflow">if</span> ( !global_fs_info.cansettime ){
00166 
00167       <span class="keywordflow">if</span> ( attrs.asked_attributes
00168            &amp;
00169            ( FSAL_ATTR_ATIME | FSAL_ATTR_CREATION
00170             | FSAL_ATTR_CTIME | FSAL_ATTR_MTIME )
00171          )
00172       {
00173         
00174         <span class="comment">/* handled as an unsettable attribute. */</span>
00175         Return( ERR_FSAL_INVAL, 0, INDEX_FSAL_setattrs );
00176       }
00177           
00178   }
00179   
00180     
00181   <span class="comment">/* apply umask, if mode attribute is to be changed */</span>
00182   
00183   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_MODE ) ){
00184      attrs.mode &amp;= (~global_fs_info.umask) ;
00185   }
00186 
00187   
00191   <span class="comment">/* init variables */</span>
00192   memset(&amp;hpss_fattr_in,0,<span class="keyword">sizeof</span>(hpss_fileattr_t));
00193   
00194   hpss_fattr_in.ObjectHandle = filehandle-&gt;ns_handle;
00195 
00196   
00197   <span class="comment">/* Then, convert attribute set. */</span>
00198   
00199   status = <a class="code" href="fsal__convert_8c.html#a16">fsal2hpss_attribset</a>( filehandle,
00200                                 &amp;attrs ,
00201                                 &amp;hpss_attr_mask ,
00202                                 &amp;(hpss_fattr_in.Attrs) );
00203 
00204   
00205   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status))
00206       Return(status.major,status.minor,INDEX_FSAL_setattrs);
00207   
00208   <span class="comment">/* Call HPSS client API function. */</span>
00209   
00210   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00211   
00212   rc = HPSSFSAL_FileSetAttrHandle(
00213             &amp;(filehandle-&gt;ns_handle),   <span class="comment">/* IN  - object handle */</span>
00214             NULL,                       <span class="comment">/* IN  - path to the object */</span>
00215             &amp;(p_context-&gt;credential.hpss_usercred),     <span class="comment">/* IN  - user credentials */</span>
00216             hpss_attr_mask,             <span class="comment">/* IN - attributes fields to set */</span>
00217             &amp;hpss_fattr_in,             <span class="comment">/* IN  - input attributes */</span>
00218             &amp;hpss_fattr_out             <span class="comment">/* OUT - attributes after change */</span>
00219           );
00220   
00221   ReleaseTokenFSCall();
00222   
00223   <span class="comment">/* The HPSS_ENOENT error actually means that handle is STALE */</span>
00224   <span class="keywordflow">if</span> ( rc == HPSS_ENOENT )
00225     Return( ERR_FSAL_STALE, -rc, INDEX_FSAL_setattrs);
00226   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc)
00227     Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_setattrs);
00228 
00229     
00230   <span class="comment">/* Optionaly fills output attributes. */</span>
00231   
00235   <span class="comment">/*</span>
00236 <span class="comment">   * HPSS only fills the modified attribute in hpss_fattr_out.</span>
00237 <span class="comment">   * Thus, if the modified attributes equal the attributes to be returned</span>
00238 <span class="comment">   * there is no need to proceed a getattr.</span>
00239 <span class="comment">   */</span>
00240   <span class="keywordflow">if</span> ( object_attributes &amp;&amp;
00241        ( object_attributes-&gt;asked_attributes == attrib_set-&gt;asked_attributes ))
00242   {
00243     
00244     <span class="comment">/* caution: hpss_fattr_out.ObjectHandle is not filled. */</span>
00245     
00246     status = <a class="code" href="fsal__convert_8c.html#a14">hpss2fsal_attributes</a>( &amp;(filehandle-&gt;ns_handle),
00247                                    &amp;(hpss_fattr_out.Attrs),
00248                                    object_attributes ) ;
00249        
00250     <span class="comment">/* on error, we set a special bit in the mask. */</span>        
00251     <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00252     {
00253       FSAL_CLEAR_MASK( object_attributes-&gt;asked_attributes );
00254       FSAL_SET_MASK( object_attributes-&gt;asked_attributes,
00255           FSAL_ATTR_RDATTR_ERR );
00256     }
00257     
00258   }
00259   <span class="comment">/* if more attributes are asked, we have to proceed a getattr. */</span>
00260   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( object_attributes )
00261   {
00262     
00263     status = <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>( filehandle, p_context, object_attributes );    
00264 
00265     <span class="comment">/* on error, we set a special bit in the mask. */</span>        
00266     <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00267     {
00268       FSAL_CLEAR_MASK( object_attributes-&gt;asked_attributes );
00269       FSAL_SET_MASK( object_attributes-&gt;asked_attributes,
00270           FSAL_ATTR_RDATTR_ERR );
00271     }
00272     
00273   }
00274   
00275   
00276   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_setattrs);
00277   
00278 }
00279 
00280 
00281 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
