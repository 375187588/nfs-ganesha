<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: fsal_rcp.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_rcp.c</h1><a href="fsal__rcp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 <span class="preprocessor">#include "stuff_alloc.h"</span>
00022 
00023 
00024 
<a name="l00058"></a><a class="code" href="fsal__rcp_8c.html#a1">00058</a> fsal_status_t  <a class="code" href="fsal__rcp_8c.html#a1">FSAL_rcp</a>(
00059     fsal_handle_t             * filehandle,         <span class="comment">/* IN */</span>
00060     fsal_op_context_t         * p_context,          <span class="comment">/* IN */</span>
00061     fsal_path_t               * p_local_path,       <span class="comment">/* IN */</span>
00062     fsal_rcpflag_t            transfer_opt          <span class="comment">/* IN */</span>
00063 ){
00064 
00065   <span class="keywordtype">int</span> local_fd;
00066   <span class="keywordtype">int</span> local_flags;
00067   
00068   fsal_file_t       fs_fd;
00069   fsal_openflags_t  fs_flags;
00070   
00071   fsal_status_t     st = FSAL_STATUS_NO_ERROR;
00072   
00073   <span class="comment">/* default buffer size for RCP: 1MB */</span>
00074 <span class="preprocessor">#define RCP_BUFFER_SIZE 1048576</span>
00075 <span class="preprocessor"></span>  caddr_t  IObuffer;
00076   
00077   <span class="keywordtype">int</span> to_local = FALSE;
00078   <span class="keywordtype">int</span> to_fs = FALSE;
00079   
00080   <span class="keywordtype">int</span> eof = FALSE;
00081   
00082   ssize_t     local_size = 0;
00083   fsal_size_t fs_size;  
00084   
00085   <span class="comment">/* sanity checks.*/</span>
00086   
00087   <span class="keywordflow">if</span> ( !filehandle || !p_context || !p_local_path )
00088     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_rcp);
00089 
00090   
00091   to_local = (( transfer_opt &amp; FSAL_RCP_FS_TO_LOCAL ) == FSAL_RCP_FS_TO_LOCAL );
00092   to_fs =    (( transfer_opt &amp; FSAL_RCP_LOCAL_TO_FS ) == FSAL_RCP_LOCAL_TO_FS );
00093     
00094   
00095 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00096 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (to_local)
00097     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00098         <span class="stringliteral">"FSAL_rcp: FSAL -&gt; local file (%s)"</span>, p_local_path-&gt;path );
00099   
00100   <span class="keywordflow">if</span> (to_fs)
00101     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00102         <span class="stringliteral">"FSAL_rcp: local file -&gt; FSAL (%s)"</span>, p_local_path-&gt;path);
00103 <span class="preprocessor">#endif  </span>
00104 <span class="preprocessor"></span>      
00105   <span class="comment">/* must give the sens of transfert (exactly one)*/</span>
00106   
00107   <span class="keywordflow">if</span> ( ( !to_local &amp;&amp; !to_fs ) || ( to_local &amp;&amp; to_fs ) )
00108     Return(ERR_FSAL_INVAL ,0 , INDEX_FSAL_rcp);
00109   
00110   <span class="comment">/* first, open local file with the correct flags */</span>
00111   
00112   <span class="keywordflow">if</span> ( to_fs )
00113   {  
00114     local_flags = O_RDONLY;
00115   }
00116   <span class="keywordflow">else</span> 
00117   {  
00118     local_flags = O_WRONLY | O_TRUNC;
00119     
00120     <span class="keywordflow">if</span> (( transfer_opt &amp; FSAL_RCP_LOCAL_CREAT) == FSAL_RCP_LOCAL_CREAT )
00121       local_flags |= O_CREAT;
00122       
00123     <span class="keywordflow">if</span> (( transfer_opt &amp; FSAL_RCP_LOCAL_EXCL) == FSAL_RCP_LOCAL_EXCL )
00124       local_flags |= O_EXCL;
00125     
00126   }
00127   
00128   
00129 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00130 <span class="preprocessor"></span>  {
00131     
00132     <span class="keywordtype">char</span> msg[1024];
00133     
00134     msg[0]=<span class="charliteral">'\0'</span>;
00135     
00136     <span class="keywordflow">if</span> (( local_flags &amp; O_RDONLY ) == O_RDONLY)
00137       strcat( msg, <span class="stringliteral">"O_RDONLY "</span>);
00138 
00139     <span class="keywordflow">if</span> (( local_flags &amp; O_WRONLY ) == O_WRONLY)
00140       strcat( msg, <span class="stringliteral">"O_WRONLY "</span>);
00141 
00142     <span class="keywordflow">if</span> (( local_flags &amp; O_TRUNC ) == O_TRUNC)
00143       strcat( msg, <span class="stringliteral">"O_TRUNC "</span>);
00144 
00145     <span class="keywordflow">if</span> (( local_flags &amp; O_CREAT ) == O_CREAT)
00146       strcat( msg, <span class="stringliteral">"O_CREAT "</span>);
00147 
00148     <span class="keywordflow">if</span> (( local_flags &amp; O_EXCL ) == O_EXCL)
00149       strcat( msg, <span class="stringliteral">"O_EXCL "</span>);
00150 
00151     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Openning local file %s with flags: %s"</span>,
00152         p_local_path-&gt;path, msg);
00153 
00154   }
00155 <span class="preprocessor">#endif</span>
00156 <span class="preprocessor"></span>  
00157   local_fd = open( p_local_path-&gt;path, local_flags, 0644 );
00158   
00159   <span class="keywordflow">if</span> ( local_fd == -1 )
00160   {
00161     Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(errno) , errno , INDEX_FSAL_rcp );
00162   }
00163   
00164   
00165   <span class="comment">/* call FSAL_open with the correct flags */</span>
00166   
00167   <span class="keywordflow">if</span> ( to_fs )
00168   {  
00169     fs_flags = FSAL_O_WRONLY | FSAL_O_TRUNC;
00170     
00171     <span class="comment">/* invalid flags for local to filesystem */</span>
00172     
00173     <span class="keywordflow">if</span> ( (( transfer_opt &amp; FSAL_RCP_LOCAL_CREAT) == FSAL_RCP_LOCAL_CREAT )
00174           ||
00175          (( transfer_opt &amp; FSAL_RCP_LOCAL_EXCL) == FSAL_RCP_LOCAL_EXCL )
00176         )
00177     {
00178       <span class="comment">/* clean &amp; return */</span>
00179       close( local_fd );
00180       Return(ERR_FSAL_INVAL ,0 , INDEX_FSAL_rcp);
00181     }
00182   }
00183   <span class="keywordflow">else</span> 
00184   {
00185     fs_flags = FSAL_O_RDONLY;
00186   }
00187 
00188   
00189 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00190 <span class="preprocessor"></span>  {
00191     
00192     <span class="keywordtype">char</span> msg[1024];
00193     
00194     msg[0]=<span class="charliteral">'\0'</span>;
00195     
00196     <span class="keywordflow">if</span> (( fs_flags &amp; FSAL_O_RDONLY ) == FSAL_O_RDONLY)
00197       strcat( msg, <span class="stringliteral">"FSAL_O_RDONLY "</span>);
00198 
00199     <span class="keywordflow">if</span> (( fs_flags &amp; FSAL_O_WRONLY ) == FSAL_O_WRONLY)
00200       strcat( msg, <span class="stringliteral">"FSAL_O_WRONLY "</span>);
00201 
00202     <span class="keywordflow">if</span> (( fs_flags &amp; FSAL_O_TRUNC ) == FSAL_O_TRUNC)
00203       strcat( msg, <span class="stringliteral">"FSAL_O_TRUNC "</span>);
00204 
00205     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00206         <span class="stringliteral">"Openning FSAL file with flags: %s"</span>, msg);
00207 
00208   }
00209 <span class="preprocessor">#endif</span>
00210 <span class="preprocessor"></span>      
00211   st = <a class="code" href="fsal__fileop_8c.html#a1">FSAL_open</a>( filehandle, p_context, fs_flags, &amp;fs_fd, NULL );
00212 
00213   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st ))
00214   {
00215     <span class="comment">/* clean &amp; return */</span>
00216       close( local_fd );
00217       Return(st.major ,st.minor , INDEX_FSAL_rcp);
00218   }
00219   
00220 
00221 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00222 <span class="preprocessor"></span>    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00223         <span class="stringliteral">"Allocating IO buffer of size %llu"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) RCP_BUFFER_SIZE);
00224 <span class="preprocessor">#endif</span>
00225 <span class="preprocessor"></span>  
00226   <span class="comment">/* Allocates buffer */</span>
00227   
00228   IObuffer = (caddr_t) Mem_Alloc( RCP_BUFFER_SIZE );
00229   
00230   <span class="keywordflow">if</span> ( IObuffer == NULL )
00231   {
00232     <span class="comment">/* clean &amp; return */</span>    
00233     close( local_fd );    
00234     <a class="code" href="fsal__fileop_8c.html#a4">FSAL_close</a>( &amp;fs_fd );    
00235     Return( ERR_FSAL_NOMEM , Mem_Errno, INDEX_FSAL_rcp );
00236   }
00237   
00238   
00239   <span class="comment">/* read/write loop */</span>
00240   
00241   <span class="keywordflow">while</span> ( !eof )
00242   {
00243     <span class="comment">/* initialize error code */</span>
00244     st = FSAL_STATUS_NO_ERROR;
00245 
00246     
00247 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00248 <span class="preprocessor"></span>    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Read a block from source"</span>);
00249 <span class="preprocessor">#endif</span>
00250 <span class="preprocessor"></span>            
00251     <span class="comment">/* read */</span>
00252     
00253     <span class="keywordflow">if</span> ( to_fs ) <span class="comment">/* from local filesystem */</span>
00254     {
00255       local_size = read( local_fd, IObuffer, RCP_BUFFER_SIZE );
00256       
00257       <span class="keywordflow">if</span> ( local_size == -1 )
00258       {
00259         st.major = ERR_FSAL_IO;
00260         st.minor = errno;
00261         <span class="keywordflow">break</span>; <span class="comment">/* exit loop */</span>
00262       }
00263       
00264       eof = ( local_size == 0 );
00265       
00266     }
00267     <span class="keywordflow">else</span> <span class="comment">/* from FSAL filesystem */</span>
00268     {
00269       fs_size = 0;
00270       st = <a class="code" href="fsal__fileop_8c.html#a2">FSAL_read</a>( &amp;fs_fd, NULL, RCP_BUFFER_SIZE, IObuffer, &amp;fs_size, &amp;eof );
00271       
00272       <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )) <span class="keywordflow">break</span>; <span class="comment">/* exit loop */</span>
00273       
00274     }
00275     
00276     <span class="comment">/* write (if not eof) */</span>
00277     
00278     <span class="keywordflow">if</span> ( !eof || ((!to_fs) &amp;&amp; (fs_size&gt;0)) )
00279     {
00280       
00281 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00282 <span class="preprocessor"></span>    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Write a block to destination"</span>);
00283 <span class="preprocessor">#endif</span>
00284 <span class="preprocessor"></span>      
00285       <span class="keywordflow">if</span> ( to_fs ) <span class="comment">/* to FSAL filesystem */</span>
00286       {
00287         
00288         st = <a class="code" href="fsal__fileop_8c.html#a3">FSAL_write</a>( &amp;fs_fd, NULL, local_size, IObuffer, &amp;fs_size );
00289        
00290         <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )) <span class="keywordflow">break</span>; <span class="comment">/* exit loop */</span>
00291         
00292       }
00293       <span class="keywordflow">else</span>  <span class="comment">/* to local filesystem */</span>
00294       {
00295        
00296         local_size = write( local_fd, IObuffer, fs_size );
00297 
00298         <span class="keywordflow">if</span> ( local_size == -1 )
00299         {
00300           st.major = ERR_FSAL_IO;
00301           st.minor = errno;
00302           <span class="keywordflow">break</span>; <span class="comment">/* exit loop */</span>
00303         }
00304         
00305       }<span class="comment">/* if to_fs */</span>
00306       
00307     }<span class="comment">/* if eof */</span>
00308 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00309 <span class="preprocessor"></span>    <span class="keywordflow">else</span>
00310       DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"End of source file reached"</span>);
00311 <span class="preprocessor">#endif    </span>
00312 <span class="preprocessor"></span>    
00313   }<span class="comment">/* while !eof */</span>
00314   
00315   
00316   <span class="comment">/* Clean */</span>
00317   
00318   Mem_Free( IObuffer );
00319   close( local_fd );
00320   <a class="code" href="fsal__fileop_8c.html#a4">FSAL_close</a>( &amp;fs_fd );
00321   
00322   <span class="comment">/* return status. */</span>
00323   
00324   Return(st.major ,st.minor , INDEX_FSAL_rcp);
00325 }
00326 
00327 
00328 fsal_status_t  FSAL_rcp_by_fileid(
00329     fsal_handle_t             * filehandle,         <span class="comment">/* IN */</span>
00330     fsal_u64_t                  fileid,             <span class="comment">/* IN */</span>
00331     fsal_op_context_t         * p_context,          <span class="comment">/* IN */</span>
00332     fsal_path_t               * p_local_path,       <span class="comment">/* IN */</span>
00333     fsal_rcpflag_t            transfer_opt          <span class="comment">/* IN */</span> )
00334 {
00335    Return( ERR_FSAL_NOTSUPP, 0, INDEX_FSAL_open_by_fileid ) ;
00336 }
00337 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
