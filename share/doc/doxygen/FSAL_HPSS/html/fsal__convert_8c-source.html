<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: fsal_convert.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_convert.c</h1><a href="fsal__convert_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#include "fsal_convert.h"</span>
00018 <span class="preprocessor">#include "fsal_internal.h"</span>
00019 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00020 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00021 
00022 
00023 <span class="preprocessor">#define MAX_2( x, y )    ( (x) &gt; (y) ? (x) : (y) )</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#define MAX_3( x, y, z ) ( (x) &gt; (y) ? MAX_2((x),(z)) : MAX_2((y),(z)) )</span>
00025 <span class="preprocessor"></span>
00026 
<a name="l00038"></a><a class="code" href="fsal__convert_8c.html#a2">00038</a> <span class="keywordtype">int</span> <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(<span class="keywordtype">int</span> hpss_errorcode){
00039     
00040   <span class="keywordflow">switch</span>(hpss_errorcode){
00041     
00042     <span class="keywordflow">case</span> HPSS_E_NOERROR:
00043         <span class="keywordflow">return</span> ERR_FSAL_NO_ERROR;
00044     
00045     <span class="keywordflow">case</span> EPERM:
00046     <span class="keywordflow">case</span> HPSS_EPERM:
00047       <span class="keywordflow">return</span> ERR_FSAL_PERM;
00048     
00049     <span class="keywordflow">case</span> ENOENT:
00050     <span class="keywordflow">case</span> HPSS_ENOENT:
00051       <span class="keywordflow">return</span> ERR_FSAL_NOENT;
00052     
00053     
00054     <span class="comment">/* connection error */</span>
00055 <span class="preprocessor">#ifdef _AIX_5</span>
00056 <span class="preprocessor"></span>    <span class="keywordflow">case</span> ENOCONNECT:
00057 <span class="preprocessor">#elif defined _LINUX</span>
00058 <span class="preprocessor"></span>    <span class="keywordflow">case</span> ECONNREFUSED:
00059     <span class="keywordflow">case</span> ECONNABORTED:
00060     <span class="keywordflow">case</span> ECONNRESET:
00061 <span class="preprocessor">#endif            </span>
00062 <span class="preprocessor"></span>    <span class="keywordflow">case</span> HPSS_ECONN:
00063       
00064     <span class="comment">/* IO error */</span>
00065     <span class="keywordflow">case</span> EIO:
00066     <span class="keywordflow">case</span> HPSS_EIO:
00067       
00068     <span class="comment">/* too many open files */</span>
00069     <span class="keywordflow">case</span> ENFILE:
00070     <span class="keywordflow">case</span> HPSS_ENFILE:
00071     <span class="keywordflow">case</span> EMFILE:
00072     <span class="keywordflow">case</span> HPSS_EMFILE:
00073     
00074     <span class="comment">/* broken pipe */</span>
00075     <span class="keywordflow">case</span> EPIPE:
00076     <span class="keywordflow">case</span> HPSS_EPIPE:
00077       
00078       <span class="comment">/* all shown as IO errors */</span>
00079       <span class="keywordflow">return</span> ERR_FSAL_IO;
00080       
00081     
00082     <span class="comment">/* no such device */</span>
00083     <span class="keywordflow">case</span> ENODEV :
00084     <span class="keywordflow">case</span> HPSS_ENODEV :
00085     <span class="keywordflow">case</span> ENXIO:
00086     <span class="keywordflow">case</span> HPSS_ENXIO:
00087       <span class="keywordflow">return</span> ERR_FSAL_NXIO;
00088     
00089     <span class="comment">/* invalid file descriptor : */</span>
00090     <span class="keywordflow">case</span> EBADF:
00091     <span class="keywordflow">case</span> HPSS_EBADF:
00092       <span class="comment">/* we suppose it was not opened... */</span>
00093       
00101       <span class="keywordflow">return</span> ERR_FSAL_NOT_OPENED ;
00102       
00103       
00104     <span class="keywordflow">case</span> ENOMEM:
00105     <span class="keywordflow">case</span> HPSS_ENOMEM: 
00106       <span class="keywordflow">return</span> ERR_FSAL_NOMEM;
00107       
00108     <span class="keywordflow">case</span> EACCES:
00109     <span class="keywordflow">case</span> HPSS_EACCES:
00110       <span class="keywordflow">return</span> ERR_FSAL_ACCESS;
00111     
00112     <span class="keywordflow">case</span> EFAULT:
00113     <span class="keywordflow">case</span> HPSS_EFAULT:
00114       <span class="keywordflow">return</span> ERR_FSAL_FAULT;
00115  
00116     <span class="keywordflow">case</span> EEXIST:
00117     <span class="keywordflow">case</span> HPSS_EEXIST:
00118       <span class="keywordflow">return</span> ERR_FSAL_EXIST;
00119       
00120     <span class="keywordflow">case</span> EXDEV :
00121     <span class="keywordflow">case</span> HPSS_EXDEV :
00122       <span class="keywordflow">return</span> ERR_FSAL_XDEV;
00123    
00124     <span class="keywordflow">case</span> ENOTDIR:
00125     <span class="keywordflow">case</span> HPSS_ENOTDIR:
00126       <span class="keywordflow">return</span> ERR_FSAL_NOTDIR;
00127     
00128     <span class="keywordflow">case</span> EISDIR:
00129     <span class="keywordflow">case</span> HPSS_EISDIR:
00130       <span class="keywordflow">return</span> ERR_FSAL_ISDIR;
00131       
00132     <span class="keywordflow">case</span> EINVAL:
00133     <span class="keywordflow">case</span> HPSS_EINVAL:
00134       <span class="keywordflow">return</span> ERR_FSAL_INVAL;
00135     
00136     <span class="keywordflow">case</span> EFBIG:
00137     <span class="keywordflow">case</span> HPSS_EFBIG:
00138       <span class="keywordflow">return</span> ERR_FSAL_FBIG;
00139       
00140     <span class="keywordflow">case</span> ENOSPC:
00141     <span class="keywordflow">case</span> HPSS_ENOSPACE:
00142       <span class="keywordflow">return</span> ERR_FSAL_NOSPC;
00143       
00144     <span class="keywordflow">case</span> EMLINK:
00145     <span class="keywordflow">case</span> HPSS_EMLINK:
00146       <span class="keywordflow">return</span> ERR_FSAL_MLINK;
00147     
00148     <span class="keywordflow">case</span> EDQUOT:
00149     <span class="keywordflow">case</span> HPSS_EDQUOT:
00150       <span class="keywordflow">return</span> ERR_FSAL_DQUOT;
00151     
00152     <span class="keywordflow">case</span> ENAMETOOLONG:
00153     <span class="keywordflow">case</span> HPSS_ENAMETOOLONG:
00154       <span class="keywordflow">return</span> ERR_FSAL_NAMETOOLONG;
00155 
00162 <span class="preprocessor">#ifdef _AIX</span>
00163 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 87:
00164 <span class="preprocessor">#else</span>
00165 <span class="preprocessor"></span>    <span class="keywordflow">case</span> ENOTEMPTY:
00166     <span class="keywordflow">case</span> -ENOTEMPTY:
00167 <span class="preprocessor">#endif      </span>
00168 <span class="preprocessor"></span>    <span class="keywordflow">case</span> HPSS_ENOTEMPTY:
00169       <span class="keywordflow">return</span> ERR_FSAL_NOTEMPTY;      
00170       
00171     <span class="keywordflow">case</span> ESTALE:
00172     <span class="keywordflow">case</span> HPSS_ESTALE:
00173       <span class="keywordflow">return</span> ERR_FSAL_STALE ;
00174           
00175     
00176     <span class="comment">/* Error code that needs a retry */</span>
00177     <span class="keywordflow">case</span> EAGAIN :
00178     <span class="keywordflow">case</span> HPSS_EAGAIN :
00179     <span class="keywordflow">case</span> EBUSY :
00180     <span class="keywordflow">case</span> HPSS_EBUSY :
00181 
00182       <span class="keywordflow">return</span> ERR_FSAL_DELAY;
00183 
00184     <span class="keywordflow">default</span>:
00185       
00186 <span class="preprocessor">#ifdef _USE_HPSS_51</span>
00187 <span class="preprocessor"></span>        
00188       <span class="comment">/* hsec error code regarding security (-3000...)*/</span>
00189       <span class="keywordflow">if</span> ( ( hpss_errorcode &lt;= -3000 ) &amp;&amp; ( hpss_errorcode &gt; -4000 ))
00190         <span class="keywordflow">return</span> ERR_FSAL_SEC;
00191     
00192 <span class="preprocessor">#elif  defined _USE_HPSS_62</span>
00193 <span class="preprocessor"></span>    
00194       <span class="comment">/* hsec error code regarding security (-11000...)*/</span>
00195       <span class="keywordflow">if</span> ( ( hpss_errorcode &lt;= HPSS_SEC_ENOT_AUTHORIZED )
00196           &amp;&amp; ( hpss_errorcode &gt;= HPSS_SEC_LDAP_ERROR ) )
00197         <span class="keywordflow">return</span> ERR_FSAL_SEC;      
00198 <span class="preprocessor">#endif</span>
00199 <span class="preprocessor"></span>      
00200       <span class="comment">/* other unexpected errors */</span>    
00201       <span class="keywordflow">return</span> ERR_FSAL_SERVERFAULT;
00202     
00203   }
00204   
00205 }
00206 
00207 
00208 
<a name="l00218"></a><a class="code" href="fsal__convert_8c.html#a3">00218</a> <span class="keywordtype">int</span>  <a class="code" href="fsal__convert_8c.html#a3">fsal2hpss_testperm</a>(fsal_accessflags_t testperm){
00219   
00220   <span class="keywordtype">int</span> hpss_testperm = 0;
00221   
00222   <span class="keywordflow">if</span> (testperm &amp; FSAL_R_OK) hpss_testperm |= R_OK;
00223   <span class="keywordflow">if</span> (testperm &amp; FSAL_W_OK) hpss_testperm |= W_OK;
00224   <span class="keywordflow">if</span> (testperm &amp; FSAL_X_OK) hpss_testperm |= X_OK;
00225   <span class="keywordflow">if</span> (testperm &amp; FSAL_F_OK) hpss_testperm |= F_OK;
00226   
00227   <span class="keywordflow">return</span> hpss_testperm;
00228   
00229 }
00230 
00231 
<a name="l00245"></a><a class="code" href="fsal__convert_8c.html#a4">00245</a> <span class="keywordtype">int</span>   <a class="code" href="fsal__convert_8c.html#a4">fsal2hpss_openflags</a>( fsal_openflags_t fsal_flags, <span class="keywordtype">int</span> * p_hpss_flags )
00246 { 
00247   <span class="keywordtype">int</span> cpt;
00248   
00249   <span class="keywordflow">if</span> (!p_hpss_flags) <span class="keywordflow">return</span> ERR_FSAL_FAULT;
00250   
00251   <span class="comment">/* check that all used flags exist */</span>
00252   
00253   <span class="keywordflow">if</span> ( fsal_flags &amp;
00254        ~( FSAL_O_RDONLY | FSAL_O_RDWR | FSAL_O_WRONLY | FSAL_O_APPEND | FSAL_O_TRUNC ))
00255     <span class="keywordflow">return</span> ERR_FSAL_INVAL;
00256   
00257   <span class="comment">/* Check for flags compatibility */</span>
00258   
00259   <span class="comment">/* O_RDONLY O_WRONLY O_RDWR cannot be used together */</span>
00260   
00261   cpt = 0;
00262   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_RDONLY ) cpt ++;
00263   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_RDWR )   cpt ++;
00264   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_WRONLY ) cpt ++;
00265   
00266   <span class="keywordflow">if</span> ( cpt &gt; 1 ) <span class="keywordflow">return</span> ERR_FSAL_INVAL;
00267     
00268   <span class="comment">/* FSAL_O_APPEND et FSAL_O_TRUNC cannot be used together */</span>
00269   
00270   <span class="keywordflow">if</span> ( (fsal_flags &amp; FSAL_O_APPEND) &amp;&amp; (fsal_flags &amp; FSAL_O_TRUNC) )
00271     <span class="keywordflow">return</span> ERR_FSAL_INVAL;  
00272   
00273   <span class="comment">/* FSAL_O_TRUNC without FSAL_O_WRONLY or FSAL_O_RDWR */</span>
00274   
00275   <span class="keywordflow">if</span> ( (fsal_flags &amp; FSAL_O_TRUNC) &amp;&amp; !( fsal_flags &amp; (FSAL_O_WRONLY | FSAL_O_RDWR) ))
00276     <span class="keywordflow">return</span> ERR_FSAL_INVAL;
00277   
00278   <span class="comment">/* conversion */</span>  
00279   
00280   *p_hpss_flags = 0;
00281   
00282   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_RDONLY )  *p_hpss_flags |= O_RDONLY;
00283   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_RDWR )    *p_hpss_flags |= O_RDWR;
00284   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_WRONLY )  *p_hpss_flags |= O_WRONLY;
00285   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_APPEND )  *p_hpss_flags |= O_APPEND;
00286   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_TRUNC )   *p_hpss_flags |= O_TRUNC;
00287   
00288   <span class="keywordflow">return</span> ERR_FSAL_NO_ERROR;
00289   
00290 }
00291 
00292 
00293 
00294 
<a name="l00304"></a><a class="code" href="fsal__convert_8c.html#a5">00304</a> mode_t <a class="code" href="fsal__convert_8c.html#a5">fsal2unix_mode</a>( fsal_accessmode_t fsal_mode ){
00305   
00306   mode_t  out_mode = 0;
00307   
00308   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_SUID) ) out_mode |= S_ISUID ;
00309   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_SGID) ) out_mode |= S_ISGID ;
00310   
00311   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_RUSR) ) out_mode |= S_IRUSR ;
00312   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_WUSR) ) out_mode |= S_IWUSR ;
00313   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_XUSR) ) out_mode |= S_IXUSR ;
00314   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_RGRP) ) out_mode |= S_IRGRP ;
00315   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_WGRP) ) out_mode |= S_IWGRP ;
00316   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_XGRP) ) out_mode |= S_IXGRP ;
00317   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_ROTH) ) out_mode |= S_IROTH ;
00318   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_WOTH) ) out_mode |= S_IWOTH ;
00319   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_XOTH) ) out_mode |= S_IXOTH ;
00320   
00321   <span class="keywordflow">return</span> out_mode;
00322   
00323 }
00324 
00325 
00326 
<a name="l00336"></a><a class="code" href="fsal__convert_8c.html#a6">00336</a> fsal_accessmode_t <a class="code" href="fsal__convert_8c.html#a6">unix2fsal_mode</a>(  mode_t unix_mode ){
00337 
00338     fsal_accessmode_t fsalmode = 0;
00339     
00340     <span class="keywordflow">if</span> ( unix_mode &amp; S_ISUID ) fsalmode|= FSAL_MODE_SUID;
00341     <span class="keywordflow">if</span> ( unix_mode &amp; S_ISGID ) fsalmode|= FSAL_MODE_SGID;
00342     
00343     <span class="keywordflow">if</span> ( unix_mode &amp; S_IRUSR ) fsalmode|= FSAL_MODE_RUSR;
00344     <span class="keywordflow">if</span> ( unix_mode &amp; S_IWUSR ) fsalmode|= FSAL_MODE_WUSR;
00345     <span class="keywordflow">if</span> ( unix_mode &amp; S_IXUSR ) fsalmode|= FSAL_MODE_XUSR;
00346 
00347     <span class="keywordflow">if</span> ( unix_mode &amp; S_IRGRP ) fsalmode|= FSAL_MODE_RGRP;
00348     <span class="keywordflow">if</span> ( unix_mode &amp; S_IWGRP ) fsalmode|= FSAL_MODE_WGRP;
00349     <span class="keywordflow">if</span> ( unix_mode &amp; S_IXGRP ) fsalmode|= FSAL_MODE_XGRP;
00350 
00351     <span class="keywordflow">if</span> ( unix_mode &amp; S_IROTH ) fsalmode|= FSAL_MODE_ROTH;
00352     <span class="keywordflow">if</span> ( unix_mode &amp; S_IWOTH ) fsalmode|= FSAL_MODE_WOTH;
00353     <span class="keywordflow">if</span> ( unix_mode &amp; S_IXOTH ) fsalmode|= FSAL_MODE_XOTH;
00354     
00355     <span class="keywordflow">return</span> fsalmode;
00356     
00357 }  
00358     
00359 
<a name="l00370"></a><a class="code" href="fsal__convert_8c.html#a7">00370</a> fsal_nodetype_t  <a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>(unsigned32  hpss_type_in){
00371 
00372   <span class="keywordflow">switch</span>( hpss_type_in ){
00373     
00374     <span class="keywordflow">case</span> NS_OBJECT_TYPE_DIRECTORY:
00375       <span class="keywordflow">return</span> FSAL_TYPE_DIR;
00376       
00377     <span class="keywordflow">case</span> NS_OBJECT_TYPE_HARD_LINK:
00378     <span class="keywordflow">case</span> NS_OBJECT_TYPE_FILE:
00379       <span class="keywordflow">return</span> FSAL_TYPE_FILE;
00380     
00381     <span class="keywordflow">case</span> NS_OBJECT_TYPE_SYM_LINK:
00382       <span class="keywordflow">return</span> FSAL_TYPE_LNK;
00383 
00384     <span class="keywordflow">case</span> NS_OBJECT_TYPE_JUNCTION:
00385       <span class="keywordflow">return</span> FSAL_TYPE_JUNCTION;
00386             
00387     <span class="keywordflow">default</span>:
00388       DisplayLogJdLevel( fsal_log, NIV_EVENT,
00389           <span class="stringliteral">"Unknown object type: %d"</span>,hpss_type_in );
00390       <span class="keywordflow">return</span> -1;
00391   }    
00392   
00393 }
00394 
00395 
00396 
<a name="l00402"></a><a class="code" href="fsal__convert_8c.html#a8">00402</a> fsal_time_t <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>( timestamp_sec_t tsec )
00403 {
00404   fsal_time_t fsaltime;
00405   
00406   fsaltime.seconds = (fsal_uint_t) tsec;
00407   fsaltime.nseconds = 0;
00408   
00409   <span class="keywordflow">return</span> fsaltime;
00410 }
00411 
00412 <span class="comment">/* fsal2hpss_time is a macro */</span>
00413 
00414 
<a name="l00424"></a><a class="code" href="fsal__convert_8c.html#a9">00424</a> fsal_u64_t <a class="code" href="fsal__convert_8c.html#a9">hpss2fsal_64</a>( u_signed64 hpss_size_in ){
00425   
00426   <span class="keywordtype">long</span> <span class="keywordtype">long</span> output_buff;
00427   CONVERT_U64_TO_LONGLONG(hpss_size_in,output_buff);
00428   <span class="keywordflow">return</span> (fsal_u64_t)(output_buff);
00429     
00430 }
00431 
00432 
00433 
<a name="l00443"></a><a class="code" href="fsal__convert_8c.html#a10">00443</a> u_signed64 <a class="code" href="fsal__convert_8c.html#a10">fsal2hpss_64</a>( fsal_u64_t fsal_size_in ){
00444     
00445   u_signed64 output_buff;  
00446   CONVERT_LONGLONG_TO_U64(fsal_size_in,output_buff) ;
00447   
00448   <span class="keywordflow">return</span> output_buff;
00449     
00450 }
00451 
00452 
00453 
<a name="l00463"></a><a class="code" href="fsal__convert_8c.html#a11">00463</a> fsal_fsid_t <a class="code" href="fsal__convert_8c.html#a11">hpss2fsal_fsid</a>( u_signed64 hpss_fsid_in ){
00464   
00465   fsal_fsid_t fsid;
00466   
00467   fsid.major = high32m(hpss_fsid_in);
00468   fsid.minor = low32m(hpss_fsid_in);
00469   
00470   <span class="keywordflow">return</span> fsid;
00471   
00472 }
00473 
00474 
00475 
00476 
<a name="l00496"></a><a class="code" href="fsal__convert_8c.html#a12">00496</a> fsal_accessmode_t <a class="code" href="fsal__convert_8c.html#a12">hpss2fsal_mode</a>( 
00497     unsigned32 uid_bit,
00498     unsigned32 gid_bit,
00499     unsigned32 sticky_bit,
00500     unsigned32 user_perms,
00501     unsigned32 group_perms,
00502     unsigned32 other_perms
00503  ){
00504   
00505   fsal_accessmode_t  out_mode = 0;
00506   
00507   <span class="comment">/* special bits */</span>
00508   <span class="keywordflow">if</span> ( uid_bit ) out_mode |= FSAL_MODE_SUID;
00509   <span class="keywordflow">if</span> ( gid_bit ) out_mode |= FSAL_MODE_SGID;
00510   <span class="keywordflow">if</span> ( sticky_bit ) out_mode |= FSAL_MODE_SVTX;
00511   
00512   <span class="comment">/* user perms */</span>
00513   <span class="keywordflow">if</span> ( user_perms &amp; NS_PERMS_RD )  out_mode |= FSAL_MODE_RUSR ;
00514   <span class="keywordflow">if</span> ( user_perms &amp; NS_PERMS_WR )  out_mode |= FSAL_MODE_WUSR ;
00515   <span class="keywordflow">if</span> ( user_perms &amp; NS_PERMS_XS )  out_mode |= FSAL_MODE_XUSR ;
00516   
00517   <span class="comment">/* group perms */</span>
00518   <span class="keywordflow">if</span> ( group_perms &amp; NS_PERMS_RD )  out_mode |= FSAL_MODE_RGRP ;
00519   <span class="keywordflow">if</span> ( group_perms &amp; NS_PERMS_WR )  out_mode |= FSAL_MODE_WGRP ;
00520   <span class="keywordflow">if</span> ( group_perms &amp; NS_PERMS_XS )  out_mode |= FSAL_MODE_XGRP ;
00521 
00522   <span class="comment">/* other perms */</span>
00523   <span class="keywordflow">if</span> ( other_perms &amp; NS_PERMS_RD )  out_mode |= FSAL_MODE_ROTH ;
00524   <span class="keywordflow">if</span> ( other_perms &amp; NS_PERMS_WR )  out_mode |= FSAL_MODE_WOTH ;
00525   <span class="keywordflow">if</span> ( other_perms &amp; NS_PERMS_XS )  out_mode |= FSAL_MODE_XOTH ;
00526   
00527   <span class="keywordflow">return</span> out_mode;
00528 
00529     
00530 }
00531 
00532 
00533 
00534 
<a name="l00556"></a><a class="code" href="fsal__convert_8c.html#a13">00556</a> <span class="keywordtype">void</span> <a class="code" href="fsal__convert_8c.html#a13">fsal2hpss_mode</a>( 
00557     fsal_accessmode_t fsal_mode,
00558     unsigned32 * uid_bit,
00559     unsigned32 * gid_bit,
00560     unsigned32 * sticky_bit,
00561     unsigned32 * user_perms,
00562     unsigned32 * group_perms,
00563     unsigned32 * other_perms
00564  ){
00565   
00566   <span class="comment">/* init outputs */</span>
00567   
00568   *uid_bit = 0;
00569   *gid_bit = 0;
00570   *sticky_bit = 0;
00571   *user_perms = 0;
00572   *group_perms = 0;
00573   *other_perms = 0;
00574   
00575   <span class="comment">/* special bits */</span>
00576   
00577   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_SUID )  *uid_bit = 1;
00578   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_SGID )  *gid_bit = 1;
00579   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_SVTX )  *sticky_bit = 1;
00580   
00581   <span class="comment">/* user perms */</span>
00582   
00583   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_RUSR  ) *user_perms |= NS_PERMS_RD;
00584   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_WUSR  ) *user_perms |= NS_PERMS_WR;
00585   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_XUSR  ) *user_perms |= NS_PERMS_XS;
00586   
00587   <span class="comment">/* group perms */</span>
00588   
00589   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_RGRP  ) *group_perms |= NS_PERMS_RD;
00590   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_WGRP  ) *group_perms |= NS_PERMS_WR;
00591   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_XGRP  ) *group_perms |= NS_PERMS_XS;
00592   
00593   <span class="comment">/* other perms */</span>
00594   
00595   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_ROTH  ) *other_perms |= NS_PERMS_RD;
00596   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_WOTH  ) *other_perms |= NS_PERMS_WR;
00597   <span class="keywordflow">if</span> ( fsal_mode &amp; FSAL_MODE_XOTH  ) *other_perms |= NS_PERMS_XS;
00598   
00599   return ;
00600     
00601 }
00602 
00603 
00604 
00605 
<a name="l00631"></a><a class="code" href="fsal__convert_8c.html#a14">00631</a> fsal_status_t <a class="code" href="fsal__convert_8c.html#a14">hpss2fsal_attributes</a>(  ns_ObjHandle_t * p_hpss_handle_in,
00632                                      hpss_Attrs_t   * p_hpss_attr_in,
00633                                      fsal_attrib_list_t * p_fsalattr_out )
00634  {
00635   
00636   
00637   fsal_attrib_mask_t supp_attr, unsupp_attr ;
00638    
00639   <span class="comment">/* sanity checks */</span>
00640   <span class="keywordflow">if</span> ( ! p_hpss_handle_in ||
00641        ! p_hpss_attr_in   ||
00642        ! p_fsalattr_out   )
00643     ReturnCode(ERR_FSAL_FAULT,0);
00644   
00645   
00646   <span class="keywordflow">if</span>( p_fsalattr_out-&gt;asked_attributes == 0 )
00647     {
00648       p_fsalattr_out-&gt;asked_attributes =  global_fs_info.supported_attrs ;
00649      
00650       DisplayLog( <span class="stringliteral">"Error: p_fsalattr_out-&gt;asked_attributes  valait 0 dans hpss2fsal_attributes line %d, fichier %s"</span>, 
00651           __LINE__, __FILE__ ) ; 
00652     }
00653 
00654   <span class="comment">/* check that asked attributes are supported */</span>
00655   supp_attr = global_fs_info.supported_attrs ;
00656  
00657   unsupp_attr = (p_fsalattr_out-&gt;asked_attributes) &amp; ( ~ supp_attr );
00658 
00659   <span class="keywordflow">if</span> ( unsupp_attr ) {
00660     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00661                   <span class="stringliteral">"Unsupported attributes: %#llX    removing it from asked attributes "</span>,unsupp_attr);
00662      
00663     p_fsalattr_out-&gt;asked_attributes = p_fsalattr_out-&gt;asked_attributes &amp; ( ~ unsupp_attr ) ;   
00664  
00665     <span class="comment">/* ReturnCode( ERR_FSAL_ATTRNOTSUPP, 0 ); */</span>
00666   }
00667   
00668   <span class="comment">/* Fills the output struct */</span>
00669   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00670       FSAL_ATTR_SUPPATTR)){
00671     p_fsalattr_out-&gt;supported_attributes = supp_attr;
00672   }
00673   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00674       FSAL_ATTR_TYPE)){
00675       p_fsalattr_out-&gt;type = 
00676           <a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( p_hpss_handle_in-&gt;Type );
00677   }
00678   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00679       FSAL_ATTR_SIZE)){
00680         p_fsalattr_out-&gt;filesize =
00681             <a class="code" href="fsal__convert_8c.html#a9">hpss2fsal_64</a>( p_hpss_attr_in-&gt;DataLength );
00682   }
00683   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00684       FSAL_ATTR_FSID)){
00685         p_fsalattr_out-&gt;fsid = <a class="code" href="fsal__convert_8c.html#a11">hpss2fsal_fsid</a>(p_hpss_attr_in-&gt;FilesetId );
00686   }
00687   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00688       FSAL_ATTR_ACL)){
00689         
00690     <span class="keywordflow">if</span> ( p_hpss_attr_in-&gt;ExtendedACLs == 0 ){
00691       <span class="keywordtype">int</span> i;
00692       <span class="keywordflow">for</span> (i=0;i&lt;FSAL_MAX_ACL;i++){
00693         p_fsalattr_out-&gt;acls[i].type = FSAL_ACL_EMPTY; <span class="comment">/* empty ACL slot */</span>
00694       }
00695     } <span class="keywordflow">else</span> {
00696       
00699     }    
00700     
00701   }
00702   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00703       FSAL_ATTR_FILEID)){
00704         p_fsalattr_out-&gt;fileid = (fsal_u64_t)
00705                   hpss_GetObjId( p_hpss_handle_in );
00706   }
00707     
00708   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00709       FSAL_ATTR_MODE)){
00710         p_fsalattr_out-&gt;mode = <a class="code" href="fsal__convert_8c.html#a12">hpss2fsal_mode</a>(
00711             p_hpss_attr_in-&gt;SetUIDBit,
00712             p_hpss_attr_in-&gt;SetGIDBit,
00713             p_hpss_attr_in-&gt;SetStickyBit,
00714             p_hpss_attr_in-&gt;UserPerms,
00715             p_hpss_attr_in-&gt;GroupPerms,
00716             p_hpss_attr_in-&gt;OtherPerms
00717           );
00718   }
00719   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00720       FSAL_ATTR_NUMLINKS )){
00721         p_fsalattr_out-&gt;numlinks = p_hpss_attr_in-&gt;LinkCount ;
00722   }
00723   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00724       FSAL_ATTR_OWNER )){
00725         p_fsalattr_out-&gt;owner =  p_hpss_attr_in-&gt;UID ;
00726   }
00727   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00728       FSAL_ATTR_GROUP )){
00729         p_fsalattr_out-&gt;group =  p_hpss_attr_in-&gt;GID ;
00730   }
00731   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00732       FSAL_ATTR_ATIME )){
00733         
00734 <span class="preprocessor">#ifdef _DEBUG_FSAL</span>
00735 <span class="preprocessor"></span>        DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"Getting ATIME:"</span>);
00736         DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tTimeLastRead = %d"</span>, p_hpss_attr_in-&gt;TimeLastRead);
00737         DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tTimeCreated = %d"</span>, p_hpss_attr_in-&gt;TimeCreated);
00738 <span class="preprocessor">#endif</span>
00739 <span class="preprocessor"></span>        
00740         <span class="keywordflow">if</span> ( p_hpss_attr_in-&gt;TimeLastRead != 0 )
00741           p_fsalattr_out-&gt;atime
00742             = <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>(p_hpss_attr_in-&gt;TimeLastRead) ;
00743         <span class="keywordflow">else</span>
00744           p_fsalattr_out-&gt;atime
00745             = <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>(p_hpss_attr_in-&gt;TimeCreated) ;
00746           
00747   }
00748   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00749       FSAL_ATTR_CREATION )){
00750         p_fsalattr_out-&gt;creation
00751             = <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>(p_hpss_attr_in-&gt;TimeCreated) ;
00752   }
00753 
00754   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00755       FSAL_ATTR_CTIME )){
00756         p_fsalattr_out-&gt;ctime
00757             = <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>(p_hpss_attr_in-&gt;TimeModified) ;
00758   }
00759   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00760       FSAL_ATTR_MTIME )){
00761     
00762 <span class="preprocessor">#ifdef _DEBUG_FSAL    </span>
00763 <span class="preprocessor"></span>        DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"Getting MTIME:"</span>);
00764         DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tType = %d"</span>,<a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( p_hpss_handle_in-&gt;Type));
00765         DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tTimeLastWritten = %d"</span>, p_hpss_attr_in-&gt;TimeLastWritten);
00766         DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tTimeModified = %d"</span>, p_hpss_attr_in-&gt;TimeModified);
00767         DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tTimeCreated = %d"</span>, p_hpss_attr_in-&gt;TimeCreated);
00768 <span class="preprocessor">#endif</span>
00769 <span class="preprocessor"></span>
00770         <span class="keywordflow">switch</span> (<a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( p_hpss_handle_in-&gt;Type )){
00771                     
00772           <span class="keywordflow">case</span> FSAL_TYPE_FILE:  
00773           <span class="keywordflow">case</span> FSAL_TYPE_LNK:          
00774             
00775             <span class="keywordflow">if</span> ( p_hpss_attr_in-&gt;TimeLastWritten != 0 )
00776               p_fsalattr_out-&gt;mtime
00777                 = <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>(p_hpss_attr_in-&gt;TimeLastWritten) ;
00778             <span class="keywordflow">else</span>
00779               p_fsalattr_out-&gt;mtime
00780                 = <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>(p_hpss_attr_in-&gt;TimeCreated) ;
00781             <span class="keywordflow">break</span>;
00782             
00783           <span class="keywordflow">case</span> FSAL_TYPE_DIR:
00784           <span class="keywordflow">case</span> FSAL_TYPE_JUNCTION:
00785             
00786             <span class="keywordflow">if</span> ( p_hpss_attr_in-&gt;TimeModified != 0 )
00787               p_fsalattr_out-&gt;mtime
00788                 = <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>(p_hpss_attr_in-&gt;TimeModified) ;
00789             <span class="keywordflow">else</span>
00790               p_fsalattr_out-&gt;mtime
00791                 = <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>(p_hpss_attr_in-&gt;TimeCreated) ;
00792             <span class="keywordflow">break</span>;
00793           
00794           <span class="keywordflow">default</span>:
00795             ReturnCode( ERR_FSAL_SERVERFAULT, 0 );
00796                 
00797         }
00798   }
00799   
00800   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00801       FSAL_ATTR_CHGTIME )){
00802         p_fsalattr_out-&gt;chgtime
00803             = <a class="code" href="fsal__convert_8c.html#a8">hpss2fsal_time</a>( MAX_3(p_hpss_attr_in-&gt;TimeModified,p_hpss_attr_in-&gt;TimeCreated, p_hpss_attr_in-&gt;TimeLastWritten) );
00804   }
00805   
00806   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00807       FSAL_ATTR_SPACEUSED )){
00808         p_fsalattr_out-&gt;spaceused
00809             = <a class="code" href="fsal__convert_8c.html#a9">hpss2fsal_64</a>( p_hpss_attr_in-&gt;DataLength );
00810   }
00811   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00812       FSAL_ATTR_MOUNTFILEID )){
00813           p_fsalattr_out-&gt;mounted_on_fileid = 
00814               <a class="code" href="fsal__convert_8c.html#a9">hpss2fsal_64</a>( p_hpss_attr_in-&gt;FilesetRootId );
00815   }
00816 
00817   <span class="comment">/* everything has been copied ! */</span>
00818   
00819   ReturnCode( ERR_FSAL_NO_ERROR, 0 );
00820   
00821   
00822 }
00823 
00824 
00825 
00826 
00827 
<a name="l00848"></a><a class="code" href="fsal__convert_8c.html#a15">00848</a> fsal_status_t  <a class="code" href="fsal__convert_8c.html#a15">hpssHandle2fsalAttributes</a>( ns_ObjHandle_t * p_hpsshandle_in,
00849                                           fsal_attrib_list_t * p_fsalattr_out ){
00850   
00851   fsal_attrib_mask_t avail_attr, unavail_attr ;
00852    
00853   <span class="comment">/* sanity check */</span>
00854   <span class="keywordflow">if</span> (!p_hpsshandle_in || !p_fsalattr_out) ReturnCode(ERR_FSAL_FAULT,0);
00855 
00856     
00857   <span class="comment">/* check that asked attributes are available */</span>
00858   avail_attr = (   
00859         FSAL_ATTR_SUPPATTR | FSAL_ATTR_TYPE |  FSAL_ATTR_FILEID
00860       );
00861   
00862   unavail_attr = (p_fsalattr_out-&gt;asked_attributes) &amp; ( ~ avail_attr );
00863   <span class="keywordflow">if</span> ( unavail_attr ) {
00864     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00865                   <span class="stringliteral">"Attributes not available: %#llX"</span>,unavail_attr);
00866     ReturnCode( ERR_FSAL_ATTRNOTSUPP, 0 );
00867   }
00868   
00869   <span class="comment">/* Fills the output struct */</span>
00870   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00871       FSAL_ATTR_SUPPATTR)){
00872     p_fsalattr_out-&gt;supported_attributes = global_fs_info.supported_attrs;
00873   }
00874   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00875       FSAL_ATTR_TYPE)){
00876       p_fsalattr_out-&gt;type = 
00877           <a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( p_hpsshandle_in-&gt;Type );
00878   }
00879   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00880       FSAL_ATTR_FILEID)){
00881         p_fsalattr_out-&gt;fileid = (fsal_u64_t)
00882                   hpss_GetObjId( p_hpsshandle_in );
00883   }
00884     
00885   <span class="comment">/* everything has been copied ! */</span>
00886   
00887   ReturnCode( ERR_FSAL_NO_ERROR, 0 );
00888    
00889 }
00890 
00891 
00892 
00893 
<a name="l00919"></a><a class="code" href="fsal__convert_8c.html#a16">00919</a> fsal_status_t <a class="code" href="fsal__convert_8c.html#a16">fsal2hpss_attribset</a>(  fsal_handle_t  * p_fsal_handle,
00920                                     fsal_attrib_list_t  * p_attrib_set ,
00921                                     hpss_fileattrbits_t * p_hpss_attrmask,
00922                                     hpss_Attrs_t * p_hpss_attrs  )
00923 {
00924 
00925   fsal_attrib_mask_t  settable_attrs, supp_attrs,
00926                       unavail_attrs, unsettable_attrs;
00927   
00928   <span class="comment">/* sanity check */</span>
00929   
00930   <span class="keywordflow">if</span> ( !p_attrib_set || !p_hpss_attrmask || !p_hpss_attrs )
00931     ReturnCode(ERR_FSAL_FAULT,0);
00932 
00933   <span class="comment">/* init output values */</span>
00934   
00935   memset( p_hpss_attrmask, 0, <span class="keyword">sizeof</span>(hpss_fileattrbits_t) );
00936   memset( p_hpss_attrs, 0, <span class="keyword">sizeof</span>(hpss_Attrs_t) );
00937   
00938     
00941   <span class="comment">/* Supported attributes */</span>
00942   
00943   supp_attrs = global_fs_info.supported_attrs;
00944   
00945   
00946   <span class="comment">/* Settable attrs. */</span>
00947   
00948   settable_attrs =  ( FSAL_ATTR_SIZE  | FSAL_ATTR_ACL |
00949                       FSAL_ATTR_MODE  | FSAL_ATTR_OWNER |
00950                       FSAL_ATTR_GROUP | FSAL_ATTR_ATIME |
00951                       FSAL_ATTR_CTIME | FSAL_ATTR_MTIME );
00952   
00953   
00954   <span class="comment">/* If there are unsupported attributes, return ERR_FSAL_ATTRNOTSUPP */</span> 
00955   
00956   unavail_attrs = ( p_attrib_set-&gt;asked_attributes ) &amp; ( ~ supp_attrs );
00957    
00958   <span class="keywordflow">if</span> ( unavail_attrs ) {
00959     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00960                   <span class="stringliteral">"Attributes not supported: %#llX"</span>,unavail_attrs);
00961 
00962     <span class="comment">/* Error : unsupported attribute. */</span>
00963         
00964     ReturnCode( ERR_FSAL_ATTRNOTSUPP, 0 );
00965   }
00966   
00967   
00968   <span class="comment">/* If there are read-only attributes, return. */</span>
00969   
00970   unsettable_attrs = ( p_attrib_set-&gt;asked_attributes ) &amp; ( ~ settable_attrs );
00971   
00972   <span class="keywordflow">if</span> ( unsettable_attrs ) {
00973     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00974                   <span class="stringliteral">"Read-Only Attributes: %#llX"</span>,unsettable_attrs);
00975 
00976     <span class="comment">/* Error : unsettable attribute. */</span>
00977         
00978     ReturnCode( ERR_FSAL_INVAL, 0 );
00979   }
00980   
00981   
00982   <span class="comment">/* convert settable attributes */</span>
00983   
00984   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( p_attrib_set-&gt;asked_attributes , FSAL_ATTR_SIZE ) ){
00985      
00986     (*p_hpss_attrmask) =
00987         API_AddRegisterValues(*p_hpss_attrmask,CORE_ATTR_DATA_LENGTH,-1);
00988     
00989     p_hpss_attrs-&gt;DataLength = <a class="code" href="fsal__convert_8c.html#a10">fsal2hpss_64</a>( p_attrib_set-&gt;filesize );
00990     
00991   }
00992 
00993     
00997   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( p_attrib_set-&gt;asked_attributes , FSAL_ATTR_MODE ) ){
00998      
00999     (*p_hpss_attrmask) =
01000         API_AddRegisterValues(*p_hpss_attrmask,
01001                                CORE_ATTR_USER_PERMS,
01002                                CORE_ATTR_GROUP_PERMS,
01003                                CORE_ATTR_OTHER_PERMS,
01004                                CORE_ATTR_SET_GID,
01005                                CORE_ATTR_SET_UID,
01006                                CORE_ATTR_SET_STICKY,
01007                                -1);
01008     
01009     <span class="comment">/* convert mode and set output structure. */</span>
01010     <a class="code" href="fsal__convert_8c.html#a13">fsal2hpss_mode</a>( p_attrib_set-&gt;mode, 
01011             &amp;(p_hpss_attrs-&gt;SetUIDBit),
01012             &amp;(p_hpss_attrs-&gt;SetGIDBit),
01013             &amp;(p_hpss_attrs-&gt;SetStickyBit),
01014             &amp;(p_hpss_attrs-&gt;UserPerms),
01015             &amp;(p_hpss_attrs-&gt;GroupPerms),
01016             &amp;(p_hpss_attrs-&gt;OtherPerms)
01017      );
01018 
01019 
01020   }
01021 
01022     
01023   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( p_attrib_set-&gt;asked_attributes , FSAL_ATTR_OWNER ) ){
01024      
01025     (*p_hpss_attrmask) =
01026         API_AddRegisterValues(*p_hpss_attrmask,CORE_ATTR_UID,-1);
01027     
01028      p_hpss_attrs-&gt;UID = p_attrib_set-&gt;owner;
01029      
01030 <span class="preprocessor">#ifdef _DEBUG_FSAL    </span>
01031 <span class="preprocessor"></span>     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"Setting Owner = : %d "</span>, p_attrib_set-&gt;owner );
01032 <span class="preprocessor">#endif</span>
01033 <span class="preprocessor"></span>  }
01034   
01035   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( p_attrib_set-&gt;asked_attributes , FSAL_ATTR_GROUP ) ){
01036      
01037     (*p_hpss_attrmask) =
01038         API_AddRegisterValues(*p_hpss_attrmask,CORE_ATTR_GID,-1);
01039     
01040      p_hpss_attrs-&gt;GID = p_attrib_set-&gt;group;
01041 
01042   }
01043 
01044 
01045   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( p_attrib_set-&gt;asked_attributes , FSAL_ATTR_ATIME ) ){
01046      
01047     (*p_hpss_attrmask) =
01048         API_AddRegisterValues(*p_hpss_attrmask,CORE_ATTR_TIME_LAST_READ,-1);
01049     
01050     p_hpss_attrs-&gt;TimeLastRead = fsal2hpss_time(  p_attrib_set-&gt;atime );
01051     
01052 <span class="preprocessor">#ifdef _DEBUG_FSAL    </span>
01053 <span class="preprocessor"></span>        DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"Setting ATIME:"</span>);
01054         DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tTimeLastRead = %d"</span>, p_hpss_attrs-&gt;TimeLastRead);
01055 <span class="preprocessor">#endif</span>
01056 <span class="preprocessor"></span>    
01057   }
01058 
01059   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( p_attrib_set-&gt;asked_attributes , FSAL_ATTR_MTIME ) ){
01060      
01061 <span class="preprocessor">#ifdef _DEBUG_FSAL    </span>
01062 <span class="preprocessor"></span>    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"Setting MTIME:"</span>);
01063     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tType = %d"</span>, p_fsal_handle-&gt;obj_type );
01064 <span class="preprocessor">#endif</span>
01065 <span class="preprocessor"></span>            
01066     <span class="keywordflow">switch</span>( p_fsal_handle-&gt;obj_type )
01067     {
01068       <span class="keywordflow">case</span> FSAL_TYPE_FILE:
01069       <span class="keywordflow">case</span> FSAL_TYPE_LNK:        
01070         
01071         (*p_hpss_attrmask) =
01072             API_AddRegisterValues(*p_hpss_attrmask,CORE_ATTR_TIME_LAST_WRITTEN,-1);
01073         p_hpss_attrs-&gt;TimeLastWritten = fsal2hpss_time(  p_attrib_set-&gt;mtime );        
01074 
01075 <span class="preprocessor">#ifdef _DEBUG_FSAL    </span>
01076 <span class="preprocessor"></span>        DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tTimeLastWritten = %d"</span>, p_hpss_attrs-&gt;TimeLastWritten);
01077 <span class="preprocessor">#endif</span>
01078 <span class="preprocessor"></span>        
01079         <span class="keywordflow">break</span>;
01080         
01081         
01082       <span class="keywordflow">case</span> FSAL_TYPE_DIR:        
01083       <span class="keywordflow">case</span> FSAL_TYPE_JUNCTION:
01084         
01085         (*p_hpss_attrmask) =
01086             API_AddRegisterValues(*p_hpss_attrmask,CORE_ATTR_TIME_MODIFIED,-1);
01087         p_hpss_attrs-&gt;TimeModified = fsal2hpss_time(  p_attrib_set-&gt;mtime );
01088         
01089 <span class="preprocessor">#ifdef _DEBUG_FSAL    </span>
01090 <span class="preprocessor"></span>        DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,<span class="stringliteral">"\tTimeModified = %d"</span>, p_hpss_attrs-&gt;TimeModified);
01091 <span class="preprocessor">#endif</span>
01092 <span class="preprocessor"></span>        
01093         <span class="keywordflow">break</span>;
01094         
01095       <span class="keywordflow">default</span>:
01096         ReturnCode( ERR_FSAL_SERVERFAULT, 0 );
01097       
01098     } <span class="comment">/* end switch */</span>
01099     
01100   } <span class="comment">/* end testmask FSAL_ATTR_MTIME */</span>
01101 
01102   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( p_attrib_set-&gt;asked_attributes , FSAL_ATTR_CTIME ) ){
01103      
01104     (*p_hpss_attrmask) =
01105         API_AddRegisterValues(*p_hpss_attrmask,CORE_ATTR_TIME_MODIFIED,-1);
01106            
01107     p_hpss_attrs-&gt;TimeModified = fsal2hpss_time(  p_attrib_set-&gt;ctime );
01108 
01109   }
01110 
01111    ReturnCode( ERR_FSAL_NO_ERROR, 0 );      
01112     
01113 }
01114 
01115 
01116 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
