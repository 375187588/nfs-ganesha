<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: fsal_context.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_context.c</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_common.h"</span>
00021 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
00022 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00023 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00024 <span class="preprocessor">#include &lt;string.h&gt;</span>
00025 
00027 <span class="keyword">enum</span>
00028 {
00029   FILESET_OPTION = 0,
00030   COS_OPTION     = 1
00031 };
00032 
00033 <span class="keyword">const</span> <span class="keywordtype">char</span> * fs_specific_opts[] =
00034 {
00035     <span class="stringliteral">"fileset"</span>,
00036     <span class="stringliteral">"cos"</span>,
00037     NULL
00038 };
00039 
00040     
00045 <span class="keyword">static</span> <span class="keywordtype">int</span> Getsubopt (<span class="keywordtype">char</span> **optionp, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> *tokens, <span class="keywordtype">char</span> **valuep)
00046 {
00047   <span class="keywordtype">char</span> *endp, *vstart;
00048   <span class="keywordtype">int</span> cnt;
00049 
00050   <span class="keywordflow">if</span> (**optionp == <span class="charliteral">'\0'</span>)
00051     <span class="keywordflow">return</span> -1;
00052 
00053   <span class="comment">/* Find end of next token.  */</span>
00054   endp = strchr (*optionp, <span class="charliteral">','</span>);
00055   <span class="keywordflow">if</span> (endp == NULL)
00056     endp = strchr (*optionp, <span class="charliteral">'\0'</span>);
00057 
00058   <span class="comment">/* Find start of value.  */</span>
00059   vstart = memchr (*optionp, <span class="charliteral">'='</span>, endp - *optionp);
00060   <span class="keywordflow">if</span> (vstart == NULL)
00061     vstart = endp;
00062 
00063   <span class="comment">/* Try to match the characters between *OPTIONP and VSTART against</span>
00064 <span class="comment">     one of the TOKENS.  */</span>
00065   <span class="keywordflow">for</span> (cnt = 0; tokens[cnt] != NULL; ++cnt)
00066     <span class="keywordflow">if</span> (memcmp (*optionp, tokens[cnt], vstart - *optionp) == 0
00067         &amp;&amp; tokens[cnt][vstart - *optionp] == <span class="charliteral">'\0'</span>)
00068       {
00069         <span class="comment">/* We found the current option in TOKENS.  */</span>
00070         *valuep = vstart != endp ? vstart + 1 : NULL;
00071 
00072         <span class="keywordflow">if</span> (*endp != <span class="charliteral">'\0'</span>)
00073           *endp++ = <span class="charliteral">'\0'</span>;
00074         *optionp = endp;
00075 
00076         <span class="keywordflow">return</span> cnt;
00077       }
00078 
00079   <span class="comment">/* The current suboption does not match any option.  */</span>
00080   *valuep = *optionp;
00081 
00082   <span class="keywordflow">if</span> (*endp != <span class="charliteral">'\0'</span>)
00083     *endp++ = <span class="charliteral">'\0'</span>;
00084   *optionp = endp;
00085 
00086   <span class="keywordflow">return</span> -1;
00087 }
00088 
00089 
<a name="l00102"></a><a class="code" href="group__FSALCredFunctions.html#ga0">00102</a> fsal_status_t <a class="code" href="group__FSALCredFunctions.html#ga0">FSAL_BuildExportContext</a>(
00103         fsal_export_context_t   * p_export_context,    <span class="comment">/* OUT */</span>
00104         fsal_path_t             * p_export_path,       <span class="comment">/* IN */</span>
00105         <span class="keywordtype">char</span>                    * fs_specific_options  <span class="comment">/* IN */</span>
00106       )
00107 {
00108   <span class="keywordtype">char</span> subopts[256];
00109   <span class="keywordtype">char</span> * p_subop;
00110   <span class="keywordtype">char</span> *value;
00111   
00112   <span class="keywordtype">char</span> * filesetname = NULL;
00113   <span class="keywordtype">int</span>    read_cos = 0; <span class="comment">/* 0 =&gt; not set */</span>
00114   
00115   <span class="keywordtype">int</span> rc;
00116   
00117   <span class="comment">/* sanity check */</span>
00118   <span class="keywordflow">if</span> (!p_export_context )
00119     Return( ERR_FSAL_FAULT ,0 , INDEX_FSAL_BuildExportContext );
00120   
00121   
00122   <span class="keywordflow">if</span>( ( fs_specific_options != NULL ) &amp;&amp; ( fs_specific_options[0] != <span class="charliteral">'\0'</span> ) )
00123   {
00124   
00125     <span class="comment">/* cleans the export context */</span>
00126     memset( p_export_context, 0, <span class="keyword">sizeof</span>( fsal_export_context_t ));
00127 
00128     <span class="comment">/* copy the option string (because it is modified by getsubopt call) */</span>
00129     strncpy( subopts, fs_specific_options , 256 );
00130     p_subop = subopts; <span class="comment">/* set initial pointer */</span>
00131     
00132     <span class="comment">/* parse the FS specific option string */</span>
00133 
00134     <span class="keywordflow">switch</span>(Getsubopt(&amp;p_subop, fs_specific_opts, &amp;value))
00135     {
00136       <span class="keywordflow">case</span> FILESET_OPTION:
00137         filesetname = value;
00138         <span class="keywordflow">break</span>;
00139 
00140       <span class="keywordflow">case</span> COS_OPTION:
00141         read_cos = atoi( value );
00142         <span class="keywordflow">if</span> ( read_cos &lt;= 0 )
00143           {
00144             DisplayLog( <span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for EXPORT::FS_Specific::%s : ( %s ) positive integer expected."</span>,
00145                         fs_specific_opts[COS_OPTION],
00146                         value );
00147             Return( ERR_FSAL_INVAL ,0 , INDEX_FSAL_BuildExportContext );          
00148           }
00149         <span class="keywordflow">break</span>;
00150 
00151       <span class="keywordflow">default</span>:
00152         {
00153           DisplayLog( <span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Invalid suboption found in EXPORT::FS_Specific : %s : %s or %s expected."</span>,
00154                       value,
00155                       fs_specific_opts[FILESET_OPTION],
00156                       fs_specific_opts[COS_OPTION] );    
00157           Return( ERR_FSAL_INVAL ,0 , INDEX_FSAL_BuildExportContext );
00158         }
00159     }
00160     
00161   }
00162     
00163   <span class="comment">/* fills the export context structure */</span>
00164   
00165   p_export_context-&gt;default_cos = read_cos;
00166   
00167   rc = HPSSFSAL_GetFilesetRoot( filesetname, &amp;p_export_context-&gt;fileset_root_handle );
00168   
00169   <span class="keywordflow">if</span> ( rc != 0 )
00170   {
00171      DisplayLog( <span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Could not get root handle for fileset \"%s\""</span>,
00172                   (filesetname == NULL ? filesetname : <span class="stringliteral">"&lt;root&gt;"</span> )  );
00173      Return( ERR_FSAL_INVAL , -rc , INDEX_FSAL_BuildExportContext );    
00174   }
00175   
00176   Return( ERR_FSAL_NO_ERROR , 0 , INDEX_FSAL_BuildExportContext );
00177   
00178 }
00179 
00180      
00181 
00182 fsal_status_t FSAL_InitClientContext( fsal_op_context_t * p_thr_context )
00183 {
00184   
00185   <span class="keywordtype">int</span> rc,i;
00186   
00187   <span class="comment">/* sanity check */</span>
00188   <span class="keywordflow">if</span> (!p_thr_context ) Return( ERR_FSAL_FAULT ,0 , INDEX_FSAL_InitClientContext );
00189 
00190   <span class="comment">/* initialy set the export entry to none */</span>
00191   p_thr_context-&gt;export_context = NULL;
00192   
00193   <span class="comment">/* LoadThreadState */</span>
00194   
00195   <span class="comment">/* We set umask to 0.</span>
00196 <span class="comment">   * The specified umask is applied later (before calling HPSS API functions)</span>
00197 <span class="comment">   */</span>
00198   <span class="keywordflow">if</span> ( rc = hpss_LoadThreadState(0,0,NULL)){
00199       Return( ERR_FSAL_PERM , -rc, INDEX_FSAL_GetClientContext );
00200   }
00201   
00202   <span class="comment">/* get associated user p_cred */</span>  
00203   <span class="keywordflow">if</span> ( rc = hpss_GetThreadUcred( &amp;(p_thr_context-&gt;credential.hpss_usercred) ))
00204   {
00205       Return( ERR_FSAL_PERM , -rc, INDEX_FSAL_InitClientContext );
00206   }
00207   
00208   <span class="comment">/* sets the credential time */</span>
00209   p_thr_context-&gt;credential.last_update = time( NULL );
00210   
00211 <span class="preprocessor">#if defined( _DEBUG_FSAL ) &amp;&amp; defined ( _USE_HPSS_51 )</span>
00212 <span class="preprocessor"></span>  
00213    <span class="comment">/* traces: prints p_credential structure */</span>
00214   
00215    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"credential created:"</span>);
00216    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tuid = %d, gid = %d"</span>,
00217       p_thr_context-&gt;credential.hpss_usercred.SecPWent.Uid, p_thr_context-&gt;credential.hpss_usercred.SecPWent.Gid);
00218    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tName = %s"</span>,
00219       p_thr_context-&gt;credential.hpss_usercred.SecPWent.Name);
00220    
00221    <span class="keywordflow">for</span> ( i=0; i&lt; p_thr_context-&gt;credential.hpss_usercred.NumGroups; i++ )
00222      DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tAlt grp: %d"</span>,
00223         p_thr_context-&gt;credential.hpss_usercred.AltGroups[i] );
00224 
00225 <span class="preprocessor">#elif defined( _DEBUG_FSAL ) &amp;&amp; defined ( _USE_HPSS_62 )</span>
00226 <span class="preprocessor"></span>
00227    <span class="comment">/* traces: prints p_credential structure */</span>
00228   
00229    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"credential created:"</span>);
00230    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tuid = %d, gid = %d"</span>,
00231       p_thr_context-&gt;credential.hpss_usercred.Uid, p_thr_context-&gt;credential.hpss_usercred.Gid);
00232    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tName = %s"</span>,
00233       p_thr_context-&gt;credential.hpss_usercred.Name);
00234    
00235    <span class="keywordflow">for</span> ( i=0; i&lt; p_thr_context-&gt;credential.hpss_usercred.NumGroups; i++ )
00236      DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tAlt grp: %d"</span>,
00237         p_thr_context-&gt;credential.hpss_usercred.AltGroups[i] );
00238        
00239 <span class="preprocessor">#endif  </span>
00240 <span class="preprocessor"></span>     
00241   Return( ERR_FSAL_NO_ERROR , 0, INDEX_FSAL_InitClientContext );
00242   
00243 }
00244 
00245  
<a name="l00269"></a><a class="code" href="group__FSALCredFunctions.html#ga2">00269</a> fsal_status_t <a class="code" href="group__FSALCredFunctions.html#ga2">FSAL_GetClientContext</a>(
00270         fsal_op_context_t       * p_thr_context,      <span class="comment">/* IN/OUT  */</span>
00271         fsal_export_context_t   * p_export_context,   <span class="comment">/* IN */</span>    
00272         fsal_uid_t              uid,                  <span class="comment">/* IN */</span>
00273         fsal_gid_t              gid,                  <span class="comment">/* IN */</span>
00274         fsal_gid_t              * alt_groups,         <span class="comment">/* IN */</span>
00275         fsal_count_t            nb_alt_groups         <span class="comment">/* IN */</span>
00276       )
00277 {
00278   
00279   fsal_count_t ng = nb_alt_groups;
00280   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00281   fsal_status_t st;
00282   
00283   <span class="comment">/* sanity check */</span>
00284   <span class="keywordflow">if</span> (!p_thr_context || !p_export_context )
00285     Return( ERR_FSAL_FAULT ,0 , INDEX_FSAL_GetClientContext );
00286   
00287   
00288   <span class="comment">/* if the credential is too old, renew it */</span>
00289   <span class="keywordflow">if</span> ( time( NULL ) - p_thr_context-&gt;credential.last_update &gt; (int)CredentialLifetime )
00290   {
00291     st = FSAL_InitClientContext( p_thr_context );
00292     <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) ) <span class="keywordflow">return</span> st;
00293   }
00294   
00295   <span class="comment">/* set the export specific context */</span>
00296   p_thr_context-&gt;export_context = p_export_context;
00297   
00298     
00299   <span class="comment">/* Extracted from  /opt/hpss/src/nfs/nfsd/nfs_Dispatch.c */</span>
00300   
00301 <span class="preprocessor">#if defined( _USE_HPSS_51 )</span>
00302 <span class="preprocessor"></span>  strcpy( p_thr_context-&gt;credential.hpss_usercred.SecPWent.Name, <span class="stringliteral">"NFS.User"</span> );
00303   p_thr_context-&gt;credential.hpss_usercred.SecLabel = 0; <span class="comment">/* Symbol? */</span>
00304   p_thr_context-&gt;credential.hpss_usercred.CurAccount = ACCT_REC_DEFAULT;
00305   p_thr_context-&gt;credential.hpss_usercred.DefAccount = ACCT_REC_DEFAULT;
00306   p_thr_context-&gt;credential.hpss_usercred.SecPWent.Uid = uid ;
00307   p_thr_context-&gt;credential.hpss_usercred.SecPWent.Gid = gid ;
00308 <span class="preprocessor">#elif defined( _USE_HPSS_62 )</span>
00309 <span class="preprocessor"></span>  strcpy( p_thr_context-&gt;credential.hpss_usercred.Name, <span class="stringliteral">"NFS.User"</span> );
00310   p_thr_context-&gt;credential.hpss_usercred.CurAccount = ACCT_REC_DEFAULT;
00311   p_thr_context-&gt;credential.hpss_usercred.DefAccount = ACCT_REC_DEFAULT;
00312   p_thr_context-&gt;credential.hpss_usercred.Uid = uid ;
00313   p_thr_context-&gt;credential.hpss_usercred.Gid = gid ;  
00314 <span class="preprocessor">#endif</span>
00315 <span class="preprocessor"></span>  
00316   <span class="keywordflow">if</span> ( ng &gt; HPSS_NGROUPS_MAX )
00317     ng = HPSS_NGROUPS_MAX ;
00318   
00319   <span class="keywordflow">if</span> ( ( ng &gt; 0 ) &amp;&amp; ( alt_groups == NULL ) )
00320     Return( ERR_FSAL_FAULT, 0, INDEX_FSAL_GetClientContext );
00321   
00322   p_thr_context-&gt;credential.hpss_usercred.NumGroups = ng;
00323   
00324   <span class="keywordflow">for</span> ( i = 0 ; i &lt; ng; i++ )
00325     p_thr_context-&gt;credential.hpss_usercred.AltGroups[i] = alt_groups[i];
00326 
00327 <span class="preprocessor">#if defined( _DEBUG_FSAL ) &amp;&amp; defined( _USE_HPSS_51 )</span>
00328 <span class="preprocessor"></span>  
00329    <span class="comment">/* traces: prints p_credential structure */</span>
00330   
00331    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"credential modified:"</span>);
00332    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tuid = %d, gid = %d"</span>,
00333       p_thr_context-&gt;credential.hpss_usercred.SecPWent.Uid, p_thr_context-&gt;credential.hpss_usercred.SecPWent.Gid);
00334    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tName = %s"</span>,
00335       p_thr_context-&gt;credential.hpss_usercred.SecPWent.Name);
00336    
00337    <span class="keywordflow">for</span> ( i=0; i&lt; p_thr_context-&gt;credential.hpss_usercred.NumGroups; i++ )
00338      DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tAlt grp: %d"</span>,
00339         p_thr_context-&gt;credential.hpss_usercred.AltGroups[i] );
00340 
00341 <span class="preprocessor">#elif defined( _DEBUG_FSAL ) &amp;&amp; defined( _USE_HPSS_62 )</span>
00342 <span class="preprocessor"></span>
00343       <span class="comment">/* traces: prints p_credential structure */</span>
00344   
00345    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"credential modified:"</span>);
00346    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tuid = %d, gid = %d"</span>,
00347       p_thr_context-&gt;credential.hpss_usercred.Uid, p_thr_context-&gt;credential.hpss_usercred.Gid);
00348    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tName = %s"</span>,
00349       p_thr_context-&gt;credential.hpss_usercred.Name);
00350    
00351    <span class="keywordflow">for</span> ( i=0; i&lt; p_thr_context-&gt;credential.hpss_usercred.NumGroups; i++ )
00352      DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tAlt grp: %d"</span>,
00353         p_thr_context-&gt;credential.hpss_usercred.AltGroups[i] );       
00354 <span class="preprocessor">#endif</span>
00355 <span class="preprocessor"></span>    
00356   Return( ERR_FSAL_NO_ERROR, 0, INDEX_FSAL_GetClientContext );
00357   
00358 }
00359 
00360 
00361 <span class="comment">/* @} */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
