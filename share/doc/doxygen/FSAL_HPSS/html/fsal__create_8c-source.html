<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: fsal_create.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_create.c</h1><a href="fsal__create_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 <span class="preprocessor">#include "fsal_common.h"</span>
00022 <span class="preprocessor">#include "HPSSclapiExt/hpssclapiext.h"</span>
00023 
00024 
00025 
<a name="l00062"></a><a class="code" href="fsal__create_8c.html#a0">00062</a> fsal_status_t <a class="code" href="fsal__create_8c.html#a0">FSAL_create</a>(
00063     fsal_handle_t         * parent_directory_handle, <span class="comment">/* IN */</span>
00064     fsal_name_t           * p_filename,              <span class="comment">/* IN */</span>
00065     fsal_op_context_t     * p_context,               <span class="comment">/* IN */</span>
00066     fsal_accessmode_t     accessmode,                <span class="comment">/* IN */</span>
00067     fsal_handle_t         * object_handle,           <span class="comment">/* OUT */</span>
00068     fsal_attrib_list_t    * object_attributes        <span class="comment">/* [ IN/OUT ] */</span>
00069 ){
00070   
00071   <span class="keywordtype">int</span> rc;
00072   mode_t  unix_mode;
00073   
00074   hpss_Attrs_t new_attrs;
00075   ns_ObjHandle_t new_hdl;
00076   
00077   <span class="comment">/* cos management */</span>  
00078   hpss_cos_hints_t      hint;
00079   hpss_cos_priorities_t hintpri;
00080   
00081   <span class="comment">/* If no COS is specified in the config file,</span>
00082 <span class="comment">   * we give NULL pointers to CreateHandle,</span>
00083 <span class="comment">   * to use the default Cos for this Fileset.</span>
00084 <span class="comment">   */</span>
00085   hpss_cos_hints_t      * p_hint = NULL;
00086   hpss_cos_priorities_t * p_hintpri = NULL;
00087       
00088   <span class="comment">/* sanity checks.</span>
00089 <span class="comment">   * note : object_attributes is optional.</span>
00090 <span class="comment">   */</span>
00091   <span class="keywordflow">if</span> ( !parent_directory_handle || 
00092        !p_context ||
00093        !object_handle ||
00094        !p_filename )
00095     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_create);
00096   
00097   
00098   <span class="comment">/* convert fsal mode to unix mode. */</span>
00099   unix_mode = <a class="code" href="fsal__convert_8c.html#a5">fsal2unix_mode</a>( accessmode );
00100   
00101   <span class="comment">/* Apply umask */</span>
00102   unix_mode = unix_mode &amp; ~global_fs_info.umask ;
00103   
00104   
00105   <span class="comment">/* Eventually set cos */</span>
00106   
00107   <span class="keywordflow">if</span> ( p_context-&gt;export_context-&gt;default_cos != 0 )
00108   {
00109     HPSSFSAL_BuildCos( p_context-&gt;export_context-&gt;default_cos, &amp;hint, &amp;hintpri);
00110     p_hint = &amp;hint;
00111     p_hintpri = &amp;hintpri;
00112   }
00113 
00114   <span class="keywordflow">if</span> ( p_context-&gt;export_context-&gt;default_cos != 0 )
00115     DisplayLogJdLevel( fsal_log, NIV_DEBUG, <span class="stringliteral">"Creating file with COS = %d"</span>,p_context-&gt;export_context-&gt;default_cos ) ;
00116   <span class="keywordflow">else</span>
00117     DisplayLogJdLevel( fsal_log, NIV_DEBUG, <span class="stringliteral">"Creating file with default fileset COS."</span> ) ;
00118 
00119 <span class="preprocessor">#ifdef _DEBUG_FSAL</span>
00120 <span class="preprocessor"></span>  DisplayLogJdLevel( fsal_log, NIV_DEBUG, <span class="stringliteral">"Creation mode: 0%o"</span>, accessmode ) ;
00121 <span class="preprocessor">#endif</span>
00122 <span class="preprocessor"></span>  
00123   
00124   <span class="comment">/* call to API */</span>
00125   
00126   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00127   
00128   rc = HPSSFSAL_CreateHandle(
00129           &amp;(parent_directory_handle-&gt;ns_handle), <span class="comment">/* IN - Parent object handle */</span>
00130           p_filename-&gt;name,       <span class="comment">/* IN - Name of the file to be created */</span>
00131           unix_mode,              <span class="comment">/* IN - Desired file perms */</span>
00132           &amp;(p_context-&gt;credential.hpss_usercred), <span class="comment">/* IN - User credentials */</span>
00133           p_hint,       <span class="comment">/* IN - Desired class of service */</span>
00134           p_hintpri,    <span class="comment">/* IN - Priorities of hint struct */</span>
00135           NULL,         <span class="comment">/* OUT - Granted class of service */</span>
00136           (object_attributes ? &amp;new_attrs : NULL ), <span class="comment">/* OUT - File attributes */</span>
00137           &amp;new_hdl,                                 <span class="comment">/* OUT - File handle */</span>
00138           NULL );     <span class="comment">/* OUT - Client authorization */</span>
00139   
00140   ReleaseTokenFSCall();
00141   
00142   
00143   <span class="comment">/* /!\ WARNING : When the directory handle is stale, HPSS returns ENOTDIR.</span>
00144 <span class="comment">   * If the returned value is HPSS_ENOTDIR, parent handle MAY be stale.</span>
00145 <span class="comment">   * Thus, we must double-check by calling getattrs.   </span>
00146 <span class="comment">   */</span>
00147   <span class="keywordflow">if</span> ( rc == HPSS_ENOTDIR || rc == HPSS_ENOENT )
00148   {
00149       <span class="keywordflow">if</span> ( HPSSFSAL_IsStaleHandle( &amp;parent_directory_handle-&gt;ns_handle,
00150                                    &amp;p_context-&gt;credential.hpss_usercred ) )
00151       {
00152         Return( ERR_FSAL_STALE, -rc, INDEX_FSAL_create );
00153       }      
00154   }
00155   
00156   <span class="comment">/* other errors */</span>
00157   
00158   <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_create);
00159   
00160   
00161   <span class="comment">/* set output handle */</span>
00162   object_handle-&gt;obj_type  = FSAL_TYPE_FILE;
00163   object_handle-&gt;ns_handle = new_hdl;
00164   
00165   
00166   <span class="keywordflow">if</span> ( object_attributes ) {
00167       
00168       fsal_status_t status;
00169     
00170       <span class="comment">/* convert hpss attributes to fsal attributes */</span>
00171     
00172       status=<a class="code" href="fsal__convert_8c.html#a14">hpss2fsal_attributes</a>( &amp;new_hdl,
00173                                    &amp;new_attrs,
00174                                    object_attributes );
00175       
00176         <span class="comment">/* on error, we set a special bit in the mask. */</span>        
00177         <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00178         {
00179           FSAL_CLEAR_MASK( object_attributes-&gt;asked_attributes );
00180           FSAL_SET_MASK( object_attributes-&gt;asked_attributes,
00181               FSAL_ATTR_RDATTR_ERR );
00182         }
00183         
00184   }
00185     
00186   
00187   <span class="comment">/* OK */</span>
00188   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_create);
00189   
00190 }
00191 
00192 
00193 
00194 
<a name="l00232"></a><a class="code" href="fsal__create_8c.html#a1">00232</a> fsal_status_t <a class="code" href="fsal__create_8c.html#a1">FSAL_mkdir</a>(
00233     fsal_handle_t         * parent_directory_handle, <span class="comment">/* IN */</span>
00234     fsal_name_t           * p_dirname,             <span class="comment">/* IN */</span>
00235     fsal_op_context_t     * p_context,                     <span class="comment">/* IN */</span>
00236     fsal_accessmode_t     accessmode,          <span class="comment">/* IN */</span>
00237     fsal_handle_t         * object_handle,           <span class="comment">/* OUT */</span>
00238     fsal_attrib_list_t    * object_attributes   <span class="comment">/* [ IN/OUT ] */</span>
00239 ){
00240 
00241   <span class="keywordtype">int</span> rc;
00242   mode_t  unix_mode;
00243   ns_ObjHandle_t  lnk_hdl;
00244   hpss_Attrs_t    lnk_attr;
00245   
00246   <span class="comment">/* sanity checks.</span>
00247 <span class="comment">   * note : object_attributes is optional.</span>
00248 <span class="comment">   */</span>
00249   <span class="keywordflow">if</span> ( !parent_directory_handle || 
00250        !p_context ||
00251        !object_handle ||
00252        !p_dirname)
00253     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_mkdir);
00254   
00255 
00256     
00257   <span class="comment">/* convert FSAL mode to HPSS mode. */</span>
00258   unix_mode = <a class="code" href="fsal__convert_8c.html#a5">fsal2unix_mode</a>( accessmode );
00259 
00260   <span class="comment">/* Apply umask */</span>
00261   unix_mode = unix_mode &amp; ~global_fs_info.umask ;
00262 
00263     
00264   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00265   
00266   rc = HPSSFSAL_MkdirHandle(
00267          &amp;(parent_directory_handle-&gt;ns_handle),
00268          p_dirname-&gt;name,
00269          unix_mode,
00270          &amp;( p_context-&gt;credential.hpss_usercred ),
00271          &amp;lnk_hdl,
00272          ( object_attributes ? &amp;lnk_attr : NULL)
00273       );
00274 
00275   ReleaseTokenFSCall();
00276 
00277   <span class="comment">/* /!\ WARNING : When the directory handle is stale, HPSS returns ENOTDIR.</span>
00278 <span class="comment">   * If the returned value is HPSS_ENOTDIR, parent handle MAY be stale.</span>
00279 <span class="comment">   * Thus, we must double-check by calling getattrs.   </span>
00280 <span class="comment">   */</span>
00281   <span class="keywordflow">if</span> ( rc == HPSS_ENOTDIR || rc == HPSS_ENOENT )
00282   {
00283       <span class="keywordflow">if</span> ( HPSSFSAL_IsStaleHandle( &amp;parent_directory_handle-&gt;ns_handle,
00284                                    &amp;p_context-&gt;credential.hpss_usercred ) )
00285       {
00286         Return( ERR_FSAL_STALE, -rc, INDEX_FSAL_mkdir );
00287       }
00288   }
00289   
00290   <span class="comment">/* other errors */</span>
00291   
00292   <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_mkdir);
00293   
00294   <span class="comment">/* set output handle */</span>
00295   object_handle-&gt;obj_type = FSAL_TYPE_DIR;
00296   object_handle-&gt;ns_handle = lnk_hdl;
00297   
00298   
00299   <span class="keywordflow">if</span> ( object_attributes ) {
00300       
00301       fsal_status_t status;
00302     
00303       <span class="comment">/* convert hpss attributes to fsal attributes */</span>
00304     
00305       status=<a class="code" href="fsal__convert_8c.html#a14">hpss2fsal_attributes</a>( &amp;lnk_hdl,
00306                                    &amp;lnk_attr,
00307                                    object_attributes );
00308       
00309       <span class="comment">/* on error, we set a special bit in the mask. */</span>        
00310       <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00311       {
00312         FSAL_CLEAR_MASK( object_attributes-&gt;asked_attributes );
00313         FSAL_SET_MASK( object_attributes-&gt;asked_attributes,
00314             FSAL_ATTR_RDATTR_ERR );
00315       }
00316   }
00317   
00318   <span class="comment">/* OK */</span>
00319   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_mkdir);
00320   
00321 }
00322 
00323 
00324 
00325 
<a name="l00363"></a><a class="code" href="fsal__create_8c.html#a2">00363</a> fsal_status_t <a class="code" href="fsal__create_8c.html#a2">FSAL_link</a>(
00364     fsal_handle_t         * target_handle,        <span class="comment">/* IN */</span>
00365     fsal_handle_t         * dir_handle,           <span class="comment">/* IN */</span>
00366     fsal_name_t           * p_link_name,          <span class="comment">/* IN */</span>
00367     fsal_op_context_t     * p_context,            <span class="comment">/* IN */</span>
00368     fsal_attrib_list_t    * attributes       <span class="comment">/* [ IN/OUT ] */</span>
00369 ){
00370   
00371   <span class="keywordtype">int</span> rc;
00372   
00373   <span class="comment">/* sanity checks.</span>
00374 <span class="comment">   * note : attributes is optional.</span>
00375 <span class="comment">   */</span>
00376   printf( <span class="stringliteral">"%p %p %p %p \n"</span>, target_handle, dir_handle, p_context, p_link_name ) ;
00377 
00378   <span class="keywordflow">if</span> ( !target_handle || 
00379        !dir_handle || 
00380        !p_context || 
00381        !p_link_name)
00382     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_link);
00383   
00384   
00385   <span class="comment">/* Tests if hardlinking is allowed by configuration. */</span>
00386   
00387   <span class="keywordflow">if</span> ( !global_fs_info.link_support )
00388       Return( ERR_FSAL_NOTSUPP, 0,INDEX_FSAL_link);
00389   
00390   <span class="comment">/* Call to HPSS API */</span>
00391   
00392   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00393   
00394   rc = hpss_LinkHandle(
00395       &amp;(target_handle-&gt;ns_handle),    <span class="comment">/* IN - Handle of existing file */</span>
00396       &amp;(dir_handle-&gt;ns_handle),       <span class="comment">/* IN - parent directory handle */</span>
00397       p_link_name-&gt;name,              <span class="comment">/* IN - New name of the object */</span>
00398       &amp;(p_context-&gt;credential.hpss_usercred)); <span class="comment">/* IN - pointer to user credentials */</span>
00399   
00400   ReleaseTokenFSCall();
00401   
00402   <span class="comment">/* /!\ WARNING : When one of the handles is stale, HPSS returns ENOTDIR or ENOENT.</span>
00403 <span class="comment">   * Thus, we must check this by calling HPSSFSAL_IsStaleHandle.</span>
00404 <span class="comment">   */</span>
00405   <span class="keywordflow">if</span> ( rc == HPSS_ENOTDIR || rc == HPSS_ENOENT )
00406   {
00407     <span class="keywordflow">if</span> ( HPSSFSAL_IsStaleHandle( &amp;dir_handle-&gt;ns_handle,
00408                                  &amp;p_context-&gt;credential.hpss_usercred ) 
00409         ||
00410         HPSSFSAL_IsStaleHandle( &amp;target_handle-&gt;ns_handle,
00411                                  &amp;p_context-&gt;credential.hpss_usercred ))
00412     {
00413       Return( ERR_FSAL_STALE, -rc, INDEX_FSAL_link );
00414     }
00415   }
00416   
00417   <span class="comment">/* other errors */</span>
00418   <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_link);
00419   
00420   
00421   <span class="comment">/* optionnaly get attributes */</span>
00422   
00423   <span class="keywordflow">if</span> ( attributes ) {
00424     
00425     fsal_status_t st;
00426     
00427     st = <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>( target_handle, p_context , attributes );
00428     
00429     <span class="comment">/* on error, we set a special bit in the mask. */</span>        
00430     <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) )
00431     {
00432       FSAL_CLEAR_MASK( attributes-&gt;asked_attributes );
00433       FSAL_SET_MASK( attributes-&gt;asked_attributes,
00434           FSAL_ATTR_RDATTR_ERR );
00435     }
00436           
00437   }
00438     
00439   <span class="comment">/* OK */</span>
00440   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_link);
00441   
00442 }
00443 
00444 
00445 
<a name="l00453"></a><a class="code" href="fsal__create_8c.html#a3">00453</a> fsal_status_t <a class="code" href="fsal__create_8c.html#a3">FSAL_mknode</a>(
00454     fsal_handle_t             * parentdir_handle,     <span class="comment">/* IN */</span>
00455     fsal_name_t               * p_node_name,          <span class="comment">/* IN */</span>
00456     fsal_op_context_t         * p_context,                     <span class="comment">/* IN */</span>
00457     fsal_accessmode_t         accessmode,             <span class="comment">/* IN */</span>
00458     fsal_nodetype_t           nodetype,             <span class="comment">/* IN */</span>
00459     fsal_dev_t                * dev,                  <span class="comment">/* IN */</span>
00460     fsal_handle_t             * p_object_handle,      <span class="comment">/* OUT (handle to the created node) */</span>    
00461     fsal_attrib_list_t        * node_attributes       <span class="comment">/* [ IN/OUT ] */</span>
00462 ){
00463 
00464   <span class="comment">/* sanity checks.</span>
00465 <span class="comment">   * note : link_attributes is optional.</span>
00466 <span class="comment">   */</span>
00467   <span class="keywordflow">if</span> ( !parentdir_handle || 
00468        !p_context ||
00469        !nodetype ||
00470        !dev ||
00471        !p_node_name )
00472     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_mknode);
00473   
00474   <span class="comment">/* Not implemented */</span>
00475   Return(ERR_FSAL_NOTSUPP ,0 , INDEX_FSAL_mknode);
00476 
00477 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
