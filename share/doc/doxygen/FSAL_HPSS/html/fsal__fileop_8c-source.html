<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: fsal_fileop.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_fileop.c</h1><a href="fsal__fileop_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00012 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00014 <span class="preprocessor">#endif</span>
00015 <span class="preprocessor"></span>
00016 <span class="preprocessor">#include "fsal.h"</span>
00017 <span class="preprocessor">#include "fsal_internal.h"</span>
00018 <span class="preprocessor">#include "fsal_convert.h"</span>
00019 <span class="preprocessor">#include "HPSSclapiExt/hpssclapiext.h"</span>
00020 
00021 
00022 
<a name="l00062"></a><a class="code" href="fsal__fileop_8c.html#a0">00062</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a0">FSAL_open_by_name</a>(
00063     fsal_handle_t         * dirhandle,             <span class="comment">/* IN */</span>
00064     fsal_name_t           * filename,              <span class="comment">/* IN */</span>
00065     fsal_op_context_t     * p_context,              <span class="comment">/* IN */</span>
00066     fsal_openflags_t        openflags,              <span class="comment">/* IN */</span>
00067     fsal_file_t           * file_descriptor,        <span class="comment">/* OUT */</span>
00068     fsal_attrib_list_t    * file_attributes         <span class="comment">/* [ IN/OUT ] */</span>)
00069 {
00070   fsal_status_t fsal_status ;
00071   fsal_handle_t filehandle ;
00072 
00073   <span class="keywordflow">if</span> ( !dirhandle || !filename || !p_context || !file_descriptor)
00074     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_open_by_name);
00075 
00076   fsal_status = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a>( dirhandle, filename, p_context, &amp;filehandle, file_attributes ) ;
00077   <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00078         <span class="keywordflow">return</span> fsal_status ;
00079 
00080   <span class="keywordflow">return</span> <a class="code" href="fsal__fileop_8c.html#a1">FSAL_open</a>( &amp;filehandle, p_context, openflags, file_descriptor, file_attributes ) ; 
00081 }
00082 
00083 
00084 
00085 
<a name="l00122"></a><a class="code" href="fsal__fileop_8c.html#a1">00122</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a1">FSAL_open</a>(
00123     fsal_handle_t         * filehandle,             <span class="comment">/* IN */</span>
00124     fsal_op_context_t     * p_context,              <span class="comment">/* IN */</span>
00125     fsal_openflags_t      openflags,                <span class="comment">/* IN */</span>
00126     fsal_file_t           * file_descriptor,        <span class="comment">/* OUT */</span>
00127     fsal_attrib_list_t    * file_attributes         <span class="comment">/* [ IN/OUT ] */</span>
00128 ){
00129   
00130   <span class="keywordtype">int</span> rc;
00131   <span class="keywordtype">int</span> hpss_flags;
00132   hpss_Attrs_t  hpss_attributes;
00133   TYPE_TOKEN_HPSS   hpss_authz;
00134       
00135   <span class="comment">/* sanity checks.</span>
00136 <span class="comment">   * note : file_attributes is optional.</span>
00137 <span class="comment">   */</span>
00138   <span class="keywordflow">if</span> ( !filehandle || !p_context || !file_descriptor)
00139     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_open);
00140   
00141   <span class="comment">/* check if it is a file */</span>
00142   
00143   <span class="keywordflow">if</span> ( filehandle-&gt;obj_type != FSAL_TYPE_FILE )
00144   {
00145     Return(ERR_FSAL_INVAL ,0 , INDEX_FSAL_open);
00146   }
00147   
00148   <span class="comment">/* convert fsal open flags to hpss open flags */</span>
00149   
00150   rc = <a class="code" href="fsal__convert_8c.html#a4">fsal2hpss_openflags</a>( openflags, &amp;hpss_flags );
00151   
00152   <span class="comment">/* flags conflicts. */</span>
00153   
00154   <span class="keywordflow">if</span> (rc) {
00155     DisplayLogJdLevel( fsal_log, NIV_EVENT,
00156       <span class="stringliteral">"Invalid/conflicting flags : %#X"</span>, openflags );
00157     Return( rc, 0, INDEX_FSAL_open);
00158   }
00159 
00160   
00161   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00162   
00163   rc = HPSSFSAL_OpenHandle(
00164                 &amp;filehandle-&gt;ns_handle, <span class="comment">/* IN - object handle */</span>
00165                 NULL,
00166                 hpss_flags,             <span class="comment">/* IN - Type of file access */</span>
00167                 (mode_t)0644,           <span class="comment">/* IN - Desired file perms if create */</span>
00168                 &amp;p_context-&gt;credential.hpss_usercred,   <span class="comment">/* IN - User credentials */</span>
00169                 NULL,                   <span class="comment">/* IN - Desired class of service */</span>
00170                 NULL,                   <span class="comment">/* IN - Priorities of hint struct */</span>
00171                 NULL,                   <span class="comment">/* OUT - Granted class of service */</span>
00172                 ( file_attributes ?
00173                   &amp;hpss_attributes : NULL ),  <span class="comment">/* OUT - returned attributes */</span>
00174                 NULL,                   <span class="comment">/* OUT - returned handle */</span>
00175                 &amp;hpss_authz             <span class="comment">/* OUT - Client authorization */</span>
00176               );
00177   
00178   ReleaseTokenFSCall();
00179   
00180   <span class="comment">/* /!\ rc is the file descriptor number !!! */</span>
00181   
00182   <span class="comment">/* The HPSS_ENOENT error actually means that handle is STALE */</span>
00183   <span class="keywordflow">if</span> ( rc == HPSS_ENOENT )
00184     Return( ERR_FSAL_STALE, -rc, INDEX_FSAL_open);
00185   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( rc &lt; 0 )
00186      Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_open );
00187   
00188   <span class="comment">/* fills output struct */</span>
00189   
00190   file_descriptor-&gt;filedes = rc;
00191   file_descriptor-&gt;fileauthz = hpss_authz;
00192 
00193     
00194   <span class="comment">/* set output attributes if asked */</span>
00195   
00196   <span class="keywordflow">if</span> ( file_attributes ){
00197     
00198     fsal_status_t status;
00199     
00200     status = <a class="code" href="fsal__convert_8c.html#a14">hpss2fsal_attributes</a>(
00201                      &amp;(filehandle-&gt;ns_handle),
00202                      &amp;hpss_attributes,
00203                      file_attributes );
00204 
00205     
00206     <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00207     {
00208         FSAL_CLEAR_MASK( file_attributes-&gt;asked_attributes );
00209         FSAL_SET_MASK( file_attributes-&gt;asked_attributes,
00210             FSAL_ATTR_RDATTR_ERR );
00211     }
00212   }
00213   
00214   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_open);
00215   
00216 }
00217 
00218 
00219 
00220 
<a name="l00249"></a><a class="code" href="fsal__fileop_8c.html#a2">00249</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a2">FSAL_read</a>(
00250     fsal_file_t     * file_descriptor,  <span class="comment">/* IN */</span>
00251     fsal_seek_t     * seek_descriptor,  <span class="comment">/* [IN] */</span>
00252     fsal_size_t     buffer_size,        <span class="comment">/* IN */</span>
00253     caddr_t         buffer,             <span class="comment">/* OUT */</span>
00254     fsal_size_t     * read_amount,      <span class="comment">/* OUT */</span>
00255     fsal_boolean_t  * end_of_file       <span class="comment">/* OUT */</span>
00256 ){
00257 
00258   ssize_t nb_read;  
00259   size_t i_size;  
00260   <span class="keywordtype">int</span> error=0;
00261   off_t seekoffset = 0;  
00262   <span class="comment">/* sanity checks. */</span>
00263   
00264   <span class="keywordflow">if</span> ( !file_descriptor ||!buffer || !read_amount || !end_of_file )
00265     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_read);
00266 
00268   i_size = (size_t) buffer_size;
00269   
00270   
00271   <span class="comment">/* positioning */</span>
00272  
00273   <span class="keywordflow">if</span> ( seek_descriptor )
00274   {
00275   
00276     <span class="keywordflow">switch</span> ( seek_descriptor-&gt;whence )
00277     {
00278       <span class="keywordflow">case</span> FSAL_SEEK_CUR:
00279         <span class="comment">/* set position plus offset */</span>
00280         
00281         <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00282         
00283         seekoffset =
00284             hpss_Lseek( file_descriptor-&gt;filedes, 
00285                         seek_descriptor-&gt;offset,
00286                         SEEK_CUR );
00287         
00288         ReleaseTokenFSCall();
00289         
00290         <span class="keywordflow">break</span>;
00291 
00292       <span class="keywordflow">case</span> FSAL_SEEK_SET :
00293         <span class="comment">/* set absolute position to offset */</span>
00294         
00295         <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00296         
00297         seekoffset =
00298             hpss_Lseek( file_descriptor-&gt;filedes,
00299                         seek_descriptor-&gt;offset,
00300                         SEEK_SET );
00301         
00302         ReleaseTokenFSCall();
00303         
00304         <span class="keywordflow">break</span>;
00305 
00306       <span class="keywordflow">case</span> FSAL_SEEK_END :
00307         <span class="comment">/* set end of file plus offset */</span>
00308         
00309         <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00310         
00311         seekoffset =
00312             hpss_Lseek( file_descriptor-&gt;filedes, 
00313                         seek_descriptor-&gt;offset,
00314                         SEEK_END );
00315         
00316         ReleaseTokenFSCall();
00317         
00318         <span class="keywordflow">break</span>;    
00319     }
00320     
00321     <span class="keywordflow">if</span> ( seekoffset &lt; 0 )
00322     {
00323       error = (int)seekoffset;
00324       
00325       DisplayLogJdLevel( fsal_log, NIV_EVENT,
00326         <span class="stringliteral">"Error in hpss_Lseek operation (whence=%s, offset=%lld)"</span>,
00327          ( seek_descriptor-&gt;whence==FSAL_SEEK_CUR ? <span class="stringliteral">"SEEK_CUR"</span> :
00328            ( seek_descriptor-&gt;whence==FSAL_SEEK_SET ? <span class="stringliteral">"SEEK_SET"</span> :
00329              ( seek_descriptor-&gt;whence==FSAL_SEEK_END ? <span class="stringliteral">"SEEK_END"</span> : <span class="stringliteral">"ERROR"</span> ))),
00330                  seek_descriptor-&gt;offset );
00331 
00332       
00333       Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(error), -error, INDEX_FSAL_read );      
00334     }
00335 
00336   }
00337 
00338   <span class="comment">/* read operation */</span>
00339   
00340   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00341   
00342   nb_read = hpss_Read(
00343               file_descriptor-&gt;filedes, <span class="comment">/* IN - ID of object to be read  */</span>
00344               (<span class="keywordtype">void</span> *) buffer,   <span class="comment">/* IN - Buffer in which to receive data */</span>
00345               i_size );          <span class="comment">/* IN - number of bytes to read         */</span>
00346    
00347   ReleaseTokenFSCall();
00348   
00351   <span class="keywordflow">if</span> ( nb_read &lt; 0 )
00352   {
00353     error = (int)nb_read;
00354     Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(error), -error, INDEX_FSAL_read );
00355   }
00356   
00357   <span class="comment">/* set output vars */</span>
00358  
00359   *read_amount = (fsal_size_t)  nb_read; 
00360   *end_of_file = ( nb_read == 0 ); 
00361   
00362 
00363   Return( ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_read ); 
00364   
00365 }
00366 
00367 
00368 
00369 
00370 
00371 
<a name="l00397"></a><a class="code" href="fsal__fileop_8c.html#a3">00397</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a3">FSAL_write</a>(
00398     fsal_file_t        * file_descriptor,     <span class="comment">/* IN */</span>
00399     fsal_seek_t        * seek_descriptor,     <span class="comment">/* IN */</span>
00400     fsal_size_t        buffer_size,           <span class="comment">/* IN */</span>
00401     caddr_t            buffer,                <span class="comment">/* IN */</span>
00402     fsal_size_t        * write_amount         <span class="comment">/* OUT */</span>
00403 ){
00404 
00405   ssize_t nb_written;  
00406   size_t i_size;
00407   <span class="keywordtype">int</span> error=0;
00408   off_t seekoffset = 0;
00409 
00410   <span class="comment">/* sanity checks. */</span>
00411   <span class="keywordflow">if</span> ( !file_descriptor || !buffer || !write_amount )
00412     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_write);
00413 
00414   
00416   i_size = (size_t) buffer_size;
00417   
00418     
00419   <span class="comment">/* positioning */</span>
00420  
00421   <span class="keywordflow">if</span> ( seek_descriptor )
00422   {
00423   
00424     <span class="keywordflow">switch</span> ( seek_descriptor-&gt;whence )
00425     {
00426       <span class="keywordflow">case</span> FSAL_SEEK_CUR:
00427         <span class="comment">/* set position plus offset */</span>
00428         
00429         <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00430         
00431         seekoffset =
00432             hpss_Lseek( file_descriptor-&gt;filedes, 
00433                         seek_descriptor-&gt;offset,
00434                         SEEK_CUR );
00435         
00436         ReleaseTokenFSCall();
00437         
00438         <span class="keywordflow">break</span>;
00439 
00440       <span class="keywordflow">case</span> FSAL_SEEK_SET :
00441         <span class="comment">/* set absolute position to offset */</span>
00442         
00443         <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00444         
00445         seekoffset =
00446             hpss_Lseek( file_descriptor-&gt;filedes,
00447                         seek_descriptor-&gt;offset,
00448                         SEEK_SET );
00449         
00450         ReleaseTokenFSCall();
00451         
00452         <span class="keywordflow">break</span>;
00453 
00454       <span class="keywordflow">case</span> FSAL_SEEK_END :
00455         <span class="comment">/* set end of file plus offset */</span>
00456         
00457         <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00458         
00459         seekoffset =
00460             hpss_Lseek( file_descriptor-&gt;filedes, 
00461                         seek_descriptor-&gt;offset,
00462                         SEEK_END );
00463         
00464         ReleaseTokenFSCall();
00465         
00466         <span class="keywordflow">break</span>;    
00467     }
00468     
00469     <span class="keywordflow">if</span> ( seekoffset &lt; 0 )
00470     {
00471       error = (int)seekoffset;
00472       
00473       DisplayLogJdLevel( fsal_log, NIV_EVENT,
00474         <span class="stringliteral">"FSAL_write: Error in hpss_Lseek operation (whence=%s, offset=%lld)"</span>,
00475          ( seek_descriptor-&gt;whence==FSAL_SEEK_CUR ? <span class="stringliteral">"SEEK_CUR"</span> :
00476            ( seek_descriptor-&gt;whence==FSAL_SEEK_SET ? <span class="stringliteral">"SEEK_SET"</span> :
00477              ( seek_descriptor-&gt;whence==FSAL_SEEK_END ? <span class="stringliteral">"SEEK_END"</span> : <span class="stringliteral">"ERROR"</span> ))),
00478                  seek_descriptor-&gt;offset );
00479           
00480       Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(error), -error, INDEX_FSAL_write );
00481     }
00482 
00483   }
00484 
00485   
00486   <span class="comment">/* write operation */</span>
00487   
00488   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00489   
00490   nb_written = hpss_Write(
00491                   file_descriptor-&gt;filedes, <span class="comment">/* IN - ID of object to be read  */</span>
00492                   (<span class="keywordtype">void</span> *) buffer,          <span class="comment">/* IN - Buffer in which to receive data */</span>
00493                   i_size );                 <span class="comment">/* IN - number of bytes to read         */</span>
00494    
00495   
00496   ReleaseTokenFSCall();
00497   
00500   <span class="keywordflow">if</span> ( nb_written &lt; 0 )
00501   {
00502     error = (int)nb_written;
00503     Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(error), -error, INDEX_FSAL_write );
00504   }
00505   
00506   <span class="comment">/* set output vars */</span>
00507  
00508   *write_amount = (fsal_size_t)  nb_written;
00509   
00510   Return( ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_write ); 
00511   
00512 }
00513 
00514 
00515 
<a name="l00530"></a><a class="code" href="fsal__fileop_8c.html#a4">00530</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a4">FSAL_close</a>(
00531     fsal_file_t        * file_descriptor <span class="comment">/* IN */</span>
00532 ){
00533   
00534   <span class="keywordtype">int</span> rc;
00535   
00536   <span class="comment">/* sanity checks. */</span>
00537   <span class="keywordflow">if</span> ( !file_descriptor )
00538     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_close);
00539   
00540   <span class="comment">/* call to close */</span>
00541   
00542   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00543   
00544   rc = hpss_Close( file_descriptor-&gt;filedes );
00545   
00546   ReleaseTokenFSCall();
00547   
00548   <span class="keywordflow">if</span> ( rc )
00549     Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_close );
00550     
00551   Return( ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_close );
00552   
00553 }
00554 
00555 <span class="comment">/* Some unsupported calls used in FSAL_PROXY, just for permit the ganeshell to compile */</span>
00556 fsal_status_t FSAL_open_by_fileid(
00557     fsal_handle_t         * filehandle,             <span class="comment">/* IN */</span>
00558     fsal_u64_t              fileid,                 <span class="comment">/* IN */</span>
00559     fsal_op_context_t     * p_context,              <span class="comment">/* IN */</span>
00560     fsal_openflags_t        openflags,              <span class="comment">/* IN */</span>
00561     fsal_file_t           * file_descriptor,        <span class="comment">/* OUT */</span>
00562     fsal_attrib_list_t    * file_attributes         <span class="comment">/* [ IN/OUT ] */</span> )
00563 {
00564   Return(ERR_FSAL_NOTSUPP ,0 , INDEX_FSAL_open_by_fileid);
00565 }
00566 
00567 fsal_status_t FSAL_close_by_fileid(
00568     fsal_file_t        * file_descriptor <span class="comment">/* IN */</span>,
00569     fsal_u64_t           fileid )
00570 {
00571   Return(ERR_FSAL_NOTSUPP ,0 , INDEX_FSAL_open_by_fileid);
00572 }
00573 
00574 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
