<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: test_fsal.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>test_fsal.c</h1><a href="test__fsal_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "log_functions.h"</span>
00020 <span class="preprocessor">#include &lt;unistd.h&gt;</span> <span class="comment">/* for using gethostname */</span>
00021 <span class="preprocessor">#include &lt;stdlib.h&gt;</span> <span class="comment">/* for using exit */</span>
00022 <span class="preprocessor">#include &lt;string.h&gt;</span>
00023 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00024 <span class="preprocessor">#include "BuddyMalloc.h"</span>
00025 
00026 <span class="preprocessor">#define READDIR_SIZE 5</span>
00027 <span class="preprocessor"></span>
00028 
00029 <span class="keywordtype">void</span> printmask(fsal_attrib_mask_t mask){
00030 
00031 
00032   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_SUPPATTR))
00033     printf(<span class="stringliteral">"FSAL_ATTR_SUPPATTR\n"</span>);
00034   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_TYPE))
00035     printf(<span class="stringliteral">"FSAL_ATTR_TYPE\n"</span>);
00036   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_SIZE))
00037     printf(<span class="stringliteral">"FSAL_ATTR_SIZE\n"</span>);
00038   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_FSID))
00039     printf(<span class="stringliteral">"FSAL_ATTR_FSID\n"</span>);
00040   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_ACL ))
00041     printf(<span class="stringliteral">"FSAL_ATTR_ACL \n"</span>);
00042   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_FILEID))
00043     printf(<span class="stringliteral">"FSAL_ATTR_FILEID\n"</span>);
00044   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_MODE))
00045     printf(<span class="stringliteral">"FSAL_ATTR_MODE\n"</span>);
00046   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_NUMLINKS))
00047     printf(<span class="stringliteral">"FSAL_ATTR_NUMLINKS\n"</span>);
00048   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_OWNER ))
00049     printf(<span class="stringliteral">"FSAL_ATTR_OWNER\n"</span>);
00050   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_GROUP ))
00051     printf(<span class="stringliteral">"FSAL_ATTR_GROUP\n"</span>);
00052   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_RAWDEV))
00053     printf(<span class="stringliteral">"FSAL_ATTR_RAWDEV\n"</span>);
00054   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_ATIME ))
00055     printf(<span class="stringliteral">"FSAL_ATTR_ATIME\n"</span>);
00056   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_CREATION))
00057     printf(<span class="stringliteral">"FSAL_ATTR_CREATION\n"</span>);
00058   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_CTIME ))
00059     printf(<span class="stringliteral">"FSAL_ATTR_CTIME\n"</span>);
00060   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_CHGTIME ))
00061     printf(<span class="stringliteral">"FSAL_ATTR_CHGTIME\n"</span>);
00062   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_MTIME ))
00063     printf(<span class="stringliteral">"FSAL_ATTR_MTIME\n"</span>);
00064   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_SPACEUSED ))
00065     printf(<span class="stringliteral">"FSAL_ATTR_SPACEUSED\n"</span>);
00066   <span class="keywordflow">if</span> (FSAL_TEST_MASK( mask , FSAL_ATTR_MOUNTFILEID ))
00067     printf(<span class="stringliteral">"FSAL_ATTR_MOUNTFILEID\n"</span>);
00068       
00069 }
00070 
00071 <span class="keywordtype">char</span> * strtype(fsal_nodetype_t type){
00072   <span class="keywordflow">switch</span>(type){
00073   <span class="keywordflow">case</span> FSAL_TYPE_FIFO :
00074     <span class="keywordflow">return</span> <span class="stringliteral">"FSAL_TYPE_FIFO "</span>;
00075   <span class="keywordflow">case</span> FSAL_TYPE_CHR  :
00076     <span class="keywordflow">return</span> <span class="stringliteral">"FSAL_TYPE_CHR  "</span>;
00077   <span class="keywordflow">case</span> FSAL_TYPE_DIR  :
00078     <span class="keywordflow">return</span> <span class="stringliteral">"FSAL_TYPE_DIR  "</span>;
00079   <span class="keywordflow">case</span> FSAL_TYPE_BLK  :
00080     <span class="keywordflow">return</span> <span class="stringliteral">"FSAL_TYPE_BLK  "</span>;
00081   <span class="keywordflow">case</span> FSAL_TYPE_FILE :
00082     <span class="keywordflow">return</span> <span class="stringliteral">"FSAL_TYPE_FILE "</span>;
00083   <span class="keywordflow">case</span> FSAL_TYPE_LNK  :
00084     <span class="keywordflow">return</span> <span class="stringliteral">"FSAL_TYPE_LNK  "</span>;
00085   <span class="keywordflow">case</span> FSAL_TYPE_JUNCTION :
00086     <span class="keywordflow">return</span> <span class="stringliteral">"FSAL_TYPE_JUNCTION"</span>;
00087   <span class="keywordflow">case</span> 0 :
00088     <span class="keywordflow">return</span> <span class="stringliteral">"(null)         "</span>;
00089     
00090   <span class="keywordflow">default</span>:
00091     <span class="keywordflow">return</span> <span class="stringliteral">"Unknown type"</span>;
00092   }
00093 }
00094 
00095 
00096 <span class="keywordtype">void</span> printattributes( fsal_attrib_list_t attrs){
00097   
00098   <span class="keywordflow">if</span> (FSAL_TEST_MASK( attrs.asked_attributes , FSAL_ATTR_RDATTR_ERR ))
00099       printf(<span class="stringliteral">"FSAL_ATTR_RDATTR_ERR\n"</span>);
00100   
00101   
00102   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_TYPE))
00103     printf(<span class="stringliteral">"Type : %s\n"</span>,strtype(attrs.type));
00104   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_SIZE))
00105     printf(<span class="stringliteral">"Size : %llu\n"</span>,attrs.filesize);
00106   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_FSID))
00107     printf(<span class="stringliteral">"fsId : %llu.%llu\n"</span>,attrs.fsid.major,attrs.fsid.minor);
00108   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_ACL ))
00109     printf(<span class="stringliteral">"ACL List ...\n"</span>);
00110   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_FILEID))
00111     printf(<span class="stringliteral">"FileId : %llu\n"</span>,attrs.fileid);
00112   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_MODE))
00113     printf(<span class="stringliteral">"Mode : %#o\n"</span>,attrs.mode);
00114   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_NUMLINKS))
00115     printf(<span class="stringliteral">"Numlinks : %u\n"</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)attrs.numlinks);
00116   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_OWNER ))
00117     printf(<span class="stringliteral">"uid : %d\n"</span>,attrs.owner);
00118   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_GROUP ))
00119     printf(<span class="stringliteral">"gid : %d\n"</span>,attrs.group);
00120   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_RAWDEV))
00121     printf(<span class="stringliteral">"Rawdev ...\n"</span>);
00122   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_ATIME ))
00123     printf(<span class="stringliteral">"atime : %s"</span>,ctime((time_t *)&amp;attrs.atime.seconds));
00124   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_CREATION))
00125     printf(<span class="stringliteral">"creation time : %s"</span>,ctime((time_t *)&amp;attrs.creation.seconds));
00126   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_CTIME ))
00127     printf(<span class="stringliteral">"ctime : %s"</span>,ctime((time_t *)&amp;attrs.ctime.seconds));
00128   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_MTIME ))
00129     printf(<span class="stringliteral">"mtime : %s"</span>,ctime((time_t *)&amp;attrs.mtime.seconds));
00130   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_CHGTIME ))
00131     printf(<span class="stringliteral">"chgtime : %s"</span>,ctime((time_t *)&amp;attrs.chgtime.seconds));
00132   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_SPACEUSED ))
00133     printf(<span class="stringliteral">"spaceused : %llu\n"</span>,attrs.spaceused);
00134   <span class="keywordflow">if</span> (FSAL_TEST_MASK(attrs.asked_attributes, FSAL_ATTR_MOUNTFILEID ))
00135     printf(<span class="stringliteral">"mounted_on_fileid : %llu\n"</span>,attrs.mounted_on_fileid);
00136 
00137     
00138 }
00139 
00140 
00141 <span class="keywordtype">void</span> usage(){
00142   fprintf(stderr,<span class="stringliteral">"Usage :\n\ttest_fsal &lt;no_test&gt;\n"</span>);
00143   fprintf(stderr,<span class="stringliteral">"\ttests :\n"</span>);
00144   fprintf(stderr,<span class="stringliteral">"\t\t1 - getattrs\n"</span>);
00145   fprintf(stderr,<span class="stringliteral">"\t\t2 - lookup\n"</span>);
00146   fprintf(stderr,<span class="stringliteral">"\t\t3 - lookupPath\n"</span>);
00147   fprintf(stderr,<span class="stringliteral">"\t\t4 - readdir (acces par tableau)\n"</span>);
00148   fprintf(stderr,<span class="stringliteral">"\t\t5 - readdir (acces liste chainee)\n"</span>);
00149   fprintf(stderr,<span class="stringliteral">"\t\t6 - access/test_access\n"</span>);
00150   fprintf(stderr,<span class="stringliteral">"\t\t7 - snprintmem/sscanmem\n"</span>);
00151   fprintf(stderr,<span class="stringliteral">"\t\t8 - mkdir/rmdir\n"</span>);
00152   fprintf(stderr,<span class="stringliteral">"\t\t9 - setattr\n"</span>);
00153   fprintf(stderr,<span class="stringliteral">"\t\tA - digest/expend handle\n"</span>);
00154   fprintf(stderr,<span class="stringliteral">"\t\tB - dynamic fs info\n"</span>);
00155   <span class="keywordflow">return</span>;
00156 }
00157 
00158 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv){
00159 
00160   <span class="keywordtype">char</span>            localmachine[256] ;
00161   <span class="keywordtype">char</span> * test;
00162   fsal_parameter_t  init_param;
00163   fsal_status_t   st;
00164   log_t log_desc = LOG_INITIALIZER;
00165   desc_log_stream_t  voie ;
00166   uid_t uid;
00167   fsal_export_context_t export_ctx;
00168   fsal_op_context_t    op_ctx;
00169   fsal_handle_t root_handle, handle;
00170   fsal_name_t name ;
00171   fsal_path_t path;
00172   fsal_attrib_list_t attribs;
00173   fsal_attrib_mask_t mask;
00174    
00175   <span class="keywordtype">char</span> tracebuff[256];
00176   
00177   <span class="keywordflow">if</span> (argc&lt;2){
00178     usage();
00179     exit(-1);
00180   }
00181   test = argv[1];
00182   <span class="comment">/* retrieving params */</span>
00183   
00184 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00185 <span class="preprocessor"></span>  BuddyInit( NULL );  
00186 <span class="preprocessor">#endif  </span>
00187 <span class="preprocessor"></span>  
00188   <span class="comment">/* init debug */</span>
00189   
00190   SetNamePgm( <span class="stringliteral">"test_fsal"</span> ) ;
00191   SetNameFileLog( <span class="stringliteral">"/dev/tty"</span> ) ;
00192   SetNameFunction( <span class="stringliteral">"main"</span> ) ;
00193   
00194   <span class="comment">/* Obtention du nom de la machine */</span>
00195   <span class="keywordflow">if</span>( gethostname( localmachine, <span class="keyword">sizeof</span>( localmachine ) ) != 0 )
00196     {
00197       DisplayErrorLog( ERR_SYS, ERR_GETHOSTNAME, errno ) ;
00198       exit( 1 ) ;
00199     }
00200   <span class="keywordflow">else</span>
00201     SetNameHost( localmachine ) ;
00202 
00203   InitDebug( NIV_FULL_DEBUG ) ;
00204 
00205   AddFamilyError( ERR_FSAL, <span class="stringliteral">"FSAL related Errors"</span>, tab_errstatus_FSAL ) ;
00206   
00207   <span class="comment">/* creating log */</span>
00208   voie.fd = fileno( stderr ) ;
00209   AddLogStreamJd( &amp;log_desc, V_FD,voie,NIV_FULL_DEBUG,SUP);
00210   
00211   <span class="comment">/* prepare fsal_init */</span>
00212   
00213   <span class="comment">/* 1 - fs specific info */</span>
00214   
00215 <span class="preprocessor">#ifdef _USE_HPSS_51  </span>
00216 <span class="preprocessor"></span>  
00217   init_param.fs_specific_info.behaviors.PrincipalName = FSAL_INIT_FORCE_VALUE ;
00218   strcpy(init_param.fs_specific_info.hpss_config.PrincipalName,<span class="stringliteral">"hpss_nfs"</span>);
00219   
00220   init_param.fs_specific_info.behaviors.KeytabPath = FSAL_INIT_FORCE_VALUE ;
00221   strcpy(init_param.fs_specific_info.hpss_config.KeytabPath,<span class="stringliteral">"/krb5/hpssserver.keytab"</span>);
00222 
00223 <span class="preprocessor">#elif defined _USE_HPSS_62</span>
00224 <span class="preprocessor"></span>  init_param.fs_specific_info.behaviors.AuthnMech = FSAL_INIT_FORCE_VALUE ;
00225   init_param.fs_specific_info.hpss_config.AuthnMech = hpss_authn_mech_krb5 ;
00226   
00227   init_param.fs_specific_info.behaviors.Principal = FSAL_INIT_FORCE_VALUE ;  
00228   strcpy( init_param.fs_specific_info.Principal , <span class="stringliteral">"hpssfs"</span> );
00229   
00230   init_param.fs_specific_info.behaviors.KeytabPath = FSAL_INIT_FORCE_VALUE ;  
00231   strcpy( init_param.fs_specific_info.KeytabPath , <span class="stringliteral">"/var/hpss/etc/hpss.keytab"</span> );
00232 
00233 <span class="preprocessor">#endif</span>
00234 <span class="preprocessor"></span>    
00235   
00236   <span class="comment">/* 2-common info (default) */</span>
00237   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info,maxfilesize);
00238   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info,maxlink);
00239   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, maxnamelen);
00240   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, maxpathlen);
00241   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, no_trunc);
00242   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, chown_restricted);
00243   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, case_insensitive);
00244   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, case_preserving);
00245   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, fh_expire_type);
00246   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, link_support);
00247   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, symlink_support);  
00248   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, named_attr);
00249   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, unique_handles);
00250   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, lease_time);
00251   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, acl_support);
00252   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, cansettime);
00253   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, homogenous);
00254   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, supported_attrs);
00255   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, maxread);
00256   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, maxwrite);
00257   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, umask);  
00258   FSAL_SET_INIT_DEFAULT( init_param.fs_common_info, auth_exportpath_xdev);  
00259   
00260   <span class="comment">/* 3- fsal info*/</span>  
00261   init_param.fsal_info.log_outputs=log_desc;  
00262   init_param.fsal_info.max_fs_calls = 0;
00263   
00264   <span class="comment">/* Init */</span>
00265   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00266         st = <a class="code" href="fsal__init_8c.html#a7">FSAL_Init</a>(&amp;init_param))){
00267     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00268   }
00269   
00270   <span class="comment">/* getting creds */</span>
00271   uid=getuid();
00272   printf(<span class="stringliteral">"uid = %d\n"</span>,uid);
00273   
00274   st = <a class="code" href="group__FSALCredFunctions.html#ga0">FSAL_BuildExportContext</a>( &amp;export_ctx,NULL, NULL );
00275   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) )
00276     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00277   
00278   st = FSAL_InitClientContext(&amp;op_ctx);
00279     
00280   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) )
00281     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00282 
00283   st = <a class="code" href="group__FSALCredFunctions.html#ga2">FSAL_GetClientContext</a>( &amp;op_ctx, &amp;export_ctx, uid, -1 , NULL, 0 );
00284     
00285   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) )
00286     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00287 
00288     
00289   <span class="comment">/* getting root handle */</span>
00290   
00291   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00292         st = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a>(NULL,NULL,&amp;op_ctx,&amp;root_handle,NULL))){
00293     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00294   }
00295 
00296   snprintHandle(tracebuff,256,&amp;root_handle);
00297   printf(<span class="stringliteral">"Root handle = %s\n"</span>,tracebuff);
00298 
00299   <span class="comment">/* getting what are the supported attributes */</span>
00300       
00301   attribs.asked_attributes = 0;
00302   FSAL_SET_MASK( attribs.asked_attributes , FSAL_ATTR_SUPPATTR );
00303   printf(<span class="stringliteral">"asked attributes :\n"</span>);
00304   printmask(attribs.asked_attributes);
00305     
00306   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00307         st = <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>(&amp;root_handle,&amp;op_ctx,&amp;attribs))){
00308     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00309   }
00310   
00311   printf(<span class="stringliteral">"supported attributes :\n"</span>);
00312   printmask(attribs.supported_attributes);
00313   
00314   mask = attribs.supported_attributes;
00315   
00316 <span class="comment">/* TEST 1 */</span>
00317   
00318 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'1'</span>) {
00319   
00320   attribs.asked_attributes = 0;
00321   FSAL_SET_MASK( attribs.asked_attributes , FSAL_ATTR_SUPPATTR );
00322   printf(<span class="stringliteral">"asked attributes :\n"</span>);
00323   printmask(attribs.asked_attributes);
00324     
00325   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00326         st = <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>(&amp;root_handle,&amp;op_ctx,&amp;attribs))){
00327     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00328   }
00329   
00330   printf(<span class="stringliteral">"supported attributes :\n"</span>);
00331     
00332   <span class="comment">/* getting all spported attributes of root */</span>
00333   attribs.asked_attributes = mask;
00334   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00335         st = <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>(&amp;root_handle,&amp;op_ctx,&amp;attribs))){
00336     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00337   }
00338   
00339   printattributes(attribs);
00340 
00341 }
00342 <span class="keywordflow">else</span>
00343 <span class="comment">/* TEST 2 */</span>    
00344 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'2'</span>) {
00345   
00346   <span class="comment">/* getting handle and attributes for subdirectory "OSF1_V5"*/</span>
00347   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00348         st = <a class="code" href="group__FSALNameFunctions.html#ga0">FSAL_str2name</a>(<span class="stringliteral">"cea"</span>,4,&amp;name))){
00349     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00350   }
00351 
00352   attribs.asked_attributes = mask;
00353   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00354         st = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a>(&amp;root_handle,&amp;name,&amp;op_ctx,&amp;handle,&amp;attribs))){
00355     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00356   }
00357   
00358   snprintHandle(tracebuff,256,&amp;handle);
00359   printf(<span class="stringliteral">"/cea handle = %s\n"</span>,tracebuff);
00360       
00361   <span class="comment">/* displaying attributes */</span>
00362   printattributes(attribs);
00363   
00364   
00365   <span class="comment">/* getting handle and attributes for subdirectory "bin"*/</span>
00366   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00367         st = <a class="code" href="group__FSALNameFunctions.html#ga0">FSAL_str2name</a>(<span class="stringliteral">"prot"</span>,5,&amp;name))){
00368     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00369   }
00370   root_handle = handle;
00371   attribs.asked_attributes = mask;
00372   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00373         st = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a>(&amp;root_handle,&amp;name,&amp;op_ctx,&amp;handle,&amp;attribs))){
00374     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00375   }
00376   
00377   snprintHandle(tracebuff,256,&amp;handle);
00378   printf(<span class="stringliteral">"/cea/prot handle = %s\n"</span>,tracebuff);
00379       
00380   <span class="comment">/* displaying attributes */</span>
00381   printattributes(attribs);
00382   
00383   <span class="comment">/* getting handle and attributes for symlink "AglaePwrSW"*/</span>
00384   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00385         st = <a class="code" href="group__FSALNameFunctions.html#ga0">FSAL_str2name</a>(<span class="stringliteral">"lama"</span>,5,&amp;name))){
00386     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00387   }
00388   root_handle = handle;
00389   attribs.asked_attributes = mask;
00390   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00391         st = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a>(&amp;root_handle,&amp;name,&amp;op_ctx,&amp;handle,&amp;attribs))){
00392     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00393   }  
00394   
00395   snprintHandle(tracebuff,256,&amp;handle);
00396   printf(<span class="stringliteral">"/cea/prot/lama handle = %s\n"</span>,tracebuff);
00397       
00398   <span class="comment">/* displaying attributes */</span>
00399   printattributes(attribs);
00400 
00401 }
00402 <span class="keywordflow">else</span>
00403 <span class="comment">/* TEST 3 */</span>    
00404 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'3'</span>) {
00405 
00406   <span class="comment">/* lookup root */</span>
00407   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00408         st = <a class="code" href="group__FSALNameFunctions.html#ga1">FSAL_str2path</a>(<span class="stringliteral">"/"</span>,30,&amp;path))){
00409     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00410   }
00411   attribs.asked_attributes = mask;
00412   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00413         st = <a class="code" href="fsal__lookup_8c.html#a2">FSAL_lookupPath</a>(&amp;path,&amp;op_ctx,&amp;handle,&amp;attribs))){
00414     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00415   }  
00416   
00417   snprintHandle(tracebuff,256,&amp;handle);
00418   printf(<span class="stringliteral">"/ handle = %s\n"</span>,tracebuff);
00419       
00420   <span class="comment">/* displaying attributes */</span>
00421   printattributes(attribs);      
00422 
00423   <span class="comment">/* lookup path */</span>
00424   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00425         st = <a class="code" href="group__FSALNameFunctions.html#ga1">FSAL_str2path</a>(<span class="stringliteral">"/cea/prot/lama"</span>,15,&amp;path))){
00426     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00427   }
00428   attribs.asked_attributes = mask;
00429   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00430         st = <a class="code" href="fsal__lookup_8c.html#a2">FSAL_lookupPath</a>(&amp;path,&amp;op_ctx,&amp;handle,&amp;attribs))){
00431     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00432   }  
00433   
00434   snprintHandle(tracebuff,256,&amp;handle);
00435   printf(<span class="stringliteral">"/cea/prot/lama handle = %s\n"</span>,tracebuff);
00436       
00437   <span class="comment">/* displaying attributes */</span>
00438   printattributes(attribs);      
00439 
00440   
00441 }
00442 <span class="keywordflow">else</span>
00443 <span class="comment">/* TEST 4 */</span>    
00444 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'4'</span>) {
00445   
00446   <span class="comment">/* readdir on root */</span>
00447   fsal_dir_t dir;
00448   fsal_cookie_t from,to;
00449   fsal_dirent_t entries[READDIR_SIZE];
00450   fsal_count_t number;
00451   fsal_boolean_t eod = FALSE;
00452   <span class="keywordtype">int</span> error = FALSE;
00453   
00454   attribs.asked_attributes = mask;
00455   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00456         st = <a class="code" href="fsal__dirs_8c.html#a0">FSAL_opendir</a>(&amp;root_handle,&amp;op_ctx,&amp;dir,&amp;attribs))){
00457     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00458   }  
00459   printf(<span class="stringliteral">"'/' attributes :\n"</span>);
00460       
00461   <span class="comment">/* displaying attributes */</span>
00462   printattributes(attribs);      
00463     
00464   from = FSAL_READDIR_FROM_BEGINNING;
00465   
00466   <span class="keywordflow">while</span> (!error &amp;&amp; !eod){
00467     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00468     <span class="keywordtype">char</span> cookiebuff[256];
00469     
00470     snprintCookie(cookiebuff,256,&amp;from);
00471     printf(<span class="stringliteral">"\nReaddir cookie = %s\n"</span>,cookiebuff);
00472     <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00473           st = <a class="code" href="fsal__dirs_8c.html#a1">FSAL_readdir</a>(&amp;dir, from,
00474                             mask,READDIR_SIZE * <span class="keyword">sizeof</span>(fsal_dirent_t),
00475                             entries, &amp;to , &amp;number, &amp;eod ))){
00476       DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00477       error = TRUE;
00478     }
00479     
00480     <span class="keywordflow">for</span> (i=0;(!error) &amp;&amp; (i&lt;number);i++){
00481       
00482       snprintHandle(tracebuff,256,&amp;entries[i].handle);
00483 
00484       snprintCookie(cookiebuff,256,&amp;entries[i].cookie);
00485             
00486       printf(<span class="stringliteral">"\t%s : %s (cookie %s)\n"</span>, tracebuff,
00487           entries[i].name.name, cookiebuff );
00488     }
00489     <span class="comment">/* preparing next call */</span>
00490     from = to;
00491     
00492   }
00493   printf(<span class="stringliteral">"Fin de boucle : error=%d ; eod=%d\n"</span>,error,eod);  
00494   
00495 }
00496 <span class="keywordflow">else</span>
00497 <span class="comment">/* TEST 5 */</span>    
00498 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'5'</span>) {
00499   
00500   <span class="comment">/* readdir on root */</span>
00501   fsal_dir_t dir;
00502   fsal_cookie_t from,to;
00503   fsal_dirent_t entries[READDIR_SIZE];
00504   fsal_count_t number;
00505   fsal_boolean_t eod = FALSE;
00506   <span class="keywordtype">int</span> error = FALSE;
00507   
00508   attribs.asked_attributes = mask;
00509   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00510         st = <a class="code" href="fsal__dirs_8c.html#a0">FSAL_opendir</a>(&amp;root_handle,&amp;op_ctx,&amp;dir,&amp;attribs))){
00511     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00512   }  
00513   printf(<span class="stringliteral">"'/' attributes :\n"</span>);
00514       
00515   <span class="comment">/* displaying attributes */</span>
00516   printattributes(attribs);      
00517   
00518   
00519   from = FSAL_READDIR_FROM_BEGINNING;
00520   
00521   <span class="keywordflow">while</span> (!error &amp;&amp; !eod){
00522     fsal_dirent_t * curr;
00523     
00524     <span class="keywordtype">char</span> cookiebuff[256];
00525    
00526     snprintCookie(cookiebuff,256,&amp;from);
00527     
00528     printf(<span class="stringliteral">"\nReaddir cookie = %s\n"</span>,cookiebuff);
00529     
00530     <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00531           st = <a class="code" href="fsal__dirs_8c.html#a1">FSAL_readdir</a>(&amp;dir, from,
00532                             mask,READDIR_SIZE * <span class="keyword">sizeof</span>(fsal_dirent_t),
00533                             entries, &amp;to , &amp;number, &amp;eod ))){
00534       DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00535       error = TRUE;
00536     }
00537     
00538     <span class="keywordflow">if</span> (number&gt;0){
00539       curr = entries;
00540       <span class="keywordflow">do</span> {
00541         
00542       snprintHandle(tracebuff,256,&amp;curr-&gt;handle);
00543       snprintCookie(cookiebuff,256,&amp;curr-&gt;cookie);
00544         
00545       printf(<span class="stringliteral">"\t%s : %s (cookie %s)\n"</span>, tracebuff,
00546           curr-&gt;name.name, cookiebuff );
00547       } <span class="keywordflow">while</span>(curr = curr-&gt;nextentry);
00548     }
00549     <span class="comment">/* preparing next call */</span>
00550     from = to;
00551     
00552   }
00553   printf(<span class="stringliteral">"Fin de boucle : error=%d ; eod=%d\n"</span>,error,eod);  
00554   
00555 }
00556 <span class="keywordflow">else</span>
00557 <span class="comment">/* TEST 6 */</span>
00558 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'6'</span>) {
00559   
00560   <span class="comment">/* readdir on root */</span>
00561   fsal_dir_t dir;
00562   fsal_cookie_t from,to;
00563   fsal_dirent_t entries[READDIR_SIZE];
00564   fsal_count_t number;
00565   fsal_boolean_t eod = FALSE;
00566   <span class="keywordtype">int</span> error = FALSE;
00567   
00568   attribs.asked_attributes = mask;
00569   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00570         st = <a class="code" href="fsal__dirs_8c.html#a0">FSAL_opendir</a>(&amp;root_handle,&amp;op_ctx,&amp;dir,&amp;attribs))){
00571     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00572   }  
00573   printf(<span class="stringliteral">"'/' attributes :\n"</span>);
00574       
00575   <span class="comment">/* displaying attributes */</span>
00576   printattributes(attribs);      
00577   
00578   
00579   from = FSAL_READDIR_FROM_BEGINNING;
00580   
00581   <span class="keywordflow">while</span> (!error &amp;&amp; !eod){
00582     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00583     
00584     snprintCookie(tracebuff,256,&amp;from);
00585     printf(<span class="stringliteral">"\nReaddir cookie = %s\n"</span>,tracebuff);
00586     
00587     st = <a class="code" href="fsal__dirs_8c.html#a1">FSAL_readdir</a>( &amp;dir, from, mask,
00588                        READDIR_SIZE * <span class="keyword">sizeof</span>(fsal_dirent_t),
00589                        entries, &amp;to , &amp;number, &amp;eod );
00590     
00591     <span class="keywordflow">if</span> (FSAL_IS_ERROR( st ) )
00592     {
00593       DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00594       error = TRUE;
00595     }
00596     
00597     <span class="comment">/* for each entry, we compare the result of FSAL_access</span>
00598 <span class="comment">     * to FSAL_test_access. */</span>
00599     <span class="keywordflow">for</span> (i=0;(!error) &amp;&amp; (i&lt;number);i++){
00600       
00601       fsal_status_t st1,st2;
00602       <span class="keywordtype">char</span> cookiebuff[256];
00603    
00604       snprintHandle(tracebuff,256,&amp;entries[i].handle);
00605       snprintCookie(cookiebuff,256,&amp;entries[i].cookie);
00606            
00607       printf(<span class="stringliteral">"\t%s : %s (cookie %s)\n"</span>, tracebuff,
00608           entries[i].name.name, cookiebuff);
00609 
00610       <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00611           st = <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>(  &amp;entries[i].handle,&amp;op_ctx,&amp;attribs ))){
00612         DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00613       }
00614       
00615       <span class="comment">/* 1 - test R access */</span>
00616       
00617       st1 = <a class="code" href="fsal__access_8c.html#a0">FSAL_access</a>(  &amp;entries[i].handle, &amp;op_ctx, FSAL_R_OK, NULL );
00618       
00619       st2 = <a class="code" href="fsal__local__op_8c.html#a0">FSAL_test_access</a>(  &amp;op_ctx,FSAL_R_OK,&amp;attribs);
00620       
00621       DisplayErrorJd(log_desc,ERR_FSAL,st1.major,st1.minor);
00622       DisplayErrorJd(log_desc,ERR_FSAL,st2.major,st2.minor);
00623 
00624       <span class="keywordflow">if</span> (st1.major != st2.major){
00625         printf(<span class="stringliteral">"Error : different access permissions given by FSAL_access and FSAL_test_access : %d &lt;&gt;%d\n"</span>,
00626             st1.major,st2.major 
00627             );
00628       }
00629       
00630       <span class="comment">/* 2 - test W access */</span>
00631       
00632       st1 = <a class="code" href="fsal__access_8c.html#a0">FSAL_access</a>(  &amp;entries[i].handle, &amp;op_ctx, FSAL_W_OK, NULL );
00633       
00634       st2 = <a class="code" href="fsal__local__op_8c.html#a0">FSAL_test_access</a>(  &amp;op_ctx,FSAL_W_OK,&amp;attribs);
00635       
00636       DisplayErrorJd(log_desc,ERR_FSAL,st1.major,st1.minor);
00637       DisplayErrorJd(log_desc,ERR_FSAL,st2.major,st2.minor);
00638 
00639       <span class="keywordflow">if</span> (st1.major != st2.major){
00640         printf(<span class="stringliteral">"Error : different access permissions given by FSAL_access and FSAL_test_access : %d &lt;&gt;%d\n"</span>,
00641             st1.major,st2.major 
00642             );
00643       }
00644       
00645       <span class="comment">/* 3 - test X access */</span>
00646       
00647       st1 = <a class="code" href="fsal__access_8c.html#a0">FSAL_access</a>(  &amp;entries[i].handle, &amp;op_ctx, FSAL_X_OK, NULL );
00648       
00649       st2 = <a class="code" href="fsal__local__op_8c.html#a0">FSAL_test_access</a>(  &amp;op_ctx,FSAL_X_OK,&amp;attribs);
00650       
00651       DisplayErrorJd(log_desc,ERR_FSAL,st1.major,st1.minor);
00652       DisplayErrorJd(log_desc,ERR_FSAL,st2.major,st2.minor);
00653 
00654       <span class="keywordflow">if</span> (st1.major != st2.major){
00655         printf(<span class="stringliteral">"Error : different access permissions given by FSAL_access and FSAL_test_access : %d &lt;&gt;%d\n"</span>,
00656             st1.major,st2.major 
00657             );
00658       }
00659       
00660     }
00661     
00662     <span class="comment">/* preparing next call */</span>
00663     from = to;
00664     
00665   }
00666   printf(<span class="stringliteral">"Fin de boucle : error=%d ; eod=%d\n"</span>,error,eod);  
00667   
00668 }
00669 <span class="keywordflow">else</span>
00670 <span class="comment">/* TEST 7 */</span>
00671 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'7'</span>) {
00672 
00673   <span class="comment">/* test snprintmem and sscanmem */</span>
00674   <span class="keywordtype">char</span> test_string[] =
00675       <span class="stringliteral">"Ceci est une chaine d'essai.\nLes chiffres : 0123456789\nLes lettres : ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;
00676   
00677   <span class="keywordtype">char</span> buffer[256];
00678   <span class="keywordtype">char</span> string[200]; <span class="comment">/* 200 suffit car test_string fait &lt;100 */</span>
00679   
00680   <span class="keywordtype">int</span> size1, size2, size3, i;
00681   
00682   <span class="comment">/* we put bad values in string, to see if it is correctly set. */</span>
00683   <span class="keywordflow">for</span> (i=0;i&lt;200;i++)
00684     string[i]=(char)i;
00685   
00686   
00687   printf(<span class="stringliteral">"Initial data (%d Bytes) = &lt;&lt;%s&gt;&gt;\n"</span>,strlen(test_string),test_string);  
00688 
00689   <span class="comment">/* Write test_string to a buffer. */</span>
00690   <span class="comment">/* We don't give the final '\0'.  */</span>
00691   snprintmem( buffer,256, test_string, strlen(test_string) );
00692   
00693   printf(<span class="stringliteral">"Dest_Buffer (%d Bytes) = &lt;&lt;%s&gt;&gt;\n"</span>,strlen(buffer),buffer);
00694   
00695   
00696   <span class="comment">/* read the value from the buffer */</span>
00697   sscanmem(string,strlen(test_string),buffer);
00698   
00699   <span class="comment">/* sets the final 0 to print the content of the buffer */</span>
00700   printf(<span class="stringliteral">"Retrieved string : following byte = %d\n"</span>,(<span class="keywordtype">int</span>)string[strlen(test_string)]);
00701   string[strlen(test_string)]=<span class="charliteral">'\0'</span>;
00702     
00703   printf(<span class="stringliteral">"Retrieved string (%d Bytes) = &lt;&lt;%s&gt;&gt;\n"</span>,strlen(string),string);
00704   
00705   <span class="comment">/* Automatic tests : */</span>
00706   size1=strlen(test_string);
00707   size2=strlen(buffer);
00708   size3=strlen(string);
00709   
00710   printf(<span class="stringliteral">"-------------------------------------\n"</span>);
00711   
00712   <span class="keywordflow">if</span> (size1 &lt;= 0 ) printf(<span class="stringliteral">"***** ERROR: source size=0 !!!\n"</span>);
00713   
00714   <span class="keywordflow">if</span> (size1 != size3) printf(<span class="stringliteral">"***** ERROR: source size &lt;&gt; target size\n"</span>);
00715   <span class="keywordflow">else</span> printf(<span class="stringliteral">"OK: source size = target size\n"</span>);
00716   
00717   <span class="keywordflow">if</span> ((size1 * 2) != size2) printf(<span class="stringliteral">"***** ERROR: hexa size &lt;&gt; 2 * source size\n"</span>);
00718   <span class="keywordflow">else</span> printf(<span class="stringliteral">"OK: hexa size = 2 * source size\n"</span>);
00719   
00720   <span class="keywordflow">if</span> (strcmp(test_string,string)) printf(<span class="stringliteral">"***** ERROR: source string &lt;&gt; target string\n"</span>);
00721   <span class="keywordflow">else</span> printf(<span class="stringliteral">"OK: source string = target string\n"</span>);  
00722   
00723     
00724 }
00725 <span class="keywordflow">else</span>
00726 <span class="comment">/* TEST 8 */</span>
00727 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'8'</span>) {
00728 
00729   fsal_handle_t dir_hdl, subdir_hdl;
00730   fsal_name_t   subdir_name;
00731         
00732   <span class="comment">/* lookup on /cea/prot/S/lama/s8/leibovic */</span>
00733   
00734   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00735         st = <a class="code" href="group__FSALNameFunctions.html#ga1">FSAL_str2path</a>(<span class="stringliteral">"/cea/prot/S/lama/s8/leibovic"</span>,40,&amp;path))){
00736     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00737   }
00738   attribs.asked_attributes = mask;
00739   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00740         st = <a class="code" href="fsal__lookup_8c.html#a2">FSAL_lookupPath</a>(&amp;path,&amp;op_ctx,&amp;handle,&amp;attribs))){
00741     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00742   }
00743   
00744   snprintHandle(tracebuff,256,&amp;handle);
00745   printf(<span class="stringliteral">"/cea/prot/S/lama/s8/leibovic: handle = %s\n"</span>,tracebuff);
00746     
00747   sleep(1);
00748   
00749   <span class="comment">/* creates a directory */</span>
00750   printf(<span class="stringliteral">"------- Create a directory -------\n"</span>);
00751   
00752   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00753         st = <a class="code" href="group__FSALNameFunctions.html#ga0">FSAL_str2name</a>(<span class="stringliteral">"tests_GANESHA"</span>,30,&amp;name))){
00754     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00755   }
00756   
00757   attribs.asked_attributes = mask;
00758   
00759   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00760        st = <a class="code" href="fsal__create_8c.html#a1">FSAL_mkdir</a>( &amp;handle, &amp;name, &amp;op_ctx,
00761                         FSAL_MODE_RUSR|FSAL_MODE_WUSR
00762                         |FSAL_MODE_XUSR|FSAL_MODE_RGRP
00763                         |FSAL_MODE_WGRP,
00764                         &amp;dir_hdl,
00765                         &amp;attribs ) )){
00766     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00767   } <span class="keywordflow">else</span> {
00768 
00769     snprintHandle(tracebuff,256,&amp;dir_hdl);
00770     printf(<span class="stringliteral">"newly created dir handle = %s\n"</span>,tracebuff);
00771 
00772     printattributes(  attribs );
00773         
00774   }
00775 
00776   sleep(1);
00777   
00778   <span class="comment">/* Try to create it again */</span>
00779   printf(<span class="stringliteral">"------- Try to create it again -------\n"</span>);
00780   
00781   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00782        st = <a class="code" href="fsal__create_8c.html#a1">FSAL_mkdir</a>( &amp;handle, &amp;name, &amp;op_ctx,
00783                         FSAL_MODE_RUSR|FSAL_MODE_WUSR
00784                         |FSAL_MODE_XUSR|FSAL_MODE_RGRP
00785                         |FSAL_MODE_WGRP,
00786                         &amp;dir_hdl,
00787                         &amp;attribs ) )){
00788     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00789   } <span class="keywordflow">else</span> {
00790 
00791     printf(<span class="stringliteral">"**** Error: FSAL should have returned ERR_FSAL_EXIST\n"</span>);
00792         
00793   }
00794 
00795   sleep(1);
00796     
00797   <span class="comment">/* creates a subdirectory */</span>
00798   printf(<span class="stringliteral">"------- Create a subdirectory -------\n"</span>);
00799   
00800   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00801         st = <a class="code" href="group__FSALNameFunctions.html#ga0">FSAL_str2name</a>(<span class="stringliteral">"subdir_GANESHA"</span>,30,&amp;subdir_name))){
00802     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00803   }
00804   
00805   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00806        st = <a class="code" href="fsal__create_8c.html#a1">FSAL_mkdir</a>( &amp;dir_hdl, &amp;subdir_name, &amp;op_ctx,
00807                         FSAL_MODE_RUSR|FSAL_MODE_WUSR
00808                         |FSAL_MODE_XUSR|FSAL_MODE_RGRP
00809                         |FSAL_MODE_WGRP,
00810                         &amp;subdir_hdl,
00811                         &amp;attribs ) )){
00812     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00813   } <span class="keywordflow">else</span> {
00814 
00815     snprintHandle(tracebuff,256,&amp;subdir_hdl);
00816     printf(<span class="stringliteral">"newly created subdir handle = %s\n"</span>,tracebuff);
00817 
00818     printattributes(  attribs );
00819         
00820   }
00821   
00822   <span class="comment">/* try to removes the parent directory */</span>
00823   printf(<span class="stringliteral">"------- Try to removes the parent directory -------\n"</span>);
00824   
00825   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00826        st = <a class="code" href="fsal__unlink_8c.html#a0">FSAL_unlink</a>( &amp;handle, &amp;name, &amp;op_ctx,
00827                          &amp;attribs ) )){
00828     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00829   } <span class="keywordflow">else</span> {
00830 
00831     printf(<span class="stringliteral">"FSAL should not have unlinked %s because it is not empty\n"</span>,name.name);
00832         
00833   }  
00834 
00835   
00836   
00837   sleep(1);
00838   
00839   <span class="comment">/* removes the subdirectory */</span>
00840   printf(<span class="stringliteral">"------- Removes the subdirectory -------\n"</span>);
00841   
00842   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00843        st = <a class="code" href="fsal__unlink_8c.html#a0">FSAL_unlink</a>( &amp;dir_hdl, &amp;subdir_name, &amp;op_ctx,
00844                          &amp;attribs ) )){
00845     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00846   } <span class="keywordflow">else</span> {
00847 
00848     printf(<span class="stringliteral">"New attributes for parent directory:\n"</span>);
00849     printattributes(  attribs );
00850         
00851   }  
00852   
00853 
00854   <span class="comment">/* removes the parent directory */</span>
00855   printf(<span class="stringliteral">"------- Removes the parent directory -------\n"</span>);
00856   
00857   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00858        st = <a class="code" href="fsal__unlink_8c.html#a0">FSAL_unlink</a>( &amp;handle, &amp;name, &amp;op_ctx,
00859                          &amp;attribs ) )){
00860     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00861   } <span class="keywordflow">else</span> {
00862 
00863     printf(<span class="stringliteral">"Unlink %s OK\n"</span>,name.name);
00864         
00865   }  
00866 
00867     
00868     
00869 }
00870 <span class="comment">/* TEST 9 */</span>
00871 <span class="keywordflow">else</span>
00872 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'9'</span>) {
00873 
00874   fsal_handle_t dir_hdl, subdir_hdl;
00875   fsal_name_t   subdir_name;
00876   fsal_attrib_list_t  attr_set;
00877   
00878   fsal_fsid_t set_fsid = { 1LL, 2LL };        
00879 
00880 <span class="preprocessor">#ifdef _LINUX  </span>
00881 <span class="preprocessor"></span>  <span class="keyword">struct </span>tm jour_heure = { 56,34, 12, 31, 12, 110 , 0, 0, 0, 0, 0 };
00882 <span class="preprocessor">#else      </span>
00883 <span class="preprocessor"></span>  <span class="keyword">struct </span>tm jour_heure = { 56,34, 12, 31, 12, 110 , 0, 0, 0 };
00884 <span class="preprocessor">#endif</span>
00885 <span class="preprocessor"></span>        
00886   <span class="comment">/* lookup on /cea/prot/S/lama/s8/leibovic */</span>
00887   
00888   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00889         st = <a class="code" href="group__FSALNameFunctions.html#ga1">FSAL_str2path</a>(<span class="stringliteral">"/cea/prot/S/lama/s8/leibovic"</span>,40,&amp;path))){
00890     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00891   }
00892   attribs.asked_attributes = mask;
00893   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00894         st = <a class="code" href="fsal__lookup_8c.html#a2">FSAL_lookupPath</a>(&amp;path,&amp;op_ctx,&amp;handle,&amp;attribs))){
00895     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00896   }
00897   
00898   snprintHandle(tracebuff,256,&amp;handle);
00899   printf(<span class="stringliteral">"/cea/prot/S/lama/s8/leibovic: handle = %s\n"</span>,tracebuff);
00900     
00901   sleep(1);
00902   
00903   <span class="comment">/* creates a file */</span>
00904   printf(<span class="stringliteral">"------- Create a file -------\n"</span>);
00905   
00906   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00907         st = <a class="code" href="group__FSALNameFunctions.html#ga0">FSAL_str2name</a>(<span class="stringliteral">"tests_GANESHA_setattrs"</span>,30,&amp;name))){
00908     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00909   }
00910   
00911   attribs.asked_attributes = mask;
00912   
00913   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
00914        st = <a class="code" href="fsal__create_8c.html#a0">FSAL_create</a>( &amp;handle, &amp;name, &amp;op_ctx,
00915                         FSAL_MODE_RUSR|FSAL_MODE_WUSR
00916                         |FSAL_MODE_XUSR|FSAL_MODE_RGRP
00917                         |FSAL_MODE_WGRP,
00918                         &amp;dir_hdl,
00919                         &amp;attribs ) )){
00920     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
00921   } <span class="keywordflow">else</span> {
00922 
00923     snprintHandle(tracebuff,256,&amp;dir_hdl);
00924     printf(<span class="stringliteral">"newly created file handle = %s\n"</span>,tracebuff);
00925 
00926     printattributes(  attribs );
00927         
00928   }
00929 
00930   sleep(1);
00931   
00932   printf(<span class="stringliteral">"------- Try to change its attributes -------\n"</span>);
00933   
00934   <span class="comment">/* Macro that try to change the value for an attribute */</span>
00935   
00936 <span class="preprocessor">#define CHANGE_ATTRS( str_nom, nom, flag, new_val ) do {\</span>
00937 <span class="preprocessor">  memset(&amp;attr_set, 0, sizeof(fsal_attrib_list_t) );    \</span>
00938 <span class="preprocessor">  printf("\nTry to change '%s' :\n",str_nom);           \</span>
00939 <span class="preprocessor">  FSAL_SET_MASK( attr_set.asked_attributes , flag );    \</span>
00940 <span class="preprocessor">  attr_set.nom = new_val;                               \</span>
00941 <span class="preprocessor">  attribs.asked_attributes = attr_set.asked_attributes; \</span>
00942 <span class="preprocessor"></span><span class="comment">/*  attribs.asked_attributes = mask;                      */</span>\
00943   st = FSAL_setattrs( &amp;dir_hdl, &amp;op_ctx, &amp;attr_set, &amp;attribs );\
00944   if ( FSAL_IS_ERROR(st) )                              \
00945     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);\
00946   else                                                  \
00947     printattributes( attribs );                         \
00948   } while(0)
00949     
00950  CHANGE_ATTRS( <span class="stringliteral">"supported_attributes"</span>,supported_attributes ,
00951                FSAL_ATTR_SUPPATTR, FSAL_ATTRS_MANDATORY );
00952   
00953  CHANGE_ATTRS( <span class="stringliteral">"type"</span>,type ,FSAL_ATTR_TYPE, FSAL_TYPE_LNK );
00954   
00955  sleep(1); <span class="comment">/* to see mtime modification by truncate */</span>
00956  
00957  CHANGE_ATTRS( <span class="stringliteral">"filesize"</span>,filesize ,FSAL_ATTR_SIZE, (fsal_size_t) 12 );
00958  
00959  sleep(1); <span class="comment">/* to see mtime modification by truncate */</span>
00960   
00961  CHANGE_ATTRS( <span class="stringliteral">"fsid"</span>,fsid ,FSAL_ATTR_FSID, set_fsid );
00962  
00963   <span class="comment">/* @todo : ACLs */</span> 
00964  
00965  CHANGE_ATTRS( <span class="stringliteral">"fileid"</span>,fileid ,FSAL_ATTR_FILEID, (fsal_u64_t) 1234 );
00966  
00967  CHANGE_ATTRS( <span class="stringliteral">"mode"</span>,mode ,FSAL_ATTR_MODE,
00968               (FSAL_MODE_RUSR|FSAL_MODE_WUSR |FSAL_MODE_RGRP) );
00969 
00970  CHANGE_ATTRS( <span class="stringliteral">"numlinks"</span>,numlinks ,FSAL_ATTR_NUMLINKS, 7 );
00971  
00972  <span class="comment">/* FSAL_ATTR_RAWDEV */</span>
00973  
00974  CHANGE_ATTRS( <span class="stringliteral">"atime"</span>,atime.seconds ,FSAL_ATTR_ATIME, mktime(&amp;jour_heure) );
00975  
00976  jour_heure.tm_min ++;
00977  
00978  CHANGE_ATTRS( <span class="stringliteral">"creation"</span>,creation.seconds ,FSAL_ATTR_CREATION, mktime(&amp;jour_heure) );
00979  
00980  jour_heure.tm_min ++;
00981  
00982  CHANGE_ATTRS( <span class="stringliteral">"mtime"</span>,mtime.seconds ,FSAL_ATTR_MTIME, mktime(&amp;jour_heure) );
00983 
00984  jour_heure.tm_min ++;
00985  
00986  CHANGE_ATTRS( <span class="stringliteral">"ctime"</span>,ctime.seconds ,FSAL_ATTR_CTIME, mktime(&amp;jour_heure) );
00987 
00988  CHANGE_ATTRS( <span class="stringliteral">"spaceused"</span>,spaceused ,FSAL_ATTR_SPACEUSED, (fsal_size_t) 12345  );
00989 
00990  CHANGE_ATTRS( <span class="stringliteral">"mounted_on_fileid"</span>,mounted_on_fileid ,
00991                 FSAL_ATTR_MOUNTFILEID, (fsal_u64_t) 3210 );
00992  
00993  CHANGE_ATTRS( <span class="stringliteral">"owner"</span>,owner ,FSAL_ATTR_OWNER, 3051  ); <span class="comment">/* deniel */</span>
00994  
00995  CHANGE_ATTRS( <span class="stringliteral">"group"</span>,group ,FSAL_ATTR_GROUP, 5953  ); <span class="comment">/* sr */</span>
00996  
00997   sleep(1);  
00998   
00999 
01000   <span class="comment">/* removes the parent directory */</span>
01001   printf(<span class="stringliteral">"------- Removes the directory -------\n"</span>);
01002   
01003   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
01004        st = <a class="code" href="fsal__unlink_8c.html#a0">FSAL_unlink</a>( &amp;handle, &amp;name, &amp;op_ctx,
01005                          &amp;attribs ) )){
01006     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
01007   } <span class="keywordflow">else</span> {
01008     
01009     printf(<span class="stringliteral">"Unlink %s OK\n"</span>,name.name);
01010     
01011   }
01012 
01013     
01014     
01015 }
01016 <span class="keywordflow">else</span>
01017 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'A'</span>) {
01018 
01019   
01020   <span class="keywordtype">char</span> digest_buff[FSAL_DIGEST_SIZE_HDLV3];
01021   
01022   <span class="comment">/* lookup on /cea/prot/S/lama/s8/leibovic */</span>
01023   
01024   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
01025         st = <a class="code" href="group__FSALNameFunctions.html#ga1">FSAL_str2path</a>(<span class="stringliteral">"/cea/prot/S/lama/s8/leibovic"</span>,40,&amp;path))){
01026     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
01027   }
01028   attribs.asked_attributes = mask;
01029   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
01030         st = <a class="code" href="fsal__lookup_8c.html#a2">FSAL_lookupPath</a>(&amp;path,&amp;op_ctx,&amp;handle,&amp;attribs))){
01031     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
01032   }
01033   
01034   snprintHandle(tracebuff,256,&amp;handle);
01035   printf(<span class="stringliteral">"/cea/prot/S/lama/s8/leibovic: handle = %s\n"</span>,tracebuff);
01036   
01037   <span class="comment">/* building digest */</span>
01038   
01039   st = <a class="code" href="fsal__tools_8c.html#a8">FSAL_DigestHandle</a>( &amp;export_ctx, FSAL_DIGEST_NFSV3, &amp;handle, digest_buff );
01040   
01041   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st ))
01042   {
01043     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
01044   }
01045   <span class="keywordflow">else</span>  
01046   {
01047     <span class="comment">/* print digest */</span>
01048     snprintmem(tracebuff,256,digest_buff,FSAL_DIGEST_SIZE_HDLV3);
01049     printf(<span class="stringliteral">"/cea/prot/S/lama/s8/leibovic: handle_digest = %s\n"</span>,tracebuff);    
01050   }
01051   
01052   memset( &amp;handle, 0, <span class="keyword">sizeof</span>( fsal_handle_t )) ;
01053   
01054   <span class="comment">/* expend digest */</span>
01055   
01056   st = <a class="code" href="fsal__tools_8c.html#a9">FSAL_ExpandHandle</a>( &amp;export_ctx, FSAL_DIGEST_NFSV3, digest_buff, &amp;handle );
01057   
01058   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st ))
01059   {
01060     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
01061   }
01062   <span class="keywordflow">else</span>  
01063   {
01064     <span class="comment">/* print expended handle */</span>
01065     snprintHandle(tracebuff,256,&amp;handle);
01066     printf(<span class="stringliteral">"/cea/prot/S/lama/s8/leibovic: handle expended = %s\n"</span>,tracebuff);    
01067   }
01068         
01069 }
01070 <span class="keywordflow">else</span>
01071 <span class="keywordflow">if</span> (test[0]==<span class="charliteral">'B'</span>) {
01072   
01073   fsal_dynamicfsinfo_t  dyninfo;
01074   
01075   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
01076         st = <a class="code" href="fsal__fsinfo_8c.html#a1">FSAL_dynamic_fsinfo</a>(&amp;root_handle,&amp;op_ctx,&amp;dyninfo))){
01077     DisplayErrorJd(log_desc,ERR_FSAL,st.major,st.minor);
01078     exit( st.major );
01079   }
01080   
01081   printf(<span class="stringliteral">"total_bytes = %llu\n"</span>, dyninfo.total_bytes);
01082   printf(<span class="stringliteral">"free_bytes = %llu\n"</span>, dyninfo.free_bytes);
01083   printf(<span class="stringliteral">"avail_bytes = %llu\n"</span>, dyninfo.avail_bytes);
01084   printf(<span class="stringliteral">"total_files = %llu\n"</span>, dyninfo.total_files);
01085   printf(<span class="stringliteral">"free_files = %llu\n"</span>, dyninfo.free_files);
01086   printf(<span class="stringliteral">"avail_files = %llu\n"</span>, dyninfo.avail_files);
01087   printf(<span class="stringliteral">"time_delta = %u.%u\n"</span>, dyninfo.time_delta.seconds, dyninfo.time_delta.nseconds);
01088   
01089 }  
01090 <span class="keywordflow">else</span> 
01091   printf(<span class="stringliteral">"%s : test inconnu\n"</span>,test);
01092 
01093 <span class="keywordflow">return</span> 0;
01094 
01095 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
