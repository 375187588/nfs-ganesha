<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: fsal_tools.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_tools.c</h1><a href="fsal__tools_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00013 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "fsal.h"</span>
00018 <span class="preprocessor">#include "fsal_internal.h"</span>
00019 <span class="preprocessor">#include "fsal_common.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 <span class="preprocessor">#include "config_parsing.h"</span>
00022 <span class="preprocessor">#include "fsal_common.h"</span>
00023 <span class="preprocessor">#include &lt;string.h&gt;</span>
00024 
00025 <span class="comment">/* case unsensitivity */</span>
00026 <span class="preprocessor">#define STRCMP   strcasecmp</span>
00027 <span class="preprocessor"></span>
00028 <span class="preprocessor">#ifdef _USE_HPSS_51</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#define TYPE_UUIDT  uuid_t</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#elif defined _USE_HPSS_62</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#define TYPE_UUIDT  hpss_uuid_t</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 <span class="keywordtype">char</span> * FSAL_GetFSName()
00035 {
00036 <span class="preprocessor">#ifdef _USE_HPSS_51</span>
00037 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="stringliteral">"HPSS 5.1"</span>;
00038 <span class="preprocessor">#elif defined _USE_HPSS_62</span>
00039 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="stringliteral">"HPSS 6.2"</span>;
00040 <span class="preprocessor">#else</span>
00041 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="stringliteral">"HPSS"</span>;
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>}
00044 
00045 
00046 
<a name="l00063"></a><a class="code" href="fsal__tools_8c.html#a5">00063</a> <span class="keywordtype">int</span> <a class="code" href="fsal__tools_8c.html#a5">FSAL_handlecmp</a>( fsal_handle_t * handle1, fsal_handle_t * handle2,
00064                     fsal_status_t * status ){
00065    
00066   
00067   fsal_u64_t  fileid1, fileid2;
00068   
00069   *status =  FSAL_STATUS_NO_ERROR;
00070    
00071   <span class="keywordflow">if</span> (!handle1 || !handle2 ){
00072     status-&gt;major = ERR_FSAL_FAULT ;
00073     <span class="keywordflow">return</span> -1;   
00074   }  
00075   
00076   <span class="comment">/* hpss_HandleCompare returns wrong results for hardlinks :</span>
00077 <span class="comment">   * it says that the two objects are different.</span>
00078 <span class="comment">   * so we use our own comparation method,</span>
00079 <span class="comment">   * by comparing fileids.</span>
00080 <span class="comment">   */</span>
00081   fileid1 = hpss_GetObjId( &amp;handle1-&gt;ns_handle );
00082   fileid2 = hpss_GetObjId( &amp;handle2-&gt;ns_handle );  
00083     
00084   <span class="keywordflow">if</span> ( fileid1 &gt; fileid2 )
00085     <span class="keywordflow">return</span> 1;
00086   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( fileid2 == fileid1 )
00087     <span class="keywordflow">return</span> 0;
00088   <span class="keywordflow">else</span>
00089     <span class="keywordflow">return</span> -1;  
00090        
00091 }
00092 
00093 
<a name="l00108"></a><a class="code" href="fsal__tools_8c.html#a6">00108</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fsal__tools_8c.html#a6">FSAL_Handle_to_HashIndex</a>( fsal_handle_t * p_handle,
00109                                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cookie,
00110                                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> alphabet_len,
00111                                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index_size)
00112 {
00113 <span class="preprocessor">#define SMALL_PRIME_MULT        3</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#define SMALL_PRIME_ADD         1999 </span>
00115 <span class="preprocessor"></span><span class="preprocessor">#define HASH_INCR( _h_, _i_ )        ( _h_ = (_h_ * SMALL_PRIME_MULT + SMALL_PRIME_ADD) % _i_ )</span>
00116 <span class="preprocessor"></span>
00117         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h = cookie;
00118         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00119         unsigned32   objid = hpss_GetObjId( &amp;p_handle-&gt;ns_handle );
00120 
00121         h ^= p_handle-&gt;ns_handle.Generation ;
00122         HASH_INCR( h, index_size );
00123         h ^= objid ;
00124         HASH_INCR( h, index_size );
00125         h ^= p_handle-&gt;ns_handle.CoreServerUUID.time_low ;
00126         HASH_INCR( h, index_size );
00127         h ^= p_handle-&gt;ns_handle.CoreServerUUID.time_mid ;
00128         HASH_INCR( h, index_size );
00129         h ^= p_handle-&gt;ns_handle.CoreServerUUID.time_hi_and_version ;
00130         HASH_INCR( h, index_size );
00131         h ^= p_handle-&gt;ns_handle.CoreServerUUID.clock_seq_hi_and_reserved ;
00132         HASH_INCR( h, index_size );
00133         h ^= p_handle-&gt;ns_handle.CoreServerUUID.clock_seq_low ;
00134         HASH_INCR( h, index_size );
00135         
00136         <span class="keywordflow">for</span> ( i = 0; i &lt; 6; i++ )
00137         {
00138                 h ^= p_handle-&gt;ns_handle.CoreServerUUID.node[i] ;
00139                 HASH_INCR( h, index_size );
00140         } 
00141         
00142         <span class="keywordflow">return</span> h % index_size; 
00143         
00144 }
00145 
00146 
00147 <span class="comment">/*</span>
00148 <span class="comment"> * FSAL_Handle_to_RBTIndex</span>
00149 <span class="comment"> * This function is used for generating a RBT node ID</span>
00150 <span class="comment"> * in order to identify entries into the RBT.</span>
00151 <span class="comment"> *</span>
00152 <span class="comment"> * \param p_handle      The handle to be hashed</span>
00153 <span class="comment"> * \param cookie        Makes it possible to have different hash value for the</span>
00154 <span class="comment"> *                      same handle, when cookie changes.</span>
00155 <span class="comment"> *</span>
00156 <span class="comment"> * \return The hash value</span>
00157 <span class="comment"> */</span>
00158 
00159 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> FSAL_Handle_to_RBTIndex( fsal_handle_t * p_handle, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cookie )
00160 {
00161         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h;
00162         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00163         unsigned32   objid = hpss_GetObjId( &amp;p_handle-&gt;ns_handle );
00164 
00165         h = cookie ;
00166         h ^= p_handle-&gt;ns_handle.Generation &lt;&lt; 1;
00167         h ^= objid &lt;&lt; 2 ;
00168 
00169         h ^= p_handle-&gt;ns_handle.CoreServerUUID.time_low &lt;&lt; 3;
00170         h ^= p_handle-&gt;ns_handle.CoreServerUUID.time_mid  &lt;&lt; 4;
00171         h ^= p_handle-&gt;ns_handle.CoreServerUUID.time_hi_and_version &lt;&lt; 5;
00172         h ^= p_handle-&gt;ns_handle.CoreServerUUID.clock_seq_hi_and_reserved &lt;&lt; 6;
00173         h ^= p_handle-&gt;ns_handle.CoreServerUUID.clock_seq_low &lt;&lt; 7;
00174 
00175         <span class="keywordflow">for</span> ( i = 0; i &lt; 6; i++ )
00176         {
00177                 h ^= ((<span class="keywordtype">unsigned</span> int)p_handle-&gt;ns_handle.CoreServerUUID.node[i]) &lt;&lt; 8+i;
00178         }
00179 
00180         <span class="keywordflow">return</span> h;
00181 }
00182 
00183 
00184 
<a name="l00202"></a><a class="code" href="fsal__tools_8c.html#a8">00202</a> fsal_status_t <a class="code" href="fsal__tools_8c.html#a8">FSAL_DigestHandle</a>(
00203     fsal_export_context_t  * p_expcontext,    <span class="comment">/* IN */</span>
00204     fsal_digesttype_t        output_type,     <span class="comment">/* IN */</span>
00205     fsal_handle_t          * in_fsal_handle,  <span class="comment">/* IN */</span>
00206     caddr_t                  out_buff         <span class="comment">/* OUT */</span>
00207 ){
00208   
00209   <span class="comment">/* min size for nfs handle digest. */</span>
00210   <span class="keywordtype">int</span> memlen = <span class="keyword">sizeof</span>( ns_ObjHandle_t ) - <span class="keyword">sizeof</span>( TYPE_UUIDT );
00211   
00212   unsigned32  objid;   <span class="comment">/* to store objID */</span>
00213   
00214   fsal_u64_t  objid64;   <span class="comment">/* to cast the objID */</span>  
00215   
00216   fsal_nodetype_t nodetype; <span class="comment">/* to store object  type */</span>
00217       
00218   <span class="comment">/* sanity checks */</span>
00219   <span class="keywordflow">if</span> (!in_fsal_handle || !out_buff || !p_expcontext) ReturnCode( ERR_FSAL_FAULT ,0 );
00220   
00221   <span class="keywordflow">switch</span>(output_type){   
00222     
00223     <span class="comment">/* NFSV2 handle digest */</span>    
00224     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV2:
00225       
00226       <span class="comment">/* The hpss handle must be converted</span>
00227 <span class="comment">       * to a 25 bytes handle. To do so,</span>
00228 <span class="comment">       * We copy all the fields from the hpss handle,</span>
00229 <span class="comment">       *  except the Coreserver ID.</span>
00230 <span class="comment">       */</span>
00231       
00232 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00233 <span class="preprocessor"></span>      
00234       <span class="comment">/* sanity check about output size */</span>
00235       
00236       <span class="keywordflow">if</span> ( memlen &gt; FSAL_DIGEST_SIZE_HDLV2 )
00237         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00238         
00239 <span class="preprocessor">#endif</span>
00240 <span class="preprocessor"></span>
00241       <span class="comment">/* sanity check about core server ID */</span>
00242       
00243       <span class="keywordflow">if</span> ( memcmp( &amp;in_fsal_handle-&gt;ns_handle.CoreServerUUID,
00244                    &amp;p_expcontext-&gt;fileset_root_handle.CoreServerUUID,
00245                    <span class="keyword">sizeof</span>(TYPE_UUIDT)) ){
00246         <span class="keywordtype">char</span> buffer[128];
00247         snprintmem(buffer,128,(caddr_t)&amp;(in_fsal_handle-&gt;ns_handle.CoreServerUUID),<span class="keyword">sizeof</span>(TYPE_UUIDT));
00248         DisplayLogJdLevel( fsal_log, NIV_DEBUG,
00249                       <span class="stringliteral">"Invalid CoreServerUUID in HPSS handle: %s"</span>,buffer);
00250       }
00251 
00252       <span class="comment">/* building digest :</span>
00253 <span class="comment">       * - fill it with zeros</span>
00254 <span class="comment">       * - setting the first bytes to the fsal_handle value</span>
00255 <span class="comment">       *   (except CoreServerUUID)</span>
00256 <span class="comment">       */</span>
00257       memset( out_buff,0,FSAL_DIGEST_SIZE_HDLV2 );
00258       memcpy( out_buff,&amp;(in_fsal_handle-&gt;ns_handle),memlen );
00259       
00260       <span class="keywordflow">break</span>;
00261 
00262       
00263     <span class="comment">/* NFSV3 handle digest */</span>      
00264     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV3:
00265       
00266       <span class="comment">/* The hpss handle must be converted</span>
00267 <span class="comment">       * to a 25 bytes handle. To do so,</span>
00268 <span class="comment">       * We copy all the fields from the hpss handle,</span>
00269 <span class="comment">       *  except the Coreserver ID.</span>
00270 <span class="comment">       */</span>
00271       
00272 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00273 <span class="preprocessor"></span>      
00274       <span class="comment">/* sanity check about output size */</span>
00275       
00276       <span class="keywordflow">if</span> ( memlen &gt; FSAL_DIGEST_SIZE_HDLV3 )
00277         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00278         
00279 <span class="preprocessor">#endif</span>
00280 <span class="preprocessor"></span>
00281       <span class="comment">/* sanity check about core server ID */</span>
00282 
00283       <span class="keywordflow">if</span> ( memcmp( &amp;in_fsal_handle-&gt;ns_handle.CoreServerUUID,
00284                    &amp;p_expcontext-&gt;fileset_root_handle.CoreServerUUID,
00285                    <span class="keyword">sizeof</span>(TYPE_UUIDT)) ){
00286         <span class="keywordtype">char</span> buffer[128];
00287         snprintmem(buffer,128,(caddr_t)&amp;(in_fsal_handle-&gt;ns_handle.CoreServerUUID),<span class="keyword">sizeof</span>(TYPE_UUIDT));
00288         DisplayLogJdLevel( fsal_log, NIV_DEBUG,
00289                       <span class="stringliteral">"Invalid CoreServerUUID in HPSS handle: %s"</span>,buffer);
00290       }
00291 
00292       <span class="comment">/* building digest :</span>
00293 <span class="comment">       * - fill it with zeros</span>
00294 <span class="comment">       * - setting the first bytes to the fsal_handle value</span>
00295 <span class="comment">       *   (except CoreServerUUID)</span>
00296 <span class="comment">       */</span>
00297       memset( out_buff,0,FSAL_DIGEST_SIZE_HDLV3 );
00298       memcpy( out_buff,&amp;(in_fsal_handle-&gt;ns_handle),memlen );
00299       
00300       <span class="keywordflow">break</span>;
00301 
00302           
00303     <span class="comment">/* NFSV4 handle digest */</span>
00304     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV4:
00305       
00306       <span class="comment">/* The hpss handle must be converted</span>
00307 <span class="comment">       * to a 25 bytes handle. To do so,</span>
00308 <span class="comment">       * We copy all the fields from the hpss handle,</span>
00309 <span class="comment">       *  except the Coreserver ID.</span>
00310 <span class="comment">       */</span>
00311       
00312 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00313 <span class="preprocessor"></span>      
00314       <span class="comment">/* sanity check about output size */</span>
00315       
00316       <span class="keywordflow">if</span> ( memlen &gt; FSAL_DIGEST_SIZE_HDLV4 )
00317         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00318         
00319 <span class="preprocessor">#endif</span>
00320 <span class="preprocessor"></span>
00321       <span class="comment">/* sanity check about core server ID */</span>
00322       
00323       <span class="keywordflow">if</span> ( memcmp( &amp;in_fsal_handle-&gt;ns_handle.CoreServerUUID,
00324                    &amp;p_expcontext-&gt;fileset_root_handle.CoreServerUUID,
00325                    <span class="keyword">sizeof</span>(TYPE_UUIDT)) ){
00326         <span class="keywordtype">char</span> buffer[128];
00327         snprintmem(buffer,128,(caddr_t)&amp;(in_fsal_handle-&gt;ns_handle.CoreServerUUID),<span class="keyword">sizeof</span>(TYPE_UUIDT));
00328         DisplayLogJdLevel( fsal_log, NIV_DEBUG,
00329                       <span class="stringliteral">"Invalid CoreServerUUID in HPSS handle: %s"</span>,buffer);
00330       }
00331       
00332       <span class="comment">/* building digest :</span>
00333 <span class="comment">       * - fill it with zeros</span>
00334 <span class="comment">       * - setting the first bytes to the fsal_handle value</span>
00335 <span class="comment">       *   (except CoreServerUUID)</span>
00336 <span class="comment">       */</span>
00337       memset( out_buff,0,FSAL_DIGEST_SIZE_HDLV4 );
00338       memcpy( out_buff,&amp;(in_fsal_handle-&gt;ns_handle),memlen );
00339       
00340       <span class="keywordflow">break</span>;
00341       
00342       
00343     <span class="comment">/* FileId digest for NFSv2 */</span>
00344     <span class="keywordflow">case</span>  FSAL_DIGEST_FILEID2:      
00345       
00346       <span class="comment">/* get object ID from handle */</span>
00347       objid = hpss_GetObjId( &amp;in_fsal_handle-&gt;ns_handle );
00348 
00349 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00350 <span class="preprocessor"></span>      
00351       <span class="comment">/* sanity check about output size */</span>
00352       
00353       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(unsigned32) &gt; FSAL_DIGEST_SIZE_FILEID2 )
00354         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00355         
00356 <span class="preprocessor">#endif</span>
00357 <span class="preprocessor"></span>            
00358       memset( out_buff,0,FSAL_DIGEST_SIZE_FILEID2 );
00359       memcpy( out_buff,&amp;objid,<span class="keyword">sizeof</span>(unsigned32) );
00360 
00361       
00362       <span class="keywordflow">break</span>;
00363       
00364       
00365     <span class="comment">/* FileId digest for NFSv3 */</span>
00366     <span class="keywordflow">case</span>  FSAL_DIGEST_FILEID3:
00367       
00368       <span class="comment">/* get object ID from handle */</span>
00369       objid64 = hpss_GetObjId( &amp;in_fsal_handle-&gt;ns_handle );      
00370       
00371 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00372 <span class="preprocessor"></span>      
00373       <span class="comment">/* sanity check about output size */</span>
00374       
00375       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(fsal_u64_t) &gt; FSAL_DIGEST_SIZE_FILEID3 )
00376         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00377         
00378 <span class="preprocessor">#endif</span>
00379 <span class="preprocessor"></span>            
00380       memset( out_buff,0,FSAL_DIGEST_SIZE_FILEID3 );
00381       memcpy( out_buff,&amp;objid64,<span class="keyword">sizeof</span>(fsal_u64_t) );
00382       <span class="keywordflow">break</span>;
00383       
00384       
00385     <span class="comment">/* FileId digest for NFSv4 */</span>
00386       
00387     <span class="keywordflow">case</span>  FSAL_DIGEST_FILEID4:
00388       <span class="comment">/* get object ID from handle */</span>
00389       objid64 = hpss_GetObjId( &amp;in_fsal_handle-&gt;ns_handle );
00390 
00391 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00392 <span class="preprocessor"></span>      
00393       <span class="comment">/* sanity check about output size */</span>
00394       
00395       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(fsal_u64_t) &gt; FSAL_DIGEST_SIZE_FILEID4 )
00396         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00397         
00398 <span class="preprocessor">#endif</span>
00399 <span class="preprocessor"></span>            
00400       memset( out_buff,0,FSAL_DIGEST_SIZE_FILEID4 );
00401       memcpy( out_buff,&amp;objid64,<span class="keyword">sizeof</span>(fsal_u64_t) );
00402       <span class="keywordflow">break</span>;      
00403     
00404     <span class="comment">/* Nodetype digest. */</span>
00405     <span class="keywordflow">case</span> FSAL_DIGEST_NODETYPE:  
00406       
00407       nodetype = in_fsal_handle-&gt;obj_type;
00408       
00409 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00410 <span class="preprocessor"></span>      
00411       <span class="comment">/* sanity check about output size */</span>
00412       
00413       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(fsal_nodetype_t) &gt; FSAL_DIGEST_SIZE_NODETYPE )
00414         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00415         
00416 <span class="preprocessor">#endif</span>
00417 <span class="preprocessor"></span>            
00418       memset( out_buff,0,FSAL_DIGEST_SIZE_NODETYPE );
00419       memcpy( out_buff,&amp;nodetype,<span class="keyword">sizeof</span>(fsal_nodetype_t) );
00420       
00421       <span class="keywordflow">break</span>;
00422     
00423       
00424     <span class="keywordflow">default</span>:
00425       ReturnCode( ERR_FSAL_SERVERFAULT ,0 );
00426   }
00427   
00428   ReturnCode(ERR_FSAL_NO_ERROR,0);
00429   
00430 }
00431 
00432 
00433 
<a name="l00449"></a><a class="code" href="fsal__tools_8c.html#a9">00449</a> fsal_status_t <a class="code" href="fsal__tools_8c.html#a9">FSAL_ExpandHandle</a>(
00450     fsal_export_context_t   * p_expcontext,    <span class="comment">/* IN */</span>
00451     fsal_digesttype_t         in_type,         <span class="comment">/* IN */</span>
00452     caddr_t                   in_buff,         <span class="comment">/* IN */</span>
00453     fsal_handle_t           * out_fsal_handle  <span class="comment">/* OUT */</span>
00454 ){
00455   
00456   <span class="comment">/* significant size in nfs digests */</span>
00457   <span class="keywordtype">int</span> memlen = <span class="keyword">sizeof</span>( ns_ObjHandle_t ) - <span class="keyword">sizeof</span>( TYPE_UUIDT ); 
00458   
00459   <span class="comment">/* sanity checks */</span>
00460   <span class="keywordflow">if</span> (!out_fsal_handle || !in_buff || !p_expcontext) ReturnCode( ERR_FSAL_FAULT ,0 );
00461   
00462   <span class="keywordflow">switch</span>(in_type){
00463     
00464     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV2:
00465       
00466       memset(out_fsal_handle,0,<span class="keyword">sizeof</span>(fsal_handle_t));
00467       memcpy(&amp;out_fsal_handle-&gt;ns_handle,in_buff,memlen);
00468       
00469       memcpy(&amp;out_fsal_handle-&gt;ns_handle.CoreServerUUID,
00470              &amp;p_expcontext-&gt;fileset_root_handle.CoreServerUUID,<span class="keyword">sizeof</span>(TYPE_UUIDT));
00471       
00472       out_fsal_handle-&gt;obj_type = <a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( out_fsal_handle-&gt;ns_handle.Type );
00473       
00474       <span class="keywordflow">break</span>;
00475       
00476     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV3:
00477       
00478       memset(out_fsal_handle,0,<span class="keyword">sizeof</span>(fsal_handle_t));
00479       memcpy(&amp;out_fsal_handle-&gt;ns_handle,in_buff,memlen);
00480 
00481       memcpy(&amp;out_fsal_handle-&gt;ns_handle.CoreServerUUID,
00482              &amp;p_expcontext-&gt;fileset_root_handle.CoreServerUUID, <span class="keyword">sizeof</span>(TYPE_UUIDT));
00483       
00484       out_fsal_handle-&gt;obj_type = <a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( out_fsal_handle-&gt;ns_handle.Type );
00485       
00486       <span class="keywordflow">break</span>;
00487       
00488     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV4:
00489       
00490       memset(out_fsal_handle,0,<span class="keyword">sizeof</span>(fsal_handle_t));
00491       memcpy(&amp;out_fsal_handle-&gt;ns_handle,in_buff,memlen);
00492       memcpy(&amp;out_fsal_handle-&gt;ns_handle.CoreServerUUID,
00493              &amp;p_expcontext-&gt;fileset_root_handle.CoreServerUUID,<span class="keyword">sizeof</span>(TYPE_UUIDT));
00494       
00495       out_fsal_handle-&gt;obj_type = <a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( out_fsal_handle-&gt;ns_handle.Type );
00496       
00497       <span class="keywordflow">break</span>;
00498       
00499     <span class="keywordflow">default</span>:
00500       <span class="comment">/* Invalid input digest type. */</span>
00501       ReturnCode( ERR_FSAL_INVAL ,0 );
00502   }
00503   
00504   ReturnCode(ERR_FSAL_NO_ERROR,0);  
00505   
00506 }
00507 
00508 
00509 
<a name="l00517"></a><a class="code" href="fsal__tools_8c.html#a10">00517</a> fsal_status_t  <a class="code" href="fsal__tools_8c.html#a10">FSAL_SetDefault_FSAL_parameter</a>(
00518                              fsal_parameter_t *  out_parameter )
00519 {
00520 
00521   log_t   no_logging = LOG_INITIALIZER;
00522   
00523   <span class="comment">/* defensive programming... */</span>  
00524   <span class="keywordflow">if</span> ( out_parameter == NULL )
00525       ReturnCode( ERR_FSAL_FAULT, 0 );
00526   
00527   <span class="comment">/* init logging to no logging */</span>  
00528   out_parameter-&gt;fsal_info.log_outputs = no_logging;
00529   
00530   <span class="comment">/* init max FS calls = unlimited */</span>
00531   out_parameter-&gt;fsal_info.max_fs_calls = 0;
00532 
00533   ReturnCode( ERR_FSAL_NO_ERROR, 0 );    
00534   
00535 }
00536 
00537 
00538 fsal_status_t  FSAL_SetDefault_FS_common_parameter(
00539                              fsal_parameter_t *  out_parameter )
00540 {
00541   <span class="comment">/* defensive programming... */</span>  
00542   <span class="keywordflow">if</span> ( out_parameter == NULL )
00543       ReturnCode( ERR_FSAL_FAULT, 0 );
00544   
00545   <span class="comment">/* set default values for all parameters of fs_common_info */</span>
00546   
00547   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxfilesize );
00548   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxlink );
00549   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxnamelen );
00550   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxpathlen );
00551   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, no_trunc );
00552   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, chown_restricted );
00553   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, case_insensitive );
00554   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, case_preserving );
00555   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, fh_expire_type );
00556   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, link_support );
00557   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, symlink_support );  
00558   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, named_attr );
00559   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, unique_handles );
00560   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, lease_time );
00561   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, acl_support );
00562   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, cansettime );
00563   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, homogenous );
00564   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, supported_attrs );
00565   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxread );
00566   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxwrite );
00567   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, umask );
00568   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, auth_exportpath_xdev );  
00569   
00570   ReturnCode( ERR_FSAL_NO_ERROR, 0 );  
00571     
00572 }
00573 
00574 
00575 
00576 
00577 fsal_status_t  FSAL_SetDefault_FS_specific_parameter(
00578                              fsal_parameter_t *  out_parameter )
00579 {
00580   <span class="comment">/* defensive programming... */</span>  
00581   <span class="keywordflow">if</span> ( out_parameter == NULL )
00582       ReturnCode( ERR_FSAL_FAULT, 0 );
00583   
00584   <span class="comment">/* set default values for all parameters of fs_specific_info */</span>
00585   
00586 <span class="preprocessor">#ifdef _USE_HPSS_51  </span>
00587 <span class="preprocessor"></span>  
00588   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, PrincipalName);
00589   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, KeytabPath);
00590   
00591 <span class="preprocessor">#elif defined _USE_HPSS_62</span>
00592 <span class="preprocessor"></span>  
00593   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, AuthnMech);
00594   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, NumRetries);
00595   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, BusyDelay);
00596   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, BusyRetries);
00597   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, MaxConnections);
00598   
00599   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, DebugPath);
00600   
00601   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, Principal);
00602   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, KeytabPath);
00603   
00604 <span class="preprocessor">#endif</span>
00605 <span class="preprocessor"></span>  
00606   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, CredentialLifetime);
00607   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_specific_info, ReturnInconsistentDirent);
00608 
00609   ReturnCode( ERR_FSAL_NO_ERROR, 0 );  
00610   
00611 }
00612 
00613 
00614 
00615 
00616 
00639 <span class="comment">/* load FSAL init info */</span>
00640  
<a name="l00641"></a><a class="code" href="fsal__tools_8c.html#a13">00641</a> fsal_status_t  <a class="code" href="fsal__tools_8c.html#a13">FSAL_load_FSAL_parameter_from_conf</a>(
00642       config_file_t       in_config,
00643       fsal_parameter_t *  out_parameter
00644     )
00645 {
00646   <span class="keywordtype">int</span>     err;
00647   <span class="keywordtype">int</span>     blk_index;
00648   <span class="keywordtype">int</span>     var_max, var_index;
00649   <span class="keywordtype">char</span> *  key_name;
00650   <span class="keywordtype">char</span> *  key_value;  
00651   
00652   <span class="keywordtype">int</span>  DebugLevel   = -1;
00653   <span class="keywordtype">char</span> * LogFile    = NULL;
00654 
00655   
00656   blk_index = config_GetBlockIndexByName( in_config, CONF_LABEL_FSAL );
00657 
00658   <span class="comment">/* cannot read item */</span>  
00659   
00660   <span class="keywordflow">if</span> ( blk_index &lt;0 ) {
00661     DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: Cannot read item \"%s\" from configuration file"</span>,
00662         CONF_LABEL_FSAL );
00663     ReturnCode( ERR_FSAL_NOENT, -blk_index );
00664   }
00665       
00666   <span class="comment">/* read variable for fsal init */</span>
00667   
00668   var_max = config_GetNbKeys( in_config, blk_index );
00669   
00670   <span class="keywordflow">for</span> ( var_index = 0; var_index &lt; var_max ; var_index ++ )
00671   {    
00672     
00673     <span class="comment">/* retrieve key's name */</span>
00674     err = config_GetKeyValue( 
00675                         in_config,
00676                         blk_index,
00677                         var_index,
00678                         &amp;key_name,
00679                         &amp;key_value
00680                        );
00681     <span class="keywordflow">if</span> ( err ){
00682       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR reading key[%d] from section \"%s\" of configuration file."</span>,
00683             var_index, CONF_LABEL_FSAL );
00684       ReturnCode( ERR_FSAL_SERVERFAULT, err );
00685     }
00686         
00687     <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"DebugLevel"</span> ) )
00688     {
00689       DebugLevel = ReturnLevelAscii( key_value );
00690       
00691       <span class="keywordflow">if</span> ( DebugLevel == -1 ){
00692         DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Invalid debug level name: \"%s\"."</span>,
00693               key_value );
00694         ReturnCode( ERR_FSAL_INVAL, -1 );        
00695       }
00696       
00697     }
00698     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"LogFile"</span> ) )
00699     {
00700       
00701       LogFile = key_value ;
00702       
00703     }
00704     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"Max_FS_calls"</span> ) )
00705     {
00706       
00707         <span class="keywordtype">int</span> maxcalls = s_read_int( key_value );
00708 
00709         <span class="keywordflow">if</span> ( maxcalls &lt; 0 )
00710         {
00711           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: null or positive integer expected."</span>,key_name);
00712           ReturnCode( ERR_FSAL_INVAL, 0 );
00713         }
00714            
00715         out_parameter-&gt;fsal_info.max_fs_calls = (<span class="keywordtype">unsigned</span> int) maxcalls;
00716       
00717     }
00718     <span class="keywordflow">else</span>
00719     {
00720       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unknown or unsettable key: %s (item %s)"</span>,
00721           key_name, CONF_LABEL_FSAL ) ;
00722       ReturnCode( ERR_FSAL_INVAL, 0 );
00723     }
00724 
00725   }
00726   
00727   <span class="comment">/* init logging */</span>
00728   
00729   <span class="keywordflow">if</span> ( LogFile )
00730   {
00731     desc_log_stream_t  log_stream;
00732     
00733     strcpy( log_stream.path , LogFile );
00734     
00735     <span class="comment">/* Default : NIV_CRIT */</span>
00736     
00737     <span class="keywordflow">if</span> ( DebugLevel == -1 )
00738       AddLogStreamJd( &amp;(out_parameter-&gt;fsal_info.log_outputs),
00739           V_FILE, log_stream, NIV_CRIT, SUP);
00740     <span class="keywordflow">else</span>         
00741       AddLogStreamJd( &amp;(out_parameter-&gt;fsal_info.log_outputs),
00742           V_FILE, log_stream, DebugLevel, SUP);
00743         
00744   }
00745 
00746   ReturnCode( ERR_FSAL_NO_ERROR, 0 );        
00747   
00748 } <span class="comment">/* FSAL_load_FSAL_parameter_from_conf */</span>
00749 
00750 
00751 
00752 <span class="comment">/* load general filesystem configuration options */</span>
00753 
00754 fsal_status_t  FSAL_load_FS_common_parameter_from_conf(
00755       config_file_t       in_config,
00756       fsal_parameter_t *  out_parameter
00757     )
00758 {
00759   <span class="keywordtype">int</span>     err;
00760   <span class="keywordtype">int</span>     blk_index;
00761   <span class="keywordtype">int</span>     var_max, var_index;
00762   <span class="keywordtype">char</span> *  key_name;
00763   <span class="keywordtype">char</span> *  key_value;  
00764   
00765   blk_index = config_GetBlockIndexByName( in_config, CONF_LABEL_FS_COMMON );
00766   
00767   <span class="comment">/* cannot read item */</span>  
00768   <span class="keywordflow">if</span> ( blk_index &lt;0 ) {
00769     DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: Cannot read item \"%s\" from configuration file"</span>,
00770         CONF_LABEL_FS_COMMON );
00771     ReturnCode( ERR_FSAL_NOENT, -blk_index );
00772   }
00773   
00774   <span class="comment">/*</span>
00775 <span class="comment">  configurable common info for filesystem are:</span>
00776 <span class="comment">  link_support      # hardlink support</span>
00777 <span class="comment">  symlink_support   # symlinks support</span>
00778 <span class="comment">  cansettime        # Is it possible to change file times</span>
00779 <span class="comment">  maxread           # Max read size from FS</span>
00780 <span class="comment">  maxwrite          # Max write size to FS</span>
00781 <span class="comment">  umask</span>
00782 <span class="comment">  auth_exportpath_xdev</span>
00783 <span class="comment">  */</span>
00784   
00785   var_max = config_GetNbKeys( in_config, blk_index );
00786   
00787   <span class="keywordflow">for</span> ( var_index = 0; var_index &lt; var_max ; var_index ++ )
00788   {
00789     
00790     
00791     <span class="comment">/* retrieve key's name */</span>
00792     err = config_GetKeyValue( 
00793                         in_config,
00794                         blk_index,
00795                         var_index,
00796                         &amp;key_name,
00797                         &amp;key_value
00798                        );
00799     <span class="keywordflow">if</span> ( err ){
00800       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR reading key[%d] from section \"%s\" of configuration file."</span>,
00801             var_index, CONF_LABEL_FS_COMMON );
00802       ReturnCode( ERR_FSAL_SERVERFAULT, err );
00803     }
00804     
00805     <span class="comment">/* does the variable exists ? */</span>
00806     <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"link_support"</span> ) )
00807       {
00808         
00809         <span class="keywordtype">int</span> <span class="keywordtype">bool</span> = StrToBoolean( key_value );
00810         
00811         <span class="keywordflow">if</span> ( <span class="keywordtype">bool</span> == -1 )
00812         {
00813           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: boolean expected."</span>,key_name);
00814           ReturnCode( ERR_FSAL_INVAL, 0 );
00815         }
00816         
00817         <span class="comment">/* if set to false, force value to false.</span>
00818 <span class="comment">         * else keep fs default.</span>
00819 <span class="comment">         */</span>
00820         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, link_support,
00821             FSAL_INIT_MAX_LIMIT, <span class="keywordtype">bool</span> );
00822             
00823       }
00824     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"symlink_support"</span> ) )
00825       {
00826         <span class="keywordtype">int</span> <span class="keywordtype">bool</span> = StrToBoolean( key_value );
00827         
00828         <span class="keywordflow">if</span> ( <span class="keywordtype">bool</span> == -1 )
00829         {
00830           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: boolean expected."</span>,key_name);
00831           ReturnCode( ERR_FSAL_INVAL, 0 );
00832         }
00833         
00834         <span class="comment">/* if set to false, force value to false.</span>
00835 <span class="comment">         * else keep fs default.</span>
00836 <span class="comment">         */</span>
00837         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, symlink_support,
00838             FSAL_INIT_MAX_LIMIT, <span class="keywordtype">bool</span> );
00839       }
00840     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"cansettime"</span> ) )
00841       {
00842         <span class="keywordtype">int</span> <span class="keywordtype">bool</span> = StrToBoolean( key_value );
00843         
00844         <span class="keywordflow">if</span> ( <span class="keywordtype">bool</span> == -1 )
00845         {
00846           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: boolean expected."</span>,key_name);
00847           ReturnCode( ERR_FSAL_INVAL, 0 );
00848         }
00849         
00850         <span class="comment">/* if set to false, force value to false.</span>
00851 <span class="comment">         * else keep fs default.</span>
00852 <span class="comment">         */</span>
00853         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, cansettime,
00854             FSAL_INIT_MAX_LIMIT, <span class="keywordtype">bool</span> );
00855         
00856       }
00857     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"maxread"</span> ) )
00858       {
00859         fsal_u64_t  size;
00860         
00861         <span class="keywordflow">if</span> ( s_read_int64( key_value , &amp;size ) )
00862         {
00863           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: positive integer expected."</span>,key_name);
00864           ReturnCode( ERR_FSAL_INVAL, 0 );
00865         }
00866         
00867         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, maxread,
00868             FSAL_INIT_FORCE_VALUE, size );
00869         
00870          
00871       }
00872     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"maxwrite"</span> ) )
00873       {
00874         fsal_u64_t  size;
00875         
00876         <span class="keywordflow">if</span> ( s_read_int64( key_value , &amp;size ) )
00877         {
00878           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: positive integer expected."</span>,key_name);
00879           ReturnCode( ERR_FSAL_INVAL, 0 );
00880         }
00881         
00882         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, maxwrite,
00883             FSAL_INIT_FORCE_VALUE, size );
00884                 
00885       }
00886     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"umask"</span> ) )
00887       {
00888         <span class="keywordtype">int</span> mode = s_read_octal( key_value );
00889         
00890         <span class="keywordflow">if</span> ( mode &lt; 0 )
00891         {
00892           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: octal expected."</span>,key_name);
00893           ReturnCode( ERR_FSAL_INVAL, 0 );
00894         }
00895         
00896         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, umask,
00897             FSAL_INIT_FORCE_VALUE, <a class="code" href="fsal__convert_8c.html#a6">unix2fsal_mode</a>(mode) );
00898         
00899       }
00900     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"auth_xdev_export"</span> ) )
00901       {
00902         <span class="keywordtype">int</span> <span class="keywordtype">bool</span> = StrToBoolean( key_value );
00903         
00904         <span class="keywordflow">if</span> ( <span class="keywordtype">bool</span> == -1 )
00905         {
00906           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: boolean expected."</span>,key_name);
00907           ReturnCode( ERR_FSAL_INVAL, 0 );
00908         }
00909         
00910         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, auth_exportpath_xdev,
00911             FSAL_INIT_FORCE_VALUE, <span class="keywordtype">bool</span> );
00912       }
00913     <span class="keywordflow">else</span>
00914     {
00915       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unknown or unsettable key: %s (item %s)"</span>,
00916           key_name, CONF_LABEL_FS_COMMON ) ;
00917       ReturnCode( ERR_FSAL_INVAL, 0 );
00918     }
00919         
00920   }
00921     
00922   ReturnCode( ERR_FSAL_NO_ERROR, 0 );    
00923     
00924 } <span class="comment">/* FSAL_load_FS_common_parameter_from_conf */</span>
00925 
00926 
00927 
00928 
00929 <span class="comment">/* load specific filesystem configuration options */</span>
00930 
00931 fsal_status_t  FSAL_load_FS_specific_parameter_from_conf(
00932       config_file_t       in_config,
00933       fsal_parameter_t *  out_parameter
00934     )
00935 {
00936   <span class="keywordtype">int</span>     err;
00937   <span class="keywordtype">int</span>     blk_index;
00938   <span class="keywordtype">int</span>     var_max, var_index;
00939   <span class="keywordtype">char</span> *  key_name;
00940   <span class="keywordtype">char</span> *  key_value;   
00941   
00942   blk_index = config_GetBlockIndexByName( in_config, CONF_LABEL_FS_SPECIFIC );
00943   
00944   <span class="comment">/* cannot read item */</span>  
00945   <span class="keywordflow">if</span> ( blk_index &lt;0 ) {
00946     DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: Cannot read item \"%s\" from configuration file"</span>,
00947         CONF_LABEL_FS_SPECIFIC );
00948     ReturnCode( ERR_FSAL_NOENT, -blk_index );
00949   }
00950   
00951   var_max = config_GetNbKeys( in_config, blk_index );
00952   
00953   <span class="keywordflow">for</span> ( var_index = 0; var_index &lt; var_max ; var_index ++ )
00954   {
00955     <span class="comment">/* retrieve key's name */</span>
00956     err = config_GetKeyValue( 
00957                         in_config,
00958                         blk_index,
00959                         var_index,
00960                         &amp;key_name,
00961                         &amp;key_value
00962                        );
00963     <span class="keywordflow">if</span> ( err ){
00964       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR reading key[%d] from section \"%s\" of configuration file."</span>,
00965             var_index, CONF_LABEL_FS_SPECIFIC );
00966       ReturnCode( ERR_FSAL_SERVERFAULT, err );
00967     }
00968     
00969 <span class="preprocessor">#ifdef _USE_HPSS_51  </span>
00970 <span class="preprocessor"></span>    <span class="comment">/* does the variable exists ? */</span>
00971     <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"PrincipalName"</span> ) )
00972       {
00973         
00974         out_parameter-&gt;fs_specific_info.behaviors.PrincipalName
00975             = FSAL_INIT_FORCE_VALUE;
00976         strcpy( out_parameter-&gt;fs_specific_info.hpss_config.PrincipalName,
00977             key_value );
00978             
00979       }
00980     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"KeytabPath"</span> ) )
00981       {
00982         
00983         out_parameter-&gt;fs_specific_info.behaviors.KeytabPath
00984             = FSAL_INIT_FORCE_VALUE;
00985         strcpy( out_parameter-&gt;fs_specific_info.hpss_config.KeytabPath,
00986             key_value );
00987             
00988       }    
00989 <span class="preprocessor">#elif defined _USE_HPSS_62</span>
00990 <span class="preprocessor"></span>    <span class="comment">/* does the variable exists ? */</span>
00991     <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"PrincipalName"</span> ) )
00992       {        
00993         out_parameter-&gt;fs_specific_info.behaviors.Principal
00994             = FSAL_INIT_FORCE_VALUE;
00995         strcpy( out_parameter-&gt;fs_specific_info.Principal,
00996             key_value );
00997             
00998       }
00999     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"KeytabPath"</span> ) )
01000       {
01001         out_parameter-&gt;fs_specific_info.behaviors.KeytabPath
01002             = FSAL_INIT_FORCE_VALUE;
01003         strcpy( out_parameter-&gt;fs_specific_info.KeytabPath,
01004             key_value );            
01005       }
01006     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"AuthMech"</span> ) )
01007       {
01008         <span class="keywordtype">int</span> error;
01009         
01010         out_parameter-&gt;fs_specific_info.behaviors.AuthnMech
01011             = FSAL_INIT_FORCE_VALUE;
01012         
01013         error = hpss_AuthnMechTypeFromString( key_value,
01014                   &amp;out_parameter-&gt;fs_specific_info.hpss_config.AuthnMech );
01015         
01016         <span class="keywordflow">if</span> (error != HPSS_E_NOERROR)
01017         {
01018           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s."</span>,key_name);
01019           ReturnCode( ERR_FSAL_INVAL, error );
01020         }
01021         
01022       }
01023     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"BusyDelay"</span> ) )
01024       {
01025         <span class="keywordtype">int</span> busydelay = s_read_int( key_value );
01026 
01027         <span class="keywordflow">if</span> ( busydelay &lt; 0 )
01028         {
01029           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: positive integer expected."</span>,key_name);
01030           ReturnCode( ERR_FSAL_INVAL, 0 );
01031         }
01032            
01033         out_parameter-&gt;fs_specific_info.behaviors.BusyDelay
01034             = FSAL_INIT_FORCE_VALUE;
01035         out_parameter-&gt;fs_specific_info.hpss_config.BusyDelay = busydelay;
01036       }
01037     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"BusyRetries"</span> ) )
01038       {
01039         <span class="keywordtype">int</span> busyretries;
01040         
01041         <span class="keywordflow">if</span> ( key_value[0] == <span class="charliteral">'-'</span> )
01042         {
01043           busyretries = s_read_int( (<span class="keywordtype">char</span> *)(key_value+1) );
01044           <span class="keywordflow">if</span> (busyretries &lt; 0)
01045           {
01046             DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: integer expected."</span>,key_name);
01047             ReturnCode( ERR_FSAL_INVAL, 0 );
01048           }
01049           busyretries = -busyretries;            
01050         }
01051         <span class="keywordflow">else</span>
01052         {
01053           busyretries = s_read_int( key_value );
01054 
01055           <span class="keywordflow">if</span> ( busyretries &lt; 0 )
01056           {
01057             DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: integer expected."</span>,key_name);
01058             ReturnCode( ERR_FSAL_INVAL, 0 );
01059           }
01060         }
01061            
01062         out_parameter-&gt;fs_specific_info.behaviors.BusyRetries
01063             = FSAL_INIT_FORCE_VALUE;
01064         out_parameter-&gt;fs_specific_info.hpss_config.BusyRetries = busyretries;
01065       }
01066     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"NumRetries"</span> ) )
01067       {
01068         <span class="keywordtype">int</span> numretries;
01069         
01070         <span class="keywordflow">if</span> ( key_value[0] == <span class="charliteral">'-'</span> )
01071         {
01072           numretries = s_read_int( (<span class="keywordtype">char</span> *)(key_value+1) );
01073           <span class="keywordflow">if</span> (numretries &lt; 0)
01074           {
01075             DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: integer expected."</span>,key_name);
01076             ReturnCode( ERR_FSAL_INVAL, 0 );
01077           }
01078           numretries = -numretries;            
01079         }
01080         <span class="keywordflow">else</span>
01081         {
01082           numretries = s_read_int( key_value );
01083 
01084           <span class="keywordflow">if</span> ( numretries &lt; 0 )
01085           {
01086             DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: integer expected."</span>,key_name);
01087             ReturnCode( ERR_FSAL_INVAL, 0 );
01088           }
01089         }
01090            
01091         out_parameter-&gt;fs_specific_info.behaviors.NumRetries
01092             = FSAL_INIT_FORCE_VALUE;
01093         out_parameter-&gt;fs_specific_info.hpss_config.NumRetries = numretries;
01094       }
01095     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"MaxConnections"</span> ) )
01096       {
01097         <span class="keywordtype">int</span> maxconn = s_read_int( key_value );
01098 
01099         <span class="keywordflow">if</span> ( maxconn &lt; 0 )
01100         {
01101           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: positive integer expected."</span>,key_name);
01102           ReturnCode( ERR_FSAL_INVAL, 0 );
01103         }
01104            
01105         out_parameter-&gt;fs_specific_info.behaviors.MaxConnections
01106             = FSAL_INIT_FORCE_VALUE;
01107         out_parameter-&gt;fs_specific_info.hpss_config.MaxConnections = maxconn;
01108       } 
01109     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"DebugPath"</span> ) )
01110       {
01111         out_parameter-&gt;fs_specific_info.behaviors.DebugPath
01112             = FSAL_INIT_FORCE_VALUE;
01113         strcpy( out_parameter-&gt;fs_specific_info.hpss_config.DebugPath,
01114             key_value );
01115       }
01116      
01117 <span class="preprocessor">#endif      </span>
01118 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"CredentialLifetime"</span> ) )
01119       {
01120         <span class="keywordtype">int</span> cred_life = s_read_int( key_value );
01121 
01122         <span class="keywordflow">if</span> ( cred_life &lt; 1 )
01123         {
01124           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: positive integer expected."</span>,key_name);
01125           ReturnCode( ERR_FSAL_INVAL, 0 );
01126         }
01127            
01128         out_parameter-&gt;fs_specific_info.behaviors.CredentialLifetime
01129             = FSAL_INIT_FORCE_VALUE;
01130         out_parameter-&gt;fs_specific_info.CredentialLifetime = (fsal_uint_t)cred_life;
01131       }
01132     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"ReturnInconsistentDirent"</span> ) )
01133       {
01134         <span class="keywordtype">int</span> <span class="keywordtype">bool</span> = StrToBoolean( key_value );
01135         
01136         <span class="keywordflow">if</span> ( <span class="keywordtype">bool</span> == -1 )
01137         {
01138           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: boolean expected."</span>,key_name);
01139           ReturnCode( ERR_FSAL_INVAL, 0 );
01140         }
01141 
01142         out_parameter-&gt;fs_specific_info.behaviors.ReturnInconsistentDirent
01143             = FSAL_INIT_FORCE_VALUE;
01144         out_parameter-&gt;fs_specific_info.ReturnInconsistentDirent = (fsal_uint_t)bool;
01145       }
01146     <span class="keywordflow">else</span>
01147       {
01148         DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unknown or unsettable key: %s (item %s)"</span>,
01149             key_name, CONF_LABEL_FS_SPECIFIC ) ;
01150         ReturnCode( ERR_FSAL_INVAL, 0 );
01151       }
01152         
01153   }  
01154     
01155    ReturnCode( ERR_FSAL_NO_ERROR, 0 );  
01156     
01157 } <span class="comment">/* FSAL_load_FS_specific_parameter_from_conf */</span>
01158 
01159 
01160 
01161 
01162 
01163 
01164 
01165 
01166 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
