<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: fsal_lookup.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_lookup.c</h1><a href="fsal__lookup_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00013 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "fsal.h"</span>
00018 <span class="preprocessor">#include "fsal_internal.h"</span>
00019 <span class="preprocessor">#include "fsal_convert.h"</span>
00020 <span class="preprocessor">#include "fsal_common.h"</span>
00021 <span class="preprocessor">#include "HPSSclapiExt/hpssclapiext.h"</span>
00022 
00023 
<a name="l00059"></a><a class="code" href="fsal__lookup_8c.html#a0">00059</a> fsal_status_t <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a> (
00060     fsal_handle_t         * parent_directory_handle,       <span class="comment">/* IN */</span>
00061     fsal_name_t           * p_filename,                    <span class="comment">/* IN */</span>
00062     fsal_op_context_t     * p_context,                     <span class="comment">/* IN */</span>
00063     fsal_handle_t         * object_handle,                 <span class="comment">/* OUT */</span>
00064     fsal_attrib_list_t    * object_attributes              <span class="comment">/* [ IN/OUT ] */</span>
00065 ){
00066   
00067   <span class="keywordtype">int</span> rc;
00068   fsal_status_t   status;
00069   hpss_fileattr_t root_attr;
00070   
00071   ns_ObjHandle_t  obj_hdl;
00072   hpss_Attrs_t    obj_attr;
00073 
00074           
00075   <span class="comment">/* sanity checks</span>
00076 <span class="comment">   * note : object_attributes is optionnal</span>
00077 <span class="comment">   *        parent_directory_handle may be null for getting FS root.</span>
00078 <span class="comment">   */</span>
00079   <span class="keywordflow">if</span> (!object_handle || !p_context )
00080     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_lookup);
00081   
00082   <span class="keywordflow">if</span> (!parent_directory_handle){
00083     
00084     <span class="comment">/* check that p_filename is NULL,</span>
00085 <span class="comment">     * else, parent_directory_handle should not</span>
00086 <span class="comment">     * be NULL.</span>
00087 <span class="comment">     */</span>
00088     <span class="keywordflow">if</span> ( p_filename != NULL )
00089       Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_lookup);
00090     
00091     <span class="comment">/* root handle = fileset root handle */</span>
00092     object_handle-&gt;obj_type  =
00093         <a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( p_context-&gt;export_context-&gt;fileset_root_handle.Type );
00094     object_handle-&gt;ns_handle = p_context-&gt;export_context-&gt;fileset_root_handle ;
00095     
00096     <span class="comment">/* retrieves root attributes, if asked. */</span>
00097     <span class="keywordflow">if</span> (object_attributes)
00098     {      
00099       fsal_status_t status;
00100 
00101       status = <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>( object_handle, p_context , object_attributes );
00102 
00103       <span class="comment">/* On error, we set a flag in the returned attributes */</span>
00104 
00105       <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00106       {
00107         FSAL_CLEAR_MASK( object_attributes-&gt;asked_attributes );
00108         FSAL_SET_MASK( object_attributes-&gt;asked_attributes,
00109             FSAL_ATTR_RDATTR_ERR );
00110       }
00111     }
00112     
00113     
00114   } <span class="keywordflow">else</span> {
00115     
00116     
00117     <span class="comment">/* the filename should not be null */</span>
00118     <span class="keywordflow">if</span> ( p_filename == NULL )
00119       Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_lookup);
00120     
00121     
00122     <span class="comment">/* Be careful about junction crossing, symlinks, hardlinks,... */</span>
00123     
00124     <span class="keywordflow">switch</span> ( parent_directory_handle-&gt;obj_type )
00125     {
00126       <span class="keywordflow">case</span> FSAL_TYPE_DIR:
00127         <span class="comment">/* OK */</span>
00128         <span class="keywordflow">break</span>;
00129       
00130       <span class="keywordflow">case</span> FSAL_TYPE_JUNCTION:
00131          <span class="comment">/* This is a junction */</span>
00132          Return(ERR_FSAL_XDEV,0,INDEX_FSAL_lookup);
00133         
00134       <span class="keywordflow">case</span> FSAL_TYPE_FILE:
00135       <span class="keywordflow">case</span> FSAL_TYPE_LNK:
00136         <span class="comment">/* not a directory */</span>
00137         Return(ERR_FSAL_NOTDIR,0,INDEX_FSAL_lookup);
00138         
00139         
00140       <span class="keywordflow">default</span>:
00141         Return(ERR_FSAL_SERVERFAULT ,0 , INDEX_FSAL_lookup);
00142     }
00143                 
00144     
00145     <span class="comment">/* call to HPSS client api */</span>
00146     <span class="comment">/* We use hpss_GetRawAttrHandle for not chasing junctions nor symlinks. */</span>
00147     
00148     <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00149     
00150     rc = HPSSFSAL_GetRawAttrHandle( &amp;(parent_directory_handle-&gt;ns_handle),
00151                                 p_filename-&gt;name,
00152                                 &amp;p_context-&gt;credential.hpss_usercred,
00153                                 FALSE, <span class="comment">/* don't traverse junctions */</span>
00154                                 &amp;obj_hdl,
00155                                 NULL,
00156                                 &amp;obj_attr );
00157     
00158     ReleaseTokenFSCall();
00159     
00165     <span class="keywordflow">if</span> ( rc == HPSS_ENOTDIR )
00166     {
00167       <span class="keywordflow">if</span> ( HPSSFSAL_IsStaleHandle( &amp;parent_directory_handle-&gt;ns_handle,
00168                                    &amp;p_context-&gt;credential.hpss_usercred ) )
00169       {
00170         Return( ERR_FSAL_STALE, -rc, INDEX_FSAL_lookup );
00171       }
00172     }
00173     
00174     <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_lookup);
00175     
00176     <span class="comment">/* set output handle */</span>
00177     object_handle-&gt;obj_type  = <a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( obj_hdl.Type );
00178     object_handle-&gt;ns_handle = obj_hdl;
00179     
00180     <span class="keywordflow">if</span> ( object_attributes ) {
00181       
00182       <span class="comment">/* convert hpss attributes to fsal attributes */</span>
00183       
00184       
00185       status=<a class="code" href="fsal__convert_8c.html#a14">hpss2fsal_attributes</a>( 
00186                            &amp;obj_hdl,
00187                            &amp;obj_attr,
00188                            object_attributes );
00189       
00190       <span class="keywordflow">if</span> (FSAL_IS_ERROR(status))
00191         Return(status.major,status.minor,INDEX_FSAL_lookup);
00192       
00193     }
00194     
00195   }
00196   
00197   <span class="comment">/* lookup complete ! */</span>
00198   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_lookup );
00199 
00200 }
00201 
00202 
00203 
00204 
<a name="l00232"></a><a class="code" href="fsal__lookup_8c.html#a1">00232</a> fsal_status_t <a class="code" href="fsal__lookup_8c.html#a1">FSAL_lookupJunction</a> (
00233     fsal_handle_t         * p_junction_handle,   <span class="comment">/* IN */</span>
00234     fsal_op_context_t     * p_context,           <span class="comment">/* IN */</span>
00235     fsal_handle_t         * p_fsoot_handle,      <span class="comment">/* OUT */</span>
00236     fsal_attrib_list_t    * p_fsroot_attributes  <span class="comment">/* [ IN/OUT ] */</span>
00237 )
00238 {
00239   <span class="keywordtype">int</span> rc;
00240   fsal_status_t   status;
00241   hpss_Attrs_t    root_attr;
00242         
00243   <span class="comment">/* sanity checks</span>
00244 <span class="comment">   * note : p_fsroot_attributes is optionnal</span>
00245 <span class="comment">   */</span>
00246   <span class="keywordflow">if</span> (!p_junction_handle || !p_fsoot_handle || !p_context )
00247     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_lookupJunction);
00248       
00249   <span class="keywordflow">if</span> ( p_junction_handle-&gt;obj_type != FSAL_TYPE_JUNCTION )
00250     Return(ERR_FSAL_INVAL ,0 , INDEX_FSAL_lookupJunction);
00251       
00252   <span class="comment">/* call to HPSS client api */</span>
00253   <span class="comment">/* We use hpss_GetRawAttrHandle for chasing junctions. */</span>
00254 
00255   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00256 
00257   rc = HPSSFSAL_GetRawAttrHandle( &amp;(p_junction_handle-&gt;ns_handle),
00258                                   NULL,
00259                                   &amp;p_context-&gt;credential.hpss_usercred,
00260                                   TRUE,     <span class="comment">/* do traverse junctions !!! */</span>
00261                                   NULL,
00262                                   NULL,
00263                                   &amp;root_attr );
00264 
00265   ReleaseTokenFSCall();
00266 
00267   <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_lookupJunction);
00268 
00269   
00270   
00271   
00272   <span class="comment">/* set output handle */</span>
00273   p_fsoot_handle-&gt;obj_type  = <a class="code" href="fsal__convert_8c.html#a7">hpss2fsal_type</a>( root_attr.FilesetHandle.Type );
00274   p_fsoot_handle-&gt;ns_handle = root_attr.FilesetHandle;
00275 
00276   <span class="keywordflow">if</span> ( p_fsroot_attributes ) {
00277 
00278     <span class="comment">/* convert hpss attributes to fsal attributes */</span>
00279 
00280 
00281     status=<a class="code" href="fsal__convert_8c.html#a14">hpss2fsal_attributes</a>(
00282                          &amp;root_attr.FilesetHandle,
00283                          &amp;root_attr,
00284                          p_fsroot_attributes );
00285 
00286     <span class="keywordflow">if</span> (FSAL_IS_ERROR(status))
00287       Return(status.major,status.minor,INDEX_FSAL_lookupJunction);
00288 
00289   }
00290 
00291   <span class="comment">/* lookup complete ! */</span>
00292   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_lookupJunction );
00293 }
00294 
00295 
00296 
00297 
00298 
<a name="l00333"></a><a class="code" href="fsal__lookup_8c.html#a2">00333</a> fsal_status_t <a class="code" href="fsal__lookup_8c.html#a2">FSAL_lookupPath</a> (
00334     fsal_path_t           * p_path,            <span class="comment">/* IN */</span>
00335     fsal_op_context_t     * p_context,         <span class="comment">/* IN */</span>
00336     fsal_handle_t         * object_handle,     <span class="comment">/* OUT */</span>
00337     fsal_attrib_list_t    * object_attributes  <span class="comment">/* [ IN/OUT ] */</span>
00338 ){
00339   fsal_name_t obj_name = FSAL_NAME_INITIALIZER; <span class="comment">/* empty string */</span>
00340   <span class="keywordtype">char</span> * ptr_str;
00341   fsal_handle_t out_hdl;
00342   fsal_status_t status;
00343   <span class="keywordtype">int</span> b_is_last = FALSE; <span class="comment">/* is it the last lookup ? */</span>
00344   
00345   <span class="comment">/* sanity checks</span>
00346 <span class="comment">   * note : object_attributes is optionnal.</span>
00347 <span class="comment">   */</span>
00348   
00349   <span class="keywordflow">if</span> (!object_handle || !p_context || !p_path)
00350     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_lookupPath);
00351   
00352   <span class="comment">/* test whether the path begins with a slash*/</span>
00353   
00354   <span class="keywordflow">if</span> ( p_path-&gt;path[0] != <span class="charliteral">'/'</span> )
00355     Return(ERR_FSAL_INVAL,0,INDEX_FSAL_lookupPath);   
00356   
00357   <span class="comment">/* the pointer now points on the next name in the path,</span>
00358 <span class="comment">   * skipping slashes.</span>
00359 <span class="comment">   */</span>
00360   
00361   ptr_str = p_path-&gt;path + 1;
00362   <span class="keywordflow">while</span> (ptr_str[0] == <span class="charliteral">'/'</span>) ptr_str++;
00363   
00364   <span class="comment">/* is the next name empty ? */</span>
00365   
00366   <span class="keywordflow">if</span> (ptr_str[0] == <span class="charliteral">'\0'</span>)  b_is_last = TRUE;
00367      
00368   
00369   <span class="comment">/* retrieves root directory */</span>
00370   
00371   status = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a> (  NULL,     <span class="comment">/* looking up for root */</span>
00372                           NULL, <span class="comment">/* empty string to get root handle */</span>
00373                           p_context,     <span class="comment">/* user's credentials */</span>
00374                           &amp;out_hdl, <span class="comment">/* output root handle */</span>
00375                           <span class="comment">/* retrieves attributes if this is the last lookup :*/</span>
00376                           ( b_is_last ? object_attributes : NULL ));
00377   
00378   <span class="keywordflow">if</span> (  FSAL_IS_ERROR( status ))
00379     Return( status.major, status.minor,INDEX_FSAL_lookupPath );
00380   
00381   
00382   <span class="comment">/* exits if this was the last lookup */</span>
00383   
00384   <span class="keywordflow">if</span>  ( b_is_last ){
00385     (*object_handle) = out_hdl;
00386     Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_lookupPath );
00387   }
00388   
00389   
00390   <span class="comment">/* proceed a step by step lookup */</span>
00391   
00392   <span class="keywordflow">while</span>( ptr_str[0] )
00393   {
00394    
00395     fsal_handle_t  in_hdl;
00396     <span class="keywordtype">char</span> * dest_ptr;
00397 
00398     <span class="comment">/* preparing lookup */</span>
00399     
00402     in_hdl = out_hdl;
00403 
00404     <span class="comment">/* compute next name */</span>
00405     obj_name.len = 0;
00406     dest_ptr = obj_name.name;
00407     <span class="keywordflow">while</span> ( ptr_str[0]!=<span class="charliteral">'\0'</span> &amp;&amp; ptr_str[0]!=<span class="charliteral">'/'</span>)
00408     {
00409       dest_ptr[0] = ptr_str[0];
00410       dest_ptr ++ ;
00411       ptr_str  ++ ;
00412       obj_name.len ++;
00413     }
00414     <span class="comment">/* final null char */</span>
00415     dest_ptr[0] = <span class="charliteral">'\0'</span>;
00416 
00417     <span class="comment">/* skip multiple slashes */</span>
00418     <span class="keywordflow">while</span> (ptr_str[0] == <span class="charliteral">'/'</span>) ptr_str++;
00419 
00420     <span class="comment">/* is the next name empty ? */</span>
00421     <span class="keywordflow">if</span> (ptr_str[0] == <span class="charliteral">'\0'</span>)
00422       b_is_last = TRUE;
00423     
00424     <span class="comment">/*call to FSAL_lookup */</span>      
00425     status = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a> (  &amp;in_hdl,  <span class="comment">/* parent directory handle */</span>
00426                             &amp;obj_name, <span class="comment">/* object name */</span>
00427                             p_context,     <span class="comment">/* user's credentials */</span>
00428                             &amp;out_hdl, <span class="comment">/* output root handle */</span>
00429                             <span class="comment">/* retrieves attributes if this is the last lookup :*/</span>
00430                             ( b_is_last ? object_attributes : NULL ));
00431     
00432     <span class="keywordflow">if</span> (  FSAL_IS_ERROR( status ) )
00433       Return( status.major, status.minor,INDEX_FSAL_lookupPath );
00434 
00435     
00436     <span class="comment">/* if the target object is a junction, an we allow cross junction lookups,</span>
00437 <span class="comment">     * we cross it.</span>
00438 <span class="comment">     */</span>
00439     <span class="keywordflow">if</span> ( global_fs_info.auth_exportpath_xdev &amp;&amp; (out_hdl.obj_type == FSAL_TYPE_JUNCTION ) )
00440     {
00441       fsal_handle_t tmp_hdl;
00442       
00443       tmp_hdl = out_hdl;
00444       
00445       <span class="comment">/*call to FSAL_lookup */</span>
00446       status = <a class="code" href="fsal__lookup_8c.html#a1">FSAL_lookupJunction</a>(  &amp;tmp_hdl,  <span class="comment">/* object handle */</span>
00447                                      p_context, <span class="comment">/* user's credentials */</span>
00448                                      &amp;out_hdl, <span class="comment">/* output root handle */</span>
00449                                     <span class="comment">/* retrieves attributes if this is the last lookup :*/</span>
00450                                     ( b_is_last ? object_attributes : NULL ));
00451 
00452     }
00453             
00454     <span class="comment">/* ptr_str is ok, we are ready for next loop */</span>
00455   }
00456   
00457  (*object_handle) = out_hdl;  
00458   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_lookupPath );  
00459 
00460 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
