<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (HPSS) library: fsal_fsinfo.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_fsinfo.c</h1><a href="fsal__fsinfo_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021               
00022 <span class="preprocessor">#ifdef _USE_HPSS_51</span>
00023 <span class="preprocessor"></span>  <span class="comment">/* for struct statfs */</span>
00024 <span class="preprocessor"># include &lt;sys/types.h&gt;</span>
00025 <span class="preprocessor">#endif</span>
00026 <span class="preprocessor"></span>
00027 
<a name="l00047"></a><a class="code" href="fsal__fsinfo_8c.html#a0">00047</a> fsal_status_t  <a class="code" href="fsal__fsinfo_8c.html#a0">FSAL_static_fsinfo</a>(
00048     fsal_handle_t       *   filehandle,       <span class="comment">/* IN */</span>
00049     fsal_op_context_t   * p_context,          <span class="comment">/* IN */</span>
00050     fsal_staticfsinfo_t *   staticinfo        <span class="comment">/* OUT */</span>
00051 ){
00052   <span class="comment">/* sanity checks. */</span>  
00053   <span class="comment">/* for HPSS, handle and credential are not used. */</span>  
00054   <span class="keywordflow">if</span> ( !staticinfo )
00055     Return( ERR_FSAL_FAULT ,0 , INDEX_FSAL_static_fsinfo );
00056   
00057   <span class="comment">/* returning static info about the filesystem */</span>
00058   (*staticinfo) = global_fs_info;
00059   
00060   Return(ERR_FSAL_NO_ERROR,0,INDEX_FSAL_static_fsinfo);
00061   
00062 }
00063 
00064 
00065 
<a name="l00085"></a><a class="code" href="fsal__fsinfo_8c.html#a1">00085</a> fsal_status_t  <a class="code" href="fsal__fsinfo_8c.html#a1">FSAL_dynamic_fsinfo</a>(
00086     fsal_handle_t        *   filehandle,         <span class="comment">/* IN */</span>
00087     fsal_op_context_t    *   p_context,          <span class="comment">/* IN */</span>
00088     fsal_dynamicfsinfo_t *   dynamicinfo         <span class="comment">/* OUT */</span>
00089 ){
00090 
00091 <span class="preprocessor">#ifdef _USE_HPSS_51</span>
00092 <span class="preprocessor"></span>  <span class="keyword">struct </span>statfs hpss_statfs;
00093 <span class="preprocessor">#elif defined( _USE_HPSS_62 )</span>
00094 <span class="preprocessor"></span>  hpss_statfs_t hpss_statfs;
00095 <span class="preprocessor">#endif</span>
00096 <span class="preprocessor"></span>  
00097   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cos_export;
00098   <span class="keywordtype">int</span> rc;
00099 
00100 
00101     <span class="comment">/* sanity checks. */</span>
00102   <span class="keywordflow">if</span> ( !filehandle ||
00103        !dynamicinfo ||
00104        !p_context )
00105     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_dynamic_fsinfo);
00106   
00107   <span class="comment">/* retrieves the default cos (or the user defined cos for this fileset) */</span>
00108   
00109   <span class="keywordflow">if</span> ( p_context-&gt;export_context-&gt;default_cos != 0 )
00110   {
00111     cos_export = p_context-&gt;export_context-&gt;default_cos ;
00112   }
00113   <span class="keywordflow">else</span>
00114   {
00115     <span class="comment">/* retrieves default fileset cos */</span>
00116     
00117     ns_FilesetAttrBits_t  attrBits;
00118     ns_FilesetAttrs_t     fsattrs;
00119       
00120     attrBits = cast64m(0);
00121     attrBits = orbit64m( attrBits, NS_FS_ATTRINDEX_COS );
00122       
00123     <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00124     rc = hpss_FilesetGetAttributes( NULL, NULL,
00125                                     &amp;p_context-&gt;export_context-&gt;fileset_root_handle,
00126                                     NULL,
00127                                     attrBits, &amp;fsattrs );
00128     ReleaseTokenFSCall();
00129 
00130     <span class="keywordflow">if</span> (rc) Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_dynamic_fsinfo );
00131     
00132     cos_export = fsattrs.ClassOfService;
00133     
00134   }
00135   
00136   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00137   rc = hpss_Statfs( p_context-&gt;export_context-&gt;default_cos, &amp;hpss_statfs );
00138   ReleaseTokenFSCall();
00139     
00140   <span class="keywordflow">if</span> ( rc ) Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_dynamic_fsinfo );
00141 
00142   <span class="comment">/* retrieves the default cos (or the user defined cos for this fileset) */</span>
00143   <span class="keywordflow">if</span> ( p_context-&gt;export_context-&gt;default_cos != 0 )
00144   {
00145     cos_export = p_context-&gt;export_context-&gt;default_cos ;
00146   }
00147   <span class="keywordflow">else</span>
00148   {
00149     <span class="comment">/* retrieves default fileset cos */</span>
00150     
00151     ns_FilesetAttrBits_t  attrBits;
00152     ns_FilesetAttrs_t     fsattrs;
00153       
00154     attrBits = cast64m(0);
00155     attrBits = orbit64m( attrBits, NS_FS_ATTRINDEX_COS );
00156       
00157     <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00158     rc = hpss_FilesetGetAttributes( NULL, NULL,
00159                                     &amp;p_context-&gt;export_context-&gt;fileset_root_handle,
00160                                     NULL,
00161                                     attrBits, &amp;fsattrs );
00162     ReleaseTokenFSCall();
00163 
00164     <span class="keywordflow">if</span> (rc) Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_dynamic_fsinfo );
00165     
00166     cos_export = fsattrs.ClassOfService;
00167     
00168   }
00169   
00170   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00171   rc = hpss_Statfs( p_context-&gt;export_context-&gt;default_cos, &amp;hpss_statfs );
00172   ReleaseTokenFSCall();
00173     
00174   <span class="keywordflow">if</span> ( rc ) Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_dynamic_fsinfo );
00175 
00176   
00177   <span class="comment">/* then retrieve info about this cos */</span>
00178 <span class="preprocessor">#ifdef BUGAZOMEU</span>
00179 <span class="preprocessor"></span>  <span class="comment">/* retrieves the default cos (or the user defined cos for this fileset) */</span>
00180   <span class="keywordflow">if</span> ( DefaultCosId != 0 )
00181   {
00182     cos_export = DefaultCosId ;
00183   }
00184   <span class="keywordflow">else</span>
00185   {
00186     <span class="comment">/* retrieves default fileset cos */</span>
00187     
00188     ns_FilesetAttrBits_t  attrBits;
00189     ns_FilesetAttrs_t     fsattrs;
00190     hpss_fileattr_t       rootattr;
00191     ns_ObjHandle_t        fshdl;
00192       
00193     <span class="comment">/* recupere la racine */</span> 
00194     
00195     <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00196     rc = HPSSFSAL_GetRoot( &amp;rootattr );
00197     ReleaseTokenFSCall();
00198     
00199     <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_dynamic_fsinfo);
00200     
00201     
00202     fshdl = rootattr.ObjectHandle;
00203     
00204     <span class="comment">/* recupere la cos du fileset correspondant */</span>
00205     
00206     attrBits = cast64m(0);
00207     attrBits = orbit64m( attrBits, NS_FS_ATTRINDEX_COS );
00208     
00209     <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();    
00210     rc = hpss_FilesetGetAttributes( NULL, NULL,
00211                                     &amp;fshdl,
00212                                     NULL,
00213                                     attrBits, &amp;fsattrs );
00214     ReleaseTokenFSCall();
00215 
00216     <span class="keywordflow">if</span> (rc) Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_dynamic_fsinfo );
00217     
00218     cos_export = fsattrs.ClassOfService ;
00219     
00220     <span class="comment">/* @todo : sometimes NULL ??? */</span>
00221     <span class="keywordflow">if</span> ( cos_export == 0 ) cos_export = 1;
00222     
00223   }
00224   
00225   <span class="comment">/* then retrieve info about this cos */</span>
00226   
00227   <a class="code" href="fsal__internal_8c.html#a18">TakeTokenFSCall</a>();
00228   rc = hpss_Statfs( cos_export, &amp;hpss_statfs );
00229   ReleaseTokenFSCall();
00230     
00231   <span class="keywordflow">if</span> ( rc ) Return( <a class="code" href="fsal__convert_8c.html#a2">hpss2fsal_error</a>(rc), -rc, INDEX_FSAL_dynamic_fsinfo );
00232 
00233   <span class="comment">/* @todo :  sometimes hpss_statfs.f_blocks &lt; hpss_statfs.f_bfree !!! */</span>
00234   
00235   <span class="keywordflow">if</span> ( dynamicinfo-&gt;total_bytes &gt;  dynamicinfo-&gt;free_bytes )
00236   {
00237     dynamicinfo-&gt;total_bytes= hpss_statfs.f_blocks * hpss_statfs.f_bsize;
00238     dynamicinfo-&gt;free_bytes = hpss_statfs.f_bfree * hpss_statfs.f_bsize ;
00239     dynamicinfo-&gt;avail_bytes= hpss_statfs.f_bavail * hpss_statfs.f_bsize;
00240     
00241     dynamicinfo-&gt;total_files= hpss_statfs.f_files;
00242     dynamicinfo-&gt;free_files = hpss_statfs.f_ffree;  
00243     dynamicinfo-&gt;avail_files= hpss_statfs.f_ffree;
00244   }
00245   
00246 <span class="preprocessor">#else</span>
00247 <span class="preprocessor"></span>  
00248   <span class="comment">/* return dummy values... like HPSS do... */</span>
00249   
00250 <span class="comment">/*  dynamicinfo-&gt;total_bytes= 1976007601074984ULL;</span>
00251 <span class="comment">  dynamicinfo-&gt;free_bytes =   23992398925016ULL;</span>
00252 <span class="comment">  dynamicinfo-&gt;avail_bytes=   23992398925016ULL;*/</span>
00253 
00254   dynamicinfo-&gt;total_bytes=   INT_MAX;
00255   dynamicinfo-&gt;free_bytes =   INT_MAX;
00256   dynamicinfo-&gt;avail_bytes=   INT_MAX;
00257 
00258   dynamicinfo-&gt;total_files= 20000000;
00259   dynamicinfo-&gt;free_files = 1000000;
00260   dynamicinfo-&gt;avail_files= 1000000;
00261   
00262 <span class="preprocessor">#endif</span>
00263 <span class="preprocessor"></span>  dynamicinfo-&gt;time_delta.seconds = 1;
00264   dynamicinfo-&gt;time_delta.nseconds = 0;
00265     
00266   Return(ERR_FSAL_NO_ERROR,0,INDEX_FSAL_dynamic_fsinfo);
00267   
00268 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:43 2008 for File System Abstraction Layer (HPSS) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
