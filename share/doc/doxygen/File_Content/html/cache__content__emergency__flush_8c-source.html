<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File Content layer: cache_content_emergency_flush.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>cache_content_emergency_flush.c</h1><a href="cache__content__emergency__flush_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Ce logiciel est un serveur implementant le protocole NFS.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * Ce logiciel est régi par la licence CeCILL soumise au droit français et</span>
00012 <span class="comment"> * respectant les principes de diffusion des logiciels libres. Vous pouvez</span>
00013 <span class="comment"> * utiliser, modifier et/ou redistribuer ce programme sous les conditions</span>
00014 <span class="comment"> * de la licence CeCILL telle que diffusée par le CEA, le CNRS et l'INRIA</span>
00015 <span class="comment"> * sur le site "http://www.cecill.info".</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * En contrepartie de l'accessibilité au code source et des droits de copie,</span>
00018 <span class="comment"> * de modification et de redistribution accordés par cette licence, il n'est</span>
00019 <span class="comment"> * offert aux utilisateurs qu'une garantie limitée.  Pour les mêmes raisons,</span>
00020 <span class="comment"> * seule une responsabilité restreinte pèse sur l'auteur du programme,  le</span>
00021 <span class="comment"> * titulaire des droits patrimoniaux et les concédants successifs.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * A cet égard  l'attention de l'utilisateur est attirée sur les risques</span>
00024 <span class="comment"> * associés au chargement,  à l'utilisation,  à la modification et/ou au</span>
00025 <span class="comment"> * développement et à la reproduction du logiciel par l'utilisateur étant</span>
00026 <span class="comment"> * donné sa spécificité de logiciel libre, qui peut le rendre complexe à</span>
00027 <span class="comment"> * manipuler et qui le réserve donc à des développeurs et des professionnels</span>
00028 <span class="comment"> * avertis possédant  des  connaissances  informatiques approfondies.  Les</span>
00029 <span class="comment"> * utilisateurs sont donc invités à charger  et  tester  l'adéquation  du</span>
00030 <span class="comment"> * logiciel à leurs besoins dans des conditions permettant d'assurer la</span>
00031 <span class="comment"> * sécurité de leurs systèmes et ou de leurs données et, plus généralement,</span>
00032 <span class="comment"> * à l'utiliser et l'exploiter dans les mêmes conditions de sécurité.</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> * Le fait que vous puissiez accéder à cet en-tête signifie que vous avez</span>
00035 <span class="comment"> * pris connaissance de la licence CeCILL, et que vous en avez accepté les</span>
00036 <span class="comment"> * termes.</span>
00037 <span class="comment"> *</span>
00038 <span class="comment"> * ---------------------</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * Copyright CEA/DAM/DIF (2005)</span>
00041 <span class="comment"> *  Contributor: Philippe DENIEL  philippe.deniel@cea.fr</span>
00042 <span class="comment"> *               Thomas LEIBOVICI thomas.leibovici@cea.fr</span>
00043 <span class="comment"> *</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> * This software is a server that implements the NFS protocol.</span>
00046 <span class="comment"> * </span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> * This software is governed by the CeCILL  license under French law and</span>
00049 <span class="comment"> * abiding by the rules of distribution of free software.  You can  use,</span>
00050 <span class="comment"> * modify and/ or redistribute the software under the terms of the CeCILL</span>
00051 <span class="comment"> * license as circulated by CEA, CNRS and INRIA at the following URL</span>
00052 <span class="comment"> * "http://www.cecill.info".</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> * As a counterpart to the access to the source code and  rights to copy,</span>
00055 <span class="comment"> * modify and redistribute granted by the license, users are provided only</span>
00056 <span class="comment"> * with a limited warranty  and the software's author,  the holder of the</span>
00057 <span class="comment"> * economic rights,  and the successive licensors  have only  limited</span>
00058 <span class="comment"> * liability.</span>
00059 <span class="comment"> *</span>
00060 <span class="comment"> * In this respect, the user's attention is drawn to the risks associated</span>
00061 <span class="comment"> * with loading,  using,  modifying and/or developing or reproducing the</span>
00062 <span class="comment"> * software by the user in light of its specific status of free software,</span>
00063 <span class="comment"> * that may mean  that it is complicated to manipulate,  and  that  also</span>
00064 <span class="comment"> therefore means  that it is reserved for developers  and  experienced</span>
00065 <span class="comment"> * professionals having in-depth computer knowledge. Users are therefore</span>
00066 <span class="comment"> * encouraged to load and test the software's suitability as regards their</span>
00067 <span class="comment"> * requirements in conditions enabling the security of their systems and/or</span>
00068 <span class="comment"> * data to be ensured and,  more generally, to use and operate it in the</span>
00069 <span class="comment"> * same conditions as regards security.</span>
00070 <span class="comment"> *</span>
00071 <span class="comment"> * The fact that you are presently reading this means that you have had</span>
00072 <span class="comment"> * knowledge of the CeCILL license and that you accept its terms.</span>
00073 <span class="comment"> * ---------------------------------------</span>
00074 <span class="comment"> */</span>
00075 
00088 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00090 <span class="preprocessor">#endif</span>
00091 <span class="preprocessor"></span>
00092 <span class="preprocessor">#include "LRU_List.h"</span>
00093 <span class="preprocessor">#include "log_functions.h"</span>
00094 <span class="preprocessor">#include "HashData.h"</span>
00095 <span class="preprocessor">#include "HashTable.h"</span>
00096 <span class="preprocessor">#include "fsal.h"</span>
00097 <span class="preprocessor">#include "cache_inode.h"</span>
00098 <span class="preprocessor">#include "cache_content.h"</span>
00099 
00100 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00101 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00102 <span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00103 <span class="preprocessor">#include &lt;time.h&gt;</span>
00104 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00105 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00106 
00107 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00108 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
00109 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00110 <span class="preprocessor">#include &lt;string.h&gt;</span>
00111 
00112 
00113 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cache_content_dir_errno ; 
00114 
<a name="l00135"></a><a class="code" href="cache__content__emergency__flush_8c.html#a1">00135</a> cache_content_status_t <a class="code" href="cache__content__emergency__flush_8c.html#a1">cache_content_emergency_flush</a>( <span class="keywordtype">char</span>                             * cachedir,
00136                                                       cache_content_flush_behaviour_t    flushhow,
00137                                                       time_t                             grace_period,
00138                                                       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                       index,
00139                                                       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                       mod, 
00140                                                       fsal_op_context_t                * pcontext,
00141                                                       cache_content_status_t           * pstatus ) 
00142 {
00143    fsal_handle_t             fsal_handle ;
00144    fsal_status_t             fsal_status ;
00145    cache_content_dirinfo_t   directory ;
00146    <span class="keyword">struct </span>dirent             dir_entry ;
00147    FILE                    * stream    = NULL ;
00148    <span class="keywordtype">char</span>                      buff[CACHE_INODE_DUMP_LEN] ;
00149    <span class="keywordtype">int</span>                       inum ;
00150    <span class="keywordtype">char</span>                      indexpath[MAXPATHLEN] ;
00151    <span class="keywordtype">char</span>                      datapath[MAXPATHLEN] ;
00152    <span class="keywordtype">char</span>                      datapathmoved[MAXPATHLEN] ;
00153    fsal_path_t               fsal_path ;
00154    fsal_mdsize_t             strsize = MAXPATHLEN + 1 ;
00155    <span class="keyword">struct </span>stat               buffstat ;
00156    time_t                    max_acmtime = 0 ;
00157    cache_content_dirinfo_t   iter_dir ;
00158 <span class="preprocessor">#ifdef _USE_PROXY</span>
00159 <span class="preprocessor"></span>   fsal_u64_t                fileid ;
00160 <span class="preprocessor">#endif</span>
00161 <span class="preprocessor"></span>
00162    *pstatus = CACHE_CONTENT_SUCCESS ;
00163 
00164    <span class="keywordflow">if</span>( <a class="code" href="cache__content__misc_8c.html#a16">cache_content_local_cache_opendir</a>( cachedir, &amp;directory )  == FALSE )
00165      {
00166         DisplayLog( <span class="stringliteral">"cache_content_emergency_flush can't open directory %s, errno=%u (%s)"</span>, 
00167                     cachedir, <a class="code" href="cache__content__emergency__flush_8c.html#a0">cache_content_dir_errno</a>, strerror( <a class="code" href="cache__content__emergency__flush_8c.html#a0">cache_content_dir_errno</a> ) ) ;
00168         *pstatus = CACHE_CONTENT_LOCAL_CACHE_ERROR ;
00169         <span class="keywordflow">return</span> *pstatus ;
00170      }
00171 
00172    <span class="keywordflow">while</span>( <a class="code" href="cache__content__misc_8c.html#a18">cache_content_local_cache_dir_iter</a>( &amp;directory, &amp;dir_entry, index, mod )  )
00173      {
00174         <span class="comment">/* Manage only index files */</span>
00175         <span class="keywordflow">if</span>( !strcmp( dir_entry.d_name + strlen( dir_entry.d_name  ) -5, <span class="stringliteral">"index"</span> )  )
00176           {
00177              <span class="keywordflow">if</span>( ( inum = <a class="code" href="cache__content__misc_8c.html#a6">cache_content_get_inum</a>( dir_entry.d_name ) ) == -1 )
00178                 {
00179                   DisplayLog( <span class="stringliteral">"Bad file name %s found in cache"</span>, dir_entry.d_name ) ;
00180                   continue ;
00181                 }
00182             
00183              <span class="comment">/* read the content of the index file, for having the FSAL handle */</span> 
00184 
00185              snprintf( indexpath, MAXPATHLEN, <span class="stringliteral">"%s/%s"</span>, cachedir, dir_entry.d_name ) ;
00186 
00187              <span class="keywordflow">if</span>( ( stream = fopen( indexpath, <span class="stringliteral">"r"</span> ) ) == NULL ) 
00188                 <span class="keywordflow">return</span> CACHE_CONTENT_LOCAL_CACHE_ERROR ;
00189 
00190              fscanf( stream, <span class="stringliteral">"internal:read_time=%s\n"</span>, buff) ;
00191              fscanf( stream, <span class="stringliteral">"internal:mod_time=%s\n"</span>, buff ) ;
00192              fscanf( stream, <span class="stringliteral">"internal:export_id=%s\n"</span>, buff ) ;
00193              fscanf( stream, <span class="stringliteral">"file: FSAL handle=%s"</span>, buff ) ;
00194              sscanHandle( &amp;fsal_handle, buff ) ;
00195 
00196              <span class="comment">/* Now close the stream */</span>
00197              fclose( stream ) ;
00198 
00199          <a class="code" href="cache__content__misc_8c.html#a7">cache_content_get_datapath</a>( cachedir, inum, datapath );
00200          snprintf( datapathmoved, MAXPATHLEN, <span class="stringliteral">"%s.under_resync"</span>, datapath ) ;
00201 
00202              <span class="comment">/* Stat the data file to now if it is eligible or not */</span>   
00203              <span class="keywordflow">if</span>( stat( datapath, &amp;buffstat ) == -1  )
00204                 {
00205                    DisplayLog( <span class="stringliteral">"Can't stat file %s errno=%u(%s), continuing with next entries..."</span>, datapath, errno, strerror( errno ) ) ;
00206                    continue ;
00207                 }
00208 
00209              <span class="comment">/* Get the max into atime, mtime, ctime */</span>
00210              max_acmtime = 0 ;
00211 
00212              <span class="keywordflow">if</span>( buffstat.st_atime &gt; max_acmtime ) max_acmtime = buffstat.st_atime ;
00213              <span class="keywordflow">if</span>( buffstat.st_mtime &gt; max_acmtime ) max_acmtime = buffstat.st_mtime ;
00214              <span class="keywordflow">if</span>( buffstat.st_ctime &gt; max_acmtime ) max_acmtime = buffstat.st_ctime ;
00215 
00216 <span class="preprocessor">#ifdef _DEBUG_CACHE_CONTENT</span>
00217 <span class="preprocessor"></span>             printf( <span class="stringliteral">"date=%d max_acmtime=%d ,time( NULL ) - max_acmtime = %d, grace_period = %d\n"</span>, 
00218                      time( NULL ), max_acmtime, time( NULL ) - max_acmtime , grace_period ) ;
00219 <span class="preprocessor">#endif</span>
00220 <span class="preprocessor"></span>
00221              <span class="keywordflow">if</span>( time( NULL ) - max_acmtime &lt; grace_period ) 
00222                 {
00223                    DisplayLog( <span class="stringliteral">"File %s is too young to die, preserving it..."</span>, datapath ) ;
00224                    continue ;
00225                 }
00226  
00227              <span class="keywordflow">if</span>( rename( datapath, datapathmoved) == -1 ) 
00228                 <span class="keywordflow">return</span> CACHE_CONTENT_LOCAL_CACHE_ERROR ;
00229 
00230 <span class="preprocessor">#ifdef _DEBUG_CACHE_CONTENT</span>
00231 <span class="preprocessor"></span>             printf( <span class="stringliteral">"=====&gt; local=%s FSAL HANDLE="</span>, datapathmoved ) ;
00232              print_buff( (<span class="keywordtype">char</span> *)&amp;fsal_handle, <span class="keyword">sizeof</span>( fsal_handle ) ) ; 
00233 <span class="preprocessor">#endif</span>
00234 <span class="preprocessor"></span>
00235              fsal_status = FSAL_str2path( datapathmoved, strsize, &amp;fsal_path ) ;
00236 <span class="preprocessor">#ifdef _USE_PROXY</span>
00237 <span class="preprocessor"></span>             fileid = <a class="code" href="cache__content__misc_8c.html#a6">cache_content_get_inum</a>( dir_entry.d_name ) ;
00238 
00239 <span class="preprocessor">#ifdef _DEBUG_CACHE_CONTENT</span>
00240 <span class="preprocessor"></span>             printf( <span class="stringliteral">"====&gt; Fileid = %llu %llx\n"</span>, fileid, fileid ) ;
00241 <span class="preprocessor">#endif</span>
00242 <span class="preprocessor"></span>
00243              <span class="keywordflow">if</span>( !FSAL_IS_ERROR( fsal_status ) ) 
00244                 {
00245                   fsal_status = FSAL_rcp_by_fileid( &amp;fsal_handle,
00246                                                     fileid, 
00247                                                     pcontext,
00248                                                     &amp;fsal_path,
00249                                                     FSAL_RCP_LOCAL_TO_FS ) ;
00250                 }
00251 <span class="preprocessor">#else</span>
00252 <span class="preprocessor"></span>             <span class="keywordflow">if</span>( !FSAL_IS_ERROR( fsal_status ) ) 
00253                 {
00254                   fsal_status = FSAL_rcp( &amp;fsal_handle, 
00255                                           pcontext, 
00256                                           &amp;fsal_path,                                     
00257                                           FSAL_RCP_LOCAL_TO_FS ) ;
00258                 }
00259 <span class="preprocessor">#endif</span>
00260 <span class="preprocessor"></span>
00261              <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) ) 
00262                {
00263                  <span class="keywordflow">if</span>( ( fsal_status.major == ERR_FSAL_NOENT ) ||
00264                      ( fsal_status.major == ERR_FSAL_STALE ) )
00265                    {
00266                      DisplayLog( <span class="stringliteral">"Cached entry %x doesn't exist anymore in FSAL, removing...."</span>, inum ) ;
00267 
00268                      <span class="comment">/* Remove the index file from the data cache */</span>
00269                      <span class="keywordflow">if</span>( unlink( indexpath ) )
00270                        {
00271                            DisplayLog( <span class="stringliteral">"Can't unlink flushed index %s, errno=%u(%s)"</span>, indexpath, errno, strerror( errno ) ) ;
00272                            <span class="keywordflow">return</span> CACHE_CONTENT_LOCAL_CACHE_ERROR ;
00273                        }
00274 
00275                      <span class="comment">/* Remove the data file from the data cache */</span>
00276                      <span class="keywordflow">if</span>( unlink( datapathmoved ) )
00277                        {
00278                            DisplayLog( <span class="stringliteral">"Can't unlink flushed index %s, errno=%u(%s)"</span>, datapath, errno, strerror( errno ) ) ;
00279                            <span class="keywordflow">return</span> CACHE_CONTENT_LOCAL_CACHE_ERROR ;
00280                        }
00281                    }
00282                  <span class="keywordflow">else</span>
00283                    DisplayLog( <span class="stringliteral">"Can't flush file #%x, fsal_status.major=%u fsal_status.minor=%u"</span>, 
00284                                inum, fsal_status.major, fsal_status.minor ) ;
00285                }
00286              <span class="keywordflow">else</span>
00287                {
00288                   <span class="keywordflow">switch</span>( flushhow ) 
00289                     {
00290                       <span class="keywordflow">case</span> CACHE_CONTENT_FLUSH_AND_DELETE:
00291                          <span class="comment">/* Remove the index file from the data cache */</span>
00292                          <span class="keywordflow">if</span>( unlink( indexpath ) )
00293                            {
00294                               DisplayLog( <span class="stringliteral">"Can't unlink flushed index %s, errno=%u(%s)"</span>, indexpath, errno, strerror( errno ) ) ;
00295                               <span class="keywordflow">return</span> CACHE_CONTENT_LOCAL_CACHE_ERROR ;
00296                            }
00297 
00298                          <span class="comment">/* Remove the data file from the data cache */</span>
00299                          <span class="keywordflow">if</span>( unlink( datapathmoved ) )
00300                            {
00301                               DisplayLog( <span class="stringliteral">"Can't unlink flushed index %s, errno=%u(%s)"</span>, datapathmoved, errno, strerror( errno ) ) ;
00302                               <span class="keywordflow">return</span> CACHE_CONTENT_LOCAL_CACHE_ERROR ;
00303                            }
00304                          break ;
00305 
00306                      <span class="keywordflow">case</span> CACHE_CONTENT_FLUSH_SYNC_ONLY:
00307                         <span class="keywordflow">if</span>( rename( datapathmoved, datapath ) == -1 ) 
00308                                 <span class="keywordflow">return</span> CACHE_CONTENT_LOCAL_CACHE_ERROR ;
00309                         break ;
00310                     }
00311                }
00312           }
00313      } 
00314    
00315   <a class="code" href="cache__content__misc_8c.html#a19">cache_content_local_cache_closedir</a>( &amp;directory ) ;
00316 
00317    <span class="keywordflow">return</span> *pstatus ;
00318 } <span class="comment">/* cache_content_emergency_flush */</span>
00319 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:20 2008 for File Content layer by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
