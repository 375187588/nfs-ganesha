<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LRu List Library: test_configurable_lru.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>test_configurable_lru.c</h1><a href="test__configurable__lru_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Ce logiciel est un serveur implementant le protocole NFS.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * Ce logiciel est régi par la licence CeCILL soumise au droit français et</span>
00012 <span class="comment"> * respectant les principes de diffusion des logiciels libres. Vous pouvez</span>
00013 <span class="comment"> * utiliser, modifier et/ou redistribuer ce programme sous les conditions</span>
00014 <span class="comment"> * de la licence CeCILL telle que diffusée par le CEA, le CNRS et l'INRIA</span>
00015 <span class="comment"> * sur le site "http://www.cecill.info".</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * En contrepartie de l'accessibilité au code source et des droits de copie,</span>
00018 <span class="comment"> * de modification et de redistribution accordés par cette licence, il n'est</span>
00019 <span class="comment"> * offert aux utilisateurs qu'une garantie limitée.  Pour les mêmes raisons,</span>
00020 <span class="comment"> * seule une responsabilité restreinte pèse sur l'auteur du programme,  le</span>
00021 <span class="comment"> * titulaire des droits patrimoniaux et les concédants successifs.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * A cet égard  l'attention de l'utilisateur est attirée sur les risques</span>
00024 <span class="comment"> * associés au chargement,  à l'utilisation,  à la modification et/ou au</span>
00025 <span class="comment"> * développement et à la reproduction du logiciel par l'utilisateur étant</span>
00026 <span class="comment"> * donné sa spécificité de logiciel libre, qui peut le rendre complexe à</span>
00027 <span class="comment"> * manipuler et qui le réserve donc à des développeurs et des professionnels</span>
00028 <span class="comment"> * avertis possédant  des  connaissances  informatiques approfondies.  Les</span>
00029 <span class="comment"> * utilisateurs sont donc invités à charger  et  tester  l'adéquation  du</span>
00030 <span class="comment"> * logiciel à leurs besoins dans des conditions permettant d'assurer la</span>
00031 <span class="comment"> * sécurité de leurs systèmes et ou de leurs données et, plus généralement,</span>
00032 <span class="comment"> * à l'utiliser et l'exploiter dans les mêmes conditions de sécurité.</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> * Le fait que vous puissiez accéder à cet en-tête signifie que vous avez</span>
00035 <span class="comment"> * pris connaissance de la licence CeCILL, et que vous en avez accepté les</span>
00036 <span class="comment"> * termes.</span>
00037 <span class="comment"> *</span>
00038 <span class="comment"> * ---------------------</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * Copyright CEA/DAM/DIF (2005)</span>
00041 <span class="comment"> *  Contributor: Philippe DENIEL  philippe.deniel@cea.fr</span>
00042 <span class="comment"> *               Thomas LEIBOVICI thomas.leibovici@cea.fr</span>
00043 <span class="comment"> *</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> * This software is a server that implements the NFS protocol.</span>
00046 <span class="comment"> * </span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> * This software is governed by the CeCILL  license under French law and</span>
00049 <span class="comment"> * abiding by the rules of distribution of free software.  You can  use,</span>
00050 <span class="comment"> * modify and/ or redistribute the software under the terms of the CeCILL</span>
00051 <span class="comment"> * license as circulated by CEA, CNRS and INRIA at the following URL</span>
00052 <span class="comment"> * "http://www.cecill.info".</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> * As a counterpart to the access to the source code and  rights to copy,</span>
00055 <span class="comment"> * modify and redistribute granted by the license, users are provided only</span>
00056 <span class="comment"> * with a limited warranty  and the software's author,  the holder of the</span>
00057 <span class="comment"> * economic rights,  and the successive licensors  have only  limited</span>
00058 <span class="comment"> * liability.</span>
00059 <span class="comment"> *</span>
00060 <span class="comment"> * In this respect, the user's attention is drawn to the risks associated</span>
00061 <span class="comment"> * with loading,  using,  modifying and/or developing or reproducing the</span>
00062 <span class="comment"> * software by the user in light of its specific status of free software,</span>
00063 <span class="comment"> * that may mean  that it is complicated to manipulate,  and  that  also</span>
00064 <span class="comment"> therefore means  that it is reserved for developers  and  experienced</span>
00065 <span class="comment"> * professionals having in-depth computer knowledge. Users are therefore</span>
00066 <span class="comment"> * encouraged to load and test the software's suitability as regards their</span>
00067 <span class="comment"> * requirements in conditions enabling the security of their systems and/or</span>
00068 <span class="comment"> * data to be ensured and,  more generally, to use and operate it in the</span>
00069 <span class="comment"> * same conditions as regards security.</span>
00070 <span class="comment"> *</span>
00071 <span class="comment"> * The fact that you are presently reading this means that you have had</span>
00072 <span class="comment"> * knowledge of the CeCILL license and that you accept its terms.</span>
00073 <span class="comment"> * ---------------------------------------</span>
00074 <span class="comment"> * Configurable test for the LRU List layer</span>
00075 <span class="comment"> *</span>
00076 <span class="comment"> * $Header: /cea/home/cvs/cvs/SHERPA/BaseCvs/GANESHA/src/LRU/test_configurable_lru.c,v 1.7 2005/11/28 17:02:39 deniel Exp $</span>
00077 <span class="comment"> *</span>
00078 <span class="comment"> * $Log: test_configurable_lru.c,v $</span>
00079 <span class="comment"> * Revision 1.7  2005/11/28 17:02:39  deniel</span>
00080 <span class="comment"> * Added CeCILL headers</span>
00081 <span class="comment"> *</span>
00082 <span class="comment"> * Revision 1.6  2005/05/10 11:44:02  deniel</span>
00083 <span class="comment"> * Datacache and metadatacache are noewqw bounded</span>
00084 <span class="comment"> *</span>
00085 <span class="comment"> * Revision 1.5  2004/12/08 14:49:44  deniel</span>
00086 <span class="comment"> * Lack of includes in test_configurable_hash.c and  test_configurable_lru.c</span>
00087 <span class="comment"> *</span>
00088 <span class="comment"> * Revision 1.4  2004/10/19 08:41:09  deniel</span>
00089 <span class="comment"> * Lots of memory leaks fixed</span>
00090 <span class="comment"> *</span>
00091 <span class="comment"> * Revision 1.3  2004/10/18 08:42:43  deniel</span>
00092 <span class="comment"> * Modifying prototypes for LRU_new_entry</span>
00093 <span class="comment"> *</span>
00094 <span class="comment"> * Revision 1.2  2004/09/23 14:34:48  deniel</span>
00095 <span class="comment"> * Mise en place du test configurable</span>
00096 <span class="comment"> *</span>
00097 <span class="comment"> * Revision 1.1  2004/09/21 13:18:40  deniel</span>
00098 <span class="comment"> *  test_configurable.c renomme en test_configurable_lru.c</span>
00099 <span class="comment"> *</span>
00100 <span class="comment"> * Revision 1.1  2004/09/01 14:52:24  deniel</span>
00101 <span class="comment"> * Population de la branche LRU</span>
00102 <span class="comment"> *</span>
00103 <span class="comment"> *</span>
00104 <span class="comment"> */</span>
00105 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00107 <span class="preprocessor">#endif</span>
00108 <span class="preprocessor"></span>
00109 
00110 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00111 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00112 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00113 <span class="preprocessor">#include &lt;string.h&gt;</span>
00114 <span class="preprocessor">#include "BuddyMalloc.h"</span>
00115 <span class="preprocessor">#include "LRU_List.h"</span>
00116 
<a name="l00117"></a><a class="code" href="test__configurable__lru_8c.html#a0">00117</a> <span class="preprocessor">#define LENBUF 256</span>
<a name="l00118"></a><a class="code" href="test__configurable__lru_8c.html#a1">00118</a> <span class="preprocessor"></span><span class="preprocessor">#define STRSIZE 10</span>
<a name="l00119"></a><a class="code" href="test__configurable__lru_8c.html#a2">00119</a> <span class="preprocessor"></span><span class="preprocessor">#define PREALLOC 1000000</span>
<a name="l00120"></a><a class="code" href="test__configurable__lru_8c.html#a3">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXTEST 1000000    </span>
00121 <span class="preprocessor"></span>
<a name="l00122"></a><a class="code" href="test__configurable__lru_8c.html#a4">00122</a> LRU_entry_t * <a class="code" href="test__configurable__lru_8c.html#a4">tabentry</a>[MAXTEST] ;
00123 
00124 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="test__lru_8c.html#a3">print_entry</a>( LRU_data_t data, <span class="keywordtype">char</span> *str )
00125 {
00126   <span class="keywordflow">return</span> snprintf( str, LRU_DISPLAY_STRLEN, <span class="stringliteral">"%s, len=%d"</span>, (<span class="keywordtype">char</span> *)data.pdata, data.len ) ;
00127 } <span class="comment">/* print_entry */</span>
00128 
00129 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="test__lru_8c.html#a4">clean_entry</a>(  LRU_entry_t * pentry, <span class="keywordtype">void</span> * addparam )
00130 {
00131   <span class="keywordflow">return</span> 0 ;
00132 } <span class="comment">/* cleanentry */</span>
00133 
<a name="l00134"></a><a class="code" href="test__configurable__lru_8c.html#a7">00134</a> <span class="keywordtype">int</span> <a class="code" href="test__configurable__lru_8c.html#a7">do_invalidate</a>( LRU_list_t * plru, <span class="keywordtype">int</span> key )
00135 {
00136   LRU_entry_t * pentry = NULL ;
00137   
00138   pentry = <a class="code" href="test__configurable__lru_8c.html#a4">tabentry</a>[key] ;
00139 
00140   <span class="keywordflow">return</span>  <a class="code" href="group__LRUExportedFunctions.html#ga1">LRU_invalidate</a>( plru, pentry ) ;
00141 }
00142 
<a name="l00143"></a><a class="code" href="test__configurable__lru_8c.html#a8">00143</a> <span class="keywordtype">int</span> <a class="code" href="test__configurable__lru_8c.html#a8">do_new</a>(  LRU_list_t * plru, <span class="keywordtype">int</span> key )
00144 {
00145   <span class="keywordtype">char</span> * tmpkey = NULL ;
00146   
00147   LRU_entry_t * pentry = NULL ;
00148   LRU_status_t status ;
00149 
00150   <span class="keywordflow">if</span>( ( tmpkey = (<span class="keywordtype">char</span> *)malloc( <a class="code" href="test__configurable__lru_8c.html#a1">STRSIZE</a> ) ) == NULL )
00151     <span class="keywordflow">return</span> -1 ;
00152 
00153   sprintf( tmpkey, <span class="stringliteral">"%d"</span>, key ) ;
00154   
00155   <span class="keywordflow">if</span>( ( pentry = <a class="code" href="group__LRUExportedFunctions.html#ga2">LRU_new_entry</a>( plru, &amp;status ) ) == NULL )
00156     <span class="keywordflow">return</span> status ;
00157   
00158   pentry-&gt;buffdata.len   = strlen( tmpkey ) ;
00159   pentry-&gt;buffdata.pdata = tmpkey ;
00160 
00161   <a class="code" href="test__configurable__lru_8c.html#a4">tabentry</a>[key] = pentry ;
00162   
00163   <span class="keywordflow">return</span> status ;
00164 }
00165 
<a name="l00166"></a><a class="code" href="test__configurable__lru_8c.html#a9">00166</a> <span class="keywordtype">int</span> <a class="code" href="test__configurable__lru_8c.html#a9">do_gc</a>( LRU_list_t * plru )
00167 {
00168   <span class="keywordflow">return</span> <a class="code" href="group__LRUExportedFunctions.html#ga3">LRU_gc_invalid</a>( plru, NULL ) ;
00169 }
00170 
00171 
<a name="l00172"></a><a class="code" href="test__configurable__lru_8c.html#a10">00172</a> <span class="keywordtype">int</span> <a class="code" href="test__lru_8c.html#a5">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[] )
00173 {
00174   <span class="keywordtype">char</span> buf[LENBUF];
00175   <span class="keywordtype">int</span> ok = 1 ;
00176   <span class="keywordtype">int</span> hrc = 0 ;
00177   <span class="keywordtype">int</span> rc = 0 ;
00178   <span class="keywordtype">int</span> expected_rc ;
00179   <span class="keywordtype">char</span> c ;
00180   <span class="keywordtype">char</span> * p;
00181   <span class="keywordtype">int</span> key  ;
00182 
00183   LRU_status_t status = 0 ;
00184   LRU_list_t * plru ;
00185   LRU_parameter_t param ;
00186 
00187   param.nb_entry_prealloc =  PREALLOC ;
00188   param.entry_to_str = print_entry ;
00189   param.clean_entry = clean_entry ;
00190   
00191   BuddyInit( NULL ) ;
00192   
00193   <span class="keywordflow">if</span>( ( plru = <a class="code" href="group__LRUExportedFunctions.html#ga0">LRU_Init</a>( param, &amp;status ) ) == NULL )
00194     {
00195        printf( <span class="stringliteral">"Test ECHOUE : Mauvaise init\n"</span> ) ;
00196        exit( 1 ) ;
00197     }  
00198 
00199   <span class="comment">/*</span>
00200 <span class="comment">   *</span>
00201 <span class="comment">   * La syntaxe d'un test est </span>
00202 <span class="comment">   * 'i key rc' : invalide l'entree avec la clef key</span>
00203 <span class="comment">   * 'n key rc' : cree une nouvelle entree avec la clef key</span>
00204 <span class="comment">   * 'g key rc' : passage du garbage collector (key ne sert a rien)</span>
00205 <span class="comment">   * 'p key rc' : imprime le LRU (key et rc ne servent a rien).</span>
00206 <span class="comment">   * </span>
00207 <span class="comment">   * Une ligne qui debute par '#' est un commentaire</span>
00208 <span class="comment">   * Une ligne qui debute par un espace ou un tab est une ligne vide [meme si il y a des trucs derriere.. :-( ]</span>
00209 <span class="comment">   * Une ligne vide (juste un CR) est une ligne vide (cette citation a recu le Premier Prix lors du Festival International </span>
00210 <span class="comment">   * de la Tautologie de Langue Francaise (FITLF), a Poully le Marais, en Aout 2004)</span>
00211 <span class="comment">   *</span>
00212 <span class="comment">   */</span>
00213 
00214   printf( <span class="stringliteral">"============ Debut de l'interactif =================\n"</span> ) ;
00215 
00216   <span class="keywordflow">while</span>( ok ) 
00217     {
00218       <span class="comment">/* Code interactif, pompe sur le test rbt de Jacques */</span>
00219       fputs(<span class="stringliteral">"&gt; "</span>, stdout);
00220       <span class="keywordflow">if</span>( ( p = fgets(buf, <a class="code" href="test__configurable__lru_8c.html#a0">LENBUF</a>, stdin) ) == NULL ) 
00221         {
00222           printf(<span class="stringliteral">"fin des commandes\n"</span>);
00223           ok = 0;
00224           <span class="keywordflow">continue</span>;
00225         }
00226       <span class="keywordflow">if</span>( ( p = strchr(buf, <span class="charliteral">'\n'</span>) ) != NULL )
00227         *p = <span class="charliteral">'\0'</span> ;
00228       
00229       rc = sscanf(buf, <span class="stringliteral">"%c %d %d"</span>, &amp;c, &amp;key, &amp;expected_rc) ;
00230       <span class="keywordflow">if</span>( c == <span class="charliteral">'#'</span> )
00231         {
00232           <span class="comment">/* # indique un commentaire */</span>
00233           continue ;
00234         }
00235       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( c == <span class="charliteral">' '</span> || c == <span class="charliteral">'\t'</span> || rc == -1 )
00236         {
00237           <span class="comment">/* Cas d'une ligne vide */</span>
00238           <span class="keywordflow">if</span>( rc &gt; 1 )
00239             printf( <span class="stringliteral">"Erreur de syntaxe : mettre un diese au debut d'un commentaire\n"</span> ) ;
00240           
00241           continue ;
00242         }
00243       <span class="keywordflow">else</span>
00244         {
00245           <span class="keywordflow">if</span>( rc != 3 )
00246             {
00247               printf( <span class="stringliteral">"Erreur de syntaxe : sscanf retourne %d au lieu de 3\n"</span>, rc ) ;
00248               continue ;
00249             }
00250           printf( <span class="stringliteral">"---&gt; %c %d %d\n"</span>, c, key, expected_rc ) ;
00251         }
00252       
00253       <span class="keywordflow">switch</span>( c ) 
00254         {
00255         <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00256           <span class="comment">/* set overwrite */</span>
00257           printf( <span class="stringliteral">"invalidate  %d  --&gt; %d ?\n"</span>, key, expected_rc ) ;
00258           
00259           hrc = <a class="code" href="test__configurable__lru_8c.html#a7">do_invalidate</a>( plru, key ) ;
00260           
00261           <span class="keywordflow">if</span>( hrc != expected_rc ) 
00262             printf( <span class="stringliteral">"&gt;&gt;&gt;&gt; ERREUR: invalidate  %d : %d != %d (expected)\n"</span>, key, hrc, expected_rc ) ;
00263           <span class="keywordflow">else</span>
00264             printf( <span class="stringliteral">"&gt;&gt;&gt;&gt; OK invalidate %d\n"</span>, key ) ;
00265           break ;
00266           
00267         <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
00268           <span class="comment">/* test */</span>
00269           printf( <span class="stringliteral">"new %d --&gt; %d ?\n"</span>, key, expected_rc ) ;
00270           
00271           hrc = <a class="code" href="test__configurable__lru_8c.html#a8">do_new</a>( plru, key ) ;
00272           
00273           <span class="keywordflow">if</span>( hrc != expected_rc ) 
00274             printf( <span class="stringliteral">"&gt;&gt;&gt;&gt; ERREUR: new %d : %d != %d (expected)\n"</span>, key, hrc, expected_rc ) ;
00275           <span class="keywordflow">else</span>
00276             printf( <span class="stringliteral">"&gt;&gt;&gt;&gt; OK new %d\n"</span>, key ) ;
00277           break ;
00278           
00279         <span class="keywordflow">case</span> <span class="charliteral">'g'</span>:
00280           <span class="comment">/* set no overwrite */</span>
00281           printf( <span class="stringliteral">"gc  %d --&gt; %d ?\n"</span>, key, expected_rc ) ;
00282           
00283           hrc = <a class="code" href="test__configurable__lru_8c.html#a9">do_gc</a>( plru ) ;
00284           
00285           <span class="keywordflow">if</span>( hrc != expected_rc ) 
00286             printf( <span class="stringliteral">"&gt;&gt;&gt;&gt; ERREUR: gc %d: %d != %d (expected)\n"</span>, key, hrc, expected_rc ) ;
00287           <span class="keywordflow">else</span>
00288             printf( <span class="stringliteral">"&gt;&gt;&gt;&gt; OK new  %d\n"</span>, key ) ;
00289           break ;
00290           
00291         <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
00292           <span class="comment">/* Print */</span>
00293           <a class="code" href="group__LRUExportedFunctions.html#ga6">LRU_Print</a>( plru ) ;
00294           break ;
00295           
00296         <span class="keywordflow">default</span>:
00297           <span class="comment">/* syntaxe error */</span>
00298           printf( <span class="stringliteral">"ordre '%c' non-reconnu\n"</span>, c ) ;
00299           break ;
00300          }
00301       
00302       fflush( stdin ) ;
00303     }
00304   
00305   printf( <span class="stringliteral">"====================================================\n"</span> ) ;
00306   printf( <span class="stringliteral">"Test reussi : tous les tests sont passes avec succes\n"</span> ) ;
00307   exit( 0 ) ;
00308   return ;
00309 } <span class="comment">/* main */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:24 2008 for LRu List Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
