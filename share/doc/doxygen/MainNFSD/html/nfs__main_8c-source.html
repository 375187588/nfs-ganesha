<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Daemon Main: nfs_main.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>nfs_main.c</h1><a href="nfs__main_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Ce logiciel est un serveur implementant le protocole NFS.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * Ce logiciel est régi par la licence CeCILL soumise au droit français et</span>
00012 <span class="comment"> * respectant les principes de diffusion des logiciels libres. Vous pouvez</span>
00013 <span class="comment"> * utiliser, modifier et/ou redistribuer ce programme sous les conditions</span>
00014 <span class="comment"> * de la licence CeCILL telle que diffusée par le CEA, le CNRS et l'INRIA</span>
00015 <span class="comment"> * sur le site "http://www.cecill.info".</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * En contrepartie de l'accessibilité au code source et des droits de copie,</span>
00018 <span class="comment"> * de modification et de redistribution accordés par cette licence, il n'est</span>
00019 <span class="comment"> * offert aux utilisateurs qu'une garantie limitée.  Pour les mêmes raisons,</span>
00020 <span class="comment"> * seule une responsabilité restreinte pèse sur l'auteur du programme,  le</span>
00021 <span class="comment"> * titulaire des droits patrimoniaux et les concédants successifs.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * A cet égard  l'attention de l'utilisateur est attirée sur les risques</span>
00024 <span class="comment"> * associés au chargement,  à l'utilisation,  à la modification et/ou au</span>
00025 <span class="comment"> * développement et à la reproduction du logiciel par l'utilisateur étant</span>
00026 <span class="comment"> * donné sa spécificité de logiciel libre, qui peut le rendre complexe à</span>
00027 <span class="comment"> * manipuler et qui le réserve donc à des développeurs et des professionnels</span>
00028 <span class="comment"> * avertis possédant  des  connaissances  informatiques approfondies.  Les</span>
00029 <span class="comment"> * utilisateurs sont donc invités à charger  et  tester  l'adéquation  du</span>
00030 <span class="comment"> * logiciel à leurs besoins dans des conditions permettant d'assurer la</span>
00031 <span class="comment"> * sécurité de leurs systèmes et ou de leurs données et, plus généralement,</span>
00032 <span class="comment"> * à l'utiliser et l'exploiter dans les mêmes conditions de sécurité.</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> * Le fait que vous puissiez accéder à cet en-tête signifie que vous avez</span>
00035 <span class="comment"> * pris connaissance de la licence CeCILL, et que vous en avez accepté les</span>
00036 <span class="comment"> * termes.</span>
00037 <span class="comment"> *</span>
00038 <span class="comment"> * ---------------------</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * Copyright CEA/DAM/DIF (2008)</span>
00041 <span class="comment"> *  Contributor: Philippe DENIEL  philippe.deniel@cea.fr</span>
00042 <span class="comment"> *               Thomas LEIBOVICI thomas.leibovici@cea.fr</span>
00043 <span class="comment"> *</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> * This software is a server that implements the NFS protocol.</span>
00046 <span class="comment"> * </span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> * This software is governed by the CeCILL  license under French law and</span>
00049 <span class="comment"> * abiding by the rules of distribution of free software.  You can  use,</span>
00050 <span class="comment"> * modify and/ or redistribute the software under the terms of the CeCILL</span>
00051 <span class="comment"> * license as circulated by CEA, CNRS and INRIA at the following URL</span>
00052 <span class="comment"> * "http://www.cecill.info".</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> * As a counterpart to the access to the source code and  rights to copy,</span>
00055 <span class="comment"> * modify and redistribute granted by the license, users are provided only</span>
00056 <span class="comment"> * with a limited warranty  and the software's author,  the holder of the</span>
00057 <span class="comment"> * economic rights,  and the successive licensors  have only  limited</span>
00058 <span class="comment"> * liability.</span>
00059 <span class="comment"> *</span>
00060 <span class="comment"> * In this respect, the user's attention is drawn to the risks associated</span>
00061 <span class="comment"> * with loading,  using,  modifying and/or developing or reproducing the</span>
00062 <span class="comment"> * software by the user in light of its specific status of free software,</span>
00063 <span class="comment"> * that may mean  that it is complicated to manipulate,  and  that  also</span>
00064 <span class="comment"> therefore means  that it is reserved for developers  and  experienced</span>
00065 <span class="comment"> * professionals having in-depth computer knowledge. Users are therefore</span>
00066 <span class="comment"> * encouraged to load and test the software's suitability as regards their</span>
00067 <span class="comment"> * requirements in conditions enabling the security of their systems and/or</span>
00068 <span class="comment"> * data to be ensured and,  more generally, to use and operate it in the</span>
00069 <span class="comment"> * same conditions as regards security.</span>
00070 <span class="comment"> *</span>
00071 <span class="comment"> * The fact that you are presently reading this means that you have had</span>
00072 <span class="comment"> * knowledge of the CeCILL license and that you accept its terms.</span>
00073 <span class="comment"> * ---------------------------------------</span>
00074 <span class="comment"> */</span>
00075 
00085 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00087 <span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>
00089 <span class="preprocessor">#include "<a class="code" href="nfs__init_8h.html">nfs_init.h</a>"</span>
00090 <span class="preprocessor">#include "fsal.h"</span>
00091 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00092 <span class="preprocessor">#include &lt;string.h&gt;</span>
00093 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00094 <span class="preprocessor">#include &lt;signal.h&gt;</span> <span class="comment">/* for sigaction */</span>
00095 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00096 
00097 
00098 <span class="comment">/* parameters for NFSd startup and default values */</span>
00099 
<a name="l00100"></a><a class="code" href="nfs__main_8c.html#a0">00100</a> <a class="code" href="struct____nfs__start__info.html">nfs_start_info_t</a>    <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a> =
00101 {
00102    .<a class="code" href="struct____nfs__start__info.html#o0">flush_datacache_mode</a> = FALSE,
00103    .<a class="code" href="struct____nfs__start__info.html#o1">nb_flush_threads</a>     = 1,
00104    .<a class="code" href="struct____nfs__start__info.html#o2">flush_behaviour</a>      = CACHE_CONTENT_FLUSH_AND_DELETE,
00105    .<a class="code" href="struct____nfs__start__info.html#o3">enable_rpcsec_gss</a>    = FALSE
00106 };
00107 
<a name="l00108"></a><a class="code" href="nfs__main_8c.html#a1">00108</a> <span class="keywordtype">char</span> <a class="code" href="fuse__binding_8c.html#a1">config_path</a>[MAXPATHLEN] = <span class="stringliteral">"/etc/ganesha/ganesha_nfsd.conf"</span>;
<a name="l00109"></a><a class="code" href="nfs__main_8c.html#a2">00109</a> <span class="keywordtype">char</span> <a class="code" href="fuse__binding_8c.html#a2">log_path</a>[MAXPATHLEN]    = <span class="stringliteral">"/tmp/ganesha_nfsd.log"</span>;
<a name="l00110"></a><a class="code" href="nfs__main_8c.html#a3">00110</a> <span class="keywordtype">char</span> <a class="code" href="fuse__binding_8c.html#a3">exec_name</a>[MAXPATHLEN]   = <span class="stringliteral">"ganesha-nfsd"</span>;
<a name="l00111"></a><a class="code" href="nfs__main_8c.html#a4">00111</a> <span class="keywordtype">char</span> <a class="code" href="fuse__binding_8c.html#a4">host_name</a>[MAXHOSTNAMELEN] = <span class="stringliteral">"localhost"</span>;
<a name="l00112"></a><a class="code" href="nfs__main_8c.html#a5">00112</a> <span class="keywordtype">int</span>          <a class="code" href="fuse__binding_8c.html#a5">debug_level</a>       = NIV_EVENT;
<a name="l00113"></a><a class="code" href="nfs__main_8c.html#a6">00113</a> <span class="keywordtype">int</span>          <a class="code" href="fuse__binding_8c.html#a6">detach_flag</a>       = FALSE ;
00114 
00115 
00116 <span class="comment">/* command line syntax */</span>
00117 
<a name="l00118"></a><a class="code" href="nfs__main_8c.html#a7">00118</a> <span class="keywordtype">char</span>  <a class="code" href="fuse__binding_8c.html#a9">options</a>[] = <span class="stringliteral">"h@RdS:F:S:f:L:N:"</span> ;
<a name="l00119"></a><a class="code" href="nfs__main_8c.html#a8">00119</a> <span class="keywordtype">char</span>  <a class="code" href="fuse__binding_8c.html#a10">usage</a>[] = 
00120     <span class="stringliteral">"Usage: %s [-hd][-L &lt;logfile&gt;][-N &lt;dbg_lvl&gt;][-f &lt;config_file&gt;]\n"</span>
00121     <span class="stringliteral">"\t[-h]                display this help\n"</span>
00122     <span class="stringliteral">"\t[-L &lt;logfile&gt;]      set the default logfile for the daemon\n"</span>
00123     <span class="stringliteral">"\t[-N &lt;dbg_lvl&gt;]      set the verbosity level\n"</span>
00124     <span class="stringliteral">"\t[-f &lt;config_file&gt;]  set the config file to be used\n"</span>
00125     <span class="stringliteral">"\t[-d]                the daemon starts in background, in a new process group\n"</span>
00126     <span class="stringliteral">"\t[-R]                daemon will manage RPCSEC_GSS (default is no RPCSEC_GSS)\n"</span>
00127     <span class="stringliteral">"\t[-F] &lt;nb_flushers&gt;  flushes the data cache with purge, but do not answer to requests\n"</span>
00128     <span class="stringliteral">"\t[-S] &lt;nb_flushers&gt;  flushes the data cache without purge, but do not answer to requests\n"</span>
00129     <span class="stringliteral">"----------------- Signals ----------------\n"</span>
00130     <span class="stringliteral">"SIGUSR1    : Enable/Disable File Content Cache forced flush\n"</span> 
00131     <span class="stringliteral">"------------- Default Values -------------\n"</span>
00132     <span class="stringliteral">"LogFile    : /tmp/ganesha_nfsd.log\n"</span>
00133     <span class="stringliteral">"DebugLevel : NIV_EVENT\n"</span>
00134     <span class="stringliteral">"ConfigFile : /etc/ganesha_nfsd.conf\n"</span> ;
00135 
00142 <span class="keyword">static</span> <span class="keywordtype">void</span> action_sigusr1( <span class="keywordtype">int</span> sig )
00143 {
00144  DisplayLog( <span class="stringliteral">"NFS_MAIN_SIGUSR1_HANDLER: Receveid SIGUSR1.... signal will be managed"</span> ) ;
00145  
00146   <span class="comment">/* Set variable force_flush_by_signal that is used in file content cache gc thread */</span>
00147   <span class="keywordflow">if</span>( force_flush_by_signal )
00148     {
00149         DisplayLog( <span class="stringliteral">"NFS_MAIN_SIGUSR1_HANDLER: force_flush_by_signal is set to FALSE"</span> ) ;
00150         <a class="code" href="nfs__file__content__gc__thread_8c.html#a5">force_flush_by_signal</a> = FALSE ;
00151     }
00152   <span class="keywordflow">else</span>
00153     {
00154         DisplayLog( <span class="stringliteral">"NFS_MAIN_SIGUSR1_HANDLER: force_flush_by_signal is set to TRUE"</span> ) ;
00155         <a class="code" href="nfs__file__content__gc__thread_8c.html#a5">force_flush_by_signal</a> = TRUE ;
00156     }
00157 } <span class="comment">/* action_sigusr1 */</span>
00158 
00159 
00160    
<a name="l00173"></a><a class="code" href="nfs__main_8c.html#a10">00173</a> <span class="keywordtype">int</span> <a class="code" href="nfs__main_8c.html#a10">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[] )
00174 {
00175     <span class="keywordtype">char</span>           * tempo_exec_name          = NULL ;
00176     <span class="keywordtype">char</span>             localmachine[MAXHOSTNAMELEN];
00177     <span class="keywordtype">int</span>              c ;
00178     nfs_parameter_t  nfs_param;
00179     pid_t            son_pid ;
00180     <span class="keyword">struct </span>sigaction act_sigusr1 ;
00181 
00182 
00183     <span class="comment">/* retrieve executable file's name */</span>
00184     
00185     <span class="keywordflow">if</span>( ( tempo_exec_name = strrchr( argv[0], <span class="charliteral">'/'</span> ) ) != NULL )
00186         strcpy( (<span class="keywordtype">char</span> *)<a class="code" href="fuse__binding_8c.html#a3">exec_name</a>, tempo_exec_name + 1 ) ;
00187 
00188     <span class="keywordflow">if</span>( *<a class="code" href="fuse__binding_8c.html#a3">exec_name</a> == <span class="charliteral">'\0'</span> )
00189         strcpy( (<span class="keywordtype">char</span> *)<a class="code" href="fuse__binding_8c.html#a3">exec_name</a>, argv[0] ) ;
00190    
00191     
00192     <span class="comment">/* get host name */</span>
00193     
00194     <span class="keywordflow">if</span>( gethostname( localmachine, <span class="keyword">sizeof</span>( localmachine ) ) != 0 )
00195     {
00196         fprintf( stderr, <span class="stringliteral">"Could not get local host name, exiting..."</span> ) ;
00197         exit( 1 ) ;
00198     }
00199     <span class="keywordflow">else</span>
00200         strncpy( <a class="code" href="fuse__binding_8c.html#a4">host_name</a>, localmachine, MAXHOSTNAMELEN);
00201     
00202 
00203     <span class="comment">/* now parsing options with getopt */</span>
00204     <span class="keywordflow">while</span>( ( c = getopt( argc, argv, <a class="code" href="fuse__binding_8c.html#a9">options</a> ) ) != EOF )
00205     {
00206       <span class="keywordflow">switch</span>( c ) 
00207         {
00208         <span class="keywordflow">case</span> <span class="charliteral">'@'</span>:
00209           <span class="comment">/* A litlle backdoor to keep track of binary versions */</span>
00210           printf( <span class="stringliteral">"%s compiled on %s at %s\n"</span>, <a class="code" href="fuse__binding_8c.html#a3">exec_name</a>, __DATE__, __TIME__ ) ;
00211           printf( <span class="stringliteral">"Release = %s\n"</span>, VERSION ) ;
00212           printf( <span class="stringliteral">"Release comment = %s\n"</span>, VERSION_COMMENT ) ;
00213           exit( 0 ) ;
00214           break ;
00215 
00216         <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
00217           <span class="comment">/* Default Log */</span>
00218           strncpy( <a class="code" href="fuse__binding_8c.html#a2">log_path</a>, optarg, MAXPATHLEN ) ;
00219           break ;
00220 
00221         <span class="keywordflow">case</span> <span class="charliteral">'N'</span>:
00222           <span class="comment">/* debug level */</span>
00223           <a class="code" href="fuse__binding_8c.html#a5">debug_level</a> = ReturnLevelAscii( optarg );
00224           <span class="keywordflow">if</span> ( <a class="code" href="fuse__binding_8c.html#a5">debug_level</a> == -1 )
00225           {
00226             fprintf( stderr, <span class="stringliteral">"Invalid value for option 'N': NIV_NULL, NIV_MAJ, NIV_CRIT, NIV_EVENT, NIV_DEBUG or NIV_FULL_DEBUG expected.\n"</span> );
00227             exit(1);
00228           }
00229           break ;
00230 
00231         <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
00232           <span class="comment">/* config file */</span>
00233           strncpy( <a class="code" href="fuse__binding_8c.html#a1">config_path</a>, optarg, MAXPATHLEN ) ;
00234           break ;
00235 
00236         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00237           <span class="comment">/* Detach or not detach ? */</span>
00238           <a class="code" href="fuse__binding_8c.html#a6">detach_flag</a> = TRUE ;
00239           break ;
00240 
00241         <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
00242           <span class="comment">/* Shall we manage  RPCSEC_GSS ? */</span>
00243           <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o3">enable_rpcsec_gss</a> = TRUE ;
00244           break ;
00245 
00246         <span class="keywordflow">case</span> <span class="charliteral">'F'</span>:
00247           <span class="comment">/* Flushes the data cache to the FSAL and purges the cache */</span> 
00248           <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o0">flush_datacache_mode</a> = TRUE ;
00249           <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o2">flush_behaviour</a>      = CACHE_CONTENT_FLUSH_AND_DELETE ;
00250           <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o1">nb_flush_threads</a>     = (<span class="keywordtype">unsigned</span> int)atoi( optarg ) ;
00251 
00252           <span class="keywordflow">if</span>( <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o1">nb_flush_threads</a> &gt; NB_MAX_FLUSHER_THREAD )
00253                 <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o1">nb_flush_threads</a> = NB_MAX_FLUSHER_THREAD ;
00254           break ;
00255 
00256         <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00257           <span class="comment">/* Flushes the data cache to the FSAL, without purging the cache */</span>
00258           <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o0">flush_datacache_mode</a> = TRUE ;
00259           <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o2">flush_behaviour</a>      = CACHE_CONTENT_FLUSH_SYNC_ONLY ;
00260           <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o1">nb_flush_threads</a>     = (<span class="keywordtype">unsigned</span> int)atoi( optarg ) ;
00261 
00262           <span class="keywordflow">if</span>( <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o1">nb_flush_threads</a> &gt; NB_MAX_FLUSHER_THREAD )
00263                 <a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>.<a class="code" href="struct____nfs__start__info.html#o1">nb_flush_threads</a> = NB_MAX_FLUSHER_THREAD ;
00264           break ;
00265 
00266         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00267         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00268         <span class="keywordflow">default</span>:
00269           <span class="comment">/* display the help */</span>
00270           fprintf( stderr, <a class="code" href="fuse__binding_8c.html#a10">usage</a>, <a class="code" href="fuse__binding_8c.html#a3">exec_name</a> ) ;
00271           exit( 0 ) ;
00272           break ;
00273         }
00274     }
00275     
00276     
00277     <span class="comment">/* initialize memory and logging */</span>
00278     
00279     <span class="keywordflow">if</span> ( <a class="code" href="nfs__init_8h.html#a2">nfs_prereq_init</a>( <a class="code" href="fuse__binding_8c.html#a3">exec_name</a>, <a class="code" href="fuse__binding_8c.html#a4">host_name</a>, <a class="code" href="fuse__binding_8c.html#a5">debug_level</a>, <a class="code" href="fuse__binding_8c.html#a2">log_path</a> ) )
00280     {
00281         fprintf( stderr, <span class="stringliteral">"NFS MAIN: Error initializing NFSd prerequisites\n"</span> );
00282         exit(1);
00283     }
00284     
00285     
00286     <span class="comment">/* Start in background, if wanted */</span>
00287     <span class="keywordflow">if</span>( detach_flag )
00288     {
00289       <span class="comment">/* Step 1: forking a service process */</span>
00290       <span class="keywordflow">switch</span>( son_pid = fork() )
00291         {
00292         <span class="keywordflow">case</span> -1 :
00293           <span class="comment">/* Fork failed */</span>
00294           DisplayErrorLog( ERR_SYS, ERR_FORK, errno ) ;
00295           DisplayLog( <span class="stringliteral">"Could nout start nfs daemon, exiting..."</span> ) ;
00296           exit( 1 ) ;
00297           
00298         <span class="keywordflow">case</span> 0:
00299           <span class="comment">/* This code is within the son (that will actually work)</span>
00300 <span class="comment">           * Let's make it the leader of its group of process */</span>
00301           <span class="keywordflow">if</span>( setsid() == -1 )
00302             {
00303               DisplayErrorLog( ERR_SYS, ERR_SETSID, errno ) ;
00304               DisplayLog( <span class="stringliteral">"Could nout start nfs daemon, exiting..."</span> ) ;
00305               exit( 1 ) ;
00306             }
00307           break ;
00308 
00309         <span class="keywordflow">default</span>:
00310           <span class="comment">/* This code is within the father, it is useless, it must die */</span>
00311           DisplayLog( <span class="stringliteral">"Starting a son of pid %d\n"</span>, son_pid ) ;
00312           exit( 0 ) ;
00313           break ;
00314         }
00315     }
00316     
00317     DisplayLog( <span class="stringliteral">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Starting GANESHA NFS Daemon on FSAL/%s &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;"</span>, FSAL_GetFSName() ) ;
00318     
00319     <span class="comment">/* Set the signal handler */</span>
00320     memset( &amp;act_sigusr1, 0, <span class="keyword">sizeof</span>( act_sigusr1 ) ) ;
00321     act_sigusr1.sa_flags = 0 ;
00322     act_sigusr1.sa_handler = action_sigusr1 ;
00323     <span class="keywordflow">if</span>( sigaction( SIGUSR1, &amp;act_sigusr1, NULL ) == -1 )
00324     {
00325         DisplayErrorLog( ERR_SYS, ERR_SIGACTION, errno ) ;
00326         exit( 1 ) ;
00327     }
00328     <span class="keywordflow">else</span>
00329         DisplayLogLevel( NIV_EVENT, <span class="stringliteral">"Signal SIGUSR1 (force flush) is ready to be used"</span> ) ;
00330         
00331     
00332     <span class="comment">/* initialize default parameters */</span>
00333     
00334     <span class="keywordflow">if</span>( <a class="code" href="nfs__init_8h.html#a3">nfs_set_param_default</a>( &amp;<a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a> ) )
00335     {
00336         DisplayLog( <span class="stringliteral">"NFS MAIN: Error setting default parameters."</span> );
00337         exit(1);
00338     }
00339         
00340     <span class="comment">/* parse configuration file */</span>
00341     
00342     <span class="keywordflow">if</span>( <a class="code" href="nfs__init_8h.html#a4">nfs_set_param_from_conf</a>( &amp;<a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>, &amp;<a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a>, <a class="code" href="fuse__binding_8c.html#a1">config_path</a> ) )
00343     {
00344       DisplayLog( <span class="stringliteral">"NFS MAIN: Error parsing configuration file."</span> ) ;
00345       exit(1);
00346     }
00347 
00348     <span class="comment">/* check parameters consitency */</span>
00349     
00350     <span class="keywordflow">if</span>( <a class="code" href="nfs__init_8h.html#a5">nfs_check_param_consistency</a>( &amp;<a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a> ) )
00351     {
00352         DisplayLog( <span class="stringliteral">"NFS MAIN: Inconsistent parameters found"</span> ) ;
00353         DisplayLog( <span class="stringliteral">"MAJOR WARNING: /!\\ | Bad Parameters could have significant impact on the daemon behavior"</span> ) ;
00354         exit(1);
00355     }
00356     
00357     <span class="comment">/* Everything seems to be OK! We can now start service threads */</span>
00358     <a class="code" href="nfs__init_8h.html#a6">nfs_start</a>( &amp;<a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>, &amp;<a class="code" href="fuse__binding_8c.html#a0">nfs_start_info</a> );
00359     
00360     <span class="keywordflow">return</span> 0;    
00361     
00362 }
00363    
00364 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:26 2008 for Daemon Main by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
