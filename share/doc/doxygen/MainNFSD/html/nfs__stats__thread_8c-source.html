<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Daemon Main: nfs_stats_thread.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>nfs_stats_thread.c</h1><a href="nfs__stats__thread_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8: </span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * Ce logiciel est un serveur implementant le protocole NFS.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * Ce logiciel est régi par la licence CeCILL soumise au droit français et</span>
00011 <span class="comment"> * respectant les principes de diffusion des logiciels libres. Vous pouvez</span>
00012 <span class="comment"> * utiliser, modifier et/ou redistribuer ce programme sous les conditions</span>
00013 <span class="comment"> * de la licence CeCILL telle que diffusée par le CEA, le CNRS et l'INRIA</span>
00014 <span class="comment"> * sur le site "http://www.cecill.info".</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> * En contrepartie de l'accessibilité au code source et des droits de copie,</span>
00017 <span class="comment"> * de modification et de redistribution accordés par cette licence, il n'est</span>
00018 <span class="comment"> * offert aux utilisateurs qu'une garantie limitée.  Pour les mêmes raisons,</span>
00019 <span class="comment"> * seule une responsabilité restreinte pèse sur l'auteur du programme,  le</span>
00020 <span class="comment"> * titulaire des droits patrimoniaux et les concédants successifs.</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> * A cet égard  l'attention de l'utilisateur est attirée sur les risques</span>
00023 <span class="comment"> * associés au chargement,  à l'utilisation,  à la modification et/ou au</span>
00024 <span class="comment"> * développement et à la reproduction du logiciel par l'utilisateur étant</span>
00025 <span class="comment"> * donné sa spécificité de logiciel libre, qui peut le rendre complexe à</span>
00026 <span class="comment"> * manipuler et qui le réserve donc à des développeurs et des professionnels</span>
00027 <span class="comment"> * avertis possédant  des  connaissances  informatiques approfondies.  Les</span>
00028 <span class="comment"> * utilisateurs sont donc invités à charger  et  tester  l'adéquation  du</span>
00029 <span class="comment"> * logiciel à leurs besoins dans des conditions permettant d'assurer la</span>
00030 <span class="comment"> * sécurité de leurs systèmes et ou de leurs données et, plus généralement,</span>
00031 <span class="comment"> * à l'utiliser et l'exploiter dans les mêmes conditions de sécurité.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> * Le fait que vous puissiez accéder à cet en-tête signifie que vous avez</span>
00034 <span class="comment"> * pris connaissance de la licence CeCILL, et que vous en avez accepté les</span>
00035 <span class="comment"> * termes.</span>
00036 <span class="comment"> *</span>
00037 <span class="comment"> * ---------------------</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> * Copyright CEA/DAM/DIF (2005)</span>
00040 <span class="comment"> *  Contributor: Philippe DENIEL  philippe.deniel@cea.fr</span>
00041 <span class="comment"> *               Thomas LEIBOVICI thomas.leibovici@cea.fr</span>
00042 <span class="comment"> *</span>
00043 <span class="comment"> *</span>
00044 <span class="comment"> * This software is a server that implements the NFS protocol.</span>
00045 <span class="comment"> * </span>
00046 <span class="comment"> *</span>
00047 <span class="comment"> * This software is governed by the CeCILL  license under French law and</span>
00048 <span class="comment"> * abiding by the rules of distribution of free software.  You can  use,</span>
00049 <span class="comment"> * modify and/ or redistribute the software under the terms of the CeCILL</span>
00050 <span class="comment"> * license as circulated by CEA, CNRS and INRIA at the following URL</span>
00051 <span class="comment"> * "http://www.cecill.info".</span>
00052 <span class="comment"> *</span>
00053 <span class="comment"> * As a counterpart to the access to the source code and  rights to copy,</span>
00054 <span class="comment"> * modify and redistribute granted by the license, users are provided only</span>
00055 <span class="comment"> * with a limited warranty  and the software's author,  the holder of the</span>
00056 <span class="comment"> * economic rights,  and the successive licensors  have only  limited</span>
00057 <span class="comment"> * liability.</span>
00058 <span class="comment"> *</span>
00059 <span class="comment"> * In this respect, the user's attention is drawn to the risks associated</span>
00060 <span class="comment"> * with loading,  using,  modifying and/or developing or reproducing the</span>
00061 <span class="comment"> * software by the user in light of its specific status of free software,</span>
00062 <span class="comment"> * that may mean  that it is complicated to manipulate,  and  that  also</span>
00063 <span class="comment"> therefore means  that it is reserved for developers  and  experienced</span>
00064 <span class="comment"> * professionals having in-depth computer knowledge. Users are therefore</span>
00065 <span class="comment"> * encouraged to load and test the software's suitability as regards their</span>
00066 <span class="comment"> * requirements in conditions enabling the security of their systems and/or</span>
00067 <span class="comment"> * data to be ensured and,  more generally, to use and operate it in the</span>
00068 <span class="comment"> * same conditions as regards security.</span>
00069 <span class="comment"> *</span>
00070 <span class="comment"> * The fact that you are presently reading this means that you have had</span>
00071 <span class="comment"> * knowledge of the CeCILL license and that you accept its terms.</span>
00072 <span class="comment"> * ---------------------------------------</span>
00073 <span class="comment"> */</span>
00074 
00086 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00088 <span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
00090 
00091 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00092 <span class="preprocessor">#include &lt;string.h&gt;</span>
00093 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00094 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00095 <span class="preprocessor">#include &lt;time.h&gt;</span>
00096 <span class="preprocessor">#include "nfs_core.h"</span> 
00097 <span class="preprocessor">#include "nfs_stat.h"</span>
00098 <span class="preprocessor">#include "nfs_exports.h"</span>
00099 
00100 <span class="keyword">extern</span> nfs_parameter_t      nfs_param ;
00101 <span class="keyword">extern</span> time_t               ServerBootTime ;
00102 <span class="keyword">extern</span> hash_table_t       * <a class="code" href="nfs__init_8c.html#a5">ht_ip_stats</a>[NB_MAX_WORKER_THREAD] ;
00103 
<a name="l00104"></a><a class="code" href="nfs__stats__thread_8c.html#a3">00104</a> <span class="keywordtype">void</span> * <a class="code" href="nfs__stats__thread_8c.html#a3">stats_thread</a>( <span class="keywordtype">void</span> * addr )
00105 {
00106   <span class="keywordtype">int</span>                  rc ;
00107   FILE               * stats_file ;
00108   <span class="keyword">struct </span>stat          statref ;
00109   <span class="keyword">struct </span>stat          stattest ;
00110   time_t               current_time ;
00111   <span class="keyword">struct </span>tm            current_time_struct ;
00112   <span class="keyword">struct </span>tm            boot_time_struct ;
00113   <span class="keywordtype">char</span>                 strdate[1024] ;
00114   <span class="keywordtype">char</span>                 strbootdate[1024] ;
00115   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>         i ;
00116   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>         j ;
00117   <span class="keywordtype">int</span>                  reopen_stats = FALSE ;
00118   nfs_worker_data_t  * <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a> = addr ;
00119   
00120   cache_inode_stat_t   global_cache_inode_stat ;
00121   nfs_worker_stat_t    global_worker_stat ;
00122   hash_stat_t          hstat   ;
00123   hash_stat_t          hstat_reverse ;
00124   
00125   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>   total_fsal_calls;
00126   fsal_statistics_t    global_fsal_stat;
00127  
00128   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>          min_pending_request ;
00129   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>          max_pending_request ; 
00130   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>          total_pending_request ;
00131   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>          average_pending_request ;
00132   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>          len_pending_request = 0 ; 
00133  
00134 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00135 <span class="preprocessor"></span>  buddy_stats_t        global_buddy_stat;
00136 <span class="preprocessor">#endif  </span>
00137 <span class="preprocessor"></span>
00138   SetNameFunction( <span class="stringliteral">"stat_thr"</span> ) ;
00139 
00140   
00141 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00142 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ( ( rc = BuddyInit( NULL )) != BUDDY_SUCCESS )
00143     {
00144       <span class="comment">/* Failed init */</span>
00145       DisplayLog( <span class="stringliteral">"NFS STATS : Memory manager could not be initialized, exiting..."</span> ) ;
00146       exit( 1 ) ;
00147     }
00148   DisplayLog( <span class="stringliteral">"NFS STATS : Memory manager successfully initialized"</span> ) ;
00149 <span class="preprocessor">#endif</span>
00150 <span class="preprocessor"></span>
00151   <span class="comment">/* Open the stats file, in append mode */</span>
00152   <span class="keywordflow">if</span>( ( stats_file = fopen( <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.stats_file_path, <span class="stringliteral">"a"</span> ) ) == NULL )
00153     {
00154       DisplayLog( <span class="stringliteral">"NFS STATS : Could not open stats file %s, no stats will be made..."</span>, 
00155                   <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.stats_file_path ) ;
00156       <span class="keywordflow">return</span> NULL ;
00157     }
00158 
00159   <span class="keywordflow">if</span>( stat( <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.stats_file_path, &amp;statref ) != 0 )
00160     {
00161       DisplayLog( <span class="stringliteral">"NFS STATS : Could not get inode for %s, no stats will be made..."</span>, 
00162                   <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.stats_file_path ) ;
00163       <span class="keywordflow">return</span> NULL ;
00164     }
00165   
00166 <span class="preprocessor">#ifdef _SNMP_ADM_ACTIVE</span>
00167 <span class="preprocessor"></span>  <span class="comment">/* start snmp library */</span>
00168   <span class="keywordflow">if</span>( <a class="code" href="nfs__stats__snmp_8c.html#a40">stats_snmp</a>(<a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>) == 0 )
00169      DisplayLog( <span class="stringliteral">"NFS STATS: SNMP stats service was started successfully"</span> ) ;
00170 <span class="preprocessor">#endif </span><span class="comment">/*_SNMP_ADM_ACTIVE*/</span>
00171   
00172   <span class="keywordflow">while</span>( 1 )
00173     {
00174        <span class="comment">/* Initial wait */</span>
00175       sleep( <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.stats_update_delay ) ;
00176 
00177       <span class="comment">/* Debug trace */</span>
00178       DisplayLogLevel( NIV_EVENT, <span class="stringliteral">"NFS STATS : now dumping stats"</span> ) ;
00179 
00180       <span class="comment">/* Stats main loop */</span>
00181       <span class="keywordflow">if</span>( stat( <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.stats_file_path, &amp;stattest ) == 0 )
00182         {
00183            <span class="keywordflow">if</span>( stattest.st_ino != statref.st_ino )
00184              reopen_stats = TRUE ;
00185         }
00186       <span class="keywordflow">else</span>
00187         {
00188           <span class="keywordflow">if</span>( errno == ENOENT )
00189             reopen_stats = TRUE ;
00190         }
00191       
00192       <span class="comment">/* Check is file has changed (the inode number will be different) */</span>
00193       <span class="keywordflow">if</span>( reopen_stats == TRUE )
00194         {
00195           <span class="comment">/* Stats file has changed */</span>
00196           DisplayLog( <span class="stringliteral">"NFS STATS : stats file has changed or was removed, I close and reopen it"</span> ) ;
00197           fflush( stats_file ) ;
00198           fclose( stats_file ) ;
00199           <span class="keywordflow">if</span>( ( stats_file = fopen( <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.stats_file_path, <span class="stringliteral">"a"</span> ) ) == NULL )
00200             {
00201               DisplayLog( <span class="stringliteral">"NFS STATS : Could not open stats file %s, no further stats will be made..."</span>, 
00202                           <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.stats_file_path ) ;
00203               <span class="keywordflow">return</span> NULL ;
00204             }
00205           statref = stattest ;
00206           reopen_stats = FALSE ;
00207         }
00208           
00209       <span class="comment">/* Get the current epoch time */</span>
00210       current_time = time( NULL ) ;
00211       memcpy( &amp;current_time_struct, localtime( &amp;current_time ), <span class="keyword">sizeof</span>( current_time_struct ) ) ;
00212       snprintf( strdate, 1024, <span class="stringliteral">"%u, %.2d/%.2d/%.4d %.2d:%.2d:%.2d "</span>,
00213                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)current_time,
00214                 current_time_struct.tm_mday, 
00215                 current_time_struct.tm_mon+1, 
00216                 1900 + current_time_struct.tm_year, 
00217                 current_time_struct.tm_hour, 
00218                 current_time_struct.tm_min, 
00219                 current_time_struct.tm_sec ) ;
00220 
00221       <span class="comment">/* Printing the general Stats */</span>
00222       memcpy( &amp;boot_time_struct, localtime( &amp;<a class="code" href="nfs__init_8c.html#a1">ServerBootTime</a> ), <span class="keyword">sizeof</span>( boot_time_struct ) ) ;
00223       snprintf( strbootdate, 1024, <span class="stringliteral">"%u, %.2d/%.2d/%.4d %.2d:%.2d:%.2d "</span>,
00224                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="nfs__init_8c.html#a1">ServerBootTime</a>,
00225                 boot_time_struct.tm_mday,
00226                 boot_time_struct.tm_mon+1,
00227                 1900 + boot_time_struct.tm_year,
00228                 boot_time_struct.tm_hour,
00229                 boot_time_struct.tm_min,
00230                 boot_time_struct.tm_sec ) ;
00231 
00232       fprintf( stats_file, <span class="stringliteral">"NFS_SERVER_GENERAL,%s;%s\n"</span>,
00233                strdate,
00234                strbootdate ) ;
00235 
00236       <span class="comment">/* Zeroing the cache_stats */</span>
00237       global_cache_inode_stat.nb_gc_lru_active = 0 ;
00238       global_cache_inode_stat.nb_gc_lru_total  = 0 ;
00239       global_cache_inode_stat.nb_call_total  = 0 ;
00240 
00241       memset( global_cache_inode_stat.func_stats.nb_err_unrecover, 0, <span class="keyword">sizeof</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ) * CACHE_INODE_NB_COMMAND ) ;
00242 
00243       <span class="comment">/* Merging the cache inode stats for every thread */</span>
00244       <span class="keywordflow">for</span>( i = 0 ; i &lt; <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.nb_worker ; i++ )
00245         {
00246           global_cache_inode_stat.nb_gc_lru_active += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.nb_gc_lru_active ;
00247           global_cache_inode_stat.nb_gc_lru_total  += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.nb_gc_lru_total ;
00248           global_cache_inode_stat.nb_call_total    += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.nb_call_total ;
00249           
00250           <span class="keywordflow">for</span>( j = 0 ; j &lt; CACHE_INODE_NB_COMMAND ; j++ )
00251             {
00252               <span class="keywordflow">if</span>( i == 0 )
00253                 {
00254                   global_cache_inode_stat.func_stats.nb_success[j]       = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.func_stats.nb_success[j] ;
00255                   global_cache_inode_stat.func_stats.nb_call[j]          = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.func_stats.nb_call[j] ;
00256                   global_cache_inode_stat.func_stats.nb_err_retryable[j] = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.func_stats.nb_err_retryable[j] ;
00257                   global_cache_inode_stat.func_stats.nb_err_unrecover[j] = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.func_stats.nb_err_unrecover[j] ;
00258                 }
00259               <span class="keywordflow">else</span>
00260                 {
00261                   global_cache_inode_stat.func_stats.nb_success[j]       += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.func_stats.nb_success[j] ;
00262                   global_cache_inode_stat.func_stats.nb_call[j]          += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.func_stats.nb_call[j] ;
00263                   global_cache_inode_stat.func_stats.nb_err_retryable[j] += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.func_stats.nb_err_retryable[j] ;
00264                   global_cache_inode_stat.func_stats.nb_err_unrecover[j] += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].cache_inode_client.stat.func_stats.nb_err_unrecover[j] ;
00265                 }
00266               
00267             }
00268         }
00269       
00270       <span class="comment">/* Printing the cache_inode stat */</span>
00271       fprintf( stats_file, <span class="stringliteral">"CACHE_INODE_CALLS,%s;%u,%u,%u"</span>, 
00272                strdate,
00273                global_cache_inode_stat.nb_call_total, 
00274                global_cache_inode_stat.nb_gc_lru_total,
00275                global_cache_inode_stat.nb_gc_lru_active ) ;
00276 
00277       <span class="keywordflow">for</span>( j = 0 ; j &lt; CACHE_INODE_NB_COMMAND ; j++ )
00278         fprintf( stats_file, <span class="stringliteral">"|%u,%u,%u,%u"</span>, 
00279                  global_cache_inode_stat.func_stats.nb_call[j], 
00280                  global_cache_inode_stat.func_stats.nb_success[j],
00281                  global_cache_inode_stat.func_stats.nb_err_retryable[j],
00282                  global_cache_inode_stat.func_stats.nb_err_unrecover[j] ) ;
00283       fprintf( stats_file, <span class="stringliteral">"\n"</span> ) ;
00284 
00285       <span class="comment">/* Pinting the cache inode hash stat */</span>
00286       <span class="comment">/* This is done only on worker[0]: the hashtable is shared and worker 0 always exists */</span>
00287       HashTable_GetStats( <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[0].ht, &amp;hstat ) ;
00288      
00289       fprintf( stats_file, <span class="stringliteral">"CACHE_INODE_HASH,%s;%u,%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u\n"</span>,
00290                strdate,
00291                hstat.dynamic.nb_entries, 
00292                hstat.computed.min_rbt_num_node,
00293                hstat.computed.max_rbt_num_node,
00294                hstat.computed.average_rbt_num_node,
00295                hstat.dynamic.ok.nb_set,
00296                hstat.dynamic.notfound.nb_set,
00297                hstat.dynamic.err.nb_set,
00298                hstat.dynamic.ok.nb_test,
00299                hstat.dynamic.notfound.nb_test,
00300                hstat.dynamic.err.nb_test,
00301                hstat.dynamic.ok.nb_get,
00302                hstat.dynamic.notfound.nb_get,
00303                hstat.dynamic.err.nb_get,
00304                hstat.dynamic.ok.nb_del,
00305                hstat.dynamic.notfound.nb_del,
00306                hstat.dynamic.err.nb_del );
00307 
00308       <span class="comment">/* Merging the NFS protocols stats together */</span>
00309       global_worker_stat.nb_total_req         = 0 ;
00310       global_worker_stat.nb_udp_req           = 0 ;
00311       global_worker_stat.nb_tcp_req           = 0 ;
00312       global_worker_stat.stat_req.nb_mnt1_req = 0 ;
00313       global_worker_stat.stat_req.nb_mnt3_req = 0 ;
00314       global_worker_stat.stat_req.nb_nfs2_req = 0 ;
00315       global_worker_stat.stat_req.nb_nfs3_req = 0 ;
00316       global_worker_stat.stat_req.nb_nfs4_req = 0 ;
00317 
00318       <span class="comment">/* prepare for computing pending request stats */</span>
00319       min_pending_request     = 10000000 ;
00320       max_pending_request     = 0 ;
00321       total_pending_request   = 0 ;
00322       average_pending_request = 0 ;
00323       len_pending_request     = 0 ;
00324 
00325       <span class="keywordflow">for</span>( i = 0 ; i &lt; <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.nb_worker ; i++ )
00326         {
00327           global_worker_stat.nb_total_req         += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.nb_total_req ;
00328           global_worker_stat.nb_udp_req           += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.nb_udp_req ;
00329           global_worker_stat.nb_tcp_req           += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.nb_tcp_req ;
00330           global_worker_stat.stat_req.nb_mnt1_req += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.nb_mnt1_req ;
00331           global_worker_stat.stat_req.nb_mnt3_req += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.nb_mnt3_req ;
00332           global_worker_stat.stat_req.nb_nfs2_req += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.nb_nfs2_req ;
00333           global_worker_stat.stat_req.nb_nfs3_req += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.nb_nfs3_req ;
00334           global_worker_stat.stat_req.nb_nfs4_req += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.nb_nfs4_req ;
00335 
00336           <span class="keywordflow">for</span>( j = 0 ; j &lt; MNT_V1_NB_COMMAND ; j++ )
00337             {
00338               <span class="keywordflow">if</span>( i == 0 )
00339                 {
00340                   global_worker_stat.stat_req.stat_req_mnt1[j].total   = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt1[j].total ;
00341                   global_worker_stat.stat_req.stat_req_mnt1[j].success = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt1[j].success ;
00342                   global_worker_stat.stat_req.stat_req_mnt1[j].dropped = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt1[j].dropped ;
00343                 }
00344               <span class="keywordflow">else</span>
00345                 {
00346                   global_worker_stat.stat_req.stat_req_mnt1[j].total   += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt1[j].total ;
00347                   global_worker_stat.stat_req.stat_req_mnt1[j].success += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt1[j].success ;
00348                   global_worker_stat.stat_req.stat_req_mnt1[j].dropped += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt1[j].dropped ;
00349                 }
00350             }
00351          
00352           <span class="keywordflow">for</span>( j = 0 ; j &lt; MNT_V3_NB_COMMAND ; j++ )
00353             {
00354                <span class="keywordflow">if</span>( i == 0 )
00355                 {
00356                   global_worker_stat.stat_req.stat_req_mnt3[j].total   = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt3[j].total ;
00357                   global_worker_stat.stat_req.stat_req_mnt3[j].success = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt3[j].success ;
00358                   global_worker_stat.stat_req.stat_req_mnt3[j].dropped = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt3[j].dropped ;
00359                 }
00360                <span class="keywordflow">else</span>
00361                  {
00362                    global_worker_stat.stat_req.stat_req_mnt3[j].total   += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt3[j].total ;
00363                    global_worker_stat.stat_req.stat_req_mnt3[j].success += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt3[j].success ;
00364                    global_worker_stat.stat_req.stat_req_mnt3[j].dropped += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_mnt3[j].dropped ;
00365                  }  
00366             }
00367           
00368           <span class="keywordflow">for</span>( j = 0 ; j &lt; NFS_V2_NB_COMMAND ; j++ )
00369             {
00370                <span class="keywordflow">if</span>( i == 0 )
00371                 {
00372                   global_worker_stat.stat_req.stat_req_nfs2[j].total   = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs2[j].total ;
00373                   global_worker_stat.stat_req.stat_req_nfs2[j].success = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs2[j].success ;
00374                   global_worker_stat.stat_req.stat_req_nfs2[j].dropped = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs2[j].dropped ;
00375                 }
00376                <span class="keywordflow">else</span>
00377                  {
00378                    global_worker_stat.stat_req.stat_req_nfs2[j].total   += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs2[j].total ;
00379                    global_worker_stat.stat_req.stat_req_nfs2[j].success += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs2[j].success ;
00380                    global_worker_stat.stat_req.stat_req_nfs2[j].dropped += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs2[j].dropped ;
00381                  }
00382             }
00383           
00384 
00385           <span class="keywordflow">for</span>( j = 0 ; j &lt; NFS_V3_NB_COMMAND ; j++ )
00386             { 
00387               <span class="keywordflow">if</span>( i == 0 )
00388                 {
00389                   global_worker_stat.stat_req.stat_req_nfs3[j].total   = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs3[j].total ;
00390                   global_worker_stat.stat_req.stat_req_nfs3[j].success = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs3[j].success ;
00391                   global_worker_stat.stat_req.stat_req_nfs3[j].dropped = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs3[j].dropped ;
00392                 }
00393               <span class="keywordflow">else</span>
00394                 {
00395                   global_worker_stat.stat_req.stat_req_nfs3[j].total   += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs3[j].total ;
00396                   global_worker_stat.stat_req.stat_req_nfs3[j].success += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs3[j].success ;
00397                   global_worker_stat.stat_req.stat_req_nfs3[j].dropped += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs3[j].dropped ;
00398                 }
00399             }
00400           
00401           <span class="keywordflow">for</span>( j = 0 ; j &lt; NFS_V4_NB_COMMAND ; j++ )
00402             {
00403               <span class="keywordflow">if</span>( i == 0 )
00404                 {
00405                   global_worker_stat.stat_req.stat_req_nfs4[j].total   = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs4[j].total ;
00406                   global_worker_stat.stat_req.stat_req_nfs4[j].success = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs4[j].success ;
00407                   global_worker_stat.stat_req.stat_req_nfs4[j].dropped = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs4[j].dropped ;
00408                 }
00409               <span class="keywordflow">else</span>
00410                 {
00411                   global_worker_stat.stat_req.stat_req_nfs4[j].total   += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs4[j].total ;
00412                   global_worker_stat.stat_req.stat_req_nfs4[j].success += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs4[j].success ;
00413                   global_worker_stat.stat_req.stat_req_nfs4[j].dropped += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.stat_req.stat_req_nfs4[j].dropped ;
00414                 }
00415             }
00416          
00417            <span class="comment">/* Computing the pending request stats */</span>
00418           len_pending_request = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].pending_request-&gt;nb_entry - <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].pending_request-&gt;nb_invalid ;
00419 
00420           <span class="keywordflow">if</span>( len_pending_request &lt; min_pending_request ) 
00421                 min_pending_request = len_pending_request ;
00422  
00423           <span class="keywordflow">if</span>( len_pending_request &gt; max_pending_request ) 
00424                 max_pending_request = len_pending_request ;
00425 
00426           total_pending_request += len_pending_request ;
00427         } <span class="comment">/* for( i = 0 ; i &lt; nfs_param.core_param.nb_worker ; i++ ) */</span>
00428 
00429       <span class="comment">/* Compute average pending request */</span>
00430       average_pending_request = total_pending_request / <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.nb_worker ;
00431 
00432       fprintf( stats_file, <span class="stringliteral">"NFS/MOUNT STATISTICS,%s;%u,%u,%u|%u,%u,%u,%u,%u|%u,%u,%u,%u\n"</span>, 
00433                strdate, 
00434                global_worker_stat.nb_total_req,
00435                global_worker_stat.nb_udp_req,
00436                global_worker_stat.nb_tcp_req,
00437                global_worker_stat.stat_req.nb_mnt1_req,
00438                global_worker_stat.stat_req.nb_mnt3_req,
00439                global_worker_stat.stat_req.nb_nfs2_req,
00440                global_worker_stat.stat_req.nb_nfs3_req,
00441                global_worker_stat.stat_req.nb_nfs4_req,
00442                total_pending_request,   
00443                min_pending_request, 
00444                max_pending_request, 
00445                average_pending_request );
00446       
00447       fprintf( stats_file, <span class="stringliteral">"MNT V1 REQUEST,%s;%u"</span>, strdate, global_worker_stat.stat_req.nb_mnt1_req ) ;
00448       <span class="keywordflow">for</span>( j = 0 ; j &lt; MNT_V1_NB_COMMAND ; j++ )
00449         fprintf( stats_file, <span class="stringliteral">"|%u,%u,%u"</span>, 
00450                  global_worker_stat.stat_req.stat_req_mnt1[j].total,
00451                  global_worker_stat.stat_req.stat_req_mnt1[j].success,
00452                  global_worker_stat.stat_req.stat_req_mnt1[j].dropped ) ;
00453       fprintf( stats_file, <span class="stringliteral">"\n"</span> ) ;
00454 
00455       fprintf( stats_file, <span class="stringliteral">"MNT V3 REQUEST,%s;%u"</span>, strdate, global_worker_stat.stat_req.nb_mnt3_req ) ;
00456       <span class="keywordflow">for</span>( j = 0 ; j &lt; MNT_V3_NB_COMMAND ; j++ )
00457         fprintf( stats_file, <span class="stringliteral">"|%u,%u,%u"</span>, 
00458                  global_worker_stat.stat_req.stat_req_mnt3[j].total,
00459                  global_worker_stat.stat_req.stat_req_mnt3[j].success,
00460                  global_worker_stat.stat_req.stat_req_mnt3[j].dropped ) ; 
00461       fprintf( stats_file, <span class="stringliteral">"\n"</span> ) ;
00462 
00463       fprintf( stats_file, <span class="stringliteral">"NFS V2 REQUEST,%s;%u"</span>, strdate, global_worker_stat.stat_req.nb_nfs2_req ) ;
00464       <span class="keywordflow">for</span>( j = 0 ; j &lt; NFS_V2_NB_COMMAND ; j++ )
00465         fprintf( stats_file, <span class="stringliteral">"|%u,%u,%u"</span>, 
00466                  global_worker_stat.stat_req.stat_req_nfs2[j].total,
00467                  global_worker_stat.stat_req.stat_req_nfs2[j].success,
00468                  global_worker_stat.stat_req.stat_req_nfs2[j].dropped ) ;
00469       fprintf( stats_file, <span class="stringliteral">"\n"</span> ) ;
00470 
00471       fprintf( stats_file, <span class="stringliteral">"NFS V3 REQUEST,%s;%u"</span>, strdate, global_worker_stat.stat_req.nb_nfs3_req ) ;
00472       <span class="keywordflow">for</span>( j = 0 ; j &lt; NFS_V3_NB_COMMAND ; j++ )
00473         fprintf( stats_file, <span class="stringliteral">"|%u,%u,%u"</span>, 
00474                  global_worker_stat.stat_req.stat_req_nfs3[j].total,
00475                  global_worker_stat.stat_req.stat_req_nfs3[j].success,
00476                  global_worker_stat.stat_req.stat_req_nfs3[j].dropped ) ;
00477       fprintf( stats_file, <span class="stringliteral">"\n"</span> ) ;
00478 
00479       fprintf( stats_file, <span class="stringliteral">"NFS V4 REQUEST,%s;%u"</span>, strdate, global_worker_stat.stat_req.nb_nfs4_req ) ;
00480       <span class="keywordflow">for</span>( j = 0 ; j &lt; NFS_V4_NB_COMMAND ; j++ )
00481         fprintf( stats_file, <span class="stringliteral">"|%u,%u,%u"</span>, 
00482                  global_worker_stat.stat_req.stat_req_nfs4[j].total,
00483                  global_worker_stat.stat_req.stat_req_nfs4[j].success,
00484                  global_worker_stat.stat_req.stat_req_nfs4[j].dropped ) ;
00485       fprintf( stats_file, <span class="stringliteral">"\n"</span> ) ;
00486 
00487             
00488       <span class="comment">/* Printing the cache inode hash stat */</span>
00489       <a class="code" href="nfs__dupreq_8c.html#a18">nfs_dupreq_get_stats</a>( &amp;hstat ) ;
00490       
00491       fprintf( stats_file, <span class="stringliteral">"DUP_REQ_HASH,%s;%u,%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u\n"</span>,
00492                strdate,
00493                hstat.dynamic.nb_entries, 
00494                hstat.computed.min_rbt_num_node,
00495                hstat.computed.max_rbt_num_node,
00496                hstat.computed.average_rbt_num_node, 
00497                hstat.dynamic.ok.nb_set,
00498                hstat.dynamic.notfound.nb_set,
00499                hstat.dynamic.err.nb_set,
00500                hstat.dynamic.ok.nb_test,
00501                hstat.dynamic.notfound.nb_test,
00502                hstat.dynamic.err.nb_test,
00503                hstat.dynamic.ok.nb_get,
00504                hstat.dynamic.notfound.nb_get,
00505                hstat.dynamic.err.nb_get,
00506                hstat.dynamic.ok.nb_del,
00507                hstat.dynamic.notfound.nb_del,
00508                hstat.dynamic.err.nb_del ) ;
00509 
00510       <span class="comment">/* Printing the UIDMAP_TYPE hash table stats */</span>
00511       idmap_get_stats( UIDMAP_TYPE, &amp;hstat, &amp;hstat_reverse ) ;
00512       fprintf( stats_file, <span class="stringliteral">"UIDMAP_HASH,%s;%u,%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u\n"</span>,
00513                strdate,
00514                hstat.dynamic.nb_entries,
00515                hstat.computed.min_rbt_num_node,
00516                hstat.computed.max_rbt_num_node,
00517                hstat.computed.average_rbt_num_node,
00518                hstat.dynamic.ok.nb_set,
00519                hstat.dynamic.notfound.nb_set,
00520                hstat.dynamic.err.nb_set,
00521                hstat.dynamic.ok.nb_test,
00522                hstat.dynamic.notfound.nb_test,
00523                hstat.dynamic.err.nb_test,
00524                hstat.dynamic.ok.nb_get,
00525                hstat.dynamic.notfound.nb_get,
00526                hstat.dynamic.err.nb_get,
00527                hstat.dynamic.ok.nb_del,
00528                hstat.dynamic.notfound.nb_del,
00529                hstat.dynamic.err.nb_del ) ;
00530       fprintf( stats_file, <span class="stringliteral">"UNAMEMAP_HASH,%s;%u,%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u\n"</span>,
00531                strdate,
00532                hstat_reverse.dynamic.nb_entries,
00533                hstat_reverse.computed.min_rbt_num_node,
00534                hstat_reverse.computed.max_rbt_num_node,
00535                hstat_reverse.computed.average_rbt_num_node,
00536                hstat_reverse.dynamic.ok.nb_set,
00537                hstat_reverse.dynamic.notfound.nb_set,
00538                hstat_reverse.dynamic.err.nb_set,
00539                hstat_reverse.dynamic.ok.nb_test,
00540                hstat_reverse.dynamic.notfound.nb_test,
00541                hstat_reverse.dynamic.err.nb_test,
00542                hstat_reverse.dynamic.ok.nb_get,
00543                hstat_reverse.dynamic.notfound.nb_get,
00544                hstat_reverse.dynamic.err.nb_get,
00545                hstat_reverse.dynamic.ok.nb_del,
00546                hstat_reverse.dynamic.notfound.nb_del,
00547                hstat_reverse.dynamic.err.nb_del ) ;
00548 
00549       <span class="comment">/* Printing the GIDMAP_TYPE hash table stats */</span>
00550       idmap_get_stats( GIDMAP_TYPE, &amp;hstat, &amp;hstat_reverse ) ;
00551       fprintf( stats_file, <span class="stringliteral">"GIDMAP_HASH,%s;%u,%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u\n"</span>,
00552                strdate,
00553                hstat.dynamic.nb_entries,
00554                hstat.computed.min_rbt_num_node,
00555                hstat.computed.max_rbt_num_node,
00556                hstat.computed.average_rbt_num_node,
00557                hstat.dynamic.ok.nb_set,
00558                hstat.dynamic.notfound.nb_set,
00559                hstat.dynamic.err.nb_set,
00560                hstat.dynamic.ok.nb_test,
00561                hstat.dynamic.notfound.nb_test,
00562                hstat.dynamic.err.nb_test,
00563                hstat.dynamic.ok.nb_get,
00564                hstat.dynamic.notfound.nb_get,
00565                hstat.dynamic.err.nb_get,
00566                hstat.dynamic.ok.nb_del,
00567                hstat.dynamic.notfound.nb_del,
00568                hstat.dynamic.err.nb_del ) ;
00569       fprintf( stats_file, <span class="stringliteral">"GNAMEMAP_HASH,%s;%u,%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u\n"</span>,
00570                strdate,
00571                hstat_reverse.dynamic.nb_entries,
00572                hstat_reverse.computed.min_rbt_num_node,
00573                hstat_reverse.computed.max_rbt_num_node,
00574                hstat_reverse.computed.average_rbt_num_node,
00575                hstat_reverse.dynamic.ok.nb_set,
00576                hstat_reverse.dynamic.notfound.nb_set,
00577                hstat_reverse.dynamic.err.nb_set,
00578                hstat_reverse.dynamic.ok.nb_test,
00579                hstat_reverse.dynamic.notfound.nb_test,
00580                hstat_reverse.dynamic.err.nb_test,
00581                hstat_reverse.dynamic.ok.nb_get,
00582                hstat_reverse.dynamic.notfound.nb_get,
00583                hstat_reverse.dynamic.err.nb_get,
00584                hstat_reverse.dynamic.ok.nb_del,
00585                hstat_reverse.dynamic.notfound.nb_del,
00586                hstat_reverse.dynamic.err.nb_del ) ;
00587 
00588       <span class="comment">/* Stats for the IP/Name hashtable */</span>
00589       nfs_ip_name_get_stats( &amp;hstat ) ;
00590       fprintf( stats_file, <span class="stringliteral">"IP_NAME_HASH,%s;%u,%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u|%u,%u,%u\n"</span>,
00591                strdate,
00592                hstat_reverse.dynamic.nb_entries,
00593                hstat_reverse.computed.min_rbt_num_node,
00594                hstat_reverse.computed.max_rbt_num_node,
00595                hstat_reverse.computed.average_rbt_num_node,
00596                hstat_reverse.dynamic.ok.nb_set,
00597                hstat_reverse.dynamic.notfound.nb_set,
00598                hstat_reverse.dynamic.err.nb_set,
00599                hstat_reverse.dynamic.ok.nb_test,
00600                hstat_reverse.dynamic.notfound.nb_test,
00601                hstat_reverse.dynamic.err.nb_test,
00602                hstat_reverse.dynamic.ok.nb_get,
00603                hstat_reverse.dynamic.notfound.nb_get,
00604                hstat_reverse.dynamic.err.nb_get,
00605                hstat_reverse.dynamic.ok.nb_del,
00606                hstat_reverse.dynamic.notfound.nb_del,
00607                hstat_reverse.dynamic.err.nb_del ) ;
00608 
00609       <span class="comment">/* fsal statistics */</span>
00610       memset( &amp;global_fsal_stat, 0, <span class="keyword">sizeof</span>( fsal_statistics_t ));
00611       total_fsal_calls = 0;
00612       
00613       <span class="keywordflow">for</span>( i = 0 ; i &lt; <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.nb_worker ; i++ )
00614         {
00615           
00616           <span class="keywordflow">for</span>( j = 0 ; j &lt; FSAL_NB_FUNC ; j++ )
00617             {
00618               total_fsal_calls += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.fsal_stats.func_stats.nb_call[j];
00619               
00620               global_fsal_stat.func_stats.nb_call[j] += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.fsal_stats.func_stats.nb_call[j];
00621               global_fsal_stat.func_stats.nb_success[j] += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.fsal_stats.func_stats.nb_success[j];
00622               global_fsal_stat.func_stats.nb_err_retryable[j] += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.fsal_stats.func_stats.nb_err_retryable[j];
00623               global_fsal_stat.func_stats.nb_err_unrecover[j] += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.fsal_stats.func_stats.nb_err_unrecover[j];
00624             }
00625             
00626         }
00627       
00628       
00629       fprintf( stats_file, <span class="stringliteral">"FSAL_CALLS,%s;%llu"</span>, strdate, total_fsal_calls ) ;
00630       <span class="keywordflow">for</span>( j = 0 ; j &lt; FSAL_NB_FUNC ; j++ )
00631         fprintf( stats_file, <span class="stringliteral">"|%u,%u,%u,%u"</span>, 
00632                  global_fsal_stat.func_stats.nb_call[j],
00633                  global_fsal_stat.func_stats.nb_success[j],
00634                  global_fsal_stat.func_stats.nb_err_retryable[j],
00635                  global_fsal_stat.func_stats.nb_err_unrecover[j] ) ;
00636       fprintf( stats_file, <span class="stringliteral">"\n"</span> ) ;
00637       
00638 
00639 
00640 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00641 <span class="preprocessor"></span>    
00642       <span class="comment">/* buddy memory */</span>
00643       
00644       memset( &amp;<a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>, 0, <span class="keyword">sizeof</span>( buddy_stats_t ));
00645       
00646       <span class="keywordflow">for</span>( i = 0 ; i &lt; <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.nb_worker ; i++ )
00647         {
00648           
00649           <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.TotalMemSpace += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.TotalMemSpace ;          
00650           <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.ExtraMemSpace += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.ExtraMemSpace ;          
00651           
00652           <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.StdMemSpace += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.StdMemSpace ;          
00653           <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.StdUsedSpace += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.StdUsedSpace ;
00654           
00655           <span class="keywordflow">if</span> ( <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.StdUsedSpace &gt; <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.WM_StdUsedSpace )
00656             <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.WM_StdUsedSpace = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.StdUsedSpace;
00657           
00658           <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.NbStdPages += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.NbStdPages ;
00659           <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.NbStdUsed += <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.NbStdUsed ;
00660           
00661           <span class="keywordflow">if</span> ( <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.NbStdUsed &gt; <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.WM_NbStdUsed )
00662             <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.WM_NbStdUsed = <a class="code" href="nfs__file__content__flush__thread_8c.html#a1">workers_data</a>[i].stats.buddy_stats.NbStdUsed;
00663           
00664         }
00665       
00666         <span class="comment">/* total memory space preallocated, total space preallocated for pages, total space that overflows pages */</span>
00667         <span class="comment">/* total memory, used memory, avg used memory/worker, max used memory/worker */</span>
00668         <span class="comment">/* total pages, used pages, avg used pages/worker, max used pages/worker */</span>
00669         
00670        fprintf( stats_file, <span class="stringliteral">"BUDDY_MEMORY,%s;%lu,%lu,%lu|%lu,%lu,%lu|%u,%u,%u,%u\n"</span>,
00671                 strdate,
00672                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.TotalMemSpace,
00673                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.StdMemSpace,
00674                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.ExtraMemSpace,
00675            
00676                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.StdUsedSpace,
00677                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(<a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.StdUsedSpace / <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.nb_worker),
00678                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.WM_StdUsedSpace,
00679            
00680                 <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.NbStdPages,
00681                 <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.NbStdUsed,
00682                 <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.NbStdUsed / <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.nb_worker,
00683                 <a class="code" href="nfs__stats__snmp_8c.html#a12">global_buddy_stat</a>.WM_NbStdUsed
00684                  );
00685                 
00686 
00687 <span class="preprocessor">#endif</span>
00688 <span class="preprocessor"></span>
00689       <span class="comment">/* Flush the data written */</span>
00690       fprintf( stats_file, <span class="stringliteral">"END, ----- NO MORE STATS FOR THIS PASS ----\n"</span> ) ;
00691       fflush( stats_file ) ;
00692 
00693       <span class="comment">/* Now managed IP stats dump */</span>
00694       nfs_ip_stats_dump(  <a class="code" href="nfs__init_8c.html#a5">ht_ip_stats</a>, 
00695                           <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.nb_worker, 
00696                           <a class="code" href="nfs__dupreq_8c.html#a0">nfs_param</a>.core_param.stats_per_client_directory  ) ;
00697 
00698     } <span class="comment">/* while ( 1 ) */</span>  
00699   
00700   <span class="keywordflow">return</span> NULL ;
00701 } <span class="comment">/* stats_thread */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:26 2008 for Daemon Main by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
