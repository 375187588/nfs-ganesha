<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_convert.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_convert.c</h1><a href="fsal__convert_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00015 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00017 <span class="preprocessor">#endif</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#include "fsal_convert.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00021 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00022 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00023 <span class="preprocessor">#include &lt;string.h&gt;</span>
00024 
00025 
00026 <span class="preprocessor">#define MAX_2( x, y )    ( (x) &gt; (y) ? (x) : (y) )</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#define MAX_3( x, y, z ) ( (x) &gt; (y) ? MAX_2((x),(z)) : MAX_2((y),(z)) )</span>
00028 <span class="preprocessor"></span>
00029 
<a name="l00041"></a><a class="code" href="fsal__convert_8c.html#a2">00041</a> <span class="keywordtype">int</span> <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(<span class="keywordtype">int</span> posix_errorcode){
00042   
00043   <span class="keywordflow">switch</span>(posix_errorcode){
00044     
00045     <span class="keywordflow">case</span> EPERM:
00046       <span class="keywordflow">return</span> ERR_FSAL_PERM;
00047     
00048     <span class="keywordflow">case</span> ENOENT:
00049       <span class="keywordflow">return</span> ERR_FSAL_NOENT;
00050     
00051     
00052     <span class="comment">/* connection error */</span>
00053 <span class="preprocessor">#ifdef _AIX_5</span>
00054 <span class="preprocessor"></span>    <span class="keywordflow">case</span> ENOCONNECT:
00055 <span class="preprocessor">#elif defined _LINUX</span>
00056 <span class="preprocessor"></span>    <span class="keywordflow">case</span> ECONNREFUSED:
00057     <span class="keywordflow">case</span> ECONNABORTED:
00058     <span class="keywordflow">case</span> ECONNRESET:
00059 <span class="preprocessor">#endif            </span>
00060 <span class="preprocessor"></span>      
00061     <span class="comment">/* IO error */</span>
00062     <span class="keywordflow">case</span> EIO:
00063       
00064     <span class="comment">/* too many open files */</span>
00065     <span class="keywordflow">case</span> ENFILE:
00066     <span class="keywordflow">case</span> EMFILE:
00067     
00068     <span class="comment">/* broken pipe */</span>
00069     <span class="keywordflow">case</span> EPIPE:
00070       
00071       <span class="comment">/* all shown as IO errors */</span>
00072       <span class="keywordflow">return</span> ERR_FSAL_IO;
00073       
00074     
00075     <span class="comment">/* no such device */</span>
00076     <span class="keywordflow">case</span> ENODEV :
00077     <span class="keywordflow">case</span> ENXIO:
00078       <span class="keywordflow">return</span> ERR_FSAL_NXIO;
00079     
00080     <span class="comment">/* invalid file descriptor : */</span>
00081     <span class="keywordflow">case</span> EBADF:
00082       <span class="comment">/* we suppose it was not opened... */</span>
00083       
00091       <span class="keywordflow">return</span> ERR_FSAL_NOT_OPENED ;
00092       
00093       
00094     <span class="keywordflow">case</span> ENOMEM:
00095       <span class="keywordflow">return</span> ERR_FSAL_NOMEM;
00096       
00097     <span class="keywordflow">case</span> EACCES:
00098       <span class="keywordflow">return</span> ERR_FSAL_ACCESS;
00099     
00100     <span class="keywordflow">case</span> EFAULT:
00101       <span class="keywordflow">return</span> ERR_FSAL_FAULT;
00102  
00103     <span class="keywordflow">case</span> EEXIST:
00104       <span class="keywordflow">return</span> ERR_FSAL_EXIST;
00105       
00106     <span class="keywordflow">case</span> EXDEV :
00107       <span class="keywordflow">return</span> ERR_FSAL_XDEV;
00108    
00109     <span class="keywordflow">case</span> ENOTDIR:
00110       <span class="keywordflow">return</span> ERR_FSAL_NOTDIR;
00111     
00112     <span class="keywordflow">case</span> EISDIR:
00113       <span class="keywordflow">return</span> ERR_FSAL_ISDIR;
00114       
00115     <span class="keywordflow">case</span> EINVAL:
00116       <span class="keywordflow">return</span> ERR_FSAL_INVAL;
00117     
00118     <span class="keywordflow">case</span> EFBIG:
00119       <span class="keywordflow">return</span> ERR_FSAL_FBIG;
00120       
00121     <span class="keywordflow">case</span> ENOSPC:
00122       <span class="keywordflow">return</span> ERR_FSAL_NOSPC;
00123       
00124     <span class="keywordflow">case</span> EMLINK:
00125       <span class="keywordflow">return</span> ERR_FSAL_MLINK;
00126     
00127     <span class="keywordflow">case</span> EDQUOT:
00128       <span class="keywordflow">return</span> ERR_FSAL_DQUOT;
00129     
00130     <span class="keywordflow">case</span> ENAMETOOLONG:
00131       <span class="keywordflow">return</span> ERR_FSAL_NAMETOOLONG;
00132 
00139 <span class="preprocessor">#ifdef _AIX</span>
00140 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 87:
00141 <span class="preprocessor">#else</span>
00142 <span class="preprocessor"></span>    <span class="keywordflow">case</span> ENOTEMPTY:
00143     <span class="keywordflow">case</span> -ENOTEMPTY:
00144 <span class="preprocessor">#endif      </span>
00145 <span class="preprocessor"></span>      <span class="keywordflow">return</span> ERR_FSAL_NOTEMPTY;      
00146       
00147     <span class="keywordflow">case</span> ESTALE:
00148       <span class="keywordflow">return</span> ERR_FSAL_STALE ;
00149           
00150     
00151     <span class="comment">/* Error code that needs a retry */</span>
00152     <span class="keywordflow">case</span> EAGAIN :
00153     <span class="keywordflow">case</span> EBUSY :
00154 
00155       <span class="keywordflow">return</span> ERR_FSAL_DELAY;
00156 
00157     <span class="keywordflow">default</span>:
00158       
00159       <span class="comment">/* other unexpected errors */</span>    
00160       <span class="keywordflow">return</span> ERR_FSAL_SERVERFAULT;
00161     
00162   }
00163   
00164 }
00165 
00166 
00167 
<a name="l00177"></a><a class="code" href="fsal__convert_8c.html#a3">00177</a> <span class="keywordtype">int</span>  <a class="code" href="fsal__convert_8c.html#a3">fsal2posix_testperm</a>(fsal_accessflags_t testperm){
00178   
00179   <span class="keywordtype">int</span> posix_testperm = 0;
00180   
00181   <span class="keywordflow">if</span> (testperm &amp; FSAL_R_OK) posix_testperm |= R_OK;
00182   <span class="keywordflow">if</span> (testperm &amp; FSAL_W_OK) posix_testperm |= W_OK;
00183   <span class="keywordflow">if</span> (testperm &amp; FSAL_X_OK) posix_testperm |= X_OK;
00184   <span class="keywordflow">if</span> (testperm &amp; FSAL_F_OK) posix_testperm |= F_OK;
00185   
00186   <span class="keywordflow">return</span> posix_testperm;
00187   
00188 }
00189 
00190 
<a name="l00205"></a><a class="code" href="fsal__convert_8c.html#a4">00205</a> <span class="keywordtype">int</span>   <a class="code" href="fsal__convert_8c.html#a4">fsal2posix_openflags</a>( fsal_openflags_t fsal_flags, <span class="keywordtype">char</span> * p_posix_flags )
00206 { 
00207   <span class="keywordtype">int</span> cpt;
00208   
00209   <span class="keywordflow">if</span> (!p_posix_flags) <span class="keywordflow">return</span> ERR_FSAL_FAULT;
00210   
00211   <span class="comment">/* check that all used flags exist */</span>
00212   
00213   <span class="keywordflow">if</span> ( fsal_flags &amp;
00214        ~( FSAL_O_RDONLY | FSAL_O_RDWR | FSAL_O_WRONLY | FSAL_O_APPEND | FSAL_O_TRUNC ))
00215     <span class="keywordflow">return</span> ERR_FSAL_INVAL;
00216   
00217   <span class="comment">/* Check for flags compatibility */</span>
00218   
00219   <span class="comment">/* O_RDONLY O_WRONLY O_RDWR cannot be used together */</span>
00220   
00221   cpt = 0;
00222   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_RDONLY ) cpt ++;
00223   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_RDWR )   cpt ++;
00224   <span class="keywordflow">if</span> ( fsal_flags &amp; FSAL_O_WRONLY ) cpt ++;
00225   
00226   <span class="keywordflow">if</span> ( cpt &gt; 1 ) <span class="keywordflow">return</span> ERR_FSAL_INVAL;
00227     
00228   <span class="comment">/* FSAL_O_APPEND et FSAL_O_TRUNC cannot be used together */</span>
00229   
00230   <span class="keywordflow">if</span> ( (fsal_flags &amp; FSAL_O_APPEND) &amp;&amp; (fsal_flags &amp; FSAL_O_TRUNC) )
00231     <span class="keywordflow">return</span> ERR_FSAL_INVAL;  
00232   
00233   <span class="comment">/* FSAL_O_TRUNC without FSAL_O_WRONLY or FSAL_O_RDWR */</span>
00234   
00235   <span class="keywordflow">if</span> ( (fsal_flags &amp; FSAL_O_TRUNC) &amp;&amp; !( fsal_flags &amp; (FSAL_O_WRONLY | FSAL_O_RDWR) ))
00236     <span class="keywordflow">return</span> ERR_FSAL_INVAL;
00237   
00238   <span class="comment">/* conversion */</span>  
00239   
00240   <span class="keywordflow">if</span> (fsal_flags &amp; FSAL_O_RDONLY)                       strcpy(p_posix_flags, <span class="stringliteral">"r"</span>);
00241   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsal_flags &amp; FSAL_O_WRONLY &amp; FSAL_O_APPEND)  strcpy(p_posix_flags, <span class="stringliteral">"a"</span>);
00242   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsal_flags &amp; FSAL_O_WRONLY &amp; FSAL_O_TRUNC)   strcpy(p_posix_flags, <span class="stringliteral">"w"</span>);
00243   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsal_flags &amp; FSAL_O_APPEND)                  strcpy(p_posix_flags, <span class="stringliteral">"a+"</span>);
00244   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsal_flags &amp; FSAL_O_TRUNC)                   strcpy(p_posix_flags, <span class="stringliteral">"w+"</span>);
00245   <span class="keywordflow">else</span>                                                  strcpy(p_posix_flags, <span class="stringliteral">"r+"</span>);
00246   
00247   <span class="keywordflow">return</span> ERR_FSAL_NO_ERROR;
00248   
00249 }
00250 
00251 
00252 
00253 
<a name="l00263"></a><a class="code" href="fsal__convert_8c.html#a5">00263</a> mode_t <a class="code" href="fsal__convert_8c.html#a5">fsal2unix_mode</a>( fsal_accessmode_t fsal_mode ){
00264   
00265   mode_t  out_mode = 0;
00266   
00267   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_SUID) ) out_mode |= S_ISUID ;
00268   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_SGID) ) out_mode |= S_ISGID ;
00269   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_SVTX) ) out_mode |= S_ISVTX ;
00270   
00271   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_RUSR) ) out_mode |= S_IRUSR ;
00272   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_WUSR) ) out_mode |= S_IWUSR ;
00273   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_XUSR) ) out_mode |= S_IXUSR ;
00274   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_RGRP) ) out_mode |= S_IRGRP ;
00275   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_WGRP) ) out_mode |= S_IWGRP ;
00276   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_XGRP) ) out_mode |= S_IXGRP ;
00277   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_ROTH) ) out_mode |= S_IROTH ;
00278   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_WOTH) ) out_mode |= S_IWOTH ;
00279   <span class="keywordflow">if</span> ( (fsal_mode &amp; FSAL_MODE_XOTH) ) out_mode |= S_IXOTH ;
00280   
00281   <span class="keywordflow">return</span> out_mode;
00282   
00283 }
00284 
00285 
00286 
<a name="l00296"></a><a class="code" href="fsal__convert_8c.html#a6">00296</a> fsal_accessmode_t <a class="code" href="fsal__convert_8c.html#a6">unix2fsal_mode</a>(  mode_t unix_mode ){
00297 
00298     fsal_accessmode_t fsalmode = 0;
00299     
00300     <span class="keywordflow">if</span> ( unix_mode &amp; S_ISUID ) fsalmode|= FSAL_MODE_SUID;
00301     <span class="keywordflow">if</span> ( unix_mode &amp; S_ISGID ) fsalmode|= FSAL_MODE_SGID;    
00302     <span class="keywordflow">if</span> ( unix_mode &amp; S_ISVTX ) fsalmode|= FSAL_MODE_SVTX;
00303     
00304     <span class="keywordflow">if</span> ( unix_mode &amp; S_IRUSR ) fsalmode|= FSAL_MODE_RUSR;
00305     <span class="keywordflow">if</span> ( unix_mode &amp; S_IWUSR ) fsalmode|= FSAL_MODE_WUSR;
00306     <span class="keywordflow">if</span> ( unix_mode &amp; S_IXUSR ) fsalmode|= FSAL_MODE_XUSR;
00307 
00308     <span class="keywordflow">if</span> ( unix_mode &amp; S_IRGRP ) fsalmode|= FSAL_MODE_RGRP;
00309     <span class="keywordflow">if</span> ( unix_mode &amp; S_IWGRP ) fsalmode|= FSAL_MODE_WGRP;
00310     <span class="keywordflow">if</span> ( unix_mode &amp; S_IXGRP ) fsalmode|= FSAL_MODE_XGRP;
00311 
00312     <span class="keywordflow">if</span> ( unix_mode &amp; S_IROTH ) fsalmode|= FSAL_MODE_ROTH;
00313     <span class="keywordflow">if</span> ( unix_mode &amp; S_IWOTH ) fsalmode|= FSAL_MODE_WOTH;
00314     <span class="keywordflow">if</span> ( unix_mode &amp; S_IXOTH ) fsalmode|= FSAL_MODE_XOTH;
00315     
00316     <span class="keywordflow">return</span> fsalmode;
00317     
00318 }  
00319     
00320 
<a name="l00331"></a><a class="code" href="fsal__convert_8c.html#a7">00331</a> fsal_nodetype_t  <a class="code" href="fsal__convert_8c.html#a7">posix2fsal_type</a>(mode_t  posix_type_in){
00332 
00333   <span class="keywordflow">switch</span>( posix_type_in &amp; S_IFMT){
00334     <span class="keywordflow">case</span> S_IFIFO:
00335       <span class="keywordflow">return</span> FSAL_TYPE_FIFO;
00336 
00337     <span class="keywordflow">case</span> S_IFCHR:
00338       <span class="keywordflow">return</span> FSAL_TYPE_CHR;
00339     
00340     <span class="keywordflow">case</span> S_IFDIR:
00341       <span class="keywordflow">return</span> FSAL_TYPE_DIR;
00342       
00343     <span class="keywordflow">case</span> S_IFBLK:
00344       <span class="keywordflow">return</span> FSAL_TYPE_BLK;
00345     
00346     <span class="keywordflow">case</span> S_IFREG:
00347     <span class="keywordflow">case</span> S_IFMT:
00348       <span class="keywordflow">return</span> FSAL_TYPE_FILE;
00349     
00350     <span class="keywordflow">case</span> S_IFLNK:
00351       <span class="keywordflow">return</span> FSAL_TYPE_LNK;
00352 
00353     <span class="keywordflow">case</span> S_IFSOCK:
00354       <span class="keywordflow">return</span> FSAL_TYPE_SOCK;
00355 
00356     <span class="keywordflow">default</span>:
00357       DisplayLogJdLevel( fsal_log, NIV_EVENT,
00358           <span class="stringliteral">"Unknown object type: %d"</span>,posix_type_in );
00359       <span class="keywordflow">return</span> -1;
00360   }    
00361   
00362 }
00363 
00364 fsal_time_t posix2fsal_time( time_t tsec )
00365 {
00366   fsal_time_t fsaltime;
00367 
00368   fsaltime.seconds = (fsal_uint_t) tsec;
00369   fsaltime.nseconds = 0;
00370 
00371   <span class="keywordflow">return</span> fsaltime;
00372 }
00373 
00374 fsal_fsid_t posix2fsal_fsid( dev_t posix_devid ){
00375 
00376   fsal_fsid_t fsid;
00377 
00378   fsid.major = (fsal_u64_t) posix_devid;
00379   fsid.minor = 0;
00380 
00381   <span class="keywordflow">return</span> fsid;
00382 
00383 }
00384 
00385 fsal_dev_t posix2fsal_devt( dev_t posix_devid ){
00386 
00387   fsal_dev_t dev;
00388 
00389   dev.major = posix_devid &gt;&gt; 8 ;
00390   dev.minor = posix_devid &amp; 0xFF ;
00391   
00392   <span class="keywordflow">return</span> dev;
00393 }
00394 
00395 fsal_status_t posix2fsal_attributes(  <span class="keyword">struct</span> stat   * p_buffstat,
00396                                      fsal_attrib_list_t * p_fsalattr_out )
00397  {
00398   
00399   fsal_attrib_mask_t supp_attr, unsupp_attr ;
00400    
00401   <span class="comment">/* sanity checks */</span>
00402   <span class="keywordflow">if</span> ( ! p_buffstat ||
00403        ! p_fsalattr_out   )
00404     ReturnCode(ERR_FSAL_FAULT,0);
00405   
00406   
00407   <span class="comment">/* check that asked attributes are supported */</span>
00408   supp_attr = global_fs_info.supported_attrs ;
00409   
00410   unsupp_attr = (p_fsalattr_out-&gt;asked_attributes) &amp; ( ~ supp_attr );
00411   <span class="keywordflow">if</span> ( unsupp_attr ) {
00412     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00413                   <span class="stringliteral">"Unsupported attributes: %#llX"</span>,unsupp_attr);
00414     ReturnCode( ERR_FSAL_ATTRNOTSUPP, 0 );
00415   }
00416   
00417   <span class="comment">/* Fills the output struct */</span>
00418   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00419       FSAL_ATTR_SUPPATTR)){
00420     p_fsalattr_out-&gt;supported_attributes = supp_attr;
00421   }
00422   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00423       FSAL_ATTR_TYPE)){
00424       p_fsalattr_out-&gt;type = 
00425           <a class="code" href="fsal__convert_8c.html#a7">posix2fsal_type</a>( p_buffstat-&gt;st_mode );
00426   }
00427   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00428       FSAL_ATTR_SIZE)){
00429         p_fsalattr_out-&gt;filesize =
00430             p_buffstat-&gt;st_size;
00431   }
00432   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00433       FSAL_ATTR_FSID)){
00434         p_fsalattr_out-&gt;fsid = posix2fsal_fsid( p_buffstat-&gt;st_dev );
00435   }
00436   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00437       FSAL_ATTR_ACL)){
00438     
00439       <span class="comment">/* XXX : manage ACL */</span>    
00440       <span class="keywordtype">int</span> i;
00441       <span class="keywordflow">for</span> (i=0;i&lt;FSAL_MAX_ACL;i++){
00442         p_fsalattr_out-&gt;acls[i].type = FSAL_ACL_EMPTY; <span class="comment">/* empty ACL slot */</span>
00443       }
00444     
00445   }
00446   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00447       FSAL_ATTR_FILEID)){
00448         p_fsalattr_out-&gt;fileid = (fsal_u64_t) (p_buffstat-&gt;st_ino);
00449   }
00450     
00451   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00452       FSAL_ATTR_MODE)){
00453         p_fsalattr_out-&gt;mode = <a class="code" href="fsal__convert_8c.html#a6">unix2fsal_mode</a>( p_buffstat-&gt;st_mode );
00454   }
00455   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00456       FSAL_ATTR_NUMLINKS )){
00457         p_fsalattr_out-&gt;numlinks = p_buffstat-&gt;st_nlink ;
00458   }
00459   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00460       FSAL_ATTR_OWNER )){
00461         p_fsalattr_out-&gt;owner =  p_buffstat-&gt;st_uid ;
00462   }
00463   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00464       FSAL_ATTR_GROUP )){
00465         p_fsalattr_out-&gt;group =  p_buffstat-&gt;st_gid ;
00466   }
00467   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00468       FSAL_ATTR_ATIME )){
00469         p_fsalattr_out-&gt;atime
00470           = posix2fsal_time( p_buffstat-&gt;st_atime ) ;
00471           
00472   }
00473 
00474   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00475       FSAL_ATTR_CTIME )){
00476         p_fsalattr_out-&gt;ctime
00477             = posix2fsal_time( p_buffstat-&gt;st_ctime ) ;
00478   }
00479   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00480       FSAL_ATTR_MTIME )){
00481         p_fsalattr_out-&gt;mtime
00482             = posix2fsal_time( p_buffstat-&gt;st_mtime) ;
00483   }
00484   
00485   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00486       FSAL_ATTR_CHGTIME )){
00487         p_fsalattr_out-&gt;chgtime
00488             = posix2fsal_time( MAX_2( p_buffstat-&gt;st_mtime, p_buffstat-&gt;st_ctime ) );
00489   }
00490   
00491   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00492       FSAL_ATTR_SPACEUSED )){
00493         p_fsalattr_out-&gt;spaceused
00494             =  p_buffstat-&gt;st_blocks * S_BLKSIZE ;
00495   }
00496 
00497   <span class="keywordflow">if</span> ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,
00498       FSAL_ATTR_RAWDEV )){
00499         p_fsalattr_out-&gt;rawdev
00500             = posix2fsal_devt( p_buffstat-&gt;st_rdev ); <span class="comment">/* XXX: convert ? */</span>
00501   }
00502   <span class="comment">/* mounted_on_fileid :</span>
00503 <span class="comment">  if ( FSAL_TEST_MASK(p_fsalattr_out-&gt;asked_attributes,</span>
00504 <span class="comment">      FSAL_ATTR_MOUNTFILEID )){</span>
00505 <span class="comment">          p_fsalattr_out-&gt;mounted_on_fileid = </span>
00506 <span class="comment">              hpss2fsal_64( p_hpss_attr_in-&gt;FilesetRootId );</span>
00507 <span class="comment">  }</span>
00508 <span class="comment">  */</span>
00509   
00510   <span class="comment">/* everything has been copied ! */</span>
00511   
00512   ReturnCode( ERR_FSAL_NO_ERROR, 0 );
00513 }
00514 
<a name="l00518"></a><a class="code" href="fsal__convert_8c.html#a12">00518</a> fsal_status_t <a class="code" href="fsal__convert_8c.html#a12">posixdb2fsal_error</a>(fsal_posixdb_status_t statusdb)
00519 {
00520   <span class="keywordflow">switch</span> (statusdb.major) {
00521     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_TOOMANYPATHS:
00522       DisplayLogJdLevel( fsal_log, NIV_EVENT,
00523           <span class="stringliteral">"Fsal posixdb : too many paths !"</span>, statusdb.minor );
00524     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_NOERR:
00525       ReturnCode(ERR_FSAL_NO_ERROR, statusdb.major);
00526       
00527     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_BADCONN:
00528     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_CMDFAILED:
00529       ReturnCode(ERR_FSAL_SERVERFAULT, statusdb.major);
00530       
00531     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_NOENT:
00532     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_NOPATH:
00533       ReturnCode(ERR_FSAL_STALE, statusdb.major);
00534       
00535     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_FAULT:
00536       ReturnCode(ERR_FSAL_FAULT, statusdb.major);
00537 
00538     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_NO_MEM:
00539       ReturnCode(ERR_FSAL_NOMEM, statusdb.major);
00540 
00541     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_PATHTOOLONG:
00542       ReturnCode(ERR_FSAL_NAMETOOLONG, statusdb.major);
00543       
00544       
00545       
00546     <span class="keywordflow">default</span>:
00547       DisplayLogJdLevel( fsal_log, NIV_EVENT,
00548           <span class="stringliteral">"Unknown posixdb error type: %d"</span>, statusdb.major );
00549       ReturnCode(ERR_FSAL_FAULT, statusdb.major);
00550   }
00551 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
