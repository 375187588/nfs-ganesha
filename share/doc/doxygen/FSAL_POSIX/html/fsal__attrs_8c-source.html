<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_attrs.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_attrs.c</h1><a href="fsal__attrs_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 <span class="preprocessor">#include &lt;utime.h&gt;</span>
00022 
00023 
<a name="l00043"></a><a class="code" href="fsal__attrs_8c.html#a0">00043</a> fsal_status_t <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>(
00044     fsal_handle_t         * p_filehandle,              <span class="comment">/* IN */</span>
00045     fsal_op_context_t     * p_context,               <span class="comment">/* IN */</span>
00046     fsal_attrib_list_t    * p_object_attributes        <span class="comment">/* IN/OUT */</span>
00047 )
00048 {
00049   <span class="keywordtype">int</span> rc, errsv;
00050   fsal_status_t status;
00051 
00052   fsal_path_t               fsalpath;
00053   <span class="keyword">struct </span>stat               buffstat;
00054 
00055   <span class="comment">/* sanity checks.</span>
00056 <span class="comment">   * note : object_attributes is mandatory in FSAL_getattrs.</span>
00057 <span class="comment">   */</span>
00058   <span class="keywordflow">if</span> (!p_filehandle || !p_context || !p_object_attributes)
00059     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_getattrs);
00060 
00061   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_filehandle, 0, &amp;fsalpath, &amp;buffstat);
00062   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_getattrs);
00063   
00064   <span class="comment">/* convert attributes */</span>
00065                      
00066   status = posix2fsal_attributes( &amp;buffstat,
00067                                  p_object_attributes );
00068   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00069   {
00070     FSAL_CLEAR_MASK( p_object_attributes-&gt;asked_attributes );
00071     FSAL_SET_MASK( p_object_attributes-&gt;asked_attributes,
00072         FSAL_ATTR_RDATTR_ERR );
00073     Return(status.major,status.minor,INDEX_FSAL_getattrs);
00074   }
00075   
00076   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_getattrs);
00077 
00078 }
00079 
00080 
00081 
00082 
<a name="l00107"></a><a class="code" href="fsal__attrs_8c.html#a1">00107</a> fsal_status_t <a class="code" href="fsal__attrs_8c.html#a1">FSAL_setattrs</a>(
00108     fsal_handle_t         * p_filehandle,        <span class="comment">/* IN */</span>
00109     fsal_op_context_t     * p_context,         <span class="comment">/* IN */</span>
00110     fsal_attrib_list_t    * p_attrib_set,        <span class="comment">/* IN */</span>
00111     fsal_attrib_list_t    * p_object_attributes  <span class="comment">/* [ IN/OUT ] */</span>
00112 ){
00113   
00114   <span class="keywordtype">int</span> rc, errsv;
00115   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00116   fsal_status_t         status;
00117   fsal_attrib_list_t    attrs ;
00118   
00119   fsal_path_t         fsalpath;
00120   <span class="keywordtype">int</span>                 count;
00121   <span class="keyword">struct </span>stat         buffstat;
00122 
00123   <span class="comment">/* sanity checks.</span>
00124 <span class="comment">   * note : object_attributes is optional.</span>
00125 <span class="comment">   */</span>
00126   <span class="keywordflow">if</span> (!p_filehandle || !p_context || !p_attrib_set)
00127     Return( ERR_FSAL_FAULT ,0 , INDEX_FSAL_setattrs);
00128     
00129   <span class="comment">/* local copy of attributes */</span>  
00130   attrs = *p_attrib_set ;
00131   
00132   <span class="comment">/* First, check that FSAL attributes changes are allowed. */</span>
00133   
00134   <span class="comment">/* Is it allowed to change times ? */</span>  
00135   
00136   <span class="keywordflow">if</span> ( !global_fs_info.cansettime ){
00137 
00138       <span class="keywordflow">if</span> ( attrs.asked_attributes
00139            &amp;
00140            ( FSAL_ATTR_ATIME | FSAL_ATTR_CREATION
00141             | FSAL_ATTR_CTIME | FSAL_ATTR_MTIME )
00142          )
00143       {
00144         <span class="comment">/* handled as an unsettable attribute. */</span>
00145         Return( ERR_FSAL_INVAL, 0, INDEX_FSAL_setattrs );
00146       }
00147   }
00148   
00149     
00150   <span class="comment">/* apply umask, if mode attribute is to be changed */</span>
00151   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_MODE ) ){
00152      attrs.mode &amp;= (~global_fs_info.umask) ;
00153   }
00154   
00155   <span class="comment">/* convert handle into path */</span>
00156   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_filehandle, 0, &amp;fsalpath, &amp;buffstat);
00157   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_setattrs);
00158 
00159   <span class="comment">/***********</span>
00160 <span class="comment">   *  CHMOD  *</span>
00161 <span class="comment">   ***********/</span>
00162   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_MODE ) )
00163   {
00164     
00165     <span class="comment">/* The POSIX chmod call don't affect the symlink object, but</span>
00166 <span class="comment">     * the entry it points to. So we must ignore it.</span>
00167 <span class="comment">     */</span>
00168     <span class="keywordflow">if</span> ( ! S_ISLNK( buffstat.st_mode ) )
00169     {
00170       
00171       <span class="keywordflow">if</span> ( p_context-&gt;credential.user != buffstat.st_uid ) Return( ERR_FSAL_PERM, 0, INDEX_FSAL_setattrs );
00172 
00173       <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00174       rc = chmod( fsalpath.path, <a class="code" href="fsal__convert_8c.html#a5">fsal2unix_mode</a>(attrs.mode) ); 
00175       errsv = errno;
00176       ReleaseTokenFSCall();
00177 
00178       <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_setattrs);
00179       
00180     }
00181         
00182   }
00183   
00184   <span class="comment">/***********</span>
00185 <span class="comment">   *  CHOWN  *</span>
00186 <span class="comment">   ***********/</span>
00187   <span class="comment">/* Only root can change uid and A normal user must be in the group he wants to set */</span>
00188   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_OWNER ) )
00189   {
00190     <span class="keywordflow">if</span> (p_context-&gt;credential.user != 0) Return( ERR_FSAL_PERM, 0, INDEX_FSAL_setattrs );
00191   }
00192   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_GROUP ) )
00193   {
00194           
00195     <span class="keywordflow">if</span> (p_context-&gt;credential.user != 0 &amp;&amp; p_context-&gt;credential.user != buffstat.st_uid) Return( ERR_FSAL_PERM, 0, INDEX_FSAL_setattrs );
00196     <span class="keywordtype">int</span> in_grp = 0;
00197     <span class="comment">/* set in_grp */</span>
00198     <span class="keywordflow">if</span> (p_context-&gt;credential.group == attrs.group) in_grp = 1;
00199     <span class="keywordflow">else</span> <span class="keywordflow">for</span> (i=0; i &lt; p_context-&gt;credential.nbgroups; i++) {
00200       <span class="keywordflow">if</span> (in_grp = (attrs.group == p_context-&gt;credential.alt_groups[i])) <span class="keywordflow">break</span>; 
00201     }
00202     <span class="keywordflow">if</span> (p_context-&gt;credential.user != 0 &amp;&amp; !in_grp) Return( ERR_FSAL_PERM, 0, INDEX_FSAL_setattrs );
00203   }
00204   
00205   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_OWNER | FSAL_ATTR_GROUP ) ) {
00206     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00207     rc = lchown( fsalpath.path,
00208                  FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_OWNER ) ? (<span class="keywordtype">int</span>) attrs.owner : -1,
00209                  FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_GROUP ) ? (<span class="keywordtype">int</span>) attrs.group : -1  );
00210     ReleaseTokenFSCall();
00211     <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errno), errno, INDEX_FSAL_setattrs);
00212   }
00213    
00214   <span class="comment">/***********</span>
00215 <span class="comment">   *  UTIME  *</span>
00216 <span class="comment">   ***********/</span>
00217   <span class="keywordflow">if</span> ( FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_ATIME | FSAL_ATTR_MTIME ) ) {
00218     
00219     <span class="keyword">struct </span>utimbuf timebuf;
00220     
00221     <span class="comment">/* check write permissions */</span>
00222     status = fsal_internal_testAccess( p_context, FSAL_W_OK, &amp;buffstat, NULL);
00223     <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_setattrs);
00224     
00225     timebuf.actime = (FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_ATIME ) ? (time_t) attrs.atime.seconds : buffstat.st_atime);
00226     timebuf.modtime = (FSAL_TEST_MASK( attrs.asked_attributes, FSAL_ATTR_MTIME ) ? (time_t) attrs.mtime.seconds : buffstat.st_mtime);
00227 
00228     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00229     rc = utime(fsalpath.path, &amp;timebuf);
00230     errsv = errno;
00231     ReleaseTokenFSCall();
00232     <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errno), errno, INDEX_FSAL_setattrs);
00233     
00234   }
00235     
00236   <span class="comment">/* Optionaly fills output attributes. */</span>
00237   
00238   <span class="keywordflow">if</span> ( p_object_attributes )
00239   {
00240     status = <a class="code" href="fsal__attrs_8c.html#a0">FSAL_getattrs</a>( p_filehandle, p_context, p_object_attributes );
00241 
00242     <span class="comment">/* on error, we set a special bit in the mask. */</span>        
00243     <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00244     {
00245       FSAL_CLEAR_MASK( p_object_attributes-&gt;asked_attributes );
00246       FSAL_SET_MASK( p_object_attributes-&gt;asked_attributes,
00247           FSAL_ATTR_RDATTR_ERR );
00248     }
00249     
00250   }
00251   
00252   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_setattrs);
00253   
00254 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
