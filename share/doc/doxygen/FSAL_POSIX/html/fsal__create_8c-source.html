<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_create.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_create.c</h1><a href="fsal__create_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 
00022 
00023 
<a name="l00052"></a><a class="code" href="fsal__create_8c.html#a0">00052</a> fsal_status_t <a class="code" href="fsal__create_8c.html#a0">FSAL_create</a>(
00053     fsal_handle_t         * p_parent_directory_handle, <span class="comment">/* IN */</span>
00054     fsal_name_t           * p_filename,              <span class="comment">/* IN */</span>
00055     fsal_op_context_t     * p_context,              <span class="comment">/* IN */</span>
00056     fsal_accessmode_t     accessmode,                <span class="comment">/* IN */</span>
00057     fsal_handle_t         * p_object_handle,           <span class="comment">/* OUT */</span>
00058     fsal_attrib_list_t    * p_object_attributes        <span class="comment">/* [ IN/OUT ] */</span>
00059 ){
00060   
00061   <span class="keywordtype">int</span> rc, fd, errsv;
00062   <span class="keywordtype">int</span> setgid_bit;
00063   fsal_status_t status;
00064   
00065   fsal_path_t   fsalpath;
00066   <span class="keyword">struct </span>stat buffstat;
00067   fsal_posixdb_fileinfo_t info;
00068   mode_t  unix_mode;
00069   
00070   <span class="comment">/* sanity checks.</span>
00071 <span class="comment">   * note : object_attributes is optional.</span>
00072 <span class="comment">   */</span>
00073   <span class="keywordflow">if</span> ( !p_parent_directory_handle || 
00074        !p_context ||
00075        !p_object_handle ||
00076        !p_filename )
00077     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_create);
00078   
00079   <span class="comment">/* convert fsal mode to unix mode. */</span>
00080   unix_mode = <a class="code" href="fsal__convert_8c.html#a5">fsal2unix_mode</a>( accessmode );
00081   
00082   <span class="comment">/* Apply umask */</span>
00083   unix_mode = unix_mode &amp; ~global_fs_info.umask ;
00084   
00085   
00086 <span class="preprocessor">#ifdef _DEBUG_FSAL</span>
00087 <span class="preprocessor"></span>  DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Creation mode: 0%o"</span>, accessmode ) ;
00088 <span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>  
00090   <span class="comment">/* build the destination path */</span>
00091   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_parent_directory_handle, 1, &amp;fsalpath, &amp;buffstat);
00092   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_create);
00093 
00094   <span class="comment">/* Check the user can write in the directory, and check the setgid bit on the directory */</span>
00095   <span class="keywordflow">if</span> (buffstat.st_mode &amp; S_ISGID) setgid_bit = 1;
00096 
00097   status = fsal_internal_testAccess( p_context, FSAL_W_OK | FSAL_X_OK, &amp;buffstat, NULL);
00098   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major,status.minor,INDEX_FSAL_create);
00099   
00100   
00101   status = <a class="code" href="fsal__internal_8c.html#a22">fsal_internal_appendFSALNameToFSALPath</a>(&amp;fsalpath, p_filename);
00102   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_create);
00103   
00104   <span class="comment">/* call to API */</span>
00105   
00106   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00107   <span class="comment">/* create the file */</span>
00108   fd = open(fsalpath.path, O_CREAT|O_WRONLY|O_TRUNC|O_EXCL, unix_mode); <span class="comment">/* error if the file already exists */</span>
00109   errsv = errno;
00110   <span class="keywordflow">if</span> (fd == -1) <span class="keywordflow">goto</span> releaseToken;
00111   <span class="comment">/* close the file descriptor */</span>
00112   rc = close(fd);
00113   errsv = errno;
00114   <span class="keywordflow">if</span> (rc) <span class="keywordflow">goto</span> releaseToken;
00115   <span class="comment">/* stat the new file */</span>
00116   rc = lstat(fsalpath.path, &amp;buffstat);
00117   errsv=errno;
00118   
00119 releaseToken:
00120   ReleaseTokenFSCall();
00121 
00122   <span class="keywordflow">if</span> (fd == -1 || rc) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_create);
00123 
00124   <span class="comment">/* add the file to the database */</span>
00125   <span class="keywordflow">if</span> (FSAL_IS_ERROR( status = <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>(&amp;buffstat, &amp;info) ) )
00126     Return( status.major, status.minor, INDEX_FSAL_create);
00127   <span class="keywordflow">if</span> (FSAL_IS_ERROR (status = fsal_internal_posixdb_add_entry( p_context-&gt;p_conn, p_filename, &amp;info, p_parent_directory_handle, p_object_handle)))
00128     Return( status.major, status.minor, INDEX_FSAL_create);
00129   
00130   <span class="comment">/* the file has been created */</span>
00131   <span class="comment">/* chown the file to the current user */</span>
00132 
00133   <span class="keywordflow">if</span> (p_context-&gt;credential.user != geteuid()) {
00134     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00135     <span class="comment">/* if the setgid_bit was set on the parent directory, do not change the group of the created file, because it's already the parentdir's group */</span>
00136     rc = lchown( fsalpath.path, p_context-&gt;credential.user, setgid_bit ? -1 : (<span class="keywordtype">int</span>) p_context-&gt;credential.group );
00137     errsv = errno;
00138     ReleaseTokenFSCall();
00139     <span class="keywordflow">if</span> ( rc ) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_create);
00140     buffstat.st_uid = p_context-&gt;credential.user;
00141     buffstat.st_gid = p_context-&gt;credential.group;
00142   }
00143   
00144   <span class="comment">/* add the file to the database */</span>
00145   
00146   <span class="keywordflow">if</span> ( p_object_attributes ) {
00147       
00148     
00149       <span class="comment">/* convert POSIX attributes to fsal attributes */</span>
00150       status=posix2fsal_attributes( &amp;buffstat,
00151                                    p_object_attributes );
00152       <span class="comment">/* on error, we set a special bit in the mask. */</span>        
00153       <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00154       {
00155         FSAL_CLEAR_MASK( p_object_attributes-&gt;asked_attributes );
00156         FSAL_SET_MASK( p_object_attributes-&gt;asked_attributes,
00157             FSAL_ATTR_RDATTR_ERR );
00158       }
00159         
00160   }
00161     
00162   
00163   <span class="comment">/* OK */</span>
00164   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_create);
00165   
00166 }
00167 
00168 
00169 
00170 
<a name="l00200"></a><a class="code" href="fsal__create_8c.html#a1">00200</a> fsal_status_t <a class="code" href="fsal__create_8c.html#a1">FSAL_mkdir</a>(
00201     fsal_handle_t         * p_parent_directory_handle, <span class="comment">/* IN */</span>
00202     fsal_name_t           * p_dirname,             <span class="comment">/* IN */</span>
00203     fsal_op_context_t     * p_context,              <span class="comment">/* IN */</span>
00204     fsal_accessmode_t     accessmode,          <span class="comment">/* IN */</span>
00205     fsal_handle_t         * p_object_handle,           <span class="comment">/* OUT */</span>
00206     fsal_attrib_list_t    * p_object_attributes   <span class="comment">/* [ IN/OUT ] */</span>
00207 ){
00208 
00209   <span class="keywordtype">int</span> rc, errsv, setgid_bit;
00210   <span class="keyword">struct </span>stat buffstat;
00211   mode_t  unix_mode;
00212   fsal_status_t status;
00213   fsal_path_t fsalpath;
00214   fsal_posixdb_fileinfo_t info;
00215   
00216   <span class="comment">/* sanity checks.</span>
00217 <span class="comment">   * note : object_attributes is optional.</span>
00218 <span class="comment">   */</span>
00219   <span class="keywordflow">if</span> ( !p_parent_directory_handle || 
00220        !p_context ||
00221        !p_object_handle ||
00222        !p_dirname)
00223     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_mkdir);
00224 
00225     
00226   <span class="comment">/* convert FSAL mode to HPSS mode. */</span>
00227   unix_mode = <a class="code" href="fsal__convert_8c.html#a5">fsal2unix_mode</a>( accessmode );
00228 
00229   <span class="comment">/* Apply umask */</span>
00230   unix_mode = unix_mode &amp; ~global_fs_info.umask ;
00231 
00232   <span class="comment">/* build the destination path */</span>
00233   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_parent_directory_handle, 1, &amp;fsalpath, &amp;buffstat);
00234   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_mkdir);
00235   
00236   <span class="comment">/* Check the user can write in the directory, and check the setgid bit on the directory */</span>
00237   <span class="keywordflow">if</span> (buffstat.st_mode &amp; S_ISGID) setgid_bit = 1;
00238 
00239   status = fsal_internal_testAccess( p_context, FSAL_W_OK | FSAL_X_OK, &amp;buffstat, NULL);
00240   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major,status.minor,INDEX_FSAL_mkdir);
00241   
00242   status = <a class="code" href="fsal__internal_8c.html#a22">fsal_internal_appendFSALNameToFSALPath</a>(&amp;fsalpath, p_dirname);
00243   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_mkdir);
00244     
00245   <span class="comment">/* creates the directory and stats it */</span>
00246   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00247   
00248   rc = mkdir(fsalpath.path, unix_mode);
00249   <span class="keywordflow">if</span> (!rc) rc = lstat(fsalpath.path, &amp;buffstat);
00250   errsv = errno;
00251   
00252   ReleaseTokenFSCall();
00253   
00254   <span class="keywordflow">if</span> ( rc ) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_mkdir);
00255     
00256 
00257   <span class="comment">/* add the directory to the database */</span>
00258   <span class="keywordflow">if</span> (FSAL_IS_ERROR( status = <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>(&amp;buffstat, &amp;info) ) )
00259     Return( status.major, status.minor, INDEX_FSAL_mkdir);
00260   <span class="keywordflow">if</span> (FSAL_IS_ERROR (status = fsal_internal_posixdb_add_entry( p_context-&gt;p_conn, p_dirname, &amp;info, p_parent_directory_handle, p_object_handle)))
00261     Return( status.major, status.minor, INDEX_FSAL_mkdir);
00262   
00263   <span class="comment">/* the directory has been created */</span>
00264   <span class="comment">/* chown the file to the current user/group */</span>
00265 
00266   <span class="keywordflow">if</span> (p_context-&gt;credential.user != geteuid()) {
00267     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00268     <span class="comment">/* if the setgid_bit was set on the parent directory, do not change the group of the created file, because it's already the parentdir's group */</span>
00269     rc = lchown( fsalpath.path, p_context-&gt;credential.user, setgid_bit ? -1 : (<span class="keywordtype">int</span>) p_context-&gt;credential.group );
00270     errsv = errno;
00271     ReleaseTokenFSCall();
00272     <span class="keywordflow">if</span> ( rc ) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_mkdir);
00273     buffstat.st_uid = p_context-&gt;credential.user;
00274     buffstat.st_gid = p_context-&gt;credential.group;
00275   }
00276   
00277   <span class="comment">/* Fills the attributes if needed */</span>
00278   <span class="keywordflow">if</span> ( p_object_attributes ) {
00279       
00280       status = posix2fsal_attributes( &amp;buffstat,
00281                                    p_object_attributes );
00282       
00283       <span class="comment">/* on error, we set a special bit in the mask. */</span>        
00284             
00285       <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00286       {
00287         FSAL_CLEAR_MASK( p_object_attributes-&gt;asked_attributes );
00288         FSAL_SET_MASK( p_object_attributes-&gt;asked_attributes,
00289             FSAL_ATTR_RDATTR_ERR );
00290       }
00291             
00292   }
00293   
00294   <span class="comment">/* OK */</span>
00295   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_mkdir);
00296   
00297 }
00298 
00299 
00300 
00301 
<a name="l00331"></a><a class="code" href="fsal__create_8c.html#a2">00331</a> fsal_status_t <a class="code" href="fsal__create_8c.html#a2">FSAL_link</a>(
00332     fsal_handle_t         * p_target_handle,        <span class="comment">/* IN */</span>
00333     fsal_handle_t         * p_dir_handle,           <span class="comment">/* IN */</span>
00334     fsal_name_t           * p_link_name,          <span class="comment">/* IN */</span>
00335     fsal_op_context_t     * p_context,              <span class="comment">/* IN */</span>
00336     fsal_attrib_list_t    * p_attributes       <span class="comment">/* [ IN/OUT ] */</span>
00337 ){
00338   
00339   <span class="keywordtype">int</span> rc, errsv;
00340   fsal_status_t status;
00341   fsal_path_t fsalpath_old, fsalpath_new;
00342   fsal_posixdb_fileinfo_t info;
00343   fsal_handle_t newhandle;
00344   <span class="keyword">struct </span>stat buffstat, buffstat_dir;
00345   
00346   <span class="comment">/* sanity checks.</span>
00347 <span class="comment">   * note : attributes is optional.</span>
00348 <span class="comment">   */</span>
00349   <span class="keywordflow">if</span> ( !p_target_handle || 
00350        !p_dir_handle || 
00351        !p_context || 
00352        !p_link_name)
00353     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_link);
00354   
00355   
00356   <span class="comment">/* Tests if hardlinking is allowed by configuration. */</span>
00357   
00358   <span class="keywordflow">if</span> ( !global_fs_info.link_support )
00359       Return( ERR_FSAL_NOTSUPP, 0,INDEX_FSAL_link);
00360   
00361 <span class="preprocessor">#ifdef _DEBUG_FSAL    </span>
00362 <span class="preprocessor"></span>  fprintf(stderr, <span class="stringliteral">"linking %llu/%i to %llu.%i/%s \n"</span>, p_target_handle-&gt;id, p_target_handle-&gt;ts, p_dir_handle-&gt;id, p_dir_handle-&gt;ts, p_link_name-&gt;name);
00363 <span class="preprocessor">#endif</span>
00364 <span class="preprocessor"></span>    
00365   <span class="comment">/* get the old path */</span>
00366   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_target_handle, 0, &amp;fsalpath_old, &amp;buffstat);
00367   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) {
00368     Return(status.major, status.minor, INDEX_FSAL_link);
00369   }
00370   
00371   <span class="comment">/* build the destination path and check permissions on the directory */</span>
00372   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_dir_handle, 1, &amp;fsalpath_new, &amp;buffstat_dir);
00373   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_link);
00374   
00375   status = fsal_internal_testAccess( p_context, FSAL_W_OK | FSAL_X_OK, &amp;buffstat_dir, NULL);
00376   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major,status.minor,INDEX_FSAL_link);
00377   
00378   status = <a class="code" href="fsal__internal_8c.html#a22">fsal_internal_appendFSALNameToFSALPath</a>(&amp;fsalpath_new, p_link_name);
00379   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_link);
00380   
00381   <span class="comment">/* Create the link on the filesystem */</span>
00382   
00383   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00384   rc = link(fsalpath_old.path, fsalpath_new.path);
00385   errsv = errno;
00386   ReleaseTokenFSCall();
00387   <span class="keywordflow">if</span> (rc) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_link);
00388   
00389   
00390   <span class="comment">/* add the link in the database */</span>
00391   buffstat.st_nlink++; <span class="comment">/* avoid to stat the new file */</span>
00392   status = <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>(&amp;buffstat, &amp;info); 
00393   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_link);
00394   
00395   <span class="keywordflow">if</span> (FSAL_IS_ERROR (status = fsal_internal_posixdb_add_entry( p_context-&gt;p_conn, p_link_name, &amp;info, p_dir_handle, &amp;newhandle)))
00396     Return(status.major, status.minor, INDEX_FSAL_link);
00397   
00398   <span class="comment">/* optionnaly get attributes */</span>
00399   
00400   <span class="keywordflow">if</span> ( p_attributes ) {
00401     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00402     rc = lstat(fsalpath_old.path, &amp;buffstat);
00403     errsv = errno;
00404     ReleaseTokenFSCall();
00405     <span class="keywordflow">if</span> (rc) {
00406       status.major = <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv);
00407       status.minor = errsv;
00408     } <span class="keywordflow">else</span> {
00409       status = posix2fsal_attributes( &amp;buffstat,
00410                                     p_attributes );
00411     }
00412     
00413     <span class="comment">/* on error, we set a special bit in the mask. */</span>
00414     <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00415     {
00416       FSAL_CLEAR_MASK( p_attributes-&gt;asked_attributes );
00417       FSAL_SET_MASK( p_attributes-&gt;asked_attributes,
00418           FSAL_ATTR_RDATTR_ERR );
00419     }
00420           
00421   }
00422     
00423   <span class="comment">/* OK */</span>
00424   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_link);
00425   
00426 }
00427 
00428 
00429 
<a name="l00437"></a><a class="code" href="fsal__create_8c.html#a3">00437</a> fsal_status_t <a class="code" href="fsal__create_8c.html#a3">FSAL_mknode</a>(
00438     fsal_handle_t             * parentdir_handle,     <span class="comment">/* IN */</span>
00439     fsal_name_t               * p_node_name,          <span class="comment">/* IN */</span>
00440     fsal_op_context_t         * p_context,            <span class="comment">/* IN */</span>
00441     fsal_accessmode_t         accessmode,             <span class="comment">/* IN */</span>
00442     fsal_nodetype_t           nodetype,               <span class="comment">/* IN */</span>
00443     fsal_dev_t                * dev,                  <span class="comment">/* IN */</span>
00444     fsal_handle_t             * p_object_handle,      <span class="comment">/* OUT (handle to the created node) */</span>
00445     fsal_attrib_list_t        * node_attributes       <span class="comment">/* [ IN/OUT ] */</span>
00446 ){
00447   <span class="keywordtype">int</span> rc, errsv, setgid_bit;
00448   <span class="keyword">struct </span>stat buffstat;
00449   fsal_status_t status;
00450   fsal_path_t fsalpath;
00451   fsal_posixdb_fileinfo_t info;
00452   
00453   mode_t unix_mode = 0;
00454   dev_t  unix_dev = 0;
00455   
00456   <span class="comment">/* sanity checks.</span>
00457 <span class="comment">   * note : link_attributes is optional.</span>
00458 <span class="comment">   */</span>
00459   <span class="keywordflow">if</span> ( !parentdir_handle || 
00460        !p_context ||
00461        !p_node_name )
00462     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_mknode);
00463   
00464   unix_mode = <a class="code" href="fsal__convert_8c.html#a5">fsal2unix_mode</a>( accessmode );
00465   
00466   <span class="comment">/* Apply umask */</span>
00467   unix_mode = unix_mode &amp; ~global_fs_info.umask ;
00468   
00469   <span class="keywordflow">switch</span>( nodetype )
00470   {
00471     <span class="keywordflow">case</span> FSAL_TYPE_BLK:
00472         <span class="keywordflow">if</span> ( !dev ) Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_mknode);
00473         unix_mode |= S_IFBLK;
00474         unix_dev = (dev-&gt;major &lt;&lt; 8 ) | (dev-&gt;minor &amp; 0xFF );
00475         <span class="keywordflow">break</span>;
00476         
00477     <span class="keywordflow">case</span> FSAL_TYPE_CHR:
00478         <span class="keywordflow">if</span> ( !dev ) Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_mknode);
00479         unix_mode |= S_IFCHR;
00480         unix_dev = (dev-&gt;major &lt;&lt; 8 ) | (dev-&gt;minor &amp; 0xFF );
00481         <span class="keywordflow">break</span>;
00482         
00483     <span class="keywordflow">case</span> FSAL_TYPE_SOCK:
00484         unix_mode |= S_IFSOCK;
00485         <span class="keywordflow">break</span>;
00486       
00487     <span class="keywordflow">case</span> FSAL_TYPE_FIFO:
00488         unix_mode |= S_IFIFO;
00489         <span class="keywordflow">break</span>;
00490         
00491     <span class="keywordflow">default</span>:
00492       DisplayLogJdLevel( fsal_log, NIV_MAJOR, <span class="stringliteral">"Invalid node type in FSAL_mknode: %d"</span>, nodetype );
00493       Return(ERR_FSAL_INVAL, 0, INDEX_FSAL_mknode);        
00494   }
00495   
00496   
00497   <span class="comment">/* build the destination path */</span>
00498   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, parentdir_handle, 1, &amp;fsalpath, &amp;buffstat);
00499   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_mknode);
00500   
00501   <span class="comment">/* Check the user can write in the directory, and check weither the setgid bit on the directory */</span>
00502   <span class="keywordflow">if</span> (buffstat.st_mode &amp; S_ISGID) setgid_bit = 1;
00503 
00504   status = fsal_internal_testAccess( p_context, FSAL_W_OK | FSAL_X_OK, &amp;buffstat, NULL);
00505   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major,status.minor,INDEX_FSAL_mknode);
00506   
00507   status = <a class="code" href="fsal__internal_8c.html#a22">fsal_internal_appendFSALNameToFSALPath</a>(&amp;fsalpath, p_node_name);
00508   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_mknode);
00509     
00510   <span class="comment">/* creates the node, then stats it */</span>
00511   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00512   
00513   rc = mknod(fsalpath.path, unix_mode, unix_dev);
00514   <span class="keywordflow">if</span> (!rc) rc = lstat(fsalpath.path, &amp;buffstat);
00515   errsv = errno;
00516   
00517   ReleaseTokenFSCall();
00518   
00519   <span class="keywordflow">if</span> ( rc ) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_mknode);
00520   
00521   
00522   <span class="comment">/* add the object to the database */</span>
00523   <span class="keywordflow">if</span> (FSAL_IS_ERROR( status = <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>(&amp;buffstat, &amp;info) ) )
00524     Return( status.major, status.minor, INDEX_FSAL_mknode);
00525   
00526   <span class="keywordflow">if</span> (FSAL_IS_ERROR (status = fsal_internal_posixdb_add_entry( p_context-&gt;p_conn, p_node_name, &amp;info, parentdir_handle, p_object_handle)))
00527     Return( status.major, status.minor, INDEX_FSAL_mknode);
00528   
00529   <span class="comment">/* the node has been created */</span>
00530   <span class="comment">/* chown the file to the current user/group */</span>
00531 
00532   <span class="keywordflow">if</span> (p_context-&gt;credential.user != geteuid())
00533   {
00534     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00535     
00536     <span class="comment">/* if the setgid_bit was set on the parent directory, do not change the group of the created file, because it's already the parentdir's group */</span>
00537     rc = lchown( fsalpath.path, p_context-&gt;credential.user, setgid_bit ? -1 : (<span class="keywordtype">int</span>) p_context-&gt;credential.group );
00538     errsv = errno;
00539     
00540     ReleaseTokenFSCall();
00541     
00542     <span class="keywordflow">if</span> ( rc ) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_mknode);
00543     
00544     buffstat.st_uid = p_context-&gt;credential.user;
00545     buffstat.st_gid = p_context-&gt;credential.group;
00546   }
00547   
00548   <span class="comment">/* Fills the attributes if needed */</span>
00549   <span class="keywordflow">if</span> ( node_attributes )
00550   {
00551       
00552       status = posix2fsal_attributes( &amp;buffstat,
00553                                       node_attributes );
00554       
00555       <span class="comment">/* on error, we set a special bit in the mask. */</span>        
00556             
00557       <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00558       {
00559         FSAL_CLEAR_MASK( node_attributes-&gt;asked_attributes );
00560         FSAL_SET_MASK( node_attributes-&gt;asked_attributes,
00561             FSAL_ATTR_RDATTR_ERR );
00562       }
00563             
00564   }
00565   
00566     
00567   <span class="comment">/* Finished */</span>
00568   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_mknode);
00569 
00570 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
