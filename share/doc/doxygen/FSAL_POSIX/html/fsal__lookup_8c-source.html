<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_lookup.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_lookup.c</h1><a href="fsal__lookup_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00013 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include &lt;string.h&gt;</span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 
00022 
<a name="l00050"></a><a class="code" href="fsal__lookup_8c.html#a0">00050</a> fsal_status_t <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a> (
00051     fsal_handle_t         * p_parent_directory_handle,        <span class="comment">/* IN */</span>
00052     fsal_name_t           * p_filename,                     <span class="comment">/* IN */</span>
00053     fsal_op_context_t     * p_context,                      <span class="comment">/* IN */</span>
00054     fsal_handle_t         * p_object_handle,                  <span class="comment">/* OUT */</span>
00055     fsal_attrib_list_t    * p_object_attributes               <span class="comment">/* [ IN/OUT ] */</span>
00056 ){
00057   <span class="keywordtype">int</span> rc, errsv;
00058   fsal_status_t             status;
00059   fsal_posixdb_status_t     statusdb;
00060   fsal_posixdb_fileinfo_t   infofs;
00061   <span class="keyword">struct </span>stat               buffstat;
00062   fsal_path_t pathfsal;
00063 
00064   <span class="comment">/* sanity checks</span>
00065 <span class="comment">   * note : object_attributes is optionnal</span>
00066 <span class="comment">   *        parent_directory_handle may be null for getting FS root.</span>
00067 <span class="comment">   */</span>
00068   <span class="keywordflow">if</span> (!p_object_handle || !p_context )
00069     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_lookup);
00070   
00071     
00072   <span class="comment">/* filename is NULL =&gt; lookup "/" */</span>
00073   <span class="keywordflow">if</span> ( (p_parent_directory_handle &amp;&amp; !p_filename) || (!p_parent_directory_handle &amp;&amp; p_filename) )
00074     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_lookup);
00075  
00076   <span class="comment">/* get informations about the parent */</span>
00077   <span class="keywordflow">if</span> (!p_parent_directory_handle){ <span class="comment">/* lookup '/' */</span>
00078     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00079     rc = lstat(<span class="stringliteral">"/"</span>, &amp;buffstat);
00080     errsv = errno;
00081     ReleaseTokenFSCall();
00082     <span class="keywordflow">if</span> ( rc ) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv) ,errsv , INDEX_FSAL_lookup);
00083   } <span class="keywordflow">else</span> {
00084     status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_parent_directory_handle, 1, &amp;pathfsal, &amp;buffstat);
00085     <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_lookup);
00086   }
00087   
00088   <span class="comment">/* Be careful about junction crossing, symlinks, hardlinks,... */</span>
00089   <span class="keywordflow">switch</span> ( <a class="code" href="fsal__convert_8c.html#a7">posix2fsal_type</a>(buffstat.st_mode) )
00090   {
00091     <span class="keywordflow">case</span> FSAL_TYPE_DIR:
00092       <span class="comment">// OK</span>
00093       <span class="keywordflow">break</span>;
00094     
00095     <span class="keywordflow">case</span> FSAL_TYPE_JUNCTION:
00096        <span class="comment">// This is a junction</span>
00097        Return(ERR_FSAL_XDEV,0,INDEX_FSAL_lookup);
00098       
00099     <span class="keywordflow">case</span> FSAL_TYPE_FILE:
00100     <span class="keywordflow">case</span> FSAL_TYPE_LNK:
00101       <span class="comment">// not a directory </span>
00102       Return(ERR_FSAL_NOTDIR,0,INDEX_FSAL_lookup);
00103       
00104     <span class="keywordflow">default</span>:
00105       Return(ERR_FSAL_SERVERFAULT ,0 , INDEX_FSAL_lookup);
00106   }
00107  
00108   <span class="keywordflow">if</span> ( !p_parent_directory_handle ) { <span class="comment">/* lookup '/' */</span>
00109       <span class="comment">/* convert struct stat to fsal_posixdb_fileinfo_t */</span>
00110 
00111       <span class="keywordflow">if</span> (FSAL_IS_ERROR( status = <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>(&amp;buffstat, &amp;infofs) ) )
00112         Return(status.major, status.minor, INDEX_FSAL_lookup);
00113 
00114       <span class="comment">/* get The handle of '/' */</span>
00115       status = <a class="code" href="fsal__internal_8c.html#a24">fsal_internal_getInfoFromName</a>( p_context, NULL, NULL, &amp;infofs, p_object_handle);
00116       <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_lookup);
00117       
00118   } <span class="keywordflow">else</span> {
00119 
00120 <span class="preprocessor">#ifdef _DEBUG_FSAL    </span>
00121 <span class="preprocessor"></span>    fprintf(stderr, <span class="stringliteral">"lookup of %llu.%i/%s\n"</span>, p_parent_directory_handle-&gt;id, p_parent_directory_handle-&gt;ts, p_filename-&gt;name );
00122 <span class="preprocessor">#endif</span>
00123 <span class="preprocessor"></span>        
00124     <span class="comment">/* check rights to enter into the directory */</span>
00125     status = fsal_internal_testAccess( p_context, FSAL_X_OK, &amp;buffstat, NULL );
00126     <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major,status.minor,INDEX_FSAL_lookup);
00127     
00128     <span class="comment">/* stat the file to see if it exists and get some information */</span>
00129     status = <a class="code" href="fsal__internal_8c.html#a22">fsal_internal_appendFSALNameToFSALPath</a>(&amp;pathfsal, p_filename);
00130     <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major,status.minor,INDEX_FSAL_lookup);
00131     
00132     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00133     rc = lstat( pathfsal.path, &amp;buffstat );
00134     errsv = errno;
00135     ReleaseTokenFSCall();
00136     <span class="keywordflow">if</span> ( rc ) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv) ,errsv , INDEX_FSAL_lookup);
00137     
00138     
00139     <span class="comment">/* getHandleFromName */</span>
00140     <span class="keywordflow">if</span> ( !<a class="code" href="group__FSALNameFunctions.html#ga4">FSAL_namecmp</a>(p_filename, &amp;FSAL_DOT) ) {
00141       <span class="comment">/* lookup "." */</span>
00142       memcpy( p_object_handle, p_parent_directory_handle, <span class="keyword">sizeof</span>(fsal_handle_t) );
00143       
00144     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !<a class="code" href="group__FSALNameFunctions.html#ga4">FSAL_namecmp</a>(p_filename, &amp;FSAL_DOT_DOT) ) {
00145       <span class="comment">/* lookup ".." */</span>
00146       statusdb = fsal_posixdb_getParentDirHandle( p_context-&gt;p_conn,
00147                                                   p_parent_directory_handle,
00148                                                   p_object_handle
00149                                                 );
00150 
00151     } <span class="keywordflow">else</span> {
00152       <span class="comment">/* convert struct stat to fsal_posixdb_fileinfo_t */</span>
00153       <span class="keywordflow">if</span> (FSAL_IS_ERROR( status = <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>(&amp;buffstat, &amp;infofs) ) )
00154         Return(status.major, status.minor, INDEX_FSAL_lookup);
00155 
00156       <span class="comment">/* get The handle of the file */</span>
00157       status = <a class="code" href="fsal__internal_8c.html#a24">fsal_internal_getInfoFromName</a>( p_context, p_parent_directory_handle, p_filename, &amp;infofs, p_object_handle);
00158       <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_lookup);
00159     }
00160 
00161   }
00162     
00163   <span class="keywordflow">if</span> ( p_object_attributes ) {
00164     
00165     <span class="comment">/* convert posix attributes to fsal attributes */</span>
00166     status = posix2fsal_attributes( 
00167                          &amp;buffstat,
00168                          p_object_attributes );
00169     
00170     <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00171     {
00172       FSAL_CLEAR_MASK( p_object_attributes-&gt;asked_attributes );
00173       FSAL_SET_MASK( p_object_attributes-&gt;asked_attributes,
00174           FSAL_ATTR_RDATTR_ERR );
00175     }
00176   }
00177     
00178   
00179   <span class="comment">/* lookup complete ! */</span>
00180   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_lookup );
00181 
00182 }
00183 
00184 
00185 
00186 
<a name="l00209"></a><a class="code" href="fsal__lookup_8c.html#a1">00209</a> fsal_status_t <a class="code" href="fsal__lookup_8c.html#a1">FSAL_lookupPath</a> (
00210     fsal_path_t           * p_path,            <span class="comment">/* IN */</span>
00211     fsal_op_context_t     * p_context,         <span class="comment">/* IN */</span>
00212     fsal_handle_t         * object_handle,     <span class="comment">/* OUT */</span>
00213     fsal_attrib_list_t    * object_attributes  <span class="comment">/* [ IN/OUT ] */</span>
00214 ){
00215   fsal_name_t obj_name = FSAL_NAME_INITIALIZER; <span class="comment">/* empty string */</span>
00216   <span class="keywordtype">char</span> * ptr_str;
00217   fsal_handle_t out_hdl;
00218   fsal_status_t status;
00219   <span class="keywordtype">int</span> b_is_last = FALSE; <span class="comment">/* is it the last lookup ? */</span>
00220   
00221   <span class="comment">/* sanity checks</span>
00222 <span class="comment">   * note : object_attributes is optionnal.</span>
00223 <span class="comment">   */</span>
00224   
00225   <span class="keywordflow">if</span> (!object_handle || !p_context || !p_path)
00226     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_lookupPath);
00227   
00228   <span class="comment">/* test whether the path begins with a slash*/</span>
00229   
00230   <span class="keywordflow">if</span> ( p_path-&gt;path[0] != <span class="charliteral">'/'</span> )
00231     Return(ERR_FSAL_INVAL,0,INDEX_FSAL_lookupPath);   
00232   
00233   <span class="comment">/* the pointer now points on the next name in the path,</span>
00234 <span class="comment">   * skipping slashes.</span>
00235 <span class="comment">   */</span>
00236   
00237   ptr_str = p_path-&gt;path + 1;
00238   <span class="keywordflow">while</span> (ptr_str[0] == <span class="charliteral">'/'</span>) ptr_str++;
00239   
00240   <span class="comment">/* is the next name empty ? */</span>
00241   
00242   <span class="keywordflow">if</span> (ptr_str[0] == <span class="charliteral">'\0'</span>)  b_is_last = TRUE;
00243      
00244   
00245   <span class="comment">/* retrieves root directory */</span>
00246   
00247   status = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a> (  NULL,     <span class="comment">/* looking up for root */</span>
00248                           NULL, <span class="comment">/* empty string to get root handle */</span>
00249                           p_context,     <span class="comment">/* user's p_contextentials */</span>
00250                           &amp;out_hdl, <span class="comment">/* output root handle */</span>
00251                           <span class="comment">/* retrieves attributes if this is the last lookup :*/</span>
00252                           ( b_is_last ? object_attributes : NULL ));
00253   
00254   <span class="keywordflow">if</span> (  FSAL_IS_ERROR( status ))
00255     Return( status.major, status.minor,INDEX_FSAL_lookupPath );
00256   
00257   
00258   <span class="comment">/* exits if this was the last lookup */</span>
00259   
00260   <span class="keywordflow">if</span>  ( b_is_last ){
00261     (*object_handle) = out_hdl;
00262     Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_lookupPath );
00263   }
00264   
00265   
00266   <span class="comment">/* proceed a step by step lookup */</span>
00267   
00268   <span class="keywordflow">while</span>( ptr_str[0] ){
00269    
00270     fsal_handle_t  in_hdl;
00271     <span class="keywordtype">char</span> * dest_ptr;
00272 
00273     <span class="comment">/* preparing lookup */</span>
00274     
00277     in_hdl = out_hdl;
00278 
00279     <span class="comment">/* compute next name */</span>
00280     dest_ptr = obj_name.name;      
00281     obj_name.len = 0;
00282     <span class="keywordflow">while</span> ( ptr_str[0]!=<span class="charliteral">'\0'</span> &amp;&amp; ptr_str[0]!=<span class="charliteral">'/'</span>){
00283       dest_ptr[0] = ptr_str[0];
00284       dest_ptr ++ ;
00285       ptr_str  ++ ;
00286       obj_name.len ++ ;
00287     }
00288     <span class="comment">/* final null char */</span>
00289     dest_ptr[0] = <span class="charliteral">'\0'</span>;
00290 
00291     <span class="comment">/* skip multiple slashes */</span>
00292     <span class="keywordflow">while</span> (ptr_str[0] == <span class="charliteral">'/'</span>) ptr_str++;
00293 
00294     <span class="comment">/* is the next name empty ? */</span>
00295     <span class="keywordflow">if</span> (ptr_str[0] == <span class="charliteral">'\0'</span>)
00296       b_is_last = TRUE;
00297 
00298     <span class="comment">/*call to FSAL_lookup */</span>      
00299     status = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a> (  &amp;in_hdl,  <span class="comment">/* parent directory handle */</span>
00300                             &amp;obj_name, <span class="comment">/* object name */</span>
00301                             p_context,     <span class="comment">/* user's p_contextentials */</span>
00302                             &amp;out_hdl, <span class="comment">/* output root handle */</span>
00303                             <span class="comment">/* retrieves attributes if this is the last lookup :*/</span>
00304                             ( b_is_last ? object_attributes : NULL ));
00305         
00306     <span class="keywordflow">if</span> (  FSAL_IS_ERROR( status ) )
00307       Return( status.major, status.minor,INDEX_FSAL_lookupPath );
00308     
00309     <span class="comment">/* ptr_str is ok, we are ready for next loop */</span>
00310   }
00311   
00312  (*object_handle) = out_hdl;  
00313   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_lookupPath );  
00314 
00315 }
00316 
00317 
00318 
<a name="l00342"></a><a class="code" href="fsal__lookup_8c.html#a2">00342</a> fsal_status_t <a class="code" href="fsal__lookup_8c.html#a2">FSAL_lookupJunction</a> (
00343     fsal_handle_t         * p_junction_handle,   <span class="comment">/* IN */</span>
00344     fsal_op_context_t     * p_context,           <span class="comment">/* IN */</span>
00345     fsal_handle_t         * p_fsoot_handle,      <span class="comment">/* OUT */</span>
00346     fsal_attrib_list_t    * p_fsroot_attributes  <span class="comment">/* [ IN/OUT ] */</span>
00347 )
00348 {
00349   <span class="keywordtype">int</span> rc;
00350   fsal_status_t   status;
00351   <span class="comment">//hpss_Attrs_t    root_attr;</span>
00352         
00353   <span class="comment">/* sanity checks</span>
00354 <span class="comment">   * note : p_fsroot_attributes is optionnal</span>
00355 <span class="comment">   */</span>
00356   <span class="comment">/*</span>
00357 <span class="comment">  if (!p_junction_handle || !p_fsoot_handle || !p_p_context )</span>
00358 <span class="comment">    Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_lookupJunction);</span>
00359 <span class="comment">  */</span>
00360   <span class="comment">/*</span>
00361 <span class="comment">  if ( p_junction_handle-&gt;obj_type != FSAL_TYPE_JUNCTION )</span>
00362 <span class="comment">    Return(ERR_FSAL_INVAL ,0 , INDEX_FSAL_lookupJunction);</span>
00363 <span class="comment">  */</span>
00364     
00365   <span class="comment">/* call to HPSS client api */</span>
00366   <span class="comment">/* We use hpss_GetRawAttrHandle for chasing junctions. */</span>
00367 
00368   <span class="comment">/* TakeTokenFSCall(); */</span>
00369 
00370   <span class="comment">//rc = HPSSFSAL_GetRawAttrHandle( &amp;(p_junction_handle-&gt;ns_handle),</span>
00371   <span class="comment">//                                NULL,</span>
00372   <span class="comment">//                                &amp;p_p_context-&gt;hpss_userp_context,</span>
00373   <span class="comment">//                                TRUE,     /* do traverse junctions !!! */</span>
00374   <span class="comment">//                                NULL,</span>
00375   <span class="comment">//                                NULL,</span>
00376   <span class="comment">//                                &amp;root_attr );</span>
00377 
00378   <span class="comment">/* ReleaseTokenFSCall(); */</span>
00379 
00380   <span class="comment">//if (rc) Return(hpss2fsal_error(rc), -rc, INDEX_FSAL_lookupJunction);</span>
00381 
00382   
00383   
00384   
00385   <span class="comment">/* set output handle */</span>
00386   <span class="comment">/*</span>
00387 <span class="comment">  p_fsoot_handle-&gt;obj_type  = hpss2fsal_type( root_attr.FilesetHandle.Type );</span>
00388 <span class="comment">  p_fsoot_handle-&gt;ns_handle = root_attr.FilesetHandle;</span>
00389 <span class="comment">  */</span>
00390   
00391   <span class="keywordflow">if</span> ( p_fsroot_attributes ) {
00392 
00393     <span class="comment">/* convert hpss attributes to fsal attributes */</span>
00394 
00395     <span class="comment">/*</span>
00396 <span class="comment">    status=hpss2fsal_attributes(</span>
00397 <span class="comment">                         &amp;root_attr.FilesetHandle,</span>
00398 <span class="comment">                         &amp;root_attr,</span>
00399 <span class="comment">                         p_fsroot_attributes );</span>
00400 <span class="comment"></span>
00401 <span class="comment">    if (FSAL_IS_ERROR(status))</span>
00402 <span class="comment">      Return(status.major,status.minor,INDEX_FSAL_lookupJunction);</span>
00403 <span class="comment">    */</span>
00404   }
00405 
00406   <span class="comment">/* lookup complete ! */</span>
00407   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_lookupJunction );
00408 }
00409 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
