<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_context.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_context.c</h1><div class="fragment"><pre class="fragment">00001 
00010 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00012 <span class="preprocessor">#endif</span>
00013 <span class="preprocessor"></span>
00014 <span class="preprocessor">#include "fsal.h"</span>
00015 <span class="preprocessor">#include "fsal_internal.h"</span>
00016 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
00017 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00018 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00019 <span class="preprocessor">#include &lt;string.h&gt;</span>
00020 
00021 
00022 <span class="keyword">const</span> <span class="keywordtype">char</span> * fs_specific_opts[] =
00023 {
00024     NULL
00025 };
00026 
00027     
00032 <span class="keyword">static</span> <span class="keywordtype">int</span> Getsubopt (<span class="keywordtype">char</span> **optionp, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> *tokens, <span class="keywordtype">char</span> **valuep)
00033 {
00034   <span class="keywordtype">char</span> *endp, *vstart;
00035   <span class="keywordtype">int</span> cnt;
00036 
00037   <span class="keywordflow">if</span> (**optionp == <span class="charliteral">'\0'</span>)
00038     <span class="keywordflow">return</span> -1;
00039 
00040   <span class="comment">/* Find end of next token.  */</span>
00041   endp = strchr (*optionp, <span class="charliteral">','</span>);
00042   <span class="keywordflow">if</span> (endp == NULL)
00043     endp = strchr (*optionp, <span class="charliteral">'\0'</span>);
00044 
00045   <span class="comment">/* Find start of value.  */</span>
00046   vstart = memchr (*optionp, <span class="charliteral">'='</span>, endp - *optionp);
00047   <span class="keywordflow">if</span> (vstart == NULL)
00048     vstart = endp;
00049 
00050   <span class="comment">/* Try to match the characters between *OPTIONP and VSTART against</span>
00051 <span class="comment">     one of the TOKENS.  */</span>
00052   <span class="keywordflow">for</span> (cnt = 0; tokens[cnt] != NULL; ++cnt)
00053     <span class="keywordflow">if</span> (memcmp (*optionp, tokens[cnt], vstart - *optionp) == 0
00054         &amp;&amp; tokens[cnt][vstart - *optionp] == <span class="charliteral">'\0'</span>)
00055       {
00056         <span class="comment">/* We found the current option in TOKENS.  */</span>
00057         *valuep = vstart != endp ? vstart + 1 : NULL;
00058 
00059         <span class="keywordflow">if</span> (*endp != <span class="charliteral">'\0'</span>)
00060           *endp++ = <span class="charliteral">'\0'</span>;
00061         *optionp = endp;
00062 
00063         <span class="keywordflow">return</span> cnt;
00064       }
00065 
00066   <span class="comment">/* The current suboption does not match any option.  */</span>
00067   *valuep = *optionp;
00068 
00069   <span class="keywordflow">if</span> (*endp != <span class="charliteral">'\0'</span>)
00070     *endp++ = <span class="charliteral">'\0'</span>;
00071   *optionp = endp;
00072 
00073   <span class="keywordflow">return</span> -1;
00074 }
00075 
00076 
<a name="l00089"></a><a class="code" href="group__FSALCredFunctions.html#ga0">00089</a> fsal_status_t <a class="code" href="group__FSALCredFunctions.html#ga0">FSAL_BuildExportContext</a>(
00090         fsal_export_context_t   * p_export_context,    <span class="comment">/* OUT */</span>
00091         fsal_path_t             * p_export_path,       <span class="comment">/* IN */</span>
00092         <span class="keywordtype">char</span>                    * fs_specific_options  <span class="comment">/* IN */</span>
00093       )
00094 {
00095   Return( ERR_FSAL_NO_ERROR , 0 , INDEX_FSAL_BuildExportContext );
00096 }
00097 
00098      
00099 
00100 fsal_status_t FSAL_InitClientContext( fsal_op_context_t * p_thr_context )
00101 {
00102   
00103   <span class="keywordtype">int</span> rc,i;
00104   fsal_posixdb_status_t      st;
00105   
00106   <span class="comment">/* sanity check */</span>
00107   <span class="keywordflow">if</span> (!p_thr_context ) Return( ERR_FSAL_FAULT ,0 , INDEX_FSAL_InitClientContext );
00108 
00109   <span class="comment">/* initialy set the export entry to none */</span>
00110   p_thr_context-&gt;export_context = NULL;
00111  
00112   st = fsal_posixdb_connect( &amp;global_posixdb_params , &amp;(p_thr_context-&gt;p_conn));
00113   <span class="keywordflow">if</span> ( FSAL_POSIXDB_IS_ERROR( st ) ) {
00114     DisplayLogLevel( NIV_CRIT, <span class="stringliteral">"CRITICAL ERROR: Worker could not connect to database !!!"</span> ) ;
00115     Return( ERR_FSAL_SERVERFAULT ,0 , INDEX_FSAL_InitClientContext );
00116   } <span class="keywordflow">else</span> {
00117     DisplayLog( <span class="stringliteral">"Worker successfuly connected to database"</span> ) ;
00118   }
00119   
00120   <span class="comment">/* sets the credential time */</span>
00121 <span class="comment">/*  p_thr_context-&gt;credential.last_update = time( NULL );*/</span>
00122   
00123    <span class="comment">/* traces: prints p_credential structure */</span>
00124   
00125   <span class="comment">/*</span>
00126 <span class="comment">   DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, "credential created:");</span>
00127 <span class="comment">   DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, "\tuid = %d, gid = %d",</span>
00128 <span class="comment">      p_thr_context-&gt;credential.hpss_usercred.SecPWent.Uid, p_thr_context-&gt;credential.hpss_usercred.SecPWent.Gid);</span>
00129 <span class="comment">   DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, "\tName = %s",</span>
00130 <span class="comment">      p_thr_context-&gt;credential.hpss_usercred.SecPWent.Name);</span>
00131 <span class="comment">   </span>
00132 <span class="comment">   for ( i=0; i&lt; p_thr_context-&gt;credential.hpss_usercred.NumGroups; i++ )</span>
00133 <span class="comment">     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, "\tAlt grp: %d",</span>
00134 <span class="comment">        p_thr_context-&gt;credential.hpss_usercred.AltGroups[i] );</span>
00135 <span class="comment">*/</span>
00136   Return( ERR_FSAL_NO_ERROR , 0, INDEX_FSAL_InitClientContext );
00137   
00138 }
00139 
00140  
<a name="l00164"></a><a class="code" href="group__FSALCredFunctions.html#ga2">00164</a> fsal_status_t <a class="code" href="group__FSALCredFunctions.html#ga2">FSAL_GetClientContext</a>(
00165         fsal_op_context_t       * p_thr_context,      <span class="comment">/* IN/OUT  */</span>
00166         fsal_export_context_t   * p_export_context,   <span class="comment">/* IN */</span>    
00167         fsal_uid_t              uid,                  <span class="comment">/* IN */</span>
00168         fsal_gid_t              gid,                  <span class="comment">/* IN */</span>
00169         fsal_gid_t              * alt_groups,         <span class="comment">/* IN */</span>
00170         fsal_count_t            nb_alt_groups         <span class="comment">/* IN */</span>
00171       )
00172 {
00173   
00174   fsal_count_t ng = nb_alt_groups;
00175   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00176   fsal_status_t st;
00177   
00178   <span class="comment">/* sanity check */</span>
00179   <span class="keywordflow">if</span> (!p_thr_context || !p_export_context )
00180     Return( ERR_FSAL_FAULT ,0 , INDEX_FSAL_GetClientContext );
00181   
00182   <span class="comment">/* set the export specific context */</span>
00183   p_thr_context-&gt;export_context = p_export_context;
00184   
00185     
00186   <span class="comment">/* Extracted from  /opt/hpss/src/nfs/nfsd/nfs_Dispatch.c */</span>
00187   p_thr_context-&gt;credential.user = uid ;
00188   p_thr_context-&gt;credential.group = gid ;
00189 
00190   
00191   <span class="keywordflow">if</span> ( ng &gt; FSAL_NGROUPS_MAX )
00192     ng = FSAL_NGROUPS_MAX ;
00193   <span class="keywordflow">if</span> ( ( ng &gt; 0 ) &amp;&amp; ( alt_groups == NULL ) )
00194     Return( ERR_FSAL_FAULT, 0, INDEX_FSAL_GetClientContext );
00195   
00196   p_thr_context-&gt;credential.nbgroups = ng;
00197   
00198   <span class="keywordflow">for</span> ( i = 0 ; i &lt; ng; i++ )
00199     p_thr_context-&gt;credential.alt_groups[i] = alt_groups[i];
00200 <span class="preprocessor">#if defined( _DEBUG_FSAL ) </span>
00201 <span class="preprocessor"></span>  
00202    <span class="comment">/* traces: prints p_credential structure */</span>
00203  
00204    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"credential modified:"</span>);
00205    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tuid = %d, gid = %d"</span>,
00206       p_thr_context-&gt;credential.user, p_thr_context-&gt;credential.group);
00207    
00208    <span class="keywordflow">for</span> ( i=0; i&lt; p_thr_context-&gt;credential.nbgroups; i++ )
00209      DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"\tAlt grp: %d"</span>,
00210         p_thr_context-&gt;credential.alt_groups[i] );
00211    
00212 <span class="preprocessor">#endif</span>
00213 <span class="preprocessor"></span>    
00214   Return( ERR_FSAL_NO_ERROR, 0, INDEX_FSAL_GetClientContext );
00215   
00216 }
00217 
00218 
00219 <span class="comment">/* @} */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
