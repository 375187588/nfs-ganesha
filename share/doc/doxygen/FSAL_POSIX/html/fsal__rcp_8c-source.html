<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_rcp.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_rcp.c</h1><a href="fsal__rcp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 <span class="preprocessor">#include "stuff_alloc.h"</span>
00022 <span class="preprocessor">#include &lt;string.h&gt;</span>
00023 
00024 
00025 
<a name="l00053"></a><a class="code" href="fsal__rcp_8c.html#a1">00053</a> fsal_status_t  <a class="code" href="fsal__rcp_8c.html#a1">FSAL_rcp</a>(
00054     fsal_handle_t             * filehandle,         <span class="comment">/* IN */</span>
00055     fsal_op_context_t               * p_context,               <span class="comment">/* IN */</span>
00056     fsal_path_t               * p_local_path,           <span class="comment">/* IN */</span>
00057     fsal_rcpflag_t            transfer_opt          <span class="comment">/* IN */</span>
00058 ){
00059 
00060   <span class="keywordtype">int</span> local_fd;
00061   <span class="keywordtype">int</span> local_flags;
00062   <span class="keywordtype">int</span> errsv;
00063   
00064   fsal_file_t       fs_fd;
00065   fsal_openflags_t  fs_flags;
00066   
00067   fsal_status_t     st = FSAL_STATUS_NO_ERROR;
00068   
00069   <span class="comment">/* default buffer size for RCP: 10MB */</span>
00070 <span class="preprocessor">#define RCP_BUFFER_SIZE 10485760</span>
00071 <span class="preprocessor"></span>  caddr_t  IObuffer;
00072   
00073   <span class="keywordtype">int</span> to_local = FALSE;
00074   <span class="keywordtype">int</span> to_fs = FALSE;
00075   
00076   <span class="keywordtype">int</span> eof = FALSE;
00077   
00078   ssize_t     local_size;
00079   fsal_size_t fs_size;  
00080   
00081   <span class="comment">/* sanity checks.*/</span>
00082   
00083   <span class="keywordflow">if</span> ( !filehandle || !p_context || !p_local_path )
00084     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_rcp);
00085 
00086   
00087   to_local = (( transfer_opt &amp; FSAL_RCP_FS_TO_LOCAL ) == FSAL_RCP_FS_TO_LOCAL );
00088   to_fs =    (( transfer_opt &amp; FSAL_RCP_LOCAL_TO_FS ) == FSAL_RCP_LOCAL_TO_FS );
00089     
00090   
00091 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00092 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (to_local)
00093     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00094         <span class="stringliteral">"FSAL_rcp: FSAL -&gt; local file (%s)"</span>, p_local_path-&gt;path );
00095   
00096   <span class="keywordflow">if</span> (to_fs)
00097     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00098         <span class="stringliteral">"FSAL_rcp: local file -&gt; FSAL (%s)"</span>, p_local_path-&gt;path);
00099 <span class="preprocessor">#endif  </span>
00100 <span class="preprocessor"></span>      
00101   <span class="comment">/* must give the sens of transfert (exactly one)*/</span>
00102   
00103   <span class="keywordflow">if</span> ( ( !to_local &amp;&amp; !to_fs ) || ( to_local &amp;&amp; to_fs ) )
00104     Return(ERR_FSAL_INVAL ,0 , INDEX_FSAL_rcp);
00105   
00106   <span class="comment">/* first, open local file with the correct flags */</span>
00107   
00108   <span class="keywordflow">if</span> ( to_fs )
00109   {  
00110     local_flags = O_RDONLY;
00111   }
00112   <span class="keywordflow">else</span> 
00113   {  
00114     local_flags = O_WRONLY | O_TRUNC;
00115     
00116     <span class="keywordflow">if</span> (( transfer_opt &amp; FSAL_RCP_LOCAL_CREAT) == FSAL_RCP_LOCAL_CREAT )
00117       local_flags |= O_CREAT;
00118       
00119     <span class="keywordflow">if</span> (( transfer_opt &amp; FSAL_RCP_LOCAL_EXCL) == FSAL_RCP_LOCAL_EXCL )
00120       local_flags |= O_EXCL;
00121     
00122   }
00123   
00124   
00125 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00126 <span class="preprocessor"></span>  {
00127     
00128     <span class="keywordtype">char</span> msg[1024];
00129     
00130     msg[0]=<span class="charliteral">'\0'</span>;
00131     
00132     <span class="keywordflow">if</span> (( local_flags &amp; O_RDONLY ) == O_RDONLY)
00133       strcat( msg, <span class="stringliteral">"O_RDONLY "</span>);
00134 
00135     <span class="keywordflow">if</span> (( local_flags &amp; O_WRONLY ) == O_WRONLY)
00136       strcat( msg, <span class="stringliteral">"O_WRONLY "</span>);
00137 
00138     <span class="keywordflow">if</span> (( local_flags &amp; O_TRUNC ) == O_TRUNC)
00139       strcat( msg, <span class="stringliteral">"O_TRUNC "</span>);
00140 
00141     <span class="keywordflow">if</span> (( local_flags &amp; O_CREAT ) == O_CREAT)
00142       strcat( msg, <span class="stringliteral">"O_CREAT "</span>);
00143 
00144     <span class="keywordflow">if</span> (( local_flags &amp; O_EXCL ) == O_EXCL)
00145       strcat( msg, <span class="stringliteral">"O_EXCL "</span>);
00146 
00147     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Openning local file %s with flags: %s"</span>,
00148         p_local_path-&gt;path, msg);
00149 
00150   }
00151 <span class="preprocessor">#endif</span>
00152 <span class="preprocessor"></span>  
00153   local_fd = open( p_local_path-&gt;path, local_flags );
00154   errsv = errno;
00155   
00156   <span class="keywordflow">if</span> ( local_fd == -1 )
00157   {
00158     Return( <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv) , errsv , INDEX_FSAL_rcp );
00159   }
00160   
00161   
00162   <span class="comment">/* call FSAL_open with the correct flags */</span>
00163   
00164   <span class="keywordflow">if</span> ( to_fs )
00165   {  
00166     fs_flags = FSAL_O_WRONLY | FSAL_O_TRUNC;
00167     
00168     <span class="comment">/* invalid flags for local to filesystem */</span>
00169     
00170     <span class="keywordflow">if</span> ( (( transfer_opt &amp; FSAL_RCP_LOCAL_CREAT) == FSAL_RCP_LOCAL_CREAT )
00171           ||
00172          (( transfer_opt &amp; FSAL_RCP_LOCAL_EXCL) == FSAL_RCP_LOCAL_EXCL )
00173         )
00174     {
00175       <span class="comment">/* clean &amp; return */</span>
00176       close( local_fd );
00177       Return(ERR_FSAL_INVAL ,0 , INDEX_FSAL_rcp);
00178     }
00179   }
00180   <span class="keywordflow">else</span> 
00181   {
00182     fs_flags = FSAL_O_RDONLY;
00183   }
00184 
00185   
00186 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00187 <span class="preprocessor"></span>  {
00188     
00189     <span class="keywordtype">char</span> msg[1024];
00190     
00191     msg[0]=<span class="charliteral">'\0'</span>;
00192     
00193     <span class="keywordflow">if</span> (( fs_flags &amp; FSAL_O_RDONLY ) == FSAL_O_RDONLY)
00194       strcat( msg, <span class="stringliteral">"FSAL_O_RDONLY "</span>);
00195 
00196     <span class="keywordflow">if</span> (( fs_flags &amp; FSAL_O_WRONLY ) == FSAL_O_WRONLY)
00197       strcat( msg, <span class="stringliteral">"FSAL_O_WRONLY "</span>);
00198 
00199     <span class="keywordflow">if</span> (( fs_flags &amp; FSAL_O_TRUNC ) == FSAL_O_TRUNC)
00200       strcat( msg, <span class="stringliteral">"FSAL_O_TRUNC "</span>);
00201 
00202     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00203         <span class="stringliteral">"Openning FSAL file with flags: %s"</span>, msg);
00204 
00205   }
00206 <span class="preprocessor">#endif</span>
00207 <span class="preprocessor"></span>      
00208   st = <a class="code" href="fsal__fileop_8c.html#a1">FSAL_open</a>( filehandle, p_context, fs_flags, &amp;fs_fd, NULL );
00209 
00210   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st ))
00211   {
00212     <span class="comment">/* clean &amp; return */</span>
00213       close( local_fd );
00214       Return(st.major ,st.minor , INDEX_FSAL_rcp);
00215   }
00216   
00217 
00218 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00219 <span class="preprocessor"></span>    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG,
00220         <span class="stringliteral">"Allocating IO buffer of size %llu"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) RCP_BUFFER_SIZE);
00221 <span class="preprocessor">#endif</span>
00222 <span class="preprocessor"></span>  
00223   <span class="comment">/* Allocates buffer */</span>
00224   
00225   IObuffer = (caddr_t) Mem_Alloc( RCP_BUFFER_SIZE );
00226   
00227   <span class="keywordflow">if</span> ( IObuffer == NULL )
00228   {
00229     <span class="comment">/* clean &amp; return */</span>    
00230     close( local_fd );    
00231     <a class="code" href="fsal__fileop_8c.html#a4">FSAL_close</a>( &amp;fs_fd );    
00232     Return( ERR_FSAL_NOMEM , Mem_Errno, INDEX_FSAL_rcp );
00233   }
00234   
00235   
00236   <span class="comment">/* read/write loop */</span>
00237   
00238   <span class="keywordflow">while</span> ( !eof )
00239   {
00240     <span class="comment">/* initialize error code */</span>
00241     st = FSAL_STATUS_NO_ERROR;
00242 
00243     
00244 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00245 <span class="preprocessor"></span>    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Read a block from source"</span>);
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span>            
00248     <span class="comment">/* read */</span>
00249     
00250     <span class="keywordflow">if</span> ( to_fs ) <span class="comment">/* from local filesystem */</span>
00251     {
00252       local_size = read( local_fd, IObuffer, RCP_BUFFER_SIZE );
00253       
00254       <span class="keywordflow">if</span> ( local_size == -1 )
00255       {
00256         st.major = ERR_FSAL_IO;
00257         st.minor = errno;
00258         <span class="keywordflow">break</span>; <span class="comment">/* exit loop */</span>
00259       }
00260       
00261       eof = ( local_size == 0 );
00262       
00263     }
00264     <span class="keywordflow">else</span> <span class="comment">/* from FSAL filesystem */</span>
00265     {
00266       fs_size = 0;
00267       st = <a class="code" href="fsal__fileop_8c.html#a2">FSAL_read</a>( &amp;fs_fd, NULL, RCP_BUFFER_SIZE, IObuffer, &amp;fs_size, &amp;eof );
00268       
00269       <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )) <span class="keywordflow">break</span>; <span class="comment">/* exit loop */</span>
00270     
00271 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00272 <span class="preprocessor"></span>      DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Size read from source: %llu"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)fs_size);
00273 <span class="preprocessor">#endif</span>
00274 <span class="preprocessor"></span>  
00275     }
00276         
00277     <span class="comment">/* write (if not eof) */</span>
00278     
00279     <span class="keywordflow">if</span> ( !eof || ((!to_fs) &amp;&amp; (fs_size&gt;0)) )
00280     {
00281       
00282 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00283 <span class="preprocessor"></span>    DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Write a block to destination"</span>);
00284 <span class="preprocessor">#endif</span>
00285 <span class="preprocessor"></span>      
00286       <span class="keywordflow">if</span> ( to_fs ) <span class="comment">/* to FSAL filesystem */</span>
00287       {
00288         
00289         st = <a class="code" href="fsal__fileop_8c.html#a3">FSAL_write</a>( &amp;fs_fd, NULL, local_size, IObuffer, &amp;fs_size );
00290         
00291         <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )) <span class="keywordflow">break</span>; <span class="comment">/* exit loop */</span>
00292         
00293       }
00294       <span class="keywordflow">else</span>  <span class="comment">/* to local filesystem */</span>
00295       {
00296        
00297         local_size = write( local_fd, IObuffer, fs_size );
00298 
00299 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00300 <span class="preprocessor"></span>      DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Size written to target: %llu"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)local_size);
00301 <span class="preprocessor">#endif</span>
00302 <span class="preprocessor"></span>
00303         <span class="keywordflow">if</span> ( local_size == -1 )
00304         {
00305           st.major = ERR_FSAL_IO;
00306           st.minor = errno;
00307           <span class="keywordflow">break</span>; <span class="comment">/* exit loop */</span>
00308         }
00309         
00310       }<span class="comment">/* if to_fs */</span>
00311       
00312     }<span class="comment">/* if eof */</span>
00313 <span class="preprocessor">#ifdef  _DEBUG_FSAL</span>
00314 <span class="preprocessor"></span>    <span class="keywordflow">else</span>
00315       DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"End of source file reached"</span>);
00316 <span class="preprocessor">#endif    </span>
00317 <span class="preprocessor"></span>    
00318   }<span class="comment">/* while !eof */</span>
00319   
00320   
00321   <span class="comment">/* Clean */</span>
00322   
00323   Mem_Free( IObuffer );
00324   close( local_fd );
00325   <a class="code" href="fsal__fileop_8c.html#a4">FSAL_close</a>( &amp;fs_fd );
00326   
00327   <span class="comment">/* return status. */</span>
00328   
00329   Return(st.major ,st.minor , INDEX_FSAL_rcp);
00330   
00331 }
00332 
00333 fsal_status_t  FSAL_rcp_by_fileid(
00334     fsal_handle_t             * filehandle,         <span class="comment">/* IN */</span>
00335     fsal_u64_t                  fileid,             <span class="comment">/* IN */</span>
00336     fsal_op_context_t         * p_context,          <span class="comment">/* IN */</span>
00337     fsal_path_t               * p_local_path,       <span class="comment">/* IN */</span>
00338     fsal_rcpflag_t            transfer_opt          <span class="comment">/* IN */</span> )
00339 {
00340    Return( ERR_FSAL_NOTSUPP, 0, INDEX_FSAL_open_by_fileid ) ;
00341 }
00342 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
