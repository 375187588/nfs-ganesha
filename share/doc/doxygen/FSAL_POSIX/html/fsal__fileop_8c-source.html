<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_fileop.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_fileop.c</h1><a href="fsal__fileop_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00013 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "fsal.h"</span>
00018 <span class="preprocessor">#include "fsal_internal.h"</span>
00019 <span class="preprocessor">#include "fsal_convert.h"</span>
00020 
00021 
00022 
<a name="l00062"></a><a class="code" href="fsal__fileop_8c.html#a0">00062</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a0">FSAL_open_by_name</a>(
00063     fsal_handle_t         * dirhandle,             <span class="comment">/* IN */</span>
00064     fsal_name_t           * filename,              <span class="comment">/* IN */</span>
00065     fsal_op_context_t     * p_context,              <span class="comment">/* IN */</span>
00066     fsal_openflags_t        openflags,              <span class="comment">/* IN */</span>
00067     fsal_file_t           * file_descriptor,        <span class="comment">/* OUT */</span>
00068     fsal_attrib_list_t    * file_attributes         <span class="comment">/* [ IN/OUT ] */</span>)
00069 {
00070   fsal_status_t fsal_status ;
00071   fsal_handle_t filehandle ;
00072 
00073   <span class="keywordflow">if</span> ( !dirhandle || !filename || !p_context || !file_descriptor)
00074     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_open_by_name);
00075 
00076   fsal_status = <a class="code" href="fsal__lookup_8c.html#a0">FSAL_lookup</a>( dirhandle, filename, p_context, &amp;filehandle, file_attributes ) ;
00077   <span class="keywordflow">if</span>( FSAL_IS_ERROR( fsal_status ) )
00078         <span class="keywordflow">return</span> fsal_status ;
00079 
00080   <span class="keywordflow">return</span> <a class="code" href="fsal__fileop_8c.html#a1">FSAL_open</a>( &amp;filehandle, p_context, openflags, file_descriptor, file_attributes ) ; 
00081 }
00082 
00083 
00084 
00085 
00086 
00087 
<a name="l00118"></a><a class="code" href="fsal__fileop_8c.html#a1">00118</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a1">FSAL_open</a>(
00119     fsal_handle_t         * p_filehandle,             <span class="comment">/* IN */</span>
00120     fsal_op_context_t     * p_context,              <span class="comment">/* IN */</span>
00121     fsal_openflags_t      openflags,                <span class="comment">/* IN */</span>
00122     fsal_file_t           * p_file_descriptor,        <span class="comment">/* OUT */</span>
00123     fsal_attrib_list_t    * p_file_attributes         <span class="comment">/* [ IN/OUT ] */</span>
00124 ){
00125   
00126   <span class="keywordtype">int</span> rc, errsv;
00127   fsal_status_t status;
00128   fsal_posixdb_status_t statusdb;
00129 
00130   fsal_path_t         fsalpath;
00131   <span class="keyword">struct </span>stat         buffstat;
00132   <span class="keywordtype">char</span>                posix_flags[4]; <span class="comment">/* stores r, r+, w, w+, a, or a+ */</span>
00133   
00134   <span class="comment">/* sanity checks.</span>
00135 <span class="comment">   * note : file_attributes is optional.</span>
00136 <span class="comment">   */</span>
00137   <span class="keywordflow">if</span> ( !p_filehandle || !p_context || !p_file_descriptor)
00138     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_open);
00139   
00140   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_filehandle, 0, &amp;fsalpath, &amp;buffstat);
00141   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_open);
00142 
00143   status = fsal_internal_testAccess( p_context, openflags &amp; FSAL_O_RDONLY ? FSAL_R_OK : FSAL_W_OK, &amp;buffstat, NULL );
00144   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major,status.minor,INDEX_FSAL_open);
00145   
00146   
00147   <span class="comment">/* convert fsal open flags to posix open flags */</span>
00148   rc = <a class="code" href="fsal__convert_8c.html#a4">fsal2posix_openflags</a>( openflags, posix_flags );
00149   
00150   <span class="comment">/* flags conflicts. */</span>
00151   <span class="keywordflow">if</span> (rc) {
00152     DisplayLogJdLevel( fsal_log, NIV_EVENT,
00153       <span class="stringliteral">"Invalid/conflicting flags : %#X"</span>, openflags );
00154     Return( rc, 0, INDEX_FSAL_open);
00155   }
00156   
00157   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00158   p_file_descriptor-&gt;p_file = fopen( fsalpath.path, posix_flags );
00159   errsv = errno;
00160   ReleaseTokenFSCall();
00161   
00162   <span class="keywordflow">if</span> ( !(p_file_descriptor-&gt;p_file) )
00163      Return( <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_open );
00164   
00165   <span class="comment">/* set the read-only flag of the file descriptor */</span>
00166   p_file_descriptor-&gt;ro = openflags &amp; FSAL_O_RDONLY;
00167   
00168   <span class="comment">/* output attributes */</span>
00169   <span class="keywordflow">if</span> ( p_file_attributes ){
00170     
00171     status = posix2fsal_attributes(
00172                      &amp;buffstat,
00173                      p_file_attributes );
00174     
00175     <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status ) )
00176     {
00177         FSAL_CLEAR_MASK( p_file_attributes-&gt;asked_attributes );
00178         FSAL_SET_MASK( p_file_attributes-&gt;asked_attributes,
00179             FSAL_ATTR_RDATTR_ERR );
00180     }
00181   }
00182   
00183   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_open);
00184   
00185 }
00186 
00187 
00188 
00189 
<a name="l00214"></a><a class="code" href="fsal__fileop_8c.html#a2">00214</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a2">FSAL_read</a>(
00215     fsal_file_t     * p_file_descriptor,  <span class="comment">/* IN */</span>
00216     fsal_seek_t     * p_seek_descriptor,  <span class="comment">/* [IN] */</span>
00217     fsal_size_t     buffer_size,        <span class="comment">/* IN */</span>
00218     caddr_t         buffer,             <span class="comment">/* OUT */</span>
00219     fsal_size_t     * p_read_amount,      <span class="comment">/* OUT */</span>
00220     fsal_boolean_t  * p_end_of_file       <span class="comment">/* OUT */</span>
00221 ){
00222 
00223   size_t i_size;  
00224   size_t nb_read;
00225   <span class="keywordtype">int</span> rc, errsv;
00226   off_t seekoffset;
00227   
00228   <span class="comment">/* sanity checks. */</span>
00229   
00230   <span class="keywordflow">if</span> ( !p_file_descriptor ||!buffer || !p_read_amount || !p_end_of_file )
00231     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_read);
00232 
00234   i_size = (size_t) buffer_size;
00235   
00236   
00237   <span class="comment">/* positioning */</span>
00238  
00239   <span class="keywordflow">if</span> ( p_seek_descriptor )
00240   {
00241   
00242     <span class="keywordflow">switch</span> ( p_seek_descriptor-&gt;whence )
00243     {
00244       <span class="keywordflow">case</span> FSAL_SEEK_CUR:
00245         <span class="comment">/* set position plus offset */</span>
00246         
00247         <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00248         rc = fseek(p_file_descriptor-&gt;p_file, p_seek_descriptor-&gt;offset, SEEK_CUR);
00249         errsv = errno;          
00250         ReleaseTokenFSCall();
00251         <span class="keywordflow">break</span>;
00252 
00253       <span class="keywordflow">case</span> FSAL_SEEK_SET :
00254         <span class="comment">/* set absolute position to offset */</span>
00255         
00256         <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00257         rc = fseek(p_file_descriptor-&gt;p_file, p_seek_descriptor-&gt;offset, SEEK_SET);
00258         errsv = errno;          
00259         ReleaseTokenFSCall();
00260         
00261         <span class="keywordflow">break</span>;
00262 
00263       <span class="keywordflow">case</span> FSAL_SEEK_END :
00264         <span class="comment">/* set end of file plus offset */</span>
00265         
00266         <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00267         rc = fseek(p_file_descriptor-&gt;p_file, p_seek_descriptor-&gt;offset, SEEK_END);
00268         errsv = errno;          
00269         ReleaseTokenFSCall();
00270         
00271         <span class="keywordflow">break</span>;    
00272     }
00273     
00274     <span class="keywordflow">if</span> ( rc )
00275     {
00276       
00277       DisplayLogJdLevel( fsal_log, NIV_EVENT,
00278         <span class="stringliteral">"Error in posix fseek operation (whence=%s, offset=%lld)"</span>,
00279          ( p_seek_descriptor-&gt;whence==FSAL_SEEK_CUR ? <span class="stringliteral">"SEEK_CUR"</span> :
00280            ( p_seek_descriptor-&gt;whence==FSAL_SEEK_SET ? <span class="stringliteral">"SEEK_SET"</span> :
00281              ( p_seek_descriptor-&gt;whence==FSAL_SEEK_END ? <span class="stringliteral">"SEEK_END"</span> : <span class="stringliteral">"ERROR"</span> ))),
00282                  p_seek_descriptor-&gt;offset );
00283 
00284       
00285       Return( <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_read );
00286     }
00287 
00288   }
00289 
00290   <span class="comment">/* read operation */</span>
00291   
00292   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00293   
00294   nb_read = fread( buffer, 1, i_size, p_file_descriptor-&gt;p_file );
00295   
00296   ReleaseTokenFSCall();
00297   
00300   <span class="keywordflow">if</span> ( feof(p_file_descriptor-&gt;p_file) )
00301     *p_end_of_file = 1; 
00302 
00303   <span class="keywordflow">if</span> ( nb_read == 0 &amp;&amp; ferror(p_file_descriptor-&gt;p_file) )
00304   {
00305     Return( <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(EBADF), EBADF, INDEX_FSAL_read );
00306   }
00307 
00308   *p_read_amount = nb_read;
00309   
00310   Return( ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_read ); 
00311   
00312 }
00313 
00314 
00315 
00316 
00317 
00318 
<a name="l00340"></a><a class="code" href="fsal__fileop_8c.html#a3">00340</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a3">FSAL_write</a>(
00341     fsal_file_t        * p_file_descriptor,     <span class="comment">/* IN */</span>
00342     fsal_seek_t        * p_seek_descriptor,     <span class="comment">/* IN */</span>
00343     fsal_size_t        buffer_size,           <span class="comment">/* IN */</span>
00344     caddr_t            buffer,                <span class="comment">/* IN */</span>
00345     fsal_size_t        * p_write_amount         <span class="comment">/* OUT */</span>
00346 ){
00347 
00348   size_t nb_written;  
00349   size_t i_size;
00350   <span class="keywordtype">int</span> rc, errsv;
00351   off_t seekoffset;
00352 
00353   <span class="comment">/* sanity checks. */</span>
00354   <span class="keywordflow">if</span> ( !p_file_descriptor || !buffer || !p_write_amount )
00355     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_write);
00356 
00357   <span class="keywordflow">if</span> ( p_file_descriptor-&gt;ro )
00358     Return(ERR_FSAL_PERM, 0, INDEX_FSAL_write);
00359   
00361   i_size = (size_t) buffer_size;
00362   
00363     
00364   <span class="comment">/* positioning */</span>
00365  
00366   <span class="keywordflow">if</span> ( p_seek_descriptor )
00367   {
00368   
00369     <span class="keywordflow">switch</span> ( p_seek_descriptor-&gt;whence )
00370     {
00371       <span class="keywordflow">case</span> FSAL_SEEK_CUR:
00372         <span class="comment">/* set position plus offset */</span>
00373         
00374         <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00375         rc = fseek(p_file_descriptor-&gt;p_file, p_seek_descriptor-&gt;offset, SEEK_CUR);
00376         errsv = errno;          
00377         ReleaseTokenFSCall();
00378         <span class="keywordflow">break</span>;
00379 
00380       <span class="keywordflow">case</span> FSAL_SEEK_SET :
00381         <span class="comment">/* set absolute position to offset */</span>
00382         
00383         <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00384         rc = fseek(p_file_descriptor-&gt;p_file, p_seek_descriptor-&gt;offset, SEEK_SET);
00385         errsv = errno;          
00386         ReleaseTokenFSCall();
00387         
00388         <span class="keywordflow">break</span>;
00389 
00390       <span class="keywordflow">case</span> FSAL_SEEK_END :
00391         <span class="comment">/* set end of file plus offset */</span>
00392         
00393         <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00394         rc = fseek(p_file_descriptor-&gt;p_file, p_seek_descriptor-&gt;offset, SEEK_END);
00395         errsv = errno;          
00396         ReleaseTokenFSCall();
00397         
00398         <span class="keywordflow">break</span>;    
00399     }
00400     
00401     <span class="keywordflow">if</span> ( rc )
00402     {
00403       
00404       DisplayLogJdLevel( fsal_log, NIV_EVENT,
00405         <span class="stringliteral">"Error in posix fseek operation (whence=%s, offset=%lld)"</span>,
00406          ( p_seek_descriptor-&gt;whence==FSAL_SEEK_CUR ? <span class="stringliteral">"SEEK_CUR"</span> :
00407            ( p_seek_descriptor-&gt;whence==FSAL_SEEK_SET ? <span class="stringliteral">"SEEK_SET"</span> :
00408              ( p_seek_descriptor-&gt;whence==FSAL_SEEK_END ? <span class="stringliteral">"SEEK_END"</span> : <span class="stringliteral">"ERROR"</span> ))),
00409                  p_seek_descriptor-&gt;offset );
00410 
00411       
00412       Return( <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_write );
00413       
00414     }
00415     
00416     DisplayLogJdLevel( fsal_log, NIV_FULL_DEBUG, <span class="stringliteral">"Write operation (whence=%s, offset=%lld, size=%lld)"</span>,
00417                ( p_seek_descriptor-&gt;whence==FSAL_SEEK_CUR ? <span class="stringliteral">"SEEK_CUR"</span> :
00418                ( p_seek_descriptor-&gt;whence==FSAL_SEEK_SET ? <span class="stringliteral">"SEEK_SET"</span> :
00419                ( p_seek_descriptor-&gt;whence==FSAL_SEEK_END ? <span class="stringliteral">"SEEK_END"</span> : <span class="stringliteral">"ERROR"</span> ))),
00420                  p_seek_descriptor-&gt;offset, buffer_size );
00421 
00422   }
00423 
00424   
00425   <span class="comment">/* write operation */</span>
00426   
00427   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00428   
00429   nb_written = fwrite( buffer, 1, i_size, p_file_descriptor-&gt;p_file );
00430 
00431   <span class="comment">/* With no flush, uncommited write may occur on 64 bits platforms */</span>
00432   (void)fflush( p_file_descriptor-&gt;p_file ) ;
00433   
00434   ReleaseTokenFSCall();
00435   
00438   <span class="keywordflow">if</span> ( nb_written &lt;= 0 &amp;&amp; ferror( p_file_descriptor-&gt;p_file ) )
00439   {
00440     Return( <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(EBADF), EBADF, INDEX_FSAL_write );
00441   }
00442   
00443   <span class="comment">/* set output vars */</span>
00444  
00445   *p_write_amount = (fsal_size_t)  nb_written;
00446   
00447   Return( ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_write ); 
00448   
00449 }
00450 
00451 
00452 
<a name="l00465"></a><a class="code" href="fsal__fileop_8c.html#a4">00465</a> fsal_status_t <a class="code" href="fsal__fileop_8c.html#a4">FSAL_close</a>(
00466     fsal_file_t        * p_file_descriptor <span class="comment">/* IN */</span>
00467 ){
00468   
00469   <span class="keywordtype">int</span> rc, errsv;
00470   
00471   <span class="comment">/* sanity checks. */</span>
00472   <span class="keywordflow">if</span> ( !p_file_descriptor )
00473     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_close);
00474   
00475   <span class="comment">/* call to close */</span>
00476   
00477   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00478   
00479   rc = fclose( p_file_descriptor-&gt;p_file );
00480   errsv = errno;
00481   
00482   ReleaseTokenFSCall();
00483   
00484   <span class="keywordflow">if</span> ( rc )
00485     Return( <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_close );
00486   
00487   Return( ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_close );
00488   
00489 }
00490 
00491 <span class="comment">/* Some unsupported calls used in FSAL_PROXY, just for permit the ganeshell to compile */</span>
00492 fsal_status_t FSAL_open_by_fileid(
00493     fsal_handle_t         * filehandle,             <span class="comment">/* IN */</span>
00494     fsal_u64_t              fileid,                 <span class="comment">/* IN */</span>
00495     fsal_op_context_t     * p_context,              <span class="comment">/* IN */</span>
00496     fsal_openflags_t        openflags,              <span class="comment">/* IN */</span>
00497     fsal_file_t           * file_descriptor,        <span class="comment">/* OUT */</span>
00498     fsal_attrib_list_t    * file_attributes         <span class="comment">/* [ IN/OUT ] */</span> )
00499 {
00500   Return(ERR_FSAL_NOTSUPP ,0 , INDEX_FSAL_open_by_fileid);
00501 }
00502 
00503 fsal_status_t FSAL_close_by_fileid(
00504     fsal_file_t        * file_descriptor <span class="comment">/* IN */</span>,
00505     fsal_u64_t           fileid )
00506 {
00507   Return(ERR_FSAL_NOTSUPP ,0 , INDEX_FSAL_open_by_fileid);
00508 }
00509 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
