<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_posixdb_tool.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_posixdb_tool.c</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00005 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00006 <span class="preprocessor">#endif</span>
00007 <span class="preprocessor"></span>
00008 <span class="preprocessor">#include "fsal.h"</span>
00009 <span class="preprocessor">#include "fsal_types.h"</span>
00010 <span class="preprocessor">#include "fsal_internal.h"</span>
00011 <span class="preprocessor">#include "stuff_alloc.h"</span>
00012 <span class="preprocessor">#include &lt;string.h&gt;</span>
00013 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00014 <span class="preprocessor">#include &lt;libgen.h&gt;</span> <span class="comment">/* basename */</span>
00015 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00016 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00017 
00018 
00019 <span class="preprocessor">#define OP_TESTCONN   1</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#define OP_EMPTYDB    2</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define OP_FIND       3</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#define OP_POPULATE   4</span>
00023 <span class="preprocessor"></span>
00024 
00025 <span class="comment">/* functions related to OP_FIND */</span>
00026 <span class="keywordtype">void</span> find(fsal_posixdb_conn *p_conn);
00027 <span class="keywordtype">void</span> display_directory(fsal_posixdb_conn * p_conn, fsal_handle_t * p_handle_parent, <span class="keywordtype">char</span> * basedir);
00028 
00029 <span class="comment">/* functions related to OP_EMPTYDB */</span>
00030 <span class="keywordtype">void</span> emptydb( fsal_posixdb_conn *p_conn );
00031 
00032 <span class="comment">/* functions related to OP_POPULATE */</span>
00033 <span class="keywordtype">void</span> populatedb(fsal_posixdb_conn *p_conn, <span class="keywordtype">char</span> *path);
00034 <span class="keywordtype">void</span> add_dir(fsal_posixdb_conn *p_conn, <span class="keywordtype">char</span> *path, fsal_handle_t *dir_handle);
00035 
00036 <span class="comment">/* ---------------------------------------------- */</span>
00037 
00038 
00039 <span class="keywordtype">void</span> populatedb(fsal_posixdb_conn *p_conn, <span class="keywordtype">char</span> *path)
00040 {
00041   <span class="keywordtype">int</span>                     rc;
00042   fsal_posixdb_fileinfo_t info;
00043   fsal_name_t             fsalname;
00044   fsal_handle_t           handle, handle_parent;
00045   <span class="keyword">struct </span>stat             buffstat;
00046   <span class="keywordtype">char</span>                    * begin, * end, backup;
00047   
00048   <span class="keywordflow">if</span> (path[0] != <span class="charliteral">'/'</span>) {
00049       fputs(<span class="stringliteral">"Error : you should provide a complete path"</span>, stderr);
00050       <span class="keywordflow">return</span>;
00051   }
00052   
00053   <span class="keywordflow">if</span> (path[strlen(path)-1] != <span class="charliteral">'/'</span> ) 
00054     strcat(path, <span class="stringliteral">"/"</span>);
00055 
00056   <span class="comment">/* add the path (given in arguments) to the database */</span>
00057   rc = lstat(<span class="stringliteral">"/"</span>, &amp;buffstat);
00058   <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>( &amp;buffstat, &amp;info );
00059   fsal_internal_posixdb_add_entry( p_conn, NULL, &amp;info, NULL, &amp;handle_parent);
00060 
00061   begin = end = path;
00062   <span class="keywordflow">while</span> (*end != <span class="charliteral">'\0'</span>) {
00063     <span class="keywordflow">while</span> ( *begin == <span class="charliteral">'/'</span> ) begin++;
00064     <span class="keywordflow">if</span> (*begin == <span class="charliteral">'\0'</span>) <span class="keywordflow">break</span>;
00065     end = begin + 1 ;
00066     <span class="keywordflow">while</span> ( *end != <span class="charliteral">'/'</span> &amp;&amp; *end != <span class="charliteral">'\0'</span>) end++;
00067     backup = *end;
00068     *end = <span class="charliteral">'\0'</span>;
00069     
00070     rc = lstat(path, &amp;buffstat);
00071     <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>( &amp;buffstat, &amp;info );
00072     <a class="code" href="group__FSALNameFunctions.html#ga0">FSAL_str2name</a>(begin, FSAL_MAX_NAME_LEN, &amp;fsalname);
00073     fsal_internal_posixdb_add_entry( p_conn, &amp;fsalname, &amp;info, &amp;handle_parent, &amp;handle);
00074     memcpy(&amp;handle_parent, &amp;handle, <span class="keyword">sizeof</span>(fsal_handle_t));
00075     
00076     *end = backup;
00077     begin=end;
00078   }
00079 
00080   <span class="comment">/* add files */</span>
00081   printf(<span class="stringliteral">"Adding entries in %s... "</span>, path);
00082   fflush(stdout);
00083   add_dir( p_conn, path, &amp;handle_parent );
00084   puts(<span class="stringliteral">"done"</span>);
00085 }
00086 
00087 
00088 <span class="keywordtype">void</span> add_dir(fsal_posixdb_conn *p_conn, <span class="keywordtype">char</span> *path, fsal_handle_t *p_dir_handle) {
00089   DIR *dirp;
00090   <span class="keyword">struct </span>dirent *dp;
00091   <span class="keyword">struct </span>dirent dpe;
00092   fsal_handle_t new_handle;
00093   <span class="keyword">struct </span>stat buffstat;
00094   <span class="keywordtype">char</span> path_temp[FSAL_MAX_PATH_LEN];
00095   fsal_status_t st;
00096   fsal_posixdb_fileinfo_t info;
00097   fsal_name_t fsalname;
00098 
00099   <span class="keywordflow">if</span> ( (dirp = opendir(path)) ) {
00100     <span class="keywordflow">while</span> (!readdir_r(dirp, &amp;dpe, &amp;dp) &amp;&amp; dp)
00101     {
00102       <span class="keywordflow">if</span> (!strcmp(dp-&gt;d_name, <span class="stringliteral">"."</span>) || !strcmp(dp-&gt;d_name, <span class="stringliteral">".."</span>)) <span class="keywordflow">continue</span>;
00103       <span class="keywordflow">if</span> (!strcmp(dp-&gt;d_name, <span class="stringliteral">".snapshot"</span>)) {
00104             fputs(<span class="stringliteral">"(ignoring .snapshot)"</span>, stderr);
00105             <span class="keywordflow">continue</span>;
00106       }
00107       strcpy(path_temp, path);
00108       strcat(path_temp, dp-&gt;d_name);
00109       lstat(path_temp, &amp;buffstat);
00110 
00111       <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>( &amp;buffstat, &amp;info );
00112       <a class="code" href="group__FSALNameFunctions.html#ga0">FSAL_str2name</a>(dp-&gt;d_name, FSAL_MAX_NAME_LEN, &amp;fsalname);
00113       st = fsal_internal_posixdb_add_entry( p_conn, &amp;fsalname, &amp;info, p_dir_handle, &amp;new_handle);
00114       <span class="keywordflow">if</span> (FSAL_IS_ERROR(st)) {
00115         fprintf(stderr, <span class="stringliteral">"[Error %i/%i]\n"</span>, st.major, st.minor);
00116         <span class="keywordflow">return</span>;
00117       }
00118       <span class="keywordflow">if</span> (S_ISDIR(buffstat.st_mode)) {
00119         strcat(path_temp, <span class="stringliteral">"/"</span>);
00120         add_dir( p_conn, path_temp, &amp;new_handle );
00121       }
00122     };
00123     closedir(dirp);
00124   }
00125 }
00126 
00127 
00128 <span class="keywordtype">void</span> emptydb( fsal_posixdb_conn *p_conn )
00129 {
00130   fsal_posixdb_status_t st;
00131   
00132   st = fsal_posixdb_flush(p_conn);
00133   <span class="keywordflow">if</span> (FSAL_POSIXDB_IS_ERROR(st)) {
00134     fprintf(stderr, <span class="stringliteral">"Error (%i/%i) while emptying the database\n"</span>, st.major, st.minor);
00135   } <span class="keywordflow">else</span> {
00136     printf(<span class="stringliteral">"Database entries have been successfully deleted\n"</span>);
00137   }
00138   
00139   <span class="keywordflow">return</span>;
00140 }
00141   
00142 <span class="keywordtype">void</span> find(fsal_posixdb_conn *p_conn)
00143 {
00144   fsal_handle_t             handle_root;
00145   fsal_posixdb_fileinfo_t   info;
00146   fsal_posixdb_status_t     st;
00147   
00148   st = fsal_posixdb_getInfoFromName(  p_conn,
00149                                       NULL, <span class="comment">/* parent handle */</span>
00150                                       NULL, <span class="comment">/* filename */</span>
00151                                       NULL,  <span class="comment">/* path */</span>
00152                                       &amp;handle_root);
00153   <span class="keywordflow">if</span> (FSAL_POSIXDB_IS_NOENT(st)) {
00154     fputs(<span class="stringliteral">"Error : Root handle not found. Is the database empty ?"</span>, stderr);
00155     <span class="keywordflow">return</span>;
00156   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FSAL_POSIXDB_IS_ERROR(st)) {
00157     fprintf(stderr, <span class="stringliteral">"Error (%i/%i) while getting root handle\n"</span>, st.major, st.minor);
00158     <span class="keywordflow">return</span>;
00159   }
00160   
00161   display_directory(p_conn, &amp;handle_root, <span class="stringliteral">""</span>);
00162   <span class="keywordflow">return</span>;
00163 }
00164 
00165 <span class="keywordtype">void</span> display_directory(fsal_posixdb_conn * p_conn, fsal_handle_t * p_handle_parent, <span class="keywordtype">char</span> * basedir)
00166 {
00167     fsal_posixdb_child *p_children;
00168     fsal_posixdb_status_t st;
00169     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count, i;
00170     
00171     st = fsal_posixdb_getChildren(p_conn, p_handle_parent, 0, &amp;p_children, &amp;count);
00172     <span class="keywordflow">if</span> (FSAL_POSIXDB_IS_ERROR(st)) {
00173       fprintf(stderr, <span class="stringliteral">"Error (%i/%i) while getting children of %s\n"</span>, st.major, st.minor, basedir);
00174       <span class="keywordflow">return</span>;
00175     }
00176     <span class="keywordflow">for</span> (i=0; i&lt;count; i++) {
00177       printf(<span class="stringliteral">"%llu %s/%s\n"</span>,p_children[i].handle.info.inode,basedir, p_children[i].name.name);
00178       <span class="keywordflow">if</span> (p_children[i].handle.info.ftype == FSAL_TYPE_DIR) {
00179         <span class="keywordtype">char</span> basedir_new[FSAL_MAX_PATH_LEN];
00180         strncpy(basedir_new, basedir, FSAL_MAX_PATH_LEN);
00181         strncat(basedir_new, <span class="stringliteral">"/"</span>, FSAL_MAX_PATH_LEN);
00182         strncat(basedir_new, p_children[i].name.name, FSAL_MAX_PATH_LEN);
00183         display_directory(p_conn, &amp;(p_children[i].handle), basedir_new);
00184       }
00185     }
00186     Mem_Free(p_children);
00187 }
00188 
00189 
00190 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv)
00191 {
00192   fsal_posixdb_conn_params_t  dbparams;
00193   <span class="keywordtype">char</span>                        exec_name[MAXPATHLEN];
00194   <span class="keywordtype">char</span>                        c, op=0;
00195   fsal_posixdb_conn           *p_conn;
00196   fsal_posixdb_status_t       statusdb;
00197   <span class="keywordtype">char</span>                        path[MAXPATHLEN];
00198   <span class="keywordtype">int</span> rc;
00199   
00200   <span class="keywordtype">char</span>  options[] = <span class="stringliteral">"h@H:P:L:D:K:"</span> ;
00201   <span class="keywordtype">char</span>  usage[] = 
00202     <span class="stringliteral">"Usage: %s [-h][-H &lt;host&gt;][-P &lt;port&gt;][-L &lt;login&gt;][-D &lt;dbname&gt;][-K &lt;passwd file&gt;] operation operation_parameters\n"</span>
00203     <span class="stringliteral">"\t[-h]               display this help\n"</span>
00204     <span class="stringliteral">"\t[-H &lt;host&gt;]        Database host\n"</span>
00205     <span class="stringliteral">"\t[-P &lt;port&gt;]        Database port\n"</span>
00206     <span class="stringliteral">"\t[-L &lt;login&gt;]       Database login\n"</span>
00207     <span class="stringliteral">"\t[-D &lt;dbname&gt;]      Name of the database\n"</span>
00208     <span class="stringliteral">"\t[-K &lt;passwd file&gt;] Path of the file where is stored the password\n"</span>
00209     <span class="stringliteral">"------------- Default Values -------------\n"</span>
00210     <span class="stringliteral">"host        : localhost\n"</span>
00211     <span class="stringliteral">"port        : default DB port\n"</span>
00212     <span class="stringliteral">"dbname      : posixdb\n"</span>
00213     <span class="stringliteral">"login       : current unix user\n"</span>
00214     <span class="stringliteral">"passwd file : default path ($PGPASSFILE)\n"</span> 
00215     <span class="stringliteral">"------------- Operations -----------------\n"</span>
00216     <span class="stringliteral">"test_connection       : try to connect to the database\n"</span>
00217     <span class="stringliteral">"empty_database        : Delete all entries in the database\n"</span>
00218     <span class="stringliteral">"find                  : Print the entries of the database (as 'find' would do it)\n"</span>
00219     <span class="stringliteral">"populate &lt;path&gt;       : Add (recursively) the object in &lt;path&gt; into the database\n\n"</span>;
00220 
00221   memset(&amp;dbparams, 0, <span class="keyword">sizeof</span>(fsal_posixdb_conn_params_t));
00222   strcpy(dbparams.host, <span class="stringliteral">"localhost"</span>);
00223   strcpy(dbparams.dbname, <span class="stringliteral">"posixdb"</span>);
00224 
00225   <span class="comment">/* What is the executable file's name */</span>
00226   <span class="keywordflow">if</span>( *exec_name == <span class="charliteral">'\0'</span> )
00227     strcpy( (<span class="keywordtype">char</span> *)exec_name, basename(argv[0]) ) ;
00228   
00229   <span class="comment">/* now parsing options with getopt */</span>
00230   <span class="keywordflow">while</span>( ( c = getopt( argc, argv, options ) ) != EOF ) {
00231       <span class="keywordflow">switch</span>( c ) {
00232         <span class="keywordflow">case</span> <span class="charliteral">'@'</span>:
00233           <span class="comment">/* A litlle backdoor to keep track of binary versions */</span>
00234           printf( <span class="stringliteral">"%s compiled on %s at %s\n"</span>, exec_name, __DATE__, __TIME__ ) ;
00235           exit( 0 ) ;
00236           break ;
00237         <span class="keywordflow">case</span> <span class="charliteral">'H'</span>:
00238           strncpy( dbparams.host, optarg, FSAL_MAX_DBHOST_NAME_LEN );
00239           <span class="keywordflow">break</span>;
00240         <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:
00241           strncpy( dbparams.port, optarg, FSAL_MAX_DBPORT_STR_LEN );
00242           <span class="keywordflow">break</span>;
00243         <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
00244           strncpy( dbparams.login, optarg, FSAL_MAX_DB_LOGIN_LEN );
00245           <span class="keywordflow">break</span>;
00246         <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
00247           strncpy( dbparams.dbname, optarg, FSAL_MAX_DB_NAME_LEN );
00248           <span class="keywordflow">break</span>;
00249         <span class="keywordflow">case</span> <span class="charliteral">'K'</span>:
00250           strncpy( dbparams.passwdfile, optarg, PATH_MAX );
00251           <span class="keywordflow">break</span>;
00252         <span class="keywordflow">default</span>:
00253           <span class="comment">/* display the help */</span>
00254           fprintf( stderr, usage, exec_name ) ;
00255           exit( 0 ) ;
00256           break ;
00257       }
00258   }
00259   
00260   <span class="keywordflow">if</span> (optind == argc) {
00261     fprintf(stderr, <span class="stringliteral">"No operation specified.\n"</span>); 
00262     fprintf( stderr, usage, exec_name ) ;
00263     exit(0); 
00264   }
00265   <span class="keywordflow">if</span> (optind &lt; argc) {
00266      <span class="keywordflow">if</span> ( !strcmp(argv[optind], <span class="stringliteral">"test_connection"</span>) ) {
00267        op = OP_TESTCONN;
00268      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !strcmp(argv[optind], <span class="stringliteral">"empty_database"</span>) ) {
00269        op = OP_EMPTYDB;
00270      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !strcmp(argv[optind], <span class="stringliteral">"find"</span>) ) {
00271        op = OP_FIND;
00272      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !strcmp(argv[optind], <span class="stringliteral">"populate"</span>) ) {
00273        op = OP_POPULATE;
00274        optind++;
00275         <span class="keywordflow">if</span> (optind &lt; argc) {
00276           strncpy(path, argv[optind], MAXPATHLEN);
00277         } <span class="keywordflow">else</span> {
00278           fputs(<span class="stringliteral">"Operation 'populate' need a parameter"</span>, stderr);
00279           fprintf( stderr, usage, exec_name ) ;
00280           exit( -1 ) ;
00281         }
00282      } <span class="keywordflow">else</span> {
00283        fprintf (stderr, <span class="stringliteral">"Unknown operation : %s\n"</span>, argv[optind]);
00284         fprintf( stderr, usage, exec_name ) ;
00285        exit( -1 );
00286      }
00287  } 
00288 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00289 <span class="preprocessor"></span>  BuddyInit( NULL );  
00290 <span class="preprocessor">#endif  </span>
00291 <span class="preprocessor"></span>  
00292   <span class="comment">/* Connecting to database */</span>
00293   <span class="keywordflow">if</span> (*(dbparams.passwdfile) != <span class="charliteral">'\0'</span>) {
00294     rc = setenv(<span class="stringliteral">"PGPASSFILE"</span>, dbparams.passwdfile, 1);
00295     <span class="keywordflow">if</span> (rc != 0)
00296       fputs(<span class="stringliteral">"Could not set POSTGRESQL keytab path."</span>, stderr);
00297   }
00298   
00299   fprintf(stderr, <span class="stringliteral">"Opening database connection to %s...\n"</span>, dbparams.host);
00300   statusdb = fsal_posixdb_connect(&amp;dbparams, &amp;p_conn);
00301   <span class="keywordflow">if</span> (FSAL_POSIXDB_IS_ERROR(statusdb)) {
00302     fprintf(stderr, <span class="stringliteral">"Error %i. exiting.\n"</span>, statusdb.minor);
00303     exit(-1);
00304   } <span class="keywordflow">else</span> {
00305     fprintf(stderr, <span class="stringliteral">"Connected.\n"</span>);
00306   }
00307   
00308   <span class="comment">/* Execute the operation */</span>
00309   <span class="keywordflow">switch</span>( op ) {
00310     <span class="keywordflow">case</span> OP_TESTCONN:
00311       <span class="comment">/* nothing to do */</span>
00312       <span class="keywordflow">break</span>;
00313     <span class="keywordflow">case</span> OP_EMPTYDB:
00314       emptydb( p_conn );
00315       <span class="keywordflow">break</span>;
00316     <span class="keywordflow">case</span> OP_FIND:
00317       find( p_conn );
00318       <span class="keywordflow">break</span>;
00319     <span class="keywordflow">case</span> OP_POPULATE:
00320       populatedb(p_conn, path);
00321       <span class="keywordflow">break</span>;
00322     <span class="keywordflow">default</span>:
00323       puts(<span class="stringliteral">"Bad operation !!"</span>); 
00324       fprintf( stderr, usage, exec_name ) ;
00325   }
00326   
00327   fsal_posixdb_disconnect(p_conn);
00328   
00329   exit(0);
00330 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
