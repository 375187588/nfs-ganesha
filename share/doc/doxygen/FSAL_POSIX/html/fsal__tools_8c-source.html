<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_tools.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_tools.c</h1><a href="fsal__tools_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00013 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "fsal.h"</span>
00018 <span class="preprocessor">#include "fsal_internal.h"</span>
00019 <span class="preprocessor">#include "fsal_convert.h"</span>
00020 <span class="preprocessor">#include "config_parsing.h"</span>
00021 <span class="preprocessor">#include &lt;string.h&gt;</span>
00022 
00023 <span class="comment">/* case unsensitivity */</span>
00024 <span class="preprocessor">#define STRCMP   strcasecmp</span>
00025 <span class="preprocessor"></span>
00026 <span class="keywordtype">char</span> * FSAL_GetFSName()
00027 {
00028         <span class="keywordflow">return</span> <span class="stringliteral">"POSIX"</span>;
00029 }
00030 
00031 
<a name="l00048"></a><a class="code" href="fsal__tools_8c.html#a3">00048</a> <span class="keywordtype">int</span> <a class="code" href="fsal__tools_8c.html#a3">FSAL_handlecmp</a>( fsal_handle_t * handle1, fsal_handle_t * handle2,
00049                     fsal_status_t * status ){
00050    
00051   
00052   fsal_u64_t  fileid1, fileid2;
00053   
00054   *status =  FSAL_STATUS_NO_ERROR;
00055    
00056   <span class="keywordflow">if</span> (!handle1 || !handle2 ){
00057     status-&gt;major = ERR_FSAL_FAULT ;
00058     <span class="keywordflow">return</span> -1;   
00059   }  
00060   
00061   <span class="keywordflow">return</span> (handle1-&gt;id != handle2-&gt;id) || (handle1-&gt;ts != handle2-&gt;ts);
00062        
00063 }
00064 
00065 
<a name="l00080"></a><a class="code" href="fsal__tools_8c.html#a4">00080</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fsal__tools_8c.html#a4">FSAL_Handle_to_HashIndex</a>( fsal_handle_t * p_handle,
00081                                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cookie,
00082                                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> alphabet_len,
00083                                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index_size)
00084 {
00085         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h;
00086         h = ( cookie * alphabet_len + ((<span class="keywordtype">unsigned</span> int)p_handle-&gt;id ^ (<span class="keywordtype">unsigned</span> int)p_handle-&gt;ts) );
00087         <span class="keywordflow">return</span> ( 3 * h + 1999 ) % index_size;
00088 }
00089 
00090 
00091 <span class="comment">/*</span>
00092 <span class="comment"> * FSAL_Handle_to_RBTIndex</span>
00093 <span class="comment"> * This function is used for generating a RBT node ID</span>
00094 <span class="comment"> * in order to identify entries into the RBT.</span>
00095 <span class="comment"> *</span>
00096 <span class="comment"> * \param p_handle      The handle to be hashed</span>
00097 <span class="comment"> * \param cookie        Makes it possible to have different hash value for the</span>
00098 <span class="comment"> *                      same handle, when cookie changes.</span>
00099 <span class="comment"> *</span>
00100 <span class="comment"> * \return The hash value</span>
00101 <span class="comment"> */</span>
00102 
00103 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> FSAL_Handle_to_RBTIndex( fsal_handle_t * p_handle, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cookie )
00104 {
00105 <span class="preprocessor">#define MAGIC   0xABCD1234</span>
00106 <span class="preprocessor"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h;
00107         h = ( cookie ^ (<span class="keywordtype">unsigned</span> int)p_handle-&gt;id ^ (<span class="keywordtype">unsigned</span> int)p_handle-&gt;ts ^ MAGIC );
00108         <span class="keywordflow">return</span> h;
00109 }
00110 
00111 
00112 
<a name="l00129"></a><a class="code" href="fsal__tools_8c.html#a6">00129</a> fsal_status_t <a class="code" href="fsal__tools_8c.html#a6">FSAL_DigestHandle</a>(
00130     fsal_export_context_t  * p_expcontext,      <span class="comment">/* IN */</span>
00131     fsal_digesttype_t        output_type,        <span class="comment">/* IN */</span>
00132     fsal_handle_t         *  p_in_fsal_handle,     <span class="comment">/* IN */</span>
00133     caddr_t                  out_buff            <span class="comment">/* OUT */</span>
00134 ){
00135   <span class="comment">/* sanity checks */</span>
00136   <span class="keywordflow">if</span> (!p_in_fsal_handle || !out_buff || !p_expcontext) ReturnCode( ERR_FSAL_FAULT ,0 );
00137   
00138   <span class="keywordflow">switch</span>(output_type){   
00139     
00140     <span class="comment">/* NFSV2 handle digest */</span>    
00141     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV2:
00142 
00143 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00144 <span class="preprocessor"></span>      <span class="comment">/* sanity check about output size */</span>
00145       
00146       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(fsal_u64_t) + <span class="keyword">sizeof</span>(int) &gt; FSAL_DIGEST_SIZE_HDLV2 )
00147         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00148 <span class="preprocessor">#endif</span>
00149 <span class="preprocessor"></span>      memset( out_buff, 0,FSAL_DIGEST_SIZE_HDLV2 );
00150       memcpy( out_buff, p_in_fsal_handle, <span class="keyword">sizeof</span>(fsal_u64_t) + <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) );
00151       <span class="keywordflow">break</span>;
00152 
00153     <span class="comment">/* NFSV3 handle digest */</span>    
00154     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV3:
00155       
00156 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00157 <span class="preprocessor"></span>      <span class="comment">/* sanity check about output size */</span>
00158       
00159       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(fsal_u64_t) + <span class="keyword">sizeof</span>(int) &gt; FSAL_DIGEST_SIZE_HDLV3 )
00160         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00161 <span class="preprocessor">#endif</span>
00162 <span class="preprocessor"></span>      memset( out_buff, 0, FSAL_DIGEST_SIZE_HDLV3 );
00163       memcpy( out_buff, p_in_fsal_handle, <span class="keyword">sizeof</span>(fsal_u64_t) + <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) );
00164       <span class="keywordflow">break</span>;
00165       
00166     <span class="comment">/* NFSV4 handle digest */</span>    
00167     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV4:
00168 
00169 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00170 <span class="preprocessor"></span>      <span class="comment">/* sanity check about output size */</span>
00171       
00172       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(fsal_u64_t) + <span class="keyword">sizeof</span>(int) &gt; FSAL_DIGEST_SIZE_HDLV4 )
00173         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00174 <span class="preprocessor">#endif</span>
00175 <span class="preprocessor"></span>      memset( out_buff, 0, FSAL_DIGEST_SIZE_HDLV4 );
00176       memcpy( out_buff, p_in_fsal_handle, <span class="keyword">sizeof</span>(fsal_u64_t) + <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) );
00177       <span class="keywordflow">break</span>;
00178 
00179 
00180     <span class="comment">/* FileId digest for NFSv2 */</span>
00181     <span class="keywordflow">case</span>  FSAL_DIGEST_FILEID2:      
00182       
00183 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00184 <span class="preprocessor"></span>      <span class="comment">/* sanity check about output size */</span>
00185       
00186       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(ino_t) &gt; FSAL_DIGEST_SIZE_FILEID2 )
00187         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00188 <span class="preprocessor">#endif</span>
00189 <span class="preprocessor"></span>      memset( out_buff, 0, FSAL_DIGEST_SIZE_FILEID2 );
00190       memcpy( out_buff, &amp;(p_in_fsal_handle-&gt;info.inode), <span class="keyword">sizeof</span>(ino_t) );
00191       
00192       <span class="keywordflow">break</span>;
00193       
00194       
00195     <span class="comment">/* FileId digest for NFSv3 */</span>
00196     <span class="keywordflow">case</span>  FSAL_DIGEST_FILEID3:
00197       
00198 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00199 <span class="preprocessor"></span>      <span class="comment">/* sanity check about output size */</span>
00200       
00201       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(ino_t) &gt; FSAL_DIGEST_SIZE_FILEID3 )
00202         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00203 <span class="preprocessor">#endif</span>
00204 <span class="preprocessor"></span>      memset( out_buff, 0, FSAL_DIGEST_SIZE_FILEID3 );
00205       memcpy( out_buff, &amp;(p_in_fsal_handle-&gt;info.inode), <span class="keyword">sizeof</span>(ino_t) );
00206       <span class="keywordflow">break</span>;
00207       
00208       
00209     <span class="comment">/* FileId digest for NFSv4 */</span>
00210       
00211     <span class="keywordflow">case</span>  FSAL_DIGEST_FILEID4:
00212 
00213 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00214 <span class="preprocessor"></span>      <span class="comment">/* sanity check about output size */</span>
00215       
00216       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(ino_t) &gt; FSAL_DIGEST_SIZE_FILEID4 )
00217         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00218 <span class="preprocessor">#endif</span>
00219 <span class="preprocessor"></span>      memset( out_buff, 0,FSAL_DIGEST_SIZE_FILEID4 );
00220       memcpy( out_buff, &amp;(p_in_fsal_handle-&gt;info.inode), <span class="keyword">sizeof</span>(ino_t) );
00221       <span class="keywordflow">break</span>;      
00222     
00223     <span class="comment">/* Nodetype digest. */</span>
00224     <span class="keywordflow">case</span> FSAL_DIGEST_NODETYPE:  
00225       
00226 <span class="preprocessor">#ifndef _NO_CHECKS</span>
00227 <span class="preprocessor"></span>      
00228       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(fsal_nodetype_t) &gt; FSAL_DIGEST_SIZE_NODETYPE )
00229         ReturnCode( ERR_FSAL_TOOSMALL, 0 );
00230 <span class="preprocessor">#endif</span>
00231 <span class="preprocessor"></span>      memset( out_buff,0,FSAL_DIGEST_SIZE_NODETYPE );
00232       memcpy( out_buff, &amp;(p_in_fsal_handle-&gt;info.ftype),<span class="keyword">sizeof</span>(fsal_nodetype_t) );
00233       <span class="keywordflow">break</span>;
00234     <span class="keywordflow">default</span>:
00235       ReturnCode( ERR_FSAL_SERVERFAULT ,0 );
00236 
00237   }
00238       
00239   ReturnCode(ERR_FSAL_NO_ERROR,0);
00240   
00241 }
00242 
00243 
00244 
<a name="l00260"></a><a class="code" href="fsal__tools_8c.html#a7">00260</a> fsal_status_t <a class="code" href="fsal__tools_8c.html#a7">FSAL_ExpandHandle</a>(
00261     fsal_export_context_t  * p_expcontext,    <span class="comment">/* IN */</span>
00262     fsal_digesttype_t        in_type,         <span class="comment">/* IN */</span>
00263     caddr_t                  in_buff,         <span class="comment">/* IN */</span>
00264     fsal_handle_t          * p_out_fsal_handle  <span class="comment">/* OUT */</span>
00265 ){
00266   
00267   <span class="comment">/* sanity checks */</span>
00268   <span class="keywordflow">if</span> (!p_out_fsal_handle || !in_buff || !p_expcontext) ReturnCode( ERR_FSAL_FAULT ,0 );
00269   
00270   <span class="keywordflow">switch</span>(in_type){   
00271     
00272     <span class="comment">/* NFSV2 handle digest */</span>    
00273     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV2:
00274       memset( p_out_fsal_handle, 0,<span class="keyword">sizeof</span>(fsal_handle_t) );
00275       memcpy( p_out_fsal_handle, in_buff, <span class="keyword">sizeof</span>(fsal_u64_t) + <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) );
00276       <span class="keywordflow">break</span>;
00277 
00278     <span class="comment">/* NFSV3 handle digest */</span>    
00279     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV3:
00280       memset( p_out_fsal_handle, 0,<span class="keyword">sizeof</span>(fsal_handle_t) );
00281       memcpy( p_out_fsal_handle, in_buff, <span class="keyword">sizeof</span>(fsal_u64_t) + <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) );
00282       <span class="keywordflow">break</span>;
00283       
00284     <span class="comment">/* NFSV4 handle digest */</span>    
00285     <span class="keywordflow">case</span>  FSAL_DIGEST_NFSV4:
00286       memset( p_out_fsal_handle, 0,<span class="keyword">sizeof</span>(fsal_handle_t) );
00287       memcpy( p_out_fsal_handle, in_buff, <span class="keyword">sizeof</span>(fsal_u64_t) + <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) );
00288       <span class="keywordflow">break</span>;
00289 
00290     <span class="keywordflow">default</span>:
00291       ReturnCode( ERR_FSAL_SERVERFAULT ,0 );
00292   }
00293   
00294   ReturnCode(ERR_FSAL_NO_ERROR,0);  
00295   
00296 }
00297 
00298 
00299 
00300 
00301 
<a name="l00309"></a><a class="code" href="fsal__tools_8c.html#a8">00309</a> fsal_status_t  <a class="code" href="fsal__tools_8c.html#a8">FSAL_SetDefault_FSAL_parameter</a>(
00310                              fsal_parameter_t *  out_parameter )
00311 {
00312 
00313   log_t   no_logging = LOG_INITIALIZER;
00314   
00315   <span class="comment">/* defensive programming... */</span>  
00316   <span class="keywordflow">if</span> ( out_parameter == NULL )
00317       ReturnCode( ERR_FSAL_FAULT, 0 );
00318   
00319   <span class="comment">/* init logging to no logging */</span>  
00320   out_parameter-&gt;fsal_info.log_outputs = no_logging;
00321   
00322   <span class="comment">/* init max FS calls = unlimited */</span>
00323   out_parameter-&gt;fsal_info.max_fs_calls = 0;
00324 
00325   ReturnCode( ERR_FSAL_NO_ERROR, 0 );    
00326   
00327 }
00328 
00329 
00330 fsal_status_t  FSAL_SetDefault_FS_common_parameter(
00331                              fsal_parameter_t *  out_parameter )
00332 {
00333   <span class="comment">/* defensive programming... */</span>  
00334   <span class="keywordflow">if</span> ( out_parameter == NULL )
00335       ReturnCode( ERR_FSAL_FAULT, 0 );
00336   
00337   <span class="comment">/* set default values for all parameters of fs_common_info */</span>
00338   
00339   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxfilesize );
00340   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxlink );
00341   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxnamelen );
00342   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxpathlen );
00343   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, no_trunc );
00344   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, chown_restricted );
00345   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, case_insensitive );
00346   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, case_preserving );
00347   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, fh_expire_type );
00348   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, link_support );
00349   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, symlink_support );  
00350   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, named_attr );
00351   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, unique_handles );
00352   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, lease_time );
00353   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, acl_support );
00354   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, cansettime );
00355   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, homogenous );
00356   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, supported_attrs );
00357   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxread );
00358   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, maxwrite );
00359   FSAL_SET_INIT_DEFAULT( out_parameter-&gt;fs_common_info, umask );
00360   
00361   ReturnCode( ERR_FSAL_NO_ERROR, 0 );  
00362     
00363 }
00364 
00365 
00366 
00367 
00368 fsal_status_t  FSAL_SetDefault_FS_specific_parameter(
00369                              fsal_parameter_t *  out_parameter )
00370 {
00371   <span class="comment">/* defensive programming... */</span>  
00372   <span class="keywordflow">if</span> ( out_parameter == NULL )
00373       ReturnCode( ERR_FSAL_FAULT, 0 );
00374   
00375   <span class="comment">/* set default values for all parameters of fs_specific_info */</span>
00376 
00377 <span class="preprocessor">#ifdef _USE_PGSQL</span>
00378 <span class="preprocessor"></span>
00379   <span class="comment">/* pgsql db */</span>
00380   strcpy(out_parameter-&gt;fs_specific_info.dbparams.host, <span class="stringliteral">"localhost"</span> );
00381   strcpy(out_parameter-&gt;fs_specific_info.dbparams.port, <span class="stringliteral">"5432"</span> );
00382   out_parameter-&gt;fs_specific_info.dbparams.dbname[0]=<span class="charliteral">'\0'</span>;
00383   out_parameter-&gt;fs_specific_info.dbparams.login[0]=<span class="charliteral">'\0'</span>;
00384   out_parameter-&gt;fs_specific_info.dbparams.passwdfile[0]=<span class="charliteral">'\0'</span>;
00385 
00386 <span class="preprocessor">#endif</span>
00387 <span class="preprocessor"></span>
00388   ReturnCode( ERR_FSAL_NO_ERROR, 0 );  
00389   
00390 }
00391 
00392 
00393 
00394 
00395 
00418 <span class="comment">/* load FSAL init info */</span>
00419  
<a name="l00420"></a><a class="code" href="fsal__tools_8c.html#a11">00420</a> fsal_status_t  <a class="code" href="fsal__tools_8c.html#a11">FSAL_load_FSAL_parameter_from_conf</a>(
00421       config_file_t       in_config,
00422       fsal_parameter_t *  out_parameter
00423     )
00424 {
00425   <span class="keywordtype">int</span>     err;
00426   <span class="keywordtype">int</span>     blk_index;
00427   <span class="keywordtype">int</span>     var_max, var_index;
00428   <span class="keywordtype">char</span> *  key_name;
00429   <span class="keywordtype">char</span> *  key_value;  
00430   
00431   <span class="keywordtype">int</span>  DebugLevel   = -1;
00432   <span class="keywordtype">char</span> * LogFile    = NULL;
00433 
00434   
00435   blk_index = config_GetBlockIndexByName( in_config, CONF_LABEL_FSAL );
00436 
00437   <span class="comment">/* cannot read item */</span>  
00438   
00439   <span class="keywordflow">if</span> ( blk_index &lt;0 ) {
00440     DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: Cannot read item \"%s\" from configuration file"</span>,
00441         CONF_LABEL_FSAL );
00442     ReturnCode( ERR_FSAL_NOENT, -blk_index );
00443   }
00444       
00445   <span class="comment">/* read variable for fsal init */</span>
00446   
00447   var_max = config_GetNbKeys( in_config, blk_index );
00448   
00449   <span class="keywordflow">for</span> ( var_index = 0; var_index &lt; var_max ; var_index ++ )
00450   {    
00451     
00452     <span class="comment">/* retrieve key's name */</span>
00453     err = config_GetKeyValue( 
00454                         in_config,
00455                         blk_index,
00456                         var_index,
00457                         &amp;key_name,
00458                         &amp;key_value
00459                        );
00460     <span class="keywordflow">if</span> ( err ){
00461       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR reading key[%d] from section \"%s\" of configuration file."</span>,
00462             var_index, CONF_LABEL_FSAL );
00463       ReturnCode( ERR_FSAL_SERVERFAULT, err );
00464     }
00465         
00466     <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"DebugLevel"</span> ) )
00467     {
00468       DebugLevel = ReturnLevelAscii( key_value );
00469       
00470       <span class="keywordflow">if</span> ( DebugLevel == -1 ){
00471         DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Invalid debug level name: \"%s\"."</span>,
00472               key_value );
00473         ReturnCode( ERR_FSAL_INVAL, -1 );        
00474       }
00475       
00476     }
00477     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"LogFile"</span> ) )
00478     {
00479       
00480       LogFile = key_value ;
00481       
00482     }
00483     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"Max_FS_calls"</span> ) )
00484     {
00485       
00486         <span class="keywordtype">int</span> maxcalls = s_read_int( key_value );
00487 
00488         <span class="keywordflow">if</span> ( maxcalls &lt; 0 )
00489         {
00490           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: null or positive integer expected."</span>,key_name);
00491           ReturnCode( ERR_FSAL_INVAL, 0 );
00492         }
00493            
00494         out_parameter-&gt;fsal_info.max_fs_calls = (<span class="keywordtype">unsigned</span> int) maxcalls;
00495       
00496     }
00497     <span class="keywordflow">else</span>
00498     {
00499       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unknown or unsettable key: %s (item %s)"</span>,
00500           key_name, CONF_LABEL_FSAL ) ;
00501       ReturnCode( ERR_FSAL_INVAL, 0 );
00502     }
00503 
00504   }
00505   
00506   <span class="comment">/* init logging */</span>
00507   
00508   <span class="keywordflow">if</span> ( LogFile )
00509   {
00510     desc_log_stream_t  log_stream;
00511     
00512     strcpy( log_stream.path , LogFile );
00513     
00514     <span class="comment">/* Default : NIV_CRIT */</span>
00515     
00516     <span class="keywordflow">if</span> ( DebugLevel == -1 )
00517       AddLogStreamJd( &amp;(out_parameter-&gt;fsal_info.log_outputs),
00518           V_FILE, log_stream, NIV_CRIT, SUP);
00519     <span class="keywordflow">else</span>         
00520       AddLogStreamJd( &amp;(out_parameter-&gt;fsal_info.log_outputs),
00521           V_FILE, log_stream, DebugLevel, SUP);
00522         
00523   }
00524 
00525   ReturnCode( ERR_FSAL_NO_ERROR, 0 );        
00526   
00527 } <span class="comment">/* FSAL_load_FSAL_parameter_from_conf */</span>
00528 
00529 
00530 
00531 <span class="comment">/* load general filesystem configuration options */</span>
00532 
00533 fsal_status_t  FSAL_load_FS_common_parameter_from_conf(
00534       config_file_t       in_config,
00535       fsal_parameter_t *  out_parameter
00536     )
00537 {
00538   <span class="keywordtype">int</span>     err;
00539   <span class="keywordtype">int</span>     blk_index;
00540   <span class="keywordtype">int</span>     var_max, var_index;
00541   <span class="keywordtype">char</span> *  key_name;
00542   <span class="keywordtype">char</span> *  key_value;  
00543   
00544   blk_index = config_GetBlockIndexByName( in_config, CONF_LABEL_FS_COMMON );
00545   
00546   <span class="comment">/* cannot read item */</span>  
00547   <span class="keywordflow">if</span> ( blk_index &lt;0 ) {
00548     DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: Cannot read item \"%s\" from configuration file"</span>,
00549         CONF_LABEL_FS_COMMON );
00550     ReturnCode( ERR_FSAL_NOENT, -blk_index );
00551   }
00552   
00553   <span class="comment">/*</span>
00554 <span class="comment">  configurable common info for filesystem are:</span>
00555 <span class="comment">  link_support      # hardlink support</span>
00556 <span class="comment">  symlink_support   # symlinks support</span>
00557 <span class="comment">  cansettime        # Is it possible to change file times</span>
00558 <span class="comment">  maxread           # Max read size from FS</span>
00559 <span class="comment">  maxwrite          # Max write size to FS</span>
00560 <span class="comment">  umask</span>
00561 <span class="comment">  */</span>
00562   
00563   var_max = config_GetNbKeys( in_config, blk_index );
00564   
00565   <span class="keywordflow">for</span> ( var_index = 0; var_index &lt; var_max ; var_index ++ )
00566   {
00567     
00568     
00569     <span class="comment">/* retrieve key's name */</span>
00570     err = config_GetKeyValue( 
00571                         in_config,
00572                         blk_index,
00573                         var_index,
00574                         &amp;key_name,
00575                         &amp;key_value
00576                        );
00577     <span class="keywordflow">if</span> ( err ){
00578       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR reading key[%d] from section \"%s\" of configuration file."</span>,
00579             var_index, CONF_LABEL_FS_COMMON );
00580       ReturnCode( ERR_FSAL_SERVERFAULT, err );
00581     }
00582     
00583     <span class="comment">/* does the variable exists ? */</span>
00584     <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"link_support"</span> ) )
00585       {
00586         
00587         <span class="keywordtype">int</span> <span class="keywordtype">bool</span> = StrToBoolean( key_value );
00588         
00589         <span class="keywordflow">if</span> ( <span class="keywordtype">bool</span> == -1 )
00590         {
00591           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: 0 or 1 expected."</span>,key_name);
00592           ReturnCode( ERR_FSAL_INVAL, 0 );
00593         }
00594         
00595         <span class="comment">/* if set to false, force value to false.</span>
00596 <span class="comment">         * else keep fs default.</span>
00597 <span class="comment">         */</span>
00598         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, link_support,
00599             FSAL_INIT_MAX_LIMIT, <span class="keywordtype">bool</span> );
00600             
00601       }
00602     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"symlink_support"</span> ) )
00603       {
00604         <span class="keywordtype">int</span> <span class="keywordtype">bool</span> = StrToBoolean( key_value );
00605         
00606         <span class="keywordflow">if</span> ( <span class="keywordtype">bool</span> == -1 )
00607         {
00608           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: 0 or 1 expected."</span>,key_name);
00609           ReturnCode( ERR_FSAL_INVAL, 0 );
00610         }
00611         
00612         <span class="comment">/* if set to false, force value to false.</span>
00613 <span class="comment">         * else keep fs default.</span>
00614 <span class="comment">         */</span>
00615         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, symlink_support,
00616             FSAL_INIT_MAX_LIMIT, <span class="keywordtype">bool</span> );
00617       }
00618     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"cansettime"</span> ) )
00619       {
00620         <span class="keywordtype">int</span> <span class="keywordtype">bool</span> = StrToBoolean( key_value );
00621         
00622         <span class="keywordflow">if</span> ( <span class="keywordtype">bool</span> == -1 )
00623         {
00624           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: 0 or 1 expected."</span>,key_name);
00625           ReturnCode( ERR_FSAL_INVAL, 0 );
00626         }
00627         
00628         <span class="comment">/* if set to false, force value to false.</span>
00629 <span class="comment">         * else keep fs default.</span>
00630 <span class="comment">         */</span>
00631         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, cansettime,
00632             FSAL_INIT_MAX_LIMIT, <span class="keywordtype">bool</span> );
00633         
00634       }
00635     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"maxread"</span> ) )
00636       {
00637         fsal_u64_t  size;
00638         
00639         <span class="keywordflow">if</span> ( s_read_int64( key_value , &amp;size ) )
00640         {
00641           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: positive integer expected."</span>,key_name);
00642           ReturnCode( ERR_FSAL_INVAL, 0 );
00643         }
00644         
00645         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, maxread,
00646             FSAL_INIT_FORCE_VALUE, size );
00647         
00648          
00649       }
00650     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"maxwrite"</span> ) )
00651       {
00652         fsal_u64_t  size;
00653         
00654         <span class="keywordflow">if</span> ( s_read_int64( key_value , &amp;size ) )
00655         {
00656           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: positive integer expected."</span>,key_name);
00657           ReturnCode( ERR_FSAL_INVAL, 0 );
00658         }
00659         
00660         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, maxwrite,
00661             FSAL_INIT_FORCE_VALUE, size );
00662                 
00663       }
00664     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"umask"</span> ) )
00665       {
00666         <span class="keywordtype">int</span> mode = s_read_octal( key_value );
00667         
00668         <span class="keywordflow">if</span> ( mode &lt; 0 )
00669         {
00670           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: octal expected."</span>,key_name);
00671           ReturnCode( ERR_FSAL_INVAL, 0 );
00672         }
00673         
00674         FSAL_SET_INIT_INFO( out_parameter-&gt;fs_common_info, umask,
00675             FSAL_INIT_FORCE_VALUE, <a class="code" href="fsal__convert_8c.html#a6">unix2fsal_mode</a>(mode) );
00676         
00677       }
00678     <span class="keywordflow">else</span>
00679     {
00680       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unknown or unsettable key: %s (item %s)"</span>,
00681           key_name, CONF_LABEL_FS_COMMON ) ;
00682       ReturnCode( ERR_FSAL_INVAL, 0 );
00683     }
00684         
00685   }
00686     
00687   ReturnCode( ERR_FSAL_NO_ERROR, 0 );    
00688     
00689 } <span class="comment">/* FSAL_load_FS_common_parameter_from_conf */</span>
00690 
00691 
00692 
00693 
00694 <span class="comment">/* load specific filesystem configuration options */</span>
00695 
00696 fsal_status_t  FSAL_load_FS_specific_parameter_from_conf(
00697       config_file_t       in_config,
00698       fsal_parameter_t *  out_parameter
00699     )
00700 {
00701   <span class="keywordtype">int</span>     err;
00702   <span class="keywordtype">int</span>     blk_index;
00703   <span class="keywordtype">int</span>     var_max, var_index;
00704   <span class="keywordtype">char</span> *  key_name;
00705   <span class="keywordtype">char</span> *  key_value;   
00706   
00707   blk_index = config_GetBlockIndexByName( in_config, CONF_LABEL_FS_SPECIFIC );
00708   
00709   <span class="comment">/* cannot read item */</span>  
00710   <span class="keywordflow">if</span> ( blk_index &lt;0 ) {
00711     DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: Cannot read item \"%s\" from configuration file"</span>,
00712         CONF_LABEL_FS_SPECIFIC );
00713     ReturnCode( ERR_FSAL_NOENT, -blk_index );
00714   }
00715  
00716   var_max = config_GetNbKeys( in_config, blk_index );
00717   
00718   <span class="keywordflow">for</span> ( var_index = 0; var_index &lt; var_max ; var_index ++ )
00719   {
00720     <span class="comment">/* retrieve key's name */</span>
00721     err = config_GetKeyValue( 
00722                         in_config,
00723                         blk_index,
00724                         var_index,
00725                         &amp;key_name,
00726                         &amp;key_value
00727                        );
00728     <span class="keywordflow">if</span> ( err ){
00729       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR reading key[%d] from section \"%s\" of configuration file."</span>,
00730             var_index, CONF_LABEL_FS_SPECIFIC );
00731       ReturnCode( ERR_FSAL_SERVERFAULT, err );
00732     }
00733     <span class="comment">/* does the variable exists ? */</span>
00734     <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"DB_Host"</span> ) ) {        
00735         strncpy(  out_parameter-&gt;fs_specific_info.dbparams.host,
00736                   key_value,
00737                   FSAL_MAX_DBHOST_NAME_LEN);
00738     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"DB_Port"</span> ) ) {
00739         <span class="keywordtype">int</span> port;
00740         port = atoi(key_value); <span class="comment">/* XXX: replace atoi by my_atoi ?! */</span>
00741         <span class="keywordflow">if</span> (port &lt;= 0 || port &gt; USHRT_MAX) {
00742           DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unexpected value for %s: positive integer (&lt; %i) expected."</span>,key_name, USHRT_MAX);
00743           ReturnCode( ERR_FSAL_INVAL, 0 );
00744         }
00745         strncpy(  out_parameter-&gt;fs_specific_info.dbparams.port,
00746                   key_value,
00747                   FSAL_MAX_DBPORT_STR_LEN);
00748     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"DB_Name"</span> ) ) {        
00749         strncpy(  out_parameter-&gt;fs_specific_info.dbparams.dbname,
00750                   key_value,
00751                   FSAL_MAX_DB_NAME_LEN);
00752     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"DB_Login"</span> ) ) { 
00753         strncpy(  out_parameter-&gt;fs_specific_info.dbparams.login,
00754                   key_value,
00755                   FSAL_MAX_DB_LOGIN_LEN);
00756     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !STRCMP( key_name, <span class="stringliteral">"DB_keytab"</span> ) ) {        
00757         strncpy(  out_parameter-&gt;fs_specific_info.dbparams.passwdfile,
00758                   key_value,
00759                   FSAL_MAX_PATH_LEN);
00760     } <span class="keywordflow">else</span> {
00761       DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: ERROR: Unknown or unsettable key: %s (item %s)"</span>,
00762           key_name, CONF_LABEL_FS_SPECIFIC ) ;
00763       ReturnCode( ERR_FSAL_INVAL, 0 );
00764     }       
00765   }  
00766    
00767   <span class="keywordflow">if</span> (out_parameter-&gt;fs_specific_info.dbparams.host[0] == <span class="charliteral">'\0'</span>
00768       || out_parameter-&gt;fs_specific_info.dbparams.dbname[0] == <span class="charliteral">'\0'</span>) {
00769     DisplayLog(<span class="stringliteral">"FSAL LOAD PARAMETER: DB_Host and DB_Name MUST be specified in the configuration file"</span>,
00770         CONF_LABEL_FS_SPECIFIC );
00771     ReturnCode( ERR_FSAL_NOENT, -blk_index );
00772   }
00773   
00774    ReturnCode( ERR_FSAL_NO_ERROR, 0 );  
00775     
00776 } <span class="comment">/* FSAL_load_FS_specific_parameter_from_conf */</span>
00777 
00778 
00779 
00780 
00781 
00782 
00783 
00784 
00785 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
