<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_dirs.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_dirs.c</h1><a href="fsal__dirs_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 <span class="preprocessor">#include "stuff_alloc.h"</span>
00022 <span class="preprocessor">#include &lt;string.h&gt;</span>
00023 
00024 
00025 
<a name="l00046"></a><a class="code" href="fsal__dirs_8c.html#a0">00046</a> fsal_status_t <a class="code" href="fsal__dirs_8c.html#a0">FSAL_opendir</a>(
00047     fsal_handle_t             * p_dir_handle,           <span class="comment">/* IN */</span>
00048     fsal_op_context_t         * p_context,            <span class="comment">/* IN */</span>
00049     fsal_dir_t                * p_dir_descriptor,       <span class="comment">/* OUT */</span>
00050     fsal_attrib_list_t        * p_dir_attributes        <span class="comment">/* [ IN/OUT ] */</span>
00051 ){
00052   <span class="keywordtype">int</span> rc, errsv;
00053   fsal_status_t status;
00054   fsal_posixdb_status_t statusdb;
00055 
00056   fsal_path_t         fsalpath;
00057   <span class="keyword">struct </span>stat         buffstat;
00058 
00059   <span class="comment">/* sanity checks</span>
00060 <span class="comment">   * note : dir_attributes is optionnal.</span>
00061 <span class="comment">   */</span>
00062   <span class="keywordflow">if</span> (!p_dir_handle || !p_context || !p_dir_descriptor)
00063     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_opendir);
00064 
00065   <span class="comment">/* get the path of the directory */</span>
00066   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_dir_handle, 1, &amp;fsalpath, &amp;buffstat);
00067   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_opendir);
00068   
00069   <span class="comment">/* Test access rights for this directory */</span>
00070     
00071   status = fsal_internal_testAccess( p_context, FSAL_R_OK, &amp;buffstat, NULL);
00072   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major,status.minor,INDEX_FSAL_opendir);
00073   
00074   <span class="comment">/* if everything is OK, fills the dir_desc structure : */</span>
00075   
00076   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00077   p_dir_descriptor-&gt;p_dir = opendir(fsalpath.path);
00078   ReleaseTokenFSCall();
00079   <span class="keywordflow">if</span> ( !p_dir_descriptor-&gt;p_dir ) 
00080       Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errno) ,errno , INDEX_FSAL_opendir);
00081       
00082   memcpy( &amp;(p_dir_descriptor-&gt;context) , p_context, <span class="keyword">sizeof</span>(fsal_op_context_t));
00083   memcpy( &amp;(p_dir_descriptor-&gt;path) , &amp;fsalpath, <span class="keyword">sizeof</span>(fsal_path_t));
00084   memcpy( &amp;(p_dir_descriptor-&gt;handle) , p_dir_handle, <span class="keyword">sizeof</span>(fsal_handle_t));
00085 
00086 <span class="preprocessor">#ifdef _USE_POSIXDB_READDIR_BLOCK</span>
00087 <span class="preprocessor"></span>  p_dir_descriptor-&gt;p_dbentries = NULL;
00088   p_dir_descriptor-&gt;dbentries_count = 0;
00089   <span class="comment">/* fill the p_dbentries list */</span>
00090   statusdb = fsal_posixdb_getChildren( p_dir_descriptor-&gt;context.p_conn,
00091                                   &amp;(p_dir_descriptor-&gt;handle),
00092                                   FSAL_POSIXDB_MAXREADDIRBLOCKSIZE,
00093                                   &amp;(p_dir_descriptor-&gt;p_dbentries),
00094                                   &amp;(p_dir_descriptor-&gt;dbentries_count)
00095   );
00096   <span class="keywordflow">if</span> (FSAL_POSIXDB_IS_ERROR(statusdb)) <span class="comment">/* too many entries in the directory, or another error */</span>
00097     p_dir_descriptor-&gt;dbentries_count = -1;
00098 
00099 <span class="preprocessor">#endif</span>
00100 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ( p_dir_attributes ) {
00101     
00102     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00103     rc = lstat(fsalpath.path, &amp;buffstat);
00104     errsv = errno;
00105     ReleaseTokenFSCall();
00106     <span class="keywordflow">if</span> ( rc ) <span class="comment">/* lstat failed */</span>
00107       <span class="keywordflow">goto</span> attr_err;
00108     
00109     status = posix2fsal_attributes(&amp;buffstat, p_dir_attributes);
00110     <span class="keywordflow">if</span> ( FSAL_IS_ERROR(status) ) {
00111 attr_err:
00112       FSAL_CLEAR_MASK( p_dir_attributes-&gt;asked_attributes );
00113       FSAL_SET_MASK( p_dir_attributes-&gt;asked_attributes,
00114           FSAL_ATTR_RDATTR_ERR );
00115     }
00116   }
00117     
00118   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_opendir );
00119 
00120 }
00121 
00122 
00123 
<a name="l00157"></a><a class="code" href="fsal__dirs_8c.html#a1">00157</a> fsal_status_t <a class="code" href="fsal__dirs_8c.html#a1">FSAL_readdir</a>(
00158     fsal_dir_t            * p_dir_descriptor,     <span class="comment">/* IN */</span>
00159     fsal_cookie_t         start_position ,      <span class="comment">/* IN */</span>
00160     fsal_attrib_mask_t    get_attr_mask,        <span class="comment">/* IN */</span>
00161     fsal_mdsize_t         buffersize,           <span class="comment">/* IN */</span>
00162     fsal_dirent_t         * p_pdirent,            <span class="comment">/* OUT */</span>
00163     fsal_cookie_t         * p_end_position,       <span class="comment">/* OUT */</span>
00164     fsal_count_t          * p_nb_entries,         <span class="comment">/* OUT */</span>
00165     fsal_boolean_t        * p_end_of_dir          <span class="comment">/* OUT */</span>
00166 ){
00167   fsal_status_t st;
00168   fsal_posixdb_status_t stdb;
00169   fsal_count_t  max_dir_entries;
00170   <span class="keyword">struct </span>dirent *dp;
00171   <span class="keyword">struct </span>dirent dpe;
00172   <span class="keyword">struct </span>stat   buffstat;
00173   fsal_path_t   fsalpath;
00174   fsal_posixdb_fileinfo_t infofs;
00175   <span class="keywordtype">int</span> rc;
00176 
00177   <span class="comment">/*****************/</span>
00178   <span class="comment">/* sanity checks */</span>
00179   <span class="comment">/*****************/</span>
00180   
00181   <span class="keywordflow">if</span> ( !p_dir_descriptor || !p_pdirent || !p_end_position
00182         || !p_nb_entries || !p_end_of_dir )
00183     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_readdir);
00184  
00185   max_dir_entries = (buffersize / <span class="keyword">sizeof</span>(fsal_dirent_t));
00186 
00187   <span class="comment">/***************************/</span>
00188   <span class="comment">/* seek into the directory */</span>
00189   <span class="comment">/***************************/</span>
00190   errno = 0;
00191   <span class="keywordflow">if</span> (start_position.cookie == 0) {
00192     rewinddir( p_dir_descriptor-&gt;p_dir );
00193     rc = errno;
00194   } <span class="keywordflow">else</span> {
00195     seekdir( p_dir_descriptor-&gt;p_dir, start_position.cookie );
00196     rc = errno;
00197   }
00198   
00199   <span class="keywordflow">if</span> ( rc ) {
00200     st.major = <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(rc);
00201     st.minor = rc;
00202     <span class="keywordflow">goto</span> readdir_error;
00203   }
00204   
00205   <span class="comment">/************************/</span>
00206   <span class="comment">/* browse the directory */</span>
00207   <span class="comment">/************************/</span>
00208 
00209 *p_nb_entries = 0;
00210   <span class="keywordflow">while</span> (*p_nb_entries &lt; max_dir_entries)
00211   {
00212     <span class="comment">/***********************/</span>
00213     <span class="comment">/* read the next entry */</span>
00214     <span class="comment">/***********************/</span>
00215     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00216     rc = readdir_r(p_dir_descriptor-&gt;p_dir, &amp;dpe, &amp;dp);
00217     ReleaseTokenFSCall();
00218     <span class="keywordflow">if</span> ( rc ) {
00219       st.major = <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errno);
00220       st.minor = errno;
00221       <span class="keywordflow">goto</span> readdir_error;
00222     } <span class="comment">/* End of directory */</span>
00223     <span class="keywordflow">if</span> (!dp) {
00224       *p_end_of_dir = 1;
00225       <span class="keywordflow">break</span>;
00226     }
00227     
00228     <span class="comment">/***********************************/</span>
00229     <span class="comment">/* Get information about the entry */</span>
00230     <span class="comment">/***********************************/</span>
00231 
00232     <span class="comment">/* build the full path of the file into "fsalpath */</span>
00233     <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = <a class="code" href="group__FSALNameFunctions.html#ga0">FSAL_str2name</a>(dp-&gt;d_name, FSAL_MAX_NAME_LEN, &amp;(p_pdirent[*p_nb_entries].name)))) 
00234       <span class="keywordflow">goto</span> readdir_error;
00235     memcpy(&amp;fsalpath, &amp;(p_dir_descriptor-&gt;path), <span class="keyword">sizeof</span>(fsal_path_t));
00236     st = <a class="code" href="fsal__internal_8c.html#a22">fsal_internal_appendFSALNameToFSALPath</a>(&amp;fsalpath, &amp;(p_pdirent[*p_nb_entries].name));
00237     <span class="keywordflow">if</span> (FSAL_IS_ERROR(st))
00238       <span class="keywordflow">goto</span> readdir_error;
00239     
00240     <span class="comment">/* get object info */</span>
00241     <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00242     rc = lstat(fsalpath.path, &amp;buffstat);
00243     ReleaseTokenFSCall();
00244     <span class="keywordflow">if</span> ( rc ) {
00245       st.major = <a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errno);
00246       st.minor = errno;
00247       <span class="keywordflow">goto</span> readdir_error;
00248     }
00249     <span class="keywordflow">if</span> (FSAL_IS_ERROR( st = <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>(&amp;buffstat, &amp;infofs) ) )
00250       <span class="keywordflow">goto</span> readdir_error;
00251 
00252     <span class="comment">/********************/</span>
00253     <span class="comment">/* fills the handle */</span>
00254     <span class="comment">/********************/</span>
00255 
00256     <span class="comment">/* check for "." and ".." */</span>
00257     <span class="keywordflow">if</span> ( !strcmp(dp-&gt;d_name, <span class="stringliteral">"."</span>) ) {
00258       memcpy( &amp;(p_pdirent[*p_nb_entries].handle), &amp;(p_dir_descriptor-&gt;handle), <span class="keyword">sizeof</span>(fsal_handle_t) );
00259     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !strcmp(dp-&gt;d_name, <span class="stringliteral">".."</span>) ) {
00260       stdb = fsal_posixdb_getParentDirHandle( p_dir_descriptor-&gt;context.p_conn,
00261                                               &amp;(p_dir_descriptor-&gt;handle),
00262                                               &amp;(p_pdirent[*p_nb_entries].handle)
00263                                             );
00264       <span class="keywordflow">if</span> (FSAL_POSIXDB_IS_ERROR(stdb) &amp;&amp; FSAL_IS_ERROR(st = <a class="code" href="fsal__convert_8c.html#a12">posixdb2fsal_error</a>(stdb))) 
00265         <span class="keywordflow">goto</span> readdir_error;
00266     } <span class="keywordflow">else</span> {
00267 <span class="preprocessor">#ifdef _USE_POSIXDB_READDIR_BLOCK</span>
00268 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( p_dir_descriptor-&gt;dbentries_count &gt; -1 ) { <span class="comment">/* look for the entry in dbentries */</span>
00269         st = <a class="code" href="fsal__internal_8c.html#a25">fsal_internal_getInfoFromChildrenList</a>( &amp;(p_dir_descriptor-&gt;context), 
00270                                                     &amp;(p_dir_descriptor-&gt;handle), 
00271                                                     &amp;(p_pdirent[*p_nb_entries].name), 
00272                                                     &amp;infofs, 
00273                                                     p_dir_descriptor-&gt;p_dbentries,
00274                                                     p_dir_descriptor-&gt;dbentries_count,
00275                                                     &amp;(p_pdirent[*p_nb_entries].handle));
00276       } <span class="keywordflow">else</span>
00277 <span class="preprocessor">#endif</span>
00278 <span class="preprocessor"></span>      { <span class="comment">/* get handle for the entry */</span>
00279         st = <a class="code" href="fsal__internal_8c.html#a24">fsal_internal_getInfoFromName</a>( &amp;(p_dir_descriptor-&gt;context), 
00280                                             &amp;(p_dir_descriptor-&gt;handle), 
00281                                             &amp;(p_pdirent[*p_nb_entries].name), 
00282                                             &amp;infofs, 
00283                                             &amp;(p_pdirent[*p_nb_entries].handle));
00284       }
00285       <span class="keywordflow">if</span> (FSAL_IS_ERROR(st))
00286         <span class="keywordflow">goto</span> readdir_error;
00287     } <span class="comment">/* end of name check for "." and ".." */</span>
00288 
00289     <span class="comment">/************************</span>
00290 <span class="comment">     * Fills the attributes *</span>
00291 <span class="comment">     ************************/</span>
00292     p_pdirent[*p_nb_entries].attributes.asked_attributes = get_attr_mask;
00293     st = posix2fsal_attributes( &amp;buffstat, &amp;(p_pdirent[*p_nb_entries].attributes) );
00294     <span class="keywordflow">if</span> (FSAL_IS_ERROR(st))
00295       <span class="keywordflow">goto</span> readdir_error;
00296 
00297     <span class="comment">/*</span>
00298 <span class="comment">     * </span>
00299 <span class="comment">     **/</span>
00300     p_pdirent[*p_nb_entries].cookie.cookie = telldir(p_dir_descriptor-&gt;p_dir);
00301     p_pdirent[*p_nb_entries].nextentry = NULL;
00302     <span class="keywordflow">if</span> (*p_nb_entries) 
00303       p_pdirent[*p_nb_entries - 1].nextentry = &amp;(p_pdirent[*p_nb_entries]);
00304     
00305     (*p_end_position) = p_pdirent[*p_nb_entries].cookie;
00306     (*p_nb_entries) ++;
00307   };
00308   
00309   
00310   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_readdir );
00311 
00312   <span class="comment">/* return error, and free what must be freed */</span>
00313 readdir_error:
00314   Return(st.major, st.minor, INDEX_FSAL_readdir);
00315 }
00316 
00317 
00318 
<a name="l00330"></a><a class="code" href="fsal__dirs_8c.html#a2">00330</a> fsal_status_t <a class="code" href="fsal__dirs_8c.html#a2">FSAL_closedir</a>(
00331     fsal_dir_t * p_dir_descriptor         <span class="comment">/* IN */</span>
00332 ){
00333   
00334   <span class="keywordtype">int</span> rc;
00335   
00336   <span class="comment">/* sanity checks */</span>
00337   <span class="keywordflow">if</span> ( !p_dir_descriptor )
00338     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_closedir);
00339   
00340 <span class="preprocessor">  #ifdef _USE_POSIXDB_READDIR_BLOCK</span>
00341 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (p_dir_descriptor-&gt;p_dbentries) Mem_Free(p_dir_descriptor-&gt;p_dbentries); 
00342 <span class="preprocessor">  #endif</span>
00343 <span class="preprocessor"></span>
00344   rc = closedir( p_dir_descriptor-&gt;p_dir );
00345   <span class="keywordflow">if</span> (rc != 0)
00346       Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errno) ,errno , INDEX_FSAL_closedir);
00347   
00348   <span class="comment">/* fill dir_descriptor with zeros */</span>
00349   memset( p_dir_descriptor , 0, <span class="keyword">sizeof</span>(fsal_dir_t) );
00350     
00351   Return( ERR_FSAL_NO_ERROR, 0 ,INDEX_FSAL_closedir );
00352   
00353 }
00354 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
