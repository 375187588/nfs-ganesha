<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>File System Abstraction Layer (POSIX) library: fsal_unlink.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>fsal_unlink.c</h1><a href="fsal__unlink_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> */</span>
00004 
00014 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#include "fsal.h"</span>
00019 <span class="preprocessor">#include "fsal_internal.h"</span>
00020 <span class="preprocessor">#include "fsal_convert.h"</span>
00021 
00022 
<a name="l00046"></a><a class="code" href="fsal__unlink_8c.html#a0">00046</a> fsal_status_t <a class="code" href="fsal__unlink_8c.html#a0">FSAL_unlink</a>(
00047     fsal_handle_t           * p_parent_directory_handle,     <span class="comment">/* IN */</span>
00048     fsal_name_t             * p_object_name,        <span class="comment">/* IN */</span>
00049     fsal_op_context_t       * p_context,                 <span class="comment">/* IN */</span>
00050     fsal_attrib_list_t      * p_parent_directory_attributes  <span class="comment">/* [IN/OUT ] */</span>
00051 ){
00052 
00053   fsal_status_t status;
00054   fsal_posixdb_status_t statusdb;
00055   <span class="keywordtype">int</span> rc, errsv;
00056   <span class="keyword">struct </span>stat buffstat, buffstat_parent; 
00057   fsal_path_t fsalpath;
00058   fsal_posixdb_fileinfo_t info;
00059   <span class="keywordtype">int</span> is_dir;
00060   
00061   <span class="comment">/* sanity checks. */</span>
00062   <span class="keywordflow">if</span> ( !p_parent_directory_handle || !p_context || !p_object_name)
00063     Return(ERR_FSAL_FAULT ,0 , INDEX_FSAL_unlink);
00064   
00065   <span class="comment">/* check credential */</span>
00066   <span class="comment">/* need to be able to 'read' the parent directory &amp; to delete it */</span>
00067   
00068   
00069   <span class="comment">/* build the destination path */</span>
00070   status = <a class="code" href="fsal__internal_8c.html#a23">fsal_internal_getPathFromHandle</a>(p_context, p_parent_directory_handle, 1, &amp;fsalpath, &amp;buffstat_parent);
00071   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_unlink);
00072   
00073   status = <a class="code" href="fsal__internal_8c.html#a22">fsal_internal_appendFSALNameToFSALPath</a>(&amp;fsalpath, p_object_name);
00074   <span class="keywordflow">if</span> (FSAL_IS_ERROR(status)) Return(status.major, status.minor, INDEX_FSAL_unlink);
00075   
00076   <span class="comment">/* </span>
00077 <span class="comment">   *  Action depends on the object type to be deleted.</span>
00078 <span class="comment">   */</span>
00079 
00080   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00081   rc = lstat(fsalpath.path, &amp;buffstat);
00082   errsv = errno;
00083   ReleaseTokenFSCall();
00084   <span class="keywordflow">if</span> ( rc ) Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_unlink);
00085 
00086   <span class="keywordflow">if</span> (FSAL_IS_ERROR( status = <a class="code" href="fsal__internal_8c.html#a20">fsal_internal_posix2posixdb_fileinfo</a>(&amp;buffstat, &amp;info) ) )
00087     Return(status.major, status.minor, INDEX_FSAL_unlink);
00088 
00089   <span class="comment">/**************************************************************</span>
00090 <span class="comment">   * Lock the handle entry related to this file in the database *</span>
00091 <span class="comment">   **************************************************************/</span>
00092   
00093   statusdb = fsal_posixdb_lockHandleForUpdate( p_context-&gt;p_conn, &amp;info);
00094   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(status = <a class="code" href="fsal__convert_8c.html#a12">posixdb2fsal_error</a>(statusdb)) ) {
00095     fsal_posixdb_cancelHandleLock( p_context-&gt;p_conn );
00096     Return(status.major, status.minor, INDEX_FSAL_unlink);
00097   }
00098   
00099   <span class="comment">/****************</span>
00100 <span class="comment">   * CHECK ACCESS *</span>
00101 <span class="comment">   ****************/</span>
00102   <span class="keywordflow">if</span> ( (buffstat_parent.st_mode &amp; S_ISVTX) <span class="comment">/* Sticky bit on the directory =&gt; the user who wants to delete the file must own it or its parent dir */</span>
00103        &amp;&amp; buffstat_parent.st_uid != p_context-&gt;credential.user 
00104        &amp;&amp; buffstat.st_uid != p_context-&gt;credential.user 
00105        &amp;&amp; p_context-&gt;credential.user != 0 ) {
00106     fsal_posixdb_cancelHandleLock( p_context-&gt;p_conn );
00107     Return(ERR_FSAL_ACCESS, 0, INDEX_FSAL_unlink);
00108   }
00109   
00110   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( status = fsal_internal_testAccess( p_context, FSAL_W_OK | FSAL_X_OK, &amp;buffstat_parent, NULL ) ) ) {
00111     fsal_posixdb_cancelHandleLock( p_context-&gt;p_conn );
00112     Return(status.major, status.minor, INDEX_FSAL_unlink);
00113   }
00114   
00115 
00116   <span class="comment">/******************************</span>
00117 <span class="comment">   * DELETE FROM THE FILESYSTEM *</span>
00118 <span class="comment">   ******************************/</span>
00119   <a class="code" href="fsal__internal_8c.html#a17">TakeTokenFSCall</a>();
00120   <span class="comment">/* If the object to delete is a directory, use 'rmdir' to delete the object, else use 'unlink' */</span>
00121   rc = (S_ISDIR(buffstat.st_mode)) ? rmdir(fsalpath.path) : unlink(fsalpath.path);
00122   errsv = errno;
00123   ReleaseTokenFSCall();
00124   <span class="keywordflow">if</span> ( rc ){
00125     fsal_posixdb_cancelHandleLock( p_context-&gt;p_conn );
00126     Return(<a class="code" href="fsal__convert_8c.html#a2">posix2fsal_error</a>(errsv), errsv, INDEX_FSAL_unlink);
00127   }
00128   
00129 
00130 
00131   <span class="comment">/****************************</span>
00132 <span class="comment">   * DELETE FROM THE DATABASE *</span>
00133 <span class="comment">   ****************************/</span>
00134 
00135   <span class="comment">/* We have to delete the path from the database, and the handle if the object was a directory or has no more hardlink */</span>
00136   statusdb = fsal_posixdb_delete( p_context-&gt;p_conn, p_parent_directory_handle, p_object_name, &amp;info );
00137   <span class="comment">/* After this operation, there's no need to 'fsal_posixdb_cancelHandleLock' because the transaction is ended */</span>
00138   <span class="keywordflow">switch</span> (statusdb.major) {
00139     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_NOERR:
00140     <span class="keywordflow">case</span> ERR_FSAL_POSIXDB_NOENT:
00141       <span class="comment">/* nothing to do */</span>
00142       <span class="keywordflow">break</span>;
00143     <span class="keywordflow">default</span>:
00144       <span class="keywordflow">if</span> ( FSAL_IS_ERROR(status = <a class="code" href="fsal__convert_8c.html#a12">posixdb2fsal_error</a>(statusdb)) ) Return(status.major, status.minor, INDEX_FSAL_unlink);
00145   }
00146   
00147   <span class="comment">/***********************</span>
00148 <span class="comment">   * FILL THE ATTRIBUTES *</span>
00149 <span class="comment">   ***********************/</span>
00150 
00151   <span class="keywordflow">if</span> ( p_parent_directory_attributes ) {
00152     status = posix2fsal_attributes(&amp;buffstat_parent, p_parent_directory_attributes);
00153     <span class="keywordflow">if</span> ( FSAL_IS_ERROR(status) ) {
00154       FSAL_CLEAR_MASK( p_parent_directory_attributes-&gt;asked_attributes );
00155       FSAL_SET_MASK( p_parent_directory_attributes-&gt;asked_attributes,
00156           FSAL_ATTR_RDATTR_ERR );
00157       Return( status.major, status.minor, INDEX_FSAL_opendir);
00158     }
00159   }
00160   <span class="comment">/* OK */</span>
00161   Return(ERR_FSAL_NO_ERROR ,0 , INDEX_FSAL_unlink);
00162   
00163 }
00164 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:45 2008 for File System Abstraction Layer (POSIX) library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
