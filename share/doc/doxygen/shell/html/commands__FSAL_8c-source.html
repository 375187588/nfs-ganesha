<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ganeshell: commands_FSAL.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>commands_FSAL.c</h1><a href="commands__FSAL_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Ce logiciel est un serveur implementant le protocole NFS.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * Ce logiciel est régi par la licence CeCILL soumise au droit français et</span>
00012 <span class="comment"> * respectant les principes de diffusion des logiciels libres. Vous pouvez</span>
00013 <span class="comment"> * utiliser, modifier et/ou redistribuer ce programme sous les conditions</span>
00014 <span class="comment"> * de la licence CeCILL telle que diffusée par le CEA, le CNRS et l'INRIA</span>
00015 <span class="comment"> * sur le site "http://www.cecill.info".</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * En contrepartie de l'accessibilité au code source et des droits de copie,</span>
00018 <span class="comment"> * de modification et de redistribution accordés par cette licence, il n'est</span>
00019 <span class="comment"> * offert aux utilisateurs qu'une garantie limitée.  Pour les mêmes raisons,</span>
00020 <span class="comment"> * seule une responsabilité restreinte pèse sur l'auteur du programme,  le</span>
00021 <span class="comment"> * titulaire des droits patrimoniaux et les concédants successifs.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * A cet égard  l'attention de l'utilisateur est attirée sur les risques</span>
00024 <span class="comment"> * associés au chargement,  à l'utilisation,  à la modification et/ou au</span>
00025 <span class="comment"> * développement et à la reproduction du logiciel par l'utilisateur étant</span>
00026 <span class="comment"> * donné sa spécificité de logiciel libre, qui peut le rendre complexe à</span>
00027 <span class="comment"> * manipuler et qui le réserve donc à des développeurs et des professionnels</span>
00028 <span class="comment"> * avertis possédant  des  connaissances  informatiques approfondies.  Les</span>
00029 <span class="comment"> * utilisateurs sont donc invités à charger  et  tester  l'adéquation  du</span>
00030 <span class="comment"> * logiciel à leurs besoins dans des conditions permettant d'assurer la</span>
00031 <span class="comment"> * sécurité de leurs systèmes et ou de leurs données et, plus généralement,</span>
00032 <span class="comment"> * à l'utiliser et l'exploiter dans les mêmes conditions de sécurité.</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> * Le fait que vous puissiez accéder à cet en-tête signifie que vous avez</span>
00035 <span class="comment"> * pris connaissance de la licence CeCILL, et que vous en avez accepté les</span>
00036 <span class="comment"> * termes.</span>
00037 <span class="comment"> *</span>
00038 <span class="comment"> * ---------------------</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * Copyright CEA/DAM/DIF (2005)</span>
00041 <span class="comment"> *  Contributor: Philippe DENIEL  philippe.deniel@cea.fr</span>
00042 <span class="comment"> *               Thomas LEIBOVICI thomas.leibovici@cea.fr</span>
00043 <span class="comment"> *</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> * This software is a server that implements the NFS protocol.</span>
00046 <span class="comment"> * </span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> * This software is governed by the CeCILL  license under French law and</span>
00049 <span class="comment"> * abiding by the rules of distribution of free software.  You can  use,</span>
00050 <span class="comment"> * modify and/ or redistribute the software under the terms of the CeCILL</span>
00051 <span class="comment"> * license as circulated by CEA, CNRS and INRIA at the following URL</span>
00052 <span class="comment"> * "http://www.cecill.info".</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> * As a counterpart to the access to the source code and  rights to copy,</span>
00055 <span class="comment"> * modify and redistribute granted by the license, users are provided only</span>
00056 <span class="comment"> * with a limited warranty  and the software's author,  the holder of the</span>
00057 <span class="comment"> * economic rights,  and the successive licensors  have only  limited</span>
00058 <span class="comment"> * liability.</span>
00059 <span class="comment"> *</span>
00060 <span class="comment"> * In this respect, the user's attention is drawn to the risks associated</span>
00061 <span class="comment"> * with loading,  using,  modifying and/or developing or reproducing the</span>
00062 <span class="comment"> * software by the user in light of its specific status of free software,</span>
00063 <span class="comment"> * that may mean  that it is complicated to manipulate,  and  that  also</span>
00064 <span class="comment"> therefore means  that it is reserved for developers  and  experienced</span>
00065 <span class="comment"> * professionals having in-depth computer knowledge. Users are therefore</span>
00066 <span class="comment"> * encouraged to load and test the software's suitability as regards their</span>
00067 <span class="comment"> * requirements in conditions enabling the security of their systems and/or</span>
00068 <span class="comment"> * data to be ensured and,  more generally, to use and operate it in the</span>
00069 <span class="comment"> * same conditions as regards security.</span>
00070 <span class="comment"> *</span>
00071 <span class="comment"> * The fact that you are presently reading this means that you have had</span>
00072 <span class="comment"> * knowledge of the CeCILL license and that you accept its terms.</span>
00073 <span class="comment"> * ---------------------------------------</span>
00074 <span class="comment"> */</span>
00075 
00270 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00271 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00272 <span class="preprocessor">#endif</span>
00273 <span class="preprocessor"></span>
00274  
00275 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00276 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00277 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00278 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00279 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00280 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00281 <span class="preprocessor">#include &lt;time.h&gt;</span>
00282 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00283 <span class="preprocessor">#include &lt;string.h&gt;</span>
00284 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
00285 <span class="preprocessor">#include "fsal.h"</span>
00286 <span class="preprocessor">#include "log_functions.h"</span>
00287 <span class="preprocessor">#include "err_ghost_fs.h"</span>
00288 <span class="preprocessor">#include "config_parsing.h"</span>
00289 <span class="preprocessor">#include "<a class="code" href="cmd__tools_8h.html">cmd_tools.h</a>"</span>
00290 <span class="preprocessor">#include "<a class="code" href="commands_8h.html">commands.h</a>"</span>
00291 <span class="preprocessor">#include "<a class="code" href="Getopt_8h.html">Getopt.h</a>"</span>
00292 <span class="preprocessor">#include "stuff_alloc.h"</span>
00293 
00294 <span class="comment">/* global FS configuration variables */</span>
00295 
00296 <span class="keyword">static</span> pthread_mutex_t mutex_log = PTHREAD_MUTEX_INITIALIZER;
00297 
00298 <span class="keyword">static</span> desc_log_stream_t  voie;
00299 <span class="keyword">static</span> <span class="keywordtype">int</span> log_level = -1;
00300 <span class="keyword">static</span> log_t log_desc = LOG_INITIALIZER;
00301 
00302 <span class="keyword">static</span> <span class="keywordtype">int</span> is_loaded = FALSE; <span class="comment">/* filsystem initialization status */</span>
00303 
00304 <span class="comment">/* thread specific configuration variables */</span>
00305 
<a name="l00306"></a><a class="code" href="structcmdfsal__thr__info____.html">00306</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info__</a>
00307 {
<a name="l00308"></a><a class="code" href="structcmdfsal__thr__info____.html#o0">00308</a>   <span class="keywordtype">int</span> is_thread_ok;           <span class="comment">/* per thread initialization status */</span>
<a name="l00309"></a><a class="code" href="structcmdfsal__thr__info____.html#o1">00309</a>   fsal_handle_t current_dir ; <span class="comment">/* current directory handle*/</span>
<a name="l00310"></a><a class="code" href="structcmdfsal__thr__info____.html#o2">00310</a>   <span class="keywordtype">char</span> current_path[FSAL_MAX_PATH_LEN]; <span class="comment">/* current path */</span>
00311 
00312   <span class="comment">/* thread's context */</span>
<a name="l00313"></a><a class="code" href="structcmdfsal__thr__info____.html#o3">00313</a>   fsal_op_context_t     context;
00314   
00315   <span class="comment">/* export context : on for each thread,</span>
00316 <span class="comment">   * on order to make it possible for them</span>
00317 <span class="comment">   * to access different filesets.</span>
00318 <span class="comment">   */</span>
<a name="l00319"></a><a class="code" href="structcmdfsal__thr__info____.html#o4">00319</a>   fsal_export_context_t exp_context;
<a name="l00320"></a><a class="code" href="structcmdfsal__thr__info____.html#o5">00320</a>   <span class="keywordtype">int</span> opened;                 <span class="comment">/* is file opened ? */</span>
<a name="l00321"></a><a class="code" href="structcmdfsal__thr__info____.html#o6">00321</a>   fsal_file_t current_fd;     <span class="comment">/* current file descriptor */</span>
00322   
00323 } <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a>;
00324 
00325 <span class="comment">/* pthread key to manage thread specific configuration */</span>
00326 
00327 <span class="keyword">static</span> pthread_key_t  thread_key ;
00328 <span class="keyword">static</span> pthread_once_t once_key = PTHREAD_ONCE_INIT ;
00329 
00330 
00331 <span class="comment">/* init pthtread_key for current thread */</span>
00332 
00333 <span class="keyword">static</span> <span class="keywordtype">void</span> init_keys( <span class="keywordtype">void</span> )
00334 {
00335   <span class="keywordflow">if</span>( pthread_key_create( &amp;thread_key, <a class="code" href="Getopt_8c.html#a0">NULL</a> ) == -1 )
00336     printf( <span class="stringliteral">"Error %d creating pthread key for thread %p : %s\n"</span>,
00337         errno,(caddr_t)pthread_self(),strerror(errno) ) ;
00338   
00339   return ;
00340 } <span class="comment">/* init_keys */</span>
00341 
00342 
<a name="l00347"></a><a class="code" href="commands__FSAL_8c.html#a12">00347</a> <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a>  * <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>(){
00348   
00349   <span class="keywordtype">int</span> i;
00350   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * p_current_thread_vars ;
00351   
00352   
00353   <span class="comment">/* first, we init the keys if this is the first time */</span>
00354   <span class="keywordflow">if</span>( pthread_once( &amp;once_key, init_keys ) != 0 ){
00355     printf( <span class="stringliteral">"Error %d calling pthread_once for thread %p : %s\n"</span>,
00356         errno,(caddr_t)pthread_self(),strerror(errno) ) ;
00357     <span class="keywordflow">return</span> NULL;
00358   }
00359   
00360   p_current_thread_vars = (<a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> *)pthread_getspecific( thread_key );
00361   
00362   <span class="comment">/* we allocate the thread context if this is the first time */</span>
00363   <span class="keywordflow">if</span> (p_current_thread_vars==NULL){
00364       
00365     <span class="comment">/* allocates thread structure */</span>
00366     p_current_thread_vars = (<a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> *)Mem_Alloc(<span class="keyword">sizeof</span>(<a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a>));
00367     
00368     <span class="comment">/* panic !!! */</span>
00369     <span class="keywordflow">if</span> (p_current_thread_vars == NULL) {
00370       printf( <span class="stringliteral">"%p:commands_FSAL: Not enough memory\n"</span>,(caddr_t)pthread_self());
00371       <span class="keywordflow">return</span> NULL;
00372     }
00373     
00374     <span class="comment">/* Clean thread context */</span>
00375         
00376     memset(  p_current_thread_vars, 0, <span class="keyword">sizeof</span>( <a class="code" href="commands__FSAL_8c.html#a8">cmdfsal_thr_info_t</a> ) );
00377     
00378     p_current_thread_vars-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> = FALSE;
00379     strcpy( p_current_thread_vars-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>, <span class="stringliteral">""</span>);
00380     p_current_thread_vars-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> = FALSE;    
00381   
00382     <span class="comment">/* set the specific value */</span>
00383     pthread_setspecific( thread_key , (<span class="keywordtype">void</span> *)p_current_thread_vars ) ;
00384     
00385   }
00386  
00387   <span class="keywordflow">return</span> p_current_thread_vars ;
00388   
00389 }<span class="comment">/* GetFSALCmdContext */</span>
00390 
00391 
<a name="l00395"></a><a class="code" href="commands__FSAL_8c.html#a13">00395</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( FILE * output,
00396                          <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a>  * context,
00397                          <span class="keywordtype">int</span> flag_v )
00398 {
00399   
00400   uid_t  uid;
00401   fsal_status_t st;
00402   fsal_handle_t     hdl_dir;
00403   <span class="keywordtype">char</span> buff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];
00404   <span class="keyword">struct </span>passwd * pw_struct;
00405   
00406   <span class="comment">/* for the moment, create export context for root fileset */</span>
00407   st = FSAL_BuildExportContext( &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o4">exp_context</a>,<a class="code" href="Getopt_8c.html#a0">NULL</a>, <a class="code" href="Getopt_8c.html#a0">NULL</a> );
00408   
00409   
00410   <span class="comment">/* get user's credentials */</span>
00411   
00412   st = FSAL_InitClientContext( &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a> );
00413 
00414   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) )
00415   {    
00416     fprintf(output,<span class="stringliteral">"Error executing FSAL_InitThreadCred:"</span>);
00417     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00418     fprintf(output,<span class="stringliteral">"\n"</span>);
00419     <span class="keywordflow">return</span> st.major;    
00420   }
00421 
00422   uid = getuid();
00423   pw_struct = getpwuid(uid); 
00424   
00425   <span class="keywordflow">if</span> ( pw_struct == NULL )
00426   {
00427     fprintf( output, <span class="stringliteral">"Unknown uid %u\n"</span>, uid );
00428     <span class="keywordflow">return</span> errno;
00429   }
00430   
00431   st = FSAL_GetClientContext( &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o4">exp_context</a>,
00432                               uid, pw_struct-&gt;pw_gid, <a class="code" href="Getopt_8c.html#a0">NULL</a> , 0 );
00433   
00434   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) )
00435   {
00436     fprintf(output,<span class="stringliteral">"Error executing FSAL_GetUserCred:"</span>);
00437     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00438     fprintf(output,<span class="stringliteral">"\n"</span>);
00439     <span class="keywordflow">return</span> st.major;    
00440   }  
00441   
00442   <span class="comment">/* get root file handle */</span>
00443   
00444   <span class="comment">/* lookup */</span>
00445   
00446   st = FSAL_lookup( <a class="code" href="Getopt_8c.html#a0">NULL</a>, <a class="code" href="Getopt_8c.html#a0">NULL</a>, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, &amp;hdl_dir, <a class="code" href="Getopt_8c.html#a0">NULL</a> );
00447   
00448   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
00449     
00450     fprintf(output,<span class="stringliteral">"Error executing FSAL_lookup:"</span>);
00451     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00452     fprintf(output,<span class="stringliteral">"\n"</span>);
00453     <span class="keywordflow">return</span> st.major;
00454     
00455   }
00456   
00457   <span class="comment">/* save root handle */</span>
00458   
00459   context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a> = hdl_dir;
00460   context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> = TRUE;
00461       
00462   strcpy(context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,<span class="stringliteral">"/"</span>);
00463   
00464   snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>);  
00465   <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Current directory is \"%s\" (@%s)\n"</span>,
00466     context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,buff);
00467   
00468   <span class="keywordflow">return</span> 0;
00469     
00470 }
00471 
00472 
<a name="l00473"></a><a class="code" href="commands__FSAL_8c.html#a14">00473</a> <span class="keywordtype">void</span> <a class="code" href="commands__FSAL_8c.html#a14">fsal_layer_SetLogLevel</a>(<span class="keywordtype">int</span> log_lvl  ){
00474   
00475   log_stream_t * curr;
00476   
00477   <span class="comment">/* mutex pour proteger le descriptor de log */</span>
00478   pthread_mutex_lock( &amp;mutex_log );
00479       
00480   <span class="comment">/* first time */</span>
00481   <span class="keywordflow">if</span> ( log_level == -1){
00482     log_level = log_lvl;
00483     voie.fd = fileno( stderr ) ;
00484     AddLogStreamJd( &amp;log_desc, V_FD,voie,log_level,SUP);
00485   } <span class="keywordflow">else</span> {
00486     log_level = log_lvl;
00487     <span class="comment">/* changing log level */</span>
00488     curr = log_desc.liste_voies;
00489     <span class="keywordflow">while</span> (curr){
00490       curr-&gt;niveau = log_level;
00491       curr = curr-&gt;suivante;
00492     }
00493   }
00494   
00495   pthread_mutex_unlock( &amp;mutex_log );
00496       
00497 }
00498     
00499 
00500 <span class="keyword">static</span> <span class="keywordtype">void</span> getopt_init(){
00501    <a class="code" href="Getopt_8c.html#a3">Opterr</a> = 0; <span class="comment">/* disables Getopt error message */</span>
00502    <span class="comment">/* reinits Getopt processing */</span>
00503    <a class="code" href="Getopt_8c.html#a4">Optind</a> = 1;
00504 }
00505 
00506 
<a name="l00507"></a><a class="code" href="commands__FSAL_8c.html#a16">00507</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a16">fsal_init</a>(<span class="keywordtype">char</span> * filename,
00508               <span class="keywordtype">int</span> flag_v,
00509               FILE * output
00510     )
00511 {
00512   config_file_t config_file;
00513   
00514   <span class="comment">/* FSAL init parameters */</span>
00515   fsal_parameter_t  init_param;  
00516   fsal_status_t     st;
00517   
00518   <span class="comment">/* thread context */</span>
00519   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
00520   
00521   <span class="comment">/* Initializes the FSAL */</span>
00522 
00523   <span class="comment">/* use FSAL error family. */</span>
00524   
00525   AddFamilyError( ERR_FSAL, <span class="stringliteral">"FSAL related Errors"</span>, tab_errstatus_FSAL ) ;  
00526 
00527     
00528   <span class="comment">/* set configuration defaults */</span>
00529   
00530   FSAL_SetDefault_FSAL_parameter( &amp;init_param );
00531   FSAL_SetDefault_FS_common_parameter( &amp;init_param );
00532   FSAL_SetDefault_FS_specific_parameter( &amp;init_param );
00533 
00534     
00535   <span class="comment">/* Parse config file */</span>
00536       
00537   config_file = config_ParseFile( filename );
00538   
00539   <span class="keywordflow">if</span> ( !config_file ){
00540     fprintf(output, <span class="stringliteral">"init_fs: Error parsing %s: %s\n"</span>, filename,  config_GetErrorMsg());
00541     <span class="keywordflow">return</span> -1;
00542   }
00543     
00544   
00545   <span class="comment">/* Load FSAL configuration from file configuration */</span>
00546 
00547   st = FSAL_load_FSAL_parameter_from_conf( config_file,&amp;init_param );
00548   
00549   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) )
00550   {
00551     <span class="keywordflow">if</span> ( st.major == ERR_FSAL_NOENT )
00552     {
00553       fprintf(output,<span class="stringliteral">"Missing FSAL stanza in config file\n"</span>);
00554     }
00555     <span class="keywordflow">else</span>
00556     {
00557       fprintf(output,<span class="stringliteral">"Error executing FSAL_load_FSAL_parameter_from_conf:"</span>);
00558       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00559       fprintf(output,<span class="stringliteral">"\n"</span>);
00560       <span class="keywordflow">return</span> st.major;
00561     }
00562   }
00563   
00564   st = FSAL_load_FS_common_parameter_from_conf( config_file,&amp;init_param );
00565   
00566   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) )
00567   {
00568     <span class="keywordflow">if</span> ( st.major == ERR_FSAL_NOENT )
00569     {
00570       fprintf(output,<span class="stringliteral">"Missing FS common stanza in config file\n"</span>);
00571     }
00572     <span class="keywordflow">else</span>
00573     {
00574       fprintf(output,<span class="stringliteral">"Error executing FSAL_load_FS_common_parameter_from_conf:"</span>);
00575       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00576       fprintf(output,<span class="stringliteral">"\n"</span>);
00577       <span class="keywordflow">return</span> st.major;
00578     }
00579   }
00580   
00581   st = FSAL_load_FS_specific_parameter_from_conf( config_file,&amp;init_param );
00582   
00583   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) )
00584   {
00585     <span class="keywordflow">if</span> ( st.major == ERR_FSAL_NOENT )
00586     {
00587       fprintf(output,<span class="stringliteral">"Missing FS specific stanza in config file\n"</span>);
00588     }
00589     <span class="keywordflow">else</span>
00590     {
00591       fprintf(output,<span class="stringliteral">"Error executing FSAL_load_FS_specific_parameter_from_conf:"</span>);
00592       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00593       fprintf(output,<span class="stringliteral">"\n"</span>);
00594       <span class="keywordflow">return</span> st.major;
00595     }
00596   }    
00597     
00598   <span class="comment">/* Free config struct */</span>  
00599   config_Free( config_file );    
00600   
00601     
00602   <span class="comment">/* overide log descriptor for FSAL */</span>
00603   
00604   init_param.fsal_info.log_outputs = log_desc;
00605   
00606   <span class="comment">/* Initialization */</span>
00607   
00608   <span class="keywordflow">if</span> (flag_v)
00609     fprintf(output,<span class="stringliteral">"Filesystem initialization...\n"</span>);
00610   
00611   st = FSAL_Init( &amp;init_param );
00612   
00613   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) ){
00614     
00615     fprintf(output,<span class="stringliteral">"Error executing FSAL_Init:"</span>);
00616     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00617     fprintf(output,<span class="stringliteral">"\n"</span>);
00618     <span class="keywordflow">return</span> st.major;
00619     
00620   }
00621   
00622   is_loaded = TRUE; 
00623   
00624   <span class="comment">/* initialize current thread */</span>
00625   
00626   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
00627   
00628   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
00629   { 
00630     <span class="keywordtype">int</span> rc;
00631     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, flag_v );
00632     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
00633   }
00634   
00635   <span class="keywordflow">return</span> 0;
00636 }
00637 
<a name="l00639"></a><a class="code" href="commands__FSAL_8c.html#a17">00639</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a17">fn_fsal_init_fs</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00640              <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00641              FILE * output )    <span class="comment">/* IN : output stream          */</span>
00642 {
00643   <span class="keywordtype">int</span> rc;
00644 
00645   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
00646   
00647   <span class="keyword">static</span> <span class="keywordtype">char</span> help_init[]=
00648     <span class="stringliteral">"usage: init_fs [options] &lt;ganesha_config_file&gt;\n"</span>
00649     <span class="stringliteral">"options :\n"</span>
00650     <span class="stringliteral">"\t-h print this help\n"</span>
00651     <span class="stringliteral">"\t-v verbose mode\n"</span>;
00652         
00653   <span class="keywordtype">int</span> option;
00654   <span class="keywordtype">int</span> flag_v = 0;
00655   <span class="keywordtype">int</span> flag_h = 0;  
00656   <span class="keywordtype">int</span> flag_p = 0;
00657   <span class="keywordtype">int</span> flag_k = 0;  
00658   <span class="keywordtype">int</span> err_flag = 0;
00659   <span class="keywordtype">char</span> * filename = NULL;
00660   
00661   
00662   <span class="comment">/* analysing options */</span>
00663   getopt_init();
00664   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
00665     <span class="keywordflow">switch</span>(option){
00666       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
00667         <span class="keywordflow">if</span> (flag_v)
00668           fprintf(output,
00669               <span class="stringliteral">"init_fs: warning: option 'v' has been specified more than once.\n"</span>);
00670         <span class="keywordflow">else</span> flag_v++;
00671         <span class="keywordflow">break</span>;
00672       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00673         <span class="keywordflow">if</span> ( flag_h )
00674           fprintf(output,
00675               <span class="stringliteral">"init_fs: warning: option 'h' has been specified more than once.\n"</span>);
00676         <span class="keywordflow">else</span> flag_h++;
00677         <span class="keywordflow">break</span>;
00678       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00679         fprintf(output,<span class="stringliteral">"init_fs: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
00680         err_flag ++;
00681         <span class="keywordflow">break</span>;
00682     }    
00683   }
00684   
00685   <span class="keywordflow">if</span> (flag_h){
00686     fprintf(output,help_init);
00687     <span class="keywordflow">return</span> 0;
00688   }
00689   
00690   <span class="comment">/* verifies mandatory argument */</span>
00691   
00692   <span class="keywordflow">if</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-1) ){
00693     <span class="comment">/* too much or not enough arguments */</span>
00694     err_flag ++;
00695   } <span class="keywordflow">else</span> {
00696     filename = argv[Optind];
00697   }
00698   
00699   <span class="keywordflow">if</span> (err_flag){
00700     fprintf(output,help_init);
00701     <span class="keywordflow">return</span> -1;
00702   }
00703 
00704   rc = <a class="code" href="commands__FSAL_8c.html#a16">fsal_init</a>(filename, flag_v, output);
00705 
00706   <span class="keywordflow">return</span> rc;
00707 }
00708 
00709 
00710 
<a name="l00713"></a><a class="code" href="commands__FSAL_8c.html#a18">00713</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a18">fn_fsal_pwd</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00714         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00715         FILE * output      <span class="comment">/* IN : output stream          */</span>
00716       ){
00717 
00718   
00719   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
00720 
00721   <span class="comment">/* is the fs initialized ? */</span>
00722   <span class="keywordflow">if</span> (!is_loaded){
00723     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
00724     <span class="keywordflow">return</span> -1;
00725   }
00726   
00727   
00728   <span class="comment">/* initialize current thread */</span>
00729     
00730   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
00731   
00732   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
00733   { 
00734     <span class="keywordtype">int</span> rc;
00735     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
00736     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
00737   }
00738 
00739   
00740   
00741   {
00742   <span class="keywordtype">char</span> buff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];
00743   snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>);
00744   
00745   fprintf(output,<span class="stringliteral">"Current directory is \"%s\" (@%s)\n"</span>,
00746     context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,buff);
00747 
00748   }
00749 
00750   <span class="keywordflow">return</span> 0;
00751     
00752 }
00753 
00754 
00755 <span class="comment">/* solves a relative or absolute path */</span>
00756 
<a name="l00757"></a><a class="code" href="commands__FSAL_8c.html#a19">00757</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(
00758     <span class="keywordtype">char</span> * io_global_path, <span class="keywordtype">int</span> size_global_path, <span class="comment">/* [IN-OUT] global path     */</span>
00759     <span class="keywordtype">char</span> * i_spec_path,                          <span class="comment">/* [IN] user specified path */</span>
00760     fsal_handle_t i_current_handle,       <span class="comment">/* [IN] current directory handle   */</span>
00761     fsal_handle_t * new_handle,           <span class="comment">/* [OUT] target object handle      */</span>
00762     FILE * output )
00763 {
00764   
00765   <span class="keywordtype">char</span> str_path[FSAL_MAX_PATH_LEN];
00766   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
00767   
00768   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
00769   
00770   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
00771   { 
00772     <span class="keywordtype">int</span> rc;
00773     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0);
00774     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
00775   }
00776 
00777   
00778   <span class="comment">/* local copy */</span>
00779   strncpy(str_path,i_spec_path,FSAL_MAX_PATH_LEN);
00780 
00781   
00782   <span class="keywordflow">if</span> (str_path[0] == <span class="charliteral">'@'</span>)
00783   <span class="comment">/* It is a file handle */</span>
00784   {
00785     <span class="keywordtype">int</span> rc;
00786     
00787     rc = sscanHandle( new_handle, str_path+1 );
00788     
00789     <span class="keywordflow">if</span> ( rc&lt;=0 ){
00790       fprintf( output, <span class="stringliteral">"Invalid FileHandle: %s\n"</span>,str_path );
00791       <span class="keywordflow">return</span> -1;
00792     }
00793     
00794     <span class="keywordflow">if</span> ( str_path[rc+1] != <span class="charliteral">'\0'</span> )
00795     {
00796       fprintf( output, <span class="stringliteral">"Invalid FileHandle: %s\n"</span>,str_path );
00797       <span class="keywordflow">return</span> -1;
00798     }
00799     
00800     strncpy( io_global_path, str_path ,size_global_path);
00801     
00802     <span class="keywordflow">return</span> 0;        
00803     
00804   }
00805   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (str_path[0] == <span class="charliteral">'/'</span>)
00806   <span class="comment">/* absolute path, proceed a lookupPath */</span>
00807   {
00808     fsal_path_t path;
00809     fsal_status_t st;
00810     fsal_handle_t tmp_hdl;  
00811     
00812     
00813     <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_str2path(str_path,FSAL_MAX_PATH_LEN,&amp;path))){
00814       fprintf(output,<span class="stringliteral">"Error executing FSAL_str2path:"</span>);
00815       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00816       fprintf(output,<span class="stringliteral">"\n"</span>);
00817       <span class="keywordflow">return</span> st.major;
00818     }
00819     
00820     <span class="keywordflow">if</span> (FSAL_IS_ERROR(st=FSAL_lookupPath(&amp;path,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;tmp_hdl,<a class="code" href="Getopt_8c.html#a0">NULL</a>))){
00821       fprintf(output,<span class="stringliteral">"Error executing FSAL_lookupPath:"</span>);
00822       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00823       fprintf(output,<span class="stringliteral">"\n"</span>);
00824       <span class="keywordflow">return</span> st.major;
00825     }
00826     
00827     <span class="comment">/* cleans path */</span>
00828     <a class="code" href="cmd__tools_8h.html#a16">clean_path</a>(str_path,FSAL_MAX_PATH_LEN);
00829 
00830     strncpy(io_global_path,str_path,size_global_path);
00831     *new_handle = tmp_hdl;
00832     
00833     <span class="keywordflow">return</span> 0;
00834         
00835   }
00836   <span class="keywordflow">else</span>
00837   <span class="comment">/* relative path, proceed a step by step lookup */</span>
00838   {
00839     fsal_name_t name;
00840     fsal_status_t st;
00841     fsal_handle_t old_hdl = i_current_handle;
00842     fsal_handle_t tmp_hdl;
00843     <span class="keywordtype">char</span> tmp_path[FSAL_MAX_PATH_LEN];
00844     <span class="keywordtype">char</span> * next_name = str_path;
00845     <span class="keywordtype">char</span> * curr = str_path;
00846     <span class="keywordtype">int</span> last=0;
00847     
00848     tmp_path[0]=<span class="charliteral">'\0'</span>; <span class="comment">/* empty string */</span>
00849     
00850     <span class="keywordflow">do</span> {
00851       
00852       <span class="comment">/* tokenize to the next '/' */</span>         
00853       <span class="keywordflow">while</span>( (*curr!=<span class="charliteral">'\0'</span>) &amp;&amp; (*curr!=<span class="charliteral">'/'</span>) )
00854         curr++;
00855 
00856       <span class="keywordflow">if</span> (!(*curr)) last=1; <span class="comment">/* remembers if it was the last dir */</span>
00857       *curr=<span class="charliteral">'\0'</span>;
00858             
00859       <span class="comment">/* build the name */</span>
00860       <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_str2name(next_name,FSAL_MAX_PATH_LEN,&amp;name))){
00861         fprintf(output,<span class="stringliteral">"Error executing FSAL_str2name:"</span>);
00862         <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00863         fprintf(output,<span class="stringliteral">"\n"</span>);
00864         <span class="keywordflow">return</span> st.major;
00865       }
00866 
00867       <span class="comment">/* lookup this name */</span>
00868       <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_lookup(&amp;old_hdl,&amp;name,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;tmp_hdl,<a class="code" href="Getopt_8c.html#a0">NULL</a>))){
00869         fprintf(output,<span class="stringliteral">"Error executing FSAL_lookup:"</span>);
00870         <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00871         fprintf(output,<span class="stringliteral">"\n"</span>);
00872         <span class="keywordflow">return</span> st.major;
00873       }
00874       
00875       <span class="comment">/* if handles are the same, we are at fileset root,</span>
00876 <span class="comment">       * so, don't modify the path.</span>
00877 <span class="comment">       * Else, we contatenate them.</span>
00878 <span class="comment">       */</span>
00879       <span class="keywordflow">if</span> ( FSAL_handlecmp( &amp;old_hdl, &amp;tmp_hdl, &amp;st ) != 0 )
00880       {
00881         <span class="comment">/* updates current handle */</span>
00882         old_hdl = tmp_hdl;
00883 
00884         <span class="comment">/* adds /name at the end of the path */</span>
00885         strncat(tmp_path,<span class="stringliteral">"/"</span>,FSAL_MAX_PATH_LEN);
00886         strncat(tmp_path,next_name,FSAL_MAX_PATH_LEN);
00887       }
00888       
00889       <span class="comment">/* updates cursors */</span>
00890       <span class="keywordflow">if</span> (!last){
00891         curr ++;
00892         next_name = curr ;
00893         <span class="comment">/* ignore successive slashes */</span>
00894         <span class="keywordflow">while</span>((*curr!=<span class="charliteral">'\0'</span>) &amp;&amp; (*curr==<span class="charliteral">'/'</span>)){
00895           curr++;
00896           next_name = curr;
00897         }
00898         <span class="keywordflow">if</span> (!(*curr)) last=1; <span class="comment">/* it is the last dir */</span>
00899       }
00900       
00901     } <span class="keywordflow">while</span>(!last);
00902     
00903     <span class="comment">/* everything is OK, apply changes */</span>
00904     
00905     strncat(io_global_path,tmp_path,size_global_path);   
00906     <a class="code" href="cmd__tools_8h.html#a16">clean_path</a>(io_global_path,size_global_path);
00907     
00908     *new_handle = old_hdl;
00909     
00910     <span class="keywordflow">return</span> 0;
00911       
00912   }
00913   
00914   
00915 }
00916 
00917 
<a name="l00919"></a><a class="code" href="commands__FSAL_8c.html#a20">00919</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a20">fn_fsal_cd</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00920         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00921         FILE * output      <span class="comment">/* IN : output stream          */</span>
00922       ){
00923 
00924   
00925   <span class="keyword">static</span> <span class="keywordtype">char</span> help_cd[]=
00926   <span class="stringliteral">"usage: cd &lt;path&gt;\n"</span>;
00927 
00928   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
00929   fsal_handle_t new_hdl;
00930   fsal_attrib_list_t attrs;
00931   fsal_status_t st;
00932   <span class="keywordtype">int</span> rc;
00933     
00934   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
00935 
00936   <span class="comment">/* is the fs initialized ? */</span>
00937   <span class="keywordflow">if</span> (!is_loaded){
00938     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
00939     <span class="keywordflow">return</span> -1;
00940   }
00941   
00942   
00943   <span class="comment">/* initialize current thread */</span>
00944     
00945   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
00946   
00947   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
00948   { 
00949     <span class="keywordtype">int</span> rc;
00950     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
00951     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
00952   }
00953   
00954   <span class="comment">/* Exactly one arg expected */</span>
00955   <span class="keywordflow">if</span> (argc!=2){
00956     fprintf(output,help_cd);
00957     <span class="keywordflow">return</span> -1;
00958   }
00959   
00960   <span class="comment">/* is it a relative or absolute path. */</span>
00961   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
00962   
00963   <span class="keywordflow">if</span> (rc = 
00964       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
00965                 argv[1],context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;new_hdl,output))
00966     <span class="keywordflow">return</span> rc;
00967 
00968   <span class="comment">/* verify if the object is a directory */</span>
00969   FSAL_CLEAR_MASK( attrs.asked_attributes );
00970   FSAL_SET_MASK( attrs.asked_attributes,
00971       FSAL_ATTR_TYPE
00972       | FSAL_ATTR_MODE
00973       | FSAL_ATTR_GROUP
00974       | FSAL_ATTR_OWNER
00975       );
00976   
00977  
00978   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_getattrs(&amp;new_hdl,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;attrs))){
00979     fprintf(output,<span class="stringliteral">"Error executing FSAL_getattrs:"</span>);
00980     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
00981     fprintf(output,<span class="stringliteral">"\n"</span>);
00982     <span class="keywordflow">return</span> st.major;
00983   }
00984   
00985   <span class="keywordflow">if</span> (attrs.type != FSAL_TYPE_DIR){
00986     fprintf(output,<span class="stringliteral">"Error: %s is not a directory\n"</span>,glob_path);  
00987     <span class="keywordflow">return</span> ENOTDIR;
00988   }
00989   
00990   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_test_access(&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,FSAL_X_OK,&amp;attrs))){
00991     fprintf(output,<span class="stringliteral">"Error: %s: permission denied.\n"</span>,glob_path);
00992     <span class="keywordflow">return</span> st.major;
00993   }
00994 
00995 <span class="comment">/*  if (FSAL_IS_ERROR(st = FSAL_access(&amp;new_hdl,&amp;contexte,FSAL_X_OK,&amp;attrs))){</span>
00996 <span class="comment">    fprintf(output,"Error: %s: permission denied.\n",);</span>
00997 <span class="comment">    return st.major;</span>
00998 <span class="comment">  }*/</span>
00999   
01000   
01001   <span class="comment">/* if so, apply changes */</span>  
01002   strncpy(context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,glob_path,FSAL_MAX_PATH_LEN);   
01003   context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a> = new_hdl;
01004     
01005   {
01006   <span class="keywordtype">char</span> buff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];
01007   snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>);
01008   
01009   fprintf(output,<span class="stringliteral">"Current directory is \"%s\" (@%s)\n"</span>,
01010     context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,buff);
01011   }
01012    
01013   <span class="keywordflow">return</span> 0;
01014       
01015 }
01016 
01017 
<a name="l01019"></a><a class="code" href="commands__FSAL_8c.html#a21">01019</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a21">fn_fsal_stat</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
01020         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
01021         FILE * output      <span class="comment">/* IN : output stream          */</span>
01022       ){
01023   
01024   
01025   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
01026    
01027   <span class="keyword">static</span> <span class="keywordtype">char</span> help_stat[]=
01028   <span class="stringliteral">"usage: stat [-h][-v] &lt;file&gt;\n"</span>;
01029 
01030   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
01031   fsal_handle_t new_hdl;
01032   fsal_attrib_list_t attrs;
01033   fsal_status_t st;
01034   <span class="keywordtype">int</span> rc,option;
01035   <span class="keywordtype">int</span> flag_v=0;
01036   <span class="keywordtype">int</span> flag_h=0;
01037   <span class="keywordtype">int</span> err_flag=0;
01038   <span class="keywordtype">char</span> * file = NULL;
01039     
01040   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
01041 
01042   <span class="comment">/* is the fs initialized ? */</span>
01043   <span class="keywordflow">if</span> (!is_loaded){
01044     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
01045     <span class="keywordflow">return</span> -1;
01046   }
01047   
01048   
01049   <span class="comment">/* initialize current thread */</span>
01050     
01051   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
01052   
01053   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
01054   { 
01055     <span class="keywordtype">int</span> rc;
01056     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
01057     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
01058   }
01059   
01060   <span class="comment">/* analysing options */</span>
01061   getopt_init();
01062   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
01063     <span class="keywordflow">switch</span>(option){
01064       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
01065         <span class="keywordflow">if</span> (flag_v)
01066           fprintf(output,
01067               <span class="stringliteral">"stat: warning: option 'v' has been specified more than once.\n"</span>);
01068         <span class="keywordflow">else</span> flag_v++;
01069         <span class="keywordflow">break</span>;
01070       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
01071         <span class="keywordflow">if</span> ( flag_h )
01072           fprintf(output,
01073               <span class="stringliteral">"stat: warning: option 'h' has been specified more than once.\n"</span>);
01074         <span class="keywordflow">else</span> flag_h++;
01075         <span class="keywordflow">break</span>;
01076       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
01077         fprintf(output,<span class="stringliteral">"stat: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
01078         err_flag ++;
01079         <span class="keywordflow">break</span>;
01080     }    
01081   }
01082   
01083   <span class="keywordflow">if</span> (flag_h){
01084     fprintf(output,help_stat);
01085     <span class="keywordflow">return</span> 0;
01086   }
01087   
01088   <span class="comment">/* Exactly one arg expected */</span>
01089   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-1)){
01090     err_flag ++;
01091   } <span class="keywordflow">else</span> {
01092     file = argv[Optind];
01093   }
01094   
01095   <span class="keywordflow">if</span> (err_flag){
01096     fprintf(output,help_stat);
01097     <span class="keywordflow">return</span> -1;
01098   }
01099     
01100   <span class="comment">/* copy current path. */</span>
01101   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
01102   
01103   <span class="comment">/* retrieves object handle*/</span>
01104   <span class="keywordflow">if</span> (rc = 
01105       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
01106                 file,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;new_hdl,output))
01107     <span class="keywordflow">return</span> rc;
01108 
01109   <span class="comment">/* retrieve supported attributes */</span>
01110   FSAL_CLEAR_MASK( attrs.asked_attributes );
01111   FSAL_SET_MASK( attrs.asked_attributes, FSAL_ATTR_SUPPATTR );
01112   
01113   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_getattrs(&amp;new_hdl,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;attrs))){
01114     fprintf(output,<span class="stringliteral">"Error executing FSAL_getattrs:"</span>);
01115     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01116     fprintf(output,<span class="stringliteral">"\n"</span>);
01117     <span class="keywordflow">return</span> st.major;
01118   }
01119   
01120   <span class="comment">/* print supported attributes if verbose flag is set */</span>
01121   <span class="keywordflow">if</span> (flag_v){
01122     fprintf(output,<span class="stringliteral">"Supported attributes :\n"</span>);
01123     <a class="code" href="cmd__tools_8h.html#a19">print_fsal_attrib_mask</a>(attrs.supported_attributes,output);
01124     fprintf(output,<span class="stringliteral">"\nAttributes :\n"</span>);
01125   }
01126   
01127   <span class="comment">/* getting all supported attributes */</span>
01128   attrs.asked_attributes = attrs.supported_attributes;
01129   
01130   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_getattrs(&amp;new_hdl,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;attrs))){
01131     fprintf(output,<span class="stringliteral">"Error executing FSAL_getattrs:"</span>);
01132     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01133     fprintf(output,<span class="stringliteral">"\n"</span>);
01134     <span class="keywordflow">return</span> st.major;
01135   }  
01136   
01137   <span class="comment">/* print file attributes */</span>
01138   <a class="code" href="cmd__tools_8h.html#a21">print_fsal_attributes</a>( attrs, output);
01139   
01140   <span class="keywordflow">return</span> 0;
01141   
01142 }
01143 
01144 
<a name="l01146"></a><a class="code" href="commands__FSAL_8c.html#a22">01146</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a22">fn_fsal_lsxattrs</a>( <span class="keywordtype">int</span> argc , <span class="comment">/* IN : number of args in argv */</span>
01147         <span class="keywordtype">char</span> ** argv ,         <span class="comment">/* IN : arg list               */</span>
01148         FILE * output          <span class="comment">/* IN : output stream          */</span>
01149       )
01150 {
01151   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
01152    
01153   <span class="keyword">static</span> <span class="keywordtype">char</span> help_lsxattr[]=
01154   <span class="stringliteral">"usage: lsxattrs [-h][-v] &lt;path&gt;\n"</span>;
01155 
01156   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
01157   fsal_handle_t new_hdl;
01158   fsal_status_t st;
01159   <span class="keywordtype">int</span> rc,option;
01160   <span class="keywordtype">int</span> flag_v=0;
01161   <span class="keywordtype">int</span> flag_h=0;
01162   <span class="keywordtype">int</span> err_flag=0;
01163   <span class="keywordtype">char</span> * file = NULL;
01164   
01165   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    cookie;
01166   fsal_xattrent_t xattr_array[256];
01167   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    nb_returned;
01168   <span class="keywordtype">int</span>             eol;
01169     
01170   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
01171 
01172   <span class="comment">/* is the fs initialized ? */</span>
01173   <span class="keywordflow">if</span> (!is_loaded){
01174     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
01175     <span class="keywordflow">return</span> -1;
01176   }
01177   
01178   
01179   <span class="comment">/* initialize current thread */</span>
01180     
01181   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
01182   
01183   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
01184   { 
01185     <span class="keywordtype">int</span> rc;
01186     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
01187     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
01188   }
01189   
01190   <span class="comment">/* analysing options */</span>
01191   getopt_init();
01192   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
01193     <span class="keywordflow">switch</span>(option){
01194       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
01195         <span class="keywordflow">if</span> (flag_v)
01196           fprintf(output,
01197               <span class="stringliteral">"lsxattrs: warning: option 'v' has been specified more than once.\n"</span>);
01198         <span class="keywordflow">else</span> flag_v++;
01199         <span class="keywordflow">break</span>;
01200       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
01201         <span class="keywordflow">if</span> ( flag_h )
01202           fprintf(output,
01203               <span class="stringliteral">"lsxattrs: warning: option 'h' has been specified more than once.\n"</span>);
01204         <span class="keywordflow">else</span> flag_h++;
01205         <span class="keywordflow">break</span>;
01206       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
01207         fprintf(output,<span class="stringliteral">"lsxattrs: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
01208         err_flag ++;
01209         <span class="keywordflow">break</span>;
01210     }    
01211   }
01212   
01213   <span class="keywordflow">if</span> (flag_h){
01214     fprintf(output,help_lsxattr);
01215     <span class="keywordflow">return</span> 0;
01216   }
01217   
01218   <span class="comment">/* Exactly one arg expected */</span>
01219   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-1)){
01220     err_flag ++;
01221   } <span class="keywordflow">else</span> {
01222     file = argv[Optind];
01223   }
01224   
01225   <span class="keywordflow">if</span> (err_flag){
01226     fprintf(output,help_lsxattr);
01227     <span class="keywordflow">return</span> -1;
01228   }
01229     
01230   <span class="comment">/* copy current path. */</span>
01231   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
01232   
01233   <span class="comment">/* retrieves object handle*/</span>
01234   <span class="keywordflow">if</span> (rc = 
01235       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
01236                 file,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;new_hdl,output))
01237     <span class="keywordflow">return</span> rc;
01238   
01239   <span class="comment">/* list extended attributes */</span>
01240   
01241   cookie = XATTRS_READLIST_FROM_BEGINNING;
01242   eol = FALSE;
01243   
01244   <span class="keywordflow">while</span> ( !eol )
01245   {
01246     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index;
01247     
01248     st = FSAL_ListXAttrs( &amp;new_hdl, cookie, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,
01249                           xattr_array, 256, &amp;nb_returned, &amp;eol );
01250     
01251     <span class="keywordflow">if</span> (FSAL_IS_ERROR(st))
01252     {
01253       fprintf(output,<span class="stringliteral">"Error executing FSAL_ListXAttrs:"</span>);
01254       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01255       fprintf(output,<span class="stringliteral">"\n"</span>);
01256       <span class="keywordflow">return</span> st.major;
01257     }
01258     
01259     <span class="comment">/* list attributes */</span>
01260     
01261     <span class="keywordflow">for</span> ( index = 0; index &lt; nb_returned; index ++ )
01262     {
01263       <span class="keywordflow">if</span> ( flag_v )
01264         <span class="comment">/* print all attribute's info */</span>
01265         fprintf(output, <span class="stringliteral">"%u: %s\n"</span>, xattr_array[index].xattr_id, xattr_array[index].xattr_name.name );
01266       <span class="keywordflow">else</span>
01267         <span class="comment">/* print only attribute's name */</span>
01268         fprintf(output, <span class="stringliteral">"%s\n"</span>, xattr_array[index].xattr_name.name );
01269       
01270       cookie = xattr_array[index].xattr_cookie ;
01271     }
01272         
01273   }
01274   
01275   <span class="keywordflow">return</span> 0;
01276   
01277 }
01278 
<a name="l01280"></a><a class="code" href="commands__FSAL_8c.html#a23">01280</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a23">fn_fsal_getxattr</a>( <span class="keywordtype">int</span> argc , <span class="comment">/* IN : number of args in argv */</span>
01281         <span class="keywordtype">char</span> ** argv ,         <span class="comment">/* IN : arg list               */</span>
01282         FILE * output          <span class="comment">/* IN : output stream          */</span>
01283       )
01284 {
01285   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hvaxn"</span>;
01286    
01287   <span class="keyword">static</span> <span class="keywordtype">char</span> help_getxattr[]=
01288   <span class="stringliteral">"usage: getxattr [-hv] [-a|-n|-x] &lt;path&gt; &lt;attr_name&gt;\n"</span>
01289     <span class="stringliteral">"options :\n"</span>
01290     <span class="stringliteral">"\t-h print this help\n"</span>
01291     <span class="stringliteral">"\t-v verbose mode\n"</span>  
01292     <span class="stringliteral">"\t-a display attribute value as ascii\n"</span>
01293     <span class="stringliteral">"\t-n display attribute value as numeric\n"</span>
01294     <span class="stringliteral">"\t-x display attribute value as hexa\n"</span>;
01295 
01296   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
01297   fsal_handle_t new_hdl;
01298   fsal_status_t st;
01299   <span class="keywordtype">int</span> rc,option;
01300   <span class="keywordtype">int</span> flag_v=0;
01301   <span class="keywordtype">int</span> flag_h=0;
01302   <span class="keywordtype">int</span> flag_x=0;
01303   <span class="keywordtype">int</span> flag_n=0;
01304   <span class="keywordtype">int</span> flag_a=0;
01305   <span class="keywordtype">int</span> err_flag=0;
01306   <span class="keywordtype">char</span> * file = NULL;
01307   <span class="keywordtype">char</span> * attrname = NULL;
01308 
01309   fsal_name_t attrnamefsal;
01310   <span class="keywordtype">char</span> buffer[4096];
01311   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> returned;
01312   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index;
01313             
01314   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
01315 
01316   <span class="comment">/* is the fs initialized ? */</span>
01317   <span class="keywordflow">if</span> (!is_loaded){
01318     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
01319     <span class="keywordflow">return</span> -1;
01320   }
01321   
01322   
01323   <span class="comment">/* initialize current thread */</span>
01324     
01325   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
01326   
01327   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
01328   { 
01329     <span class="keywordtype">int</span> rc;
01330     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
01331     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
01332   }
01333   
01334   <span class="comment">/* analysing options */</span>
01335   getopt_init();
01336   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
01337     <span class="keywordflow">switch</span>(option){
01338       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
01339         <span class="keywordflow">if</span> (flag_v)
01340           fprintf(output,
01341               <span class="stringliteral">"getxattr: warning: option 'v' has been specified more than once.\n"</span>);
01342         <span class="keywordflow">else</span> flag_v++;
01343         <span class="keywordflow">break</span>;
01344       <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
01345         <span class="keywordflow">if</span> (flag_a)
01346           fprintf(output,
01347               <span class="stringliteral">"getxattr: warning: option 'a' has been specified more than once.\n"</span>);
01348         <span class="keywordflow">else</span> flag_a++;
01349         <span class="keywordflow">break</span>;
01350       <span class="keywordflow">case</span> <span class="charliteral">'x'</span>:
01351         <span class="keywordflow">if</span> (flag_x)
01352           fprintf(output,
01353               <span class="stringliteral">"getxattr: warning: option 'x' has been specified more than once.\n"</span>);
01354         <span class="keywordflow">else</span> flag_x++;
01355         <span class="keywordflow">break</span>;
01356       <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
01357         <span class="keywordflow">if</span> (flag_n)
01358           fprintf(output,
01359               <span class="stringliteral">"getxattr: warning: option 'n' has been specified more than once.\n"</span>);
01360         <span class="keywordflow">else</span> flag_n++;
01361         <span class="keywordflow">break</span>;
01362       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
01363         <span class="keywordflow">if</span> ( flag_h )
01364           fprintf(output,
01365               <span class="stringliteral">"getxattr: warning: option 'h' has been specified more than once.\n"</span>);
01366         <span class="keywordflow">else</span> flag_h++;
01367         <span class="keywordflow">break</span>;
01368       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
01369         fprintf(output,<span class="stringliteral">"getxattr: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
01370         err_flag ++;
01371         <span class="keywordflow">break</span>;
01372     }    
01373   }
01374   
01375   <span class="keywordflow">if</span> (flag_h){
01376     fprintf(output,help_getxattr);
01377     <span class="keywordflow">return</span> 0;
01378   }
01379   
01380   <span class="keywordflow">if</span> ( flag_x + flag_n + flag_a &gt; 1 )
01381   {
01382     fprintf(output,<span class="stringliteral">"getxattr: options -x, -a and -n are not compatible\n"</span>);
01383     fprintf(output,help_getxattr);
01384     <span class="keywordflow">return</span> -1;
01385   }
01386   
01387   <span class="comment">/* Exactly 2 args expected */</span>
01388   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-2)){
01389     err_flag ++;
01390   } <span class="keywordflow">else</span> {
01391     file = argv[Optind];
01392     attrname =  argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1];
01393   }
01394   
01395   <span class="keywordflow">if</span> (err_flag){
01396     fprintf(output,help_getxattr);
01397     <span class="keywordflow">return</span> -1;
01398   }
01399     
01400   <span class="comment">/* copy current path. */</span>
01401   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
01402   
01403   <span class="comment">/* retrieves object handle*/</span>
01404   <span class="keywordflow">if</span> (rc = 
01405       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
01406                 file,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;new_hdl,output))
01407     <span class="keywordflow">return</span> rc;
01408   
01409   <span class="comment">/* create fsal_name_t */</span>
01410   FSAL_str2name( attrname, 256, &amp;attrnamefsal );
01411 
01412   memset( buffer, 0, <span class="keyword">sizeof</span>(buffer) );
01413   
01414   <span class="comment">/* get extended attribute */</span>
01415  
01416 <span class="preprocessor">#ifdef BUGAZOMEU_64 </span>
01417 <span class="preprocessor"></span>  st = FSAL_GetXAttrValueByName( &amp;new_hdl, &amp;attrnamefsal, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,
01418                     buffer, 4096, &amp;returned );
01419 <span class="preprocessor">#endif</span>
01420 <span class="preprocessor"></span>
01421   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st))
01422   {
01423     fprintf(output,<span class="stringliteral">"Error executing FSAL_GetXAttrValueByName:"</span>);
01424     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01425     fprintf(output,<span class="stringliteral">"\n"</span>);
01426     <span class="keywordflow">return</span> st.major;
01427   }
01428 
01429   
01430    <span class="keywordflow">if</span> ( returned == 0 )
01431    {
01432      fprintf(output,<span class="stringliteral">"(empty)\n"</span>);
01433      <span class="keywordflow">return</span> 0;
01434    }  
01435     
01436   <span class="comment">/* display returned value */</span>
01437   
01438   <span class="comment">/* when no flags are given, try to determinate what it is */</span>
01439    
01440   <span class="keywordflow">if</span> ( !flag_a &amp;&amp; !flag_n &amp;&amp; !flag_x )
01441   {
01442     <span class="comment">/* is it ascii ? */</span>
01443     <span class="keywordflow">if</span> ( strlen(buffer) == returned - 1 || strlen(buffer) == returned )
01444     {
01445       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
01446       <span class="keywordtype">char</span> * str = buffer;
01447       <span class="keywordtype">int</span> is_ascii = TRUE;
01448       
01449       <span class="keywordflow">for</span> ( i = 0; i &lt; strlen(str); i++ )
01450       {
01451           <span class="keywordflow">if</span> ( !isprint( str[i] ) &amp;&amp; !isspace( str[i] ) )
01452           {
01453             is_ascii = FALSE;
01454             <span class="keywordflow">break</span>;
01455           }
01456       }
01457       <span class="keywordflow">if</span> ( is_ascii ) flag_a = 1;
01458     }
01459     
01460     <span class="comment">/* is it numeric */</span>
01461     <span class="keywordflow">if</span> ( !flag_a )
01462     {
01463       <span class="keywordflow">if</span> ( returned == 1 || returned == 2 || returned == 4 || returned == 8 )
01464         flag_n = 1;
01465       <span class="keywordflow">else</span>
01466         flag_x = 1;
01467     }    
01468   }
01469   
01470   <span class="keywordflow">if</span> ( flag_a )
01471   {
01472     <span class="keywordflow">if</span> ( strlen(buffer)&gt;0 &amp;&amp; buffer[strlen(buffer)-1] != <span class="charliteral">'\n'</span> )
01473       fprintf(output, <span class="stringliteral">"%s\n"</span>, buffer );
01474     <span class="keywordflow">else</span>
01475       fprintf(output, <span class="stringliteral">"%s"</span>, buffer );
01476   }
01477   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_n )
01478   {
01479     <span class="keywordflow">if</span> ( returned == 1 )
01480       fprintf(output, <span class="stringliteral">"%hhu\n"</span>, buffer[0] );
01481     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( returned == 2 )
01482       fprintf(output, <span class="stringliteral">"%hu\n"</span>, *((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>*)buffer) );
01483     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( returned == 4 )
01484       fprintf(output, <span class="stringliteral">"%u\n"</span>, *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)buffer) );
01485     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( returned == 8 )
01486       fprintf(output, <span class="stringliteral">"%llu\n"</span>, *((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>*)buffer) );
01487     <span class="keywordflow">else</span>
01488     {
01489       <span class="keywordflow">for</span> ( index = 0; index &lt; returned; index += 8 )
01490       {
01491         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> * p64 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> *)(buffer + index);
01492         <span class="keywordflow">if</span> (index == 0 )
01493           fprintf(output, <span class="stringliteral">"%llu"</span>, *p64 );
01494         <span class="keywordflow">else</span>
01495           fprintf(output, <span class="stringliteral">".%llu"</span>, *p64 );
01496       }
01497       fprintf(output, <span class="stringliteral">"\n"</span>);
01498 
01499     }
01500     
01501   }
01502   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( flag_x ) <span class="comment">/* hexa */</span>
01503   {
01504       fprintf(output, <span class="stringliteral">"0X"</span> );
01505       <span class="keywordflow">for</span> ( index = 0; index &lt; returned; index ++ )
01506       {
01507         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> val = buffer[index];
01508         fprintf(output, <span class="stringliteral">"%hhX"</span>, val );
01509       }
01510       fprintf(output, <span class="stringliteral">"\n"</span>);
01511     
01512   }
01513   
01514   <span class="keywordflow">return</span> 0;
01515   
01516 }
01517 
01518 
01519 
01520 
<a name="l01522"></a><a class="code" href="commands__FSAL_8c.html#a24">01522</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a24">fn_fsal_ls</a>(
01523         <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
01524         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
01525         FILE * output )    <span class="comment">/* IN : output stream          */</span>      
01526 {
01527   
01528   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hvdlS"</span>;
01529   
01530   <span class="keyword">static</span> <span class="keywordtype">char</span> help_ls[]=
01531     <span class="stringliteral">"usage: ls [options] [name|path]\n"</span>
01532     <span class="stringliteral">"options :\n"</span>
01533     <span class="stringliteral">"\t-h print this help\n"</span>
01534     <span class="stringliteral">"\t-v verbose mode\n"</span>  
01535     <span class="stringliteral">"\t-d print directory info instead of listing its content\n"</span>      
01536     <span class="stringliteral">"\t-l print standard UNIX attributes\n"</span>
01537     <span class="stringliteral">"\t-S print all supported attributes\n"</span>;
01538     
01539   <span class="keywordtype">int</span> option;
01540   <span class="keywordtype">int</span> flag_v = 0;
01541   <span class="keywordtype">int</span> flag_h = 0;
01542   <span class="keywordtype">int</span> flag_d = 0;
01543   <span class="keywordtype">int</span> flag_l = 0;
01544   <span class="keywordtype">int</span> flag_S = 0;
01545   <span class="keywordtype">int</span> err_flag = 0;
01546   <span class="keywordtype">char</span> * str_name;
01547   
01548 <span class="preprocessor">  #define READDIR_SIZE FSAL_READDIR_SIZE</span>
01549 <span class="preprocessor"></span>  
01550   fsal_attrib_mask_t mask_needed;
01551   fsal_handle_t      obj_hdl;
01552   fsal_dir_t dir;
01553   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
01554   fsal_attrib_list_t attrs;
01555   fsal_status_t st;
01556   fsal_cookie_t from,to;
01557   fsal_dirent_t entries[READDIR_SIZE];
01558   fsal_count_t number;
01559   fsal_boolean_t eod = FALSE;
01560   fsal_path_t symlink_path;
01561   <span class="keywordtype">int</span> error = FALSE;
01562   <span class="keywordtype">int</span> rc;
01563 
01564   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
01565         
01566   <span class="comment">/* analysing options */</span>
01567   getopt_init();
01568   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){
01569     
01570     <span class="keywordflow">switch</span>(option){
01571       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
01572         <span class="keywordflow">if</span> (flag_v)
01573           fprintf(output,
01574               <span class="stringliteral">"ls: warning: option 'v' has been specified more than once.\n"</span>);
01575         <span class="keywordflow">else</span> flag_v++;
01576         <span class="keywordflow">break</span>;
01577       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
01578         <span class="keywordflow">if</span> ( flag_h )
01579           fprintf(output,
01580               <span class="stringliteral">"ls: warning: option 'h' has been specified more than once.\n"</span>);
01581         <span class="keywordflow">else</span> flag_h++;
01582         <span class="keywordflow">break</span>;
01583       <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
01584         <span class="keywordflow">if</span> ( flag_d )
01585           fprintf(output,
01586               <span class="stringliteral">"ls: warning: option 'd' has been specified more than once.\n"</span>);
01587         <span class="keywordflow">else</span> flag_d++;
01588         <span class="keywordflow">break</span>;
01589       <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
01590         <span class="keywordflow">if</span> ( flag_l )
01591           fprintf(output,
01592               <span class="stringliteral">"ls: warning: option 'l' has been specified more than once.\n"</span>);
01593         <span class="keywordflow">else</span> flag_l++;
01594         <span class="keywordflow">break</span>;
01595       <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
01596         <span class="keywordflow">if</span> ( flag_S )
01597           fprintf(output,
01598               <span class="stringliteral">"ls: warning: option 'S' has been specified more than once.\n"</span>);
01599         <span class="keywordflow">else</span> flag_S++;
01600         <span class="keywordflow">break</span>;
01601       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
01602         fprintf(output,<span class="stringliteral">"ls: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
01603         err_flag ++;
01604         <span class="keywordflow">break</span>;
01605     }
01606     
01607   }
01608 
01609   <span class="keywordflow">if</span> (flag_l+flag_S&gt;1){
01610     fprintf(output,<span class="stringliteral">"ls: conflict between options l,S\n"</span>);
01611     err_flag++;
01612   }
01613     
01614   <span class="keywordflow">if</span> (flag_h){
01615     fprintf(output,help_ls);
01616     <span class="keywordflow">return</span> 0;
01617   }
01618   <span class="keywordflow">if</span> (err_flag){
01619     fprintf(output,help_ls);
01620     <span class="keywordflow">return</span> -1;
01621   }
01622   
01623     
01624   <span class="comment">/* is the fs initialized ? */</span>
01625   <span class="keywordflow">if</span> (!is_loaded){
01626     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
01627     <span class="keywordflow">return</span> -1;
01628   }
01629   
01630   
01631   <span class="comment">/* initialize current thread */</span>
01632     
01633   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
01634   
01635   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
01636   { 
01637     <span class="keywordtype">int</span> rc;
01638     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
01639     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
01640   }
01641   
01642   <span class="comment">/* prepare needed attributes mask */</span>
01643   FSAL_CLEAR_MASK( mask_needed );
01644   FSAL_SET_MASK( mask_needed, FSAL_ATTRS_MANDATORY );
01645   
01646   <span class="keywordflow">if</span> (flag_l)
01647     FSAL_SET_MASK( mask_needed, FSAL_ATTRS_POSIX );
01648   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_S)
01649     mask_needed = 0xFFFFFFFFFFFFFFFFLL;
01650   
01651   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
01652   
01653   <span class="comment">/* first, retrieve the argument (if any) */</span>
01654   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> == (argc-1)){
01655     str_name = argv[Optind];
01656 
01657     <span class="comment">/* retrieving handle */</span>  
01658     <span class="keywordflow">if</span> (rc = 
01659         <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
01660                   str_name,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;obj_hdl,output))
01661       <span class="keywordflow">return</span> rc;
01662     
01663   } <span class="keywordflow">else</span> {
01664     str_name = <span class="stringliteral">"."</span>;
01665     obj_hdl = context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>;
01666   }  
01667     
01668   <span class="keywordflow">if</span> (flag_v)
01669     fprintf(output,<span class="stringliteral">"proceeding ls on \"%s\"\n"</span>, glob_path);
01670 
01671   FSAL_CLEAR_MASK( attrs.asked_attributes );
01672   FSAL_SET_MASK( attrs.asked_attributes, FSAL_ATTR_SUPPATTR );
01673   
01674   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_getattrs(&amp;obj_hdl,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;attrs))){
01675     fprintf(output,<span class="stringliteral">"Error executing FSAL_getattrs:"</span>);
01676     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01677     fprintf(output,<span class="stringliteral">"\n"</span>);
01678     <span class="keywordflow">return</span> st.major;
01679   }
01680   
01681   <span class="comment">/* getting all needed attributes */</span>
01682   attrs.asked_attributes = ( attrs.supported_attributes &amp; mask_needed );
01683   
01684   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_getattrs(&amp;obj_hdl,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;attrs))){
01685     fprintf(output,<span class="stringliteral">"Error executing FSAL_getattrs:"</span>);
01686     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01687     fprintf(output,<span class="stringliteral">"\n"</span>);
01688     <span class="keywordflow">return</span> st.major;
01689   }
01690 
01691   
01692  <span class="comment">/*</span>
01693 <span class="comment">  * if the object is a file or a directoy with the -d option specified,</span>
01694 <span class="comment">  * we only show its info and exit.</span>
01695 <span class="comment">  */</span>  
01696   <span class="keywordflow">if</span> ( (attrs.type != FSAL_TYPE_DIR) || flag_d ){
01697    
01698     <span class="keywordflow">if</span> ( (attrs.type == FSAL_TYPE_LNK) &amp;&amp; (flag_l) ){
01699       
01700       <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_readlink(
01701             &amp;obj_hdl,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;symlink_path,<a class="code" href="Getopt_8c.html#a0">NULL</a>))){
01702         fprintf(output,<span class="stringliteral">"Error executing FSAL_readlink:"</span>);
01703         <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01704         fprintf(output,<span class="stringliteral">"\n"</span>);
01705         <span class="keywordflow">return</span> st.major;
01706       }
01707       
01708     }
01709    
01710     <span class="keywordflow">if</span> (flag_l)      
01711       <a class="code" href="cmd__tools_8h.html#a22">print_item_line</a>( output,&amp;attrs, str_name, symlink_path.path);
01712     
01713     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_S){
01714       
01715       <span class="keywordtype">char</span> tracebuff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];      
01716       snprintHandle(tracebuff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;obj_hdl);
01717       fprintf(output,<span class="stringliteral">"%s (@%s):\n"</span>,str_name,tracebuff);
01718       <a class="code" href="cmd__tools_8h.html#a21">print_fsal_attributes</a>( attrs, output );
01719       
01720     } <span class="keywordflow">else</span>  <span class="comment">/* only prints the name */</span>
01721       fprintf(output,<span class="stringliteral">"%s\n"</span>,str_name);
01722           
01723     <span class="keywordflow">return</span> 0;
01724   }
01725 
01726   <span class="comment">/*</span>
01727 <span class="comment">   * the current object is a directory, we have to list its element</span>
01728 <span class="comment">   */</span>
01729   <span class="keywordflow">if</span> (FSAL_IS_ERROR(
01730         st = FSAL_opendir(&amp;obj_hdl,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;dir,<a class="code" href="Getopt_8c.html#a0">NULL</a>))){
01731     fprintf(output,<span class="stringliteral">"Error executing FSAL_opendir:"</span>);
01732     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01733     fprintf(output,<span class="stringliteral">"\n"</span>);
01734     <span class="keywordflow">return</span> st.major;
01735   }
01736 
01737   from = FSAL_READDIR_FROM_BEGINNING;
01738     
01739   <span class="keywordflow">while</span> (!error &amp;&amp; !eod){
01740     fsal_dirent_t * curr;
01741     <span class="keywordtype">char</span> item_path[FSAL_MAX_PATH_LEN];
01742    
01743     <span class="keywordflow">if</span> (FSAL_IS_ERROR(
01744           st = FSAL_readdir(&amp;dir, from,attrs.supported_attributes &amp; mask_needed,
01745                             <a class="code" href="commands__FSAL_8c.html#a0">READDIR_SIZE</a> * <span class="keyword">sizeof</span>(fsal_dirent_t),
01746                             entries, &amp;to , &amp;number, &amp;eod ))){
01747       fprintf(output,<span class="stringliteral">"Error executing FSAL_readdir:"</span>);
01748       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01749       fprintf(output,<span class="stringliteral">"\n"</span>);
01750       error =  st.major;
01751       number = 0;
01752     }
01753 
01754     <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"FSAL_readdir returned %u entries\n"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)number);
01755     
01756     <span class="keywordflow">if</span> (number&gt;0){
01757       curr = entries;
01758       <span class="keywordflow">do</span> {
01759         <span class="keywordtype">int</span> len;
01760         len = strlen(str_name);
01761         <span class="keywordflow">if</span> (!strcmp(str_name,<span class="stringliteral">"."</span>))
01762           strncpy(item_path,curr-&gt;name.name,FSAL_MAX_PATH_LEN);
01763         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (str_name[len-1] == <span class="charliteral">'/'</span>)
01764           snprintf(item_path,FSAL_MAX_PATH_LEN,<span class="stringliteral">"%s%s"</span>,str_name,curr-&gt;name.name);
01765         <span class="keywordflow">else</span>
01766           snprintf(item_path,FSAL_MAX_PATH_LEN,<span class="stringliteral">"%s/%s"</span>,str_name,curr-&gt;name.name);
01767         
01768         <span class="keywordflow">if</span> ( (curr-&gt;attributes.type == FSAL_TYPE_LNK) &amp;&amp; (flag_l) ){
01769           
01770           <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_readlink(
01771                 &amp;curr-&gt;handle,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,&amp;symlink_path,<a class="code" href="Getopt_8c.html#a0">NULL</a>))){
01772             fprintf(output,<span class="stringliteral">"Error executing FSAL_readlink:"</span>);
01773             <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01774             fprintf(output,<span class="stringliteral">"\n"</span>);
01775             <span class="keywordflow">return</span> st.major;
01776           }
01777           
01778         }
01779 
01780         <span class="keywordflow">if</span> (flag_l)
01781           <a class="code" href="cmd__tools_8h.html#a22">print_item_line</a>( output,&amp;(curr-&gt;attributes),item_path, symlink_path.path);
01782         
01783         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_S){
01784           
01785           <span class="keywordtype">char</span> tracebuff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];      
01786           snprintHandle(tracebuff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;curr-&gt;handle);
01787           
01788           fprintf(output,<span class="stringliteral">"%s (@%s):\n"</span>,item_path,tracebuff);
01789           <a class="code" href="cmd__tools_8h.html#a21">print_fsal_attributes</a>( curr-&gt;attributes, output);
01790           
01791         } <span class="keywordflow">else</span>  <span class="comment">/* only prints the name */</span>
01792           fprintf(output,<span class="stringliteral">"%s\n"</span>,item_path);
01793         
01794       } <span class="keywordflow">while</span>(curr = curr-&gt;nextentry);
01795     }
01796     <span class="comment">/* preparing next call */</span>
01797     from = to;
01798     
01799   }
01800   
01801   FSAL_closedir(&amp;dir);
01802        
01803   <span class="keywordflow">return</span> error;  
01804   
01805 } <span class="comment">/* fn_fsal_ls */</span>
01806   
01807 
01808 
<a name="l01810"></a><a class="code" href="commands__FSAL_8c.html#a25">01810</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a25">fn_fsal_callstat</a>( <span class="keywordtype">int</span> argc ,<span class="comment">/* IN : number of args in argv */</span>
01811         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
01812         FILE * output      <span class="comment">/* IN : output stream          */</span>
01813       ){
01814 
01815   fsal_statistics_t call_stat;
01816   <span class="keywordtype">int</span> i;
01817   
01818   <span class="keyword">static</span> <span class="keywordtype">char</span> help_stats[]=
01819   <span class="stringliteral">"usage: stats\n"</span>;
01820 
01821   <span class="comment">/* is the fs initialized ? */</span>
01822   <span class="keywordflow">if</span> (!is_loaded){
01823     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
01824     <span class="keywordflow">return</span> -1;
01825   }
01826   
01827   <span class="comment">/* No args expected */</span>
01828   <span class="keywordflow">if</span> (argc!=1){
01829     fprintf(output,help_stats);
01830     <span class="keywordflow">return</span> -1;
01831   }
01832   
01833   <span class="comment">/* retrieving current thread stats */</span>
01834   FSAL_get_stats( &amp;call_stat,FALSE );
01835   
01836   <span class="comment">/* displaying stats */</span>
01837   <span class="comment">/* header: */</span>
01838   fprintf(output,<span class="stringliteral">"Function             | Nb_Calls    | Success     | Retryable   | Unrecoverable\n"</span>);
01839   <span class="comment">/* content */</span>
01840   <span class="keywordflow">for</span> (i=0;i&lt;FSAL_NB_FUNC;i++)
01841     fprintf(output,<span class="stringliteral">"%-20s | %11u | %11u | %11u | %11u\n"</span>,
01842           fsal_function_names[i],
01843           call_stat.func_stats.nb_call[i],
01844           call_stat.func_stats.nb_success[i],
01845           call_stat.func_stats.nb_err_retryable[i],
01846           call_stat.func_stats.nb_err_unrecover[i]
01847           );
01848   
01849   <span class="keywordflow">return</span> 0; 
01850 }
01851 
01852 
<a name="l01854"></a><a class="code" href="commands__FSAL_8c.html#a26">01854</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a26">fn_fsal_su</a>( <span class="keywordtype">int</span> argc , <span class="comment">/* IN : number of args in argv */</span>
01855          <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
01856          FILE * output      <span class="comment">/* IN : output stream          */</span>
01857        ){
01858   
01859   <span class="keywordtype">char</span> * str_uid;
01860   fsal_uid_t  uid; 
01861   fsal_status_t st;
01862   <span class="keyword">struct </span>passwd * pw_struct;
01863   <span class="keywordtype">int</span> i;
01864 
01865 <span class="preprocessor"># define MAX_GRPS  128</span>
01866 <span class="preprocessor"></span>  gid_t   groups_tab[MAX_GRPS];
01867   <span class="keywordtype">int</span>     nb_grp;
01868 
01869   <span class="keyword">static</span> <span class="keywordtype">char</span> help_stats[]=
01870   <span class="stringliteral">"usage: su &lt;uid&gt;\n"</span>;
01871 
01872   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
01873 
01874   <span class="comment">/* is the fs initialized ? */</span>
01875   <span class="keywordflow">if</span> (!is_loaded){
01876     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
01877     <span class="keywordflow">return</span> -1;
01878   }
01879   
01880   
01881   <span class="comment">/* initialize current thread */</span>
01882     
01883   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
01884   
01885   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
01886   { 
01887     <span class="keywordtype">int</span> rc;
01888     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
01889     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
01890   }
01891   
01892   <span class="comment">/* UID arg expected */</span>
01893   <span class="keywordflow">if</span> (argc!=2){
01894     fprintf(output,help_stats);
01895     <span class="keywordflow">return</span> -1;
01896   } <span class="keywordflow">else</span> {
01897     str_uid = argv[1];
01898   }
01899   
01900   <span class="keywordflow">if</span> ( isdigit( str_uid[0] ) )
01901   {
01902     <span class="keywordflow">if</span> ( (uid = <a class="code" href="cmd__tools_8h.html#a10">my_atoi</a>(str_uid) ) == (uid_t)-1 )
01903     {
01904       fprintf(output,<span class="stringliteral">"Error: invalid uid \"%s\"\n"</span>,str_uid);
01905       <span class="keywordflow">return</span> -1;
01906     }
01907     pw_struct = getpwuid(uid); 
01908   }
01909   <span class="keywordflow">else</span>
01910   {
01911     pw_struct = getpwnam( str_uid );
01912   }
01913   
01914   <span class="keywordflow">if</span> ( pw_struct == NULL )
01915   {
01916     fprintf( output, <span class="stringliteral">"Unknown user %s\n"</span>, str_uid );
01917     <span class="keywordflow">return</span> errno;
01918   }
01919   
01920   nb_grp = <a class="code" href="cmd__tools_8h.html#a25">getugroups</a>( <a class="code" href="commands__Cache__inode_8c.html#a3">MAX_GRPS</a>, groups_tab, pw_struct-&gt;pw_name, pw_struct-&gt;pw_gid );
01921   
01922   fprintf( output, <span class="stringliteral">"Changing user to : %s ( uid = %d, gid = %d )\n"</span>,
01923        pw_struct-&gt;pw_name , pw_struct-&gt;pw_uid, pw_struct-&gt;pw_gid );
01924   
01925   <span class="keywordflow">if</span> ( nb_grp &gt; 1 )
01926   {
01927     fprintf( output, <span class="stringliteral">"altgroups = "</span>);
01928     <span class="keywordflow">for</span> ( i = 1; i &lt; nb_grp; i++ )
01929     {      
01930       <span class="keywordflow">if</span> ( i == 1 )
01931         fprintf( output, <span class="stringliteral">"%d"</span>, groups_tab[i]);
01932       <span class="keywordflow">else</span>
01933         fprintf( output, <span class="stringliteral">", %d"</span>, groups_tab[i]);      
01934     }
01935     fprintf( output, <span class="stringliteral">"\n"</span>);
01936   }
01937 
01938   st = FSAL_GetClientContext( &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o4">exp_context</a>,
01939                               pw_struct-&gt;pw_uid, pw_struct-&gt;pw_gid,
01940                               groups_tab, nb_grp );
01941       
01942   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) )
01943   {
01944     fprintf(output,<span class="stringliteral">"Error executing FSAL_GetUserCred:"</span>);
01945     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
01946     fprintf(output,<span class="stringliteral">"\n"</span>);
01947     <span class="keywordflow">return</span> st.major;
01948   }
01949   
01950   fprintf(output,<span class="stringliteral">"Done.\n"</span>);
01951   
01952   <span class="keywordflow">return</span> 0;
01953   
01954 }
01955 
01956 
01957 
01958 
<a name="l01960"></a><a class="code" href="commands__FSAL_8c.html#a27">01960</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a27">fn_fsal_unlink</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
01961         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
01962         FILE * output      <span class="comment">/* IN : output stream          */</span>
01963       ){
01964   
01965   
01966   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
01967    
01968   <span class="keyword">static</span> <span class="keywordtype">char</span> help_unlink[]=
01969   <span class="stringliteral">"usage: unlink [-h][-v] &lt;path&gt;\n"</span>;
01970 
01971   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
01972   fsal_handle_t new_hdl;
01973   fsal_attrib_list_t attrs;
01974   fsal_status_t st;
01975   <span class="keywordtype">int</span> rc,option;
01976   <span class="keywordtype">int</span> flag_v=0;
01977   <span class="keywordtype">int</span> flag_h=0;
01978   <span class="keywordtype">int</span> err_flag=0;
01979   
01980   <span class="keywordtype">char</span> tmp_path[FSAL_MAX_PATH_LEN];
01981   <span class="keywordtype">char</span> * path;
01982   <span class="keywordtype">char</span> * file;
01983   
01984   fsal_name_t objname;
01985     
01986   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
01987 
01988   <span class="comment">/* is the fs initialized ? */</span>
01989   <span class="keywordflow">if</span> (!is_loaded){
01990     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
01991     <span class="keywordflow">return</span> -1;
01992   }  
01993   
01994   <span class="comment">/* initialize current thread */</span>
01995     
01996   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
01997   
01998   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
01999   { 
02000     <span class="keywordtype">int</span> rc;
02001     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
02002     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
02003   }
02004   
02005   <span class="comment">/* analysing options */</span>
02006   getopt_init();
02007   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
02008     <span class="keywordflow">switch</span>(option){
02009       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
02010         <span class="keywordflow">if</span> (flag_v)
02011           fprintf(output,
02012               <span class="stringliteral">"unlink: warning: option 'v' has been specified more than once.\n"</span>);
02013         <span class="keywordflow">else</span> flag_v++;
02014         <span class="keywordflow">break</span>;
02015       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
02016         <span class="keywordflow">if</span> ( flag_h )
02017           fprintf(output,
02018               <span class="stringliteral">"unlink: warning: option 'h' has been specified more than once.\n"</span>);
02019         <span class="keywordflow">else</span> flag_h++;
02020         <span class="keywordflow">break</span>;
02021       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
02022         fprintf(output,<span class="stringliteral">"unlink: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
02023         err_flag ++;
02024         <span class="keywordflow">break</span>;
02025     }    
02026   }
02027   
02028   <span class="keywordflow">if</span> (flag_h){
02029     fprintf(output,help_unlink);
02030     <span class="keywordflow">return</span> 0;
02031   }
02032   
02033   <span class="comment">/* Exactly 1 args expected */</span>
02034   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-1)){
02035     err_flag ++;
02036   } <span class="keywordflow">else</span> {
02037     strncpy(tmp_path,argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>],FSAL_MAX_PATH_LEN);
02038     <a class="code" href="cmd__tools_8h.html#a15">split_path</a>(tmp_path, &amp;path, &amp;file);
02039   }  
02040   
02041   <span class="keywordflow">if</span> (err_flag){
02042     fprintf(output,help_unlink);
02043     <span class="keywordflow">return</span> -1;
02044   }
02045     
02046   <span class="comment">/* copy current path. */</span>
02047   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
02048   
02049   <span class="comment">/* retrieves path handle*/</span>
02050   <span class="keywordflow">if</span> (rc = 
02051       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
02052                 path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;new_hdl,output))
02053     <span class="keywordflow">return</span> rc;
02054 
02055   <span class="comment">/* create fsal_name_t */</span>
02056   st = FSAL_str2name(
02057       file,
02058       256,
02059       &amp;objname
02060     );
02061   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st )){
02062     fprintf(output,<span class="stringliteral">"Error executing FSAL_str2name:"</span>);
02063     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02064     fprintf(output,<span class="stringliteral">"\n"</span>);
02065     <span class="keywordflow">return</span> st.major;
02066   }
02067 
02068   
02069   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_unlink(&amp;new_hdl,&amp;objname,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,<a class="code" href="Getopt_8c.html#a0">NULL</a>))){
02070     fprintf(output,<span class="stringliteral">"Error executing FSAL_unlink:"</span>);
02071     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02072     fprintf(output,<span class="stringliteral">"\n"</span>);
02073     <span class="keywordflow">return</span> st.major;
02074   }
02075 
02076   <span class="keywordflow">if</span> (flag_v)
02077     fprintf(output,<span class="stringliteral">"%s/%s successfully unlinked\n"</span>,glob_path,file);
02078 
02079       
02080   <span class="keywordflow">return</span> 0;
02081   
02082 }
02083 
02084 
<a name="l02086"></a><a class="code" href="commands__FSAL_8c.html#a28">02086</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a28">fn_fsal_mkdir</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
02087         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
02088         FILE * output      <span class="comment">/* IN : output stream          */</span>
02089       ){
02090   
02091   
02092   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
02093    
02094   <span class="keyword">static</span> <span class="keywordtype">char</span> help_mkdir[]=
02095   <span class="stringliteral">"usage: mkdir [-h][-v] &lt;path&gt; &lt;mode&gt;\n"</span>
02096   <span class="stringliteral">"       path: path of the directory to be created\n"</span>
02097   <span class="stringliteral">"       mode: octal mode for the directory is to be created (ex: 755)\n"</span> ;
02098 
02099   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
02100   fsal_handle_t new_hdl,subdir_hdl;
02101   fsal_attrib_list_t attrs;
02102   fsal_status_t st;
02103   <span class="keywordtype">int</span> rc,option;
02104   <span class="keywordtype">int</span> flag_v=0;
02105   <span class="keywordtype">int</span> flag_h=0;
02106   <span class="keywordtype">int</span> err_flag=0;
02107   <span class="keywordtype">int</span> mode;
02108   fsal_accessmode_t fsalmode = 0755;
02109   
02110   <span class="keywordtype">char</span> tmp_path[FSAL_MAX_PATH_LEN];
02111   <span class="keywordtype">char</span> * path;
02112   <span class="keywordtype">char</span> * file;
02113   <span class="keywordtype">char</span> * strmode;
02114   
02115   fsal_name_t objname;
02116     
02117   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
02118 
02119   <span class="comment">/* is the fs initialized ? */</span>
02120   <span class="keywordflow">if</span> (!is_loaded){
02121     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
02122     <span class="keywordflow">return</span> -1;
02123   }  
02124   
02125   <span class="comment">/* initialize current thread */</span>
02126     
02127   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
02128   
02129   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
02130   { 
02131     <span class="keywordtype">int</span> rc;
02132     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
02133     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
02134   }
02135     
02136   <span class="comment">/* analysing options */</span>
02137   getopt_init();
02138   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
02139     <span class="keywordflow">switch</span>(option){
02140       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
02141         <span class="keywordflow">if</span> (flag_v)
02142           fprintf(output,
02143               <span class="stringliteral">"mkdir: warning: option 'v' has been specified more than once.\n"</span>);
02144         <span class="keywordflow">else</span> flag_v++;
02145         <span class="keywordflow">break</span>;
02146       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
02147         <span class="keywordflow">if</span> ( flag_h )
02148           fprintf(output,
02149               <span class="stringliteral">"mkdir: warning: option 'h' has been specified more than once.\n"</span>);
02150         <span class="keywordflow">else</span> flag_h++;
02151         <span class="keywordflow">break</span>;
02152       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
02153         fprintf(output,<span class="stringliteral">"mkdir: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
02154         err_flag ++;
02155         <span class="keywordflow">break</span>;
02156     }    
02157   }
02158   
02159   <span class="keywordflow">if</span> (flag_h){
02160     fprintf(output,help_mkdir);
02161     <span class="keywordflow">return</span> 0;
02162   }
02163   
02164   <span class="comment">/* Exactly 2 args expected */</span>
02165   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-2)){
02166     err_flag ++;
02167   } <span class="keywordflow">else</span> {
02168     
02169     strncpy(tmp_path,argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>],FSAL_MAX_PATH_LEN);
02170     <a class="code" href="cmd__tools_8h.html#a15">split_path</a>(tmp_path,&amp;path,&amp;file);
02171     
02172     strmode = argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1];
02173   
02174     <span class="comment">/* converting mode string to FSAL mode string */</span>
02175     mode = <a class="code" href="cmd__tools_8h.html#a11">atomode</a>(strmode);  
02176     <span class="keywordflow">if</span> (mode&lt;0) err_flag ++;
02177     <span class="keywordflow">else</span> {
02178 
02179       fsalmode = 0;
02180 
02181       <span class="keywordflow">if</span> ( mode &amp; S_ISUID ) fsalmode|= FSAL_MODE_SUID;
02182       <span class="keywordflow">if</span> ( mode &amp; S_ISGID ) fsalmode|= FSAL_MODE_SGID;
02183 
02184       <span class="keywordflow">if</span> ( mode &amp; S_IRUSR ) fsalmode|= FSAL_MODE_RUSR;
02185       <span class="keywordflow">if</span> ( mode &amp; S_IWUSR ) fsalmode|= FSAL_MODE_WUSR;
02186       <span class="keywordflow">if</span> ( mode &amp; S_IXUSR ) fsalmode|= FSAL_MODE_XUSR;
02187 
02188       <span class="keywordflow">if</span> ( mode &amp; S_IRGRP ) fsalmode|= FSAL_MODE_RGRP;
02189       <span class="keywordflow">if</span> ( mode &amp; S_IWGRP ) fsalmode|= FSAL_MODE_WGRP;
02190       <span class="keywordflow">if</span> ( mode &amp; S_IXGRP ) fsalmode|= FSAL_MODE_XGRP;
02191 
02192       <span class="keywordflow">if</span> ( mode &amp; S_IROTH ) fsalmode|= FSAL_MODE_ROTH;
02193       <span class="keywordflow">if</span> ( mode &amp; S_IWOTH ) fsalmode|= FSAL_MODE_WOTH;
02194       <span class="keywordflow">if</span> ( mode &amp; S_IXOTH ) fsalmode|= FSAL_MODE_XOTH;
02195 
02196     }
02197     
02198   }
02199   
02200   
02201   <span class="keywordflow">if</span> (err_flag){
02202     fprintf(output,help_mkdir);
02203     <span class="keywordflow">return</span> -1;
02204   }
02205     
02206   <span class="comment">/* copy current path. */</span>
02207   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
02208   
02209   <span class="comment">/* retrieves path handle*/</span>
02210   <span class="keywordflow">if</span> (rc = 
02211       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
02212                 path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;new_hdl,output))
02213     <span class="keywordflow">return</span> rc;
02214 
02215   <span class="comment">/* create fsal_name_t */</span>
02216   st = FSAL_str2name(
02217       file,
02218       256,
02219       &amp;objname
02220     );
02221   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st )){
02222     fprintf(output,<span class="stringliteral">"Error executing FSAL_str2name:"</span>);
02223     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02224     fprintf(output,<span class="stringliteral">"\n"</span>);
02225     <span class="keywordflow">return</span> st.major;
02226   }
02227 
02228   
02229   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_mkdir(&amp;new_hdl,&amp;objname,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,
02230                                     fsalmode,&amp;subdir_hdl,<a class="code" href="Getopt_8c.html#a0">NULL</a>))){
02231     fprintf(output,<span class="stringliteral">"Error executing FSAL_mkdir:"</span>);
02232     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02233     fprintf(output,<span class="stringliteral">"\n"</span>);
02234     <span class="keywordflow">return</span> st.major;
02235   }
02236 
02237   <span class="keywordflow">if</span> (flag_v)
02238   {
02239     <span class="keywordtype">char</span> buff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];  
02240     snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;subdir_hdl);
02241   
02242     fprintf(output,<span class="stringliteral">"%s/%s successfully created (@%s) \n"</span>,glob_path,file,buff);
02243 
02244   }
02245 
02246       
02247   <span class="keywordflow">return</span> 0;
02248   
02249 }
02250 
02251 
02252 
02253 
<a name="l02255"></a><a class="code" href="commands__FSAL_8c.html#a29">02255</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a29">fn_fsal_rename</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
02256         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
02257         FILE * output      <span class="comment">/* IN : output stream          */</span>
02258       ){
02259   
02260   
02261   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
02262    
02263   <span class="keyword">static</span> <span class="keywordtype">char</span> help_rename[]=
02264   <span class="stringliteral">"usage: rename [-h][-v] &lt;src&gt; &lt;dest&gt;\n"</span>;
02265 
02266   <span class="keywordtype">char</span> src_glob_path[FSAL_MAX_PATH_LEN];
02267   <span class="keywordtype">char</span> tgt_glob_path[FSAL_MAX_PATH_LEN];
02268   
02269   fsal_handle_t src_path_handle, tgt_path_handle;
02270   fsal_name_t   src_name, tgt_name;
02271   
02272   fsal_status_t st;
02273   <span class="keywordtype">int</span> rc,option;
02274   <span class="keywordtype">int</span> flag_v=0;
02275   <span class="keywordtype">int</span> flag_h=0;
02276   <span class="keywordtype">int</span> err_flag=0;
02277   
02278   <span class="keywordtype">char</span> tmp_path1[FSAL_MAX_PATH_LEN];
02279   <span class="keywordtype">char</span> tmp_path2[FSAL_MAX_PATH_LEN];
02280   <span class="keywordtype">char</span> * src_path;
02281   <span class="keywordtype">char</span> * src_file;
02282   <span class="keywordtype">char</span> * tgt_path;
02283   <span class="keywordtype">char</span> * tgt_file;
02284       
02285   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
02286 
02287   <span class="comment">/* is the fs initialized ? */</span>
02288   <span class="keywordflow">if</span> (!is_loaded){
02289     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
02290     <span class="keywordflow">return</span> -1;
02291   }  
02292   
02293   <span class="comment">/* initialize current thread */</span>
02294     
02295   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
02296   
02297   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
02298   { 
02299     <span class="keywordtype">int</span> rc;
02300     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
02301     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
02302   }
02303   
02304   <span class="comment">/* analysing options */</span>
02305   getopt_init();
02306   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
02307     <span class="keywordflow">switch</span>(option){
02308       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
02309         <span class="keywordflow">if</span> (flag_v)
02310           fprintf(output,
02311               <span class="stringliteral">"rename: warning: option 'v' has been specified more than once.\n"</span>);
02312         <span class="keywordflow">else</span> flag_v++;
02313         <span class="keywordflow">break</span>;
02314       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
02315         <span class="keywordflow">if</span> ( flag_h )
02316           fprintf(output,
02317               <span class="stringliteral">"rename: warning: option 'h' has been specified more than once.\n"</span>);
02318         <span class="keywordflow">else</span> flag_h++;
02319         <span class="keywordflow">break</span>;
02320       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
02321         fprintf(output,<span class="stringliteral">"rename: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
02322         err_flag ++;
02323         <span class="keywordflow">break</span>;
02324     }    
02325   }
02326   
02327   <span class="keywordflow">if</span> (flag_h){
02328     fprintf(output,help_rename);
02329     <span class="keywordflow">return</span> 0;
02330   }
02331   
02332   <span class="comment">/* Exactly 2 args expected */</span>
02333   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-2)){
02334     err_flag ++;
02335   } <span class="keywordflow">else</span> {
02336     
02337     strncpy(tmp_path1,argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>],FSAL_MAX_PATH_LEN);
02338     <a class="code" href="cmd__tools_8h.html#a15">split_path</a>(tmp_path1,&amp;src_path,&amp;src_file);
02339 
02340     strncpy(tmp_path2,argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1],FSAL_MAX_PATH_LEN);
02341     <a class="code" href="cmd__tools_8h.html#a15">split_path</a>(tmp_path2,&amp;tgt_path,&amp;tgt_file);
02342     
02343   }
02344   
02345   <span class="keywordflow">if</span> (err_flag){
02346     fprintf(output,help_rename);
02347     <span class="keywordflow">return</span> -1;
02348   }
02349   
02350   <span class="keywordflow">if</span> (flag_v)
02351     fprintf(output,<span class="stringliteral">"Renaming %s (dir %s) to %s (dir %s)\n"</span>,
02352         src_file,src_path,tgt_file,tgt_path);
02353   
02354   <span class="comment">/* copy current path. */</span>
02355   strncpy(src_glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
02356   strncpy(tgt_glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
02357   
02358   <span class="comment">/* retrieves paths handles */</span>
02359   <span class="keywordflow">if</span> (rc = 
02360       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(src_glob_path,FSAL_MAX_PATH_LEN,
02361                 src_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;src_path_handle,output))
02362     <span class="keywordflow">return</span> rc;
02363 
02364   <span class="keywordflow">if</span> (rc = 
02365       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(tgt_glob_path,FSAL_MAX_PATH_LEN,
02366                 tgt_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;tgt_path_handle,output))
02367     <span class="keywordflow">return</span> rc;
02368 
02369   
02370   <span class="comment">/* create fsal_name_t */</span>
02371   
02372   st = FSAL_str2name( src_file, 256,  &amp;src_name );
02373   
02374   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )){
02375     
02376     fprintf(output,<span class="stringliteral">"Error executing FSAL_str2name:"</span>);
02377     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02378     fprintf(output,<span class="stringliteral">"\n"</span>);
02379     <span class="keywordflow">return</span> st.major;
02380     
02381   }
02382 
02383   st = FSAL_str2name( tgt_file, 256,  &amp;tgt_name );
02384   
02385   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )){
02386     
02387     fprintf(output,<span class="stringliteral">"Error executing FSAL_str2name:"</span>);
02388     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02389     fprintf(output,<span class="stringliteral">"\n"</span>);
02390     <span class="keywordflow">return</span> st.major;
02391     
02392   }
02393 
02394   <span class="comment">/* Rename operation */</span>  
02395   
02396   st = FSAL_rename(
02397     &amp;src_path_handle,      <span class="comment">/* IN */</span>
02398     &amp;src_name,             <span class="comment">/* IN */</span>
02399     &amp;tgt_path_handle,      <span class="comment">/* IN */</span>
02400     &amp;tgt_name,             <span class="comment">/* IN */</span>
02401     &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,        <span class="comment">/* IN */</span>
02402     <a class="code" href="Getopt_8c.html#a0">NULL</a>,
02403     <a class="code" href="Getopt_8c.html#a0">NULL</a>
02404   );
02405   
02406   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )){
02407     
02408     fprintf(output,<span class="stringliteral">"Error executing FSAL_rename:"</span>);
02409     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02410     fprintf(output,<span class="stringliteral">"\n"</span>);
02411     <span class="keywordflow">return</span> st.major;
02412     
02413   }
02414 
02415   <span class="keywordflow">if</span> (flag_v)
02416     fprintf( output,<span class="stringliteral">"%s/%s successfully renamed to %s/%s\n"</span>,
02417           src_glob_path, src_file,
02418           tgt_glob_path, tgt_file
02419         );
02420 
02421       
02422   <span class="keywordflow">return</span> 0;
02423   
02424 }
02425 
02426 
02427 
02428 
<a name="l02430"></a><a class="code" href="commands__FSAL_8c.html#a30">02430</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a30">fn_fsal_ln</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
02431         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
02432         FILE * output      <span class="comment">/* IN : output stream          */</span>
02433       ){
02434   
02435   
02436   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
02437    
02438   <span class="keyword">static</span> <span class="keywordtype">char</span> help_ln[]=
02439   <span class="stringliteral">"ln: create a symbolic link.\n"</span>
02440   <span class="stringliteral">"usage: ln [-h][-v] &lt;link_content&gt; &lt;link_path&gt;\n"</span>
02441   <span class="stringliteral">"       link_content: content of the symbolic link to be created\n"</span>
02442   <span class="stringliteral">"       link_path: path of the symbolic link to be created\n"</span>;
02443 
02444   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
02445   fsal_handle_t path_hdl,link_hdl;
02446   fsal_status_t st;
02447   <span class="keywordtype">int</span> rc,option;
02448   <span class="keywordtype">int</span> flag_v=0;
02449   <span class="keywordtype">int</span> flag_h=0;
02450   <span class="keywordtype">int</span> err_flag=0;
02451   <span class="keywordtype">int</span> mode;
02452   
02453   <span class="keywordtype">char</span> * content = NULL;
02454   <span class="keywordtype">char</span> tmp_path[FSAL_MAX_PATH_LEN];
02455   <span class="keywordtype">char</span> * path;
02456   <span class="keywordtype">char</span> * name;
02457   
02458   fsal_name_t objname;
02459   fsal_path_t objcontent;
02460     
02461   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
02462 
02463   <span class="comment">/* is the fs initialized ? */</span>
02464   <span class="keywordflow">if</span> (!is_loaded){
02465     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
02466     <span class="keywordflow">return</span> -1;
02467   }  
02468   
02469   <span class="comment">/* initialize current thread */</span>
02470     
02471   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
02472   
02473   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
02474   { 
02475     <span class="keywordtype">int</span> rc;
02476     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
02477     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
02478   }
02479   
02480   <span class="comment">/* analysing options */</span>
02481   getopt_init();
02482   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
02483     <span class="keywordflow">switch</span>(option){
02484       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
02485         <span class="keywordflow">if</span> (flag_v)
02486           fprintf(output,
02487               <span class="stringliteral">"ln: warning: option 'v' has been specified more than once.\n"</span>);
02488         <span class="keywordflow">else</span> flag_v++;
02489         <span class="keywordflow">break</span>;
02490       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
02491         <span class="keywordflow">if</span> ( flag_h )
02492           fprintf(output,
02493               <span class="stringliteral">"ln: warning: option 'h' has been specified more than once.\n"</span>);
02494         <span class="keywordflow">else</span> flag_h++;
02495         <span class="keywordflow">break</span>;
02496       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
02497         fprintf(output,<span class="stringliteral">"ln: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
02498         err_flag ++;
02499         <span class="keywordflow">break</span>;
02500     }    
02501   }
02502   
02503   <span class="keywordflow">if</span> (flag_h){
02504     fprintf(output,help_ln);
02505     <span class="keywordflow">return</span> 0;
02506   }
02507   
02508   <span class="comment">/* 2 args expected */</span>
02509   
02510   <span class="keywordflow">if</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> == (argc-2) ){
02511     
02512     content = argv[Optind];
02513     
02514     strncpy(tmp_path,argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1],FSAL_MAX_PATH_LEN);
02515     <a class="code" href="cmd__tools_8h.html#a15">split_path</a>(tmp_path,&amp;path,&amp;name);
02516 
02517   } <span class="keywordflow">else</span> {    
02518     err_flag ++;    
02519   }
02520   
02521   
02522   <span class="keywordflow">if</span> (err_flag){
02523     fprintf(output,help_ln);
02524     <span class="keywordflow">return</span> -1;
02525   }
02526     
02527   <span class="comment">/* copy current path. */</span>
02528   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
02529   
02530   <span class="comment">/* retrieves path handle*/</span>
02531   <span class="keywordflow">if</span> (rc = 
02532       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
02533                 path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;path_hdl,output))
02534     <span class="keywordflow">return</span> rc;
02535 
02536   <span class="comment">/* create fsal_name_t */</span>  
02537   st = FSAL_str2name(
02538       name,
02539       256,
02540       &amp;objname
02541     );
02542   
02543   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )){
02544     fprintf(output,<span class="stringliteral">"Error executing FSAL_str2name:"</span>);
02545     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02546     fprintf(output,<span class="stringliteral">"\n"</span>);
02547     <span class="keywordflow">return</span> st.major;
02548   }
02549 
02550   <span class="comment">/* create fsal_path_t */</span>  
02551   st = FSAL_str2path(
02552       content,
02553       256,
02554       &amp;objcontent
02555     );
02556   
02557   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )){
02558     fprintf(output,<span class="stringliteral">"Error executing FSAL_str2path:"</span>);
02559     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02560     fprintf(output,<span class="stringliteral">"\n"</span>);
02561     <span class="keywordflow">return</span> st.major;
02562   }
02563 
02564   st = FSAL_symlink(
02565           &amp;path_hdl,  <span class="comment">/* IN - parent dir handle */</span>
02566           &amp;objname,   <span class="comment">/* IN - link name */</span>
02567           &amp;objcontent,<span class="comment">/* IN - link content */</span>
02568           &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,      <span class="comment">/* IN - user contexte */</span>
02569           0777,       <span class="comment">/* IN (ignored) */</span>
02570           &amp;link_hdl,  <span class="comment">/* OUT - link handle*/</span>
02571           <a class="code" href="Getopt_8c.html#a0">NULL</a> );     <span class="comment">/* OUT - link attributes */</span>
02572   
02573   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) ){
02574     fprintf(output,<span class="stringliteral">"Error executing FSAL_symlink:"</span>);
02575     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02576     fprintf(output,<span class="stringliteral">"\n"</span>);
02577     <span class="keywordflow">return</span> st.major;
02578   }
02579 
02580   <span class="keywordflow">if</span> (flag_v)
02581   {
02582     <span class="keywordtype">char</span> buff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];  
02583     snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;link_hdl);
02584   
02585     fprintf(output,<span class="stringliteral">"%s/%s -&gt; %s successfully created (@%s) \n"</span>,path,name,content,buff);
02586 
02587   }
02588 
02589       
02590   <span class="keywordflow">return</span> 0;
02591   
02592 }
02593 
02594 
02595 
02596 
<a name="l02598"></a><a class="code" href="commands__FSAL_8c.html#a31">02598</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a31">fn_fsal_hardlink</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
02599         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
02600         FILE * output      <span class="comment">/* IN : output stream          */</span>
02601       ){
02602   
02603   
02604   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
02605    
02606   <span class="keyword">static</span> <span class="keywordtype">char</span> help_hardlink[]=
02607   <span class="stringliteral">"hardlink: create a hard link.\n"</span>
02608   <span class="stringliteral">"usage: hardlink [-h][-v] &lt;target&gt; &lt;new_path&gt;\n"</span>
02609   <span class="stringliteral">"       target: path of an existing file.\n"</span>
02610   <span class="stringliteral">"       new_path: path of the hardlink to be created\n"</span>;
02611 
02612   <span class="keywordtype">char</span> glob_path_target[FSAL_MAX_PATH_LEN];
02613   <span class="keywordtype">char</span> glob_path_link[FSAL_MAX_PATH_LEN];
02614   
02615   fsal_handle_t target_hdl, dir_hdl;
02616   fsal_name_t   link_name;
02617   
02618   fsal_status_t st;
02619   <span class="keywordtype">int</span> rc,option;
02620   <span class="keywordtype">int</span> flag_v=0;
02621   <span class="keywordtype">int</span> flag_h=0;
02622   <span class="keywordtype">int</span> err_flag=0;
02623   <span class="keywordtype">int</span> mode;
02624   
02625   <span class="keywordtype">char</span> * target = NULL;
02626   
02627   <span class="keywordtype">char</span> tmp_path[FSAL_MAX_PATH_LEN];
02628   <span class="keywordtype">char</span> * path;
02629   <span class="keywordtype">char</span> * name;
02630       
02631   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
02632 
02633   <span class="comment">/* is the fs initialized ? */</span>
02634   <span class="keywordflow">if</span> (!is_loaded){
02635     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
02636     <span class="keywordflow">return</span> -1;
02637   }  
02638   
02639   <span class="comment">/* initialize current thread */</span>
02640     
02641   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
02642   
02643   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
02644   { 
02645     <span class="keywordtype">int</span> rc;
02646     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
02647     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
02648   }
02649   
02650   <span class="comment">/* analysing options */</span>
02651   getopt_init();
02652   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
02653     <span class="keywordflow">switch</span>(option){
02654       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
02655         <span class="keywordflow">if</span> (flag_v)
02656           fprintf(output,
02657               <span class="stringliteral">"hardlink: warning: option 'v' has been specified more than once.\n"</span>);
02658         <span class="keywordflow">else</span> flag_v++;
02659         <span class="keywordflow">break</span>;
02660       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
02661         <span class="keywordflow">if</span> ( flag_h )
02662           fprintf(output,
02663               <span class="stringliteral">"hardlink: warning: option 'h' has been specified more than once.\n"</span>);
02664         <span class="keywordflow">else</span> flag_h++;
02665         <span class="keywordflow">break</span>;
02666       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
02667         fprintf(output,<span class="stringliteral">"hardlink: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
02668         err_flag ++;
02669         <span class="keywordflow">break</span>;
02670     }    
02671   }
02672   
02673   <span class="keywordflow">if</span> (flag_h){
02674     fprintf(output,help_hardlink);
02675     <span class="keywordflow">return</span> 0;
02676   }
02677   
02678   <span class="comment">/* 2 args expected */</span>
02679   
02680   <span class="keywordflow">if</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> == (argc-2) ){
02681     
02682     target = argv[Optind];
02683     
02684     strncpy(tmp_path,argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1],FSAL_MAX_PATH_LEN);
02685     <a class="code" href="cmd__tools_8h.html#a15">split_path</a>(tmp_path,&amp;path,&amp;name);
02686 
02687   } <span class="keywordflow">else</span> {    
02688     err_flag ++;    
02689   }
02690   
02691   
02692   <span class="keywordflow">if</span> (err_flag){
02693     fprintf(output,help_hardlink);
02694     <span class="keywordflow">return</span> -1;
02695   }
02696     
02697   <span class="comment">/* copy current path. */</span>
02698   strncpy(glob_path_target,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
02699   strncpy(glob_path_link,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
02700   
02701   <span class="comment">/* retrieves path handle for target */</span>
02702   <span class="keywordflow">if</span> (rc = 
02703       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path_target,FSAL_MAX_PATH_LEN,
02704                 target,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;target_hdl,output))
02705     <span class="keywordflow">return</span> rc;
02706 
02707   <span class="comment">/* retrieves path handle for parent dir */</span>
02708   <span class="keywordflow">if</span> (rc = 
02709       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path_link,FSAL_MAX_PATH_LEN,
02710                 path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;dir_hdl,output))
02711     <span class="keywordflow">return</span> rc;
02712   
02713   
02714   <span class="comment">/* create fsal_name_t */</span>
02715   st = FSAL_str2name(
02716       name,
02717       256,
02718       &amp;link_name
02719     );
02720   
02721   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )){
02722     fprintf(output,<span class="stringliteral">"Error executing FSAL_str2name:"</span>);
02723     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02724     fprintf(output,<span class="stringliteral">"\n"</span>);
02725     <span class="keywordflow">return</span> st.major;
02726   }
02727 
02728 
02729   st = FSAL_link(
02730           &amp;target_hdl,<span class="comment">/* IN - target file */</span>
02731           &amp;dir_hdl,   <span class="comment">/* IN - parent dir handle */</span>
02732           &amp;link_name, <span class="comment">/* IN - link name */</span>
02733           &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,  <span class="comment">/* IN - user contexte */</span>
02734           <a class="code" href="Getopt_8c.html#a0">NULL</a> );     <span class="comment">/* OUT - new attributes */</span>
02735   
02736   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) ){
02737     fprintf(output,<span class="stringliteral">"Error executing FSAL_link:"</span>);
02738     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02739     fprintf(output,<span class="stringliteral">"\n"</span>);
02740     <span class="keywordflow">return</span> st.major;
02741   }
02742 
02743   <span class="keywordflow">if</span> (flag_v)
02744   {
02745     fprintf(output,<span class="stringliteral">"%s/%s &lt;=&gt; %s successfully created\n"</span>,path,name,glob_path_target);
02746 
02747   }
02748 
02749       
02750   <span class="keywordflow">return</span> 0;
02751   
02752 }
02753 
02754 
02755 
02756 
<a name="l02758"></a><a class="code" href="commands__FSAL_8c.html#a32">02758</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a32">fn_fsal_create</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
02759         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
02760         FILE * output      <span class="comment">/* IN : output stream          */</span>
02761       ){
02762   
02763   
02764   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
02765    
02766   <span class="keyword">static</span> <span class="keywordtype">char</span> help_create[]=
02767   <span class="stringliteral">"usage: create [-h][-v] &lt;path&gt; &lt;mode&gt;\n"</span>
02768   <span class="stringliteral">"       path: path of the file to be created\n"</span>
02769   <span class="stringliteral">"       mode: octal access mode for the file to be created (ex: 644)\n"</span> ;
02770 
02771   <span class="keywordtype">char</span> glob_path_dir[FSAL_MAX_PATH_LEN];
02772   fsal_handle_t dir_hdl,file_hdl;
02773   
02774   fsal_status_t st;
02775   <span class="keywordtype">int</span> rc,option;
02776   <span class="keywordtype">int</span> flag_v=0;
02777   <span class="keywordtype">int</span> flag_h=0;
02778   <span class="keywordtype">int</span> err_flag=0;
02779   <span class="keywordtype">int</span> mode;
02780   fsal_accessmode_t fsalmode = 0644;
02781   
02782   <span class="keywordtype">char</span> tmp_path[FSAL_MAX_PATH_LEN];
02783   <span class="keywordtype">char</span> * path;
02784   <span class="keywordtype">char</span> * file;
02785   <span class="keywordtype">char</span> * strmode;
02786   
02787   fsal_name_t objname;
02788     
02789   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
02790 
02791   <span class="comment">/* is the fs initialized ? */</span>
02792   <span class="keywordflow">if</span> (!is_loaded){
02793     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
02794     <span class="keywordflow">return</span> -1;
02795   }  
02796   
02797   <span class="comment">/* initialize current thread */</span>
02798     
02799   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
02800   
02801   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
02802   { 
02803     <span class="keywordtype">int</span> rc;
02804     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
02805     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
02806   }
02807   
02808   <span class="comment">/* analysing options */</span>
02809   getopt_init();
02810   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
02811     <span class="keywordflow">switch</span>(option){
02812       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
02813         <span class="keywordflow">if</span> (flag_v)
02814           fprintf(output,
02815               <span class="stringliteral">"create: warning: option 'v' has been specified more than once.\n"</span>);
02816         <span class="keywordflow">else</span> flag_v++;
02817         <span class="keywordflow">break</span>;
02818       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
02819         <span class="keywordflow">if</span> ( flag_h )
02820           fprintf(output,
02821               <span class="stringliteral">"create: warning: option 'h' has been specified more than once.\n"</span>);
02822         <span class="keywordflow">else</span> flag_h++;
02823         <span class="keywordflow">break</span>;
02824       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
02825         fprintf(output,<span class="stringliteral">"create: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
02826         err_flag ++;
02827         <span class="keywordflow">break</span>;
02828     }
02829   }
02830   
02831   <span class="keywordflow">if</span> (flag_h){
02832     fprintf(output,help_create);
02833     <span class="keywordflow">return</span> 0;
02834   }
02835   
02836   <span class="comment">/* Exactly 2 args expected */</span>
02837   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-2)){
02838     err_flag ++;
02839   } <span class="keywordflow">else</span> {
02840     
02841     strncpy(tmp_path,argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>],FSAL_MAX_PATH_LEN);
02842     <a class="code" href="cmd__tools_8h.html#a15">split_path</a>(tmp_path,&amp;path,&amp;file);
02843     
02844     strmode = argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1];
02845   
02846     <span class="comment">/* converting mode string to FSAL mode string */</span>
02847     mode = <a class="code" href="cmd__tools_8h.html#a11">atomode</a>(strmode);  
02848     <span class="keywordflow">if</span> (mode&lt;0) err_flag ++;
02849     <span class="keywordflow">else</span> {
02850 
02851       fsalmode = 0;
02852 
02853       <span class="keywordflow">if</span> ( mode &amp; S_ISUID ) fsalmode|= FSAL_MODE_SUID;
02854       <span class="keywordflow">if</span> ( mode &amp; S_ISGID ) fsalmode|= FSAL_MODE_SGID;
02855 
02856       <span class="keywordflow">if</span> ( mode &amp; S_IRUSR ) fsalmode|= FSAL_MODE_RUSR;
02857       <span class="keywordflow">if</span> ( mode &amp; S_IWUSR ) fsalmode|= FSAL_MODE_WUSR;
02858       <span class="keywordflow">if</span> ( mode &amp; S_IXUSR ) fsalmode|= FSAL_MODE_XUSR;
02859 
02860       <span class="keywordflow">if</span> ( mode &amp; S_IRGRP ) fsalmode|= FSAL_MODE_RGRP;
02861       <span class="keywordflow">if</span> ( mode &amp; S_IWGRP ) fsalmode|= FSAL_MODE_WGRP;
02862       <span class="keywordflow">if</span> ( mode &amp; S_IXGRP ) fsalmode|= FSAL_MODE_XGRP;
02863 
02864       <span class="keywordflow">if</span> ( mode &amp; S_IROTH ) fsalmode|= FSAL_MODE_ROTH;
02865       <span class="keywordflow">if</span> ( mode &amp; S_IWOTH ) fsalmode|= FSAL_MODE_WOTH;
02866       <span class="keywordflow">if</span> ( mode &amp; S_IXOTH ) fsalmode|= FSAL_MODE_XOTH;
02867 
02868     }
02869     
02870   }
02871   
02872   
02873   <span class="keywordflow">if</span> (err_flag){
02874     fprintf(output,help_create);
02875     <span class="keywordflow">return</span> -1;
02876   }
02877     
02878   <span class="comment">/* copy current path. */</span>
02879   strncpy(glob_path_dir,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
02880   
02881   <span class="comment">/* retrieves path handle*/</span>
02882   <span class="keywordflow">if</span> (rc = 
02883       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path_dir,FSAL_MAX_PATH_LEN,
02884                 path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;dir_hdl,output))
02885     <span class="keywordflow">return</span> rc;
02886 
02887   <span class="comment">/* create fsal_name_t */</span>
02888   st = FSAL_str2name(
02889       file,
02890       256,
02891       &amp;objname
02892     );
02893   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st )){
02894     fprintf(output,<span class="stringliteral">"Error executing FSAL_str2name:"</span>);
02895     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02896     fprintf(output,<span class="stringliteral">"\n"</span>);
02897     <span class="keywordflow">return</span> st.major;
02898   }
02899 
02900   st = FSAL_create(
02901           &amp;dir_hdl,  <span class="comment">/* IN */</span>
02902           &amp;objname,  <span class="comment">/* IN */</span>
02903           &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,     <span class="comment">/* IN */</span>
02904           fsalmode,  <span class="comment">/* IN */</span>
02905           &amp;file_hdl, <span class="comment">/* OUT */</span>
02906           <a class="code" href="Getopt_8c.html#a0">NULL</a>  <span class="comment">/* [ IN/OUT ] */</span>
02907         );
02908   
02909   
02910   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st)){
02911     fprintf(output,<span class="stringliteral">"Error executing FSAL_create:"</span>);
02912     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
02913     fprintf(output,<span class="stringliteral">"\n"</span>);
02914     <span class="keywordflow">return</span> st.major;
02915   }
02916 
02917   <span class="keywordflow">if</span> (flag_v)
02918   {
02919     <span class="keywordtype">char</span> buff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];  
02920     snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;file_hdl);
02921   
02922     fprintf(output,<span class="stringliteral">"%s/%s successfully created (@%s) \n"</span>,glob_path_dir,file,buff);
02923 
02924   }
02925 
02926       
02927   <span class="keywordflow">return</span> 0;
02928   
02929 }
02930 
02931 
02932 
02933 <span class="comment">/* setattr</span>
02934 <span class="comment"> *</span>
02935 <span class="comment"> * syntax of command line:</span>
02936 <span class="comment"> * setattr file_path  attribute_name  attribute_value</span>
02937 <span class="comment"> *</span>
02938 <span class="comment"> */</span>
<a name="l02939"></a><a class="code" href="commands__FSAL_8c.html#a33">02939</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a33">fn_fsal_setattr</a>(
02940         <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
02941         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
02942         FILE * output      <span class="comment">/* IN : output stream          */</span>
02943       )
02944 {
02945   
02946   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
02947    
02948   <span class="keyword">static</span> <span class="keywordtype">char</span> help_setattr[]=
02949   <span class="stringliteral">"usage: setattr [-h][-v] &lt;path&gt; &lt;attr&gt;=&lt;value&gt;,&lt;attr&gt;=&lt;value&gt;,...\n"</span>;
02950 
02951   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];  <span class="comment">/* absolute path of the object */</span>
02952   fsal_handle_t obj_hdl;              <span class="comment">/* handle of the object */</span>
02953   fsal_attrib_list_t set_attrs;       <span class="comment">/* attributes to be setted */</span>
02954   fsal_status_t st;                   <span class="comment">/* FSAL return status */</span>
02955   
02956   <span class="keywordtype">int</span> rc,option;
02957   <span class="keywordtype">int</span> flag_v=0;
02958   <span class="keywordtype">int</span> flag_h=0;
02959   <span class="keywordtype">int</span> err_flag=0;
02960   
02961   <span class="keywordtype">char</span> * file = NULL;        <span class="comment">/* the relative path to the object */</span>
02962   <span class="keywordtype">char</span> * attr_list = NULL;   <span class="comment">/* attribute list */</span>
02963       
02964   
02965   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
02966 
02967   <span class="comment">/* is the fs initialized ? */</span>
02968   <span class="keywordflow">if</span> (!is_loaded){
02969     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
02970     <span class="keywordflow">return</span> -1;
02971   }  
02972   
02973   <span class="comment">/* initialize current thread */</span>
02974     
02975   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
02976   
02977   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
02978   { 
02979     <span class="keywordtype">int</span> rc;
02980     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
02981     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
02982   }
02983   
02984   <span class="comment">/* analysing options */</span>
02985   
02986   getopt_init();
02987   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1)
02988   {   
02989     <span class="keywordflow">switch</span>(option){
02990       
02991       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
02992         <span class="keywordflow">if</span> (flag_v)
02993           fprintf(output,
02994               <span class="stringliteral">"setattr: warning: option 'v' has been specified more than once.\n"</span>);
02995         <span class="keywordflow">else</span> flag_v++;
02996         <span class="keywordflow">break</span>;
02997         
02998       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
02999         <span class="keywordflow">if</span> ( flag_h )
03000           fprintf(output,
03001               <span class="stringliteral">"setattr: warning: option 'h' has been specified more than once.\n"</span>);
03002         <span class="keywordflow">else</span> flag_h++;
03003         <span class="keywordflow">break</span>;
03004         
03005       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
03006         fprintf(output,<span class="stringliteral">"setattr: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
03007         err_flag ++;
03008         <span class="keywordflow">break</span>;
03009     }    
03010   }
03011   
03012   <span class="keywordflow">if</span> (flag_h){
03013     
03014     <a class="code" href="structshell__attribute____.html">shell_attribute_t</a> * curr_attr;
03015     
03016     <span class="comment">/* print usage */</span>
03017     fprintf(output,help_setattr);
03018     
03019     fprintf(output,<span class="stringliteral">"\n&lt;attr&gt; can be one of the following values:\n"</span>);
03020     
03021     <span class="comment">/* print attribute list */</span>
03022     
03023     <span class="keywordflow">for</span> ( curr_attr = shell_attr_list; curr_attr-&gt;<a class="code" href="structshell__attribute____.html#o1">attr_type</a> != ATTR_NONE; curr_attr++ )
03024     {
03025       <span class="keywordflow">switch</span>( curr_attr-&gt;<a class="code" href="structshell__attribute____.html#o1">attr_type</a>)
03026       {              
03027         <span class="keywordflow">case</span> <a class="code" href="cmd__tools_8h.html#a26a5">ATTR_32</a>:        
03028           fprintf( output, <span class="stringliteral">"\t %s \t:\t 32 bits integer\n"</span>,curr_attr-&gt;<a class="code" href="structshell__attribute____.html#o0">attr_name</a> );
03029           <span class="keywordflow">break</span>;
03030         <span class="keywordflow">case</span> <a class="code" href="cmd__tools_8h.html#a26a6">ATTR_64</a>:
03031           fprintf( output, <span class="stringliteral">"\t %s \t:\t 64 bits integer\n"</span>,curr_attr-&gt;<a class="code" href="structshell__attribute____.html#o0">attr_name</a> );
03032           <span class="keywordflow">break</span>;
03033         <span class="keywordflow">case</span> <a class="code" href="cmd__tools_8h.html#a26a7">ATTR_OCTAL</a>:
03034           fprintf( output, <span class="stringliteral">"\t %s \t:\t octal\n"</span>,curr_attr-&gt;<a class="code" href="structshell__attribute____.html#o0">attr_name</a> );
03035           <span class="keywordflow">break</span>;
03036         <span class="keywordflow">case</span> <a class="code" href="cmd__tools_8h.html#a26a8">ATTR_TIME</a>:
03037           fprintf( output, <span class="stringliteral">"\t %s \t:\t time (format: YYYYMMDDhhmmss)\n"</span>,curr_attr-&gt;<a class="code" href="structshell__attribute____.html#o0">attr_name</a> );
03038           <span class="keywordflow">break</span>;
03039       }
03040     }    
03041     
03042     <span class="keywordflow">return</span> 0;
03043   }
03044   
03045   <span class="comment">/* Exactly 2 args expected (path and attributes) */</span>
03046   
03047   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-2)){
03048     err_flag ++;
03049   } <span class="keywordflow">else</span> {
03050     file = argv[Optind];
03051     attr_list = argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1];
03052   }
03053   
03054   <span class="keywordflow">if</span> (err_flag){
03055     fprintf(output,help_setattr);
03056     <span class="keywordflow">return</span> -1;
03057   }
03058     
03059   <span class="comment">/* copy current absolute path to a local variable. */</span>
03060   
03061   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
03062   
03063   <span class="comment">/* retrieve handle to the file whose attributes are to be changed */</span>
03064   
03065   rc = <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>( glob_path, FSAL_MAX_PATH_LEN, file, context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,
03066       &amp;obj_hdl, output ) ;
03067   <span class="keywordflow">if</span> (rc) <span class="keywordflow">return</span> rc;
03068   
03069   <span class="comment">/* Convert the peers (attr_name,attr_val) to an FSAL attribute structure. */</span>
03070   rc = <a class="code" href="cmd__tools_8h.html#a23">MkFSALSetAttrStruct</a>( attr_list, &amp;set_attrs );
03071   
03072   <span class="comment">/* interprets output code */</span>
03073   <span class="keywordflow">switch</span> (rc)
03074   {
03075     <span class="keywordflow">case</span> 0:
03076       <span class="comment">/* OK */</span>
03077       <span class="keywordflow">break</span>;
03078       
03079     <span class="keywordflow">case</span> EFAULT:
03080       fprintf(output,<span class="stringliteral">"setattr: Internal error.\n"</span>);
03081       <span class="keywordflow">return</span> rc;
03082       
03083     <span class="keywordflow">case</span> ENOENT:
03084       fprintf(output,<span class="stringliteral">"setattr: Unknown attribute in list %s\n"</span>,attr_list);
03085       <span class="keywordflow">return</span> rc;
03086       
03087     <span class="keywordflow">case</span> EINVAL:
03088       fprintf(output,<span class="stringliteral">"setattr: Invalid value for attribute in list %s\n"</span>, attr_list );
03089       <span class="keywordflow">return</span> rc;
03090       
03091     <span class="keywordflow">default</span>:
03092       fprintf(output,<span class="stringliteral">"setattr: Error %d converting attributes.\n"</span>,rc );
03093       <span class="keywordflow">return</span> rc;
03094   }
03095   
03096   <span class="comment">/* if verbose mode is on, we print the attributes to be set */</span>    
03097   <span class="keywordflow">if</span> (flag_v){
03098       <a class="code" href="cmd__tools_8h.html#a21">print_fsal_attributes</a>( set_attrs, output );
03099   }
03100   
03101   
03102   <span class="comment">/* executes set attrs */</span>
03103   
03104   st = FSAL_setattrs( &amp;obj_hdl, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, &amp;set_attrs, <a class="code" href="Getopt_8c.html#a0">NULL</a> );
03105     
03106   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
03107     fprintf(output,<span class="stringliteral">"Error executing FSAL_setattrs:"</span>);
03108     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
03109     fprintf(output,<span class="stringliteral">"\n"</span>);
03110     <span class="keywordflow">return</span> st.major;
03111   }
03112   
03113   <span class="keywordflow">return</span> 0;
03114   
03115 }
03116 
03117 
03118 
<a name="l03125"></a><a class="code" href="commands__FSAL_8c.html#a34">03125</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a34">fn_fsal_access</a>(
03126         <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
03127         <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
03128         FILE * output      <span class="comment">/* IN : output stream          */</span>
03129       )
03130 {
03131   
03132   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hvA"</span>;
03133    
03134   <span class="keyword">static</span> <span class="keywordtype">char</span> help_access[]=
03135   <span class="stringliteral">"usage: access [-h][-v][-A] &lt;rights&gt; &lt;path&gt;\n"</span>
03136   <span class="stringliteral">"\n"</span>
03137   <span class="stringliteral">"   -h : print this help\n"</span>
03138   <span class="stringliteral">"   -v : verbose mode\n"</span>
03139   <span class="stringliteral">"   -A : test access from attributes\n"</span>
03140   <span class="stringliteral">"        ( call to getattr + test_access instead of access )\n"</span>
03141   <span class="stringliteral">"\n"</span>
03142   <span class="stringliteral">" &lt;rights&gt; : a set of the following characters:\n"</span>
03143   <span class="stringliteral">"    F: test file existence\n"</span>
03144   <span class="stringliteral">"    R: test read permission\n"</span>
03145   <span class="stringliteral">"    W: test write permission\n"</span>
03146   <span class="stringliteral">"    X: test execute permission\n"</span>
03147   <span class="stringliteral">"\n"</span>
03148   <span class="stringliteral">"Example: access -A RX my_dir\n"</span>
03149   <span class="stringliteral">"test read and exec rights for directory \"my_dir\"\n"</span>
03150   <span class="stringliteral">"by doing a getattr and a test_access call.\n\n"</span>;
03151   
03152 
03153   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];  <span class="comment">/* absolute path of the object */</span>
03154   fsal_handle_t       obj_hdl;        <span class="comment">/* handle of the object */</span>
03155   fsal_accessflags_t  test_perms;     <span class="comment">/* permissions to be tested */</span>
03156   fsal_status_t st;                   <span class="comment">/* FSAL return status */</span>
03157   
03158   <span class="keywordtype">int</span> rc,option;
03159   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
03160   <span class="keywordtype">int</span> flag_v=0;
03161   <span class="keywordtype">int</span> flag_h=0;
03162   <span class="keywordtype">int</span> flag_A=0;
03163   <span class="keywordtype">int</span> err_flag=0;
03164   
03165   <span class="keywordtype">char</span> * file = NULL;        <span class="comment">/* the relative path to the object */</span>  
03166   <span class="keywordtype">char</span> * str_perms = NULL;   <span class="comment">/* string that represents the permissions to be tested */</span>
03167       
03168   
03169   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
03170 
03171   <span class="comment">/* is the fs initialized ? */</span>
03172   <span class="keywordflow">if</span> (!is_loaded){
03173     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
03174     <span class="keywordflow">return</span> -1;
03175   }  
03176   
03177   <span class="comment">/* initialize current thread */</span>
03178     
03179   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
03180   
03181   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
03182   { 
03183     <span class="keywordtype">int</span> rc;
03184     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
03185     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
03186   }
03187   
03188   <span class="comment">/* analysing options */</span>
03189   
03190   getopt_init();
03191   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1)
03192   {   
03193     <span class="keywordflow">switch</span>(option){
03194       
03195       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
03196         <span class="keywordflow">if</span> (flag_v)
03197           fprintf(output,
03198               <span class="stringliteral">"access: warning: option 'v' has been specified more than once.\n"</span>);
03199         <span class="keywordflow">else</span> flag_v++;
03200         <span class="keywordflow">break</span>;
03201         
03202       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
03203         <span class="keywordflow">if</span> ( flag_h )
03204           fprintf(output,
03205               <span class="stringliteral">"access: warning: option 'h' has been specified more than once.\n"</span>);
03206         <span class="keywordflow">else</span> flag_h++;
03207         <span class="keywordflow">break</span>;
03208         
03209       <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
03210         <span class="keywordflow">if</span> ( flag_A )
03211           fprintf(output,
03212               <span class="stringliteral">"access: warning: option 'A' has been specified more than once.\n"</span>);
03213         <span class="keywordflow">else</span> flag_A++;
03214         <span class="keywordflow">break</span>;
03215         
03216       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
03217         fprintf(output,<span class="stringliteral">"access: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
03218         err_flag ++;
03219         <span class="keywordflow">break</span>;
03220     }    
03221   }
03222   
03223   <span class="keywordflow">if</span> (flag_h){
03224     
03225     <span class="comment">/* print usage */</span>
03226     fprintf(output,help_access);    
03227     <span class="keywordflow">return</span> 0;
03228     
03229   }
03230   
03231   <span class="comment">/* Exactly 2 args expected */</span>
03232   
03233   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-2)){
03234     err_flag ++;
03235   } <span class="keywordflow">else</span> {
03236     str_perms = argv[Optind];
03237     file = argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1];
03238   }
03239   
03240   <span class="keywordflow">if</span> (err_flag){
03241     fprintf(output,help_access);
03242     <span class="keywordflow">return</span> -1;
03243   }
03244     
03245   <span class="comment">/* copy current absolute path to a local variable. */</span>
03246   
03247   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
03248   
03249   <span class="comment">/* retrieve handle to the file whose permissions are to be tested */</span>
03250   
03251   rc = <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>( glob_path, FSAL_MAX_PATH_LEN, file, context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>, &amp;obj_hdl, output );
03252   <span class="keywordflow">if</span> (rc) <span class="keywordflow">return</span> rc;
03253     
03254   
03255   <span class="comment">/* Convert the permission string to an fsal access test. */</span>
03256   
03257   test_perms = 0;
03258   
03259   <span class="keywordflow">for</span> ( i=0; i &lt; strlen(str_perms); i++ )
03260   {    
03261     <span class="keywordflow">switch</span>( str_perms[i] )
03262     {
03263       <span class="keywordflow">case</span> <span class="charliteral">'F'</span>:        
03264         <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"F_OK flag\n"</span>);
03265         test_perms |= FSAL_F_OK ;
03266         <span class="keywordflow">break</span>;
03267         
03268       <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
03269         <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"R_OK flag\n"</span>);
03270         test_perms |= FSAL_R_OK ;
03271         <span class="keywordflow">break</span>;
03272         
03273       <span class="keywordflow">case</span> <span class="charliteral">'W'</span>:
03274         <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"W_OK flag\n"</span>);
03275         test_perms |= FSAL_W_OK ;
03276         <span class="keywordflow">break</span>;
03277         
03278       <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:      
03279         <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"X_OK flag\n"</span>);
03280         test_perms |= FSAL_X_OK ;
03281         <span class="keywordflow">break</span>;
03282         
03283       <span class="keywordflow">default</span>:
03284         fprintf(output,<span class="stringliteral">"**** Invalid test: %c ****\n"</span>, str_perms[i] );
03285         fprintf(output,help_access);
03286         <span class="keywordflow">return</span> -1;
03287     }    
03288   }  
03289   
03290   
03291   <span class="comment">/* Call to FSAL */</span>
03292   
03293   <span class="keywordflow">if</span> ( flag_A )
03294   {
03295     fsal_attrib_list_t attributes;
03296         
03297     <span class="comment">/* 1st method: get attr and test_access */</span>  
03298     
03299     FSAL_CLEAR_MASK( attributes.asked_attributes );
03300     FSAL_SET_MASK( attributes.asked_attributes,
03301         FSAL_ATTR_MODE | FSAL_ATTR_OWNER |  FSAL_ATTR_GROUP | FSAL_ATTR_ACL );
03302     
03303     <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Getting file attributes...\n"</span>);
03304     
03305     st = FSAL_getattrs( &amp;obj_hdl, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, &amp;attributes );
03306     
03307     <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
03308       fprintf(output,<span class="stringliteral">"Error executing FSAL_getattrs:"</span>);
03309       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
03310       fprintf(output,<span class="stringliteral">"\n"</span>);
03311       <span class="keywordflow">return</span> st.major;
03312     }
03313 
03314     <span class="keywordflow">if</span> ( flag_v )
03315     {
03316       <a class="code" href="cmd__tools_8h.html#a21">print_fsal_attributes</a>( attributes, output );
03317     }
03318         
03319     <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Testing access rights...\n"</span>);
03320     
03321     st = FSAL_test_access( &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, test_perms, &amp;attributes);
03322     
03323     <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
03324       
03325       fprintf(output,<span class="stringliteral">"Error executing FSAL_test_access:"</span>);
03326       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
03327       fprintf(output,<span class="stringliteral">"\n"</span>);
03328       <span class="keywordflow">return</span> st.major;
03329       
03330     } <span class="keywordflow">else</span> {
03331       
03332       fprintf(output,<span class="stringliteral">"access: Access granted.\n"</span>);
03333       <span class="keywordflow">return</span> 0;
03334         
03335     }
03336     
03337       
03338   }
03339   <span class="keywordflow">else</span>
03340   {
03341     <span class="comment">/* 2nd method: simply calling access */</span>
03342     
03343     <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Calling access\n"</span>);
03344     
03345     st = FSAL_access( &amp;obj_hdl, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a> ,test_perms, <a class="code" href="Getopt_8c.html#a0">NULL</a> );
03346     
03347     <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
03348       
03349       fprintf(output,<span class="stringliteral">"Error executing FSAL_access:"</span>);
03350       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
03351       fprintf(output,<span class="stringliteral">"\n"</span>);
03352       <span class="keywordflow">return</span> st.major;
03353       
03354     } <span class="keywordflow">else</span> {
03355       
03356       fprintf(output,<span class="stringliteral">"access: Access granted.\n"</span>);
03357       <span class="keywordflow">return</span> 0;     
03358     }
03359   
03360   }
03361   
03362 }
03363 
03364 
03365 
03366 
03367 
03368 
<a name="l03370"></a><a class="code" href="commands__FSAL_8c.html#a35">03370</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a35">fn_fsal_truncate</a>( <span class="keywordtype">int</span> argc ,  <span class="comment">/* IN : number of args in argv */</span>
03371         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
03372         FILE * output             <span class="comment">/* IN : output stream          */</span>
03373       ){
03374   
03375   
03376   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
03377    
03378   <span class="keyword">static</span> <span class="keywordtype">char</span> help_truncate[]=
03379   <span class="stringliteral">"usage: truncate [-h][-v] &lt;file&gt; &lt;size&gt;\n"</span>;
03380 
03381   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
03382   fsal_handle_t filehdl;
03383   
03384   fsal_status_t st;
03385   fsal_size_t trunc_size;
03386   
03387   <span class="keywordtype">int</span> rc,option;
03388   <span class="keywordtype">int</span> flag_v=0;
03389   <span class="keywordtype">int</span> flag_h=0;
03390   <span class="keywordtype">int</span> err_flag=0;
03391   
03392   <span class="keywordtype">char</span> * file = NULL;
03393   <span class="keywordtype">char</span> * str_size = NULL;
03394     
03395   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
03396 
03397   <span class="comment">/* is the fs initialized ? */</span>
03398   <span class="keywordflow">if</span> (!is_loaded){
03399     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
03400     <span class="keywordflow">return</span> -1;
03401   }  
03402   
03403   <span class="comment">/* initialize current thread */</span>
03404     
03405   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
03406   
03407   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
03408   { 
03409     <span class="keywordtype">int</span> rc;
03410     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
03411     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
03412   }
03413   
03414   <span class="comment">/* analysing options */</span>
03415   getopt_init();
03416   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
03417     <span class="keywordflow">switch</span>(option){
03418       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
03419         <span class="keywordflow">if</span> (flag_v)
03420           fprintf(output,
03421               <span class="stringliteral">"truncate: warning: option 'v' has been specified more than once.\n"</span>);
03422         <span class="keywordflow">else</span> flag_v++;
03423         <span class="keywordflow">break</span>;
03424       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
03425         <span class="keywordflow">if</span> ( flag_h )
03426           fprintf(output,
03427               <span class="stringliteral">"truncate: warning: option 'h' has been specified more than once.\n"</span>);
03428         <span class="keywordflow">else</span> flag_h++;
03429         <span class="keywordflow">break</span>;
03430       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
03431         fprintf(output,<span class="stringliteral">"truncate: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
03432         err_flag ++;
03433         <span class="keywordflow">break</span>;
03434     }    
03435   }
03436   
03437   <span class="keywordflow">if</span> (flag_h){
03438     fprintf(output,help_truncate);
03439     <span class="keywordflow">return</span> 0;
03440   }
03441   
03442   <span class="comment">/* Exactly two arg expected */</span>
03443   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-2)){
03444     err_flag ++;
03445   } <span class="keywordflow">else</span> {
03446     file = argv[Optind];
03447     str_size = argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1];
03448     
03449     rc = <a class="code" href="cmd__tools_8h.html#a12">ato64</a>( str_size, &amp;trunc_size );
03450     <span class="keywordflow">if</span> ( rc == -1 ){
03451       fprintf(output,<span class="stringliteral">"truncate: error: invalid trunc size \"%s\"\n"</span>,
03452           str_size);
03453       err_flag++;
03454     }
03455     
03456   }
03457   
03458   <span class="keywordflow">if</span> (err_flag){
03459     fprintf(output,help_truncate);
03460     <span class="keywordflow">return</span> -1;
03461   }
03462     
03463   <span class="comment">/* copy current path. */</span>
03464   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
03465   
03466   <span class="comment">/* retrieves object handle*/</span>
03467   <span class="keywordflow">if</span> (rc = 
03468       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
03469                 file,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;filehdl,output))
03470     <span class="keywordflow">return</span> rc;
03471 
03472   <span class="keywordflow">if</span> (flag_v)
03473     fprintf(output,<span class="stringliteral">"Truncating \"%s\" to %llu bytes.\n"</span>,glob_path,trunc_size);
03474   
03475   st = FSAL_truncate(
03476       &amp;filehdl,
03477       &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,
03478       trunc_size,
03479       <a class="code" href="Getopt_8c.html#a0">NULL</a> );
03480     
03481   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
03482     fprintf(output,<span class="stringliteral">"Error executing FSAL_truncate:"</span>);
03483     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
03484     fprintf(output,<span class="stringliteral">"\n"</span>);
03485     <span class="keywordflow">return</span> st.major;
03486   }
03487   
03488   <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Truncate operation completed sucessfully.\n"</span>);   
03489     
03490   <span class="keywordflow">return</span> 0;
03491   
03492 }
03493 
<a name="l03498"></a><a class="code" href="commands__FSAL_8c.html#a36">03498</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a36">fn_fsal_open_byname</a>(
03499         <span class="keywordtype">int</span> argc ,                <span class="comment">/* IN : number of args in argv */</span>
03500         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
03501         FILE * output             <span class="comment">/* IN : output stream          */</span>
03502       )
03503   {
03504   
03505   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
03506    
03507   <span class="keyword">static</span> <span class="keywordtype">char</span> help_open[]=
03508     <span class="stringliteral">"usage: open_byname [-h][-v] &lt;path&gt; [&lt;oflags&gt;]\n"</span>
03509     <span class="stringliteral">"   where &lt;oflags&gt; is a set of the following values:\n"</span>
03510     <span class="stringliteral">"   'r': read, 'w': write, 'a': append, 't': truncate.\n"</span>;
03511 
03512   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
03513   fsal_handle_t filehdl;
03514   fsal_name_t filename ;
03515  
03516   fsal_status_t st;
03517   
03518   <span class="keywordtype">int</span> rc,option;
03519   <span class="keywordtype">int</span> flag_v=0;
03520   <span class="keywordtype">int</span> flag_h=0;
03521   <span class="keywordtype">int</span> err_flag=0;
03522 
03523   fsal_openflags_t o_flags;
03524       
03525   <span class="keywordtype">int</span> flag_r=0;
03526   <span class="keywordtype">int</span> flag_w=0;
03527   <span class="keywordtype">int</span> flag_a=0;
03528   <span class="keywordtype">int</span> flag_t=0;
03529   
03530     
03531   <span class="keywordtype">char</span> * file = NULL;
03532   <span class="keywordtype">char</span> * opt_str;
03533     
03534   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
03535 
03536   <span class="comment">/* is the fs initialized ? */</span>
03537   <span class="keywordflow">if</span> (!is_loaded){
03538     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
03539     <span class="keywordflow">return</span> -1;
03540   }  
03541   
03542   <span class="comment">/* initialize current thread */</span>
03543     
03544   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
03545   
03546   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
03547   { 
03548     <span class="keywordtype">int</span> rc;
03549     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
03550     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
03551   }
03552   
03553   <span class="comment">/* is a file already opened ? */</span>
03554   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> )
03555   {
03556     fprintf(output,<span class="stringliteral">"Error: a file is already opened. Use 'close' command first.\n"</span>);
03557     <span class="keywordflow">return</span> -1;
03558   }
03559   
03560   <span class="comment">/* analysing options */</span>
03561   
03562   getopt_init();
03563   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
03564     <span class="keywordflow">switch</span>(option){
03565       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
03566         <span class="keywordflow">if</span> (flag_v)
03567           fprintf(output,
03568               <span class="stringliteral">"open: warning: option 'v' has been specified more than once.\n"</span>);
03569         <span class="keywordflow">else</span> flag_v++;
03570         <span class="keywordflow">break</span>;
03571       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
03572         <span class="keywordflow">if</span> ( flag_h )
03573           fprintf(output,
03574               <span class="stringliteral">"open: warning: option 'h' has been specified more than once.\n"</span>);
03575         <span class="keywordflow">else</span> flag_h++;
03576         <span class="keywordflow">break</span>;
03577       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
03578         fprintf(output,<span class="stringliteral">"open: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
03579         err_flag ++;
03580         <span class="keywordflow">break</span>;
03581     }    
03582   }
03583   
03584   <span class="keywordflow">if</span> (flag_h){
03585     fprintf(output,help_open);
03586     <span class="keywordflow">return</span> 0;
03587   }
03588   
03589   <span class="comment">/* one or two args expected */</span>
03590   <span class="keywordflow">if</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> &gt; (argc-1) )
03591     err_flag ++;
03592   <span class="keywordflow">else</span>
03593   {
03594     file = argv[Optind];
03595     
03596     <a class="code" href="Getopt_8c.html#a4">Optind</a>++;
03597     
03598     <span class="comment">/* optional flags */</span>
03599     <span class="keywordflow">while</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> &lt; argc )
03600     {
03601       <span class="comment">/* test flags */</span>
03602       opt_str = argv[Optind];
03603       
03604       <span class="keywordflow">while</span> (*opt_str)
03605       {
03606         <span class="keywordflow">switch</span>( *opt_str )
03607         {
03608           <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
03609           <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
03610             flag_r ++;
03611             <span class="keywordflow">break</span>;
03612             
03613           <span class="keywordflow">case</span> <span class="charliteral">'w'</span>:
03614           <span class="keywordflow">case</span> <span class="charliteral">'W'</span>:
03615             flag_w ++;
03616             <span class="keywordflow">break</span>;
03617             
03618           <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
03619           <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
03620             flag_a ++;
03621             <span class="keywordflow">break</span>;
03622 
03623           <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
03624           <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
03625             flag_t ++;
03626             <span class="keywordflow">break</span>;
03627           
03628           <span class="keywordflow">default</span>:
03629             fprintf(output,<span class="stringliteral">"open_byname: unknown open flag : '%c'\n"</span>,*opt_str);
03630             err_flag ++;            
03631         }
03632         opt_str ++;
03633       }
03634       
03635       <a class="code" href="Getopt_8c.html#a4">Optind</a>++;
03636     }
03637         
03638   }
03639 
03640   
03641 
03642   <span class="keywordflow">if</span> (err_flag){
03643     fprintf(output,help_open);
03644     <span class="keywordflow">return</span> -1;
03645   }
03646 
03647   <span class="comment">/* Convert filename to fsal_name_t */</span>
03648   <span class="keywordflow">if</span> (FSAL_IS_ERROR(st = FSAL_str2name(file,FSAL_MAX_PATH_LEN,&amp;filename))){
03649       fprintf(output,<span class="stringliteral">"Error executing FSAL_str2name:"</span>);
03650       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
03651       fprintf(output,<span class="stringliteral">"\n"</span>);
03652       <span class="keywordflow">return</span> st.major;
03653     }
03654 
03655   
03656   <span class="comment">/* make open flags */</span>
03657   
03658   o_flags = 0;
03659   
03660   <span class="keywordflow">if</span> (flag_r &amp;&amp; flag_w ) o_flags |= FSAL_O_RDWR ;
03661   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_r) o_flags |= FSAL_O_RDONLY ;
03662   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_w) o_flags |= FSAL_O_WRONLY ;
03663   
03664   <span class="keywordflow">if</span> (flag_a) o_flags |= FSAL_O_APPEND ;
03665   <span class="keywordflow">if</span> (flag_t) o_flags |= FSAL_O_TRUNC ;
03666   
03667   <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Open operation on %s with flags %#X.\n"</span>,glob_path,
03668                       o_flags );
03669   
03670   st = FSAL_open_by_name( &amp;(context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>), &amp;filename, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, o_flags, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o6">current_fd</a> , <a class="code" href="Getopt_8c.html#a0">NULL</a> );
03671   
03672   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
03673     fprintf(output,<span class="stringliteral">"Error executing FSAL_open:"</span>);
03674     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
03675     fprintf(output,<span class="stringliteral">"\n"</span>);
03676     <span class="keywordflow">return</span> st.major;
03677   }
03678   
03679   <span class="comment">/* note that a file is opened. */</span>
03680   context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> = TRUE;
03681   
03682   <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Open operation completed sucessfully : fd = %d.\n"</span>, FSAL_FILENO(&amp;(context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o6">current_fd</a>)) );
03683     
03684   <span class="keywordflow">return</span> 0;
03685   
03686 }
03687 
03688     
<a name="l03693"></a><a class="code" href="commands__FSAL_8c.html#a37">03693</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a37">fn_fsal_open</a>(
03694         <span class="keywordtype">int</span> argc ,                <span class="comment">/* IN : number of args in argv */</span>
03695         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
03696         FILE * output             <span class="comment">/* IN : output stream          */</span>
03697       )
03698   {
03699   
03700   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
03701    
03702   <span class="keyword">static</span> <span class="keywordtype">char</span> help_open[]=
03703     <span class="stringliteral">"usage: open [-h][-v] &lt;path&gt; [&lt;oflags&gt;]\n"</span>
03704     <span class="stringliteral">"   where &lt;oflags&gt; is a set of the following values:\n"</span>
03705     <span class="stringliteral">"   'r': read, 'w': write, 'a': append, 't': truncate.\n"</span>;
03706 
03707   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
03708   fsal_handle_t filehdl;
03709   
03710   fsal_status_t st;
03711   
03712   <span class="keywordtype">int</span> rc,option;
03713   <span class="keywordtype">int</span> flag_v=0;
03714   <span class="keywordtype">int</span> flag_h=0;
03715   <span class="keywordtype">int</span> err_flag=0;
03716 
03717   fsal_openflags_t o_flags;
03718       
03719   <span class="keywordtype">int</span> flag_r=0;
03720   <span class="keywordtype">int</span> flag_w=0;
03721   <span class="keywordtype">int</span> flag_a=0;
03722   <span class="keywordtype">int</span> flag_t=0;
03723   
03724     
03725   <span class="keywordtype">char</span> * file = NULL;
03726   <span class="keywordtype">char</span> * opt_str;
03727     
03728   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
03729 
03730   <span class="comment">/* is the fs initialized ? */</span>
03731   <span class="keywordflow">if</span> (!is_loaded){
03732     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
03733     <span class="keywordflow">return</span> -1;
03734   }  
03735   
03736   <span class="comment">/* initialize current thread */</span>
03737     
03738   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
03739   
03740   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
03741   { 
03742     <span class="keywordtype">int</span> rc;
03743     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
03744     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
03745   }
03746   
03747   <span class="comment">/* is a file already opened ? */</span>
03748   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> )
03749   {
03750     fprintf(output,<span class="stringliteral">"Error: a file is already opened. Use 'close' command first.\n"</span>);
03751     <span class="keywordflow">return</span> -1;
03752   }
03753   
03754   <span class="comment">/* analysing options */</span>
03755   
03756   getopt_init();
03757   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
03758     <span class="keywordflow">switch</span>(option){
03759       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
03760         <span class="keywordflow">if</span> (flag_v)
03761           fprintf(output,
03762               <span class="stringliteral">"open: warning: option 'v' has been specified more than once.\n"</span>);
03763         <span class="keywordflow">else</span> flag_v++;
03764         <span class="keywordflow">break</span>;
03765       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
03766         <span class="keywordflow">if</span> ( flag_h )
03767           fprintf(output,
03768               <span class="stringliteral">"open: warning: option 'h' has been specified more than once.\n"</span>);
03769         <span class="keywordflow">else</span> flag_h++;
03770         <span class="keywordflow">break</span>;
03771       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
03772         fprintf(output,<span class="stringliteral">"open: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
03773         err_flag ++;
03774         <span class="keywordflow">break</span>;
03775     }    
03776   }
03777   
03778   <span class="keywordflow">if</span> (flag_h){
03779     fprintf(output,help_open);
03780     <span class="keywordflow">return</span> 0;
03781   }
03782   
03783   <span class="comment">/* one or two args expected */</span>
03784   <span class="keywordflow">if</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> &gt; (argc-1) )
03785     err_flag ++;
03786   <span class="keywordflow">else</span>
03787   {
03788     file = argv[Optind];
03789     
03790     <a class="code" href="Getopt_8c.html#a4">Optind</a>++;
03791     
03792     <span class="comment">/* optional flags */</span>
03793     <span class="keywordflow">while</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> &lt; argc )
03794     {
03795       <span class="comment">/* test flags */</span>
03796       opt_str = argv[Optind];
03797       
03798       <span class="keywordflow">while</span> (*opt_str)
03799       {
03800         <span class="keywordflow">switch</span>( *opt_str )
03801         {
03802           <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
03803           <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
03804             flag_r ++;
03805             <span class="keywordflow">break</span>;
03806             
03807           <span class="keywordflow">case</span> <span class="charliteral">'w'</span>:
03808           <span class="keywordflow">case</span> <span class="charliteral">'W'</span>:
03809             flag_w ++;
03810             <span class="keywordflow">break</span>;
03811             
03812           <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
03813           <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
03814             flag_a ++;
03815             <span class="keywordflow">break</span>;
03816 
03817           <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
03818           <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
03819             flag_t ++;
03820             <span class="keywordflow">break</span>;
03821           
03822           <span class="keywordflow">default</span>:
03823             fprintf(output,<span class="stringliteral">"open: unknown open flag : '%c'\n"</span>,*opt_str);
03824             err_flag ++;            
03825         }
03826         opt_str ++;
03827       }
03828       
03829       <a class="code" href="Getopt_8c.html#a4">Optind</a>++;
03830     }
03831         
03832   }
03833 
03834   <span class="keywordflow">if</span> (err_flag){
03835     fprintf(output,help_open);
03836     <span class="keywordflow">return</span> -1;
03837   }
03838     
03839   <span class="comment">/* copy current path. */</span>
03840   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
03841   
03842   <span class="comment">/* retrieves object handle*/</span>
03843   <span class="keywordflow">if</span> (rc = 
03844       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
03845                 file,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;filehdl,output))
03846     <span class="keywordflow">return</span> rc;
03847 
03848   <span class="comment">/* make open flags */</span>
03849   
03850   o_flags = 0;
03851   
03852   <span class="keywordflow">if</span> (flag_r &amp;&amp; flag_w ) o_flags |= FSAL_O_RDWR ;
03853   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_r) o_flags |= FSAL_O_RDONLY ;
03854   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_w) o_flags |= FSAL_O_WRONLY ;
03855   
03856   <span class="keywordflow">if</span> (flag_a) o_flags |= FSAL_O_APPEND ;
03857   <span class="keywordflow">if</span> (flag_t) o_flags |= FSAL_O_TRUNC ;
03858   
03859   <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Open operation on %s with flags %#X.\n"</span>,glob_path,
03860                       o_flags );
03861   
03862   st = FSAL_open( &amp;filehdl, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, o_flags, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o6">current_fd</a> , <a class="code" href="Getopt_8c.html#a0">NULL</a> );
03863   
03864   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
03865     fprintf(output,<span class="stringliteral">"Error executing FSAL_open:"</span>);
03866     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
03867     fprintf(output,<span class="stringliteral">"\n"</span>);
03868     <span class="keywordflow">return</span> st.major;
03869   }
03870   
03871   <span class="comment">/* note that a file is opened. */</span>
03872   context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> = TRUE;
03873   
03874   <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Open operation completed sucessfully : fd = %d.\n"</span>, FSAL_FILENO(&amp;(context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o6">current_fd</a>)) );
03875     
03876   <span class="keywordflow">return</span> 0;
03877   
03878 }
03879 
<a name="l03884"></a><a class="code" href="commands__FSAL_8c.html#a38">03884</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a38">fn_fsal_open_byfileid</a>(
03885         <span class="keywordtype">int</span> argc ,                <span class="comment">/* IN : number of args in argv */</span>
03886         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
03887         FILE * output             <span class="comment">/* IN : output stream          */</span>
03888       )
03889   {
03890   
03891   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hv"</span>;
03892    
03893   <span class="keyword">static</span> <span class="keywordtype">char</span> help_open_byfileid[]=
03894     <span class="stringliteral">"usage: open_byfileid [-h][-v] &lt;path&gt; &lt;fileid&gt; [&lt;oflags&gt;]\n"</span>
03895     <span class="stringliteral">"   where &lt;oflags&gt; is a set of the following values:\n"</span>
03896     <span class="stringliteral">"   'r': read, 'w': write, 'a': append, 't': truncate.\n"</span>;
03897 
03898   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
03899   fsal_handle_t filehdl;
03900   
03901   fsal_status_t st;
03902   
03903   <span class="keywordtype">int</span> rc,option;
03904   <span class="keywordtype">int</span> flag_v=0;
03905   <span class="keywordtype">int</span> flag_h=0;
03906   <span class="keywordtype">int</span> err_flag=0;
03907 
03908   fsal_openflags_t o_flags;
03909       
03910   <span class="keywordtype">int</span> flag_r=0;
03911   <span class="keywordtype">int</span> flag_w=0;
03912   <span class="keywordtype">int</span> flag_a=0;
03913   <span class="keywordtype">int</span> flag_t=0;
03914   
03915     
03916   <span class="keywordtype">char</span> * file = NULL;
03917   <span class="keywordtype">char</span> * strfileid = NULL ;
03918   fsal_u64_t fileid = 0LL ;
03919   <span class="keywordtype">char</span> * opt_str;
03920     
03921   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
03922 
03923   <span class="comment">/* is the fs initialized ? */</span>
03924   <span class="keywordflow">if</span> (!is_loaded){
03925     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
03926     <span class="keywordflow">return</span> -1;
03927   }  
03928   
03929   <span class="comment">/* initialize current thread */</span>
03930     
03931   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
03932   
03933   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
03934   { 
03935     <span class="keywordtype">int</span> rc;
03936     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
03937     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
03938   }
03939   
03940   <span class="comment">/* is a file already opened ? */</span>
03941   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> )
03942   {
03943     fprintf(output,<span class="stringliteral">"Error: a file is already opened. Use 'close' command first.\n"</span>);
03944     <span class="keywordflow">return</span> -1;
03945   }
03946   
03947   <span class="comment">/* analysing options */</span>
03948   
03949   getopt_init();
03950   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
03951     <span class="keywordflow">switch</span>(option){
03952       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
03953         <span class="keywordflow">if</span> (flag_v)
03954           fprintf(output,
03955               <span class="stringliteral">"open: warning: option 'v' has been specified more than once.\n"</span>);
03956         <span class="keywordflow">else</span> flag_v++;
03957         <span class="keywordflow">break</span>;
03958       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
03959         <span class="keywordflow">if</span> ( flag_h )
03960           fprintf(output,
03961               <span class="stringliteral">"open: warning: option 'h' has been specified more than once.\n"</span>);
03962         <span class="keywordflow">else</span> flag_h++;
03963         <span class="keywordflow">break</span>;
03964       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
03965         fprintf(output,<span class="stringliteral">"open: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
03966         err_flag ++;
03967         <span class="keywordflow">break</span>;
03968     }    
03969   }
03970   
03971   <span class="keywordflow">if</span> (flag_h){
03972     fprintf(output,help_open_byfileid);
03973     <span class="keywordflow">return</span> 0;
03974   }
03975   
03976   <span class="comment">/* two or three args expected */</span>
03977   <span class="keywordflow">if</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> &gt; (argc-2) )
03978     err_flag ++;
03979   <span class="keywordflow">else</span>
03980   {
03981     file = argv[Optind];
03982     strfileid = argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1] ;
03983     sscanf( strfileid, <span class="stringliteral">"%llu"</span>, &amp;fileid ) ;
03984  
03985     <a class="code" href="Getopt_8c.html#a4">Optind</a> += 2 ;
03986     
03987     <span class="comment">/* optional flags */</span>
03988     <span class="keywordflow">while</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> &lt; argc )
03989     {
03990       <span class="comment">/* test flags */</span>
03991       opt_str = argv[Optind];
03992       
03993       <span class="keywordflow">while</span> (*opt_str)
03994       {
03995         <span class="keywordflow">switch</span>( *opt_str )
03996         {
03997           <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
03998           <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
03999             flag_r ++;
04000             <span class="keywordflow">break</span>;
04001             
04002           <span class="keywordflow">case</span> <span class="charliteral">'w'</span>:
04003           <span class="keywordflow">case</span> <span class="charliteral">'W'</span>:
04004             flag_w ++;
04005             <span class="keywordflow">break</span>;
04006             
04007           <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
04008           <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
04009             flag_a ++;
04010             <span class="keywordflow">break</span>;
04011 
04012           <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
04013           <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
04014             flag_t ++;
04015             <span class="keywordflow">break</span>;
04016           
04017           <span class="keywordflow">default</span>:
04018             fprintf(output,<span class="stringliteral">"open: unknown open flag : '%c'\n"</span>,*opt_str);
04019             err_flag ++;            
04020         }
04021         opt_str ++;
04022       }
04023       
04024       <a class="code" href="Getopt_8c.html#a4">Optind</a>++;
04025     }
04026         
04027   }
04028 
04029   <span class="keywordflow">if</span> (err_flag){
04030     fprintf(output,help_open_byfileid);
04031     <span class="keywordflow">return</span> -1;
04032   }
04033     
04034   <span class="comment">/* copy current path. */</span>
04035   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
04036   
04037   <span class="comment">/* retrieves object handle*/</span>
04038   <span class="keywordflow">if</span> (rc = 
04039       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
04040                 file,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;filehdl,output))
04041     <span class="keywordflow">return</span> rc;
04042 
04043   <span class="comment">/* make open flags */</span>
04044   
04045   o_flags = 0;
04046   
04047   <span class="keywordflow">if</span> (flag_r &amp;&amp; flag_w ) o_flags |= FSAL_O_RDWR ;
04048   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_r) o_flags |= FSAL_O_RDONLY ;
04049   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_w) o_flags |= FSAL_O_WRONLY ;
04050   
04051   <span class="keywordflow">if</span> (flag_a) o_flags |= FSAL_O_APPEND ;
04052   <span class="keywordflow">if</span> (flag_t) o_flags |= FSAL_O_TRUNC ;
04053   
04054   <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Open operation on %s with flags %#X.\n"</span>,glob_path,
04055                       o_flags );
04056   
04057   st = FSAL_open_by_fileid( &amp;filehdl, fileid, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, o_flags, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o6">current_fd</a> , <a class="code" href="Getopt_8c.html#a0">NULL</a> );
04058   
04059   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
04060     fprintf(output,<span class="stringliteral">"Error executing FSAL_open:"</span>);
04061     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
04062     fprintf(output,<span class="stringliteral">"\n"</span>);
04063     <span class="keywordflow">return</span> st.major;
04064   }
04065   
04066   <span class="comment">/* note that a file is opened. */</span>
04067   context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> = TRUE;
04068   
04069   <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"Open operation completed sucessfully : fd = %d.\n"</span>, FSAL_FILENO(&amp;(context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o6">current_fd</a>)) );
04070     
04071   <span class="keywordflow">return</span> 0;
04072   
04073 }
04074 
04075 
04076 
04077 
<a name="l04081"></a><a class="code" href="commands__FSAL_8c.html#a39">04081</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a39">fn_fsal_read</a>(
04082         <span class="keywordtype">int</span> argc ,                <span class="comment">/* IN : number of args in argv */</span>
04083         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
04084         FILE * output             <span class="comment">/* IN : output stream          */</span>
04085       )
04086 {
04087   
04088   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hvAXB:s:"</span>;
04089    
04090   <span class="keyword">static</span> <span class="keywordtype">char</span> help_read[]=
04091    <span class="stringliteral">"Usage:\n"</span>
04092    <span class="stringliteral">"  read [-h][-v][-A][-X] [-B &lt;block_size&gt; ] [ -s &lt;seek_type&gt;,&lt;offset&gt; ]  { &lt;total_bytes&gt; | all }\n"</span>
04093    <span class="stringliteral">"Options:\n"</span>
04094    <span class="stringliteral">"  -h: print this help\n"</span>
04095    <span class="stringliteral">"  -v: verbose mode\n"</span>
04096    <span class="stringliteral">"  -A: display read data in ascii\n"</span>
04097    <span class="stringliteral">"  -X: display read data in hexa\n"</span>
04098    <span class="stringliteral">"  -B &lt;blocksize&gt;: block size used for reading, in bytes (default 1k).\n"</span>
04099    <span class="stringliteral">"  -s &lt;seek_type&gt;,&lt;offset&gt;: specify the position of the first byte to be read.\n"</span>
04100    <span class="stringliteral">"        &lt;seek_type&gt; can take the values SET, CUR or END.\n"</span>
04101    <span class="stringliteral">"        &lt;offset&gt; is a signed integer.\n"</span>
04102    <span class="stringliteral">"  &lt;total_bytes&gt;: indicates the total number of bytes to be read\n"</span>
04103    <span class="stringliteral">"      ('all' indicates that data are read until the end of the file).\n"</span>
04104    <span class="stringliteral">"Example:\n"</span>
04105    <span class="stringliteral">"  For reading the last 2kB of the opened file, using 1k block size:\n"</span>
04106    <span class="stringliteral">"        read -B 1024 -s END,-2048 all   \n"</span>;
04107    
04108    
04109   fsal_status_t st;
04110   
04111   <span class="keywordtype">int</span> rc,option;
04112   
04113   <span class="keywordtype">int</span> flag_v=0;
04114   <span class="keywordtype">int</span> flag_h=0;
04115   <span class="keywordtype">int</span> flag_A=0;
04116   <span class="keywordtype">int</span> flag_X=0;
04117   <span class="keywordtype">int</span> flag_B=0;
04118   <span class="keywordtype">int</span> flag_s=0;
04119   
04120   <span class="keywordtype">int</span> err_flag=0;
04121 
04122   <span class="keywordtype">char</span> * str_block_size = NULL;
04123   
04124   <span class="keywordtype">char</span> str_seek_buff[256];
04125       
04126   <span class="keywordtype">char</span> * str_seek_type = NULL;
04127   <span class="keywordtype">char</span> * str_seek_offset = NULL;
04128   <span class="keywordtype">char</span> * str_total_bytes = NULL;
04129   
04130   fsal_size_t block_size = 1024;  <span class="comment">/* default: 1ko */</span>  
04131   fsal_size_t total_bytes = 0; <span class="comment">/* 0 == read all */</span>
04132   fsal_seek_t seek_desc =
04133       { FSAL_SEEK_CUR, 0 }; <span class="comment">/* default: read current position */</span>
04134   
04135   fsal_seek_t * p_seek_desc = NULL;
04136   
04137   <span class="comment">/* fsal arguments */</span>
04138   
04139   fsal_boolean_t  is_eof = 0;
04140   fsal_size_t     total_nb_read = 0;
04141   fsal_size_t     once_nb_read = 0;
04142   fsal_size_t     nb_block_read = 0;
04143   
04144   <span class="keywordtype">char</span> * p_read_buff;
04145   
04146   
04147   <span class="keyword">struct </span>timeval timer_start;
04148   <span class="keyword">struct </span>timeval timer_stop;
04149   <span class="keyword">struct </span>timeval timer_diff;
04150   
04151     
04152   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
04153 
04154   <span class="comment">/* is the fs initialized ? */</span>
04155   <span class="keywordflow">if</span> (!is_loaded){
04156     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
04157     <span class="keywordflow">return</span> -1;
04158   }  
04159   
04160   <span class="comment">/* initialize current thread */</span>
04161     
04162   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
04163   
04164   <span class="keywordflow">if</span> ( context-&gt;is_thread_ok != TRUE )
04165   { 
04166     <span class="keywordtype">int</span> rc;
04167     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
04168     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
04169   }
04170   
04171   <span class="comment">/* is a file opened ? */</span>
04172   <span class="keywordflow">if</span> ( !context-&gt;opened )
04173   {
04174     fprintf(output,<span class="stringliteral">"Error: no opened file. Use 'open' command first.\n"</span>);
04175     <span class="keywordflow">return</span> -1;
04176   }
04177     
04178   <span class="comment">/* option analysis. */</span>
04179   
04180   getopt_init();
04181   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
04182     <span class="keywordflow">switch</span>(option){
04183       
04184       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
04185         <span class="keywordflow">if</span> (flag_v)
04186           fprintf(output,
04187               <span class="stringliteral">"read: warning: option 'v' has been specified more than once.\n"</span>);
04188         <span class="keywordflow">else</span> flag_v++;
04189         <span class="keywordflow">break</span>;
04190         
04191       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
04192         <span class="keywordflow">if</span> ( flag_h )
04193           fprintf(output,
04194               <span class="stringliteral">"read: warning: option 'h' has been specified more than once.\n"</span>);
04195         <span class="keywordflow">else</span> flag_h++;
04196         <span class="keywordflow">break</span>;
04197         
04198       <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
04199         <span class="keywordflow">if</span> ( flag_A )
04200           fprintf(output,
04201               <span class="stringliteral">"read: warning: option 'A' has been specified more than once.\n"</span>);
04202         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( flag_X )
04203         {
04204           fprintf(output,
04205               <span class="stringliteral">"read: option 'A' conflicts with option 'X'.\n"</span>);
04206           err_flag ++;
04207         }
04208         <span class="keywordflow">else</span> flag_A++;
04209         <span class="keywordflow">break</span>;
04210         
04211       <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
04212         <span class="keywordflow">if</span> ( flag_X )
04213           fprintf(output,
04214               <span class="stringliteral">"read: warning: option 'X' has been specified more than once.\n"</span>);
04215         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( flag_A )
04216         {
04217           fprintf(output,
04218               <span class="stringliteral">"read: option 'X' conflicts with option 'A'.\n"</span>);
04219           err_flag ++;
04220         }
04221         <span class="keywordflow">else</span> flag_X++;
04222         <span class="keywordflow">break</span>;
04223         
04224       <span class="keywordflow">case</span> <span class="charliteral">'B'</span>:
04225         <span class="keywordflow">if</span> ( flag_B )
04226           fprintf(output,
04227               <span class="stringliteral">"read: warning: option 'B' has been specified more than once.\n"</span>);
04228         <span class="keywordflow">else</span>
04229         {
04230           flag_B++;
04231           str_block_size = Optarg;
04232         }
04233         <span class="keywordflow">break</span>;
04234         
04235       <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
04236         <span class="keywordflow">if</span> ( flag_s )
04237           fprintf(output,
04238               <span class="stringliteral">"read: warning: option 's' has been specified more than once.\n"</span>);
04239         <span class="keywordflow">else</span>
04240         {
04241           flag_s++;
04242           strncpy(str_seek_buff,<a class="code" href="Getopt_8c.html#a6">Optarg</a>,256);
04243           str_seek_type = str_seek_buff;
04244         }
04245         <span class="keywordflow">break</span>;
04246         
04247       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
04248         fprintf(output,<span class="stringliteral">"read: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
04249         err_flag ++;
04250         <span class="keywordflow">break</span>;
04251     }    
04252   }
04253   
04254   <span class="keywordflow">if</span> (flag_h)
04255   {
04256     fprintf(output,help_read);
04257     <span class="keywordflow">return</span> 0;
04258   }
04259   
04260   <span class="comment">/* Exactly one arg expected */</span>
04261   
04262   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-1))
04263     err_flag ++;
04264   <span class="keywordflow">else</span>
04265     str_total_bytes = argv[Optind];
04266   
04267   <span class="keywordflow">if</span> (err_flag)
04268   {
04269     fprintf(output,help_read);
04270     <span class="keywordflow">return</span> -1;
04271   }
04272   
04273   <span class="comment">/* check argument types */</span>
04274     
04275   <span class="keywordflow">if</span> ( flag_B )
04276   {
04277     <span class="comment">/* Try to convert the str_block_size to fsal_size_t */</span>
04278     
04279     rc = <a class="code" href="cmd__tools_8h.html#a12">ato64</a>( str_block_size, &amp;block_size );
04280     
04281     <span class="keywordflow">if</span> ( rc == -1 )
04282     {
04283       fprintf(output,<span class="stringliteral">"read: error: invalid block size \"%s\"\n"</span>,
04284           str_block_size);
04285       err_flag++;
04286     }
04287     
04288   }
04289   
04290   <span class="keywordflow">if</span> ( flag_s )
04291   {
04292     <span class="comment">/* Try to parse the argument */</span>
04293     
04294     str_seek_offset = strchr( str_seek_type, <span class="charliteral">','</span> );
04295     
04296     <span class="keywordflow">if</span> ( str_seek_offset == NULL )
04297     {
04298       fprintf(output,<span class="stringliteral">"read: error: invalid seek specifier \"%s\". &lt;seek_type&gt;,&lt;offset&gt; expected.\n"</span>,
04299           str_seek_type);
04300       err_flag++;      
04301     }
04302     
04303     <span class="keywordflow">if</span> ( !err_flag )
04304     {
04305       <span class="keywordtype">int</span> sign = 1;
04306       
04307       *str_seek_offset=<span class="charliteral">'\0'</span>;
04308       str_seek_offset++; <span class="comment">/* the first char after the "," */</span>
04309 
04310       <span class="comment">/* Check seek type */</span>
04311 
04312       <span class="keywordflow">if</span> ( !strncmp( str_seek_type, <span class="stringliteral">"CUR"</span>, 256 ) )
04313         seek_desc.whence = FSAL_SEEK_CUR;
04314       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !strncmp( str_seek_type, <span class="stringliteral">"SET"</span>, 256 ) )
04315         seek_desc.whence = FSAL_SEEK_SET;
04316       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !strncmp( str_seek_type, <span class="stringliteral">"END"</span>, 256 ) )
04317         seek_desc.whence = FSAL_SEEK_END;
04318       <span class="keywordflow">else</span>
04319       {
04320         fprintf(output,<span class="stringliteral">"read: error: invalid seek type \"%s\". CUR, SET or END expected.\n"</span>,
04321             str_seek_type);
04322         err_flag ++;
04323       }
04324       
04325       <span class="comment">/* Try to convert str_seek_offset to fsal_off_t */</span>
04326       
04327       <span class="keywordflow">switch</span> (str_seek_offset[0])
04328       {
04329         <span class="keywordflow">case</span> <span class="charliteral">'+'</span>:
04330           sign = 1;
04331           str_seek_offset ++;
04332           <span class="keywordflow">break</span>;
04333           
04334         <span class="keywordflow">case</span> <span class="charliteral">'-'</span>:
04335           sign = -1;
04336           str_seek_offset ++;
04337           <span class="keywordflow">break</span>;
04338       }
04339       
04340       rc = <a class="code" href="cmd__tools_8h.html#a12">ato64</a>( str_seek_offset, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> *) &amp;seek_desc.offset );
04341 
04342       <span class="keywordflow">if</span> ( rc == -1 )
04343       {
04344         fprintf(output,<span class="stringliteral">"read: error: invalid offset \"%s\".\n"</span>,
04345             str_seek_offset);
04346         err_flag++;
04347       }
04348       <span class="keywordflow">else</span>
04349          <span class="keywordflow">if</span> (sign &lt; 0) seek_desc.offset = -seek_desc.offset;
04350      
04351     }
04352     
04353     p_seek_desc = &amp;seek_desc;
04354     
04355   }
04356   <span class="keywordflow">else</span>  
04357   {
04358     p_seek_desc = NULL; <span class="comment">/* default seeking */</span>
04359   }
04360   
04361   <span class="keywordflow">if</span> (!strcasecmp( str_total_bytes , <span class="stringliteral">"all"</span> ))
04362   {
04363     total_bytes = 0;
04364   }
04365   <span class="keywordflow">else</span>
04366   {
04367     rc = <a class="code" href="cmd__tools_8h.html#a12">ato64</a>( str_total_bytes, &amp;total_bytes );
04368     
04369     <span class="keywordflow">if</span> ( rc == -1 )
04370     {
04371       fprintf(output,<span class="stringliteral">"read: error: invalid read size \"%s\". \"all\" or &lt;nb_bytes&gt; expected.\n"</span>,
04372           str_total_bytes);
04373       err_flag++;
04374     }
04375   }
04376 
04377   <span class="keywordflow">if</span> (err_flag)
04378   {
04379     fprintf(output,help_read);
04380     <span class="keywordflow">return</span> -1;
04381   }
04382     
04383   <span class="keywordflow">if</span> (flag_v)
04384   {
04385         
04386     <span class="comment">/* print a sum-up of read parameters */</span>
04387     fprintf(output, <span class="stringliteral">"Read options: Block size: %llu Bytes, Seek: %s%+lld, Read limit: %llu Bytes\n"</span>,
04388         block_size,
04389         ( p_seek_desc ? ( seek_desc.whence==FSAL_SEEK_SET ? <span class="stringliteral">"SET"</span>:
04390           seek_desc.whence==FSAL_SEEK_CUR ? <span class="stringliteral">"CUR"</span>:
04391           <span class="stringliteral">"END"</span> ) : <span class="stringliteral">"DEFAULT"</span> ),
04392         ( p_seek_desc ? seek_desc.offset : 0LL ),
04393         total_bytes );
04394   }
04395   
04396   
04397   <span class="comment">/* Now all arguments have been parsed, let's act ! */</span>
04398   
04399   <span class="comment">/* alloc a buffer */</span>
04400   p_read_buff = Mem_Alloc( block_size );
04401   
04402   <span class="keywordflow">if</span> ( p_read_buff == NULL )
04403   {
04404     fprintf(output,<span class="stringliteral">"read: error: Not enough memory to allocate read buffer (%llu Bytes).\n"</span>,block_size);
04405     <span class="keywordflow">return</span> ENOMEM;    
04406   }
04407   
04408   
04409   gettimeofday( &amp;timer_start,<a class="code" href="Getopt_8c.html#a0">NULL</a> );  
04410   
04411   <span class="comment">/* while EOF is not reached, and read&lt;asked (when total_bytes!=0) */</span>
04412   <span class="keywordflow">while</span> ( !is_eof &amp;&amp; !(( total_bytes!= 0) &amp;&amp; (total_nb_read &gt;= total_bytes)) )
04413   {
04414     
04415     st = FSAL_read( &amp;context-&gt;current_fd, p_seek_desc,
04416                     block_size, (caddr_t)p_read_buff, &amp;once_nb_read, &amp;is_eof );
04417      
04418     <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) )
04419     {
04420       fprintf(output,<span class="stringliteral">"Error executing FSAL_read:"</span>);
04421       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
04422       fprintf(output,<span class="stringliteral">"\n"</span>);
04423       
04424       <span class="comment">/* exit only if it is not retryable */</span>
04425       <span class="keywordflow">if</span> ( fsal_is_retryable(st) )
04426       {
04427         sleep(1);
04428         <span class="keywordflow">continue</span>;
04429       }
04430       <span class="keywordflow">else</span>
04431       {
04432         Mem_Free(p_read_buff);
04433         <span class="keywordflow">return</span> st.major;
04434       }
04435     }
04436     
04437     <span class="comment">/* print what was read. */</span>
04438     <span class="keywordflow">if</span> ( flag_A )
04439     {
04440       fsal_size_t index;
04441       <span class="keywordflow">for</span> (index=0; index&lt;once_nb_read; index ++)
04442         fprintf( output, <span class="stringliteral">"%c."</span>, p_read_buff[index] );
04443     }
04444     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( flag_X )
04445     {
04446       fsal_size_t index;
04447       <span class="keywordflow">for</span> (index=0; index&lt;once_nb_read; index ++)
04448         fprintf( output, <span class="stringliteral">"%.2X "</span>, p_read_buff[index] );      
04449     }
04450     <span class="keywordflow">else</span>
04451         fprintf( output,<span class="stringliteral">"."</span> );
04452 
04453     <span class="comment">/* update stats */</span>    
04454     
04455     <span class="keywordflow">if</span> (once_nb_read&gt;0) nb_block_read ++;
04456     
04457     total_nb_read += once_nb_read;
04458     
04459     <span class="comment">/* flush */</span>
04460     <span class="keywordflow">if</span> ( nb_block_read % 10 ) fflush( output );
04461     
04462     <span class="comment">/* what ever seek type was, we continue reading from current position */</span>
04463     p_seek_desc = NULL;
04464     
04465   }
04466   
04467   gettimeofday( &amp;timer_stop,<a class="code" href="Getopt_8c.html#a0">NULL</a> );
04468   
04469   <span class="comment">/* newline after read blocks */</span>
04470   fprintf( output,<span class="stringliteral">"\n"</span> );  
04471   
04472   <span class="keywordflow">if</span> (flag_v)
04473   {
04474     <span class="keywordtype">double</span> bandwidth ;
04475     
04476     <span class="comment">/* print stats */</span>
04477     fprintf(output, <span class="stringliteral">"Nb blocks read: %llu\n"</span>, nb_block_read);
04478     fprintf(output, <span class="stringliteral">"Total: %llu Bytes\n"</span>, total_nb_read );
04479     
04480     fprintf(output, <span class="stringliteral">"Time enlapsed: "</span>);
04481     timer_diff = <a class="code" href="cmd__tools_8h.html#a24">time_diff</a>( timer_start, timer_stop );
04482     <a class="code" href="cmd__tools_8h.html#a0">print_timeval</a>( output, timer_diff );
04483     
04484     bandwidth = total_nb_read/(1024*1024*( timer_diff.tv_sec + 0.000001 * timer_diff.tv_usec ));
04485         
04486     fprintf(output, <span class="stringliteral">"Bandwidth: %f MB/s\n"</span>, bandwidth );
04487     
04488   }
04489   Mem_Free(p_read_buff);
04490   
04491   <span class="keywordflow">return</span> 0;
04492 }
04493 
04494 
04495 
<a name="l04525"></a><a class="code" href="commands__FSAL_8c.html#a40">04525</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a40">fn_fsal_write</a>(
04526         <span class="keywordtype">int</span> argc ,                <span class="comment">/* IN : number of args in argv */</span>
04527         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
04528         FILE * output             <span class="comment">/* IN : output stream          */</span>
04529       )
04530 {
04531   
04532   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hvs:N:A:X:"</span>;
04533    
04534   <span class="keyword">static</span> <span class="keywordtype">char</span> help_write[]=
04535           <span class="stringliteral">"Usage:\n"</span>
04536           <span class="stringliteral">"  write [-h][-v] [ -s &lt;seek_type&gt;,&lt;offset&gt; ]  [-N &lt;nb_times&gt;] -A &lt;ascii_string&gt;\n"</span>
04537           <span class="stringliteral">"  write [-h][-v] [ -s &lt;seek_type&gt;,&lt;offset&gt; ]  [-N &lt;nb_times&gt;] -X &lt;hexa_data&gt;\n"</span>
04538           <span class="stringliteral">"Where:\n"</span>
04539           <span class="stringliteral">"  &lt;seek_type&gt; can be: SET, CUR, END\n"</span>
04540           <span class="stringliteral">"  &lt;offset&gt; is a signed number of bytes.\n"</span>
04541           <span class="stringliteral">"  &lt;nb_times&gt; is the number of times we write the expression into the file.\n"</span>
04542           <span class="stringliteral">"\n"</span>
04543           <span class="stringliteral">"  &lt;ascii_string&gt; is a string to be written to file.\n"</span>
04544           <span class="stringliteral">"      Note that the null terminating character of is also written\n"</span>
04545           <span class="stringliteral">"      to file.\n"</span>
04546           <span class="stringliteral">"or\n"</span>
04547           <span class="stringliteral">"  &lt;hexa_data&gt; is a data represented in hexadecimal format,\n"</span>
04548           <span class="stringliteral">"      that is to be written to file.\n"</span>
04549           <span class="stringliteral">"\n"</span>
04550           <span class="stringliteral">"Examples:\n"</span>
04551           <span class="stringliteral">"\n"</span>
04552           <span class="stringliteral">"  For writting 10 times the null terminated string \"hello world\"\n"</span>
04553           <span class="stringliteral">"  at the end of the file:\n"</span>
04554           <span class="stringliteral">"        write -s END,0 -N 10 -A \"hello world\"\n"</span>
04555           <span class="stringliteral">"\n"</span>
04556           <span class="stringliteral">"  For overwritting the beginning of the file with\n"</span>
04557           <span class="stringliteral">"  the pattern 0xA1267AEF31254ADE repeated twice:\n"</span>
04558           <span class="stringliteral">"        write -s SET,0 -N 2 -X \"A1267AEF31254ADE\"\n"</span>;
04559       
04560   fsal_status_t st;
04561   
04562   <span class="keywordtype">int</span> rc,option;
04563   
04564   <span class="keywordtype">int</span> flag_v=0;
04565   <span class="keywordtype">int</span> flag_h=0;
04566   <span class="keywordtype">int</span> flag_N=0;
04567   <span class="keywordtype">int</span> flag_s=0;
04568   <span class="keywordtype">int</span> flag_A=0;
04569   <span class="keywordtype">int</span> flag_X=0;
04570   
04571   <span class="keywordtype">int</span> err_flag = 0;
04572 
04573   <span class="keywordtype">char</span> * str_times = NULL;
04574   <span class="keywordtype">char</span> str_seek_buff[256];      
04575   <span class="keywordtype">char</span> * str_seek_type = NULL;
04576   <span class="keywordtype">char</span> * str_seek_offset = NULL;  
04577   
04578   <span class="keywordtype">char</span> * str_hexa = NULL;  
04579   <span class="keywordtype">char</span> * str_ascii = NULL;
04580   
04581   size_t datasize = 0;
04582   <span class="keywordtype">char</span> * databuff = NULL;
04583   
04584   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> nb_times=1; <span class="comment">/* default = 1 */</span>  
04585   
04586   fsal_size_t block_size;  <span class="comment">/* the length of the data block to be written */</span>
04587   
04588   fsal_u64_t  nb_block_written=0;
04589   fsal_size_t size_written=0;
04590   fsal_size_t size_written_once=0;
04591   
04592   fsal_seek_t seek_desc =
04593       { FSAL_SEEK_CUR, 0 }; <span class="comment">/* default: write to current position */</span>
04594   
04595   fsal_seek_t * p_seek_desc = NULL;
04596 
04597   <span class="keyword">struct </span>timeval timer_start;
04598   <span class="keyword">struct </span>timeval timer_stop;
04599   <span class="keyword">struct </span>timeval timer_diff;
04600   
04601     
04602   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
04603 
04604   <span class="comment">/* is the fs initialized ? */</span>
04605   <span class="keywordflow">if</span> (!is_loaded){
04606     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
04607     <span class="keywordflow">return</span> -1;
04608   }  
04609   
04610   <span class="comment">/* initialize current thread */</span>
04611     
04612   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
04613   
04614   <span class="keywordflow">if</span> ( context-&gt;is_thread_ok != TRUE )
04615   { 
04616     <span class="keywordtype">int</span> rc;
04617     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
04618     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
04619   }
04620   
04621   <span class="comment">/* is a file opened ? */</span>
04622   <span class="keywordflow">if</span> ( !context-&gt;opened )
04623   {
04624     fprintf(output,<span class="stringliteral">"Error: no opened file. Use 'open' command first.\n"</span>);
04625     <span class="keywordflow">return</span> -1;
04626   }
04627     
04628   <span class="comment">/* option analysis. */</span>
04629   
04630   getopt_init();
04631   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
04632     <span class="keywordflow">switch</span>(option){
04633       
04634       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
04635         <span class="keywordflow">if</span> (flag_v)
04636           fprintf(output,
04637               <span class="stringliteral">"write: warning: option 'v' has been specified more than once.\n"</span>);
04638         <span class="keywordflow">else</span> flag_v++;
04639         <span class="keywordflow">break</span>;
04640         
04641       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
04642         <span class="keywordflow">if</span> ( flag_h )
04643           fprintf(output,
04644               <span class="stringliteral">"write: warning: option 'h' has been specified more than once.\n"</span>);
04645         <span class="keywordflow">else</span> flag_h++;
04646         <span class="keywordflow">break</span>;
04647         
04648       <span class="keywordflow">case</span> <span class="charliteral">'N'</span>:
04649         <span class="keywordflow">if</span> ( flag_N )
04650           fprintf(output,
04651               <span class="stringliteral">"write: warning: option 'N' has been specified more than once.\n"</span>);
04652         <span class="keywordflow">else</span>
04653         {
04654           flag_N++;
04655           str_times = Optarg;
04656         }
04657         <span class="keywordflow">break</span>;
04658         
04659       <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
04660         <span class="keywordflow">if</span> ( flag_s )
04661           fprintf(output,
04662               <span class="stringliteral">"write: warning: option 's' has been specified more than once.\n"</span>);
04663         <span class="keywordflow">else</span>
04664         {
04665           flag_s++;
04666           strncpy(str_seek_buff,<a class="code" href="Getopt_8c.html#a6">Optarg</a>,256);
04667           str_seek_type = str_seek_buff;
04668         }
04669         <span class="keywordflow">break</span>;
04670         
04671       <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
04672         <span class="keywordflow">if</span> ( flag_A )
04673           fprintf(output,
04674               <span class="stringliteral">"write: warning: option 'A' has been specified more than once.\n"</span>);
04675         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( flag_X )
04676         {
04677           fprintf(output,
04678               <span class="stringliteral">"write: option 'A' conflicts with option 'X'.\n"</span>);
04679           err_flag ++;
04680         }
04681         <span class="keywordflow">else</span>
04682         {
04683           flag_A++;
04684           str_ascii = Optarg;
04685         }
04686         <span class="keywordflow">break</span>;
04687         
04688       <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
04689         <span class="keywordflow">if</span> ( flag_X )
04690           fprintf(output,
04691               <span class="stringliteral">"write: warning: option 'X' has been specified more than once.\n"</span>);
04692         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( flag_A )
04693         {
04694           fprintf(output,
04695               <span class="stringliteral">"write: option 'X' conflicts with option 'A'.\n"</span>);
04696           err_flag ++;
04697         }
04698         <span class="keywordflow">else</span>
04699         {
04700           flag_X++;
04701           str_hexa = Optarg;
04702         }
04703         <span class="keywordflow">break</span>;
04704         
04705       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
04706         fprintf(output,<span class="stringliteral">"write: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
04707         err_flag ++;
04708         <span class="keywordflow">break</span>;
04709     }    
04710   }
04711   
04712   <span class="keywordflow">if</span> (flag_h)
04713   {
04714     fprintf(output,help_write);
04715     <span class="keywordflow">return</span> 0;
04716   }
04717   
04718   <span class="comment">/* No extra arg expected */</span>
04719   
04720   <span class="keywordflow">if</span> (<a class="code" href="Getopt_8c.html#a4">Optind</a> != argc) err_flag ++;
04721 
04722   <span class="keywordflow">if</span> (!flag_A &amp;&amp; !flag_X)
04723   {
04724     fprintf(output, <span class="stringliteral">"write: error: -A or -X option is mandatory.\n"</span>);
04725     err_flag ++;
04726   }
04727 
04728     
04729   <span class="keywordflow">if</span> (err_flag)
04730   {
04731     fprintf(output,help_write);
04732     <span class="keywordflow">return</span> -1;
04733   }
04734   
04735   <span class="comment">/* check argument types */</span>
04736     
04737   <span class="keywordflow">if</span> ( flag_N )
04738   {
04739     <span class="comment">/* Try to convert the str_times to nb_times */</span>
04740     
04741     rc = <a class="code" href="cmd__tools_8h.html#a12">ato64</a>( str_times, &amp;nb_times );
04742     
04743     <span class="keywordflow">if</span> ( rc == -1 )
04744     {
04745       fprintf(output,<span class="stringliteral">"write: error: invalid number \"%s\"\n"</span>,
04746           str_times);
04747       <span class="keywordflow">return</span> EINVAL;
04748     }
04749     
04750   }
04751   
04752   <span class="keywordflow">if</span> ( flag_s )
04753   {
04754     <span class="keywordtype">int</span> sign = 1;
04755 
04756     <span class="comment">/* Try to parse the argument */</span>
04757     
04758     str_seek_offset = strchr( str_seek_type, <span class="charliteral">','</span> );
04759     
04760     <span class="keywordflow">if</span> ( str_seek_offset == NULL )
04761     {
04762       fprintf(output,<span class="stringliteral">"write: error: invalid seek specifier \"%s\". &lt;seek_type&gt;,&lt;offset&gt; expected.\n"</span>,
04763           str_seek_type);
04764       <span class="keywordflow">return</span> EINVAL;
04765     }
04766     
04767     *str_seek_offset=<span class="charliteral">'\0'</span>;
04768     str_seek_offset++; <span class="comment">/* the first char after the "," */</span>
04769 
04770     <span class="comment">/* Check seek type */</span>
04771 
04772     <span class="keywordflow">if</span> ( !strncmp( str_seek_type, <span class="stringliteral">"CUR"</span>, 256 ) )
04773       seek_desc.whence = FSAL_SEEK_CUR;
04774     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !strncmp( str_seek_type, <span class="stringliteral">"SET"</span>, 256 ) )
04775       seek_desc.whence = FSAL_SEEK_SET;
04776     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !strncmp( str_seek_type, <span class="stringliteral">"END"</span>, 256 ) )
04777       seek_desc.whence = FSAL_SEEK_END;
04778     <span class="keywordflow">else</span>
04779     {
04780       fprintf(output,<span class="stringliteral">"write: error: invalid seek type \"%s\". CUR, SET or END expected.\n"</span>,
04781           str_seek_type);
04782       <span class="keywordflow">return</span> EINVAL;
04783     }
04784 
04785     <span class="comment">/* Try to convert str_seek_offset to fsal_off_t */</span>
04786 
04787     <span class="keywordflow">switch</span> (str_seek_offset[0])
04788     {
04789       <span class="keywordflow">case</span> <span class="charliteral">'+'</span>:
04790         sign = 1;
04791         str_seek_offset ++;
04792         <span class="keywordflow">break</span>;
04793 
04794       <span class="keywordflow">case</span> <span class="charliteral">'-'</span>:
04795         sign = -1;
04796         str_seek_offset ++;
04797         <span class="keywordflow">break</span>;
04798     }
04799 
04800     rc = <a class="code" href="cmd__tools_8h.html#a12">ato64</a>( str_seek_offset,  (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> *) &amp;seek_desc.offset );
04801 
04802     <span class="keywordflow">if</span> ( rc == -1 )
04803     {
04804       fprintf(output,<span class="stringliteral">"write: error: invalid offset \"%s\".\n"</span>,
04805           str_seek_offset);
04806       <span class="keywordflow">return</span> EINVAL;
04807     }
04808     <span class="keywordflow">else</span>
04809        <span class="keywordflow">if</span> (sign &lt; 0) seek_desc.offset = -seek_desc.offset;
04810 
04811     
04812     p_seek_desc = &amp;seek_desc;
04813     
04814   }
04815   <span class="keywordflow">else</span>  
04816   {
04817     p_seek_desc = NULL; <span class="comment">/* default seeking */</span>
04818   }
04819   
04820   <span class="keywordflow">if</span> (flag_A)
04821   {
04822     datasize = strlen(str_ascii)+1; <span class="comment">/* Include null termination char. */</span>
04823     databuff = str_ascii;    
04824   }
04825   
04826   
04827   <span class="keywordflow">if</span> (flag_X)
04828   {
04829     size_t length = strlen( str_hexa );
04830     
04831     datasize = (length &gt;&gt; 1);
04832     
04833     <span class="keywordflow">if</span> ( length % 2 )
04834     {
04835     
04836       <span class="comment">/* if it is not odd: error */</span>
04837       fprintf(output,<span class="stringliteral">"write: error: in \"%s\", data length is not a multiple of 8 bits.\n"</span>,
04838             str_hexa);
04839     
04840       <span class="keywordflow">return</span> EINVAL;
04841     }
04842     
04843     databuff = Mem_Alloc( datasize + 1 );
04844     
04845     <span class="keywordflow">if</span> ( databuff == NULL )
04846     {
04847       fprintf(output,<span class="stringliteral">"write: error: Not enough memory to allocate %llu Bytes.\n"</span>,
04848             (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)datasize);
04849       <span class="keywordflow">return</span> ENOMEM;
04850     }
04851 
04852     
04853     memset( databuff, 0, datasize + 1 );
04854       
04855     <span class="comment">/* try to convert the string to hexa */</span>
04856     rc = sscanmem(databuff, datasize, str_hexa );
04857 
04858     <span class="keywordflow">if</span> (rc != (int)(2*datasize))
04859     {
04860       <span class="comment">/* if it is not odd: error */</span>
04861       fprintf(output,<span class="stringliteral">"write: error: \"%s\" in not a valid hexa format.\n"</span>,
04862             str_hexa);
04863 
04864       Mem_Free( str_hexa );
04865 
04866       <span class="keywordflow">return</span> EINVAL;        
04867     }
04868     
04869   }
04870     
04871   
04872   <span class="keywordflow">if</span> (flag_v)
04873   {    
04874     <span class="comment">/* print a sum-up of write parameters */</span>
04875     fprintf(output, <span class="stringliteral">"Write options: Data length: %llu x %llu Bytes, Seek: %s%+lld\n"</span>,
04876         (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)nb_times,
04877         (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)datasize,
04878         ( p_seek_desc ? ( seek_desc.whence==FSAL_SEEK_SET ? <span class="stringliteral">"SET"</span>:
04879           seek_desc.whence==FSAL_SEEK_CUR ? <span class="stringliteral">"CUR"</span>:
04880           <span class="stringliteral">"END"</span> ) : <span class="stringliteral">"DEFAULT"</span> ),
04881         ( p_seek_desc ? seek_desc.offset : 0LL )
04882         );
04883   }
04884   
04885   <span class="comment">/* variables initialisation */</span>
04886     
04887   block_size = (fsal_size_t) datasize;  
04888   nb_block_written=0;
04889   size_written=0;  
04890   size_written_once=0;
04891   
04892   gettimeofday( &amp;timer_start,<a class="code" href="Getopt_8c.html#a0">NULL</a> );  
04893   
04894   <span class="comment">/* write loop */</span>
04895     
04896   <span class="keywordflow">while</span> ( nb_block_written &lt; nb_times )
04897   {
04898     
04899     st = FSAL_write( &amp;context-&gt;current_fd, p_seek_desc,
04900                      block_size, (caddr_t)databuff, &amp;size_written_once );
04901      
04902     <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) )
04903     {
04904       fprintf(output,<span class="stringliteral">"Error executing FSAL_write:"</span>);
04905       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
04906       fprintf(output,<span class="stringliteral">"\n"</span>);
04907       
04908       <span class="comment">/* exit only if it is not retryable */</span>      
04909       <span class="keywordflow">if</span> ( fsal_is_retryable(st) )
04910       {
04911         sleep(1);
04912         <span class="keywordflow">continue</span>;
04913       }
04914       <span class="keywordflow">else</span>
04915       {
04916         <span class="keywordflow">if</span> (flag_X) Mem_Free( databuff );
04917         <span class="keywordflow">return</span> st.major;
04918       }
04919     }
04920     
04921     fprintf( output,<span class="stringliteral">"."</span> );
04922 
04923     <span class="comment">/* update stats */</span>
04924     
04925     <span class="keywordflow">if</span> (size_written_once&gt;0) nb_block_written ++;
04926     
04927     size_written += size_written_once;
04928     
04929     <span class="comment">/* flush */</span>
04930     <span class="keywordflow">if</span> ( nb_block_written % 10 ) fflush( output );
04931 
04932     
04933     <span class="comment">/* what ever seek type was, we continue writting to the current position */</span>
04934     p_seek_desc = NULL;
04935     
04936   }
04937   
04938   gettimeofday( &amp;timer_stop,<a class="code" href="Getopt_8c.html#a0">NULL</a> );
04939   
04940   <span class="comment">/* newline after written blocks */</span>
04941   fprintf( output,<span class="stringliteral">"\n"</span> );  
04942   
04943   <span class="keywordflow">if</span> (flag_v)
04944   {
04945     <span class="keywordtype">double</span> bandwidth ;
04946     
04947     <span class="comment">/* print stats */</span>
04948     fprintf(output, <span class="stringliteral">"Nb blocks written: %llu\n"</span>, nb_block_written);
04949     fprintf(output, <span class="stringliteral">"Total volume: %llu Bytes\n"</span>, size_written );
04950     
04951     fprintf(output, <span class="stringliteral">"Time enlapsed: "</span>);
04952     timer_diff = <a class="code" href="cmd__tools_8h.html#a24">time_diff</a>( timer_start, timer_stop );
04953     <a class="code" href="cmd__tools_8h.html#a0">print_timeval</a>( output, timer_diff );
04954     
04955     bandwidth = size_written/(1024*1024*( timer_diff.tv_sec + 0.000001 * timer_diff.tv_usec ));
04956     
04957     fprintf(output, <span class="stringliteral">"Bandwidth: %f MB/s\n"</span>, bandwidth );
04958     
04959   }
04960   
04961   <span class="keywordflow">if</span> (flag_X) Mem_Free( databuff );
04962   
04963   <span class="keywordflow">return</span> 0;
04964   
04965 }
04966 
04967 
04968 
04969 
<a name="l04974"></a><a class="code" href="commands__FSAL_8c.html#a41">04974</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a41">fn_fsal_close</a>(
04975         <span class="keywordtype">int</span> argc ,                <span class="comment">/* IN : number of args in argv */</span>
04976         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
04977         FILE * output             <span class="comment">/* IN : output stream          */</span>
04978       )
04979   {
04980   
04981   <span class="keyword">static</span> <span class="keywordtype">char</span> help_close[]= <span class="stringliteral">"usage: close\n"</span>;
04982 
04983   fsal_status_t st;
04984   
04985   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
04986 
04987   <span class="comment">/* is the fs initialized ? */</span>
04988   <span class="keywordflow">if</span> (!is_loaded){
04989     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
04990     <span class="keywordflow">return</span> -1;
04991   }  
04992   
04993   <span class="comment">/* initialize current thread */</span>
04994     
04995   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
04996   
04997   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
04998   { 
04999     <span class="keywordtype">int</span> rc;
05000     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
05001     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
05002   }
05003   
05004   <span class="comment">/* is a file already opened ? */</span>
05005   <span class="keywordflow">if</span> ( !context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> )
05006   {
05007     fprintf(output,<span class="stringliteral">"Error: this is no file currently opened.\n"</span>);
05008     <span class="keywordflow">return</span> -1;
05009   }
05010   
05011   <span class="keywordflow">if</span> ( argc != 1 )
05012   {
05013     fprintf(output,help_close);
05014     <span class="keywordflow">return</span> -1;    
05015   }  
05016   
05017   
05018   st = FSAL_close( &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o6">current_fd</a> );
05019   
05020   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
05021     fprintf(output,<span class="stringliteral">"Error executing FSAL_close:"</span>);
05022     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
05023     fprintf(output,<span class="stringliteral">"\n"</span>);
05024     <span class="keywordflow">return</span> st.major;
05025   }
05026   
05027   <span class="comment">/* note that a file is closed. */</span>
05028   context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> = FALSE;
05029   
05030   <span class="keywordflow">return</span> 0;
05031   
05032 }
05033 
<a name="l05038"></a><a class="code" href="commands__FSAL_8c.html#a42">05038</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a42">fn_fsal_close_byfileid</a>(
05039         <span class="keywordtype">int</span> argc ,                <span class="comment">/* IN : number of args in argv */</span>
05040         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
05041         FILE * output             <span class="comment">/* IN : output stream          */</span>
05042       )
05043   {
05044   
05045   <span class="keyword">static</span> <span class="keywordtype">char</span> help_close[]= <span class="stringliteral">"usage: close_byfileid &lt;fileid&gt;\n"</span>;
05046 
05047   fsal_status_t st;
05048   
05049   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
05050 
05051   <span class="comment">/* is the fs initialized ? */</span>
05052   <span class="keywordflow">if</span> (!is_loaded){
05053     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
05054     <span class="keywordflow">return</span> -1;
05055   }  
05056   
05057   <span class="comment">/* initialize current thread */</span>
05058     
05059   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
05060   
05061   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
05062   { 
05063     <span class="keywordtype">int</span> rc;
05064     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
05065     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
05066   }
05067   
05068   <span class="comment">/* is a file already opened ? */</span>
05069   <span class="keywordflow">if</span> ( !context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> )
05070   {
05071     fprintf(output,<span class="stringliteral">"Error: this is no file currently opened.\n"</span>);
05072     <span class="keywordflow">return</span> -1;
05073   }
05074   
05075   <span class="keywordflow">if</span> ( argc != 1 )
05076   {
05077     fprintf(output,help_close);
05078     <span class="keywordflow">return</span> -1;    
05079   }  
05080   
05081   
05082   st = FSAL_close( &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o6">current_fd</a> );
05083   
05084   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
05085     fprintf(output,<span class="stringliteral">"Error executing FSAL_close:"</span>);
05086     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
05087     fprintf(output,<span class="stringliteral">"\n"</span>);
05088     <span class="keywordflow">return</span> st.major;
05089   }
05090   
05091   <span class="comment">/* note that a file is closed. */</span>
05092   context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o5">opened</a> = FALSE;
05093   
05094   <span class="keywordflow">return</span> 0;
05095   
05096 }
05097 
05098 
<a name="l05103"></a><a class="code" href="commands__FSAL_8c.html#a43">05103</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a43">fn_fsal_cat</a>(
05104         <span class="keywordtype">int</span> argc ,                <span class="comment">/* IN : number of args in argv */</span>
05105         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
05106         FILE * output             <span class="comment">/* IN : output stream          */</span>
05107       )
05108   {
05109   
05110   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hf"</span>;
05111    
05112   <span class="keyword">static</span> <span class="keywordtype">char</span> help_cat[]=
05113     <span class="stringliteral">"usage: cat [-h][-f] &lt;path&gt;\n"</span>
05114     <span class="stringliteral">"   -h: print this help\n"</span>
05115     <span class="stringliteral">"   -f: by default, cat doesn't print more that 1MB.\n"</span>
05116     <span class="stringliteral">"       this option force it to print the whole file.\n"</span>;
05117 
05118   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
05119   fsal_handle_t filehdl;
05120   
05121   fsal_status_t st;
05122   
05123   <span class="keywordtype">int</span> rc,option;
05124   <span class="keywordtype">int</span> flag_h=0;
05125   <span class="keywordtype">int</span> flag_f=0;
05126   <span class="keywordtype">int</span> err_flag=0;
05127 
05128   fsal_openflags_t o_flags;
05129   fsal_file_t      cat_fd;
05130   
05131 <span class="preprocessor">#define MAX_CAT_SIZE  (1024*1024)</span>
05132 <span class="preprocessor"></span>  fsal_size_t nb_read = 0;
05133   fsal_size_t buffsize = 1024;
05134   <span class="keywordtype">char</span>        readbuff[1024];  
05135   <span class="keywordtype">int</span> is_eof = 0;
05136         
05137   <span class="keywordtype">char</span> * file = NULL;
05138     
05139   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
05140 
05141   <span class="comment">/* is the fs initialized ? */</span>
05142   <span class="keywordflow">if</span> (!is_loaded){
05143     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
05144     <span class="keywordflow">return</span> -1;
05145   }  
05146   
05147   <span class="comment">/* initialize current thread */</span>
05148     
05149   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
05150   
05151   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
05152   { 
05153     <span class="keywordtype">int</span> rc;
05154     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
05155     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
05156   }
05157   
05158   <span class="comment">/* analysing options */</span>
05159   
05160   getopt_init();
05161   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
05162     <span class="keywordflow">switch</span>(option){
05163       <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
05164         <span class="keywordflow">if</span> (flag_f)
05165           fprintf(output,
05166               <span class="stringliteral">"cat: warning: option 'f' has been specified more than once.\n"</span>);
05167         <span class="keywordflow">else</span> flag_f++;
05168         <span class="keywordflow">break</span>;
05169       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
05170         <span class="keywordflow">if</span> ( flag_h )
05171           fprintf(output,
05172               <span class="stringliteral">"cat: warning: option 'h' has been specified more than once.\n"</span>);
05173         <span class="keywordflow">else</span> flag_h++;
05174         <span class="keywordflow">break</span>;
05175       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
05176         fprintf(output,<span class="stringliteral">"cat: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
05177         err_flag ++;
05178         <span class="keywordflow">break</span>;
05179     }    
05180   }
05181   
05182   <span class="keywordflow">if</span> (flag_h){
05183     fprintf(output,help_cat);
05184     <span class="keywordflow">return</span> 0;
05185   }
05186   
05187   <span class="comment">/* one arg expected */</span>
05188   <span class="keywordflow">if</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-1) )
05189     err_flag ++;
05190   <span class="keywordflow">else</span>
05191     file = argv[Optind];        
05192 
05193   <span class="keywordflow">if</span> (err_flag){
05194     fprintf(output,help_cat);
05195     <span class="keywordflow">return</span> -1;
05196   }
05197     
05198   <span class="comment">/* copy current path. */</span>
05199   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
05200   
05201   <span class="comment">/* retrieves object handle*/</span>
05202   <span class="keywordflow">if</span> (rc = 
05203       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
05204                 file,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;filehdl,output))
05205     <span class="keywordflow">return</span> rc;
05206 
05207   <span class="comment">/* make open flags */</span>
05208   
05209   o_flags = FSAL_O_RDONLY;
05210   
05211   st = FSAL_open( &amp;filehdl, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, o_flags, &amp;cat_fd , <a class="code" href="Getopt_8c.html#a0">NULL</a> );
05212   
05213   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
05214     fprintf(output,<span class="stringliteral">"Error executing FSAL_open:"</span>);
05215     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
05216     fprintf(output,<span class="stringliteral">"\n"</span>);
05217     <span class="keywordflow">return</span> st.major;
05218   }
05219   
05220   <span class="comment">/* read operations */</span>
05221   
05222   <span class="keywordflow">while</span> (!is_eof &amp;&amp; ( flag_f || ( nb_read &lt; MAX_CAT_SIZE ) ) )
05223   {
05224     fsal_size_t nb_read_once;
05225     
05226     st = FSAL_read( &amp;cat_fd, <a class="code" href="Getopt_8c.html#a0">NULL</a>, buffsize, (caddr_t)readbuff,
05227                     &amp;nb_read_once, &amp;is_eof );
05228         
05229     <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) )
05230     {
05231       fprintf(output,<span class="stringliteral">"Error executing FSAL_read:"</span>);
05232       <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
05233       fprintf(output,<span class="stringliteral">"\n"</span>);
05234       
05235       <span class="comment">/* exit only if it is not retryable */</span>
05236       <span class="keywordflow">if</span> ( fsal_is_retryable(st) )
05237       {
05238         sleep(1);
05239         <span class="keywordflow">continue</span>;
05240       }
05241       <span class="keywordflow">else</span> <span class="keywordflow">return</span> st.major;
05242     }
05243     
05244     fwrite( (caddr_t)readbuff, (size_t)nb_read_once, 1, output );
05245 
05246     <span class="comment">/* update stats */</span>    
05247     nb_read += nb_read_once;    
05248       
05249   }
05250   
05251   FSAL_close( &amp;cat_fd );
05252   
05253   <span class="keywordflow">if</span> (!is_eof)
05254   {
05255     fprintf( output, <span class="stringliteral">"\n----------------- File is larger than 1MB (use -f option to display all) -----------------\n"</span>);
05256     <span class="keywordflow">return</span> EPERM;
05257   }    
05258     
05259   <span class="keywordflow">return</span> 0;
05260   
05261 }
05262 
05263 
05264 
<a name="l05269"></a><a class="code" href="commands__FSAL_8c.html#a44">05269</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a44">fn_fsal_rcp</a>(
05270         <span class="keywordtype">int</span> argc ,                <span class="comment">/* IN : number of args in argv */</span>
05271         <span class="keywordtype">char</span> ** argv ,            <span class="comment">/* IN : arg list               */</span>
05272         FILE * output             <span class="comment">/* IN : output stream          */</span>
05273       )
05274   {
05275   
05276   <span class="keyword">static</span> <span class="keywordtype">char</span> format[]=<span class="stringliteral">"hvrw"</span>;
05277    
05278   <span class="keyword">static</span> <span class="keywordtype">char</span> help_rcp[]=
05279     <span class="stringliteral">"usage: rcp [-h][-v] -r|-w &lt;fsal_path&gt; &lt;local_path&gt;\n"</span>
05280     <span class="stringliteral">"  -h : print this help\n"</span>
05281     <span class="stringliteral">"  -v : verbose mode\n"</span>
05282     <span class="stringliteral">"copy direction:\n"</span>
05283     <span class="stringliteral">"  -r : FSAL -&gt; local filesystem\n"</span>
05284     <span class="stringliteral">"  -w : local filesystem -&gt; FSAL\n"</span>;
05285 
05286   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
05287   fsal_handle_t filehdl;
05288   
05289   fsal_status_t st;
05290   
05291   <span class="keywordtype">int</span> rc,option;
05292   <span class="keywordtype">int</span> flag_h=0;
05293   <span class="keywordtype">int</span> flag_v=0;
05294   <span class="keywordtype">int</span> flag_r=0;
05295   <span class="keywordtype">int</span> flag_w=0;
05296   
05297   <span class="keywordtype">int</span> err_flag=0;
05298   
05299   <span class="keywordtype">char</span> * local_file = NULL;
05300   <span class="keywordtype">char</span> * fsal_file = NULL;
05301   
05302   fsal_path_t local_path_fsal;
05303   fsal_rcpflag_t  rcp_opt;
05304   
05305   
05306   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
05307 
05308   <span class="comment">/* is the fs initialized ? */</span>
05309   <span class="keywordflow">if</span> (!is_loaded){
05310     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
05311     <span class="keywordflow">return</span> -1;
05312   }  
05313   
05314   <span class="comment">/* initialize current thread */</span>
05315     
05316   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
05317   
05318   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
05319   { 
05320     <span class="keywordtype">int</span> rc;
05321     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
05322     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
05323   }
05324   
05325   <span class="comment">/* analysing options */</span>
05326   
05327   getopt_init();
05328   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1){   
05329     <span class="keywordflow">switch</span>(option){
05330       <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
05331         <span class="keywordflow">if</span> (flag_w)
05332         {
05333           fprintf(output,
05334               <span class="stringliteral">"rcp: error: option 'r' conflicts with option 'w'.\n"</span>);
05335           err_flag ++;
05336         }
05337         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_r)
05338           fprintf(output,
05339               <span class="stringliteral">"rcp: warning: option 'r' has been specified more than once.\n"</span>);
05340         <span class="keywordflow">else</span> flag_r++;
05341         <span class="keywordflow">break</span>;
05342       <span class="keywordflow">case</span> <span class="charliteral">'w'</span>:
05343         <span class="keywordflow">if</span> (flag_r)
05344         {
05345           fprintf(output,
05346               <span class="stringliteral">"rcp: error: option 'w' conflicts with option 'r'.\n"</span>);
05347           err_flag ++;
05348         }
05349         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag_w)
05350           fprintf(output,
05351               <span class="stringliteral">"rcp: warning: option 'w' has been specified more than once.\n"</span>);
05352         <span class="keywordflow">else</span> flag_w++;
05353         <span class="keywordflow">break</span>;
05354       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
05355         <span class="keywordflow">if</span> ( flag_h )
05356           fprintf(output,
05357               <span class="stringliteral">"rcp: warning: option 'h' has been specified more than once.\n"</span>);
05358         <span class="keywordflow">else</span> flag_h++;
05359         <span class="keywordflow">break</span>;
05360       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
05361         <span class="keywordflow">if</span> ( flag_v )
05362           fprintf(output,
05363               <span class="stringliteral">"rcp: warning: option 'v' has been specified more than once.\n"</span>);
05364         <span class="keywordflow">else</span> flag_v++;
05365         <span class="keywordflow">break</span>;
05366       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
05367         fprintf(output,<span class="stringliteral">"rcp: unknown option : %c\n"</span>,<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
05368         err_flag ++;
05369         <span class="keywordflow">break</span>;
05370     }    
05371   }
05372   
05373   <span class="keywordflow">if</span> (flag_h){
05374     fprintf(output,help_rcp);
05375     <span class="keywordflow">return</span> 0;
05376   }
05377   
05378   <span class="comment">/* two args expected */</span>
05379   <span class="keywordflow">if</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-2) )
05380     err_flag ++;
05381   <span class="keywordflow">else</span>
05382   {
05383     fsal_file = argv[Optind]; 
05384     local_file = argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1];
05385   }
05386   
05387   <span class="keywordflow">if</span> (err_flag){
05388     fprintf(output,help_rcp);
05389     <span class="keywordflow">return</span> -1;
05390   }
05391     
05392   <span class="comment">/* copy current path. */</span>
05393   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
05394   
05395   <span class="comment">/* retrieves object handle*/</span>
05396   
05397   <span class="keywordflow">if</span> (rc = 
05398       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
05399                 fsal_file,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;filehdl,output))
05400     <span class="keywordflow">return</span> rc;
05401 
05402   
05403   <span class="comment">/* build fsal path strcuture for local file */</span>
05404   
05405   st = FSAL_str2path( local_file, strlen(local_file)+1,
05406                       &amp;local_path_fsal );
05407   
05408   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )){
05409     
05410     fprintf(output,<span class="stringliteral">"Error executing FSAL_str2path:"</span>);
05411     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
05412     fprintf(output,<span class="stringliteral">"\n"</span>);
05413     <span class="keywordflow">return</span> st.major;
05414     
05415   }
05416 
05417     
05418   <span class="comment">/* make rcp flags */</span>
05419   
05420   <span class="keywordflow">if</span> ( flag_r )
05421     rcp_opt = FSAL_RCP_FS_TO_LOCAL | FSAL_RCP_LOCAL_CREAT ;
05422   <span class="keywordflow">else</span>
05423     rcp_opt = FSAL_RCP_LOCAL_TO_FS ;
05424 
05425   <span class="keywordflow">if</span> ( flag_v )
05426   {
05427     fprintf(output, <span class="stringliteral">"rcp: calling FSAL_rcp with options: "</span>);
05428     
05429     <span class="keywordflow">if</span> ( rcp_opt &amp; FSAL_RCP_FS_TO_LOCAL )
05430       fprintf(output, <span class="stringliteral">"FSAL_RCP_FS_TO_LOCAL "</span>);
05431     
05432     <span class="keywordflow">if</span> ( rcp_opt &amp; FSAL_RCP_LOCAL_TO_FS )
05433       fprintf(output, <span class="stringliteral">"FSAL_RCP_LOCAL_TO_FS "</span>);
05434     
05435     <span class="keywordflow">if</span> ( rcp_opt &amp; FSAL_RCP_LOCAL_EXCL )
05436       fprintf(output, <span class="stringliteral">"FSAL_RCP_LOCAL_EXCL "</span>);
05437     
05438     <span class="keywordflow">if</span> ( rcp_opt &amp; FSAL_RCP_LOCAL_CREAT )
05439       fprintf(output, <span class="stringliteral">"FSAL_RCP_LOCAL_CREAT "</span>);
05440     
05441     fprintf(output,<span class="stringliteral">"\n"</span>);
05442   }
05443   
05444   
05445   <span class="comment">/* rcp operation */</span>
05446   
05447   st = FSAL_rcp( &amp;filehdl, &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>, &amp;local_path_fsal ,rcp_opt );
05448   
05449   <span class="keywordflow">if</span> ( FSAL_IS_ERROR(st) ){
05450     fprintf(output,<span class="stringliteral">"Error executing FSAL_rcp:"</span>);
05451     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
05452     fprintf(output,<span class="stringliteral">"\n"</span>);
05453     <span class="keywordflow">return</span> st.major;
05454   }
05455   
05456   <span class="keywordflow">if</span> ( flag_v )
05457   {
05458     <span class="keywordflow">if</span> ( flag_r )
05459       fprintf(output, <span class="stringliteral">"rcp operation successfully completed : %s -&gt; %s\n"</span>,glob_path, local_file );
05460     <span class="keywordflow">else</span>
05461       fprintf(output, <span class="stringliteral">"rcp operation successfully completed : %s -&gt; %s\n"</span>,local_file, glob_path );      
05462   }
05463     
05464   <span class="keywordflow">return</span> 0;
05465   
05466 }
05467 
05468 
05469 
05470 
<a name="l05472"></a><a class="code" href="commands__FSAL_8c.html#a45">05472</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a45">fn_fsal_cross</a>( <span class="keywordtype">int</span> argc , <span class="comment">/* IN : number of args in argv */</span>
05473         <span class="keywordtype">char</span> ** argv ,        <span class="comment">/* IN : arg list               */</span>
05474         FILE * output         <span class="comment">/* IN : output stream          */</span>
05475       ){
05476 
05477   
05478   <span class="keyword">static</span> <span class="keywordtype">char</span> help_cross[]=
05479   <span class="stringliteral">"usage: cross &lt;junction_path&gt;\n"</span>;
05480 
05481   <span class="keywordtype">char</span> glob_path[FSAL_MAX_PATH_LEN];
05482   fsal_handle_t junction_hdl, root_hdl;
05483   fsal_attrib_list_t attrs;
05484   fsal_status_t st;
05485   <span class="keywordtype">int</span> rc;
05486     
05487   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
05488 
05489   <span class="comment">/* is the fs initialized ? */</span>
05490   <span class="keywordflow">if</span> (!is_loaded){
05491     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
05492     <span class="keywordflow">return</span> -1;
05493   }
05494   
05495   
05496   <span class="comment">/* initialize current thread */</span>
05497     
05498   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
05499   
05500   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
05501   { 
05502     <span class="keywordtype">int</span> rc;
05503     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
05504     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
05505   }
05506   
05507   <span class="comment">/* Exactly one arg expected */</span>
05508   <span class="keywordflow">if</span> (argc!=2){
05509     fprintf(output,help_cross);
05510     <span class="keywordflow">return</span> -1;
05511   }
05512   
05513   <span class="comment">/* is it a relative or absolute path. */</span>
05514   strncpy(glob_path,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
05515   
05516   <span class="keywordflow">if</span> (rc = 
05517       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path,FSAL_MAX_PATH_LEN,
05518                 argv[1],context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;junction_hdl,output))
05519     <span class="keywordflow">return</span> rc;
05520 
05521   <span class="comment">/* solves the junction */</span>
05522   FSAL_CLEAR_MASK( attrs.asked_attributes );
05523   FSAL_SET_MASK( attrs.asked_attributes,
05524       FSAL_ATTR_TYPE
05525       | FSAL_ATTR_MODE
05526       | FSAL_ATTR_GROUP
05527       | FSAL_ATTR_OWNER
05528       );
05529   
05530   st = FSAL_lookupJunction( &amp;junction_hdl,
05531                             &amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o3">context</a>,
05532                             &amp;root_hdl,
05533                             <a class="code" href="Getopt_8c.html#a0">NULL</a> );
05534   
05535   <span class="keywordflow">if</span> ( FSAL_IS_ERROR( st ) ){
05536     <span class="keywordtype">char</span> buff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];
05537     snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;junction_hdl);
05538     
05539     fprintf(output,<span class="stringliteral">"Error executing FSAL_lookupJunction(@%s):"</span>,buff);
05540     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
05541     fprintf(output,<span class="stringliteral">"\n"</span>);
05542     <span class="keywordflow">return</span> st.major;
05543   }
05544   
05545   <span class="comment">/* Apply changes */</span>
05546   strncat( glob_path,<span class="stringliteral">"&gt;"</span>,FSAL_MAX_PATH_LEN );
05547   strncpy(context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,glob_path,FSAL_MAX_PATH_LEN);
05548   context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a> = root_hdl;
05549     
05550   {
05551   <span class="keywordtype">char</span> buff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];
05552   snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>);
05553   
05554   fprintf(output,<span class="stringliteral">"Current directory is \"%s\" (@%s)\n"</span>,
05555     context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,buff);
05556   }
05557    
05558   <span class="keywordflow">return</span> 0;
05559       
05560 }
05561 
05562 
<a name="l05564"></a><a class="code" href="commands__FSAL_8c.html#a46">05564</a> <span class="keywordtype">int</span> <a class="code" href="commands__FSAL_8c.html#a46">fn_fsal_handlecmp</a>( <span class="keywordtype">int</span> argc , <span class="comment">/* IN : number of args in argv */</span>
05565                        <span class="keywordtype">char</span> ** argv ,         <span class="comment">/* IN : arg list   */</span>
05566                        FILE * output          <span class="comment">/* IN : output stream */</span>
05567                       )
05568 {
05569   <span class="keyword">static</span> <span class="keywordtype">char</span> help_handlecmp[]=
05570   <span class="stringliteral">"usage: handlecmp &lt;obj1&gt; &lt;obj2&gt;\n"</span>;
05571 
05572   <span class="keywordtype">char</span> glob_path1[FSAL_MAX_PATH_LEN];
05573   <span class="keywordtype">char</span> glob_path2[FSAL_MAX_PATH_LEN];
05574   <span class="keywordtype">char</span> buff[2*<span class="keyword">sizeof</span>(fsal_handle_t)+1];
05575   
05576   fsal_handle_t hdl1, hdl2;
05577   fsal_status_t st;
05578   <span class="keywordtype">int</span> rc;
05579     
05580   <a class="code" href="structcmdfsal__thr__info____.html">cmdfsal_thr_info_t</a> * context;
05581 
05582   <span class="comment">/* is the fs initialized ? */</span>
05583   <span class="keywordflow">if</span> (!is_loaded){
05584     fprintf(output,<span class="stringliteral">"Error: filesystem not initialized\n"</span>);
05585     <span class="keywordflow">return</span> -1;
05586   }
05587   
05588   
05589   <span class="comment">/* initialize current thread */</span>
05590     
05591   context = <a class="code" href="commands__FSAL_8c.html#a12">GetFSALCmdContext</a>();
05592   
05593   <span class="keywordflow">if</span> ( context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o0">is_thread_ok</a> != TRUE )
05594   { 
05595     <span class="keywordtype">int</span> rc;
05596     rc = <a class="code" href="commands__FSAL_8c.html#a13">Init_Thread_Context</a>( output, context, 0 );
05597     <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;
05598   }
05599   
05600   <span class="comment">/* Exactly 2 args expected */</span>
05601   <span class="keywordflow">if</span> (argc!=3){
05602     fprintf(output,help_handlecmp);
05603     <span class="keywordflow">return</span> -1;
05604   }
05605   
05606   strncpy(glob_path1,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
05607   strncpy(glob_path2,context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o2">current_path</a>,FSAL_MAX_PATH_LEN);
05608   
05609   <span class="keywordflow">if</span> (rc = 
05610       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path1,FSAL_MAX_PATH_LEN,
05611                 argv[1],context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;hdl1,output))
05612     <span class="keywordflow">return</span> rc;
05613 
05614   <span class="keywordflow">if</span> (rc = 
05615       <a class="code" href="commands__FSAL_8c.html#a19">solvepath</a>(glob_path2,FSAL_MAX_PATH_LEN,
05616                 argv[2],context-&gt;<a class="code" href="structcmdfsal__thr__info____.html#o1">current_dir</a>,&amp;hdl2,output))
05617     <span class="keywordflow">return</span> rc;
05618   
05619   <span class="comment">/* it should return :</span>
05620 <span class="comment">   *  - 0 if handle are the same</span>
05621 <span class="comment">   *    - A non null value else.</span>
05622 <span class="comment">   */</span>
05623   rc = FSAL_handlecmp( &amp;hdl1, &amp;hdl2, &amp;st );
05624   
05625   <span class="keywordflow">if</span> (FSAL_IS_ERROR( st )){    
05626     fprintf(output,<span class="stringliteral">"Error executing FSAL_handlecmp:"</span>);
05627     <a class="code" href="cmd__tools_8h.html#a18">print_fsal_status</a>(output,st);
05628     fprintf(output,<span class="stringliteral">"\n"</span>);
05629     <span class="keywordflow">return</span> st.major;    
05630   }
05631   
05632   snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;hdl1);  
05633   fprintf(output, <span class="stringliteral">"%s: handle = @%s\n"</span>, argv[1],buff);
05634   
05635   snprintHandle(buff,2*<span class="keyword">sizeof</span>(fsal_handle_t)+1,&amp;hdl2);  
05636   fprintf(output, <span class="stringliteral">"%s: handle = @%s\n"</span>, argv[2],buff);
05637   
05638   <span class="keywordflow">if</span> ( rc == 0 )
05639   {
05640     fprintf(output, <span class="stringliteral">"Handles are identical.\n"</span>);
05641     <span class="keywordflow">return</span> rc;
05642   }
05643   <span class="keywordflow">else</span>
05644   {
05645     fprintf(output, <span class="stringliteral">"Handles are different.\n"</span>);
05646     <span class="keywordflow">return</span> rc;
05647   }
05648   
05649   <span class="keywordflow">return</span> 0; 
05650 }
05651 
05652 
05653 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:35 2008 for ganeshell by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
