<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ganeshell: shell_utils.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>shell_utils.c</h1><a href="shell__utils_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * Ce logiciel est un serveur implementant le protocole NFS.</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> * Ce logiciel est régi par la licence CeCILL soumise au droit français et</span>
00012 <span class="comment"> * respectant les principes de diffusion des logiciels libres. Vous pouvez</span>
00013 <span class="comment"> * utiliser, modifier et/ou redistribuer ce programme sous les conditions</span>
00014 <span class="comment"> * de la licence CeCILL telle que diffusée par le CEA, le CNRS et l'INRIA</span>
00015 <span class="comment"> * sur le site "http://www.cecill.info".</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * En contrepartie de l'accessibilité au code source et des droits de copie,</span>
00018 <span class="comment"> * de modification et de redistribution accordés par cette licence, il n'est</span>
00019 <span class="comment"> * offert aux utilisateurs qu'une garantie limitée.  Pour les mêmes raisons,</span>
00020 <span class="comment"> * seule une responsabilité restreinte pèse sur l'auteur du programme,  le</span>
00021 <span class="comment"> * titulaire des droits patrimoniaux et les concédants successifs.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * A cet égard  l'attention de l'utilisateur est attirée sur les risques</span>
00024 <span class="comment"> * associés au chargement,  à l'utilisation,  à la modification et/ou au</span>
00025 <span class="comment"> * développement et à la reproduction du logiciel par l'utilisateur étant</span>
00026 <span class="comment"> * donné sa spécificité de logiciel libre, qui peut le rendre complexe à</span>
00027 <span class="comment"> * manipuler et qui le réserve donc à des développeurs et des professionnels</span>
00028 <span class="comment"> * avertis possédant  des  connaissances  informatiques approfondies.  Les</span>
00029 <span class="comment"> * utilisateurs sont donc invités à charger  et  tester  l'adéquation  du</span>
00030 <span class="comment"> * logiciel à leurs besoins dans des conditions permettant d'assurer la</span>
00031 <span class="comment"> * sécurité de leurs systèmes et ou de leurs données et, plus généralement,</span>
00032 <span class="comment"> * à l'utiliser et l'exploiter dans les mêmes conditions de sécurité.</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> * Le fait que vous puissiez accéder à cet en-tête signifie que vous avez</span>
00035 <span class="comment"> * pris connaissance de la licence CeCILL, et que vous en avez accepté les</span>
00036 <span class="comment"> * termes.</span>
00037 <span class="comment"> *</span>
00038 <span class="comment"> * ---------------------</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * Copyright CEA/DAM/DIF (2005)</span>
00041 <span class="comment"> *  Contributor: Philippe DENIEL  philippe.deniel@cea.fr</span>
00042 <span class="comment"> *               Thomas LEIBOVICI thomas.leibovici@cea.fr</span>
00043 <span class="comment"> *</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> * This software is a server that implements the NFS protocol.</span>
00046 <span class="comment"> * </span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> * This software is governed by the CeCILL  license under French law and</span>
00049 <span class="comment"> * abiding by the rules of distribution of free software.  You can  use,</span>
00050 <span class="comment"> * modify and/ or redistribute the software under the terms of the CeCILL</span>
00051 <span class="comment"> * license as circulated by CEA, CNRS and INRIA at the following URL</span>
00052 <span class="comment"> * "http://www.cecill.info".</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> * As a counterpart to the access to the source code and  rights to copy,</span>
00055 <span class="comment"> * modify and redistribute granted by the license, users are provided only</span>
00056 <span class="comment"> * with a limited warranty  and the software's author,  the holder of the</span>
00057 <span class="comment"> * economic rights,  and the successive licensors  have only  limited</span>
00058 <span class="comment"> * liability.</span>
00059 <span class="comment"> *</span>
00060 <span class="comment"> * In this respect, the user's attention is drawn to the risks associated</span>
00061 <span class="comment"> * with loading,  using,  modifying and/or developing or reproducing the</span>
00062 <span class="comment"> * software by the user in light of its specific status of free software,</span>
00063 <span class="comment"> * that may mean  that it is complicated to manipulate,  and  that  also</span>
00064 <span class="comment"> therefore means  that it is reserved for developers  and  experienced</span>
00065 <span class="comment"> * professionals having in-depth computer knowledge. Users are therefore</span>
00066 <span class="comment"> * encouraged to load and test the software's suitability as regards their</span>
00067 <span class="comment"> * requirements in conditions enabling the security of their systems and/or</span>
00068 <span class="comment"> * data to be ensured and,  more generally, to use and operate it in the</span>
00069 <span class="comment"> * same conditions as regards security.</span>
00070 <span class="comment"> *</span>
00071 <span class="comment"> * The fact that you are presently reading this means that you have had</span>
00072 <span class="comment"> * knowledge of the CeCILL license and that you accept its terms.</span>
00073 <span class="comment"> * ---------------------------------------</span>
00074 <span class="comment"> */</span>
00075 
00111 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00113 <span class="preprocessor">#endif</span>
00114 <span class="preprocessor"></span>
00115  
00116 <span class="preprocessor">#include "<a class="code" href="cmd__tools_8h.html">cmd_tools.h</a>"</span>
00117 <span class="preprocessor">#include &lt;errno.h&gt;</span> 
00118 <span class="preprocessor">#include "<a class="code" href="shell__utils_8h.html">shell_utils.h</a>"</span>
00119 <span class="preprocessor">#include "<a class="code" href="Getopt_8h.html">Getopt.h</a>"</span>
00120 <span class="preprocessor">#include &lt;string.h&gt;</span>
00121 
00122 <span class="preprocessor">#include "stuff_alloc.h"</span>
00123 
00124 <span class="comment">/* For mallinfo */</span>
00125 <span class="preprocessor">#include &lt;malloc.h&gt;</span>
00126 
00127 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00128 
00129 <span class="comment">/*--------------------------</span>
00130 <span class="comment"> *    Timer management.</span>
00131 <span class="comment"> *-------------------------*/</span>
00132 
00133 <span class="comment">/* start time */</span>
00134 <span class="keyword">static</span> <span class="keyword">struct </span>timeval timer_start = {0,0};
00135 
00136 <span class="comment">/* stop time */</span>
00137 <span class="keyword">static</span> <span class="keyword">struct </span>timeval timer_end = {0,0};
00138 
00139 <span class="comment">/* timer state (0=OFF, 1=ON) */</span>
00140 <span class="keyword">static</span> <span class="keywordtype">int</span> timer_state = 0;
00141 
00142 
00143 
00144 <span class="comment">/* The timer command */</span>
00145 
<a name="l00146"></a><a class="code" href="shell__utils_8h.html#a1">00146</a> <span class="keywordtype">int</span> <a class="code" href="shell__utils_8h.html#a1">util_timer</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00147                 <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00148                 FILE * output      <span class="comment">/* IN : output stream          */</span>
00149               )
00150 {
00151   
00152   
00153       <span class="keywordflow">if</span> (argc != 2)
00154       {
00155         fprintf(output,<span class="stringliteral">"Usage: %s start|print|stop.\n"</span>,argv[0]);
00156         <span class="keywordflow">return</span> -1;
00157       }
00158       
00159       <span class="comment">/* Timer start command */</span>
00160       
00161       <span class="keywordflow">if</span> (!strcmp(argv[1],<span class="stringliteral">"start"</span>)){
00162         
00163         <span class="keywordflow">if</span> ( timer_state ){
00164           fprintf(output,<span class="stringliteral">"Timer already started.\n"</span>);
00165           <span class="keywordflow">return</span> -1;
00166         }
00167         
00168         <span class="keywordflow">if</span> ( gettimeofday(&amp;timer_start,<a class="code" href="Getopt_8c.html#a0">NULL</a>)== -1 ){
00169           fprintf(output,<span class="stringliteral">"Error retrieving system time.\n"</span>);
00170           <span class="keywordflow">return</span> -1;
00171         }
00172         
00173         fprintf( output,<span class="stringliteral">"Timer start time: "</span> );
00174         <a class="code" href="cmd__tools_8h.html#a0">print_timeval</a>( output, timer_start );
00175         
00176         timer_state = 1;
00177         <span class="keywordflow">return</span> 0;
00178       }
00179       
00180       
00181       <span class="comment">/* Timer stop command */</span>
00182       
00183       <span class="keywordflow">if</span> ( !strcmp(argv[1],<span class="stringliteral">"stop"</span>) )
00184       {
00185         
00186         <span class="keywordflow">if</span> (!timer_state)
00187         {
00188           fprintf(output,<span class="stringliteral">"Timer is not started.\n"</span>);
00189           <span class="keywordflow">return</span> -1;
00190         }
00191         
00192         <span class="keywordflow">if</span> ( gettimeofday(&amp;timer_end,<a class="code" href="Getopt_8c.html#a0">NULL</a>)== -1 )
00193         {
00194           fprintf(output,<span class="stringliteral">"Error retrieving system time.\n"</span>);
00195           <span class="keywordflow">return</span> -1;
00196         }
00197         
00198         fprintf(output,<span class="stringliteral">"Timer stop time: "</span>);
00199         <a class="code" href="cmd__tools_8h.html#a0">print_timeval</a>( output, timer_end );
00200         
00201         timer_state = 0;
00202         <span class="keywordflow">return</span> 0;
00203       }
00204       
00205       
00206       <span class="comment">/* Timer print command */</span>
00207       
00208       <span class="keywordflow">if</span> ( !strcmp(argv[1],<span class="stringliteral">"print"</span>) )
00209       {
00210         
00211         <span class="keywordflow">if</span> ( timer_state )
00212         {
00213           
00214           <span class="keyword">struct </span>timeval timer_tmp;
00215           
00216           <span class="comment">/* timer is running, print current enlapsed time */</span>
00217           <span class="keywordflow">if</span> ( gettimeofday(&amp;timer_tmp,<a class="code" href="Getopt_8c.html#a0">NULL</a>)== -1 )
00218           {
00219             fprintf(output,<span class="stringliteral">"Error retrieving system time.\n"</span>);
00220             <span class="keywordflow">return</span> -1;
00221           }
00222           
00223           timer_tmp = <a class="code" href="cmd__tools_8h.html#a24">time_diff</a>( timer_start,timer_tmp );
00224           <a class="code" href="cmd__tools_8h.html#a0">print_timeval</a>( output, timer_tmp );
00225           
00226         } <span class="keywordflow">else</span> {
00227           
00228           <span class="keyword">struct </span>timeval timer_tmp;
00229           
00230           timer_tmp = <a class="code" href="cmd__tools_8h.html#a24">time_diff</a>( timer_start, timer_end );
00231           <a class="code" href="cmd__tools_8h.html#a0">print_timeval</a>( output, timer_tmp );
00232           
00233         }
00234         <span class="keywordflow">return</span> 0;
00235       }
00236       
00237       <span class="comment">/* unknown timer command */</span>
00238       fprintf(output,<span class="stringliteral">"Usage: %s start|print|stop.\n"</span>,argv[0]);
00239       <span class="keywordflow">return</span> -1;  
00240   
00241 } <span class="comment">/* util_timer */</span>
00242 
00243 
00244 
00245 
00246 <span class="comment">/*--------------------------</span>
00247 <span class="comment"> *      System utils.</span>
00248 <span class="comment"> *-------------------------*/</span>
00249 
00250 
<a name="l00251"></a><a class="code" href="shell__utils_8h.html#a2">00251</a> <span class="keywordtype">int</span> <a class="code" href="shell__utils_8h.html#a2">util_sleep</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00252                 <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00253                 FILE * output      <span class="comment">/* IN : output stream          */</span>
00254               )
00255 {
00256   
00257       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sleep_time;        
00258       <span class="keywordtype">int</span> rc;
00259       
00260       <span class="keywordflow">if</span> (argc != 2)
00261       {        
00262         fprintf( output,<span class="stringliteral">"Usage: %s &lt;int value&gt;\n"</span>,argv[0]);
00263         <span class="keywordflow">return</span> -1;        
00264       }
00265 
00266       <span class="comment">/* conversion */</span>
00267       rc = <a class="code" href="cmd__tools_8h.html#a10">my_atoi</a>( argv[1] );
00268 
00269       <span class="keywordflow">if</span> ( rc&lt;0 )
00270       {
00271         fprintf( output,<span class="stringliteral">"Usage: %s &lt;int value&gt; (%s is not a positive integer)\n"</span>,argv[0],argv[1]);
00272         <span class="keywordflow">return</span> -1;
00273       }
00274 
00275       sleep_time = ( <span class="keywordtype">unsigned</span> long ) rc;
00276 
00277       fprintf( output,<span class="stringliteral">"sleep: suspending execution for %lu s...\n"</span>, sleep_time);
00278 
00279       <span class="comment">/* sleeping */</span>
00280 
00281       sleep(sleep_time);
00282 
00283       
00284       <span class="keywordflow">return</span> 0;
00285   
00286 }
00287 
00288 
00289 
00290 
<a name="l00291"></a><a class="code" href="shell__utils_8h.html#a3">00291</a> <span class="keywordtype">int</span> <a class="code" href="shell__utils_8h.html#a3">util_shell</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00292                 <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00293                 FILE * output      <span class="comment">/* IN : output stream          */</span>
00294               )
00295 {
00296   
00297   FILE * cmd_output;
00298   <span class="keywordtype">int</span> i;
00299   <span class="keywordtype">char</span> command_line[1024] = <span class="stringliteral">""</span>;
00300   <span class="keywordtype">char</span> buffer[1024];
00301 
00302   <span class="keywordflow">if</span> ( argc &lt; 2 )
00303   {
00304     fprintf( output,<span class="stringliteral">"Usage: %s &lt;shell_cmd&gt; [arg1 arg2 ...]\n"</span>,argv[0]);
00305     <span class="keywordflow">return</span> -1;
00306   }
00307 
00308     
00309   <span class="comment">/* builds the command line */</span>
00310   
00311   <span class="keywordflow">for</span> ( i = 1; i &lt;argc ; i++ )
00312   {
00313     strncat( command_line, argv[i], 1024 );
00314     <span class="keywordflow">if</span> ( i != argc - 1 )
00315       strncat( command_line, <span class="stringliteral">" "</span>, 1024 );
00316   }
00317   
00318   <span class="comment">/* launch the command */</span>
00319   
00320   cmd_output = popen( command_line, <span class="stringliteral">"r"</span> );
00321   
00322   <span class="keywordflow">if</span> ( cmd_output == NULL )
00323   {
00324     fprintf( output,<span class="stringliteral">"shell: popen error %d\n"</span>, errno );
00325     <span class="keywordflow">return</span> -1;
00326   }
00327   
00328   <span class="comment">/* copy the shell ouput to the command output stream */</span>
00329   
00330   <span class="keywordflow">while</span> ( fgets( buffer, <span class="keyword">sizeof</span>(buffer), cmd_output ) != NULL )
00331   {    
00332     fputs( buffer, output );    
00333   }
00334   
00335   <span class="comment">/* get returned status */</span>
00336   
00337   <span class="keywordflow">return</span> pclose( cmd_output );  
00338   
00339 } <span class="comment">/* util_shell */</span>
00340 
00341 
00342 
00343 
<a name="l00344"></a><a class="code" href="shell__utils_8h.html#a4">00344</a> <span class="keywordtype">int</span> <a class="code" href="shell__utils_8h.html#a4">util_meminfo</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00345                   <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00346                   FILE * output      <span class="comment">/* IN : output stream          */</span>
00347                  )
00348 {
00349 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00350 <span class="preprocessor"></span>  buddy_stats_t bstats;
00351 <span class="preprocessor">#endif</span>
00352 <span class="preprocessor"></span>        
00353   <span class="comment">/* standard mallinfo */</span>
00354   
00355   <span class="keyword">struct </span>mallinfo meminfo = mallinfo();
00356   
00357   fprintf(output, <span class="stringliteral">"Mallinfo:\n"</span>);
00358   
00359   fprintf(output, <span class="stringliteral">"   Total space in arena: %lu\n"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)meminfo.arena );
00360   fprintf(output, <span class="stringliteral">"   Number of ordinary blocks: %d\n"</span>, meminfo.ordblks );
00361   fprintf(output, <span class="stringliteral">"   Number of small blocks: %d\n"</span>, meminfo.smblks );
00362   fprintf(output, <span class="stringliteral">"   Number of holding blocks: %d\n"</span>, meminfo.hblks );
00363   fprintf(output, <span class="stringliteral">"   Space in holding block headers: %d\n"</span>, meminfo.hblkhd );
00364   fprintf(output, <span class="stringliteral">"   Space in small blocks in use: %lu\n"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)meminfo.usmblks );
00365   fprintf(output, <span class="stringliteral">"   Space in free small blocks: %lu\n"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)meminfo.fsmblks );
00366   fprintf(output, <span class="stringliteral">"   Space in ordinary blocks in use: %lu\n"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)meminfo.uordblks );
00367   fprintf(output, <span class="stringliteral">"   Space in free ordinary blocks: %lu\n"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)meminfo.fordblks );
00368   fprintf(output, <span class="stringliteral">"   Cost of enabling keep option: %d\n"</span>, meminfo.keepcost );  
00369   fprintf(output,<span class="stringliteral">"\n"</span>);
00370   
00371 <span class="preprocessor">#ifndef _NO_BUDDY_SYSTEM</span>
00372 <span class="preprocessor"></span>  
00373   BuddyGetStats( &amp;bstats ) ;
00374   
00375   fprintf(output, <span class="stringliteral">"Buddy info (thread %p):\n"</span>,(caddr_t)pthread_self() );
00376   <span class="comment">/* Buddy sytem info */</span>
00377   
00378   fprintf( output, <span class="stringliteral">"Total Space in Arena: %lu  (Watermark: %lu)\n"</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.TotalMemSpace,
00379                                                                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.WM_TotalMemSpace );
00380   fprintf( output, <span class="stringliteral">"\n"</span> );
00381   
00382   fprintf( output, <span class="stringliteral">"Total Space for Standard Pages: %lu  (Watermark: %lu)\n"</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.StdMemSpace,
00383                                                                      (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.WM_StdMemSpace );
00384   
00385   fprintf( output, <span class="stringliteral">"      Nb Standard Pages: %lu\n"</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.NbStdPages );
00386   
00387   fprintf( output, <span class="stringliteral">"      Size of Std Pages: %lu\n"</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.StdPageSize );
00388   
00389 
00390   fprintf( output, <span class="stringliteral">"      Space Used inside Std Pages: %lu  (Watermark: %lu)\n"</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.StdUsedSpace, 
00391                                                                      (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.WM_StdUsedSpace );
00392 
00393           
00394   fprintf( output, <span class="stringliteral">"      Nb of Std Pages Used: %lu  (Watermark: %lu)\n"</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.NbStdUsed ,
00395                                                                      (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bstats.WM_NbStdUsed );
00396   
00397   <span class="keywordflow">if</span> ( bstats.NbStdUsed &gt; 0 )
00398   {
00399   fprintf( output, <span class="stringliteral">"      Memory Fragmentation: %.2f %%\n"</span>,
00400              100.0 - ( 100.0 * bstats.StdUsedSpace / ( 1.0 * bstats.NbStdUsed * bstats.StdPageSize )) );
00401   }
00402   
00403   fprintf( output, <span class="stringliteral">"\n"</span> );  
00404   
00405   
00406 <span class="preprocessor">#endif</span>
00407 <span class="preprocessor"></span>  
00408   <span class="keywordflow">return</span> 0;
00409   
00410   
00411 } <span class="comment">/* util_meminfo */</span>
00412 
00413 
00414 
00415 <span class="comment">/*----------------------</span>
00416 <span class="comment"> *    String utils.</span>
00417 <span class="comment"> *----------------------*/</span>
00418 
<a name="l00419"></a><a class="code" href="shell__utils_8h.html#a5">00419</a> <span class="keywordtype">int</span> <a class="code" href="shell__utils_8h.html#a5">util_cmp</a>( <span class="keywordtype">int</span> argc ,        <span class="comment">/* IN : number of args in argv */</span>
00420              <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00421              FILE * output      <span class="comment">/* IN : output stream          */</span>
00422             )
00423 {
00424   
00425   <span class="keyword">static</span> <span class="keywordtype">char</span> * format = <span class="stringliteral">"hinv"</span>;
00426   <span class="keyword">static</span> <span class="keywordtype">char</span> * help_cmp =
00427       <span class="stringliteral">"Usage: %s [ -h | -i | -n | -v ]  &lt;expr1&gt; &lt;expr2&gt;\n"</span>
00428       <span class="stringliteral">"     -h: print this help\n"</span>
00429       <span class="stringliteral">"     -i: case insensitive comparison\n"</span>
00430       <span class="stringliteral">"     -n: numerical comparison\n"</span>
00431       <span class="stringliteral">"     -v: verbose mode\n"</span>;
00432   
00433   <span class="keywordtype">int</span> err_flag = 0; <span class="comment">/* error parsing options */</span>
00434   <span class="keywordtype">int</span> flag_h = 0; <span class="comment">/* help */</span>
00435   <span class="keywordtype">int</span> flag_i = 0; <span class="comment">/* case insensitive compare */</span>
00436   <span class="keywordtype">int</span> flag_n = 0; <span class="comment">/* numerical compare */</span>
00437   <span class="keywordtype">int</span> flag_v = 0; <span class="comment">/* verbose */</span>
00438   
00439   <span class="keywordtype">int</span> rc, option;
00440     
00441   <span class="keywordtype">char</span> * str1 = NULL;  <span class="comment">/* arg1 */</span>
00442   <span class="keywordtype">char</span> * str2 = NULL;  <span class="comment">/* arg2 */</span>
00443   
00444   <span class="comment">/* the value to been returned, according to argv[0] */</span>
00445   <span class="keywordtype">int</span> value_if_equal = FALSE;
00446   
00447   <span class="keywordflow">if</span> (!strcmp(argv[0],<span class="stringliteral">"eq"</span>)) value_if_equal = TRUE;
00448   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(argv[0],<span class="stringliteral">"ne"</span>)) value_if_equal = FALSE;
00449   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(argv[0],<span class="stringliteral">"cmp"</span>)) value_if_equal = FALSE;
00450   <span class="comment">/* unexpected !!! */</span>
00451   <span class="keywordflow">else</span> exit(1);
00452   
00453   <span class="comment">/* disables Getopt error message */</span>
00454   <a class="code" href="Getopt_8c.html#a3">Opterr</a> = 0;
00455   
00456   <span class="comment">/* reinits Getopt processing */</span>
00457   <a class="code" href="Getopt_8c.html#a4">Optind</a> = 1;
00458 
00459   <span class="keywordflow">while</span> ((option = <a class="code" href="Getopt_8h.html#a4">Getopt</a>(argc, argv, format)) != -1)
00460   {   
00461     <span class="keywordflow">switch</span>(option)
00462     {
00463       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00464         <span class="keywordflow">if</span> (flag_h)
00465           fprintf(output,
00466               <span class="stringliteral">"%s: warning: option 'h' has been specified more than once.\n"</span>,argv[0] );
00467         <span class="keywordflow">else</span> flag_h ++;
00468         <span class="keywordflow">break</span>;
00469         
00470       <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00471         <span class="keywordflow">if</span> (flag_i)
00472           fprintf(output,
00473               <span class="stringliteral">"%s: warning: option 'i' has been specified more than once.\n"</span>,argv[0] );
00474         <span class="keywordflow">else</span> flag_i ++;
00475         <span class="keywordflow">break</span>;
00476         
00477       <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
00478         <span class="keywordflow">if</span> (flag_n)
00479           fprintf(output,
00480               <span class="stringliteral">"%s: warning: option 'n' has been specified more than once.\n"</span>,argv[0] );
00481         <span class="keywordflow">else</span> flag_n ++;
00482         <span class="keywordflow">break</span>;
00483         
00484       <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
00485         <span class="keywordflow">if</span> (flag_v)
00486           fprintf(output,
00487               <span class="stringliteral">"%s: warning: option 'v' has been specified more than once.\n"</span>,argv[0] );
00488         <span class="keywordflow">else</span> flag_v ++;
00489         <span class="keywordflow">break</span>;
00490         
00491       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00492         fprintf(output,<span class="stringliteral">"%s: unknown option : %c\n"</span>,argv[0],<a class="code" href="Getopt_8c.html#a5">Optopt</a>);
00493         err_flag ++;
00494         <span class="keywordflow">break</span>;
00495     }    
00496   }
00497 
00498   <span class="comment">/* help flag */</span>  
00499   <span class="keywordflow">if</span> ( flag_h )
00500   {
00501     fprintf( output, help_cmp, argv[0] );
00502     <span class="keywordflow">return</span> -1;
00503   }
00504 
00505   <span class="comment">/* check conflicts */</span>
00506   <span class="keywordflow">if</span> ( flag_i + flag_n &gt; 1 )
00507   {
00508     fprintf( output,<span class="stringliteral">"%s: conflict between options -i, -n\n"</span>,argv[0] );
00509     err_flag++;
00510   }
00511 
00512   
00513   <span class="comment">/* check arg number */</span>  
00514   <span class="keywordflow">if</span> ( <a class="code" href="Getopt_8c.html#a4">Optind</a> != (argc-2) )
00515   {
00516     <span class="comment">/* too much or not enough arguments */</span>
00517     err_flag ++;
00518   }
00519   <span class="keywordflow">else</span>
00520   {
00521     str1 = argv[Optind];
00522     str2 = argv[<a class="code" href="Getopt_8c.html#a4">Optind</a>+1];
00523   }
00524   
00525   <span class="comment">/* error */</span>
00526   <span class="keywordflow">if</span> (err_flag)
00527   {
00528     fprintf(output,help_cmp,argv[0]);
00529     <span class="keywordflow">return</span> -1;
00530   }
00531   
00532   
00533   <span class="keywordflow">if</span> ( !flag_i &amp;&amp; !flag_n )
00534   {
00535     <span class="comment">/* normal comparison */</span>
00536     rc = strcmp( str1, str2 );
00537   }
00538   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( flag_i )
00539   {
00540     <span class="comment">/* case insensitive comparison */</span>
00541     rc = strcasecmp( str1, str2 );
00542   }
00543   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( flag_n )
00544   {
00545     <span class="keywordtype">int</span> a,b;
00546     
00547     
00548     <span class="keywordflow">if</span> (str1[0]==<span class="charliteral">'-'</span>)
00549       a = <a class="code" href="cmd__tools_8h.html#a10">my_atoi</a>( str1+1 );
00550     <span class="keywordflow">else</span>
00551       a = <a class="code" href="cmd__tools_8h.html#a10">my_atoi</a>( str1 );
00552     
00553     <span class="keywordflow">if</span> ( a&lt;0 )
00554     {
00555       fprintf(output, <span class="stringliteral">"cmp: invalid integer value %s\n"</span>, str1 );
00556       <span class="keywordflow">return</span> -1;
00557     }
00558     
00559     <span class="keywordflow">if</span> (str1[0]==<span class="charliteral">'-'</span>) a = -a;
00560     
00561     <span class="keywordflow">if</span> (str2[0]==<span class="charliteral">'-'</span>)
00562       b = <a class="code" href="cmd__tools_8h.html#a10">my_atoi</a>( str2+1 );
00563     <span class="keywordflow">else</span>
00564       b = <a class="code" href="cmd__tools_8h.html#a10">my_atoi</a>( str2 );
00565     
00566     <span class="keywordflow">if</span> ( b&lt;0 )
00567     {
00568       fprintf(output, <span class="stringliteral">"cmp: invalid integer value %s\n"</span>, str2 );
00569       <span class="keywordflow">return</span> -1;
00570     }
00571     
00572     <span class="keywordflow">if</span> (str2[0]==<span class="charliteral">'-'</span>) b = -b;
00573     
00574     rc = b-a ;
00575     
00576   }
00577     
00578     
00579   <span class="comment">/* return values */</span>
00580         
00581   <span class="keywordflow">if</span> ( rc == 0 )
00582   {
00583     <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"arg1 = arg2\n"</span> );
00584     
00585     <span class="keywordflow">return</span> value_if_equal;
00586   }
00587   <span class="keywordflow">else</span>
00588   {
00589     <span class="keywordflow">if</span> (flag_v) fprintf(output,<span class="stringliteral">"arg1 &lt;&gt; arg2\n"</span> );
00590     
00591     <span class="keywordflow">return</span> (!value_if_equal) ;
00592   }
00593   
00594 } <span class="comment">/* util_cmp */</span>
00595 
00596 
00597 
00598 <span class="comment">/* diff 2 strings line by line */</span>
00599 
00600 <span class="keyword">static</span> <span class="keywordtype">void</span> diff(FILE * output, <span class="keywordtype">char</span> * str1, <span class="keywordtype">char</span> * str2){
00601 
00602   <span class="comment">/* current lines,chars */</span>
00603   <span class="keywordtype">char</span> * str_line1;
00604   <span class="keywordtype">char</span> * char1;
00605   <span class="keywordtype">char</span> * str_line2;
00606   <span class="keywordtype">char</span> * char2;
00607   
00608   str_line1=str1;
00609   str_line2=str2;
00610   
00611   <span class="keywordflow">do</span> {
00612   
00613     char1=str_line1;
00614     char2=str_line2;
00615   
00616     <span class="keywordflow">while</span> (*char1 == *char2)
00617     {
00618       <span class="keywordflow">if</span> ((*char1 == <span class="charliteral">'\0'</span>) || (*char1 == <span class="charliteral">'\n'</span>))  <span class="keywordflow">break</span>;
00619             
00620       char1++;
00621       char2++;    
00622     }
00623     
00624     <span class="comment">/* different ? */</span>
00625     <span class="keywordflow">if</span> (*char1 != *char2)
00626     {
00627             
00628       <span class="comment">/* prints from the beggining of the line to the end */</span>
00629       <span class="keywordflow">if</span> (*str_line1) fprintf(output, <span class="stringliteral">"\t&lt;- "</span>);    
00630       
00631       <span class="keywordflow">while</span> ( (*str_line1) &amp;&amp; (*str_line1 != <span class="charliteral">'\n'</span>))
00632       {
00633         putc(*str_line1,output);
00634         str_line1++;
00635       }
00636       
00637       <span class="comment">/* skip the final \n  */</span>
00638       <span class="keywordflow">if</span> (*str_line1) str_line1++;
00639       
00640       <span class="keywordflow">if</span> (*str_line2) fprintf(output,<span class="stringliteral">"\n\t-&gt; "</span>);
00641       
00642       <span class="keywordflow">while</span> ( (*str_line2) &amp;&amp; (*str_line2 != <span class="charliteral">'\n'</span>))
00643       {
00644         putc(*str_line2,output);
00645         str_line2++;
00646       }
00647       <span class="comment">/* skip the final \n  */</span>
00648       <span class="keywordflow">if</span> (*str_line2) str_line2++;
00649       
00650       putc(<span class="charliteral">'\n'</span>,output);
00651 
00652     }
00653     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*char1 == <span class="charliteral">'\n'</span>)
00654     {      
00655       <span class="comment">/* end of line */</span>
00656       str_line1 = char1 + 1;
00657       str_line2 = char2 + 1;
00658     }
00659     <span class="keywordflow">else</span> 
00660     {
00661       <span class="comment">/* end of file */</span>
00662       <span class="keywordflow">break</span>;
00663     }
00664   
00665   } <span class="keywordflow">while</span>(1);
00666   
00667   <span class="keywordflow">return</span>;
00668       
00669 }
00670 
00671 
00672 
00673 
<a name="l00674"></a><a class="code" href="shell__utils_8h.html#a6">00674</a> <span class="keywordtype">int</span> <a class="code" href="shell__utils_8h.html#a6">util_diff</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00675                <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00676                FILE * output      <span class="comment">/* IN : output stream          */</span>
00677              )
00678 {
00679     
00680   <span class="keywordflow">if</span> ( argc != 3 )
00681   {
00682     fprintf( output,<span class="stringliteral">"Usage: %s &lt;expr1&gt; &lt;expr2&gt;\n"</span>,argv[0]);
00683     <span class="keywordflow">return</span> -1;
00684   }
00685   
00686   diff( output, argv[1], argv[2] );
00687   
00688   <span class="keywordflow">return</span> 0;
00689   
00690 }
00691 
00692 
00693 
00694 <span class="comment">/* counts the number of char and lines in a string.*/</span>
00695 <span class="keyword">static</span> <span class="keywordtype">void</span> wc( FILE * output, <span class="keywordtype">char</span> * str )
00696 {
00697   
00698   <span class="keywordtype">int</span> nb_char = 0;
00699   <span class="keywordtype">int</span> nb_NL = 0;
00700   <span class="keywordtype">char</span> * curr = str;
00701   
00702   <span class="keywordflow">while</span> ( *curr )
00703   {
00704     nb_char ++;
00705     <span class="keywordflow">if</span> (*curr==<span class="charliteral">'\n'</span>) nb_NL++;
00706     curr++;
00707   }
00708   
00709   fprintf(output, <span class="stringliteral">"%d %d\n"</span>,nb_char,nb_NL);
00710   
00711   <span class="keywordflow">return</span>;
00712 }
00713 
00714 
00715 
<a name="l00716"></a><a class="code" href="shell__utils_8h.html#a7">00716</a> <span class="keywordtype">int</span> <a class="code" href="shell__utils_8h.html#a7">util_wc</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00717              <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00718              FILE * output      <span class="comment">/* IN : output stream          */</span>
00719             )
00720 {
00721   
00722   <span class="keywordflow">if</span> ( argc != 2 )
00723   {
00724     fprintf( output,<span class="stringliteral">"Usage: %s &lt;expr&gt;\n"</span>,argv[0]);
00725     <span class="keywordflow">return</span> -1;
00726   }
00727   
00728   wc( output, argv[1] );
00729   
00730   <span class="keywordflow">return</span> 0;
00731   
00732 }
00733 
00734 
00735 
<a name="l00736"></a><a class="code" href="shell__utils_8h.html#a8">00736</a> <span class="keywordtype">int</span> <a class="code" href="shell__utils_8h.html#a8">util_chomp</a>( <span class="keywordtype">int</span> argc ,         <span class="comment">/* IN : number of args in argv */</span>
00737                 <span class="keywordtype">char</span> ** argv ,     <span class="comment">/* IN : arg list               */</span>
00738                 FILE * output      <span class="comment">/* IN : output stream          */</span>
00739               )
00740 {
00741   
00742   <span class="keywordtype">int</span> len;
00743   <span class="keywordtype">char</span> * in;
00744   <span class="keywordtype">char</span> * out;
00745   
00746   <span class="keywordflow">if</span> ( argc != 2 )
00747   {
00748     fprintf( output,<span class="stringliteral">"Usage: %s &lt;expr&gt;\n"</span>,argv[0]);
00749     <span class="keywordflow">return</span> -1;
00750   }
00751   
00752   in = argv[1];
00753   
00754   len = strlen(in);
00755 
00756   <span class="keywordflow">if</span> ( in[len-1] == <span class="charliteral">'\n'</span> )
00757   {
00758 
00759     out = (<span class="keywordtype">char</span> *)Mem_Alloc(len+1);
00760     
00761     <span class="keywordflow">if</span> ( out == NULL ) <span class="keywordflow">return</span> Mem_Errno;
00762     
00763     <span class="comment">/* local copy */</span>
00764     strncpy(out,in, len+1);
00765     
00766     out[len-1] = <span class="charliteral">'\0'</span>;
00767     
00768     fprintf( output, <span class="stringliteral">"%s"</span>, out);
00769     
00770     Mem_Free(out);
00771   
00772   }
00773   <span class="keywordflow">else</span>
00774   {
00775     fprintf( output, <span class="stringliteral">"%s"</span>, in);
00776   }
00777   
00778   <span class="keywordflow">return</span> 0;
00779   
00780 }
00781 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 9 08:24:35 2008 for ganeshell by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
