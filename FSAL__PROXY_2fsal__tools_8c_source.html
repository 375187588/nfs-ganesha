<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>nfs-ganesha: fsal_tools.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nfs-ganesha&#160;<span id="projectnumber">1.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>fsal_tools.c</h1>  </div>
</div>
<div class="contents">
<a href="FSAL__PROXY_2fsal__tools_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * vim:set expandtab:shiftwidth=2:tabstop=8:</span>
<a name="l00003"></a>00003 <span class="comment"> */</span>
<a name="l00004"></a>00004 
<a name="l00013"></a>00013 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#endif</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="preprocessor">#ifdef _SOLARIS</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span><span class="preprocessor">#include &quot;solaris_port.h&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#endif                          </span><span class="comment">/* _SOLARIS */</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;ctype.h&gt;</span>              <span class="comment">/* for isalpha */</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;netdb.h&gt;</span>              <span class="comment">/* for gethostbyname */</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;fsal.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="FSAL__PROXY_2fsal__internal_8h.html">fsal_internal.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="FSAL__PROXY_2fsal__common_8h.html">fsal_common.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="FSAL_2FSAL__PROXY_2fsal__convert_8h.html">fsal_convert.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;config_parsing.h&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="FSAL__PROXY_2fsal__common_8h.html">fsal_common.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#ifdef _HANDLE_MAPPING</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="handle__mapping_8h.html" title="This module is used for managing a persistent map between PROXY FSAL handles (including NFSv4 handles...">handle_mapping/handle_mapping.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#endif</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span>
<a name="l00039"></a>00039 <span class="keyword">extern</span> <a class="code" href="structproxyfs__specific__initinfo__t.html">proxyfs_specific_initinfo_t</a> <a class="code" href="FSAL__PROXY_2fsal__context_8c.html#aef581e684b2ec173691174858e72b991">global_fsal_proxy_specific_info</a>;
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">/* case unsensitivity */</span>
<a name="l00042"></a><a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">00042</a> <span class="preprocessor">#define STRCMP   strcasecmp</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span>
<a name="l00044"></a><a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a30c3538b920b4db2ca7919e1b3816cad">00044</a> <span class="keywordtype">char</span> *<a class="code" href="FSAL__PROXY_2fsal__internal_8h.html#a30c3538b920b4db2ca7919e1b3816cad">PROXYFSAL_GetFSName</a>()
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046   <span class="keywordflow">return</span> <span class="stringliteral">&quot;NFSv4 PROXY&quot;</span>;
<a name="l00047"></a>00047 }
<a name="l00048"></a>00048 
<a name="l00065"></a><a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a45a9e215c4afb0c3ac5067f643347aca">00065</a> <span class="keywordtype">int</span> <a class="code" href="FSAL__PROXY_2fsal__internal_8h.html#afac40da0de66584e1953230fa3cabb8b">PROXYFSAL_handlecmp</a>(<a class="code" href="structfsal__handle____.html">fsal_handle_t</a> * handle_1, <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> * handle_2,
<a name="l00066"></a>00066                         <a class="code" href="structfsal__status____.html">fsal_status_t</a> * status)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068   *status = FSAL_STATUS_NO_ERROR;
<a name="l00069"></a>00069   <a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> * handle1 = (<a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> *)handle_1;
<a name="l00070"></a>00070   <a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> * handle2 = (<a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> *)handle_2;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072   <span class="keywordflow">if</span>(!handle1 || !handle2)
<a name="l00073"></a>00073     {
<a name="l00074"></a>00074       status-&gt;<a class="code" href="structfsal__status____.html#ab12ffb4b1b65891a5dd5939fc7d543de">major</a> = <a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2af61ca69bcf4e68b1f488322eabd59ba7">ERR_FSAL_FAULT</a>;
<a name="l00075"></a>00075       <span class="keywordflow">return</span> -1;
<a name="l00076"></a>00076     }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   <span class="comment">/* Check if size are the same for underlying&#39;s server FH */</span>
<a name="l00079"></a>00079   <span class="keywordflow">if</span>(handle1-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a> != handle2-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a>)
<a name="l00080"></a>00080     <span class="keywordflow">return</span> -1;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082   <span class="comment">/* At last, check underlying FH value. We use the fact that srv_handle_len is the same */</span>
<a name="l00083"></a>00083   <span class="keywordflow">if</span>(memcmp(handle1-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#aebfab86fe06759fac32509a2bc2f39e8">srv_handle_val</a>, handle2-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#aebfab86fe06759fac32509a2bc2f39e8">srv_handle_val</a>, handle1-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a>))
<a name="l00084"></a>00084     <span class="keywordflow">return</span> -1;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086   <span class="comment">/* If this point is reached, then the FH are the same */</span>
<a name="l00087"></a>00087   <span class="keywordflow">return</span> 0;
<a name="l00088"></a>00088 }                               <span class="comment">/* FSAL_handlecmp */</span>
<a name="l00089"></a>00089 
<a name="l00104"></a><a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#af3401909b6413703150ce681f4928406">00104</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="FSAL__PROXY_2fsal__internal_8h.html#a304bdb671a5889f0ad0bdd8c68875f56">PROXYFSAL_Handle_to_HashIndex</a>(<a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *handle,
<a name="l00105"></a>00105                                            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cookie,
<a name="l00106"></a>00106                                            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> alphabet_len,
<a name="l00107"></a>00107                                            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index_size)
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cpt = 0;
<a name="l00110"></a>00110   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sum = 0;
<a name="l00111"></a>00111   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> extract = 0;
<a name="l00112"></a>00112   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mod;
<a name="l00113"></a>00113   <a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> * p_handle = (<a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> *)handle;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115   <span class="comment">/* XXX If the handle is not 32 bits-aligned, the last loop will get uninitialized</span>
<a name="l00116"></a>00116 <span class="comment">   * chars after the end of the handle. We must avoid this by skipping the last loop</span>
<a name="l00117"></a>00117 <span class="comment">   * and doing a special processing for the last bytes */</span>
<a name="l00118"></a>00118 
<a name="l00119"></a>00119   mod = p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a> % <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int);
<a name="l00120"></a>00120 
<a name="l00121"></a>00121   sum = cookie;
<a name="l00122"></a>00122   <span class="keywordflow">for</span>(cpt = 0; cpt &lt; p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a> - mod; cpt += <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int))
<a name="l00123"></a>00123     {
<a name="l00124"></a>00124       memcpy(&amp;extract, &amp;(p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#aebfab86fe06759fac32509a2bc2f39e8">srv_handle_val</a>[cpt]), <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l00125"></a>00125       sum = (3 * sum + 5 * extract + 1999) % index_size;
<a name="l00126"></a>00126     }
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   <span class="keywordflow">if</span>(mod)
<a name="l00129"></a>00129     {
<a name="l00130"></a>00130       extract = 0;
<a name="l00131"></a>00131       <span class="keywordflow">for</span>(cpt = p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a> - mod; cpt &lt; p_handle-&gt;data.srv_handle_len; cpt++)
<a name="l00132"></a>00132         {
<a name="l00133"></a>00133           <span class="comment">/* shift of 1 byte */</span>
<a name="l00134"></a>00134           extract &lt;&lt;= 8;
<a name="l00135"></a>00135           extract |= (<span class="keywordtype">unsigned</span> int)p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#aebfab86fe06759fac32509a2bc2f39e8">srv_handle_val</a>[cpt];
<a name="l00136"></a>00136         }
<a name="l00137"></a>00137       sum = (3 * sum + 5 * extract + 1999) % index_size;
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140   <span class="keywordflow">return</span> sum;
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="comment">/*</span>
<a name="l00144"></a>00144 <span class="comment"> * FSAL_Handle_to_RBTIndex</span>
<a name="l00145"></a>00145 <span class="comment"> * This function is used for generating a RBT node ID</span>
<a name="l00146"></a>00146 <span class="comment"> * in order to identify entries into the RBT.</span>
<a name="l00147"></a>00147 <span class="comment"> *</span>
<a name="l00148"></a>00148 <span class="comment"> * \param p_handle      The handle to be hashed</span>
<a name="l00149"></a>00149 <span class="comment"> * \param cookie        Makes it possible to have different hash value for the</span>
<a name="l00150"></a>00150 <span class="comment"> *                      same handle, when cookie changes.</span>
<a name="l00151"></a>00151 <span class="comment"> *</span>
<a name="l00152"></a>00152 <span class="comment"> * \return The hash value</span>
<a name="l00153"></a>00153 <span class="comment"> */</span>
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a12bfee034d32d043d9f6c59f124db453">00155</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="FSAL__PROXY_2fsal__internal_8h.html#a92a0b97fb2136a7bc25703934238c623">PROXYFSAL_Handle_to_RBTIndex</a>(<a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *handle,
<a name="l00156"></a>00156                                           <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cookie)
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h = 0;
<a name="l00159"></a>00159   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cpt = 0;
<a name="l00160"></a>00160   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> extract = 0;
<a name="l00161"></a>00161   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mod;
<a name="l00162"></a>00162   <a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> * p_handle = (<a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> *)handle;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164   h = cookie;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166   <span class="comment">/* XXX If the handle is not 32 bits-aligned, the last loop will get uninitialized</span>
<a name="l00167"></a>00167 <span class="comment">   * chars after the end of the handle. We must avoid this by skipping the last loop</span>
<a name="l00168"></a>00168 <span class="comment">   * and doing a special processing for the last bytes */</span>
<a name="l00169"></a>00169 
<a name="l00170"></a>00170   mod = p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a> % <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int);
<a name="l00171"></a>00171 
<a name="l00172"></a>00172   <span class="keywordflow">for</span>(cpt = 0; cpt &lt; p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a> - mod; cpt += <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int))
<a name="l00173"></a>00173     {
<a name="l00174"></a>00174       memcpy(&amp;extract, &amp;(p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#aebfab86fe06759fac32509a2bc2f39e8">srv_handle_val</a>[cpt]), <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l00175"></a>00175       h = (857 * h ^ extract) % 715827883;
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   <span class="keywordflow">if</span>(mod)
<a name="l00179"></a>00179     {
<a name="l00180"></a>00180       extract = 0;
<a name="l00181"></a>00181       <span class="keywordflow">for</span>(cpt = p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a> - mod; cpt &lt; p_handle-&gt;data.srv_handle_len; cpt++)
<a name="l00182"></a>00182         {
<a name="l00183"></a>00183           <span class="comment">/* shift of 1 byte */</span>
<a name="l00184"></a>00184           extract &lt;&lt;= 8;
<a name="l00185"></a>00185           extract |= (<span class="keywordtype">unsigned</span> int)p_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#aebfab86fe06759fac32509a2bc2f39e8">srv_handle_val</a>[cpt];
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187       h = (857 * h ^ extract) % 715827883;
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190   <span class="keywordflow">return</span> h;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="keyword">static</span> ssize_t proxy_sizeof_handle(<span class="keyword">const</span> <a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> *pxh)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195   <span class="keywordflow">if</span>(pxh-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a> &gt; <span class="keyword">sizeof</span>(pxh-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#aebfab86fe06759fac32509a2bc2f39e8">srv_handle_val</a>))
<a name="l00196"></a>00196     <span class="keywordflow">return</span> -1;
<a name="l00197"></a>00197   <span class="keywordflow">return</span> offsetof(<a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a>, data.<a class="code" href="unionproxyfsal__handle__t.html#aebfab86fe06759fac32509a2bc2f39e8">srv_handle_val</a>) + 
<a name="l00198"></a>00198          pxh-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a1f78a7827106a9bec1bdbb87802ffff2">srv_handle_len</a>;
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00217"></a><a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a3e9f794e96071dc177a2ff2584236bc5">00217</a> <a class="code" href="structfsal__status____.html">fsal_status_t</a> <a class="code" href="FSAL__PROXY_2fsal__internal_8h.html#a8c728f3cfff7eecaa513623e52dd8057">PROXYFSAL_DigestHandle</a>(<a class="code" href="structfsal__export__context____.html">fsal_export_context_t</a> * exp_context, <span class="comment">/* IN */</span>
<a name="l00218"></a>00218                                      <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547f">fsal_digesttype_t</a> output_type,     <span class="comment">/* IN */</span>
<a name="l00219"></a>00219                                      <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> * in_handle,       <span class="comment">/* IN */</span>
<a name="l00220"></a>00220                                      <span class="keyword">struct</span> <a class="code" href="structfsal__handle__desc.html">fsal_handle_desc</a> * fh_desc)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222 <span class="preprocessor">#ifdef _HANDLE_MAPPING</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>  <a class="code" href="structnfs23__map__handle____.html">nfs23_map_handle_t</a> map_hdl;
<a name="l00224"></a>00224 <span class="preprocessor">#endif</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>  <a class="code" href="structproxyfsal__export__context__t.html">proxyfsal_export_context_t</a> * p_expcontext = (<a class="code" href="structproxyfsal__export__context__t.html">proxyfsal_export_context_t</a> *)exp_context;
<a name="l00226"></a>00226   <a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> * in_fsal_handle = (<a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> *)in_handle;
<a name="l00227"></a>00227   ssize_t sz;
<a name="l00228"></a>00228   <span class="keyword">const</span> <span class="keywordtype">void</span> *data;
<a name="l00229"></a>00229   <a class="code" href="extended__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> fid2;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231   <span class="comment">/* sanity checks */</span>
<a name="l00232"></a>00232   <span class="keywordflow">if</span>(!in_handle || !fh_desc || !fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#abd5b9bc086e7fdd84b0411bbbd8f266a">start</a> || !p_expcontext)
<a name="l00233"></a>00233     <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2af61ca69bcf4e68b1f488322eabd59ba7">ERR_FSAL_FAULT</a>, 0);
<a name="l00234"></a>00234 
<a name="l00235"></a>00235   <span class="keywordflow">switch</span> (output_type)
<a name="l00236"></a>00236     {
<a name="l00237"></a>00237     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fa2f4c4de7fef77a02ff65ae6d1701096a">FSAL_DIGEST_NFSV2</a>:
<a name="l00238"></a>00238     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fa0e31d9da84e68e93a63194ac77dde857">FSAL_DIGEST_NFSV3</a>:
<a name="l00239"></a>00239       <span class="keywordflow">if</span>(!global_fsal_proxy_specific_info.<a class="code" href="structproxyfs__specific__initinfo__t.html#ae1418b336d3f89dc7c1b8b62861315f0">enable_handle_mapping</a>)
<a name="l00240"></a>00240         <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a31b0b0524df3c96313a66f4a358b0cb8">ERR_FSAL_NOTSUPP</a>, 0);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="preprocessor">#ifdef _HANDLE_MAPPING</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a> &lt; <span class="keyword">sizeof</span>(map_hdl))
<a name="l00244"></a>00244         <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a7c8bdedaecff33995a0aee3c76df9fd0">ERR_FSAL_TOOSMALL</a>, 0);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246       <span class="comment">/* returns a digest and register it to handle map</span>
<a name="l00247"></a>00247 <span class="comment">       * (use the same checksum as cache inode&#39;s RBT index)</span>
<a name="l00248"></a>00248 <span class="comment">       */</span>
<a name="l00249"></a>00249       map_hdl.<a class="code" href="structnfs23__map__handle____.html#a6401f5a87b9d2247959d721e6d10c209">object_id</a> = in_fsal_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a6fc2dd44230cf2bb7f40991aab0befc2">fileid4</a>;
<a name="l00250"></a>00250       map_hdl.<a class="code" href="structnfs23__map__handle____.html#a27c75ffcf0a61fea93b8352c7cf3eaf9">handle_hash</a> = <a class="code" href="fsal__glue_8c.html#a0afe476befc56121cceeb82a69e458c5">FSAL_Handle_to_RBTIndex</a>(in_fsal_handle, 0);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252       <a class="code" href="handle__mapping_8c.html#a95eb499e52953a62e2218c2105ae76d1">HandleMap_SetFH</a>(&amp;map_hdl, in_fsal_handle);
<a name="l00253"></a>00253 
<a name="l00254"></a>00254       <span class="comment">/* Do no set length - use as much of opaque handle as allowed,</span>
<a name="l00255"></a>00255 <span class="comment">       * it could help when converting handles back in ExpandHandle */</span>
<a name="l00256"></a>00256       memset(fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#abd5b9bc086e7fdd84b0411bbbd8f266a">start</a>, 0, fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a>);
<a name="l00257"></a>00257       memcpy(fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#abd5b9bc086e7fdd84b0411bbbd8f266a">start</a>, &amp;map_hdl, <span class="keyword">sizeof</span>(map_hdl));
<a name="l00258"></a>00258       <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a2ab4fbc56e98d01fc4f166d513f92df1">ERR_FSAL_NO_ERROR</a>, 0);
<a name="l00259"></a>00259 <span class="preprocessor">#endif</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span>    <span class="comment">/* fallthru */</span>
<a name="l00261"></a>00261     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fafda832e40b2b8bb5b5a1f1a0e56b9d9e">FSAL_DIGEST_NFSV4</a>:
<a name="l00262"></a>00262       sz = proxy_sizeof_handle(in_fsal_handle);
<a name="l00263"></a>00263       data = in_fsal_handle;
<a name="l00264"></a>00264       <span class="keywordflow">break</span>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fa4f39e103f1d1e66786e47a0b4d00e584">FSAL_DIGEST_FILEID2</a>:
<a name="l00267"></a>00267       fid2 = in_fsal_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a6fc2dd44230cf2bb7f40991aab0befc2">fileid4</a>;
<a name="l00268"></a>00268       <span class="keywordflow">if</span>(fid2 != in_fsal_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a6fc2dd44230cf2bb7f40991aab0befc2">fileid4</a>)
<a name="l00269"></a>00269         <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a5936c8df3b6e695177b485f84eb6463b">ERR_FSAL_OVERFLOW</a>, 0);
<a name="l00270"></a>00270       data = &amp;fid2;
<a name="l00271"></a>00271       sz = <span class="keyword">sizeof</span>(fid2);
<a name="l00272"></a>00272       <span class="keywordflow">break</span>;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fafdc65a8250795f8cc7bd8492fe740bca">FSAL_DIGEST_FILEID3</a>:
<a name="l00275"></a>00275     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fa0a9ad9370461f07724546c9b4ef87f04">FSAL_DIGEST_FILEID4</a>:
<a name="l00276"></a>00276       sz = <span class="keyword">sizeof</span>(in_fsal_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a6fc2dd44230cf2bb7f40991aab0befc2">fileid4</a>);
<a name="l00277"></a>00277       data = &amp;(in_fsal_handle-&gt;<a class="code" href="unionproxyfsal__handle__t.html#a3dfe215624332230912566fab6ab0da6">data</a>.<a class="code" href="unionproxyfsal__handle__t.html#a6fc2dd44230cf2bb7f40991aab0befc2">fileid4</a>);
<a name="l00278"></a>00278       <span class="keywordflow">break</span>;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="keywordflow">default</span>:
<a name="l00281"></a>00281       <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8f54f11bfb7d1ba0aaa65addd01294c0">ERR_FSAL_SERVERFAULT</a>, 0);
<a name="l00282"></a>00282     }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   <span class="keywordflow">if</span>(fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a> &lt;  sz)
<a name="l00285"></a>00285     {
<a name="l00286"></a>00286       <a class="code" href="log_8h.html#aa7aee8ec65b5baafb430f8d2a7588d53">LogDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;Cannot fit %zd bytes into %zd&quot;</span>,
<a name="l00287"></a>00287                sz, fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a>);
<a name="l00288"></a>00288       <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a7c8bdedaecff33995a0aee3c76df9fd0">ERR_FSAL_TOOSMALL</a>, 0);
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291   fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a> = sz;
<a name="l00292"></a>00292   memcpy(fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#abd5b9bc086e7fdd84b0411bbbd8f266a">start</a>, data, sz);
<a name="l00293"></a>00293   <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a2ab4fbc56e98d01fc4f166d513f92df1">ERR_FSAL_NO_ERROR</a>, 0);
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 }                               <span class="comment">/* FSAL_DigestHandle */</span>
<a name="l00296"></a>00296 
<a name="l00310"></a><a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a277101580e6db7a796ece60f96318451">00310</a> <a class="code" href="structfsal__status____.html">fsal_status_t</a> <a class="code" href="FSAL__PROXY_2fsal__internal_8h.html#a2e19b01ff7906b1a435900e413f5329f">PROXYFSAL_ExpandHandle</a>(<a class="code" href="structfsal__export__context____.html">fsal_export_context_t</a> * p_expcontext, <span class="comment">/* IN */</span>
<a name="l00311"></a>00311                                      <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547f">fsal_digesttype_t</a> in_type, <span class="comment">/* IN */</span>
<a name="l00312"></a>00312                                      <span class="keyword">struct</span> <a class="code" href="structfsal__handle__desc.html">fsal_handle_desc</a> *fh_desc)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314 <span class="preprocessor">#ifdef _HANDLE_MAPPING</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span>  <a class="code" href="structnfs23__map__handle____.html">nfs23_map_handle_t</a> *map_hdl;
<a name="l00316"></a>00316   <a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> tmp_hdl;
<a name="l00317"></a>00317   <span class="keywordtype">int</span> rc;
<a name="l00318"></a>00318 <span class="preprocessor">#endif</span>
<a name="l00319"></a>00319 <span class="preprocessor"></span>  ssize_t sz;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321   <span class="comment">/* sanity checks */</span>
<a name="l00322"></a>00322   <span class="keywordflow">if</span>(!fh_desc || !fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#abd5b9bc086e7fdd84b0411bbbd8f266a">start</a>)
<a name="l00323"></a>00323     <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2af61ca69bcf4e68b1f488322eabd59ba7">ERR_FSAL_FAULT</a>, 0);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325   <span class="keywordflow">switch</span> (in_type)
<a name="l00326"></a>00326     {
<a name="l00327"></a>00327     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fa2f4c4de7fef77a02ff65ae6d1701096a">FSAL_DIGEST_NFSV2</a>:
<a name="l00328"></a>00328     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fa0e31d9da84e68e93a63194ac77dde857">FSAL_DIGEST_NFSV3</a>:
<a name="l00329"></a>00329       <span class="keywordflow">if</span>(!global_fsal_proxy_specific_info.<a class="code" href="structproxyfs__specific__initinfo__t.html#ae1418b336d3f89dc7c1b8b62861315f0">enable_handle_mapping</a>)
<a name="l00330"></a>00330         <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a31b0b0524df3c96313a66f4a358b0cb8">ERR_FSAL_NOTSUPP</a>, 0);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 <span class="preprocessor">#ifdef _HANDLE_MAPPING</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a> &lt; <span class="keyword">sizeof</span>(*map_hdl))
<a name="l00334"></a>00334         <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a7c8bdedaecff33995a0aee3c76df9fd0">ERR_FSAL_TOOSMALL</a>, 0);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336       map_hdl = (<a class="code" href="structnfs23__map__handle____.html">nfs23_map_handle_t</a> *)fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#abd5b9bc086e7fdd84b0411bbbd8f266a">start</a>;
<a name="l00337"></a>00337       rc = <a class="code" href="handle__mapping_8c.html#a17c70a0823ea78f0d10f82c41201e272">HandleMap_GetFH</a>(map_hdl, &amp;tmp_hdl);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339       <span class="keywordflow">if</span>(<a class="code" href="log_8h.html#ad2b900e4d4ae3a366d0690930c8a68aa">isFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>))
<a name="l00340"></a>00340         {
<a name="l00341"></a>00341           <span class="keywordflow">if</span>(rc == <a class="code" href="handle__mapping_8h.html#a69e30a91d7ab5c36705556c5182e4258">HANDLEMAP_STALE</a>)
<a name="l00342"></a>00342             <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;File id=%llu : HandleMap_GetFH returns HANDLEMAP_STALE\n&quot;</span>,
<a name="l00343"></a>00343                          (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)map_hdl-&gt;<a class="code" href="structnfs23__map__handle____.html#a6401f5a87b9d2247959d721e6d10c209">object_id</a>);
<a name="l00344"></a>00344           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rc == 0)
<a name="l00345"></a>00345             <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;File id=%llu : HandleMap_GetFH returns HANDLEMAP_SUCCESS\n&quot;</span>,
<a name="l00346"></a>00346                          (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)map_hdl-&gt;<a class="code" href="structnfs23__map__handle____.html#a6401f5a87b9d2247959d721e6d10c209">object_id</a>);
<a name="l00347"></a>00347           <span class="keywordflow">else</span>
<a name="l00348"></a>00348             <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;File id=%llu : HandleMap_GetFH returns error %d\n&quot;</span>,
<a name="l00349"></a>00349                          (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)map_hdl-&gt;<a class="code" href="structnfs23__map__handle____.html#a6401f5a87b9d2247959d721e6d10c209">object_id</a>, rc);
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352       <span class="keywordflow">if</span>(rc == <a class="code" href="handle__mapping_8h.html#a69e30a91d7ab5c36705556c5182e4258">HANDLEMAP_STALE</a>)
<a name="l00353"></a>00353         <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a9be280ce3e4b71c39f5c1eb55aefc581">ERR_FSAL_STALE</a>, rc);
<a name="l00354"></a>00354       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rc != 0)
<a name="l00355"></a>00355         <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8f54f11bfb7d1ba0aaa65addd01294c0">ERR_FSAL_SERVERFAULT</a>, rc);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357       sz = proxy_sizeof_handle(&amp;tmp_hdl);
<a name="l00358"></a>00358       <span class="keywordflow">if</span>(fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a> &lt; sz)
<a name="l00359"></a>00359         <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a7c8bdedaecff33995a0aee3c76df9fd0">ERR_FSAL_TOOSMALL</a>, 0);
<a name="l00360"></a>00360       memcpy(fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#abd5b9bc086e7fdd84b0411bbbd8f266a">start</a>, &amp;tmp_hdl, sz);
<a name="l00361"></a>00361       <span class="keywordflow">break</span>;
<a name="l00362"></a>00362 <span class="preprocessor">#endif</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span>    <span class="comment">/* fallthru */</span>
<a name="l00364"></a>00364     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fafda832e40b2b8bb5b5a1f1a0e56b9d9e">FSAL_DIGEST_NFSV4</a>:
<a name="l00365"></a>00365       sz = proxy_sizeof_handle((<a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> *)fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#abd5b9bc086e7fdd84b0411bbbd8f266a">start</a>);
<a name="l00366"></a>00366       <span class="keywordflow">if</span>(sz &lt; 0)
<a name="l00367"></a>00367         <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a447e0f2dc1a679c58936bc9a57b6f3ce">ERR_FSAL_BADHANDLE</a>, 0);
<a name="l00368"></a>00368       <span class="keywordflow">if</span>(fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a> != sz)
<a name="l00369"></a>00369         {
<a name="l00370"></a>00370           <a class="code" href="log_8h.html#a3cf3c22fac6bb9871e25007551caeb13">LogMajor</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>,
<a name="l00371"></a>00371                    <span class="stringliteral">&quot;size mismatch for handle.  should be %zd, got %zd&quot;</span>,
<a name="l00372"></a>00372                    sz, fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a>);
<a name="l00373"></a>00373           <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a447e0f2dc1a679c58936bc9a57b6f3ce">ERR_FSAL_BADHANDLE</a>, 0);
<a name="l00374"></a>00374         }
<a name="l00375"></a>00375       <span class="keywordflow">break</span>;
<a name="l00376"></a>00376     <span class="keywordflow">case</span> <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fae1fce2f8aa3be8b81f6006c28515b566">FSAL_DIGEST_SIZEOF</a>:
<a name="l00377"></a>00377       sz = proxy_sizeof_handle((<a class="code" href="unionproxyfsal__handle__t.html">proxyfsal_handle_t</a> *)fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#abd5b9bc086e7fdd84b0411bbbd8f266a">start</a>);
<a name="l00378"></a>00378       <span class="keywordflow">break</span>;
<a name="l00379"></a>00379     <span class="keywordflow">default</span>: <span class="comment">/* Catch FILEID2, FILEID3, FILEID4 */</span>
<a name="l00380"></a>00380       <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8f54f11bfb7d1ba0aaa65addd01294c0">ERR_FSAL_SERVERFAULT</a>, 0);
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382   fh_desc-&gt;<a class="code" href="structfsal__handle__desc.html#ac26d3f3266e78ecaffc1e39e937923f8">len</a> = sz;  <span class="comment">/* pass back the actual size */</span>
<a name="l00383"></a>00383   <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a2ab4fbc56e98d01fc4f166d513f92df1">ERR_FSAL_NO_ERROR</a>, 0);
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00394"></a><a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a42948fd555151e80a025a35de41da485">00394</a> <a class="code" href="structfsal__status____.html">fsal_status_t</a> <a class="code" href="FSAL__PROXY_2fsal__internal_8h.html#a42948fd555151e80a025a35de41da485">PROXYFSAL_SetDefault_FS_specific_parameter</a>(<a class="code" href="structfsal__parameter____.html">fsal_parameter_t</a> * out_parameter)
<a name="l00395"></a>00395 {
<a name="l00396"></a>00396   <a class="code" href="structproxyfs__specific__initinfo__t.html">proxyfs_specific_initinfo_t</a> *init_info;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398   <span class="comment">/* defensive programming... */</span>
<a name="l00399"></a>00399   <span class="keywordflow">if</span>(out_parameter == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00400"></a>00400     <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2af61ca69bcf4e68b1f488322eabd59ba7">ERR_FSAL_FAULT</a>, 0);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402   <span class="comment">/* &gt;&gt; set your default FS configuration into the</span>
<a name="l00403"></a>00403 <span class="comment">     out_parameter-&gt;fs_specific_info structure &lt;&lt; */</span>
<a name="l00404"></a>00404 
<a name="l00405"></a>00405   init_info = (<a class="code" href="structproxyfs__specific__initinfo__t.html">proxyfs_specific_initinfo_t</a> *) &amp;(out_parameter-&gt;<a class="code" href="structfsal__parameter____.html#aa1853a1cd56fd71035a73fb2db42161d">fs_specific_info</a>);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a96c6a6796de849db39537b27d40a6383">retry_sleeptime</a> = <a class="code" href="FSAL_2FSAL__PROXY_2fsal__types_8h.html#a95f5a8fa56923ef2f6cdd41d946decbd">FSAL_PROXY_RETRY_SLEEPTIME</a>; <span class="comment">/* Time to sleep when retrying */</span>
<a name="l00408"></a>00408   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#aa09ac46d57f188d986021d0d9dbccaa3">srv_addr</a> = htonl(0x7F000001); <span class="comment">/* 127.0.0.1 aka localhost     */</span>
<a name="l00409"></a>00409   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a339a462f99be7f9af81d467771a3ef43">srv_prognum</a> = 100003; <span class="comment">/* Default NFS prognum         */</span>
<a name="l00410"></a>00410   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a0593e45debff45e2bd357d5a655adc3a">srv_port</a> = htons(2049);       <span class="comment">/* Default NFS port            */</span>
<a name="l00411"></a>00411   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ac0c822c3b068e9125e9e5390af56863d">srv_timeout</a> = 2;     <span class="comment">/* RPC Client timeout          */</span>
<a name="l00412"></a>00412   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a920f13d1ebcd07df221296ec499678d2">srv_sendsize</a> = <a class="code" href="FSAL_2FSAL__PROXY_2fsal__types_8h.html#a342626b13f72c11a836a9772b6950601">FSAL_PROXY_SEND_BUFFER_SIZE</a>;   <span class="comment">/* Default Buffer Send Size    */</span>
<a name="l00413"></a>00413   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a93f5679d62c5839c324f72f91a60bdf2">srv_recvsize</a> = <a class="code" href="FSAL_2FSAL__PROXY_2fsal__types_8h.html#ae1c966d9a5e32145175e6980650fb6b6">FSAL_PROXY_RECV_BUFFER_SIZE</a>;   <span class="comment">/* Default Buffer Send Size    */</span>
<a name="l00414"></a>00414   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a8b0f61a7affd1c31794585e21b378bd3">use_privileged_client_port</a> = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;   <span class="comment">/* No privileged port by default */</span>
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a854b2f02f4579c1c5d8a99add94c82da">active_krb5</a> = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;  <span class="comment">/* No RPCSEC_GSS by default */</span>
<a name="l00417"></a>00417   strncpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ac0b06e73789871eb873f598932630c89">local_principal</a>, <span class="stringliteral">&quot;(no principal set)&quot;</span>, MAXNAMLEN);    <span class="comment">/* Principal is nfs@&lt;host&gt;  */</span>
<a name="l00418"></a>00418   strncpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a2e3f165f4348b2385c179f78281d8289">remote_principal</a>, <span class="stringliteral">&quot;(no principal set)&quot;</span>, MAXNAMLEN);   <span class="comment">/* Principal is nfs@&lt;host&gt;  */</span>
<a name="l00419"></a>00419   strncpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ab9f7e49925049ad35d6c8af7d2008846">keytab</a>, <span class="stringliteral">&quot;etc/krb5.keytab&quot;</span>, <a class="code" href="tests_8h.html#addfa831c1473e710d2b71b72fd7fcfa5">MAXPATHLEN</a>);       <span class="comment">/* Path to krb5 keytab file */</span>
<a name="l00420"></a>00420   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a657421f6877353a9d662f3877f522469">cred_lifetime</a> = 86400;        <span class="comment">/* 24h is a good default    */</span>
<a name="l00421"></a>00421   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a552a38f0462fc25f05d19b4fc15c643e">sec_type</a> = 0;
<a name="l00422"></a>00422 
<a name="l00423"></a>00423   strcpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a739fb9041e715aa759c0504201eac13e">srv_proto</a>, <span class="stringliteral">&quot;tcp&quot;</span>);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 <span class="preprocessor">#ifdef _HANDLE_MAPPING</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span>  init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ae1418b336d3f89dc7c1b8b62861315f0">enable_handle_mapping</a> = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00427"></a>00427   strcpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a5042e1630086a64b2c7632bfcb75c974">hdlmap_dbdir</a>, <span class="stringliteral">&quot;/var/ganesha/handlemap&quot;</span>);
<a name="l00428"></a>00428   strcpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a8c0de1ba178708947ac66d92a4705113">hdlmap_tmpdir</a>, <span class="stringliteral">&quot;/var/ganesha/tmp&quot;</span>);
<a name="l00429"></a>00429   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ad05edc7879d7583bab559a87f7a2a0a6">hdlmap_dbcount</a> = 8;
<a name="l00430"></a>00430   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a2a34a02c4e5f451ea4cffa9827a4bd89">hdlmap_hashsize</a> = 103;
<a name="l00431"></a>00431   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#abe7f718f5ce4885ef6e39b105173ecdf">hdlmap_nb_entry_prealloc</a> = 16384;
<a name="l00432"></a>00432   init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a4ead988e8c0ad7cedc0918436083308e">hdlmap_nb_db_op_prealloc</a> = 1024;
<a name="l00433"></a>00433 <span class="preprocessor">#endif</span>
<a name="l00434"></a>00434 <span class="preprocessor"></span>
<a name="l00435"></a>00435   <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a2ab4fbc56e98d01fc4f166d513f92df1">ERR_FSAL_NO_ERROR</a>, 0);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 
<a name="l00460"></a>00460 <span class="comment">/* load specific filesystem configuration options */</span>
<a name="l00461"></a>00461 
<a name="l00462"></a><a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#adf379b5d1a9b57663b7abffcec05b2a8">00462</a> <a class="code" href="structfsal__status____.html">fsal_status_t</a> <a class="code" href="FSAL__PROXY_2fsal__internal_8h.html#adf379b5d1a9b57663b7abffcec05b2a8">PROXYFSAL_load_FS_specific_parameter_from_conf</a>(<a class="code" href="config__parsing_8h.html#adfea46b92009fb7b8d52287bd2aa1900">config_file_t</a> in_config,
<a name="l00463"></a>00463                                                              <a class="code" href="structfsal__parameter____.html">fsal_parameter_t</a> *
<a name="l00464"></a>00464                                                              out_parameter)
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466   <span class="keywordtype">int</span> err;
<a name="l00467"></a>00467   <span class="keywordtype">int</span> var_max, var_index;
<a name="l00468"></a>00468   <span class="keywordtype">char</span> *<a class="code" href="test__findlog_8c.html#a79d219c9ec9c570e3060579f4007f0bd">key_name</a>;
<a name="l00469"></a>00469   <span class="keywordtype">char</span> *key_value;
<a name="l00470"></a>00470   <span class="keyword">struct </span>hostent *hp = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00471"></a>00471   <a class="code" href="config__parsing_8h.html#a3813af0c64c81660602658700f604d16">config_item_t</a> block;
<a name="l00472"></a>00472   <a class="code" href="structproxyfs__specific__initinfo__t.html">proxyfs_specific_initinfo_t</a> *init_info;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="comment">/* defensive programming... */</span>
<a name="l00475"></a>00475   <span class="keywordflow">if</span>(out_parameter == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00476"></a>00476     <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2af61ca69bcf4e68b1f488322eabd59ba7">ERR_FSAL_FAULT</a>, 0);
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   <span class="comment">/* &gt;&gt; set your default FS configuration into the</span>
<a name="l00479"></a>00479 <span class="comment">     out_parameter-&gt;fs_specific_info structure &lt;&lt; */</span>
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   init_info = (<a class="code" href="structproxyfs__specific__initinfo__t.html">proxyfs_specific_initinfo_t</a> *) &amp;(out_parameter-&gt;<a class="code" href="structfsal__parameter____.html#aa1853a1cd56fd71035a73fb2db42161d">fs_specific_info</a>);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483   block = <a class="code" href="config__parsing_8c.html#a124c884106272c278b7380b2ea98248d">config_FindItemByName</a>(in_config, <a class="code" href="FSAL_2FSAL__CEPH_2fsal__types_8h.html#a1f148cbea3c80e8164aa6799013734fc">CONF_LABEL_FS_SPECIFIC</a>);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485   <span class="comment">/* cannot read item */</span>
<a name="l00486"></a>00486   <span class="keywordflow">if</span>(block == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00487"></a>00487     {
<a name="l00488"></a>00488       <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a56ee474beccbe057441cc2d70a26ad15">COMPONENT_CONFIG</a>, <span class="stringliteral">&quot;FSAL LOAD PARAMETER: Cannot read item \&quot;%s\&quot; from configuration file&quot;</span>,
<a name="l00489"></a>00489               <a class="code" href="FSAL_2FSAL__CEPH_2fsal__types_8h.html#a1f148cbea3c80e8164aa6799013734fc">CONF_LABEL_FS_SPECIFIC</a>);
<a name="l00490"></a>00490       <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2afad14ef4f3e93a70727fe0436f935e96">ERR_FSAL_NOENT</a>, 0);
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="config__parsing_8c.html#a447e838f4a3252ddabd4dc0be3bb6cdb">config_ItemType</a>(block) != <a class="code" href="config__parsing_8h.html#a527de5d1ae029146e3f1b826b802ae9ca43470a36ad972f791fbb8697d02b03ce">CONFIG_ITEM_BLOCK</a>)
<a name="l00493"></a>00493     {
<a name="l00494"></a>00494       <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a56ee474beccbe057441cc2d70a26ad15">COMPONENT_CONFIG</a>, <span class="stringliteral">&quot;FSAL LOAD PARAMETER: Item \&quot;%s\&quot; is expected to be a block&quot;</span>,
<a name="l00495"></a>00495               <a class="code" href="FSAL_2FSAL__CEPH_2fsal__types_8h.html#a1f148cbea3c80e8164aa6799013734fc">CONF_LABEL_FS_SPECIFIC</a>);
<a name="l00496"></a>00496       <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8e03e63b74eb0767518d858d71fc68a3">ERR_FSAL_INVAL</a>, 0);
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499   <span class="comment">/* makes an iteration on the (key, value) couplets */</span>
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   var_max = <a class="code" href="config__parsing_8c.html#a098e7a2614baf20bb96f612c3d7b8d69">config_GetNbItems</a>(block);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503   <span class="keywordflow">for</span>(var_index = 0; var_index &lt; var_max; var_index++)
<a name="l00504"></a>00504     {
<a name="l00505"></a>00505       <a class="code" href="config__parsing_8h.html#a3813af0c64c81660602658700f604d16">config_item_t</a> item;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507       item = <a class="code" href="config__parsing_8c.html#aa6232f17aec5d583443924e79b536002">config_GetItemByIndex</a>(block, var_index);
<a name="l00508"></a>00508 
<a name="l00509"></a>00509       err = <a class="code" href="config__parsing_8c.html#aff2105a8be08ca4687d93ae8f1db2fde">config_GetKeyValue</a>(item, &amp;key_name, &amp;key_value);
<a name="l00510"></a>00510       <span class="keywordflow">if</span>(err)
<a name="l00511"></a>00511         {
<a name="l00512"></a>00512           <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a56ee474beccbe057441cc2d70a26ad15">COMPONENT_CONFIG</a>,
<a name="l00513"></a>00513                   <span class="stringliteral">&quot;FSAL LOAD PARAMETER: ERROR reading key[%d] from section \&quot;%s\&quot; of configuration file.&quot;</span>,
<a name="l00514"></a>00514                   var_index, <a class="code" href="FSAL_2FSAL__CEPH_2fsal__types_8h.html#a1f148cbea3c80e8164aa6799013734fc">CONF_LABEL_FS_SPECIFIC</a>);
<a name="l00515"></a>00515           <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8f54f11bfb7d1ba0aaa65addd01294c0">ERR_FSAL_SERVERFAULT</a>, err);
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518       <span class="comment">/* what parameter is it ? */</span>
<a name="l00519"></a>00519 
<a name="l00520"></a>00520       <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;Srv_Addr&quot;</span>))
<a name="l00521"></a>00521         {
<a name="l00522"></a>00522           <span class="keywordflow">if</span>(isdigit(key_value[0]))
<a name="l00523"></a>00523             {
<a name="l00524"></a>00524               <span class="comment">/* Address begin with a digit, it is a address in the dotted form, translate it */</span>
<a name="l00525"></a>00525               init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#aa09ac46d57f188d986021d0d9dbccaa3">srv_addr</a> = inet_addr(key_value);
<a name="l00526"></a>00526             }
<a name="l00527"></a>00527           <span class="keywordflow">else</span>
<a name="l00528"></a>00528             {
<a name="l00529"></a>00529               <span class="comment">/* This is a serveur name that is to be resolved. Use gethostbyname */</span>
<a name="l00530"></a>00530               <span class="keywordflow">if</span>((hp = gethostbyname(key_value)) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00531"></a>00531                 {
<a name="l00532"></a>00532                   <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a56ee474beccbe057441cc2d70a26ad15">COMPONENT_CONFIG</a>, <span class="stringliteral">&quot;FSAL LOAD PARAMETER: ERROR: Unexpected value for %s&quot;</span>,
<a name="l00533"></a>00533                           key_name);
<a name="l00534"></a>00534                   <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8e03e63b74eb0767518d858d71fc68a3">ERR_FSAL_INVAL</a>, 0);
<a name="l00535"></a>00535                 }
<a name="l00536"></a>00536               memcpy(&amp;init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#aa09ac46d57f188d986021d0d9dbccaa3">srv_addr</a>, hp-&gt;h_addr, hp-&gt;h_length);
<a name="l00537"></a>00537             }
<a name="l00538"></a>00538         }
<a name="l00539"></a>00539       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;NFS_Port&quot;</span>))
<a name="l00540"></a>00540         {
<a name="l00541"></a>00541           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a0593e45debff45e2bd357d5a655adc3a">srv_port</a> =
<a name="l00542"></a>00542               htons((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)atoi(key_value));
<a name="l00543"></a>00543         }
<a name="l00544"></a>00544       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;NFS_Service&quot;</span>))
<a name="l00545"></a>00545         {
<a name="l00546"></a>00546           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a339a462f99be7f9af81d467771a3ef43">srv_prognum</a> = (<span class="keywordtype">unsigned</span> int)atoi(key_value);
<a name="l00547"></a>00547         }
<a name="l00548"></a>00548       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;NFS_SendSize&quot;</span>))
<a name="l00549"></a>00549         {
<a name="l00550"></a>00550           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a920f13d1ebcd07df221296ec499678d2">srv_sendsize</a> = (<span class="keywordtype">unsigned</span> int)atoi(key_value);
<a name="l00551"></a>00551         }
<a name="l00552"></a>00552       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;NFS_RecvSize&quot;</span>))
<a name="l00553"></a>00553         {
<a name="l00554"></a>00554           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a93f5679d62c5839c324f72f91a60bdf2">srv_recvsize</a> = (<span class="keywordtype">unsigned</span> int)atoi(key_value);
<a name="l00555"></a>00555         }
<a name="l00556"></a>00556       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;Use_Privileged_Client_Port&quot;</span>))
<a name="l00557"></a>00557         {
<a name="l00558"></a>00558            init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a8b0f61a7affd1c31794585e21b378bd3">use_privileged_client_port</a> = <a class="code" href="common__utils_8c.html#aa7984fc81c44d8d54259443cfc670f32">StrToBoolean</a>( key_value ) ;
<a name="l00559"></a>00559         }
<a name="l00560"></a>00560       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;Retry_SleepTime&quot;</span>))
<a name="l00561"></a>00561         {
<a name="l00562"></a>00562           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a96c6a6796de849db39537b27d40a6383">retry_sleeptime</a> = (<span class="keywordtype">unsigned</span> int)atoi(key_value);
<a name="l00563"></a>00563         }
<a name="l00565"></a>00565       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;NFS_Proto&quot;</span>))
<a name="l00566"></a>00566         {
<a name="l00567"></a>00567           <span class="comment">/* key_value should be either &quot;udp&quot; or &quot;tcp&quot; */</span>
<a name="l00568"></a>00568           <span class="keywordflow">if</span>(strncasecmp(key_value, <span class="stringliteral">&quot;udp&quot;</span>, MAXNAMLEN)
<a name="l00569"></a>00569              &amp;&amp; strncasecmp(key_value, <span class="stringliteral">&quot;tcp&quot;</span>, MAXNAMLEN))
<a name="l00570"></a>00570             {
<a name="l00571"></a>00571               <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a56ee474beccbe057441cc2d70a26ad15">COMPONENT_CONFIG</a>, <span class="stringliteral">&quot;FSAL LOAD PARAMETER: ERROR: Unexpected value for %s --&gt; %s&quot;</span>,
<a name="l00572"></a>00572                       key_name, key_value);
<a name="l00573"></a>00573               <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8e03e63b74eb0767518d858d71fc68a3">ERR_FSAL_INVAL</a>, 0);
<a name="l00574"></a>00574             }
<a name="l00575"></a>00575           strncpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a739fb9041e715aa759c0504201eac13e">srv_proto</a>, key_value, MAXNAMLEN);
<a name="l00576"></a>00576         }
<a name="l00578"></a>00578       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;Active_krb5&quot;</span>))
<a name="l00579"></a>00579         {
<a name="l00580"></a>00580           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a854b2f02f4579c1c5d8a99add94c82da">active_krb5</a> = <a class="code" href="common__utils_8c.html#aa7984fc81c44d8d54259443cfc670f32">StrToBoolean</a>(key_value);
<a name="l00581"></a>00581         }
<a name="l00582"></a>00582       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;Local_PrincipalName&quot;</span>))
<a name="l00583"></a>00583         {
<a name="l00584"></a>00584           strncpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ac0b06e73789871eb873f598932630c89">local_principal</a>, key_value, MAXNAMLEN);
<a name="l00585"></a>00585         }
<a name="l00586"></a>00586       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;Remote_PrincipalName&quot;</span>))
<a name="l00587"></a>00587         {
<a name="l00588"></a>00588           strncpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a2e3f165f4348b2385c179f78281d8289">remote_principal</a>, key_value, MAXNAMLEN);
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;KeytabPath&quot;</span>))
<a name="l00591"></a>00591         {
<a name="l00592"></a>00592           strncpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ab9f7e49925049ad35d6c8af7d2008846">keytab</a>, key_value, <a class="code" href="tests_8h.html#addfa831c1473e710d2b71b72fd7fcfa5">MAXPATHLEN</a>);
<a name="l00593"></a>00593         }
<a name="l00594"></a>00594       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;Credential_LifeTime&quot;</span>))
<a name="l00595"></a>00595         {
<a name="l00596"></a>00596           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a657421f6877353a9d662f3877f522469">cred_lifetime</a> = (<span class="keywordtype">unsigned</span> int)atoi(key_value);
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;Sec_Type&quot;</span>))
<a name="l00599"></a>00599         {
<a name="l00600"></a>00600 <span class="preprocessor">#ifdef _USE_GSSRPC</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span>          <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_value, <span class="stringliteral">&quot;krb5&quot;</span>))
<a name="l00602"></a>00602             init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a552a38f0462fc25f05d19b4fc15c643e">sec_type</a> = RPCSEC_GSS_SVC_NONE;
<a name="l00603"></a>00603           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_value, <span class="stringliteral">&quot;krb5i&quot;</span>))
<a name="l00604"></a>00604             init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a552a38f0462fc25f05d19b4fc15c643e">sec_type</a> = RPCSEC_GSS_SVC_INTEGRITY;
<a name="l00605"></a>00605           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_value, <span class="stringliteral">&quot;krb5p&quot;</span>))
<a name="l00606"></a>00606             init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a552a38f0462fc25f05d19b4fc15c643e">sec_type</a> = RPCSEC_GSS_SVC_PRIVACY;
<a name="l00607"></a>00607           <span class="keywordflow">else</span>
<a name="l00608"></a>00608             {
<a name="l00609"></a>00609               <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a56ee474beccbe057441cc2d70a26ad15">COMPONENT_CONFIG</a>, <span class="stringliteral">&quot;FSAL LOAD PARAMETER: bad value %s for parameter %s&quot;</span>, key_value,
<a name="l00610"></a>00610                       key_name);
<a name="l00611"></a>00611               <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8e03e63b74eb0767518d858d71fc68a3">ERR_FSAL_INVAL</a>, 0);
<a name="l00612"></a>00612             }
<a name="l00613"></a>00613 <span class="preprocessor">#endif</span>
<a name="l00614"></a>00614 <span class="preprocessor"></span>        }
<a name="l00615"></a>00615       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;Enable_Handle_Mapping&quot;</span>))
<a name="l00616"></a>00616         {
<a name="l00617"></a>00617           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ae1418b336d3f89dc7c1b8b62861315f0">enable_handle_mapping</a> = <a class="code" href="common__utils_8c.html#aa7984fc81c44d8d54259443cfc670f32">StrToBoolean</a>(key_value);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619           <span class="keywordflow">if</span>(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ae1418b336d3f89dc7c1b8b62861315f0">enable_handle_mapping</a> == -1)
<a name="l00620"></a>00620             {
<a name="l00621"></a>00621               <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a56ee474beccbe057441cc2d70a26ad15">COMPONENT_CONFIG</a>,
<a name="l00622"></a>00622                       <span class="stringliteral">&quot;FSAL LOAD PARAMETER: ERROR: Unexpected value for %s --&gt; %s (boolean expected)&quot;</span>,
<a name="l00623"></a>00623                       key_name, key_value);
<a name="l00624"></a>00624               <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8e03e63b74eb0767518d858d71fc68a3">ERR_FSAL_INVAL</a>, 0);
<a name="l00625"></a>00625             }
<a name="l00626"></a>00626         }
<a name="l00627"></a>00627       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;HandleMap_DB_Dir&quot;</span>))
<a name="l00628"></a>00628         {
<a name="l00629"></a>00629           strncpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a5042e1630086a64b2c7632bfcb75c974">hdlmap_dbdir</a>, key_value, <a class="code" href="tests_8h.html#addfa831c1473e710d2b71b72fd7fcfa5">MAXPATHLEN</a>);
<a name="l00630"></a>00630         }
<a name="l00631"></a>00631       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;HandleMap_Tmp_Dir&quot;</span>))
<a name="l00632"></a>00632         {
<a name="l00633"></a>00633           strncpy(init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a8c0de1ba178708947ac66d92a4705113">hdlmap_tmpdir</a>, key_value, <a class="code" href="tests_8h.html#addfa831c1473e710d2b71b72fd7fcfa5">MAXPATHLEN</a>);
<a name="l00634"></a>00634         }
<a name="l00635"></a>00635       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;HandleMap_DB_Count&quot;</span>))
<a name="l00636"></a>00636         {
<a name="l00637"></a>00637           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#ad05edc7879d7583bab559a87f7a2a0a6">hdlmap_dbcount</a> = (<span class="keywordtype">unsigned</span> int)atoi(key_value);
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;HandleMap_HashTable_Size&quot;</span>))
<a name="l00640"></a>00640         {
<a name="l00641"></a>00641           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a2a34a02c4e5f451ea4cffa9827a4bd89">hdlmap_hashsize</a> = (<span class="keywordtype">unsigned</span> int)atoi(key_value);
<a name="l00642"></a>00642         }
<a name="l00643"></a>00643       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;HandleMap_Nb_Entries_Prealloc&quot;</span>))
<a name="l00644"></a>00644         {
<a name="l00645"></a>00645           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#abe7f718f5ce4885ef6e39b105173ecdf">hdlmap_nb_entry_prealloc</a> =
<a name="l00646"></a>00646               (<span class="keywordtype">unsigned</span> int)atoi(key_value);
<a name="l00647"></a>00647         }
<a name="l00648"></a>00648       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!<a class="code" href="FSAL__PROXY_2fsal__tools_8c.html#a1ffef5879101d778f17a377e0d8b0e00">STRCMP</a>(key_name, <span class="stringliteral">&quot;HandleMap_Nb_DB_Operations_Prealloc&quot;</span>))
<a name="l00649"></a>00649         {
<a name="l00650"></a>00650           init_info-&gt;<a class="code" href="structproxyfs__specific__initinfo__t.html#a4ead988e8c0ad7cedc0918436083308e">hdlmap_nb_db_op_prealloc</a> =
<a name="l00651"></a>00651               (<span class="keywordtype">unsigned</span> int)atoi(key_value);
<a name="l00652"></a>00652         }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654       <span class="keywordflow">else</span>
<a name="l00655"></a>00655         {
<a name="l00656"></a>00656           <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a56ee474beccbe057441cc2d70a26ad15">COMPONENT_CONFIG</a>,
<a name="l00657"></a>00657                   <span class="stringliteral">&quot;FSAL LOAD PARAMETER: ERROR: Unknown or unsettable key: %s (item %s)&quot;</span>,
<a name="l00658"></a>00658                   key_name, <a class="code" href="FSAL_2FSAL__CEPH_2fsal__types_8h.html#a1f148cbea3c80e8164aa6799013734fc">CONF_LABEL_FS_SPECIFIC</a>);
<a name="l00659"></a>00659           <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a8e03e63b74eb0767518d858d71fc68a3">ERR_FSAL_INVAL</a>, 0);
<a name="l00660"></a>00660         }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664   <a class="code" href="fsal_8h.html#a9e59f9dd05680d17442417516a3029e5">ReturnCode</a>(<a class="code" href="err__fsal_8h.html#a5fca950e941463a0c2462761a96d20f2a2ab4fbc56e98d01fc4f166d513f92df1">ERR_FSAL_NO_ERROR</a>, 0);
<a name="l00665"></a>00665 
<a name="l00666"></a>00666 }                               <span class="comment">/* FSAL_load_FS_specific_parameter_from_conf */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 21 2012 for nfs-ganesha by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
