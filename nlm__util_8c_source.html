<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>nfs-ganesha: nlm_util.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nfs-ganesha&#160;<span id="projectnumber">1.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>nlm_util.c</h1>  </div>
</div>
<div class="contents">
<a href="nlm__util_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright IBM Corporation, 2010</span>
<a name="l00003"></a>00003 <span class="comment"> *  Contributor: Aneesh Kumar K.v  &lt;aneesh.kumar@linux.vnet.ibm.com&gt;</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * * --------------------------</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00008"></a>00008 <span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
<a name="l00009"></a>00009 <span class="comment"> * License as published by the Free Software Foundation; either</span>
<a name="l00010"></a>00010 <span class="comment"> * version 3 of the License, or (at your option) any later version.</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00013"></a>00013 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00015"></a>00015 <span class="comment"> * Lesser General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<a name="l00018"></a>00018 <span class="comment"> * License along with this library; if not, write to the Free Software</span>
<a name="l00019"></a>00019 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#endif</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span>
<a name="l00028"></a>00028 <span class="preprocessor">#ifdef _SOLARIS</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="preprocessor">#include &quot;solaris_port.h&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#endif</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;ganesha_rpc.h&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;nlm4.h&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;sal_functions.h&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;nlm_util.h&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;nsm.h&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;nlm_async.h&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;nfs_core.h&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;nfs_tcb.h&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">/* nlm grace time tracking */</span>
<a name="l00046"></a>00046 <span class="keyword">static</span> <span class="keyword">struct </span>timeval nlm_grace_tv;
<a name="l00047"></a><a class="code" href="nlm__util_8c.html#a8d4855ea07319a18c0216f5bac390bcb">00047</a> <span class="preprocessor">#define NLM4_GRACE_PERIOD 10</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00049"></a>00049 <span class="comment"> * Time after which we should retry the granted</span>
<a name="l00050"></a>00050 <span class="comment"> * message request again</span>
<a name="l00051"></a>00051 <span class="comment"> */</span>
<a name="l00052"></a><a class="code" href="nlm__util_8c.html#ac6d460361e89876cfc4d31ffdac8fad2">00052</a> <span class="preprocessor">#define NLM4_CLIENT_GRACE_PERIOD 3</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00054"></a>00054 <span class="comment">/* We manage our own cookie for GRANTED call backs</span>
<a name="l00055"></a>00055 <span class="comment"> * Cookie </span>
<a name="l00056"></a>00056 <span class="comment"> */</span>
<a name="l00057"></a><a class="code" href="structgranted__cookie__t.html">00057</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structgranted__cookie__t.html">granted_cookie_t</a>
<a name="l00058"></a>00058 {
<a name="l00059"></a><a class="code" href="structgranted__cookie__t.html#a63b467922b86a41d5f7e8e5abd898187">00059</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structgranted__cookie__t.html#a63b467922b86a41d5f7e8e5abd898187">gc_seconds</a>;
<a name="l00060"></a><a class="code" href="structgranted__cookie__t.html#af2b5e0ed9a9d0f90015b9e45a967e4fe">00060</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structgranted__cookie__t.html#af2b5e0ed9a9d0f90015b9e45a967e4fe">gc_microseconds</a>;
<a name="l00061"></a><a class="code" href="structgranted__cookie__t.html#a948450471a7b067189452d69bb0f5128">00061</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structgranted__cookie__t.html#a948450471a7b067189452d69bb0f5128">gc_cookie</a>;
<a name="l00062"></a>00062 } <a class="code" href="nlm__util_8c.html#a717b5e5e0888bca2be154515bcdf0c85">granted_cookie_t</a>;
<a name="l00063"></a>00063 
<a name="l00064"></a><a class="code" href="nlm__util_8c.html#ad9742fa8da3e948ced530b0260b38d35">00064</a> <a class="code" href="structgranted__cookie__t.html">granted_cookie_t</a> <a class="code" href="nlm__util_8c.html#ad9742fa8da3e948ced530b0260b38d35">granted_cookie</a>;
<a name="l00065"></a><a class="code" href="nlm__util_8c.html#a61ab39979e720b6d50143e36853d5dac">00065</a> pthread_mutex_t <a class="code" href="nlm__util_8c.html#a61ab39979e720b6d50143e36853d5dac">granted_mutex</a> = PTHREAD_MUTEX_INITIALIZER;
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="nlm__util_8c.html#ae0a6a46e50b757e573ef896c086e84ca">00067</a> <span class="keywordtype">void</span> <a class="code" href="nlm__util_8c.html#ae0a6a46e50b757e573ef896c086e84ca">next_granted_cookie</a>(<a class="code" href="structgranted__cookie__t.html">granted_cookie_t</a> *cookie)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069   <a class="code" href="common__utils_8h.html#a13190861330e48fe885da6b2671876a9">P</a>(<a class="code" href="nlm__util_8c.html#a61ab39979e720b6d50143e36853d5dac">granted_mutex</a>);
<a name="l00070"></a>00070   granted_cookie.<a class="code" href="structgranted__cookie__t.html#a948450471a7b067189452d69bb0f5128">gc_cookie</a>++;
<a name="l00071"></a>00071   *cookie = <a class="code" href="nlm__util_8c.html#ad9742fa8da3e948ced530b0260b38d35">granted_cookie</a>;
<a name="l00072"></a>00072   <a class="code" href="common__utils_8h.html#a5a9b6f8030959507eee365b226d63b00">V</a>(<a class="code" href="nlm__util_8c.html#a61ab39979e720b6d50143e36853d5dac">granted_mutex</a>);
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="nlm__util_8c.html#a14cf4eae911b299c6acf0344248e16fd">00075</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="nlm__util_8h.html#a14cf4eae911b299c6acf0344248e16fd">lock_result_str</a>(<span class="keywordtype">int</span> rc)
<a name="l00076"></a>00076 {
<a name="l00077"></a>00077   <span class="keywordflow">switch</span>(rc)
<a name="l00078"></a>00078     {
<a name="l00079"></a>00079       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0afed82341001bda6fc720ec7f13b3d25f">NLM4_GRANTED</a>:             <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_GRANTED&quot;</span>;
<a name="l00080"></a>00080       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a76ba2dfbc21139b9cdb27e6de10d8954">NLM4_DENIED</a>:              <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_DENIED&quot;</span>;
<a name="l00081"></a>00081       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a4890fa941c7252655e07006b6093bb41">NLM4_DENIED_NOLOCKS</a>:      <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_DENIED_NOLOCKS&quot;</span>;
<a name="l00082"></a>00082       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0ab8f113d618995fb585549382aa146ce9">NLM4_BLOCKED</a>:             <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_BLOCKED&quot;</span>;
<a name="l00083"></a>00083       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a81247d672417402a14eae8437662ff29">NLM4_DENIED_GRACE_PERIOD</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_DENIED_GRACE_PERIOD&quot;</span>;
<a name="l00084"></a>00084       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a0df15f093103da88b62ed5043875dbf8">NLM4_DEADLCK</a>:             <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_DEADLCK&quot;</span>;
<a name="l00085"></a>00085       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a8e03148e089eb87abd0a38a0de480487">NLM4_ROFS</a>:                <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_ROFS&quot;</span>;
<a name="l00086"></a>00086       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a6232c8f919cdd3101da40d6b9e411e49">NLM4_STALE_FH</a>:            <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_STALE_FH&quot;</span>;
<a name="l00087"></a>00087       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0add8a9101f33863ee99255e96412dfa18">NLM4_FBIG</a>:                <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_FBIG&quot;</span>;
<a name="l00088"></a>00088       <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a52187b76d65b4d0fa3c0921a3b272690">NLM4_FAILED</a>:              <span class="keywordflow">return</span> <span class="stringliteral">&quot;NLM4_FAILED&quot;</span>;
<a name="l00089"></a>00089       <span class="keywordflow">default</span>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;Unknown&quot;</span>;
<a name="l00090"></a>00090     }
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="nlm__util_8c.html#a60b7d2de12c53886bcb1ccdde38de77e">00093</a> <span class="keyword">inline</span> <a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> <a class="code" href="nlm__util_8c.html#a60b7d2de12c53886bcb1ccdde38de77e">lock_end</a>(<a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> start, <a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> len)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095   <span class="keywordflow">if</span>(len == 0)
<a name="l00096"></a>00096     <span class="keywordflow">return</span> UINT64_MAX;
<a name="l00097"></a>00097   <span class="keywordflow">else</span>
<a name="l00098"></a>00098     <span class="keywordflow">return</span> start + len - 1;
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="nlm__util_8c.html#a972c633e46423f4574e9ce5eee272fde">00101</a> bool_t <a class="code" href="nlm__util_8c.html#a972c633e46423f4574e9ce5eee272fde">fill_netobj</a>(netobj * dst, <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> len)
<a name="l00102"></a>00102 {
<a name="l00103"></a>00103   dst-&gt;n_len   = 0;
<a name="l00104"></a>00104   dst-&gt;n_bytes = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00105"></a>00105   <span class="keywordflow">if</span>(len != 0)
<a name="l00106"></a>00106     {
<a name="l00107"></a>00107       dst-&gt;n_bytes = gsh_malloc(len);
<a name="l00108"></a>00108       <span class="keywordflow">if</span>(dst-&gt;n_bytes != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00109"></a>00109         {
<a name="l00110"></a>00110           dst-&gt;n_len = len;
<a name="l00111"></a>00111           memcpy(dst-&gt;n_bytes, data, len);
<a name="l00112"></a>00112         }
<a name="l00113"></a>00113       <span class="keywordflow">else</span>
<a name="l00114"></a>00114         <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116   <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="nlm__util_8c.html#aa068a5d0b5653358d77d3f9d3929ecb1">00119</a> netobj *<a class="code" href="nlm__util_8h.html#aa068a5d0b5653358d77d3f9d3929ecb1">copy_netobj</a>(netobj * dst, netobj * src)
<a name="l00120"></a>00120 {
<a name="l00121"></a>00121   <span class="keywordflow">if</span>(dst == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00122"></a>00122     <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00123"></a>00123   dst-&gt;n_len = 0;
<a name="l00124"></a>00124   <span class="keywordflow">if</span>(src-&gt;n_len != 0)
<a name="l00125"></a>00125     {
<a name="l00126"></a>00126       dst-&gt;n_bytes = gsh_malloc(src-&gt;n_len);
<a name="l00127"></a>00127       <span class="keywordflow">if</span>(!dst-&gt;n_bytes)
<a name="l00128"></a>00128         <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00129"></a>00129       memcpy(dst-&gt;n_bytes, src-&gt;n_bytes, src-&gt;n_len);
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131   <span class="keywordflow">else</span>
<a name="l00132"></a>00132     dst-&gt;n_bytes = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   dst-&gt;n_len = src-&gt;n_len;
<a name="l00135"></a>00135   <span class="keywordflow">return</span> dst;
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="nlm__util_8c.html#af4395c3f38c138b7a7a8ace0d5f4487e">00138</a> <span class="keywordtype">void</span> <a class="code" href="nlm__util_8h.html#af4395c3f38c138b7a7a8ace0d5f4487e">netobj_free</a>(netobj * obj)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140   <span class="keywordflow">if</span>(obj-&gt;n_bytes)
<a name="l00141"></a>00141     gsh_free(obj-&gt;n_bytes);
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="nlm__util_8c.html#a2a37ae5a8f8501d12c0abad1456fefee">00144</a> <span class="keywordtype">void</span> <a class="code" href="nlm__util_8h.html#a2a37ae5a8f8501d12c0abad1456fefee">netobj_to_string</a>(netobj *obj, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">int</span> maxlen)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146   <span class="keywordtype">int</span> len = obj-&gt;n_len;
<a name="l00147"></a>00147   <span class="keywordflow">if</span>((len * 2) + 10 &gt; maxlen)
<a name="l00148"></a>00148     len = (maxlen - 10) / 2;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   <a class="code" href="sal__functions_8h.html#a4ac7c8d8d01b567b3a288a79a2b65709">DisplayOpaqueValue</a>(obj-&gt;n_bytes, len, buffer);
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a><a class="code" href="nlm__util_8c.html#a83e0ed0f5d94799ddde971f674adaf60">00153</a> <span class="keywordtype">void</span> <a class="code" href="nlm4_8h.html#a83e0ed0f5d94799ddde971f674adaf60">nlm_init</a>(<span class="keywordtype">void</span>)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155   <span class="comment">/* start NLM grace period */</span>
<a name="l00156"></a>00156   gettimeofday(&amp;nlm_grace_tv, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158   <span class="comment">/* also use this time to initialize granted_cookie */</span>
<a name="l00159"></a>00159   granted_cookie.<a class="code" href="structgranted__cookie__t.html#a63b467922b86a41d5f7e8e5abd898187">gc_seconds</a>      = (<span class="keywordtype">unsigned</span> long) nlm_grace_tv.tv_sec;
<a name="l00160"></a>00160   granted_cookie.<a class="code" href="structgranted__cookie__t.html#af2b5e0ed9a9d0f90015b9e45a967e4fe">gc_microseconds</a> = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) nlm_grace_tv.tv_usec;
<a name="l00161"></a>00161   granted_cookie.<a class="code" href="structgranted__cookie__t.html#a948450471a7b067189452d69bb0f5128">gc_cookie</a>       = 0;
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 
<a name="l00164"></a><a class="code" href="nlm__util_8c.html#a6761d182b82fb7f4278a5992b66413ee">00164</a> <span class="keywordtype">void</span> <a class="code" href="nlm__util_8c.html#a6761d182b82fb7f4278a5992b66413ee">free_grant_arg</a>(<a class="code" href="sal__data_8h.html#abf159a29a191e59f176897b998c40b7e">state_async_queue_t</a> *arg)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166   state_nlm_async_data_t * nlm_arg = &amp;arg-&gt;state_async_data.state_nlm_async_data;
<a name="l00167"></a>00167   <a class="code" href="nlm__util_8h.html#af4395c3f38c138b7a7a8ace0d5f4487e">netobj_free</a>(&amp;nlm_arg-&gt;nlm_async_args.nlm_async_grant.cookie);
<a name="l00168"></a>00168   <a class="code" href="nlm__util_8h.html#af4395c3f38c138b7a7a8ace0d5f4487e">netobj_free</a>(&amp;nlm_arg-&gt;nlm_async_args.nlm_async_grant.alock.oh);
<a name="l00169"></a>00169   <a class="code" href="nlm__util_8h.html#af4395c3f38c138b7a7a8ace0d5f4487e">netobj_free</a>(&amp;nlm_arg-&gt;nlm_async_args.nlm_async_grant.alock.fh);
<a name="l00170"></a>00170   <span class="keywordflow">if</span>(nlm_arg-&gt;nlm_async_args.nlm_async_grant.alock.caller_name != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00171"></a>00171     gsh_free(nlm_arg-&gt;nlm_async_args.nlm_async_grant.alock.caller_name);
<a name="l00172"></a>00172   gsh_free(arg);
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00181"></a>00181 <span class="keyword">static</span> <span class="keywordtype">void</span> nlm4_send_grant_msg(<a class="code" href="sal__data_8h.html#abf159a29a191e59f176897b998c40b7e">state_async_queue_t</a> *arg)
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183   <span class="keywordtype">int</span>                      retval;
<a name="l00184"></a>00184   <span class="keywordtype">char</span>                     buffer[1024];
<a name="l00185"></a>00185   <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5b">state_status_t</a>           state_status = <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba95fdd6b02cbc698e4bd1a4eafe1661ff">STATE_SUCCESS</a>;
<a name="l00186"></a>00186   state_cookie_entry_t   * cookie_entry;
<a name="l00187"></a>00187   <a class="code" href="structfsal__op__context____.html">fsal_op_context_t</a>        context, * pcontext = &amp;context;
<a name="l00188"></a>00188   state_nlm_async_data_t * nlm_arg = &amp;arg-&gt;state_async_data.state_nlm_async_data;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190   <span class="keywordflow">if</span>(<a class="code" href="log_8h.html#ac778c7aeca566b747dd5bb1baecb6316">isDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>))
<a name="l00191"></a>00191     {
<a name="l00192"></a>00192       <a class="code" href="nlm__util_8h.html#a2a37ae5a8f8501d12c0abad1456fefee">netobj_to_string</a>(&amp;nlm_arg-&gt;nlm_async_args.nlm_async_grant.cookie,
<a name="l00193"></a>00193                        buffer, <span class="keyword">sizeof</span>(buffer));
<a name="l00194"></a>00194 
<a name="l00195"></a>00195       <a class="code" href="log_8h.html#aa7aee8ec65b5baafb430f8d2a7588d53">LogDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00196"></a>00196                <span class="stringliteral">&quot;Sending GRANTED for arg=%p svid=%d start=%llx len=%llx cookie=%s&quot;</span>,
<a name="l00197"></a>00197                arg, nlm_arg-&gt;nlm_async_args.nlm_async_grant.alock.svid,
<a name="l00198"></a>00198                (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) nlm_arg-&gt;nlm_async_args.nlm_async_grant.alock.l_offset,
<a name="l00199"></a>00199                (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) nlm_arg-&gt;nlm_async_args.nlm_async_grant.alock.l_len,
<a name="l00200"></a>00200                buffer);
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   retval = <a class="code" href="nlm__async_8h.html#aae660e9b3785b69d605fa55ab97d3c01">nlm_send_async</a>(<a class="code" href="nlm4_8h.html#a5cefd0b5eef7266d5585343625d2f413">NLMPROC4_GRANTED_MSG</a>,
<a name="l00204"></a>00204                           nlm_arg-&gt;nlm_async_host,
<a name="l00205"></a>00205                           &amp;(nlm_arg-&gt;nlm_async_args.nlm_async_grant),
<a name="l00206"></a>00206                           nlm_arg-&gt;nlm_async_key);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208   <a class="code" href="nlm__owner_8c.html#a8ec5ffad0b53808d66220669827b1a9b">dec_nlm_client_ref</a>(nlm_arg-&gt;nlm_async_host);
<a name="l00209"></a>00209   <a class="code" href="nlm__util_8c.html#a6761d182b82fb7f4278a5992b66413ee">free_grant_arg</a>(arg);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211   <span class="comment">/* If success, we are done. */</span>
<a name="l00212"></a>00212   <span class="keywordflow">if</span>(retval == RPC_SUCCESS)
<a name="l00213"></a>00213     <span class="keywordflow">return</span>;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215   <span class="comment">/*</span>
<a name="l00216"></a>00216 <span class="comment">   * We are not able call granted callback. Some client may retry</span>
<a name="l00217"></a>00217 <span class="comment">   * the lock again. So remove the existing blocked nlm entry</span>
<a name="l00218"></a>00218 <span class="comment">   */</span>
<a name="l00219"></a>00219   <a class="code" href="log_8h.html#a3cf3c22fac6bb9871e25007551caeb13">LogMajor</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00220"></a>00220            <span class="stringliteral">&quot;GRANTED_MSG RPC call failed with return code %d. Removing the blocking lock&quot;</span>,
<a name="l00221"></a>00221            retval);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223   <span class="keywordflow">if</span>(state_find_grant(nlm_arg-&gt;nlm_async_args.nlm_async_grant.cookie.n_bytes,
<a name="l00224"></a>00224                       nlm_arg-&gt;nlm_async_args.nlm_async_grant.cookie.n_len,
<a name="l00225"></a>00225                       &amp;cookie_entry,
<a name="l00226"></a>00226                       &amp;state_status) != <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba95fdd6b02cbc698e4bd1a4eafe1661ff">STATE_SUCCESS</a>)
<a name="l00227"></a>00227     {
<a name="l00228"></a>00228       <span class="comment">/* This must be an old NLM_GRANTED_RES */</span>
<a name="l00229"></a>00229       <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00230"></a>00230                    <span class="stringliteral">&quot;Could not find cookie=%s status=%s&quot;</span>,
<a name="l00231"></a>00231                    buffer, <a class="code" href="sal__functions_8h.html#a5c251a49aca6c7d4fc07bcc9f925ec07">state_err_str</a>(state_status));
<a name="l00232"></a>00232       <span class="keywordflow">return</span>;
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235   pthread_rwlock_wrlock(&amp;cookie_entry-&gt;sce_pentry-&gt;state_lock);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   <span class="keywordflow">if</span>(cookie_entry-&gt;sce_lock_entry-&gt;sle_block_data == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l00238"></a>00238      !<a class="code" href="nlm__util_8h.html#a2b937321c15f535f6ab0e077b532995e">nlm_block_data_to_fsal_context</a>(cookie_entry-&gt;sce_lock_entry-&gt;sle_block_data,
<a name="l00239"></a>00239                                      pcontext))
<a name="l00240"></a>00240     {
<a name="l00241"></a>00241       <span class="comment">/* Wow, we&#39;re not doing well... */</span>
<a name="l00242"></a>00242       pthread_rwlock_unlock(&amp;cookie_entry-&gt;sce_pentry-&gt;state_lock);
<a name="l00243"></a>00243       <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00244"></a>00244                    <span class="stringliteral">&quot;Could not find block data for cookie=%s (must be an old NLM_GRANTED_RES)&quot;</span>,
<a name="l00245"></a>00245                    buffer);
<a name="l00246"></a>00246       <span class="keywordflow">return</span>;
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   pthread_rwlock_unlock(&amp;cookie_entry-&gt;sce_pentry-&gt;state_lock);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251   <span class="keywordflow">if</span>(state_release_grant(pcontext,
<a name="l00252"></a>00252                          cookie_entry,
<a name="l00253"></a>00253                          &amp;state_status) != <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba95fdd6b02cbc698e4bd1a4eafe1661ff">STATE_SUCCESS</a>)
<a name="l00254"></a>00254     {
<a name="l00255"></a>00255       <span class="comment">/* Huh? */</span>
<a name="l00256"></a>00256       <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00257"></a>00257                    <span class="stringliteral">&quot;Could not release cookie=%s status=%s&quot;</span>,
<a name="l00258"></a>00258                    buffer, <a class="code" href="sal__functions_8h.html#a5c251a49aca6c7d4fc07bcc9f925ec07">state_err_str</a>(state_status));
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="nlm__util_8c.html#a6d173531998cf252ecc406db40a7fb54">00262</a> <span class="keywordtype">int</span> <a class="code" href="nlm__util_8h.html#a6d173531998cf252ecc406db40a7fb54">nlm_process_parameters</a>(<span class="keyword">struct</span> svc_req        * preq,
<a name="l00263"></a>00263                            bool_t                  exclusive,
<a name="l00264"></a>00264                            <a class="code" href="structnlm4__lock.html">nlm4_lock</a>             * alock,
<a name="l00265"></a>00265                            <a class="code" href="structfsal__lock__param__t.html">fsal_lock_param_t</a>     * plock,
<a name="l00266"></a>00266                            <a class="code" href="structcache__entry__t.html" title="Represents a cached inode.">cache_entry_t</a>        ** ppentry,
<a name="l00267"></a>00267                            <a class="code" href="structfsal__op__context____.html">fsal_op_context_t</a>     * pcontext,
<a name="l00268"></a>00268                            care_t                  care,
<a name="l00269"></a>00269                            state_nsm_client_t   ** ppnsm_client,
<a name="l00270"></a>00270                            state_nlm_client_t   ** ppnlm_client,
<a name="l00271"></a>00271                            <a class="code" href="structstate__owner__t.html">state_owner_t</a>        ** ppowner,
<a name="l00272"></a>00272                            <a class="code" href="sal__data_8h.html#a3035370b7b027cc7c897284b50c5fc12">state_block_data_t</a>   ** ppblock_data)
<a name="l00273"></a>00273 {
<a name="l00274"></a>00274   <a class="code" href="structcache__inode__fsal__data____.html">cache_inode_fsal_data_t</a> fsal_data;
<a name="l00275"></a>00275   <a class="code" href="structfsal__attrib__list____.html">fsal_attrib_list_t</a>      attr;
<a name="l00276"></a>00276   <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2">cache_inode_status_t</a>    cache_status;
<a name="l00277"></a>00277   SVCXPRT                *ptr_svc = preq-&gt;rq_xprt;
<a name="l00278"></a>00278   <span class="keywordtype">int</span>                     rc;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280   *ppnsm_client = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00281"></a>00281   *ppnlm_client = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00282"></a>00282   *ppowner      = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   <span class="comment">/* Convert file handle into a cache entry */</span>
<a name="l00285"></a>00285   <span class="keywordflow">if</span>(alock-&gt;<a class="code" href="structnlm4__lock.html#a0c69f88dad1f9625f3b2c16676242548">fh</a>.n_len &gt; MAX_NETOBJ_SZ ||
<a name="l00286"></a>00286      !<a class="code" href="nfs__file__handle_8h.html#ac4b3303a5e40600c415dab544800c996">nfs3_FhandleToFSAL</a>((<a class="code" href="structnfs__fh3.html">nfs_fh3</a> *) &amp;alock-&gt;<a class="code" href="structnlm4__lock.html#a0c69f88dad1f9625f3b2c16676242548">fh</a>, &amp;fsal_data.<a class="code" href="structcache__inode__fsal__data____.html#a4bb6eae804842b06f773ddeb873fb5b5">fh_desc</a>, pcontext))
<a name="l00287"></a>00287     {
<a name="l00288"></a>00288       <span class="comment">/* handle is not valid */</span>
<a name="l00289"></a>00289       <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a6232c8f919cdd3101da40d6b9e411e49">NLM4_STALE_FH</a>;
<a name="l00290"></a>00290     }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292   <span class="comment">/* Now get the cached inode attributes */</span>
<a name="l00293"></a>00293   *ppentry = <a class="code" href="cache__inode__get_8c.html#af93e3320581ae2ea6e5633598d5a2c77" title="Gets an entry by using its fsdata as a key and caches it if needed.">cache_inode_get</a>(&amp;fsal_data,
<a name="l00294"></a>00294                              &amp;attr,
<a name="l00295"></a>00295                              pcontext,
<a name="l00296"></a>00296                              <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00297"></a>00297                              &amp;cache_status);
<a name="l00298"></a>00298   <span class="keywordflow">if</span>(*ppentry == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00299"></a>00299     {
<a name="l00300"></a>00300       <span class="comment">/* handle is not valid */</span>
<a name="l00301"></a>00301       <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a6232c8f919cdd3101da40d6b9e411e49">NLM4_STALE_FH</a>;
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304   *ppnsm_client = <a class="code" href="nlm__owner_8c.html#a0d53d30fb6e35fe0205cd62b925ca115">get_nsm_client</a>(care, ptr_svc, alock-&gt;<a class="code" href="structnlm4__lock.html#a4a7680d60c065f560686b84fd0094b9c">caller_name</a>);
<a name="l00305"></a>00305 
<a name="l00306"></a>00306   <span class="keywordflow">if</span>(*ppnsm_client == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00307"></a>00307     {
<a name="l00308"></a>00308       <span class="comment">/* If NSM Client is not found, and we don&#39;t care (such as unlock),</span>
<a name="l00309"></a>00309 <span class="comment">       * just return GRANTED (the unlock must succeed, there can&#39;t be</span>
<a name="l00310"></a>00310 <span class="comment">       * any locks).</span>
<a name="l00311"></a>00311 <span class="comment">       */</span>
<a name="l00312"></a>00312       <span class="keywordflow">if</span>(care != CARE_NOT)
<a name="l00313"></a>00313         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a4890fa941c7252655e07006b6093bb41">NLM4_DENIED_NOLOCKS</a>;
<a name="l00314"></a>00314       <span class="keywordflow">else</span>
<a name="l00315"></a>00315         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0afed82341001bda6fc720ec7f13b3d25f">NLM4_GRANTED</a>;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317       <span class="keywordflow">goto</span> out_put;
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320   *ppnlm_client = <a class="code" href="nlm__owner_8c.html#a0647bfed30c298c7452695a953592d8f">get_nlm_client</a>(care, ptr_svc, *ppnsm_client, alock-&gt;<a class="code" href="structnlm4__lock.html#a4a7680d60c065f560686b84fd0094b9c">caller_name</a>);
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   <span class="keywordflow">if</span>(*ppnlm_client == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00323"></a>00323     {
<a name="l00324"></a>00324       <span class="comment">/* If NLM Client is not found, and we don&#39;t care (such as unlock),</span>
<a name="l00325"></a>00325 <span class="comment">       * just return GRANTED (the unlock must succeed, there can&#39;t be</span>
<a name="l00326"></a>00326 <span class="comment">       * any locks).</span>
<a name="l00327"></a>00327 <span class="comment">       */</span>
<a name="l00328"></a>00328       <a class="code" href="nlm__owner_8c.html#a68f3b7c0fb0982a436d198a6a28429ad">dec_nsm_client_ref</a>(*ppnsm_client);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330       <span class="keywordflow">if</span>(care != CARE_NOT)
<a name="l00331"></a>00331         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a4890fa941c7252655e07006b6093bb41">NLM4_DENIED_NOLOCKS</a>;
<a name="l00332"></a>00332       <span class="keywordflow">else</span>
<a name="l00333"></a>00333         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0afed82341001bda6fc720ec7f13b3d25f">NLM4_GRANTED</a>;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335       <span class="keywordflow">goto</span> out_put;
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   *ppowner = <a class="code" href="nlm__owner_8c.html#a1fe84375b8f4ac451d76ca8cf3b7d956">get_nlm_owner</a>(care, *ppnlm_client, &amp;alock-&gt;<a class="code" href="structnlm4__lock.html#af1657853a7e83dd2e24d3f873f37d0dc">oh</a>, alock-&gt;<a class="code" href="structnlm4__lock.html#a30219f792f5964734898c45eb06dadb4">svid</a>);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340   <span class="keywordflow">if</span>(*ppowner == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00341"></a>00341     {
<a name="l00342"></a>00342       <a class="code" href="log_8h.html#aa7aee8ec65b5baafb430f8d2a7588d53">LogDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00343"></a>00343                <span class="stringliteral">&quot;Could not get NLM Owner&quot;</span>);
<a name="l00344"></a>00344       <a class="code" href="nlm__owner_8c.html#a68f3b7c0fb0982a436d198a6a28429ad">dec_nsm_client_ref</a>(*ppnsm_client);
<a name="l00345"></a>00345       <a class="code" href="nlm__owner_8c.html#a8ec5ffad0b53808d66220669827b1a9b">dec_nlm_client_ref</a>(*ppnlm_client);
<a name="l00346"></a>00346       *ppnlm_client = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348       <span class="comment">/* If owner is not found, and we don&#39;t care (such as unlock),</span>
<a name="l00349"></a>00349 <span class="comment">       * just return GRANTED (the unlock must succeed, there can&#39;t be</span>
<a name="l00350"></a>00350 <span class="comment">       * any locks).</span>
<a name="l00351"></a>00351 <span class="comment">       */</span>
<a name="l00352"></a>00352       <span class="keywordflow">if</span>(care != CARE_NOT)
<a name="l00353"></a>00353         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a4890fa941c7252655e07006b6093bb41">NLM4_DENIED_NOLOCKS</a>;
<a name="l00354"></a>00354       <span class="keywordflow">else</span>
<a name="l00355"></a>00355         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0afed82341001bda6fc720ec7f13b3d25f">NLM4_GRANTED</a>;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357       <span class="keywordflow">goto</span> out_put;
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="keywordflow">if</span>(ppblock_data != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00361"></a>00361     {
<a name="l00362"></a>00362          *ppblock_data = gsh_malloc(<span class="keyword">sizeof</span>(**ppblock_data));
<a name="l00363"></a>00363       <span class="comment">/* Fill in the block data, if we don&#39;t get one, we will just proceed</span>
<a name="l00364"></a>00364 <span class="comment">       * without (which will mean the lock doesn&#39;t block.</span>
<a name="l00365"></a>00365 <span class="comment">       */</span>
<a name="l00366"></a>00366       <span class="keywordflow">if</span>(*ppblock_data != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00367"></a>00367         {
<a name="l00368"></a>00368           memset(*ppblock_data, 0, <span class="keyword">sizeof</span>(**ppblock_data));
<a name="l00369"></a>00369           <span class="keywordflow">if</span>(<a class="code" href="ganesha__rpc_8h.html#ac79de7952a084c98f9dfeba5e1ac0556">copy_xprt_addr</a>(&amp;(*ppblock_data)-&gt;sbd_block_data.sbd_nlm_block_data.sbd_nlm_hostaddr, ptr_svc) == 0)
<a name="l00370"></a>00370             {
<a name="l00371"></a>00371               <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00372"></a>00372                            <span class="stringliteral">&quot;copy_xprt_addr failed for Program %d, Version %d, Function %d&quot;</span>,
<a name="l00373"></a>00373                            (<span class="keywordtype">int</span>)preq-&gt;rq_prog, (<span class="keywordtype">int</span>)preq-&gt;rq_vers, (<span class="keywordtype">int</span>)preq-&gt;rq_proc);
<a name="l00374"></a>00374               gsh_free(*ppblock_data);
<a name="l00375"></a>00375               *ppblock_data = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00376"></a>00376               rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a52187b76d65b4d0fa3c0921a3b272690">NLM4_FAILED</a>;
<a name="l00377"></a>00377               <span class="keywordflow">goto</span> out_put;
<a name="l00378"></a>00378             }
<a name="l00379"></a>00379           (*ppblock_data)-&gt;sbd_granted_callback = <a class="code" href="nlm__util_8h.html#ab89e708c088abb9173e22894883ab6b7">nlm_granted_callback</a>;
<a name="l00380"></a>00380           (*ppblock_data)-&gt;sbd_block_data_to_fsal_context = <a class="code" href="nlm__util_8h.html#a2b937321c15f535f6ab0e077b532995e">nlm_block_data_to_fsal_context</a>;
<a name="l00381"></a>00381           (*ppblock_data)-&gt;sbd_block_data.sbd_nlm_block_data.sbd_nlm_fh.n_bytes =
<a name="l00382"></a>00382             (*ppblock_data)-&gt;sbd_block_data.sbd_nlm_block_data.sbd_nlm_fh_buf;
<a name="l00383"></a>00383           (*ppblock_data)-&gt;sbd_block_data.sbd_nlm_block_data.sbd_nlm_fh.n_len = alock-&gt;<a class="code" href="structnlm4__lock.html#a0c69f88dad1f9625f3b2c16676242548">fh</a>.n_len;
<a name="l00384"></a>00384           memcpy((*ppblock_data)-&gt;sbd_block_data.sbd_nlm_block_data.sbd_nlm_fh_buf,
<a name="l00385"></a>00385                  alock-&gt;<a class="code" href="structnlm4__lock.html#a0c69f88dad1f9625f3b2c16676242548">fh</a>.n_bytes,
<a name="l00386"></a>00386                  alock-&gt;<a class="code" href="structnlm4__lock.html#a0c69f88dad1f9625f3b2c16676242548">fh</a>.n_len);
<a name="l00387"></a>00387           <span class="comment">/* FSF TODO: Ultimately I think the following will go away, we won&#39;t need the context, just the export */</span>
<a name="l00388"></a>00388           <span class="comment">/* Copy credentials from pcontext */</span>
<a name="l00389"></a>00389 <span class="preprocessor">#ifdef _USE_HPSS</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>
<a name="l00391"></a>00391           (*ppblock_data)-&gt;sbd_credential.user  =  pcontext-&gt;<a class="code" href="structfsal__op__context____.html#a8c06e8eee9146a362ed0cb8c921abc31">credential</a>.hpss_usercred.Uid ;
<a name="l00392"></a>00392           (*ppblock_data)-&gt;sbd_credential.<a class="code" href="structuser__credentials.html#ab2dfa027586dd78c5c30355482d9bc5d">group</a> =  pcontext-&gt;<a class="code" href="structfsal__op__context____.html#a8c06e8eee9146a362ed0cb8c921abc31">credential</a>.hpss_usercred.Gid ;
<a name="l00393"></a>00393 <span class="preprocessor">#else</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>          (*ppblock_data)-&gt;sbd_credential = pcontext-&gt;<a class="code" href="structfsal__op__context____.html#a8c06e8eee9146a362ed0cb8c921abc31">credential</a>;
<a name="l00395"></a>00395 <span class="preprocessor">#endif</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>        }
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398   <span class="comment">/* Fill in plock */</span>
<a name="l00399"></a>00399   plock-&gt;<a class="code" href="structfsal__lock__param__t.html#af92333e93eb13a24565eb97d40d4e79d">lock_type</a>   = exclusive ? <a class="code" href="fsal__types_8h.html#aab76e308a0e07a7fcb4f4182ca3c098ca26e942e5ccc850086303fb166d2e1624">FSAL_LOCK_W</a> : <a class="code" href="fsal__types_8h.html#aab76e308a0e07a7fcb4f4182ca3c098caa8633965558922590799e083782fb423">FSAL_LOCK_R</a>;
<a name="l00400"></a>00400   plock-&gt;<a class="code" href="structfsal__lock__param__t.html#a170a307abeec4fbabbde67143abae136">lock_start</a>  = alock-&gt;<a class="code" href="structnlm4__lock.html#a93ab098e4b6acda45c94268e41cf4821">l_offset</a>;
<a name="l00401"></a>00401   plock-&gt;<a class="code" href="structfsal__lock__param__t.html#a7d0118133370d4d72c5644389316792e">lock_length</a> = alock-&gt;<a class="code" href="structnlm4__lock.html#a41846f08233c10b261f95e7026c1d714">l_len</a>;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00404"></a>00404                <span class="stringliteral">&quot;Parameters Processed&quot;</span>);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406   <span class="keywordflow">return</span> -1;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408  out_put:
<a name="l00409"></a>00409 
<a name="l00410"></a>00410   <a class="code" href="cache__inode__get_8c.html#a8ff682b5012ccc7a46cb876664d0a7a2">cache_inode_put</a>(*ppentry);
<a name="l00411"></a>00411   *ppentry = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00412"></a>00412   <span class="keywordflow">return</span> rc;
<a name="l00413"></a>00413 }
<a name="l00414"></a>00414 
<a name="l00415"></a><a class="code" href="nlm__util_8c.html#acd1fa8ec7b808dd78dbc24f48bae0a00">00415</a> <span class="keywordtype">int</span> <a class="code" href="nlm__util_8h.html#acd1fa8ec7b808dd78dbc24f48bae0a00">nlm_process_share_parms</a>(<span class="keyword">struct</span> svc_req        * preq,
<a name="l00416"></a>00416                             <a class="code" href="structnlm4__share.html">nlm4_share</a>            * share,
<a name="l00417"></a>00417                             <a class="code" href="structcache__entry__t.html" title="Represents a cached inode.">cache_entry_t</a>        ** ppentry,
<a name="l00418"></a>00418                             <a class="code" href="structfsal__op__context____.html">fsal_op_context_t</a>     * pcontext,
<a name="l00419"></a>00419                             care_t                  care,
<a name="l00420"></a>00420                             state_nsm_client_t   ** ppnsm_client,
<a name="l00421"></a>00421                             state_nlm_client_t   ** ppnlm_client,
<a name="l00422"></a>00422                             <a class="code" href="structstate__owner__t.html">state_owner_t</a>        ** ppowner)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424   <a class="code" href="structcache__inode__fsal__data____.html">cache_inode_fsal_data_t</a> fsal_data;
<a name="l00425"></a>00425   <a class="code" href="structfsal__attrib__list____.html">fsal_attrib_list_t</a>      attr;
<a name="l00426"></a>00426   <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2">cache_inode_status_t</a>    cache_status;
<a name="l00427"></a>00427   SVCXPRT                *ptr_svc = preq-&gt;rq_xprt;
<a name="l00428"></a>00428   <span class="keywordtype">int</span>                     rc;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430   *ppnsm_client = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00431"></a>00431   *ppnlm_client = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00432"></a>00432   *ppowner      = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434   <span class="comment">/* Convert file handle into a cache entry */</span>
<a name="l00435"></a>00435   <span class="keywordflow">if</span>(share-&gt;<a class="code" href="structnlm4__share.html#a9bf1f3835ba49b5242174ccff98d6abe">fh</a>.n_len &gt; MAX_NETOBJ_SZ ||
<a name="l00436"></a>00436      !<a class="code" href="nfs__file__handle_8h.html#ac4b3303a5e40600c415dab544800c996">nfs3_FhandleToFSAL</a>((<a class="code" href="structnfs__fh3.html">nfs_fh3</a> *) &amp;share-&gt;<a class="code" href="structnlm4__share.html#a9bf1f3835ba49b5242174ccff98d6abe">fh</a>, &amp;fsal_data.<a class="code" href="structcache__inode__fsal__data____.html#a4bb6eae804842b06f773ddeb873fb5b5">fh_desc</a>, pcontext))
<a name="l00437"></a>00437     {
<a name="l00438"></a>00438       <span class="comment">/* handle is not valid */</span>
<a name="l00439"></a>00439       <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a6232c8f919cdd3101da40d6b9e411e49">NLM4_STALE_FH</a>;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442   <span class="comment">/* Now get the cached inode attributes */</span>
<a name="l00443"></a>00443   *ppentry = <a class="code" href="cache__inode__get_8c.html#af93e3320581ae2ea6e5633598d5a2c77" title="Gets an entry by using its fsdata as a key and caches it if needed.">cache_inode_get</a>(&amp;fsal_data,
<a name="l00444"></a>00444                              &amp;attr,
<a name="l00445"></a>00445                              pcontext,
<a name="l00446"></a>00446                              <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00447"></a>00447                              &amp;cache_status);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449   <span class="keywordflow">if</span>(*ppentry == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00450"></a>00450     {
<a name="l00451"></a>00451       <span class="comment">/* handle is not valid */</span>
<a name="l00452"></a>00452       <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a6232c8f919cdd3101da40d6b9e411e49">NLM4_STALE_FH</a>;
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   *ppnsm_client = <a class="code" href="nlm__owner_8c.html#a0d53d30fb6e35fe0205cd62b925ca115">get_nsm_client</a>(care, ptr_svc, share-&gt;<a class="code" href="structnlm4__share.html#afdb18ff90ac5e6d5135cbb1c0ceca348">caller_name</a>);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   <span class="keywordflow">if</span>(*ppnsm_client == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00458"></a>00458     {
<a name="l00459"></a>00459       <span class="comment">/* If NSM Client is not found, and we don&#39;t care (for unshare),</span>
<a name="l00460"></a>00460 <span class="comment">       * just return GRANTED (the unshare must succeed, there can&#39;t be</span>
<a name="l00461"></a>00461 <span class="comment">       * any shares).</span>
<a name="l00462"></a>00462 <span class="comment">       */</span>
<a name="l00463"></a>00463       <span class="keywordflow">if</span>(care != CARE_NOT)
<a name="l00464"></a>00464         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a4890fa941c7252655e07006b6093bb41">NLM4_DENIED_NOLOCKS</a>;
<a name="l00465"></a>00465       <span class="keywordflow">else</span>
<a name="l00466"></a>00466         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0afed82341001bda6fc720ec7f13b3d25f">NLM4_GRANTED</a>;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468       <span class="keywordflow">goto</span> out_put;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471   *ppnlm_client = <a class="code" href="nlm__owner_8c.html#a0647bfed30c298c7452695a953592d8f">get_nlm_client</a>(care, ptr_svc, *ppnsm_client, share-&gt;<a class="code" href="structnlm4__share.html#afdb18ff90ac5e6d5135cbb1c0ceca348">caller_name</a>);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473   <span class="keywordflow">if</span>(*ppnlm_client == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00474"></a>00474     {
<a name="l00475"></a>00475       <span class="comment">/* If NLM Client is not found, and we don&#39;t care (such as unlock),</span>
<a name="l00476"></a>00476 <span class="comment">       * just return GRANTED (the unlock must succeed, there can&#39;t be</span>
<a name="l00477"></a>00477 <span class="comment">       * any locks).</span>
<a name="l00478"></a>00478 <span class="comment">       */</span>
<a name="l00479"></a>00479       <a class="code" href="nlm__owner_8c.html#a68f3b7c0fb0982a436d198a6a28429ad">dec_nsm_client_ref</a>(*ppnsm_client);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481       <span class="keywordflow">if</span>(care != CARE_NOT)
<a name="l00482"></a>00482         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a4890fa941c7252655e07006b6093bb41">NLM4_DENIED_NOLOCKS</a>;
<a name="l00483"></a>00483       <span class="keywordflow">else</span>
<a name="l00484"></a>00484         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0afed82341001bda6fc720ec7f13b3d25f">NLM4_GRANTED</a>;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486       <span class="keywordflow">goto</span> out_put;
<a name="l00487"></a>00487     }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489   *ppowner = <a class="code" href="nlm__owner_8c.html#a1fe84375b8f4ac451d76ca8cf3b7d956">get_nlm_owner</a>(care, *ppnlm_client, &amp;share-&gt;<a class="code" href="structnlm4__share.html#a7c9846855bc8a7cf3329d2d1c12949e8">oh</a>, 0);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491   <span class="keywordflow">if</span>(*ppowner == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00492"></a>00492     {
<a name="l00493"></a>00493       <a class="code" href="log_8h.html#aa7aee8ec65b5baafb430f8d2a7588d53">LogDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00494"></a>00494                <span class="stringliteral">&quot;Could not get NLM Owner&quot;</span>);
<a name="l00495"></a>00495       <a class="code" href="nlm__owner_8c.html#a68f3b7c0fb0982a436d198a6a28429ad">dec_nsm_client_ref</a>(*ppnsm_client);
<a name="l00496"></a>00496       <a class="code" href="nlm__owner_8c.html#a8ec5ffad0b53808d66220669827b1a9b">dec_nlm_client_ref</a>(*ppnlm_client);
<a name="l00497"></a>00497       *ppnlm_client = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00498"></a>00498 
<a name="l00499"></a>00499       <span class="comment">/* If owner is not found, and we don&#39;t care (such as unlock),</span>
<a name="l00500"></a>00500 <span class="comment">       * just return GRANTED (the unlock must succeed, there can&#39;t be</span>
<a name="l00501"></a>00501 <span class="comment">       * any locks).</span>
<a name="l00502"></a>00502 <span class="comment">       */</span>
<a name="l00503"></a>00503       <span class="keywordflow">if</span>(care != CARE_NOT)
<a name="l00504"></a>00504         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a4890fa941c7252655e07006b6093bb41">NLM4_DENIED_NOLOCKS</a>;
<a name="l00505"></a>00505       <span class="keywordflow">else</span>
<a name="l00506"></a>00506         rc = <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0afed82341001bda6fc720ec7f13b3d25f">NLM4_GRANTED</a>;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508       <span class="keywordflow">goto</span> out_put;
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00512"></a>00512                <span class="stringliteral">&quot;Parameters Processed&quot;</span>);
<a name="l00513"></a>00513 
<a name="l00514"></a>00514   <span class="keywordflow">return</span> -1;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516  out_put:
<a name="l00517"></a>00517 
<a name="l00518"></a>00518   <a class="code" href="cache__inode__get_8c.html#a8ff682b5012ccc7a46cb876664d0a7a2">cache_inode_put</a>(*ppentry);
<a name="l00519"></a>00519   *ppentry = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00520"></a>00520   <span class="keywordflow">return</span> rc;
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a><a class="code" href="nlm__util_8c.html#a6fb8d1c40183667f67925e31b179c621">00523</a> <span class="keywordtype">void</span> <a class="code" href="nlm__util_8h.html#a6fb8d1c40183667f67925e31b179c621">nlm_process_conflict</a>(<a class="code" href="structnlm4__holder.html">nlm4_holder</a>          * nlm_holder,
<a name="l00524"></a>00524                           <a class="code" href="structstate__owner__t.html">state_owner_t</a>        * holder,
<a name="l00525"></a>00525                           <a class="code" href="structfsal__lock__param__t.html">fsal_lock_param_t</a>    * conflict)
<a name="l00526"></a>00526 {
<a name="l00527"></a>00527   <span class="keywordflow">if</span>(conflict != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00528"></a>00528     {
<a name="l00529"></a>00529       nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#a83df57c9c0da0a9a61b12669d00ae334">exclusive</a> = conflict-&gt;<a class="code" href="structfsal__lock__param__t.html#af92333e93eb13a24565eb97d40d4e79d">lock_type</a> == <a class="code" href="fsal__types_8h.html#aab76e308a0e07a7fcb4f4182ca3c098ca26e942e5ccc850086303fb166d2e1624">FSAL_LOCK_W</a>;
<a name="l00530"></a>00530       nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#aaf309e03ea917dfdb8f4ac39bc87541b">l_offset</a>  = conflict-&gt;<a class="code" href="structfsal__lock__param__t.html#a170a307abeec4fbabbde67143abae136">lock_start</a>;
<a name="l00531"></a>00531       nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#a21dc4250e1a214dc9e9ba16e2b2baf62">l_len</a>     = conflict-&gt;<a class="code" href="structfsal__lock__param__t.html#a7d0118133370d4d72c5644389316792e">lock_length</a>;
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533   <span class="keywordflow">else</span>
<a name="l00534"></a>00534     {
<a name="l00535"></a>00535       <span class="comment">/* For some reason, don&#39;t have an actual conflict,</span>
<a name="l00536"></a>00536 <span class="comment">       * just make it exclusive over the whole file</span>
<a name="l00537"></a>00537 <span class="comment">       * (which would conflict with any lock requested).</span>
<a name="l00538"></a>00538 <span class="comment">       */</span>
<a name="l00539"></a>00539       nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#a83df57c9c0da0a9a61b12669d00ae334">exclusive</a> = <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00540"></a>00540       nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#aaf309e03ea917dfdb8f4ac39bc87541b">l_offset</a>  = 0;
<a name="l00541"></a>00541       nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#a21dc4250e1a214dc9e9ba16e2b2baf62">l_len</a>     = 0;
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544   <span class="keywordflow">if</span>(holder != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00545"></a>00545     {
<a name="l00546"></a>00546       <span class="keywordflow">if</span>(holder-&gt;<a class="code" href="structstate__owner__t.html#a348f822632529b5aa366e84b1b5edeea">so_type</a> == STATE_LOCK_OWNER_NLM)
<a name="l00547"></a>00547         nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#a0df483360be4889f79e30644046c7c59">svid</a> = holder-&gt;<a class="code" href="structstate__owner__t.html#a2952e79d65755ad25235af0d306fb0d3">so_owner</a>.so_nlm_owner.so_nlm_svid;
<a name="l00548"></a>00548       <span class="keywordflow">else</span>
<a name="l00549"></a>00549         nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#a0df483360be4889f79e30644046c7c59">svid</a> = 0;
<a name="l00550"></a>00550       <a class="code" href="nlm__util_8c.html#a972c633e46423f4574e9ce5eee272fde">fill_netobj</a>(&amp;nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#adfc1cf99cfb5f5991b275d4f61558612">oh</a>,
<a name="l00551"></a>00551                   holder-&gt;<a class="code" href="structstate__owner__t.html#a233106d13bab3610f0f2d0df15279d1a">so_owner_val</a>,
<a name="l00552"></a>00552                   holder-&gt;<a class="code" href="structstate__owner__t.html#a6de6ac9ea5654d3604040a4e14344e1b">so_owner_len</a>);
<a name="l00553"></a>00553     }
<a name="l00554"></a>00554   <span class="keywordflow">else</span>
<a name="l00555"></a>00555     {
<a name="l00556"></a>00556       <span class="comment">/* If we don&#39;t have an NLM owner, not much we can do. */</span>
<a name="l00557"></a>00557       nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#a0df483360be4889f79e30644046c7c59">svid</a>       = 0;
<a name="l00558"></a>00558       <a class="code" href="nlm__util_8c.html#a972c633e46423f4574e9ce5eee272fde">fill_netobj</a>(&amp;nlm_holder-&gt;<a class="code" href="structnlm4__holder.html#adfc1cf99cfb5f5991b275d4f61558612">oh</a>,
<a name="l00559"></a>00559                   <a class="code" href="sal__data_8h.html#a54b5362efb0708c58ca5c23a0fe4bba5">unknown_owner</a>.<a class="code" href="structstate__owner__t.html#a233106d13bab3610f0f2d0df15279d1a">so_owner_val</a>,
<a name="l00560"></a>00560                   <a class="code" href="sal__data_8h.html#a54b5362efb0708c58ca5c23a0fe4bba5">unknown_owner</a>.<a class="code" href="structstate__owner__t.html#a6de6ac9ea5654d3604040a4e14344e1b">so_owner_len</a>);
<a name="l00561"></a>00561     }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563   <span class="comment">/* Release any lock owner reference passed back from SAL */</span>
<a name="l00564"></a>00564   <span class="keywordflow">if</span>(holder != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00565"></a>00565     <a class="code" href="sal__functions_8h.html#ad273c7b600f33f5410c03d89f56e8115">dec_state_owner_ref</a>(holder);
<a name="l00566"></a>00566 }
<a name="l00567"></a>00567 
<a name="l00568"></a><a class="code" href="nlm__util_8c.html#a89168dbcb2f177818efe71e6c309390a">00568</a> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0">nlm4_stats</a> <a class="code" href="nlm__util_8h.html#a89168dbcb2f177818efe71e6c309390a">nlm_convert_state_error</a>(<a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5b">state_status_t</a> status)
<a name="l00569"></a>00569 {
<a name="l00570"></a>00570   <span class="keywordflow">switch</span>(status)
<a name="l00571"></a>00571     {
<a name="l00572"></a>00572       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba95fdd6b02cbc698e4bd1a4eafe1661ff">STATE_SUCCESS</a>:        <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0afed82341001bda6fc720ec7f13b3d25f">NLM4_GRANTED</a>;
<a name="l00573"></a>00573       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5baca81ee684ca3b8423644fc1e8e5031fe">STATE_LOCK_CONFLICT</a>:  <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a76ba2dfbc21139b9cdb27e6de10d8954">NLM4_DENIED</a>;
<a name="l00574"></a>00574       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba26a225f20238097f55d92a5c7e086c18">STATE_STATE_CONFLICT</a>: <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a76ba2dfbc21139b9cdb27e6de10d8954">NLM4_DENIED</a>;
<a name="l00575"></a>00575       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba83de6e519398c6a0377256b70f1d58fc">STATE_MALLOC_ERROR</a>:   <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a4890fa941c7252655e07006b6093bb41">NLM4_DENIED_NOLOCKS</a>;
<a name="l00576"></a>00576       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5badd826dce2e924f2a4b52b320e2271546">STATE_LOCK_BLOCKED</a>:   <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0ab8f113d618995fb585549382aa146ce9">NLM4_BLOCKED</a>;
<a name="l00577"></a>00577       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5badfa8f02b483599feda40b8f65c456fe6">STATE_GRACE_PERIOD</a>:   <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a81247d672417402a14eae8437662ff29">NLM4_DENIED_GRACE_PERIOD</a>;
<a name="l00578"></a>00578       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba9338442986ba4476bc8aacc67bd1336f">STATE_LOCK_DEADLOCK</a>:  <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a0df15f093103da88b62ed5043875dbf8">NLM4_DEADLCK</a>;
<a name="l00579"></a>00579       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba4d227dd19a5c5e93e82f0e0cb7f197e6">STATE_READ_ONLY_FS</a>:   <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a8e03148e089eb87abd0a38a0de480487">NLM4_ROFS</a>;
<a name="l00580"></a>00580       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba3b6bf6508f079878391d80df01d93a9c">STATE_NOT_FOUND</a>:      <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a6232c8f919cdd3101da40d6b9e411e49">NLM4_STALE_FH</a>;
<a name="l00581"></a>00581       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba3b68e3c9ffcbb8462e00cdaf5c694bd4">STATE_FSAL_ESTALE</a>:    <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a6232c8f919cdd3101da40d6b9e411e49">NLM4_STALE_FH</a>;
<a name="l00582"></a>00582       <span class="keywordflow">case</span> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5bacca5802aef94008d1312ea935e1a9c29">STATE_FILE_BIG</a>:       <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0add8a9101f33863ee99255e96412dfa18">NLM4_FBIG</a>;
<a name="l00583"></a>00583       <span class="keywordflow">default</span>:                   <span class="keywordflow">return</span> <a class="code" href="nlm4_8h.html#aea86e167169c487eb17132a711d770d0a52187b76d65b4d0fa3c0921a3b272690">NLM4_FAILED</a>;
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00587"></a><a class="code" href="nlm__util_8c.html#a2b937321c15f535f6ab0e077b532995e">00587</a> bool_t <a class="code" href="nlm__util_8h.html#a2b937321c15f535f6ab0e077b532995e">nlm_block_data_to_fsal_context</a>(<a class="code" href="sal__data_8h.html#a3035370b7b027cc7c897284b50c5fc12">state_block_data_t</a> * block_data,
<a name="l00588"></a>00588                                       <a class="code" href="structfsal__op__context____.html">fsal_op_context_t</a>  * <a class="code" href="nfs__file__content__flush__thread_8c.html#a60c0876d3df3d3a3aed3dab74d0f99c8">fsal_context</a>)
<a name="l00589"></a>00589 {
<a name="l00590"></a>00590   <a class="code" href="structexportlist____.html">exportlist_t</a>           * pexport = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00591"></a>00591   <span class="keywordtype">short</span>                    exportid;
<a name="l00592"></a>00592   <a class="code" href="structfsal__status____.html">fsal_status_t</a>            fsal_status;
<a name="l00593"></a>00593   state_nlm_block_data_t * nlm_block_data = &amp;block_data-&gt;sbd_block_data.sbd_nlm_block_data;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595   <span class="comment">/* Get export ID from handle */</span>
<a name="l00596"></a>00596   exportid = nlm4_FhandleToExportId(&amp;nlm_block_data-&gt;sbd_nlm_fh);
<a name="l00597"></a>00597 
<a name="l00598"></a>00598   <span class="comment">/* Get export matching export ID */</span>
<a name="l00599"></a>00599   <span class="keywordflow">if</span>(exportid &lt; 0 ||
<a name="l00600"></a>00600      (pexport = <a class="code" href="nfs__exports_8h.html#a7ccd248588595588755f71322288a8df">nfs_Get_export_by_id</a>(<a class="code" href="nfs__core_8h.html#aeb8fc46586993cf210777049fca03969">nfs_param</a>.<a class="code" href="structnfs__param____.html#ac8fc09bcd317cc133cd1f8b6b3478aa3">pexportlist</a>, exportid)) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l00601"></a>00601      (pexport-&gt;<a class="code" href="structexportlist____.html#a47d40937207a0fd8e67e191415ffef60">options</a> &amp; <a class="code" href="nfs__exports_8h.html#a8eb509796037d78741ada0471bd6625d">EXPORT_OPTION_NFSV3</a>) == 0)
<a name="l00602"></a>00602     {
<a name="l00603"></a>00603       <span class="comment">/* Reject the request for authentication reason (incompatible file handle) */</span>
<a name="l00604"></a>00604       <span class="keywordflow">if</span>(<a class="code" href="log_8h.html#a3f69d7a1490bad51754c04781bff6f54">isInfo</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>))
<a name="l00605"></a>00605         {
<a name="l00606"></a>00606           <span class="keywordtype">char</span> dumpfh[1024];
<a name="l00607"></a>00607           <span class="keywordtype">char</span> *reason;
<a name="l00608"></a>00608           <span class="keywordtype">char</span> addrbuf[<a class="code" href="ganesha__rpc_8h.html#a9174d973fdbe2abdc1987d702b5b7d1a">SOCK_NAME_MAX</a>];
<a name="l00609"></a>00609           <a class="code" href="ganesha__rpc_8h.html#a798e3040dc5734e965e36b405958f984">sprint_sockaddr</a>(&amp;nlm_block_data-&gt;sbd_nlm_hostaddr,
<a name="l00610"></a>00610                           addrbuf,
<a name="l00611"></a>00611                           <span class="keyword">sizeof</span>(addrbuf));
<a name="l00612"></a>00612           <span class="keywordflow">if</span>(exportid &lt; 0)
<a name="l00613"></a>00613             reason = <span class="stringliteral">&quot;has badly formed handle&quot;</span>;
<a name="l00614"></a>00614           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pexport == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00615"></a>00615             reason = <span class="stringliteral">&quot;has invalid export&quot;</span>;
<a name="l00616"></a>00616           <span class="keywordflow">else</span>
<a name="l00617"></a>00617             reason = <span class="stringliteral">&quot;V3 not allowed on this export&quot;</span>;
<a name="l00618"></a>00618           <a class="code" href="nfs__file__handle_8h.html#a51bd36d3e7fcc63f7f12569d7fd28901">sprint_fhandle_nlm</a>(dumpfh, &amp;nlm_block_data-&gt;sbd_nlm_fh);
<a name="l00619"></a>00619           <a class="code" href="log_8h.html#a3cf3c22fac6bb9871e25007551caeb13">LogMajor</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00620"></a>00620                    <span class="stringliteral">&quot;NLM4 granted lock from host %s %s, FH=%s&quot;</span>,
<a name="l00621"></a>00621                    addrbuf, reason, dumpfh);
<a name="l00622"></a>00622         }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624       <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00628"></a>00628                <span class="stringliteral">&quot;Found export entry for dirname=%s as exportid=%d&quot;</span>,
<a name="l00629"></a>00629                pexport-&gt;<a class="code" href="structexportlist____.html#aed69da9ea94f07652e30b8393311c025">dirname</a>, pexport-&gt;<a class="code" href="structexportlist____.html#a6cdf6b3326db83e0af2976000c374b12">id</a>);
<a name="l00630"></a>00630   <span class="comment">/* Build the credentials */</span>
<a name="l00631"></a>00631   fsal_status = <a class="code" href="fsal__glue_8c.html#ac9d7f36333e895d045a6e484589fda10">FSAL_GetClientContext</a>(fsal_context,
<a name="l00632"></a>00632                                       &amp;pexport-&gt;<a class="code" href="structexportlist____.html#abbe82cf495253f375cd7f4bf47406aca">FS_export_context</a>,
<a name="l00633"></a>00633                                       block_data-&gt;sbd_credential.user,
<a name="l00634"></a>00634                                       block_data-&gt;sbd_credential.group,
<a name="l00635"></a>00635                                       block_data-&gt;sbd_credential.alt_groups,
<a name="l00636"></a>00636                                       block_data-&gt;sbd_credential.nbgroups);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638   <span class="keywordflow">if</span>(<a class="code" href="fsal_8h.html#a7c2a97ec2fa552dea8e497c7dd8a2b86">FSAL_IS_ERROR</a>(fsal_status))
<a name="l00639"></a>00639     {
<a name="l00640"></a>00640       <a class="code" href="log_8h.html#a014a663a4d20c38e82ab3f35298667e8">LogEvent</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00641"></a>00641                <span class="stringliteral">&quot;Could not get credentials for (uid=%d,gid=%d), fsal error=(%d,%d)&quot;</span>,
<a name="l00642"></a>00642                block_data-&gt;sbd_credential.user,
<a name="l00643"></a>00643                block_data-&gt;sbd_credential.group,
<a name="l00644"></a>00644                fsal_status.<a class="code" href="structfsal__status____.html#ab12ffb4b1b65891a5dd5939fc7d543de">major</a>, fsal_status.<a class="code" href="structfsal__status____.html#ac260418be3f1105f31b1663083903e83">minor</a>);
<a name="l00645"></a>00645       <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00646"></a>00646     }
<a name="l00647"></a>00647   <span class="keywordflow">else</span>
<a name="l00648"></a>00648     <a class="code" href="log_8h.html#aa7aee8ec65b5baafb430f8d2a7588d53">LogDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00649"></a>00649              <span class="stringliteral">&quot;FSAL Cred acquired for (uid=%d,gid=%d)&quot;</span>,
<a name="l00650"></a>00650              block_data-&gt;sbd_credential.user,
<a name="l00651"></a>00651              block_data-&gt;sbd_credential.group);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653   <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a><a class="code" href="nlm__util_8c.html#ab89e708c088abb9173e22894883ab6b7">00656</a> <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5b">state_status_t</a> <a class="code" href="nlm__util_8h.html#ab89e708c088abb9173e22894883ab6b7">nlm_granted_callback</a>(<a class="code" href="structcache__entry__t.html" title="Represents a cached inode.">cache_entry_t</a>        * pentry,
<a name="l00657"></a>00657                                     <a class="code" href="structstate__lock__entry__t.html">state_lock_entry_t</a>   * lock_entry,
<a name="l00658"></a>00658                                     <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5b">state_status_t</a>       * pstatus)
<a name="l00659"></a>00659 {
<a name="l00660"></a>00660   <a class="code" href="structfsal__op__context____.html">fsal_op_context_t</a>        <a class="code" href="nfs__file__content__flush__thread_8c.html#a60c0876d3df3d3a3aed3dab74d0f99c8">fsal_context</a>, *pcontext = &amp;<a class="code" href="nfs__file__content__flush__thread_8c.html#a60c0876d3df3d3a3aed3dab74d0f99c8">fsal_context</a>;
<a name="l00661"></a>00661   <a class="code" href="sal__data_8h.html#a3035370b7b027cc7c897284b50c5fc12">state_block_data_t</a>     * block_data     = lock_entry-&gt;<a class="code" href="structstate__lock__entry__t.html#abf169f4225e3c1887d46f426afbb3de5">sle_block_data</a>;
<a name="l00662"></a>00662   state_nlm_block_data_t * nlm_block_data = &amp;block_data-&gt;sbd_block_data.sbd_nlm_block_data;
<a name="l00663"></a>00663   state_cookie_entry_t   * cookie_entry = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00664"></a>00664   <a class="code" href="sal__data_8h.html#abf159a29a191e59f176897b998c40b7e">state_async_queue_t</a>    * arg;
<a name="l00665"></a>00665   <a class="code" href="structnlm4__testargs.html">nlm4_testargs</a>          * inarg;
<a name="l00666"></a>00666   state_nlm_owner_t      * nlm_grant_owner  = &amp;lock_entry-&gt;<a class="code" href="structstate__lock__entry__t.html#adf890d0e8663092452500dd22eac76e3">sle_owner</a>-&gt;<a class="code" href="structstate__owner__t.html#a2952e79d65755ad25235af0d306fb0d3">so_owner</a>.so_nlm_owner;
<a name="l00667"></a>00667   state_nlm_client_t     * nlm_grant_client = nlm_grant_owner-&gt;so_client;
<a name="l00668"></a>00668   <a class="code" href="structgranted__cookie__t.html">granted_cookie_t</a>         nlm_grant_cookie;
<a name="l00669"></a>00669   <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5b">state_status_t</a>           dummy_status;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671   <span class="keywordflow">if</span>(<a class="code" href="nlm__util_8h.html#a2b937321c15f535f6ab0e077b532995e">nlm_block_data_to_fsal_context</a>(block_data, &amp;fsal_context) != <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l00672"></a>00672     {
<a name="l00673"></a>00673       *pstatus = <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5bad9f0a73bb6dfcc7334423be5606e0719">STATE_INCONSISTENT_ENTRY</a>;
<a name="l00674"></a>00674       <span class="keywordflow">return</span> *pstatus;
<a name="l00675"></a>00675     }
<a name="l00676"></a>00676 
<a name="l00677"></a>00677   arg = gsh_malloc(<span class="keyword">sizeof</span>(*arg));
<a name="l00678"></a>00678   <span class="keywordflow">if</span>(arg == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00679"></a>00679     {
<a name="l00680"></a>00680       <span class="comment">/* If we fail allocation the best is to delete the block entry</span>
<a name="l00681"></a>00681 <span class="comment">      * so that client can try again and get the lock. May be</span>
<a name="l00682"></a>00682 <span class="comment">      * by then we are able to allocate objects</span>
<a name="l00683"></a>00683 <span class="comment">      */</span>
<a name="l00684"></a>00684       *pstatus = <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba83de6e519398c6a0377256b70f1d58fc">STATE_MALLOC_ERROR</a>;
<a name="l00685"></a>00685       <span class="keywordflow">return</span> *pstatus;
<a name="l00686"></a>00686    }
<a name="l00687"></a>00687 
<a name="l00688"></a>00688   memset(arg, 0, <span class="keyword">sizeof</span>(*arg));
<a name="l00689"></a>00689 
<a name="l00690"></a>00690   <span class="comment">/* Get a cookie to use for this grant */</span>
<a name="l00691"></a>00691   <a class="code" href="nlm__util_8c.html#ae0a6a46e50b757e573ef896c086e84ca">next_granted_cookie</a>(&amp;nlm_grant_cookie);
<a name="l00692"></a>00692 
<a name="l00693"></a>00693   <span class="comment">/* Add a cookie to the blocked lock pending grant.</span>
<a name="l00694"></a>00694 <span class="comment">   * It will also request lock from FSAL.</span>
<a name="l00695"></a>00695 <span class="comment">   * Could return STATE_LOCK_BLOCKED because FSAL would have had to block.</span>
<a name="l00696"></a>00696 <span class="comment">   */</span>
<a name="l00697"></a>00697   <span class="keywordflow">if</span>(state_add_grant_cookie(pentry,
<a name="l00698"></a>00698                             pcontext,
<a name="l00699"></a>00699                             &amp;nlm_grant_cookie,
<a name="l00700"></a>00700                             <span class="keyword">sizeof</span>(nlm_grant_cookie),
<a name="l00701"></a>00701                             lock_entry,
<a name="l00702"></a>00702                             &amp;cookie_entry,
<a name="l00703"></a>00703                             pstatus) != <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba95fdd6b02cbc698e4bd1a4eafe1661ff">STATE_SUCCESS</a>)
<a name="l00704"></a>00704     {
<a name="l00705"></a>00705       <a class="code" href="nlm__util_8c.html#a6761d182b82fb7f4278a5992b66413ee">free_grant_arg</a>(arg);
<a name="l00706"></a>00706       <span class="keywordflow">return</span> *pstatus;
<a name="l00707"></a>00707     }
<a name="l00708"></a>00708 
<a name="l00709"></a>00709   <span class="comment">/* Fill in the arguments for the NLMPROC4_GRANTED_MSG call */</span>
<a name="l00710"></a>00710   <a class="code" href="nlm__owner_8c.html#a3c04360a905c140c885a9c08fc21bc30">inc_nlm_client_ref</a>(nlm_grant_client);
<a name="l00711"></a>00711   arg-&gt;state_async_func = nlm4_send_grant_msg;
<a name="l00712"></a>00712   arg-&gt;state_async_data.state_nlm_async_data.nlm_async_host = nlm_grant_client;
<a name="l00713"></a>00713   arg-&gt;state_async_data.state_nlm_async_data.nlm_async_key  = cookie_entry;
<a name="l00714"></a>00714   inarg = &amp;arg-&gt;state_async_data.state_nlm_async_data.nlm_async_args.nlm_async_grant;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716   <span class="keywordflow">if</span>(!<a class="code" href="nlm__util_8h.html#aa068a5d0b5653358d77d3f9d3929ecb1">copy_netobj</a>(&amp;inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#a0c69f88dad1f9625f3b2c16676242548">fh</a>, &amp;nlm_block_data-&gt;sbd_nlm_fh))
<a name="l00717"></a>00717     <span class="keywordflow">goto</span> grant_fail_malloc;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719   <span class="keywordflow">if</span>(!<a class="code" href="nlm__util_8c.html#a972c633e46423f4574e9ce5eee272fde">fill_netobj</a>(&amp;inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#af1657853a7e83dd2e24d3f873f37d0dc">oh</a>,
<a name="l00720"></a>00720                   lock_entry-&gt;<a class="code" href="structstate__lock__entry__t.html#adf890d0e8663092452500dd22eac76e3">sle_owner</a>-&gt;<a class="code" href="structstate__owner__t.html#a233106d13bab3610f0f2d0df15279d1a">so_owner_val</a>,
<a name="l00721"></a>00721                   lock_entry-&gt;<a class="code" href="structstate__lock__entry__t.html#adf890d0e8663092452500dd22eac76e3">sle_owner</a>-&gt;<a class="code" href="structstate__owner__t.html#a6de6ac9ea5654d3604040a4e14344e1b">so_owner_len</a>))
<a name="l00722"></a>00722     <span class="keywordflow">goto</span> grant_fail_malloc;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724   <span class="keywordflow">if</span>(!<a class="code" href="nlm__util_8c.html#a972c633e46423f4574e9ce5eee272fde">fill_netobj</a>(&amp;inarg-&gt;<a class="code" href="structnlm4__testargs.html#ad61986f6cf3bc35582c9f857b85066c6">cookie</a>,
<a name="l00725"></a>00725                   (<span class="keywordtype">char</span> *) &amp;nlm_grant_cookie,
<a name="l00726"></a>00726                   <span class="keyword">sizeof</span>(nlm_grant_cookie)))
<a name="l00727"></a>00727     <span class="keywordflow">goto</span> grant_fail_malloc;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729   inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#a4a7680d60c065f560686b84fd0094b9c">caller_name</a> = gsh_strdup(nlm_grant_client-&gt;slc_nlm_caller_name);
<a name="l00730"></a>00730   <span class="keywordflow">if</span>(!inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#a4a7680d60c065f560686b84fd0094b9c">caller_name</a>)
<a name="l00731"></a>00731     <span class="keywordflow">goto</span> grant_fail_malloc;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733   inarg-&gt;<a class="code" href="structnlm4__testargs.html#a9d55590633028bed5f7aa0b6d77bad44">exclusive</a>      = lock_entry-&gt;<a class="code" href="structstate__lock__entry__t.html#a29f54c1985776b109a0d073e2c091273">sle_lock</a>.<a class="code" href="structfsal__lock__param__t.html#af92333e93eb13a24565eb97d40d4e79d">lock_type</a> == <a class="code" href="fsal__types_8h.html#aab76e308a0e07a7fcb4f4182ca3c098ca26e942e5ccc850086303fb166d2e1624">FSAL_LOCK_W</a>;
<a name="l00734"></a>00734   inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#a30219f792f5964734898c45eb06dadb4">svid</a>     = nlm_grant_owner-&gt;so_nlm_svid;
<a name="l00735"></a>00735   inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#a93ab098e4b6acda45c94268e41cf4821">l_offset</a> = lock_entry-&gt;<a class="code" href="structstate__lock__entry__t.html#a29f54c1985776b109a0d073e2c091273">sle_lock</a>.<a class="code" href="structfsal__lock__param__t.html#a170a307abeec4fbabbde67143abae136">lock_start</a>;
<a name="l00736"></a>00736   inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#a41846f08233c10b261f95e7026c1d714">l_len</a>    = lock_entry-&gt;<a class="code" href="structstate__lock__entry__t.html#a29f54c1985776b109a0d073e2c091273">sle_lock</a>.<a class="code" href="structfsal__lock__param__t.html#a7d0118133370d4d72c5644389316792e">lock_length</a>;
<a name="l00737"></a>00737   <span class="keywordflow">if</span>(<a class="code" href="log_8h.html#ac778c7aeca566b747dd5bb1baecb6316">isDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>))
<a name="l00738"></a>00738     {
<a name="l00739"></a>00739       <span class="keywordtype">char</span> buffer[1024];
<a name="l00740"></a>00740 
<a name="l00741"></a>00741       <a class="code" href="nlm__util_8h.html#a2a37ae5a8f8501d12c0abad1456fefee">netobj_to_string</a>(&amp;inarg-&gt;<a class="code" href="structnlm4__testargs.html#ad61986f6cf3bc35582c9f857b85066c6">cookie</a>, buffer, <span class="keyword">sizeof</span>(buffer));
<a name="l00742"></a>00742 
<a name="l00743"></a>00743       <a class="code" href="log_8h.html#aa7aee8ec65b5baafb430f8d2a7588d53">LogDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00744"></a>00744                <span class="stringliteral">&quot;Sending GRANTED for arg=%p svid=%d start=%llx len=%llx cookie=%s&quot;</span>,
<a name="l00745"></a>00745                arg, inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#a30219f792f5964734898c45eb06dadb4">svid</a>,
<a name="l00746"></a>00746                (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#a93ab098e4b6acda45c94268e41cf4821">l_offset</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>) inarg-&gt;<a class="code" href="structnlm4__testargs.html#a8d1641461217e030082238a54d97ad59">alock</a>.<a class="code" href="structnlm4__lock.html#a41846f08233c10b261f95e7026c1d714">l_len</a>,
<a name="l00747"></a>00747                buffer);
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750   <span class="comment">/* Now try to schedule NLMPROC4_GRANTED_MSG call */</span>
<a name="l00751"></a>00751   *pstatus = state_async_schedule(arg);
<a name="l00752"></a>00752 
<a name="l00753"></a>00753   <span class="keywordflow">if</span>(*pstatus != <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba95fdd6b02cbc698e4bd1a4eafe1661ff">STATE_SUCCESS</a>)
<a name="l00754"></a>00754     <span class="keywordflow">goto</span> grant_fail;
<a name="l00755"></a>00755 
<a name="l00756"></a>00756   <span class="keywordflow">return</span> *pstatus;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758  grant_fail_malloc:
<a name="l00759"></a>00759   *pstatus = <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba83de6e519398c6a0377256b70f1d58fc">STATE_MALLOC_ERROR</a>;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761  grant_fail:
<a name="l00762"></a>00762 
<a name="l00763"></a>00763   <span class="comment">/* Something went wrong after we added a grant cookie, need to clean up */</span>
<a name="l00764"></a>00764 
<a name="l00765"></a>00765   <a class="code" href="nlm__owner_8c.html#a8ec5ffad0b53808d66220669827b1a9b">dec_nlm_client_ref</a>(nlm_grant_client);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767   <span class="comment">/* Clean up NLMPROC4_GRANTED_MSG arguments */</span>
<a name="l00768"></a>00768   <a class="code" href="nlm__util_8c.html#a6761d182b82fb7f4278a5992b66413ee">free_grant_arg</a>(arg);
<a name="l00769"></a>00769 
<a name="l00770"></a>00770   <span class="comment">/* Cancel the pending grant to release the cookie */</span>
<a name="l00771"></a>00771   <span class="keywordflow">if</span>(state_cancel_grant(pcontext,
<a name="l00772"></a>00772                         cookie_entry,
<a name="l00773"></a>00773                         &amp;dummy_status) != <a class="code" href="sal__data_8h.html#abaefb535451d8c22b6d4074d63effd5ba95fdd6b02cbc698e4bd1a4eafe1661ff">STATE_SUCCESS</a>)
<a name="l00774"></a>00774     {
<a name="l00775"></a>00775       <span class="comment">/* Not much we can do other than log that something bad happened. */</span>
<a name="l00776"></a>00776       <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a9e7a98540a985631f5e8c7fdfd175720">COMPONENT_NLM</a>,
<a name="l00777"></a>00777               <span class="stringliteral">&quot;Unable to clean up GRANTED lock after error&quot;</span>);
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780   <span class="keywordflow">return</span> *pstatus;
<a name="l00781"></a>00781 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 21 2012 for nfs-ganesha by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
