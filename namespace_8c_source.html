<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>nfs-ganesha: namespace.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nfs-ganesha&#160;<span id="projectnumber">1.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>namespace.c</h1>  </div>
</div>
<div class="contents">
<a href="namespace_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * \brief Manage a namespace for path&lt;-&gt;inode association</span>
<a name="l00003"></a>00003 <span class="comment"> */</span>
<a name="l00004"></a>00004 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#endif</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="namespace_8h.html">namespace.h</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;RW_Lock.h&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;HashTable.h&quot;</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="comment">/*-----------------------------------------------------</span>
<a name="l00018"></a>00018 <span class="comment"> *              Type definitions</span>
<a name="l00019"></a>00019 <span class="comment"> *-----------------------------------------------------*/</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="comment">/* We provide 2 associations:</span>
<a name="l00022"></a>00022 <span class="comment"> * Lookup: (parent,name) -&gt; fsnode</span>
<a name="l00023"></a>00023 <span class="comment"> * Path:   inode-&gt;fsnode with list of (parent,name)</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="struct____inode____.html">00026</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct____inode____.html">__inode__</a>
<a name="l00027"></a>00027 {
<a name="l00028"></a><a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">00028</a>   ino_t <a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>;
<a name="l00029"></a><a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">00029</a>   dev_t <a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>;
<a name="l00030"></a><a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">00030</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>;
<a name="l00031"></a>00031 } <a class="code" href="namespace_8c.html#acf5598ae0157d91e9087f695777b4468">inode_t</a>;
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">/* - key for lookup hash table</span>
<a name="l00034"></a>00034 <span class="comment"> * - it is also used to keep a list of parent/name of an entry</span>
<a name="l00035"></a>00035 <span class="comment"> */</span>
<a name="l00036"></a><a class="code" href="struct____lookup__peer____.html">00036</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct____lookup__peer____.html">__lookup_peer__</a>
<a name="l00037"></a>00037 {
<a name="l00038"></a><a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">00038</a>   <a class="code" href="struct____inode____.html">inode_t</a> <a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>;
<a name="l00039"></a><a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">00039</a>   <span class="keywordtype">char</span> <a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>[<a class="code" href="fsal__types_8h.html#ad026c47acb9681dca70066e06a9e6b50">FSAL_MAX_NAME_LEN</a>];
<a name="l00040"></a>00040 
<a name="l00041"></a>00041   <span class="comment">/* used for pool chaining into parent list and pool allocation */</span>
<a name="l00042"></a><a class="code" href="struct____lookup__peer____.html#a800a90dbe883194d793d5c1117be4755">00042</a>   <span class="keyword">struct </span><a class="code" href="struct____lookup__peer____.html">__lookup_peer__</a> *<a class="code" href="struct____lookup__peer____.html#a800a90dbe883194d793d5c1117be4755">p_next</a>;
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 } <a class="code" href="namespace_8c.html#a4d898100989e5bb2c277ee39e8bda980">lookup_peer_t</a>;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">/* - data for lookup hash table is a fsnode ;</span>
<a name="l00047"></a>00047 <span class="comment"> * - key for path hash table is an inode_t ;</span>
<a name="l00048"></a>00048 <span class="comment"> * - data for path hash table is a fsnode.</span>
<a name="l00049"></a>00049 <span class="comment"> */</span>
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="struct____fsnode____.html">00051</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct____fsnode____.html">__fsnode__</a>
<a name="l00052"></a>00052 {
<a name="l00053"></a><a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">00053</a>   <a class="code" href="struct____inode____.html">inode_t</a> <a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>;
<a name="l00054"></a><a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">00054</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a>;       
<a name="l00057"></a><a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">00057</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">n_children</a>;       
<a name="l00060"></a><a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">00060</a>   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062   <span class="comment">/* used for pool allocation */</span>
<a name="l00063"></a><a class="code" href="struct____fsnode____.html#aee93978aabc8c36c97132ee0221005e2">00063</a>   <span class="keyword">struct </span><a class="code" href="struct____fsnode____.html">__fsnode__</a> *<a class="code" href="struct____fsnode____.html#aee93978aabc8c36c97132ee0221005e2">p_next</a>;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 } <a class="code" href="namespace_8c.html#a857992393491b6a8eb9ba0574c34a318">fsnode_t</a>;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="comment">/*-----------------------------------------------------</span>
<a name="l00068"></a>00068 <span class="comment"> *                 Memory management</span>
<a name="l00069"></a>00069 <span class="comment"> *-----------------------------------------------------*/</span>
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="namespace_8c.html#a9a44be15a8a81e0dbfd2c780a2cef557">00071</a> <a class="code" href="structpool.html" title="Type representing a pool.">pool_t</a> <a class="code" href="namespace_8c.html#a9a44be15a8a81e0dbfd2c780a2cef557">node_pool</a>;
<a name="l00072"></a>00072 <span class="keyword">static</span> pthread_mutex_t node_pool_mutex = PTHREAD_MUTEX_INITIALIZER;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="keyword">static</span> <a class="code" href="struct____fsnode____.html">fsnode_t</a> *node_alloc()
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_new;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   <a class="code" href="common__utils_8h.html#a13190861330e48fe885da6b2671876a9">P</a>(node_pool_mutex);
<a name="l00079"></a>00079   p_new = pool_add(node_pool);
<a name="l00080"></a>00080   <a class="code" href="common__utils_8h.html#a5a9b6f8030959507eee365b226d63b00">V</a>(node_pool_mutex);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082   memset(p_new, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct____fsnode____.html">fsnode_t</a>));
<a name="l00083"></a>00083 
<a name="l00084"></a>00084   <span class="keywordflow">return</span> p_new;
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="keyword">static</span> <span class="keywordtype">void</span> node_free(<a class="code" href="struct____fsnode____.html">fsnode_t</a> * p_node)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089   memset(p_node, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct____fsnode____.html">fsnode_t</a>));
<a name="l00090"></a>00090 
<a name="l00091"></a>00091   <a class="code" href="common__utils_8h.html#a13190861330e48fe885da6b2671876a9">P</a>(node_pool_mutex);
<a name="l00092"></a>00092   pool_free(node_pool, p_node);
<a name="l00093"></a>00093   <a class="code" href="common__utils_8h.html#a5a9b6f8030959507eee365b226d63b00">V</a>(node_pool_mutex);
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="comment">/* pool of lookup peers */</span>
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="namespace_8c.html#a49e1d2279c3dada5b4fc1e8d5c7443d9">00098</a> <a class="code" href="structpool.html" title="Type representing a pool.">pool_t</a> <a class="code" href="namespace_8c.html#a49e1d2279c3dada5b4fc1e8d5c7443d9">peer_pool</a>;
<a name="l00099"></a>00099 <span class="keyword">static</span> pthread_mutex_t peer_pool_mutex = PTHREAD_MUTEX_INITIALIZER;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="keyword">static</span> <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *peer_alloc()
<a name="l00102"></a>00102 {
<a name="l00103"></a>00103   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_new;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105   <a class="code" href="common__utils_8h.html#a13190861330e48fe885da6b2671876a9">P</a>(peer_pool_mutex);
<a name="l00106"></a>00106   p_new = pool_alloc(peer_pool, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00107"></a>00107   <a class="code" href="common__utils_8h.html#a5a9b6f8030959507eee365b226d63b00">V</a>(peer_pool_mutex);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109   memset(p_new, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a>));
<a name="l00110"></a>00110 
<a name="l00111"></a>00111   <span class="keywordflow">return</span> p_new;
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="keyword">static</span> <span class="keywordtype">void</span> peer_free(<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> * p_peer)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116   memset(p_peer, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a>));
<a name="l00117"></a>00117 
<a name="l00118"></a>00118   <a class="code" href="common__utils_8h.html#a13190861330e48fe885da6b2671876a9">P</a>(peer_pool_mutex);
<a name="l00119"></a>00119   pool_free(peer_pool, p_peer);
<a name="l00120"></a>00120   <a class="code" href="common__utils_8h.html#a5a9b6f8030959507eee365b226d63b00">V</a>(peer_pool_mutex);
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 <span class="comment">/*----------------------------------------------------</span>
<a name="l00124"></a>00124 <span class="comment"> *                  hash tables</span>
<a name="l00125"></a>00125 <span class="comment"> *----------------------------------------------------*/</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="comment">/* functions for hashing/comparing lookup peers */</span>
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash_peer_idx(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_conf, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key);
<a name="l00130"></a>00130 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash_peer_rbt(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_conf, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key);
<a name="l00131"></a>00131 <span class="keyword">static</span> <span class="keywordtype">int</span> cmp_peers(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key1, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key2);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="comment">/* functions for hashing/comparing inode numbers */</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash_ino_idx(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_conf, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key);
<a name="l00136"></a>00136 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash_ino_rbt(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_conf, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key);
<a name="l00137"></a>00137 <span class="keyword">static</span> <span class="keywordtype">int</span> cmp_inodes(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key1, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key2);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="comment">/* display functions */</span>
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="keyword">static</span> <span class="keywordtype">int</span> print_lookup_peer(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_val, <span class="keywordtype">char</span> *outbuff);
<a name="l00142"></a>00142 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="FSAL__POSIX_2fsal__xattrs_8c.html#a444546a1e16e048967340326f3a919ea">print_inode</a>(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_val, <span class="keywordtype">char</span> *outbuff);
<a name="l00143"></a>00143 <span class="keyword">static</span> <span class="keywordtype">int</span> print_fsnode(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_val, <span class="keywordtype">char</span> *outbuff);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="comment">/* configuration for lookup hashtable</span>
<a name="l00146"></a>00146 <span class="comment"> * TODO: externize those parameters</span>
<a name="l00147"></a>00147 <span class="comment"> */</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="keyword">static</span> <a class="code" href="structhash__param.html">hash_parameter_t</a> lookup_hash_config = {
<a name="l00150"></a>00150   .<a class="code" href="structhash__param.html#ac835083bd319700097c852ab29852d69">index_size</a> = 877,
<a name="l00151"></a>00151   .alphabet_length = 26,
<a name="l00152"></a>00152   .hash_func_key = hash_peer_idx,
<a name="l00153"></a>00153   .hash_func_rbt = hash_peer_rbt,
<a name="l00154"></a>00154   .compare_key = cmp_peers,
<a name="l00155"></a>00155   .key_to_str = print_lookup_peer,
<a name="l00156"></a>00156   .val_to_str = print_fsnode,
<a name="l00157"></a>00157   .ht_name = <span class="stringliteral">&quot;FUSE Lookup Cache&quot;</span>,
<a name="l00158"></a>00158   .flags = <a class="code" href="group__HTStructs.html#ga9328d32743f91cb2c22541ad45bf58bc">HT_FLAG_CACHE</a>,
<a name="l00159"></a>00159   .ht_log_component = <a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>
<a name="l00160"></a>00160 };
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="comment">/* configuration for inode-&gt;fsnode hashtable</span>
<a name="l00163"></a>00163 <span class="comment"> * TODO: externize those parameters</span>
<a name="l00164"></a>00164 <span class="comment"> */</span>
<a name="l00165"></a>00165 <span class="keyword">static</span> <a class="code" href="structhash__param.html">hash_parameter_t</a> nodes_hash_config = {
<a name="l00166"></a>00166   .<a class="code" href="structhash__param.html#ac835083bd319700097c852ab29852d69">index_size</a> = 877,
<a name="l00167"></a>00167   .alphabet_length = 10,
<a name="l00168"></a>00168   .hash_func_key = hash_ino_idx,
<a name="l00169"></a>00169   .hash_func_rbt = hash_ino_rbt,
<a name="l00170"></a>00170   .compare_key = cmp_inodes,
<a name="l00171"></a>00171   .key_to_str = <a class="code" href="FSAL__POSIX_2fsal__xattrs_8c.html#a444546a1e16e048967340326f3a919ea">print_inode</a>,
<a name="l00172"></a>00172   .val_to_str = print_fsnode,
<a name="l00173"></a>00173   .ht_name = <span class="stringliteral">&quot;FUSE fsnode Cache&quot;</span>,
<a name="l00174"></a>00174   .flags = <a class="code" href="group__HTStructs.html#ga9328d32743f91cb2c22541ad45bf58bc">HT_FLAG_CACHE</a>,
<a name="l00175"></a>00175   .ht_log_component = <a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>
<a name="l00176"></a>00176 };
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 <span class="comment">/* namespace structures */</span>
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="keyword">static</span> <a class="code" href="struct__RW__LOCK.html">rw_lock_t</a> ns_lock = { 0 };
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 <span class="keyword">static</span> <a class="code" href="structhash__table.html">hash_table_t</a> *lookup_hash = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00183"></a>00183 <span class="keyword">static</span> <a class="code" href="structhash__table.html">hash_table_t</a> *nodes_hash = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 <span class="comment">/*----------------------------------------------------</span>
<a name="l00186"></a>00186 <span class="comment"> *         hash tables functions implementation</span>
<a name="l00187"></a>00187 <span class="comment"> *----------------------------------------------------*/</span>
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment">/* functions for hashing/comparing lookup peers */</span>
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash_peer_idx(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_conf, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash;
<a name="l00194"></a>00194   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_peer = (<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *) p_key-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00195"></a>00195   <span class="keywordtype">char</span> *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>;
<a name="l00196"></a>00196 
<a name="l00197"></a>00197   hash = 1;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199   <span class="keywordflow">for</span>(<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a> = p_peer-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>; *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a> != <span class="charliteral">&#39;\0&#39;</span>; <a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>++)
<a name="l00200"></a>00200     hash =
<a name="l00201"></a>00201         ((hash * p_conf-&gt;<a class="code" href="structhash__param.html#af2b84e6a1d8462616014f5fc691e2611">alphabet_length</a>) + (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(*name)) % p_conf-&gt;<a class="code" href="structhash__param.html#ac835083bd319700097c852ab29852d69">index_size</a>;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   hash = (hash + (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)p_peer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>) % p_conf-&gt;<a class="code" href="structhash__param.html#ac835083bd319700097c852ab29852d69">index_size</a>;
<a name="l00204"></a>00204   hash = (hash ^ (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)p_peer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>) % p_conf-&gt;<a class="code" href="structhash__param.html#ac835083bd319700097c852ab29852d69">index_size</a>;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206   <span class="keywordflow">return</span> hash;
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash_peer_rbt(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_conf, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash;
<a name="l00212"></a>00212   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_peer = (<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *) p_key-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00213"></a>00213   <span class="keywordtype">char</span> *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215   hash = 1;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217   <span class="keywordflow">for</span>(<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a> = p_peer-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>; *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a> != <span class="charliteral">&#39;\0&#39;</span>; <a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>++)
<a name="l00218"></a>00218     hash = ((hash &lt;&lt; 5) - hash + (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(*name));
<a name="l00219"></a>00219 
<a name="l00220"></a>00220   <span class="keywordflow">return</span> (hash ^ (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)p_peer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> ^ (<span class="keywordtype">unsigned</span> long)p_peer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>);
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 <span class="keyword">static</span> <span class="keywordtype">int</span> cmp_peers(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key1, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key2)
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_peer1 = (<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *) p_key1-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00226"></a>00226   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_peer2 = (<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *) p_key2-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="comment">/* compare parent inode, then name */</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230   <span class="keywordflow">if</span>((p_peer1-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> &gt; p_peer2-&gt;parent.inum)
<a name="l00231"></a>00231      || (p_peer1-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> &gt; p_peer2-&gt;parent.dev))
<a name="l00232"></a>00232     <span class="keywordflow">return</span> 1;
<a name="l00233"></a>00233   <span class="keywordflow">else</span> <span class="keywordflow">if</span>((p_peer1-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> &lt; p_peer2-&gt;parent.inum)
<a name="l00234"></a>00234           || (p_peer1-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> &lt; p_peer2-&gt;parent.dev))
<a name="l00235"></a>00235     <span class="keywordflow">return</span> -1;
<a name="l00236"></a>00236   <span class="keywordflow">else</span>                          <span class="comment">/* same parent */</span>
<a name="l00237"></a>00237     <span class="keywordflow">return</span> strncmp(p_peer1-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>, p_peer2-&gt;name, <a class="code" href="fsal__types_8h.html#ad026c47acb9681dca70066e06a9e6b50">FSAL_MAX_NAME_LEN</a>);
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="comment">/* functions for hashing/comparing inode numbers */</span>
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash_ino_idx(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_conf, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash;
<a name="l00246"></a>00246   <a class="code" href="struct____inode____.html">inode_t</a> *p_ino = (<a class="code" href="struct____inode____.html">inode_t</a> *) p_key-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248   hash =
<a name="l00249"></a>00249       (p_conf-&gt;<a class="code" href="structhash__param.html#af2b84e6a1d8462616014f5fc691e2611">alphabet_length</a> + ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)p_ino-&gt;<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> ^ (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)p_ino-&gt;<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>));
<a name="l00250"></a>00250   <span class="keywordflow">return</span> (3 * hash + 1999) % p_conf-&gt;<a class="code" href="structhash__param.html#ac835083bd319700097c852ab29852d69">index_size</a>;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash_ino_rbt(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_conf, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key)
<a name="l00255"></a>00255 {
<a name="l00256"></a>00256   <a class="code" href="struct____inode____.html">inode_t</a> *p_ino = (<a class="code" href="struct____inode____.html">inode_t</a> *) p_key-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258   return (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(p_ino-&gt;<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> ^ (3 * (p_ino-&gt;<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> + 1)));
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 <span class="keyword">static</span> <span class="keywordtype">int</span> cmp_inodes(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key1, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_key2)
<a name="l00262"></a>00262 {
<a name="l00263"></a>00263   <a class="code" href="struct____inode____.html">inode_t</a> *p_ino1 = (<a class="code" href="struct____inode____.html">inode_t</a> *) p_key1-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00264"></a>00264   <a class="code" href="struct____inode____.html">inode_t</a> *p_ino2 = (<a class="code" href="struct____inode____.html">inode_t</a> *) p_key2-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266   <span class="keywordflow">if</span>((p_ino1-&gt;<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> &gt; p_ino2-&gt;inum) || (p_ino1-&gt;<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> &gt; p_ino2-&gt;dev))
<a name="l00267"></a>00267     <span class="keywordflow">return</span> 1;
<a name="l00268"></a>00268   <span class="keywordflow">else</span> <span class="keywordflow">if</span>((p_ino1-&gt;<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> &lt; p_ino2-&gt;inum) || (p_ino1-&gt;<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> &lt; p_ino2-&gt;dev))
<a name="l00269"></a>00269     <span class="keywordflow">return</span> -1;
<a name="l00270"></a>00270   <span class="keywordflow">else</span>
<a name="l00271"></a>00271     <span class="keywordflow">return</span> 0;
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="comment">/* display functions */</span>
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="keyword">static</span> <span class="keywordtype">int</span> print_lookup_peer(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_val, <span class="keywordtype">char</span> *outbuff)
<a name="l00277"></a>00277 {
<a name="l00278"></a>00278   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_peer = (<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *) p_val-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00279"></a>00279   <span class="keywordflow">return</span> sprintf(outbuff, <span class="stringliteral">&quot;parent:%lX.%lu, name:%s&quot;</span>,
<a name="l00280"></a>00280                  (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span>)p_peer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>,
<a name="l00281"></a>00281                  (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> int)p_peer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, p_peer-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>);
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="FSAL__POSIX_2fsal__xattrs_8c.html#a444546a1e16e048967340326f3a919ea">print_inode</a>(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_val, <span class="keywordtype">char</span> *outbuff)
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286   <a class="code" href="struct____inode____.html">inode_t</a> *p_ino = (<a class="code" href="struct____inode____.html">inode_t</a> *) p_val-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00287"></a>00287   <span class="keywordflow">return</span> sprintf(outbuff, <span class="stringliteral">&quot;device:%lX inode:%lu (gen:%u)&quot;</span>,
<a name="l00288"></a>00288                  (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span>)p_ino-&gt;<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> int)p_ino-&gt;<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>,
<a name="l00289"></a>00289                  p_ino-&gt;<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>);
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 <span class="keyword">static</span> <span class="keywordtype">int</span> print_fsnode(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * p_val, <span class="keywordtype">char</span> *outbuff)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_node = (<a class="code" href="struct____fsnode____.html">fsnode_t</a> *) p_val-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296   <span class="keywordflow">if</span>(p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>)
<a name="l00297"></a>00297     <span class="keywordflow">return</span> sprintf(outbuff,
<a name="l00298"></a>00298                    <span class="stringliteral">&quot;device:%lX inode:%lu (gen:%u), linkcount:%u, children:%u, first_parent:%lX.%lu, name=%s&quot;</span>,
<a name="l00299"></a>00299                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span>)p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>,
<a name="l00300"></a>00300                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span>)p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>,
<a name="l00301"></a>00301                    p_node-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">n_children</a>,
<a name="l00302"></a>00302                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span>)p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>,
<a name="l00303"></a>00303                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span>)p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>,
<a name="l00304"></a>00304                    p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>);
<a name="l00305"></a>00305   <span class="keywordflow">else</span>
<a name="l00306"></a>00306     <span class="keywordflow">return</span> sprintf(outbuff,
<a name="l00307"></a>00307                    <span class="stringliteral">&quot;device:%lX inode:%lu (gen:%u), linkcount:%u, children:%u (no parent)&quot;</span>,
<a name="l00308"></a>00308                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span>)p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>,
<a name="l00309"></a>00309                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span>)p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>,
<a name="l00310"></a>00310                    p_node-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">n_children</a>);
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 <span class="comment">/*----------------------------------------------------</span>
<a name="l00315"></a>00315 <span class="comment"> *              hash tables helpers</span>
<a name="l00316"></a>00316 <span class="comment"> *----------------------------------------------------*/</span>
<a name="l00317"></a><a class="code" href="namespace_8c.html#a32c9f60f7ebc23dee8317ff3792568a8">00317</a> <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *<a class="code" href="namespace_8c.html#a32c9f60f7ebc23dee8317ff3792568a8">h_insert_new_lookup</a>(ino_t parent_inode,
<a name="l00318"></a>00318                                    dev_t parent_dev,
<a name="l00319"></a>00319                                    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> parent_gen,
<a name="l00320"></a>00320                                    <span class="keywordtype">char</span> *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>, <a class="code" href="struct____fsnode____.html">fsnode_t</a> * p_entry, <span class="keywordtype">int</span> overwrite)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00323"></a>00323   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffval;
<a name="l00324"></a>00324 
<a name="l00325"></a>00325   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_lpeer;
<a name="l00326"></a>00326   <span class="keywordtype">int</span> flag;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328   <span class="comment">/* alloc new peer */</span>
<a name="l00329"></a>00329   p_lpeer = peer_alloc();
<a name="l00330"></a>00330   <span class="keywordflow">if</span>(!p_lpeer)
<a name="l00331"></a>00331     <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333   p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> = parent_inode;
<a name="l00334"></a>00334   p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> = parent_dev;
<a name="l00335"></a>00335   p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a> = parent_gen;
<a name="l00336"></a>00336   strncpy(p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>, name, <a class="code" href="fsal__types_8h.html#ad026c47acb9681dca70066e06a9e6b50">FSAL_MAX_NAME_LEN</a>);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) p_lpeer;
<a name="l00339"></a>00339   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(*p_lpeer);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) p_entry;
<a name="l00342"></a>00342   buffval.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(*p_entry);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344   <span class="keywordflow">if</span>(overwrite)
<a name="l00345"></a>00345     flag = <a class="code" href="group__HTStructs.html#ggab434086e69de04e0dcb4a269625c83e3a9e77ddde96573f9eeed7263120e91aa4">HASHTABLE_SET_HOW_SET_OVERWRITE</a>;
<a name="l00346"></a>00346   <span class="keywordflow">else</span>
<a name="l00347"></a>00347     flag = <a class="code" href="group__HTStructs.html#ggab434086e69de04e0dcb4a269625c83e3a160497855cb35a4e7db24152027751cd">HASHTABLE_SET_HOW_SET_NO_OVERWRITE</a>;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349   <span class="keywordflow">if</span>(<a class="code" href="group__HTExported.html#ga613e404f11079c49c4020b659fe681cd" title="Set a pair (key,value) into the Hash Table.">HashTable_Test_And_Set</a>(lookup_hash, &amp;buffkey, &amp;buffval, flag) != <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00350"></a>00350     {
<a name="l00351"></a>00351       peer_free(p_lpeer);
<a name="l00352"></a>00352       <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355   <span class="comment">/* Add lookup to node and increase n_lookup count */</span>
<a name="l00356"></a>00356   p_entry-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a>++;
<a name="l00357"></a>00357   p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#a800a90dbe883194d793d5c1117be4755">p_next</a> = p_entry-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>;
<a name="l00358"></a>00358   p_entry-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a> = p_lpeer;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="keywordflow">return</span> p_lpeer;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 }                               <span class="comment">/* h_insert_new_lookup */</span>
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="comment">/* get the node pointed by a lookup peer (if it exists) */</span>
<a name="l00365"></a><a class="code" href="namespace_8c.html#a2882d4ce79e5eee1ad1aa8b74ea97bfb">00365</a> <a class="code" href="struct____fsnode____.html">fsnode_t</a> *<a class="code" href="namespace_8c.html#a2882d4ce79e5eee1ad1aa8b74ea97bfb">h_get_lookup</a>(ino_t parent_inode, dev_t parent_dev, <span class="keywordtype">char</span> *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>, <span class="keywordtype">int</span> *p_rc)
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> lpeer;
<a name="l00368"></a>00368   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00369"></a>00369   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffval;
<a name="l00370"></a>00370   <span class="keywordtype">int</span> rc;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372   <span class="comment">/* test if lookup peer is referenced in lookup hashtable */</span>
<a name="l00373"></a>00373   lpeer.<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> = parent_inode;
<a name="l00374"></a>00374   lpeer.<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> = parent_dev;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376   strncpy(lpeer.<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>, name, <a class="code" href="fsal__types_8h.html#ad026c47acb9681dca70066e06a9e6b50">FSAL_MAX_NAME_LEN</a>);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) &amp; lpeer;
<a name="l00379"></a>00379   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(lpeer);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   rc = HashTable_Get(lookup_hash, &amp;buffkey, &amp;buffval);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383   <span class="keywordflow">if</span>(p_rc)
<a name="l00384"></a>00384     *p_rc = rc;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="keywordflow">if</span>(rc == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00387"></a>00387     <span class="keywordflow">return</span> (<a class="code" href="struct____fsnode____.html">fsnode_t</a> *) (buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>);
<a name="l00388"></a>00388   <span class="keywordflow">else</span>
<a name="l00389"></a>00389     <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00390"></a>00390 }                               <span class="comment">/* h_get_lookup */</span>
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 <span class="comment">/* remove a lookup entry and return the pointed node */</span>
<a name="l00393"></a><a class="code" href="namespace_8c.html#a81691bee542cd25c9927058c0d7614bc">00393</a> <a class="code" href="struct____fsnode____.html">fsnode_t</a> *<a class="code" href="namespace_8c.html#a81691bee542cd25c9927058c0d7614bc">h_del_lookup</a>(ino_t parent_inode, dev_t parent_dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> parent_gen,
<a name="l00394"></a>00394                        <span class="keywordtype">char</span> *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>, <span class="keywordtype">int</span> *p_rc)
<a name="l00395"></a>00395 {
<a name="l00396"></a>00396   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> lpeer;
<a name="l00397"></a>00397   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_lpeer;
<a name="l00398"></a>00398   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_lpeer_last;
<a name="l00399"></a>00399   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey_in, buffkey_out;
<a name="l00400"></a>00400   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffdata;
<a name="l00401"></a>00401   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_node;
<a name="l00402"></a>00402   <span class="keywordtype">int</span> rc;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404   <span class="comment">/* test if lookup peer is referenced in lookup hashtable */</span>
<a name="l00405"></a>00405   lpeer.<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> = parent_inode;
<a name="l00406"></a>00406   lpeer.<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> = parent_dev;
<a name="l00407"></a>00407   <span class="comment">/* note: generation not needed for Hashtable_Get/Del */</span>
<a name="l00408"></a>00408 
<a name="l00409"></a>00409   strncpy(lpeer.<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>, name, <a class="code" href="fsal__types_8h.html#ad026c47acb9681dca70066e06a9e6b50">FSAL_MAX_NAME_LEN</a>);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411   buffkey_in.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) &amp; lpeer;
<a name="l00412"></a>00412   buffkey_in.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(lpeer);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414   rc = HashTable_Del(lookup_hash, &amp;buffkey_in, &amp;buffkey_out, &amp;buffdata);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   <span class="keywordflow">if</span>(p_rc)
<a name="l00417"></a>00417     *p_rc = rc;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419   <span class="keywordflow">if</span>(rc == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00420"></a>00420     {
<a name="l00421"></a>00421       <span class="comment">/* Remove lookup from node and decrease n_lookup count */</span>
<a name="l00422"></a>00422       p_node = (<a class="code" href="struct____fsnode____.html">fsnode_t</a> *) buffdata.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424       assert(p_node-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a> &gt; 0);
<a name="l00425"></a>00425       p_node-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a>--;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427       <span class="comment">/* find lpeer in node */</span>
<a name="l00428"></a>00428       p_lpeer_last = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430       <span class="keywordflow">for</span>(p_lpeer = p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>; p_lpeer != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; p_lpeer = p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#a800a90dbe883194d793d5c1117be4755">p_next</a>)
<a name="l00431"></a>00431         {
<a name="l00432"></a>00432           <span class="keywordflow">if</span>(p_lpeer == (<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *) buffkey_out.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>)
<a name="l00433"></a>00433             {
<a name="l00434"></a>00434               <span class="comment">/* check parent inode and entry name */</span>
<a name="l00435"></a>00435               <span class="keywordflow">if</span>((p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> != parent_inode)
<a name="l00436"></a>00436                  || (p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> != parent_dev)
<a name="l00437"></a>00437                  || (p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a> != parent_gen)
<a name="l00438"></a>00438                  || strncmp(p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>, name, <a class="code" href="fsal__types_8h.html#ad026c47acb9681dca70066e06a9e6b50">FSAL_MAX_NAME_LEN</a>))
<a name="l00439"></a>00439                 {
<a name="l00440"></a>00440                   <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>,
<a name="l00441"></a>00441                           <span class="stringliteral">&quot;NAMESPACE MANAGER: An incompatible direntry was found. In node: %lu.%lu (gen:%u) ,%s  Deleted:%lu.%lu (gen:%u),%s&quot;</span>,
<a name="l00442"></a>00442                           p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>,
<a name="l00443"></a>00443                           p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>, p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>, parent_dev,
<a name="l00444"></a>00444                           parent_inode, parent_gen, name);
<a name="l00445"></a>00445                   <span class="comment">/* remove it anyway... */</span>
<a name="l00446"></a>00446                 }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448               <span class="comment">/* remove it from list */</span>
<a name="l00449"></a>00449 
<a name="l00450"></a>00450               <span class="keywordflow">if</span>(p_lpeer_last)
<a name="l00451"></a>00451                 p_lpeer_last-&gt;<a class="code" href="struct____lookup__peer____.html#a800a90dbe883194d793d5c1117be4755">p_next</a> = p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#a800a90dbe883194d793d5c1117be4755">p_next</a>;
<a name="l00452"></a>00452               <span class="keywordflow">else</span>
<a name="l00453"></a>00453                 p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a> = p_lpeer-&gt;<a class="code" href="struct____lookup__peer____.html#a800a90dbe883194d793d5c1117be4755">p_next</a>;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455               <span class="comment">/* free it */</span>
<a name="l00456"></a>00456 
<a name="l00457"></a>00457               peer_free(p_lpeer);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459               <span class="comment">/* finished */</span>
<a name="l00460"></a>00460               <span class="keywordflow">break</span>;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462             }
<a name="l00463"></a>00463           <span class="comment">/* if lpeer found */</span>
<a name="l00464"></a>00464           p_lpeer_last = p_lpeer;
<a name="l00465"></a>00465         }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467       <span class="comment">/* return the pointer node */</span>
<a name="l00468"></a>00468       <span class="keywordflow">return</span> p_node;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470   <span class="keywordflow">else</span>
<a name="l00471"></a>00471     <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 }                               <span class="comment">/* h_del_lookup */</span>
<a name="l00474"></a>00474 
<a name="l00475"></a><a class="code" href="namespace_8c.html#a2bbb78c1560333a4286ad9e439892f8c">00475</a> <a class="code" href="struct____fsnode____.html">fsnode_t</a> *<a class="code" href="namespace_8c.html#a2bbb78c1560333a4286ad9e439892f8c">h_insert_new_node</a>(ino_t <a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>, dev_t device, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gen, <span class="keywordtype">int</span> overwrite)
<a name="l00476"></a>00476 {
<a name="l00477"></a>00477   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00478"></a>00478   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffval;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_node;
<a name="l00481"></a>00481   <span class="keywordtype">int</span> flag;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483   p_node = node_alloc();
<a name="l00484"></a>00484   <span class="keywordflow">if</span>(!p_node)
<a name="l00485"></a>00485     <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487   p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> = <a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>;
<a name="l00488"></a>00488   p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> = device;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490   p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a> = gen;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492   <span class="comment">/* no children, no hardlink for the moment */</span>
<a name="l00493"></a>00493   p_node-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a> = 0;
<a name="l00494"></a>00494   p_node-&gt;<a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">n_children</a> = 0;
<a name="l00495"></a>00495   p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a> = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497   <span class="comment">/* insert it to hash table */</span>
<a name="l00498"></a>00498 
<a name="l00499"></a>00499   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) &amp; p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>;
<a name="l00500"></a>00500   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502   buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) p_node;
<a name="l00503"></a>00503   buffval.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(*p_node);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505   <span class="keywordflow">if</span>(overwrite)
<a name="l00506"></a>00506     flag = <a class="code" href="group__HTStructs.html#ggab434086e69de04e0dcb4a269625c83e3a9e77ddde96573f9eeed7263120e91aa4">HASHTABLE_SET_HOW_SET_OVERWRITE</a>;
<a name="l00507"></a>00507   <span class="keywordflow">else</span>
<a name="l00508"></a>00508     flag = <a class="code" href="group__HTStructs.html#ggab434086e69de04e0dcb4a269625c83e3a160497855cb35a4e7db24152027751cd">HASHTABLE_SET_HOW_SET_NO_OVERWRITE</a>;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510   <span class="keywordflow">if</span>(<a class="code" href="group__HTExported.html#ga613e404f11079c49c4020b659fe681cd" title="Set a pair (key,value) into the Hash Table.">HashTable_Test_And_Set</a>(nodes_hash, &amp;buffkey, &amp;buffval, flag) != <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00511"></a>00511     {
<a name="l00512"></a>00512       node_free(p_node);
<a name="l00513"></a>00513       <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00514"></a>00514     }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516   <span class="keywordflow">return</span> p_node;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 }                               <span class="comment">/* h_insert_new_node */</span>
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="comment">/* get the node corresponding to an inode number */</span>
<a name="l00521"></a><a class="code" href="namespace_8c.html#a5f99dbe9b573042dc11025e6a69984a1">00521</a> <a class="code" href="struct____fsnode____.html">fsnode_t</a> *<a class="code" href="namespace_8c.html#a5f99dbe9b573042dc11025e6a69984a1">h_get_node</a>(ino_t <a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>, dev_t device, <span class="keywordtype">int</span> *p_rc)
<a name="l00522"></a>00522 {
<a name="l00523"></a>00523   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00524"></a>00524   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffval;
<a name="l00525"></a>00525   <a class="code" href="struct____inode____.html">inode_t</a> key;
<a name="l00526"></a>00526   <span class="keywordtype">int</span> rc;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   <span class="comment">/* test if inode is referenced in nodes hashtable */</span>
<a name="l00529"></a>00529 
<a name="l00530"></a>00530   key.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> = <a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>;
<a name="l00531"></a>00531   key.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> = device;
<a name="l00532"></a>00532   <span class="comment">/* note: generation not needed for Hashtable_Get */</span>
<a name="l00533"></a>00533 
<a name="l00534"></a>00534   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) &amp; key;
<a name="l00535"></a>00535   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(key);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537   rc = HashTable_Get(nodes_hash, &amp;buffkey, &amp;buffval);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539   <span class="keywordflow">if</span>(p_rc)
<a name="l00540"></a>00540     *p_rc = rc;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542   <span class="keywordflow">if</span>(rc == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00543"></a>00543     <span class="keywordflow">return</span> (<a class="code" href="struct____fsnode____.html">fsnode_t</a> *) (buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>);
<a name="l00544"></a>00544   <span class="keywordflow">else</span>
<a name="l00545"></a>00545     <span class="keywordflow">return</span> <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00546"></a>00546 }                               <span class="comment">/* h_get_node */</span>
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 <span class="comment">/* remove the node corresponding to an inode number */</span>
<a name="l00549"></a><a class="code" href="namespace_8c.html#ab0efbedc008052543e63856588ad67de">00549</a> <span class="keywordtype">int</span> <a class="code" href="namespace_8c.html#ab0efbedc008052543e63856588ad67de">h_del_node</a>(ino_t <a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>, dev_t device)
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00552"></a>00552   <a class="code" href="struct____inode____.html">inode_t</a> key;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554   <span class="comment">/* test if inode is referenced in nodes hashtable */</span>
<a name="l00555"></a>00555   key.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> = <a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>;
<a name="l00556"></a>00556   key.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> = device;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558   <span class="comment">/* note: generation not needed for Hashtable_Get/Del */</span>
<a name="l00559"></a>00559 
<a name="l00560"></a>00560   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) &amp; key;
<a name="l00561"></a>00561   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(key);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563   <span class="keywordflow">return</span> HashTable_Del(nodes_hash, &amp;buffkey, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 }                               <span class="comment">/* h_del_node */</span>
<a name="l00566"></a>00566 
<a name="l00567"></a>00567 <span class="comment">/*----------------------------------------------------</span>
<a name="l00568"></a>00568 <span class="comment"> *              Exported functions</span>
<a name="l00569"></a>00569 <span class="comment"> *----------------------------------------------------*/</span>
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="comment">/* Initialize namespace and create root with the given inode number */</span>
<a name="l00572"></a><a class="code" href="namespace_8h.html#a91195d97317b8b2125df20ccceed1bdd">00572</a> <span class="keywordtype">int</span> <a class="code" href="namespace_8c.html#a91195d97317b8b2125df20ccceed1bdd">NamespaceInit</a>(ino_t root_inode, dev_t root_dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *p_root_gen)
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *root;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576   <span class="comment">/* Initialize pools.</span>
<a name="l00577"></a>00577 <span class="comment">   */</span>
<a name="l00578"></a>00578 
<a name="l00579"></a>00579   peer_pool = pool_init(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a>),
<a name="l00580"></a>00580                         pool_basic_substrate,
<a name="l00581"></a>00581                         <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00582"></a>00582   node_pool = pool_init(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct____fsnode____.html">fsnode_t</a>),
<a name="l00583"></a>00583                         pool_basic_substrate,
<a name="l00584"></a>00584                         <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586   <span class="comment">/* initialize namespace lock */</span>
<a name="l00587"></a>00587   <span class="keywordflow">if</span>(<a class="code" href="RW__Lock_8h.html#aac705dafe2b44fa4af84f99a98076bd2">rw_lock_init</a>(&amp;ns_lock))
<a name="l00588"></a>00588     <span class="keywordflow">return</span> ENOMEM;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590   <span class="comment">/* init the lookup hash table */</span>
<a name="l00591"></a>00591   lookup_hash = <a class="code" href="group__HTExported.html#ga49502e8329739f9789ec4423289235d2" title="Initialize a new hash table.">HashTable_Init</a>(&amp;lookup_hash_config);
<a name="l00592"></a>00592   nodes_hash = <a class="code" href="group__HTExported.html#ga49502e8329739f9789ec4423289235d2" title="Initialize a new hash table.">HashTable_Init</a>(&amp;nodes_hash_config);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594   <span class="keywordflow">if</span>(!lookup_hash || !nodes_hash)
<a name="l00595"></a>00595     <span class="keywordflow">return</span> ENOMEM;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597   <span class="comment">/* allocate the root entry */</span>
<a name="l00598"></a>00598   root = <a class="code" href="namespace_8c.html#a2bbb78c1560333a4286ad9e439892f8c">h_insert_new_node</a>(root_inode, root_dev, *p_root_gen, <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600   <span class="keywordflow">if</span>(!root)
<a name="l00601"></a>00601     <span class="keywordflow">return</span> ENOMEM;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;namespace: Root=%lX.%ld (gen:%u)&quot;</span>, root_dev, root_inode,
<a name="l00604"></a>00604          root-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>);
<a name="l00605"></a>00605 
<a name="l00606"></a>00606   *p_root_gen = root-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608   <span class="comment">/* never remove it */</span>
<a name="l00609"></a>00609   root-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a> = 1;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611   <span class="keywordflow">return</span> 0;
<a name="l00612"></a>00612 }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614 <span class="comment">/* Add a child entry (no lock) */</span>
<a name="l00615"></a>00615 <span class="keyword">static</span> <span class="keywordtype">int</span> NamespaceAdd_nl(ino_t parent_ino, dev_t parent_dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> parent_gen,
<a name="l00616"></a>00616                            <span class="keywordtype">char</span> *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>,
<a name="l00617"></a>00617                            ino_t entry_ino, dev_t entry_dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *p_new_gen)
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_parent = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00620"></a>00620   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_node = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00621"></a>00621   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_node_exist = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00622"></a>00622   <a class="code" href="struct____lookup__peer____.html">lookup_peer_t</a> *p_lpeer;
<a name="l00623"></a>00623   <span class="keywordtype">int</span> rc;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;namespace: Adding (%lX.%ld,%s)=%lX.%ld&quot;</span>,
<a name="l00626"></a>00626          parent_dev, parent_ino, name, entry_dev, entry_ino);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628   <span class="comment">/* does parent inode exist in namespace ? */</span>
<a name="l00629"></a>00629 
<a name="l00630"></a>00630   p_parent = <a class="code" href="namespace_8c.html#a5f99dbe9b573042dc11025e6a69984a1">h_get_node</a>(parent_ino, parent_dev, &amp;rc);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632   <span class="keywordflow">if</span>(!p_parent)
<a name="l00633"></a>00633     <span class="keywordflow">return</span> ENOENT;
<a name="l00634"></a>00634   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(p_parent-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a> != parent_gen)
<a name="l00635"></a>00635     <span class="keywordflow">return</span> ESTALE;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637   <span class="comment">/* does another entry exist with this inode ? (hardlink) */</span>
<a name="l00638"></a>00638 
<a name="l00639"></a>00639   p_node = <a class="code" href="namespace_8c.html#a5f99dbe9b573042dc11025e6a69984a1">h_get_node</a>(entry_ino, entry_dev, &amp;rc);
<a name="l00640"></a>00640 
<a name="l00641"></a>00641   <span class="keywordflow">switch</span> (rc)
<a name="l00642"></a>00642     {
<a name="l00643"></a>00643     <span class="keywordflow">case</span> <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>:
<a name="l00644"></a>00644       {
<a name="l00645"></a>00645         <span class="comment">/* this node exists */</span>
<a name="l00646"></a>00646 
<a name="l00647"></a>00647         <span class="comment">/* test if it is already referenced in lookup hashtable */</span>
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         p_node_exist = <a class="code" href="namespace_8c.html#a2882d4ce79e5eee1ad1aa8b74ea97bfb">h_get_lookup</a>(parent_ino, parent_dev, name, &amp;rc);
<a name="l00650"></a>00650 
<a name="l00651"></a>00651         <span class="keywordflow">if</span>(rc == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1af64969299d286caf4ae0ec62f44d6c79">HASHTABLE_ERROR_NO_SUCH_KEY</a>)
<a name="l00652"></a>00652           {
<a name="l00653"></a>00653 
<a name="l00654"></a>00654             <span class="comment">/* create and add new peer to hash table */</span>
<a name="l00655"></a>00655             p_lpeer =
<a name="l00656"></a>00656                 <a class="code" href="namespace_8c.html#a32c9f60f7ebc23dee8317ff3792568a8">h_insert_new_lookup</a>(parent_ino, parent_dev, parent_gen, name, p_node,
<a name="l00657"></a>00657                                     <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00658"></a>00658             <span class="keywordflow">if</span>(!p_lpeer)
<a name="l00659"></a>00659               <span class="keywordflow">return</span> EFAULT;
<a name="l00660"></a>00660 
<a name="l00661"></a>00661             <span class="comment">/* increment parent&#39;s refcount */</span>
<a name="l00662"></a>00662             p_parent-&gt;<a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">n_children</a>++;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664           }
<a name="l00665"></a>00665         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rc == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00666"></a>00666           {
<a name="l00667"></a>00667 
<a name="l00668"></a>00668             <span class="keywordflow">if</span>((p_node_exist-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> == entry_ino)
<a name="l00669"></a>00669                &amp;&amp; (p_node_exist-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> == entry_dev))
<a name="l00670"></a>00670               {
<a name="l00671"></a>00671                 <span class="comment">/* entry already exist: nothing to do, return last generation */</span>
<a name="l00672"></a>00672                 *p_new_gen = p_node_exist-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>;
<a name="l00673"></a>00673                 <span class="keywordflow">return</span> 0;
<a name="l00674"></a>00674               }
<a name="l00675"></a>00675             <span class="keywordflow">else</span>
<a name="l00676"></a>00676               {
<a name="l00677"></a>00677                 <span class="comment">/* an incompatible entry was found ! */</span>
<a name="l00678"></a>00678 
<a name="l00679"></a>00679                 <span class="comment">/* TODO: REMOVE IT silently because the filesystem changed behind us */</span>
<a name="l00680"></a>00680 
<a name="l00681"></a>00681                 <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>,
<a name="l00682"></a>00682                         <span class="stringliteral">&quot;NAMESPACE MANAGER: An incompatible direntry was found. Existing: %lX.%lu,%s-&gt;%lX.%lu  New:%lX.%lu,%s-&gt;%lX.%lu&quot;</span>,
<a name="l00683"></a>00683                         parent_dev, parent_ino, name, p_node_exist-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>,
<a name="l00684"></a>00684                         p_node_exist-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, parent_dev, parent_ino, name, entry_dev, entry_ino);
<a name="l00685"></a>00685                 <span class="keywordflow">return</span> EEXIST;
<a name="l00686"></a>00686               }
<a name="l00687"></a>00687           }
<a name="l00688"></a>00688         <span class="keywordflow">else</span>                    <span class="comment">/* other error */</span>
<a name="l00689"></a>00689           {
<a name="l00690"></a>00690             <span class="keywordflow">return</span> EFAULT;
<a name="l00691"></a>00691           }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693         <span class="keywordflow">break</span>;
<a name="l00694"></a>00694       }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="keywordflow">case</span> <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1af64969299d286caf4ae0ec62f44d6c79">HASHTABLE_ERROR_NO_SUCH_KEY</a>:
<a name="l00697"></a>00697       {
<a name="l00698"></a>00698 
<a name="l00699"></a>00699         <span class="comment">/* allocate new node entry */</span>
<a name="l00700"></a>00700         p_node = <a class="code" href="namespace_8c.html#a2bbb78c1560333a4286ad9e439892f8c">h_insert_new_node</a>(entry_ino, entry_dev, *p_new_gen, <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702         <span class="keywordflow">if</span>(!p_node)
<a name="l00703"></a>00703           <span class="keywordflow">return</span> ENOMEM;
<a name="l00704"></a>00704 
<a name="l00705"></a>00705         <span class="comment">/* now, create the associated lookup peer */</span>
<a name="l00706"></a>00706 
<a name="l00707"></a>00707         p_lpeer =
<a name="l00708"></a>00708             <a class="code" href="namespace_8c.html#a32c9f60f7ebc23dee8317ff3792568a8">h_insert_new_lookup</a>(parent_ino, parent_dev, parent_gen, name, p_node, <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710         <span class="keywordflow">if</span>(!p_lpeer)
<a name="l00711"></a>00711           <span class="keywordflow">return</span> ENOMEM;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713         <span class="comment">/* increase parent&#39;s refcount */</span>
<a name="l00714"></a>00714         p_parent-&gt;<a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">n_children</a>++;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716         <span class="keywordflow">break</span>;
<a name="l00717"></a>00717       }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719     <span class="keywordflow">default</span>:
<a name="l00720"></a>00720       <span class="keywordflow">return</span> EFAULT;            <span class="comment">/* should not occur ! */</span>
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;namespace: Entry %lX.%ld (gen:%u)  has now link count = %u&quot;</span>,
<a name="l00724"></a>00724          p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>,
<a name="l00725"></a>00725          p_node-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a>);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727   *p_new_gen = p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729   <span class="comment">/* added successfuly */</span>
<a name="l00730"></a>00730   <span class="keywordflow">return</span> 0;
<a name="l00731"></a>00731 }                               <span class="comment">/* NamespaceAdd_nl */</span>
<a name="l00732"></a>00732 
<a name="l00733"></a>00733 <span class="comment">/* Remove a child entry (no lock) */</span>
<a name="l00734"></a>00734 <span class="keyword">static</span> <span class="keywordtype">int</span> NamespaceRemove_nl(ino_t parent_ino, dev_t parent_dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> parent_gen,
<a name="l00735"></a>00735                               <span class="keywordtype">char</span> *name)
<a name="l00736"></a>00736 {
<a name="l00737"></a>00737   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_parent = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00738"></a>00738   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_node = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00739"></a>00739   <span class="keywordtype">int</span> rc;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;namespace: removing %lX.%ld/%s&quot;</span>, parent_dev, parent_ino, name);
<a name="l00742"></a>00742 
<a name="l00743"></a>00743   <span class="comment">/* get parent node */</span>
<a name="l00744"></a>00744   p_parent = <a class="code" href="namespace_8c.html#a5f99dbe9b573042dc11025e6a69984a1">h_get_node</a>(parent_ino, parent_dev, &amp;rc);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746   <span class="keywordflow">if</span>(rc == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1af64969299d286caf4ae0ec62f44d6c79">HASHTABLE_ERROR_NO_SUCH_KEY</a>)
<a name="l00747"></a>00747     <span class="keywordflow">return</span> ENOENT;
<a name="l00748"></a>00748   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!p_parent)
<a name="l00749"></a>00749     <span class="keywordflow">return</span> EFAULT;
<a name="l00750"></a>00750   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(p_parent-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a> != parent_gen)
<a name="l00751"></a>00751     <span class="keywordflow">return</span> ESTALE;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753   <span class="comment">/* remove the lookup entry in the hash and get pointed node (if exists) */</span>
<a name="l00754"></a>00754   p_node = <a class="code" href="namespace_8c.html#a81691bee542cd25c9927058c0d7614bc">h_del_lookup</a>(parent_ino, parent_dev, parent_gen, name, &amp;rc);
<a name="l00755"></a>00755 
<a name="l00756"></a>00756   <span class="keywordflow">if</span>(rc == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1af64969299d286caf4ae0ec62f44d6c79">HASHTABLE_ERROR_NO_SUCH_KEY</a>)
<a name="l00757"></a>00757     {
<a name="l00758"></a>00758       <span class="comment">/* consider its OK */</span>
<a name="l00759"></a>00759       <span class="keywordflow">return</span> 0;
<a name="l00760"></a>00760     }
<a name="l00761"></a>00761   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!p_node)
<a name="l00762"></a>00762     {
<a name="l00763"></a>00763       <span class="keywordflow">return</span> EFAULT;
<a name="l00764"></a>00764     }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766   assert(p_parent-&gt;<a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">n_children</a> &gt; 0);
<a name="l00767"></a>00767 
<a name="l00768"></a>00768   <span class="comment">/* decrement parents&#39; lookup count */</span>
<a name="l00769"></a>00769   p_parent-&gt;<a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">n_children</a>--;
<a name="l00770"></a>00770 
<a name="l00771"></a>00771   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;namespace: Entry %lX.%ld has now link count = %u&quot;</span>,
<a name="l00772"></a>00772          p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a>);
<a name="l00773"></a>00773 
<a name="l00774"></a>00774   <span class="comment">/* node not in namespace tree anymore */</span>
<a name="l00775"></a>00775   <span class="keywordflow">if</span>(p_node-&gt;<a class="code" href="struct____fsnode____.html#a3184a0ecae5b3c86b19c917c1a38733b">n_lookup</a> == 0)
<a name="l00776"></a>00776     {
<a name="l00777"></a>00777       assert(p_node-&gt;<a class="code" href="struct____fsnode____.html#af4c03365752f2185b1614dabd2e08242">n_children</a> == 0);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779       <span class="comment">/* remove from hash table */</span>
<a name="l00780"></a>00780       rc = <a class="code" href="namespace_8c.html#ab0efbedc008052543e63856588ad67de">h_del_node</a>(p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>);
<a name="l00781"></a>00781 
<a name="l00782"></a>00782       <span class="keywordflow">if</span>(rc != <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00783"></a>00783         {
<a name="l00784"></a>00784           <span class="keywordflow">return</span> EFAULT;
<a name="l00785"></a>00785         }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787       <span class="comment">/* free the node */</span>
<a name="l00788"></a>00788       node_free(p_node);
<a name="l00789"></a>00789     }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791   <span class="comment">/* remove succeeded ! */</span>
<a name="l00792"></a>00792   <span class="keywordflow">return</span> 0;
<a name="l00793"></a>00793 }                               <span class="comment">/* NamespaceRemove_nl */</span>
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="comment">/* Add a child entry */</span>
<a name="l00796"></a><a class="code" href="namespace_8h.html#a3063e09a524929a0786099fc3843b166">00796</a> <span class="keywordtype">int</span> <a class="code" href="namespace_8c.html#a3063e09a524929a0786099fc3843b166">NamespaceAdd</a>(ino_t parent_ino, dev_t parent_dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gen,
<a name="l00797"></a>00797                  <span class="keywordtype">char</span> *name, ino_t entry_ino, dev_t entry_dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *p_new_gen)
<a name="l00798"></a>00798 {
<a name="l00799"></a>00799   <span class="keywordtype">int</span> rc;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801   <span class="comment">/* lock the namespace for modification */</span>
<a name="l00802"></a>00802   <a class="code" href="RW__Lock_8h.html#a0b96e0927b62c7782185168c6e9de763">P_w</a>(&amp;ns_lock);
<a name="l00803"></a>00803   rc = NamespaceAdd_nl(parent_ino, parent_dev, gen, name,
<a name="l00804"></a>00804                        entry_ino, entry_dev, p_new_gen);
<a name="l00805"></a>00805   <a class="code" href="RW__Lock_8h.html#ad8b195d025fcfd1076942fa5868d14a3">V_w</a>(&amp;ns_lock);
<a name="l00806"></a>00806 
<a name="l00807"></a>00807   <span class="keywordflow">return</span> rc;
<a name="l00808"></a>00808 }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810 <span class="comment">/* Remove a child entry */</span>
<a name="l00811"></a><a class="code" href="namespace_8h.html#ad910f6c5e329e84cc8d5ca6c20ff5869">00811</a> <span class="keywordtype">int</span> <a class="code" href="namespace_8c.html#ad910f6c5e329e84cc8d5ca6c20ff5869">NamespaceRemove</a>(ino_t parent_ino, dev_t parent_dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gen, <span class="keywordtype">char</span> *name)
<a name="l00812"></a>00812 {
<a name="l00813"></a>00813   <span class="keywordtype">int</span> rc;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815   <span class="comment">/* lock the namespace for modification */</span>
<a name="l00816"></a>00816   <a class="code" href="RW__Lock_8h.html#a0b96e0927b62c7782185168c6e9de763">P_w</a>(&amp;ns_lock);
<a name="l00817"></a>00817   rc = NamespaceRemove_nl(parent_ino, parent_dev, gen, name);
<a name="l00818"></a>00818   <a class="code" href="RW__Lock_8h.html#ad8b195d025fcfd1076942fa5868d14a3">V_w</a>(&amp;ns_lock);
<a name="l00819"></a>00819 
<a name="l00820"></a>00820   <span class="keywordflow">return</span> rc;
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 <span class="comment">/* Move an entry in the namespace */</span>
<a name="l00824"></a><a class="code" href="namespace_8h.html#a720538422aac33bb1a568ea2dc6b3d72">00824</a> <span class="keywordtype">int</span> <a class="code" href="namespace_8c.html#a720538422aac33bb1a568ea2dc6b3d72">NamespaceRename</a>(ino_t parent_entry_src, dev_t src_dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> srcgen,
<a name="l00825"></a>00825                     <span class="keywordtype">char</span> *name_src, ino_t parent_entry_tgt, dev_t tgt_dev,
<a name="l00826"></a>00826                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tgtgen, <span class="keywordtype">char</span> *name_tgt)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828 
<a name="l00829"></a>00829   <span class="keywordtype">int</span> rc = 0;
<a name="l00830"></a>00830   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_node;
<a name="l00831"></a>00831   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> new_gen;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833   <span class="comment">/* lock the namespace for modification */</span>
<a name="l00834"></a>00834   <a class="code" href="RW__Lock_8h.html#a0b96e0927b62c7782185168c6e9de763">P_w</a>(&amp;ns_lock);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836   <span class="comment">/* get source node info */</span>
<a name="l00837"></a>00837   p_node = <a class="code" href="namespace_8c.html#a2882d4ce79e5eee1ad1aa8b74ea97bfb">h_get_lookup</a>(parent_entry_src, src_dev, name_src, &amp;rc);
<a name="l00838"></a>00838 
<a name="l00839"></a>00839   <span class="keywordflow">if</span>(!p_node || rc != 0)
<a name="l00840"></a>00840     {
<a name="l00841"></a>00841       <a class="code" href="RW__Lock_8h.html#ad8b195d025fcfd1076942fa5868d14a3">V_w</a>(&amp;ns_lock);
<a name="l00842"></a>00842       <span class="keywordflow">return</span> rc;
<a name="l00843"></a>00843     }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845   <span class="comment">/* check that source != target (if so, do nothing) */</span>
<a name="l00846"></a>00846   <span class="keywordflow">if</span>((parent_entry_src == parent_entry_tgt)
<a name="l00847"></a>00847      &amp;&amp; (src_dev == tgt_dev) &amp;&amp; !strcmp(name_src, name_tgt))
<a name="l00848"></a>00848     {
<a name="l00849"></a>00849       <a class="code" href="RW__Lock_8h.html#ad8b195d025fcfd1076942fa5868d14a3">V_w</a>(&amp;ns_lock);
<a name="l00850"></a>00850       <span class="keywordflow">return</span> 0;
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853   <span class="comment">/* try to add new path (with the same gen number) */</span>
<a name="l00854"></a>00854   new_gen = p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>;
<a name="l00855"></a>00855 
<a name="l00856"></a>00856   rc = NamespaceAdd_nl(parent_entry_tgt, tgt_dev, tgtgen, name_tgt, p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>,
<a name="l00857"></a>00857                        p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>, &amp;new_gen);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859   <span class="keywordflow">if</span>(rc == EEXIST)
<a name="l00860"></a>00860     {
<a name="l00861"></a>00861       <span class="comment">/* remove previous entry */</span>
<a name="l00862"></a>00862       rc = NamespaceRemove_nl(parent_entry_tgt, tgt_dev, tgtgen, name_tgt);
<a name="l00863"></a>00863       <span class="keywordflow">if</span>(rc)
<a name="l00864"></a>00864         {
<a name="l00865"></a>00865           <a class="code" href="RW__Lock_8h.html#ad8b195d025fcfd1076942fa5868d14a3">V_w</a>(&amp;ns_lock);
<a name="l00866"></a>00866           <span class="keywordflow">return</span> rc;
<a name="l00867"></a>00867         }
<a name="l00868"></a>00868 
<a name="l00869"></a>00869       <span class="comment">/* add the new one */</span>
<a name="l00870"></a>00870       new_gen = p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872       rc = NamespaceAdd_nl(parent_entry_tgt, tgt_dev, tgtgen, name_tgt,
<a name="l00873"></a>00873                            p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>, &amp;new_gen);
<a name="l00874"></a>00874     }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876   <span class="keywordflow">if</span>(rc)
<a name="l00877"></a>00877     {
<a name="l00878"></a>00878       <a class="code" href="RW__Lock_8h.html#ad8b195d025fcfd1076942fa5868d14a3">V_w</a>(&amp;ns_lock);
<a name="l00879"></a>00879       <span class="keywordflow">return</span> rc;
<a name="l00880"></a>00880     }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882   <span class="comment">/* remove old path */</span>
<a name="l00883"></a>00883   rc = NamespaceRemove_nl(parent_entry_src, src_dev, srcgen, name_src);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885   <a class="code" href="RW__Lock_8h.html#ad8b195d025fcfd1076942fa5868d14a3">V_w</a>(&amp;ns_lock);
<a name="l00886"></a>00886 
<a name="l00887"></a>00887   <span class="keywordflow">return</span> rc;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889 }
<a name="l00890"></a>00890 
<a name="l00891"></a><a class="code" href="namespace_8h.html#aaac028ee8c263e1d57f000340837638d">00891</a> <span class="keywordtype">int</span> <a class="code" href="namespace_8c.html#aaac028ee8c263e1d57f000340837638d">NamespaceGetGen</a>(ino_t <a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>, dev_t dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *p_gen)
<a name="l00892"></a>00892 {
<a name="l00893"></a>00893   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_node;
<a name="l00894"></a>00894   <span class="keywordtype">int</span> rc;
<a name="l00895"></a>00895 
<a name="l00896"></a>00896   <span class="comment">/* get entry from hash */</span>
<a name="l00897"></a>00897   p_node = <a class="code" href="namespace_8c.html#a5f99dbe9b573042dc11025e6a69984a1">h_get_node</a>(inode, dev, &amp;rc);
<a name="l00898"></a>00898 
<a name="l00899"></a>00899   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;NamespaceGetGen(%lX,%ld): p_node = %p, rc = %d&quot;</span>, dev, inode, p_node, rc);
<a name="l00900"></a>00900 
<a name="l00901"></a>00901   <span class="keywordflow">if</span>(!p_node)
<a name="l00902"></a>00902     <span class="keywordflow">return</span> ENOENT;
<a name="l00903"></a>00903   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rc != 0)
<a name="l00904"></a>00904     <span class="keywordflow">return</span> rc;
<a name="l00905"></a>00905 
<a name="l00906"></a>00906   *p_gen = p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908   <span class="keywordflow">return</span> 0;
<a name="l00909"></a>00909 }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911 <span class="comment">/* Get a possible full path for an entry */</span>
<a name="l00912"></a><a class="code" href="namespace_8h.html#a9159cfa14f17164ac79968ac2f449532">00912</a> <span class="keywordtype">int</span> <a class="code" href="namespace_8c.html#a9159cfa14f17164ac79968ac2f449532">NamespacePath</a>(ino_t entry, dev_t dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gen, <span class="keywordtype">char</span> *path)
<a name="l00913"></a>00913 {
<a name="l00914"></a>00914   <a class="code" href="struct____fsnode____.html">fsnode_t</a> *p_node;
<a name="l00915"></a>00915   <span class="keywordtype">int</span> rc;
<a name="l00916"></a>00916   <span class="keywordtype">char</span> tmp_path[<a class="code" href="fsal__types_8h.html#acd322bedd761c83fb32251e714c0f943">FSAL_MAX_PATH_LEN</a>];
<a name="l00917"></a>00917 
<a name="l00918"></a>00918   <a class="code" href="struct____inode____.html">inode_t</a> curr_inode;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920   <span class="comment">/* initialize paths */</span>
<a name="l00921"></a>00921   path[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00922"></a>00922   tmp_path[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00923"></a>00923 
<a name="l00924"></a>00924   <span class="comment">/* lock the namespace read-only */</span>
<a name="l00925"></a>00925   <a class="code" href="RW__Lock_8h.html#a32615064bda74b79963b44010599dee7">P_r</a>(&amp;ns_lock);
<a name="l00926"></a>00926 
<a name="l00927"></a>00927   curr_inode.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> = entry;
<a name="l00928"></a>00928   curr_inode.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> = dev;
<a name="l00929"></a>00929   curr_inode.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a> = gen;
<a name="l00930"></a>00930 
<a name="l00931"></a>00931   <span class="keywordflow">do</span>
<a name="l00932"></a>00932     {
<a name="l00933"></a>00933       <span class="comment">/* get entry from hash */</span>
<a name="l00934"></a>00934       p_node = <a class="code" href="namespace_8c.html#a5f99dbe9b573042dc11025e6a69984a1">h_get_node</a>(curr_inode.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, curr_inode.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>, &amp;rc);
<a name="l00935"></a>00935 
<a name="l00936"></a>00936       <span class="keywordflow">if</span>(!p_node)
<a name="l00937"></a>00937         {
<a name="l00938"></a>00938           <a class="code" href="RW__Lock_8h.html#a735aa1d52b02e2ce6644f83017fd6d72">V_r</a>(&amp;ns_lock);
<a name="l00939"></a>00939           <span class="keywordflow">if</span>(rc == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1af64969299d286caf4ae0ec62f44d6c79">HASHTABLE_ERROR_NO_SUCH_KEY</a>)
<a name="l00940"></a>00940             {
<a name="l00941"></a>00941               <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;namespace: %lX.%ld not found&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)dev,
<a name="l00942"></a>00942                      (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)entry);
<a name="l00943"></a>00943               <span class="keywordflow">return</span> ENOENT;
<a name="l00944"></a>00944             }
<a name="l00945"></a>00945           <span class="keywordflow">else</span>
<a name="l00946"></a>00946             <span class="keywordflow">return</span> EFAULT;
<a name="l00947"></a>00947         }
<a name="l00948"></a>00948       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(p_node-&gt;<a class="code" href="struct____fsnode____.html#a7c2b44c70d5657fe5f7f25b435482984">inode</a>.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a> != curr_inode.<a class="code" href="struct____inode____.html#aea02365016b9a5c751e61fe8e955fb52">generation</a>)
<a name="l00949"></a>00949         {
<a name="l00950"></a>00950           <a class="code" href="RW__Lock_8h.html#a735aa1d52b02e2ce6644f83017fd6d72">V_r</a>(&amp;ns_lock);
<a name="l00951"></a>00951           <span class="keywordflow">return</span> ESTALE;
<a name="l00952"></a>00952         }
<a name="l00953"></a>00953 
<a name="l00954"></a>00954       <span class="keywordflow">if</span>(!p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>)
<a name="l00955"></a>00955         {
<a name="l00956"></a>00956           <span class="comment">/* this is the root entry, just add &#39;/&#39; at the begining and return */</span>
<a name="l00957"></a>00957 
<a name="l00958"></a>00958           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;namespace: root entry reached&quot;</span>);
<a name="l00959"></a>00959 
<a name="l00960"></a>00960           snprintf(path, <a class="code" href="fsal__types_8h.html#acd322bedd761c83fb32251e714c0f943">FSAL_MAX_PATH_LEN</a>, <span class="stringliteral">&quot;/%s&quot;</span>, tmp_path);
<a name="l00961"></a>00961           <span class="keywordflow">break</span>;
<a name="l00962"></a>00962         }
<a name="l00963"></a>00963       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(path[0] == <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00964"></a>00964         {
<a name="l00965"></a>00965           <span class="comment">/* nothing in path for the moment, just copy entry name in it */</span>
<a name="l00966"></a>00966           strncpy(path, p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>, <a class="code" href="fsal__types_8h.html#ad026c47acb9681dca70066e06a9e6b50">FSAL_MAX_NAME_LEN</a>);
<a name="l00967"></a>00967           curr_inode = p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>;
<a name="l00968"></a>00968         }
<a name="l00969"></a>00969       <span class="keywordflow">else</span>
<a name="l00970"></a>00970         {
<a name="l00971"></a>00971           <span class="comment">/* this is a parent dir, path is now &lt;dirname&gt;/&lt;subpath&gt; */</span>
<a name="l00972"></a>00972           snprintf(path, <a class="code" href="fsal__types_8h.html#acd322bedd761c83fb32251e714c0f943">FSAL_MAX_PATH_LEN</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>, tmp_path);
<a name="l00973"></a>00973 
<a name="l00974"></a>00974           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;lookup peer found: (%lX.%ld,%s)&quot;</span>,
<a name="l00975"></a>00975                  p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>,
<a name="l00976"></a>00976                  p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>);
<a name="l00977"></a>00977 
<a name="l00978"></a>00978           <span class="comment">/* loop detection */</span>
<a name="l00979"></a>00979           <span class="keywordflow">if</span>((curr_inode.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a> == p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>)
<a name="l00980"></a>00980              &amp;&amp; (curr_inode.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a> == p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>))
<a name="l00981"></a>00981             {
<a name="l00982"></a>00982               <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>,
<a name="l00983"></a>00983                       <span class="stringliteral">&quot;NAMESPACE MANAGER: loop detected in namespace: %lX.%ld/%s = %lX.%ld&quot;</span>,
<a name="l00984"></a>00984                       p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>, p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>,
<a name="l00985"></a>00985                       p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#af8c4986b81b93d78a453774bab5f9567">name</a>, curr_inode.<a class="code" href="struct____inode____.html#a7c7b2c6647d9f2f9fa47e60e063ffdb4">dev</a>, curr_inode.<a class="code" href="struct____inode____.html#aa459d38aa40935d38fd12c3d7c8313c0">inum</a>);
<a name="l00986"></a>00986               <a class="code" href="RW__Lock_8h.html#a735aa1d52b02e2ce6644f83017fd6d72">V_r</a>(&amp;ns_lock);
<a name="l00987"></a>00987               <span class="keywordflow">return</span> ELOOP;
<a name="l00988"></a>00988             }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990           curr_inode = p_node-&gt;<a class="code" href="struct____fsnode____.html#a2ee29245d1db37329561c2f8c9e933ee">parent_list</a>-&gt;<a class="code" href="struct____lookup__peer____.html#aaa00bdc113afc456ca8ec8235c700c8f">parent</a>;
<a name="l00991"></a>00991         }
<a name="l00992"></a>00992 
<a name="l00993"></a>00993       <span class="comment">/* backup path to tmp_path for next loop */</span>
<a name="l00994"></a>00994       strcpy(tmp_path, path);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     }
<a name="l00997"></a>00997   <span class="keywordflow">while</span>(1);
<a name="l00998"></a>00998 
<a name="l00999"></a>00999   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a384d74248e2dfa73e41e7a2c66d68248">COMPONENT_FSAL</a>, <span class="stringliteral">&quot;inode=%lX.%ld (gen %u), path=&#39;%s&#39;&quot;</span>, dev, entry, gen, path);
<a name="l01000"></a>01000 
<a name="l01001"></a>01001   <span class="comment">/* reverse lookup succeeded */</span>
<a name="l01002"></a>01002   <a class="code" href="RW__Lock_8h.html#a735aa1d52b02e2ce6644f83017fd6d72">V_r</a>(&amp;ns_lock);
<a name="l01003"></a>01003   <span class="keywordflow">return</span> 0;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 21 2012 for nfs-ganesha by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
