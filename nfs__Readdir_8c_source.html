<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>nfs-ganesha: nfs_Readdir.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nfs-ganesha&#160;<span id="projectnumber">1.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>nfs_Readdir.c</h1>  </div>
</div>
<div class="contents">
<a href="nfs__Readdir_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001  <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * vimf:expandtab:shiftwidth=8:tabstop=8:</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
<a name="l00005"></a>00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
<a name="l00006"></a>00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00010"></a>00010 <span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
<a name="l00011"></a>00011 <span class="comment"> * License as published by the Free Software Foundation; either</span>
<a name="l00012"></a>00012 <span class="comment"> * version 3 of the License, or (at your option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00017"></a>00017 <span class="comment"> * Lesser General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<a name="l00020"></a>00020 <span class="comment"> * License along with this library; if not, write to the Free Software</span>
<a name="l00021"></a>00021 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ---------------------------------------</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00036"></a>00036 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#endif</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span>
<a name="l00040"></a>00040 <span class="preprocessor">#ifdef _SOLARIS</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#include &quot;solaris_port.h&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#endif</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>           <span class="comment">/* for having FNDELAY */</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;HashData.h&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;HashTable.h&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;ganesha_rpc.h&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;nfs23.h&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;nfs4.h&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;mount.h&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;nfs_core.h&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;cache_inode.h&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;cache_inode_lru.h&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;cache_inode_weakref.h&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;nfs_exports.h&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;nfs_creds.h&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;nfs_proto_functions.h&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;nfs_tools.h&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;nfs_proto_tools.h&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">/* This has a tremendous amount of code duplication, but it&#39;s very</span>
<a name="l00067"></a>00067 <span class="comment">   difficult to refactor since the differences between NFSv2 and</span>
<a name="l00068"></a>00068 <span class="comment">   NFSv3 are more a matter of data types than functionality. */</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="keyword">static</span> bool_t nfs2_readdir_callback(<span class="keywordtype">void</span>* opaque,
<a name="l00071"></a>00071                                     <span class="keywordtype">char</span> *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>,
<a name="l00072"></a>00072                                     <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *handle,
<a name="l00073"></a>00073                                     <a class="code" href="structfsal__attrib__list____.html">fsal_attrib_list_t</a> *attrs,
<a name="l00074"></a>00074                                     <a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> cookie);
<a name="l00075"></a>00075 <span class="keyword">static</span> bool_t nfs3_readdir_callback(<span class="keywordtype">void</span>* opaque,
<a name="l00076"></a>00076                                     <span class="keywordtype">char</span> *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>,
<a name="l00077"></a>00077                                     <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *handle,
<a name="l00078"></a>00078                                     <a class="code" href="structfsal__attrib__list____.html">fsal_attrib_list_t</a> *attrs,
<a name="l00079"></a>00079                                     <a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> cookie);
<a name="l00080"></a>00080 <span class="keyword">static</span> <span class="keywordtype">void</span> free_entry2s(<a class="code" href="structentry2.html">entry2</a> *entry2s);
<a name="l00081"></a>00081 <span class="keyword">static</span> <span class="keywordtype">void</span> free_entry3s(<a class="code" href="structentry3.html">entry3</a> *entry3s);
<a name="l00082"></a>00082 
<a name="l00090"></a><a class="code" href="structnfs2__readdir__cb__data.html">00090</a> <span class="keyword">struct </span><a class="code" href="structnfs2__readdir__cb__data.html" title="Opaque bookkeeping structure for NFSv2 readdir.">nfs2_readdir_cb_data</a>
<a name="l00091"></a>00091 {
<a name="l00092"></a><a class="code" href="structnfs2__readdir__cb__data.html#a550a4e14ab704ed9e41968e5c5716d47">00092</a>      <a class="code" href="structentry2.html">entry2</a> *<a class="code" href="structnfs2__readdir__cb__data.html#a550a4e14ab704ed9e41968e5c5716d47">entries</a>; <span class="comment">/*&lt; The array holding individual entries */</span>
<a name="l00093"></a><a class="code" href="structnfs2__readdir__cb__data.html#a06e055f72b94291370503dbd97efe435">00093</a>      <span class="keywordtype">size_t</span> <a class="code" href="structnfs2__readdir__cb__data.html#a06e055f72b94291370503dbd97efe435">mem_left</a>; <span class="comment">/*&lt; The amount of memory remaining before we</span>
<a name="l00094"></a>00094 <span class="comment">                          hit maxcount */</span>
<a name="l00095"></a><a class="code" href="structnfs2__readdir__cb__data.html#ad5a81f25b5f808d9994b0738cc5e6dda">00095</a>      <span class="keywordtype">size_t</span> <a class="code" href="structnfs2__readdir__cb__data.html#ad5a81f25b5f808d9994b0738cc5e6dda">count</a>; <span class="comment">/*&lt; The count of complete entries stored in the</span>
<a name="l00096"></a>00096 <span class="comment">                       buffer */</span>
<a name="l00097"></a><a class="code" href="structnfs2__readdir__cb__data.html#ada3f78b8b0e8f6f091612637613e4fcb">00097</a>      <span class="keywordtype">size_t</span> <a class="code" href="structnfs2__readdir__cb__data.html#ada3f78b8b0e8f6f091612637613e4fcb">total_entries</a>; <span class="comment">/*&lt; The total number of entries in the</span>
<a name="l00098"></a>00098 <span class="comment">                              array */</span>
<a name="l00099"></a><a class="code" href="structnfs2__readdir__cb__data.html#a1a264a7e3f703172227f781bfc9cacce">00099</a>      <a class="code" href="structfsal__op__context____.html">fsal_op_context_t</a> *<a class="code" href="structnfs2__readdir__cb__data.html#a1a264a7e3f703172227f781bfc9cacce">context</a>; <span class="comment">/*&lt; FSAL operation context */</span>
<a name="l00100"></a><a class="code" href="structnfs2__readdir__cb__data.html#a1ac879789b54a3c5e7821e28ac7c8755">00100</a>      <a class="code" href="nfs23_8h.html#a7aa4ec59cb08c181dab1f366d0c06778">nfsstat2</a> <a class="code" href="structnfs2__readdir__cb__data.html#a1ac879789b54a3c5e7821e28ac7c8755">error</a>; <span class="comment">/*&lt; Set to a value other than NFS_OK if the</span>
<a name="l00101"></a>00101 <span class="comment">                         callback function finds a fatal error. */</span>
<a name="l00102"></a>00102 };
<a name="l00103"></a>00103 
<a name="l00111"></a><a class="code" href="structnfs3__readdir__cb__data.html">00111</a> <span class="keyword">struct </span><a class="code" href="structnfs3__readdir__cb__data.html" title="Opaque bookkeeping structure for NFSv3 readdir.">nfs3_readdir_cb_data</a>
<a name="l00112"></a>00112 {
<a name="l00113"></a><a class="code" href="structnfs3__readdir__cb__data.html#a571bff8b40a66b5d9cf8643cb3bfeec4">00113</a>      <a class="code" href="structentry3.html">entry3</a> *<a class="code" href="structnfs3__readdir__cb__data.html#a571bff8b40a66b5d9cf8643cb3bfeec4">entries</a>; <span class="comment">/*&lt; The array holding individual entries */</span>
<a name="l00114"></a><a class="code" href="structnfs3__readdir__cb__data.html#abb5ab6236eb8bd776f91523e7e568153">00114</a>      <span class="keywordtype">size_t</span> <a class="code" href="structnfs3__readdir__cb__data.html#abb5ab6236eb8bd776f91523e7e568153">mem_left</a>; <span class="comment">/*&lt; The amount of memory remaining before we</span>
<a name="l00115"></a>00115 <span class="comment">                          hit maxcount */</span>
<a name="l00116"></a><a class="code" href="structnfs3__readdir__cb__data.html#ab5a4fab3e7b9ff2743e066f8000acd0c">00116</a>      <span class="keywordtype">size_t</span> <a class="code" href="structnfs3__readdir__cb__data.html#ab5a4fab3e7b9ff2743e066f8000acd0c">count</a>; <span class="comment">/*&lt; The count of complete entries stored in the</span>
<a name="l00117"></a>00117 <span class="comment">                       buffer */</span>
<a name="l00118"></a><a class="code" href="structnfs3__readdir__cb__data.html#a172a99ae853b0c4161dcb7516117a8c9">00118</a>      <span class="keywordtype">size_t</span> <a class="code" href="structnfs3__readdir__cb__data.html#a172a99ae853b0c4161dcb7516117a8c9">total_entries</a>; <span class="comment">/*&lt; The total number of entries in the</span>
<a name="l00119"></a>00119 <span class="comment">                              array */</span>
<a name="l00120"></a><a class="code" href="structnfs3__readdir__cb__data.html#a024e3b803cfa00a9081c3de04279ebec">00120</a>      <a class="code" href="structfsal__op__context____.html">fsal_op_context_t</a> *<a class="code" href="structnfs3__readdir__cb__data.html#a024e3b803cfa00a9081c3de04279ebec">context</a>; <span class="comment">/*&lt; FSAL operation context */</span>
<a name="l00121"></a><a class="code" href="structnfs3__readdir__cb__data.html#a12cf5d3808fb78b9981d2f13cd2871f0">00121</a>      <a class="code" href="nfs23_8h.html#a1721ade9b8e43c719c5834eaaf60aac5">nfsstat3</a> <a class="code" href="structnfs3__readdir__cb__data.html#a12cf5d3808fb78b9981d2f13cd2871f0">error</a>; <span class="comment">/*&lt; Set to a value other than NFS_OK if the</span>
<a name="l00122"></a>00122 <span class="comment">                         callback function finds a fatal error. */</span>
<a name="l00123"></a>00123 };
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 
<a name="l00145"></a>00145 <span class="keywordtype">int</span>
<a name="l00146"></a><a class="code" href="group__NFSprocs.html#ga0060845e94a234f886c994fe0c5ed188">00146</a> <a class="code" href="group__NFSprocs.html#ga0060845e94a234f886c994fe0c5ed188" title="The NFS PROC2 and PROC3 READDIR.">nfs_Readdir</a>(<a class="code" href="unionnfs__arg____.html">nfs_arg_t</a> *arg,
<a name="l00147"></a>00147             <a class="code" href="structexportlist____.html">exportlist_t</a> *export,
<a name="l00148"></a>00148             <a class="code" href="structfsal__op__context____.html">fsal_op_context_t</a> *context,
<a name="l00149"></a>00149             <a class="code" href="structnfs__worker__data____.html">nfs_worker_data_t</a> *worker,
<a name="l00150"></a>00150             <span class="keyword">struct</span> svc_req *req,
<a name="l00151"></a>00151             <a class="code" href="unionnfs__res____.html">nfs_res_t</a> *<a class="code" href="nsm_8h.html#ab0bd7560790c13b656fd58e17e35143e">res</a>)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153      <a class="code" href="structcache__entry__t.html" title="Represents a cached inode.">cache_entry_t</a> *dir_entry = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00154"></a>00154      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count = 0;
<a name="l00155"></a>00155      <a class="code" href="structfsal__attrib__list____.html">fsal_attrib_list_t</a> dir_attr;
<a name="l00156"></a>00156      <a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> cookie = 0;
<a name="l00157"></a>00157      <a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> cache_inode_cookie = 0;
<a name="l00158"></a>00158      <a class="code" href="nfs23_8h.html#a774acc42a913991b53f0c266319d432a">cookieverf3</a> cookie_verifier;
<a name="l00159"></a>00159      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_entries;
<a name="l00160"></a>00160      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> estimated_num_entries = 0;
<a name="l00161"></a>00161      <a class="code" href="cache__inode_8h.html#ae017962c50fe48834d8638069c7edc99">cache_inode_file_type_t</a> dir_filetype = 0;
<a name="l00162"></a>00162      bool_t eod_met = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00163"></a>00163      <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2">cache_inode_status_t</a> cache_status = <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2a3fdbbb2367268ae84ac11d7b189643d8">CACHE_INODE_SUCCESS</a>;
<a name="l00164"></a>00164      <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2">cache_inode_status_t</a> cache_status_gethandle = <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2a3fdbbb2367268ae84ac11d7b189643d8">CACHE_INODE_SUCCESS</a>;
<a name="l00165"></a>00165      <span class="keywordtype">int</span> rc = <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>;
<a name="l00166"></a>00166      <span class="keyword">struct </span><a class="code" href="structnfs2__readdir__cb__data.html" title="Opaque bookkeeping structure for NFSv2 readdir.">nfs2_readdir_cb_data</a> cb2 = {<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00167"></a>00167      <span class="keyword">struct </span><a class="code" href="structnfs3__readdir__cb__data.html" title="Opaque bookkeeping structure for NFSv3 readdir.">nfs3_readdir_cb_data</a> cb3 = {<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00168"></a>00168      <a class="code" href="cache__inode_8h.html#ae15b4790d2635a17e60170281546aa01" title="Type of callback for cache_inode_readdir.">cache_inode_readdir_cb_t</a> cbfunc;
<a name="l00169"></a>00169      <span class="keywordtype">void</span> *cbdata;
<a name="l00170"></a>00170      <a class="code" href="structcache__entry__t.html" title="Represents a cached inode.">cache_entry_t</a> *parent_dir_entry = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172      <span class="keywordflow">if</span> (<a class="code" href="log_8h.html#ac778c7aeca566b747dd5bb1baecb6316">isDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556af6e90cb9d43106e13df4e83652c94f27">COMPONENT_NFSPROTO</a>) || <a class="code" href="log_8h.html#ac778c7aeca566b747dd5bb1baecb6316">isDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a7c25ed8c28010a9bc4de72ef249316a9">COMPONENT_NFS_READDIR</a>)) {
<a name="l00173"></a>00173           <span class="keywordtype">char</span> str[<a class="code" href="nfs__file__handle_8h.html#add3fa684cef3f27ade6bb43b7b22e7cf">LEN_FH_STR</a>];
<a name="l00174"></a>00174           <a class="code" href="log_8h.html#a80c77121778df3130d72817d3d1a9451">log_components_t</a> component;
<a name="l00175"></a>00175           <a class="code" href="nfs__proto__tools_8h.html#af8a0cfaf3ea5c49ec0ea0f157a7b90ab">nfs_FhandleToStr</a>(req-&gt;rq_vers,
<a name="l00176"></a>00176                            &amp;(arg-&gt;<a class="code" href="group__NFSprocs.html#ga3055b5c7839544bb0236013043a6af23">arg_readdir2</a>.<a class="code" href="structREADDIR2args.html#a0d000aff5087bb3f5e30cf1695e78bba">dir</a>),
<a name="l00177"></a>00177                            &amp;(arg-&gt;<a class="code" href="group__NFSprocs.html#gac0ab90166dbe6a767cb7637f06c14c72">arg_readdir3</a>.<a class="code" href="structREADDIR3args.html#a8d23dc5a8c875175b3ed0b6a088f4b53">dir</a>),
<a name="l00178"></a>00178                            <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00179"></a>00179                            str);
<a name="l00180"></a>00180           <span class="keywordflow">if</span>(<a class="code" href="log_8h.html#ac778c7aeca566b747dd5bb1baecb6316">isDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556af6e90cb9d43106e13df4e83652c94f27">COMPONENT_NFSPROTO</a>)) {
<a name="l00181"></a>00181                component = <a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556af6e90cb9d43106e13df4e83652c94f27">COMPONENT_NFSPROTO</a>;
<a name="l00182"></a>00182           } <span class="keywordflow">else</span> {
<a name="l00183"></a>00183                component = <a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a7c25ed8c28010a9bc4de72ef249316a9">COMPONENT_NFS_READDIR</a>;
<a name="l00184"></a>00184           }
<a name="l00185"></a>00185           <a class="code" href="log_8h.html#aa7aee8ec65b5baafb430f8d2a7588d53">LogDebug</a>(component,
<a name="l00186"></a>00186                    <span class="stringliteral">&quot;REQUEST PROCESSING: Calling nfs_Readdir handle: %s&quot;</span>, str);
<a name="l00187"></a>00187      }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189      <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ad0f0a57c0aacb6093af91d085b807cbd">NFS_V3</a>) {
<a name="l00190"></a>00190           <span class="comment">/* to avoid setting it on each error case */</span>
<a name="l00191"></a>00191           res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#a1eb6557d88762b90ca354104d0bd7987">READDIR3res_u</a>.<a class="code" href="structREADDIR3res.html#a2a42e1cc720b7d6da40bc4e2fc91e665">resfail</a>.<a class="code" href="structREADDIR3resfail.html#a02dc42db1e8c2132d9a4d7b51eeed7f3">dir_attributes</a>
<a name="l00192"></a>00192                .<a class="code" href="structpost__op__attr.html#a7eed0c4cb54b1759439f7b9d69e3f818">attributes_follow</a> = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00193"></a>00193      }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195      <span class="comment">/* Look up cache entry for filehandle */</span>
<a name="l00196"></a>00196      <span class="keywordflow">if</span> ((dir_entry
<a name="l00197"></a>00197           = <a class="code" href="nfs__proto__tools_8h.html#a8228cc616abf625c61190a8e50769fc1">nfs_FhandleToCache</a>(req-&gt;rq_vers,
<a name="l00198"></a>00198                                &amp;(arg-&gt;<a class="code" href="group__NFSprocs.html#ga3055b5c7839544bb0236013043a6af23">arg_readdir2</a>.<a class="code" href="structREADDIR2args.html#a0d000aff5087bb3f5e30cf1695e78bba">dir</a>),
<a name="l00199"></a>00199                                &amp;(arg-&gt;<a class="code" href="group__NFSprocs.html#gac0ab90166dbe6a767cb7637f06c14c72">arg_readdir3</a>.<a class="code" href="structREADDIR3args.html#a8d23dc5a8c875175b3ed0b6a088f4b53">dir</a>),
<a name="l00200"></a>00200                                <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00201"></a>00201                                &amp;(res-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#afa6d0c5a85a537586fa0ac963f0eead4">status</a>),
<a name="l00202"></a>00202                                &amp;(res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a>),
<a name="l00203"></a>00203                                <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00204"></a>00204                                &amp;dir_attr,
<a name="l00205"></a>00205                                context,
<a name="l00206"></a>00206                                &amp;rc)) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00207"></a>00207           <span class="comment">/* Stale NFS FH? */</span>
<a name="l00208"></a>00208           <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00209"></a>00209      }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211      <span class="keywordflow">if</span> ((req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ad0f0a57c0aacb6093af91d085b807cbd">NFS_V3</a>) &amp;&amp;
<a name="l00212"></a>00212          (<a class="code" href="nfs__file__handle_8h.html#a668b574eeda3bc36c6b891636a37a82d">nfs3_Is_Fh_Xattr</a>(&amp;(arg-&gt;<a class="code" href="group__NFSprocs.html#gac0ab90166dbe6a767cb7637f06c14c72">arg_readdir3</a>.<a class="code" href="structREADDIR3args.html#a8d23dc5a8c875175b3ed0b6a088f4b53">dir</a>)))) {
<a name="l00213"></a>00213           rc = <a class="code" href="group__NFSprocs.html#ga7d3038e94eaf30335e1b076d608a75f3">nfs3_Readdir_Xattr</a>(arg, export, context, req, res);
<a name="l00214"></a>00214           <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00215"></a>00215      }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217      <span class="comment">/* Extract the filetype */</span>
<a name="l00218"></a>00218      dir_filetype = <a class="code" href="cache__inode__misc_8c.html#a8f6934bbf38300379caf1342b6a63b26" title="converts an FSAL type to the corresponding cache_inode type">cache_inode_fsal_type_convert</a>(dir_attr.<a class="code" href="structfsal__attrib__list____.html#a03249aca39ba1b16b4712079d93b025e">type</a>);
<a name="l00219"></a>00219      <span class="comment">/* Sanity checks -- must be a directory */</span>
<a name="l00220"></a>00220      <span class="keywordflow">if</span> (dir_filetype != <a class="code" href="cache__inode_8h.html#a2aee8d2ff73574138b75922c7652162fa9d09f58160b1161920aad19080f568cc">DIRECTORY</a>) {
<a name="l00221"></a>00221           <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ab7bf618affb552e91b562c195b52b6a7">NFS_V2</a>) {
<a name="l00222"></a>00222                <span class="comment">/* In the RFC tell it not good but it does not tell</span>
<a name="l00223"></a>00223 <span class="comment">                  what to do ... */</span>
<a name="l00224"></a>00224                res-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#afa6d0c5a85a537586fa0ac963f0eead4">status</a> = <a class="code" href="nfs23_8h.html#a7aa4ec59cb08c181dab1f366d0c06778a24f5ab8f84177e3e02837643c1eed2c1">NFSERR_NOTDIR</a>;
<a name="l00225"></a>00225           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ad0f0a57c0aacb6093af91d085b807cbd">NFS_V3</a>) {
<a name="l00226"></a>00226                res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a> = <a class="code" href="nfs23_8h.html#a1721ade9b8e43c719c5834eaaf60aac5a209f5840d7c6405e49354fb906ecc98b">NFS3ERR_NOTDIR</a>;
<a name="l00227"></a>00227           }
<a name="l00228"></a>00228           rc = <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>;
<a name="l00229"></a>00229           <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00230"></a>00230      }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232      <span class="comment">/* Parse out request arguments and decide how many entries we</span>
<a name="l00233"></a>00233 <span class="comment">        want.  For NFSv3, deal with the cookie verifier. */</span>
<a name="l00234"></a>00234 
<a name="l00235"></a>00235      <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ab7bf618affb552e91b562c195b52b6a7">NFS_V2</a>) {
<a name="l00236"></a>00236           count = (arg-&gt;<a class="code" href="group__NFSprocs.html#ga3055b5c7839544bb0236013043a6af23">arg_readdir2</a>.<a class="code" href="structREADDIR2args.html#ac6df5af18c0ed40d506dc2d063f5ca0f">count</a> * 9) / 10;
<a name="l00237"></a>00237           memcpy(&amp;cookie, arg-&gt;<a class="code" href="group__NFSprocs.html#ga3055b5c7839544bb0236013043a6af23">arg_readdir2</a>.<a class="code" href="structREADDIR2args.html#a8378d8b4c2cd91ef5cc5e8e810ed77db">cookie</a>, <a class="code" href="nfs23_8h.html#a8dc3490d4217e755ed64ed35c7b1b2e2">NFS2_COOKIESIZE</a>);
<a name="l00238"></a>00238           estimated_num_entries = <a class="code" href="test5_8c.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(50, count / <span class="keyword">sizeof</span>(<a class="code" href="structentry2.html">entry2</a>));
<a name="l00239"></a>00239           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a7c25ed8c28010a9bc4de72ef249316a9">COMPONENT_NFS_READDIR</a>,
<a name="l00240"></a>00240                        <span class="stringliteral">&quot;-- Readdir2 -&gt; count=%lu  cookie = %&quot;</span>PRIu64<span class="stringliteral">&quot;  &quot;</span>
<a name="l00241"></a>00241                        <span class="stringliteral">&quot;estimated_num_entries=%lu&quot;</span>, count, cookie,
<a name="l00242"></a>00242                        estimated_num_entries);
<a name="l00243"></a>00243           <span class="keywordflow">if</span> (estimated_num_entries == 0) {
<a name="l00244"></a>00244                res-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#afa6d0c5a85a537586fa0ac963f0eead4">status</a> = <a class="code" href="nfs23_8h.html#a7aa4ec59cb08c181dab1f366d0c06778a579c9b7724e68a522d8ea09cf95f95fe">NFSERR_IO</a>;
<a name="l00245"></a>00245                rc = <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>;
<a name="l00246"></a>00246                <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00247"></a>00247           }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249           cb2.<a class="code" href="structnfs2__readdir__cb__data.html#a550a4e14ab704ed9e41968e5c5716d47">entries</a> = gsh_calloc(estimated_num_entries,
<a name="l00250"></a>00250                                    <span class="keyword">sizeof</span>(<a class="code" href="structentry2.html">entry2</a>));
<a name="l00251"></a>00251           <span class="keywordflow">if</span> (cb2.<a class="code" href="structnfs2__readdir__cb__data.html#a550a4e14ab704ed9e41968e5c5716d47">entries</a> == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00252"></a>00252                rc = <a class="code" href="group__NFSprocs.html#gad48913a4e6ea3bdaca974a4c4fccd6c2">NFS_REQ_DROP</a>;
<a name="l00253"></a>00253                <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00254"></a>00254           }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256           cb2.<a class="code" href="structnfs2__readdir__cb__data.html#ada3f78b8b0e8f6f091612637613e4fcb">total_entries</a> = estimated_num_entries;
<a name="l00257"></a>00257           cb2.<a class="code" href="structnfs2__readdir__cb__data.html#a06e055f72b94291370503dbd97efe435">mem_left</a> = count - <span class="keyword">sizeof</span>(<a class="code" href="nfs23_8h.html#a490a21e6279ba48e00c9c1817fe5e136">READDIR2resok</a>);
<a name="l00258"></a>00258           cb2.<a class="code" href="structnfs2__readdir__cb__data.html#ad5a81f25b5f808d9994b0738cc5e6dda">count</a> = 0;
<a name="l00259"></a>00259           cb2.<a class="code" href="structnfs2__readdir__cb__data.html#a1a264a7e3f703172227f781bfc9cacce">context</a> = <a class="code" href="structnfs3__readdir__cb__data.html#a024e3b803cfa00a9081c3de04279ebec">context</a>;
<a name="l00260"></a>00260           cb2.<a class="code" href="structnfs2__readdir__cb__data.html#a1ac879789b54a3c5e7821e28ac7c8755">error</a> = <a class="code" href="nfs23_8h.html#a7aa4ec59cb08c181dab1f366d0c06778ab31cf3caaf8dd2ab122a66434db73c96">NFS_OK</a>;
<a name="l00261"></a>00261           cbfunc = nfs2_readdir_callback;
<a name="l00262"></a>00262           cbdata = &amp;cb2;
<a name="l00263"></a>00263      } <span class="keywordflow">else</span> {
<a name="l00264"></a>00264           count = (arg-&gt;<a class="code" href="group__NFSprocs.html#gac0ab90166dbe6a767cb7637f06c14c72">arg_readdir3</a>.<a class="code" href="structREADDIR3args.html#a8aad396e861425299615e21ed1cacb56">count</a> * 9 / 10);
<a name="l00265"></a>00265           cookie = arg-&gt;<a class="code" href="group__NFSprocs.html#gac0ab90166dbe6a767cb7637f06c14c72">arg_readdir3</a>.<a class="code" href="structREADDIR3args.html#a23558c5ecfa732069b457300b32b5723">cookie</a>;
<a name="l00266"></a>00266           estimated_num_entries = <a class="code" href="test5_8c.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(count / <span class="keyword">sizeof</span>(<a class="code" href="structentry3.html">entry3</a>), 50);
<a name="l00267"></a>00267           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a7c25ed8c28010a9bc4de72ef249316a9">COMPONENT_NFS_READDIR</a>,
<a name="l00268"></a>00268                        <span class="stringliteral">&quot;---&gt; nfs3_Readdir: count=%lu  cookie=%&quot;</span>PRIu64<span class="stringliteral">&quot;  &quot;</span>
<a name="l00269"></a>00269                        <span class="stringliteral">&quot;estimated_num_entries=%lu&quot;</span>,
<a name="l00270"></a>00270                        count, cookie, estimated_num_entries);
<a name="l00271"></a>00271           <span class="keywordflow">if</span> (estimated_num_entries == 0) {
<a name="l00272"></a>00272                res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a> = <a class="code" href="nfs23_8h.html#a1721ade9b8e43c719c5834eaaf60aac5af9affc48ca762f3962543440cce051e4">NFS3ERR_TOOSMALL</a>;
<a name="l00273"></a>00273                rc = <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>;
<a name="l00274"></a>00274                <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00275"></a>00275           }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277           <span class="comment">/* To make or check the cookie verifier */</span>
<a name="l00278"></a>00278           memset(cookie_verifier, 0, <span class="keyword">sizeof</span>(<a class="code" href="nfs23_8h.html#a774acc42a913991b53f0c266319d432a">cookieverf3</a>));
<a name="l00279"></a>00279           <span class="comment">/* If cookie verifier is used, then a</span>
<a name="l00280"></a>00280 <span class="comment">             non-trivial value is returned to the</span>
<a name="l00281"></a>00281 <span class="comment">             client.</span>
<a name="l00282"></a>00282 <span class="comment"></span>
<a name="l00283"></a>00283 <span class="comment">             This value is the mtime of the directory. If verifier is</span>
<a name="l00284"></a>00284 <span class="comment">             unused (as in many NFS Servers) then only a set of zeros</span>
<a name="l00285"></a>00285 <span class="comment">             is returned (trivial value). */</span>
<a name="l00286"></a>00286           <span class="keywordflow">if</span> (export-&gt;<a class="code" href="structexportlist____.html#a43954aa643a0c3d4eb2498d964b412dc">UseCookieVerifier</a>)
<a name="l00287"></a>00287                memcpy(cookie_verifier,
<a name="l00288"></a>00288                       &amp;(dir_attr.<a class="code" href="structfsal__attrib__list____.html#a441daefe7cc86152355f895d81bc2936">mtime</a>),
<a name="l00289"></a>00289                       <span class="keyword">sizeof</span>(dir_attr.<a class="code" href="structfsal__attrib__list____.html#a441daefe7cc86152355f895d81bc2936">mtime</a>));
<a name="l00290"></a>00290           <span class="comment">/* Nothing to do if != 0 because the area is already full of</span>
<a name="l00291"></a>00291 <span class="comment">             zero */</span>
<a name="l00292"></a>00292           <span class="keywordflow">if</span> ((cookie != 0) &amp;&amp;
<a name="l00293"></a>00293               (export-&gt;<a class="code" href="structexportlist____.html#a43954aa643a0c3d4eb2498d964b412dc">UseCookieVerifier</a>)) {
<a name="l00294"></a>00294                <span class="comment">/* Not the first call, so we have to check the cookie</span>
<a name="l00295"></a>00295 <span class="comment">                  verifier */</span>
<a name="l00296"></a>00296                <span class="keywordflow">if</span> (memcmp(cookie_verifier,
<a name="l00297"></a>00297                           arg-&gt;<a class="code" href="group__NFSprocs.html#gac0ab90166dbe6a767cb7637f06c14c72">arg_readdir3</a>.<a class="code" href="structREADDIR3args.html#ab5f19f4fb79541202750e79c9cd6ec54">cookieverf</a>,
<a name="l00298"></a>00298                           <a class="code" href="nfs23_8h.html#ae12e942a6a60ea34191e330e53b1e9b1">NFS3_COOKIEVERFSIZE</a>) != 0) {
<a name="l00299"></a>00299                     res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a> = <a class="code" href="nfs23_8h.html#a1721ade9b8e43c719c5834eaaf60aac5a8104dd997541859f9605571955b48cf2">NFS3ERR_BAD_COOKIE</a>;
<a name="l00300"></a>00300                     rc = <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>;
<a name="l00301"></a>00301                     <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00302"></a>00302                }
<a name="l00303"></a>00303           }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305           cb3.<a class="code" href="structnfs3__readdir__cb__data.html#a571bff8b40a66b5d9cf8643cb3bfeec4">entries</a> = gsh_calloc(estimated_num_entries,
<a name="l00306"></a>00306                                    <span class="keyword">sizeof</span>(<a class="code" href="structentry3.html">entry3</a>));
<a name="l00307"></a>00307           <span class="keywordflow">if</span> (cb3.<a class="code" href="structnfs3__readdir__cb__data.html#a571bff8b40a66b5d9cf8643cb3bfeec4">entries</a> == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00308"></a>00308                rc = <a class="code" href="group__NFSprocs.html#gad48913a4e6ea3bdaca974a4c4fccd6c2">NFS_REQ_DROP</a>;
<a name="l00309"></a>00309                <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00310"></a>00310           }
<a name="l00311"></a>00311           cb3.<a class="code" href="structnfs3__readdir__cb__data.html#a172a99ae853b0c4161dcb7516117a8c9">total_entries</a> = estimated_num_entries;
<a name="l00312"></a>00312           cb3.<a class="code" href="structnfs3__readdir__cb__data.html#abb5ab6236eb8bd776f91523e7e568153">mem_left</a> = count - <span class="keyword">sizeof</span>(<a class="code" href="nfs23_8h.html#a02821dbb25c7f44c03cbb5640da5d8a6">READDIR3resok</a>);
<a name="l00313"></a>00313           cb3.<a class="code" href="structnfs3__readdir__cb__data.html#ab5a4fab3e7b9ff2743e066f8000acd0c">count</a> = 0;
<a name="l00314"></a>00314           cb3.<a class="code" href="structnfs3__readdir__cb__data.html#a024e3b803cfa00a9081c3de04279ebec">context</a> = <a class="code" href="structnfs3__readdir__cb__data.html#a024e3b803cfa00a9081c3de04279ebec">context</a>;
<a name="l00315"></a>00315           cb3.<a class="code" href="structnfs3__readdir__cb__data.html#a12cf5d3808fb78b9981d2f13cd2871f0">error</a> = <a class="code" href="nfs23_8h.html#a7aa4ec59cb08c181dab1f366d0c06778ab31cf3caaf8dd2ab122a66434db73c96">NFS_OK</a>;
<a name="l00316"></a>00316           cbfunc = nfs3_readdir_callback;
<a name="l00317"></a>00317           cbdata = &amp;cb3;
<a name="l00318"></a>00318      }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320      <span class="comment">/* Adjust the cookie we supply to cache_inode */</span>
<a name="l00321"></a>00321      <span class="keywordflow">if</span> (cookie &gt; 2)  <span class="comment">/* it is not the cookie for &quot;.&quot; nor &quot;..&quot; */</span> {
<a name="l00322"></a>00322           cache_inode_cookie = cookie;
<a name="l00323"></a>00323      } <span class="keywordflow">else</span> {
<a name="l00324"></a>00324           cache_inode_cookie = 0;
<a name="l00325"></a>00325      }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327      <span class="comment">/* Fills &quot;.&quot;  */</span>
<a name="l00328"></a>00328      <span class="keywordflow">if</span> (cookie == 0) {
<a name="l00329"></a>00329           <span class="keywordflow">if</span> (!cbfunc(cbdata, <span class="stringliteral">&quot;.&quot;</span>, &amp;dir_entry-&gt;<a class="code" href="structcache__entry__t.html#aaa7abf75d0997dba12395a01c09be705">handle</a>, &amp;dir_attr, 1))
<a name="l00330"></a>00330                 <span class="keywordflow">goto</span> outerr;
<a name="l00331"></a>00331      }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333      <span class="comment">/* Fills &quot;..&quot; */</span>
<a name="l00334"></a>00334      <span class="keywordflow">if</span> ((cookie &lt;= 1) &amp;&amp; (estimated_num_entries &gt; 1)) {
<a name="l00335"></a>00335           <a class="code" href="structfsal__attrib__list____.html">fsal_attrib_list_t</a> parent_dir_attr;
<a name="l00336"></a>00336           <span class="comment">/* Get parent pentry */</span>
<a name="l00337"></a>00337           parent_dir_entry = <a class="code" href="cache__inode__lookupp_8c.html#a67ba9f31113205922a6a17cc37971a9c" title="Public function to look up a directory&amp;#39;s parent.">cache_inode_lookupp</a>(dir_entry,
<a name="l00338"></a>00338                                                  context,
<a name="l00339"></a>00339                                                  &amp;cache_status_gethandle);
<a name="l00340"></a>00340           <span class="keywordflow">if</span> (parent_dir_entry == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00341"></a>00341                <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ab7bf618affb552e91b562c195b52b6a7">NFS_V2</a>) {
<a name="l00342"></a>00342                     res-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#afa6d0c5a85a537586fa0ac963f0eead4">status</a>
<a name="l00343"></a>00343                          = <a class="code" href="group__NFSprocs.html#ga90fe1b6090478dd005254a847ecb287e">nfs2_Errno</a>(cache_status_gethandle);
<a name="l00344"></a>00344                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ad0f0a57c0aacb6093af91d085b807cbd">NFS_V3</a>) {
<a name="l00345"></a>00345                     res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a>
<a name="l00346"></a>00346                          = <a class="code" href="group__NFSprocs.html#gaa4f9710cdfa7157d9b730110d4cb0621">nfs3_Errno</a>(cache_status_gethandle);
<a name="l00347"></a>00347                }
<a name="l00348"></a>00348                rc = <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>;
<a name="l00349"></a>00349                <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00350"></a>00350           }
<a name="l00351"></a>00351           <span class="keywordflow">if</span> ((<a class="code" href="cache__inode__getattr_8c.html#a08ad01b43bf9ec833899b526cea387bf" title="Gets the attributes for a cached entry.">cache_inode_getattr</a>(parent_dir_entry,
<a name="l00352"></a>00352                                    &amp;parent_dir_attr,
<a name="l00353"></a>00353                                    context,
<a name="l00354"></a>00354                                    &amp;cache_status_gethandle))
<a name="l00355"></a>00355               != <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2a3fdbbb2367268ae84ac11d7b189643d8">CACHE_INODE_SUCCESS</a>) {
<a name="l00356"></a>00356                <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ab7bf618affb552e91b562c195b52b6a7">NFS_V2</a>) {
<a name="l00357"></a>00357                     res-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#afa6d0c5a85a537586fa0ac963f0eead4">status</a>
<a name="l00358"></a>00358                          = <a class="code" href="group__NFSprocs.html#ga90fe1b6090478dd005254a847ecb287e">nfs2_Errno</a>(cache_status_gethandle);
<a name="l00359"></a>00359                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ad0f0a57c0aacb6093af91d085b807cbd">NFS_V3</a>) {
<a name="l00360"></a>00360                     res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a>
<a name="l00361"></a>00361                          = <a class="code" href="group__NFSprocs.html#gaa4f9710cdfa7157d9b730110d4cb0621">nfs3_Errno</a>(cache_status_gethandle);
<a name="l00362"></a>00362                }
<a name="l00363"></a>00363                rc = <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>;
<a name="l00364"></a>00364                <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00365"></a>00365           }
<a name="l00366"></a>00366           <span class="keywordflow">if</span> (!cbfunc(cbdata, <span class="stringliteral">&quot;..&quot;</span>, &amp;parent_dir_entry-&gt;<a class="code" href="structcache__entry__t.html#aaa7abf75d0997dba12395a01c09be705">handle</a>,
<a name="l00367"></a>00367                       &amp;parent_dir_attr, 2))
<a name="l00368"></a>00368                 <span class="keywordflow">goto</span> outerr;
<a name="l00369"></a>00369           <a class="code" href="cache__inode__get_8c.html#a8ff682b5012ccc7a46cb876664d0a7a2">cache_inode_put</a>(parent_dir_entry);
<a name="l00370"></a>00370           parent_dir_entry = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00371"></a>00371      }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="comment">/* Some definitions that will be very useful to avoid very long names</span>
<a name="l00374"></a>00374 <span class="comment">   for variables */</span>
<a name="l00375"></a>00375 <span class="preprocessor">#define RES_READDIR2_OK   res-&gt;res_readdir2.READDIR2res_u.readdirok</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span><span class="preprocessor">#define RES_READDIR3_OK   res-&gt;res_readdir3.READDIR3res_u.resok</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span><span class="preprocessor">#define RES_READDIR3_FAIL res-&gt;res_readdir3.READDIR3res_u.resfail</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span>
<a name="l00379"></a>00379      <span class="comment">/* Call readdir */</span>
<a name="l00380"></a>00380      <span class="keywordflow">if</span> (<a class="code" href="cache__inode__readdir_8c.html#a4bedd92e6b201a9fff52ba1751f0b770" title="Reads a directory.">cache_inode_readdir</a>(dir_entry,
<a name="l00381"></a>00381                              cache_inode_cookie,
<a name="l00382"></a>00382                              &amp;num_entries,
<a name="l00383"></a>00383                              &amp;eod_met,
<a name="l00384"></a>00384                              context,
<a name="l00385"></a>00385                              cbfunc,
<a name="l00386"></a>00386                              cbdata,
<a name="l00387"></a>00387                              &amp;cache_status) != <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2a3fdbbb2367268ae84ac11d7b189643d8">CACHE_INODE_SUCCESS</a>) {
<a name="l00388"></a>00388           <span class="keywordflow">if</span> (<a class="code" href="nfs__proto__tools_8h.html#a42b9be27d5c5fd939c1eeb7e8b9e96df">nfs_RetryableError</a>(cache_status)) {
<a name="l00389"></a>00389                rc = <a class="code" href="group__NFSprocs.html#gad48913a4e6ea3bdaca974a4c4fccd6c2">NFS_REQ_DROP</a>;
<a name="l00390"></a>00390                <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00391"></a>00391           }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393           <a class="code" href="nfs__proto__tools_8h.html#ac2de99fb1ffdf13ba2047ff934da0956">nfs_SetFailedStatus</a>(context, export,
<a name="l00394"></a>00394                               req-&gt;rq_vers,
<a name="l00395"></a>00395                               cache_status,
<a name="l00396"></a>00396                               &amp;res-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#afa6d0c5a85a537586fa0ac963f0eead4">status</a>,
<a name="l00397"></a>00397                               &amp;res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a>,
<a name="l00398"></a>00398                               dir_entry,
<a name="l00399"></a>00399                               &amp;(res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#a1eb6557d88762b90ca354104d0bd7987">READDIR3res_u</a>
<a name="l00400"></a>00400                                 .<a class="code" href="structREADDIR3res.html#a2a42e1cc720b7d6da40bc4e2fc91e665">resfail</a>.<a class="code" href="structREADDIR3resfail.html#a02dc42db1e8c2132d9a4d7b51eeed7f3">dir_attributes</a>),
<a name="l00401"></a>00401                               <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00402"></a>00402           <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00403"></a>00403      }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405      <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a7c25ed8c28010a9bc4de72ef249316a9">COMPONENT_NFS_READDIR</a>,
<a name="l00406"></a>00406                   <span class="stringliteral">&quot;-- Readdir -&gt; Call to &quot;</span>
<a name="l00407"></a>00407                   <span class="stringliteral">&quot;cache_inode_readdir(cookie=%&quot;</span>PRIu64
<a name="l00408"></a>00408                   <span class="stringliteral">&quot; -&gt; num_entries = %u&quot;</span>,
<a name="l00409"></a>00409                   cache_inode_cookie,
<a name="l00410"></a>00410                   num_entries);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412      <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ab7bf618affb552e91b562c195b52b6a7">NFS_V2</a>) {
<a name="l00413"></a>00413           <a class="code" href="nfs__Readdir_8c.html#a014aea009f0abc4518680917f80a9f75">RES_READDIR2_OK</a>.entries = cb2.<a class="code" href="structnfs2__readdir__cb__data.html#a550a4e14ab704ed9e41968e5c5716d47">entries</a>;
<a name="l00414"></a>00414           <a class="code" href="nfs__Readdir_8c.html#a014aea009f0abc4518680917f80a9f75">RES_READDIR2_OK</a>.eof = eod_met;
<a name="l00415"></a>00415      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ad0f0a57c0aacb6093af91d085b807cbd">NFS_V3</a>) {
<a name="l00416"></a>00416           <a class="code" href="nfs__Readdir_8c.html#a46f20d02f9ff0ea771cd02d3459520b1">RES_READDIR3_OK</a>.reply.entries = cb3.<a class="code" href="structnfs3__readdir__cb__data.html#a571bff8b40a66b5d9cf8643cb3bfeec4">entries</a>;
<a name="l00417"></a>00417           <a class="code" href="nfs__Readdir_8c.html#a46f20d02f9ff0ea771cd02d3459520b1">RES_READDIR3_OK</a>.reply.eof = eod_met;
<a name="l00418"></a>00418           <a class="code" href="nfs__proto__tools_8h.html#a2c06fec5fb15635d2e89a2d552b4459f">nfs_SetPostOpAttr</a>(export,
<a name="l00419"></a>00419                             &amp;dir_attr,
<a name="l00420"></a>00420                             &amp;(<a class="code" href="nfs__Readdir_8c.html#a46f20d02f9ff0ea771cd02d3459520b1">RES_READDIR3_OK</a>.dir_attributes));
<a name="l00421"></a>00421           memcpy(<a class="code" href="nfs__Readdir_8c.html#a46f20d02f9ff0ea771cd02d3459520b1">RES_READDIR3_OK</a>.cookieverf,
<a name="l00422"></a>00422                  cookie_verifier,
<a name="l00423"></a>00423                  <span class="keyword">sizeof</span>(<a class="code" href="nfs23_8h.html#a774acc42a913991b53f0c266319d432a">cookieverf3</a>));
<a name="l00424"></a>00424           res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a> = <a class="code" href="nfs23_8h.html#a1721ade9b8e43c719c5834eaaf60aac5ae705552b166e565f66540b9412805365">NFS3_OK</a>;
<a name="l00425"></a>00425      }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427      rc = <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>:
<a name="l00430"></a>00430      <span class="comment">/* return references */</span>
<a name="l00431"></a>00431      <span class="keywordflow">if</span> (dir_entry) {
<a name="l00432"></a>00432           <a class="code" href="cache__inode__get_8c.html#a8ff682b5012ccc7a46cb876664d0a7a2">cache_inode_put</a>(dir_entry);
<a name="l00433"></a>00433      }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435      <span class="keywordflow">if</span> (parent_dir_entry) {
<a name="l00436"></a>00436           <a class="code" href="cache__inode__get_8c.html#a8ff682b5012ccc7a46cb876664d0a7a2">cache_inode_put</a>(parent_dir_entry);
<a name="l00437"></a>00437      }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439      <span class="comment">/* Deallocate memory in the event of an error */</span>
<a name="l00440"></a>00440      <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ab7bf618affb552e91b562c195b52b6a7">NFS_V2</a>) {
<a name="l00441"></a>00441           <span class="keywordflow">if</span> (((res-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#afa6d0c5a85a537586fa0ac963f0eead4">status</a> != <a class="code" href="nfs23_8h.html#a7aa4ec59cb08c181dab1f366d0c06778ab31cf3caaf8dd2ab122a66434db73c96">NFS_OK</a>) ||
<a name="l00442"></a>00442                (rc != <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>)) &amp;&amp;
<a name="l00443"></a>00443               (cb2.<a class="code" href="structnfs2__readdir__cb__data.html#a550a4e14ab704ed9e41968e5c5716d47">entries</a> != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00444"></a>00444                free_entry2s(cb2.<a class="code" href="structnfs2__readdir__cb__data.html#a550a4e14ab704ed9e41968e5c5716d47">entries</a>);
<a name="l00445"></a>00445                <a class="code" href="nfs__Readdir_8c.html#a014aea009f0abc4518680917f80a9f75">RES_READDIR2_OK</a>.entries = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00446"></a>00446           }
<a name="l00447"></a>00447      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ad0f0a57c0aacb6093af91d085b807cbd">NFS_V3</a>) {
<a name="l00448"></a>00448           <span class="keywordflow">if</span> (((res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a> != <a class="code" href="nfs23_8h.html#a1721ade9b8e43c719c5834eaaf60aac5ae705552b166e565f66540b9412805365">NFS3_OK</a>) ||
<a name="l00449"></a>00449                (rc != <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>)) &amp;&amp;
<a name="l00450"></a>00450               (cb3.<a class="code" href="structnfs3__readdir__cb__data.html#a571bff8b40a66b5d9cf8643cb3bfeec4">entries</a> != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00451"></a>00451                free_entry3s(cb3.<a class="code" href="structnfs3__readdir__cb__data.html#a571bff8b40a66b5d9cf8643cb3bfeec4">entries</a>);
<a name="l00452"></a>00452                <a class="code" href="nfs__Readdir_8c.html#a46f20d02f9ff0ea771cd02d3459520b1">RES_READDIR3_OK</a>.reply.entries = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00453"></a>00453           }
<a name="l00454"></a>00454      }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456      <span class="keywordflow">return</span> rc;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 outerr:
<a name="l00459"></a>00459      <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ab7bf618affb552e91b562c195b52b6a7">NFS_V2</a>) {
<a name="l00460"></a>00460           assert(cbdata == &amp;cb2);
<a name="l00461"></a>00461           res-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#afa6d0c5a85a537586fa0ac963f0eead4">status</a> = cb2.<a class="code" href="structnfs2__readdir__cb__data.html#a1ac879789b54a3c5e7821e28ac7c8755">error</a>;
<a name="l00462"></a>00462      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (req-&gt;rq_vers == <a class="code" href="nfs23_8h.html#ad0f0a57c0aacb6093af91d085b807cbd">NFS_V3</a>) {
<a name="l00463"></a>00463           assert(cbdata == &amp;cb3);
<a name="l00464"></a>00464           res-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a> = cb3.<a class="code" href="structnfs3__readdir__cb__data.html#a12cf5d3808fb78b9981d2f13cd2871f0">error</a>;
<a name="l00465"></a>00465      }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467      <span class="keywordflow">goto</span> <a class="code" href="test__nfs__ip__name_8c.html#a0204bbf34f64a80680c73f74564b6d22">out</a>;
<a name="l00468"></a>00468 } <span class="comment">/* nfs_Readdir */</span>
<a name="l00469"></a>00469 
<a name="l00478"></a><a class="code" href="group__NFSprocs.html#ga084dabf08482aadf9b743eadf2baafe4">00478</a> <span class="keywordtype">void</span> <a class="code" href="group__NFSprocs.html#ga084dabf08482aadf9b743eadf2baafe4">nfs2_Readdir_Free</a>(<a class="code" href="unionnfs__res____.html">nfs_res_t</a> * resp)
<a name="l00479"></a>00479 {
<a name="l00480"></a>00480      <span class="keywordflow">if</span> ((resp-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#afa6d0c5a85a537586fa0ac963f0eead4">status</a> == <a class="code" href="nfs23_8h.html#a7aa4ec59cb08c181dab1f366d0c06778ab31cf3caaf8dd2ab122a66434db73c96">NFS_OK</a>) &amp;&amp;
<a name="l00481"></a>00481          (resp-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#a120738085bcfae5aa7d0e37052fc2842">READDIR2res_u</a>.<a class="code" href="structREADDIR2res.html#a4707533b0df565560beaa5516b86ca89">readdirok</a>.<a class="code" href="structREADDIR2resok.html#a7338be3ff34ae9d63ade4784de9fced0">entries</a> != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00482"></a>00482           free_entry2s(resp-&gt;<a class="code" href="group__NFSprocs.html#ga54ec3265d048c980d0ba361bd3bdd356">res_readdir2</a>.<a class="code" href="structREADDIR2res.html#a120738085bcfae5aa7d0e37052fc2842">READDIR2res_u</a>.<a class="code" href="structREADDIR2res.html#a4707533b0df565560beaa5516b86ca89">readdirok</a>.<a class="code" href="structREADDIR2resok.html#a7338be3ff34ae9d63ade4784de9fced0">entries</a>);
<a name="l00483"></a>00483      }
<a name="l00484"></a>00484 } <span class="comment">/* nfs2_Readdir_Free */</span>
<a name="l00485"></a>00485 
<a name="l00494"></a><a class="code" href="group__NFSprocs.html#ga902eec2e2d7ec8f317d76985d9af2a56">00494</a> <span class="keywordtype">void</span> <a class="code" href="group__NFSprocs.html#ga902eec2e2d7ec8f317d76985d9af2a56">nfs3_Readdir_Free</a>(<a class="code" href="unionnfs__res____.html">nfs_res_t</a> * resp)
<a name="l00495"></a>00495 {
<a name="l00496"></a>00496      <span class="keywordflow">if</span> ((resp-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#ab64bb5d01348b4cf9addb7430dd1f551">status</a> == <a class="code" href="nfs23_8h.html#a1721ade9b8e43c719c5834eaaf60aac5ae705552b166e565f66540b9412805365">NFS3_OK</a>) &amp;&amp;
<a name="l00497"></a>00497          (resp-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#a1eb6557d88762b90ca354104d0bd7987">READDIR3res_u</a>.<a class="code" href="structREADDIR3res.html#a8f590ab782e757297b1f5c35c4defd0c">resok</a>.<a class="code" href="structREADDIR3resok.html#a7ba2bfa9ab96b863aae07c54236dd3b9">reply</a>.<a class="code" href="structdirlist3.html#a67038caf7a11594aff12c0c3156f4116">entries</a> != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00498"></a>00498           free_entry3s(resp-&gt;<a class="code" href="group__NFSprocs.html#gac0aa7ad2fbd3d380997cd43c576bf8cd">res_readdir3</a>.<a class="code" href="structREADDIR3res.html#a1eb6557d88762b90ca354104d0bd7987">READDIR3res_u</a>.<a class="code" href="structREADDIR3res.html#a8f590ab782e757297b1f5c35c4defd0c">resok</a>.<a class="code" href="structREADDIR3resok.html#a7ba2bfa9ab96b863aae07c54236dd3b9">reply</a>.<a class="code" href="structdirlist3.html#a67038caf7a11594aff12c0c3156f4116">entries</a>);
<a name="l00499"></a>00499      }
<a name="l00500"></a>00500 } <span class="comment">/* nfs3_Readdir_Free */</span>
<a name="l00501"></a>00501 
<a name="l00518"></a>00518 <span class="keyword">static</span> bool_t
<a name="l00519"></a>00519 nfs2_readdir_callback(<span class="keywordtype">void</span>* opaque,
<a name="l00520"></a>00520                       <span class="keywordtype">char</span> *<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>,
<a name="l00521"></a>00521                       <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *handle,
<a name="l00522"></a>00522                       <a class="code" href="structfsal__attrib__list____.html">fsal_attrib_list_t</a> *attrs,
<a name="l00523"></a>00523                       <a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> cookie)
<a name="l00524"></a>00524 {
<a name="l00525"></a>00525      <span class="comment">/* Not-so-opaque pointer to callback data`*/</span>
<a name="l00526"></a>00526      <span class="keyword">struct </span><a class="code" href="structnfs2__readdir__cb__data.html" title="Opaque bookkeeping structure for NFSv2 readdir.">nfs2_readdir_cb_data</a> *tracker =
<a name="l00527"></a>00527           (<span class="keyword">struct </span><a class="code" href="structnfs2__readdir__cb__data.html" title="Opaque bookkeeping structure for NFSv2 readdir.">nfs2_readdir_cb_data</a> *) opaque;
<a name="l00528"></a>00528      <span class="comment">/* Space needed for this entry&#39;s filename */</span>
<a name="l00529"></a>00529      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> namelen = strlen(name);
<a name="l00530"></a>00530      <span class="comment">/* A big-endian representation of the least significant</span>
<a name="l00531"></a>00531 <span class="comment">        thirty-to bits of the cookie. */</span>
<a name="l00532"></a>00532      <a class="code" href="extended__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> truncookie = htonl((<a class="code" href="extended__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>) cookie);
<a name="l00533"></a>00533      <a class="code" href="structentry2.html">entry2</a> *e2 = tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#a550a4e14ab704ed9e41968e5c5716d47">entries</a> + tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#ad5a81f25b5f808d9994b0738cc5e6dda">count</a>;
<a name="l00534"></a>00534      <span class="comment">/* Fileid descriptor */</span>
<a name="l00535"></a>00535      <span class="keyword">struct </span><a class="code" href="structfsal__handle__desc.html">fsal_handle_desc</a> id_descriptor
<a name="l00536"></a>00536           = {<span class="keyword">sizeof</span>(e2-&gt;<a class="code" href="structentry2.html#abbd9a58eb8734866fe74d811697f45ef">fileid</a>), (caddr_t) &amp;e2-&gt;<a class="code" href="structentry2.html#abbd9a58eb8734866fe74d811697f45ef">fileid</a>};
<a name="l00537"></a>00537      <span class="keywordtype">size_t</span> need = <span class="keyword">sizeof</span>(<a class="code" href="nfs23_8h.html#a2362ea53ea7a12aab234acf8b4cb9aca">entry2</a>) + ((namelen + 3) &amp; ~3) + 4;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539      <span class="keywordflow">if</span> (tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#ad5a81f25b5f808d9994b0738cc5e6dda">count</a> == tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#ada3f78b8b0e8f6f091612637613e4fcb">total_entries</a>) {
<a name="l00540"></a>00540           <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00541"></a>00541      }
<a name="l00542"></a>00542      <span class="keywordflow">if</span> (tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#a06e055f72b94291370503dbd97efe435">mem_left</a> &lt; (<span class="keyword">sizeof</span>(<a class="code" href="structentry2.html">entry2</a>) + namelen)) {
<a name="l00543"></a>00543           <span class="keywordflow">if</span> (tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#ad5a81f25b5f808d9994b0738cc5e6dda">count</a> == 0) {
<a name="l00544"></a>00544                tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#a1ac879789b54a3c5e7821e28ac7c8755">error</a> = <a class="code" href="nfs23_8h.html#a7aa4ec59cb08c181dab1f366d0c06778a579c9b7724e68a522d8ea09cf95f95fe">NFSERR_IO</a>;
<a name="l00545"></a>00545           }
<a name="l00546"></a>00546           <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00547"></a>00547      }
<a name="l00548"></a>00548      <a class="code" href="fsal__glue_8c.html#a4c4e6ee7b7965e763c6ce8bc835a6aee">FSAL_DigestHandle</a>(<a class="code" href="fsal_8h.html#a8ff5e5c930dcb77fbb19ab95d2350fc2">FSAL_GET_EXP_CTX</a>(tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#a1a264a7e3f703172227f781bfc9cacce">context</a>),
<a name="l00549"></a>00549                        <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fa4f39e103f1d1e66786e47a0b4d00e584">FSAL_DIGEST_FILEID2</a>,
<a name="l00550"></a>00550                        handle,
<a name="l00551"></a>00551                        &amp;id_descriptor);
<a name="l00552"></a>00552      e2-&gt;<a class="code" href="structentry2.html#a11ab28f7bfe85a7904962f485a513754">name</a> = gsh_malloc(namelen + 1);
<a name="l00553"></a>00553      <span class="keywordflow">if</span> (e2-&gt;<a class="code" href="structentry2.html#a11ab28f7bfe85a7904962f485a513754">name</a> == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00554"></a>00554           tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#a1ac879789b54a3c5e7821e28ac7c8755">error</a> = <a class="code" href="nfs23_8h.html#a7aa4ec59cb08c181dab1f366d0c06778a579c9b7724e68a522d8ea09cf95f95fe">NFSERR_IO</a>;
<a name="l00555"></a>00555           <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00556"></a>00556      }
<a name="l00557"></a>00557      strcpy(e2-&gt;<a class="code" href="structentry2.html#a11ab28f7bfe85a7904962f485a513754">name</a>, name);
<a name="l00558"></a>00558      memcpy(e2-&gt;<a class="code" href="structentry2.html#a95e3bfaf872152d0aac24c032baae72b">cookie</a>, &amp;truncookie, <a class="code" href="nfs23_8h.html#a8dc3490d4217e755ed64ed35c7b1b2e2">NFS2_COOKIESIZE</a>);
<a name="l00559"></a>00559      <span class="keywordflow">if</span> (tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#ad5a81f25b5f808d9994b0738cc5e6dda">count</a> != 0) {
<a name="l00560"></a>00560           tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#a550a4e14ab704ed9e41968e5c5716d47">entries</a>[tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#ad5a81f25b5f808d9994b0738cc5e6dda">count</a> - 1].<a class="code" href="structentry2.html#ae958ee2312cab66cb374bedc4c1ebb6c">nextentry</a> = e2;
<a name="l00561"></a>00561      }
<a name="l00562"></a>00562      tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#a06e055f72b94291370503dbd97efe435">mem_left</a> -= need;
<a name="l00563"></a>00563      ++(tracker-&gt;<a class="code" href="structnfs2__readdir__cb__data.html#ad5a81f25b5f808d9994b0738cc5e6dda">count</a>);
<a name="l00564"></a>00564      <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00565"></a>00565 } <span class="comment">/* nfs2_readdir_callback */</span>
<a name="l00566"></a>00566 
<a name="l00583"></a>00583 <span class="keyword">static</span> bool_t
<a name="l00584"></a>00584 nfs3_readdir_callback(<span class="keywordtype">void</span>* opaque,
<a name="l00585"></a>00585                       <span class="keywordtype">char</span> *name,
<a name="l00586"></a>00586                       <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *handle,
<a name="l00587"></a>00587                       <a class="code" href="structfsal__attrib__list____.html">fsal_attrib_list_t</a> *attrs,
<a name="l00588"></a>00588                       <a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> cookie)
<a name="l00589"></a>00589 {
<a name="l00590"></a>00590      <span class="comment">/* Not-so-opaque pointer to callback data`*/</span>
<a name="l00591"></a>00591      <span class="keyword">struct </span><a class="code" href="structnfs3__readdir__cb__data.html" title="Opaque bookkeeping structure for NFSv3 readdir.">nfs3_readdir_cb_data</a> *tracker =
<a name="l00592"></a>00592           (<span class="keyword">struct </span><a class="code" href="structnfs3__readdir__cb__data.html" title="Opaque bookkeeping structure for NFSv3 readdir.">nfs3_readdir_cb_data</a> *) opaque;
<a name="l00593"></a>00593      <span class="comment">/* Length of the current filename */</span>
<a name="l00594"></a>00594      <span class="keywordtype">size_t</span> namelen = strlen(name);
<a name="l00595"></a>00595      <a class="code" href="structentry3.html">entry3</a> *e3 = tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#a571bff8b40a66b5d9cf8643cb3bfeec4">entries</a> + tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#ab5a4fab3e7b9ff2743e066f8000acd0c">count</a>;
<a name="l00596"></a>00596      <span class="comment">/* Fileid descriptor */</span>
<a name="l00597"></a>00597      <span class="keyword">struct </span><a class="code" href="structfsal__handle__desc.html">fsal_handle_desc</a> id_descriptor
<a name="l00598"></a>00598           = {<span class="keyword">sizeof</span>(e3-&gt;<a class="code" href="structentry3.html#a49753496a3576afcebb9fd7890697675">fileid</a>), (caddr_t) &amp;e3-&gt;<a class="code" href="structentry3.html#a49753496a3576afcebb9fd7890697675">fileid</a>};
<a name="l00599"></a>00599      <span class="keywordtype">size_t</span> need = <span class="keyword">sizeof</span>(<a class="code" href="nfs23_8h.html#ab646825eac14f7d6cbef2c93198a5431">entry3</a>) + ((namelen + 3) &amp; ~3) + 4;
<a name="l00600"></a>00600 
<a name="l00601"></a>00601      <span class="keywordflow">if</span> (tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#ab5a4fab3e7b9ff2743e066f8000acd0c">count</a> == tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#a172a99ae853b0c4161dcb7516117a8c9">total_entries</a>) {
<a name="l00602"></a>00602           <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00603"></a>00603      }
<a name="l00604"></a>00604      <span class="keywordflow">if</span> ((tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#abb5ab6236eb8bd776f91523e7e568153">mem_left</a> &lt; need)) {
<a name="l00605"></a>00605           <span class="keywordflow">if</span> (tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#ab5a4fab3e7b9ff2743e066f8000acd0c">count</a> == 0) {
<a name="l00606"></a>00606                tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#a12cf5d3808fb78b9981d2f13cd2871f0">error</a> = <a class="code" href="nfs23_8h.html#a1721ade9b8e43c719c5834eaaf60aac5af9affc48ca762f3962543440cce051e4">NFS3ERR_TOOSMALL</a>;
<a name="l00607"></a>00607           }
<a name="l00608"></a>00608           <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00609"></a>00609      }
<a name="l00610"></a>00610      <a class="code" href="fsal__glue_8c.html#a4c4e6ee7b7965e763c6ce8bc835a6aee">FSAL_DigestHandle</a>(<a class="code" href="fsal_8h.html#a8ff5e5c930dcb77fbb19ab95d2350fc2">FSAL_GET_EXP_CTX</a>(tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#a024e3b803cfa00a9081c3de04279ebec">context</a>),
<a name="l00611"></a>00611                        <a class="code" href="fsal__types_8h.html#a6b861e58fd209b5146465e558f0a547fafdc65a8250795f8cc7bd8492fe740bca">FSAL_DIGEST_FILEID3</a>,
<a name="l00612"></a>00612                        handle,
<a name="l00613"></a>00613                        &amp;id_descriptor);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615      e3-&gt;<a class="code" href="structentry3.html#a33aa657a1fd2b6be6824c6181656cd3d">name</a> = gsh_malloc(namelen + 1);
<a name="l00616"></a>00616      <span class="keywordflow">if</span> (e3-&gt;<a class="code" href="structentry3.html#a33aa657a1fd2b6be6824c6181656cd3d">name</a> == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00617"></a>00617           tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#a12cf5d3808fb78b9981d2f13cd2871f0">error</a> = <a class="code" href="nfs23_8h.html#a1721ade9b8e43c719c5834eaaf60aac5ab7c8b15a1e3430e7eb532260f0f7ede5">NFS3ERR_IO</a>;
<a name="l00618"></a>00618           <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00619"></a>00619      }
<a name="l00620"></a>00620      strcpy(e3-&gt;<a class="code" href="structentry3.html#a33aa657a1fd2b6be6824c6181656cd3d">name</a>, name);
<a name="l00621"></a>00621      e3-&gt;<a class="code" href="structentry3.html#abea67210c6fed25df853d885906d7af6">cookie</a> = cookie;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623      <span class="keywordflow">if</span> (tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#ab5a4fab3e7b9ff2743e066f8000acd0c">count</a> &gt; 0) {
<a name="l00624"></a>00624           tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#a571bff8b40a66b5d9cf8643cb3bfeec4">entries</a>[tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#ab5a4fab3e7b9ff2743e066f8000acd0c">count</a> - 1].<a class="code" href="structentry3.html#af0a6d8ceec056d063472a744d7da3500">nextentry</a> = e3;
<a name="l00625"></a>00625      }
<a name="l00626"></a>00626      tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#abb5ab6236eb8bd776f91523e7e568153">mem_left</a> -= need;
<a name="l00627"></a>00627      ++(tracker-&gt;<a class="code" href="structnfs3__readdir__cb__data.html#ab5a4fab3e7b9ff2743e066f8000acd0c">count</a>);
<a name="l00628"></a>00628      <span class="keywordflow">return</span> <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00629"></a>00629 } <span class="comment">/* */</span>
<a name="l00630"></a>00630 
<a name="l00640"></a>00640 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00641"></a>00641 free_entry2s(<a class="code" href="structentry2.html">entry2</a> *entry2s)
<a name="l00642"></a>00642 {
<a name="l00643"></a>00643      <a class="code" href="structentry2.html">entry2</a> *entry = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645      <span class="keywordflow">for</span> (entry = entry2s;
<a name="l00646"></a>00646           entry != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00647"></a>00647           entry = entry-&gt;<a class="code" href="structentry2.html#ae958ee2312cab66cb374bedc4c1ebb6c">nextentry</a>) {
<a name="l00648"></a>00648           gsh_free(entry-&gt;<a class="code" href="structentry2.html#a11ab28f7bfe85a7904962f485a513754">name</a>);
<a name="l00649"></a>00649      }
<a name="l00650"></a>00650      gsh_free(entry2s);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652      <span class="keywordflow">return</span>;
<a name="l00653"></a>00653 } <span class="comment">/* free_entry2s */</span>
<a name="l00654"></a>00654 
<a name="l00664"></a>00664 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00665"></a>00665 free_entry3s(<a class="code" href="structentry3.html">entry3</a> *entry3s)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667      <a class="code" href="structentry3.html">entry3</a> *entry = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00668"></a>00668 
<a name="l00669"></a>00669      <span class="keywordflow">for</span> (entry = entry3s;
<a name="l00670"></a>00670           entry != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00671"></a>00671           entry = entry-&gt;<a class="code" href="structentry3.html#af0a6d8ceec056d063472a744d7da3500">nextentry</a>) {
<a name="l00672"></a>00672           gsh_free(entry-&gt;<a class="code" href="structentry3.html#a33aa657a1fd2b6be6824c6181656cd3d">name</a>);
<a name="l00673"></a>00673      }
<a name="l00674"></a>00674      gsh_free(entry3s);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676      <span class="keywordflow">return</span>;
<a name="l00677"></a>00677 } <span class="comment">/* free_entry3s */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 21 2012 for nfs-ganesha by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
