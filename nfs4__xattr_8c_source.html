<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>nfs-ganesha: nfs4_xattr.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nfs-ganesha&#160;<span id="projectnumber">1.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>nfs4_xattr.c</h1>  </div>
</div>
<div class="contents">
<a href="nfs4__xattr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
<a name="l00005"></a>00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
<a name="l00006"></a>00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00010"></a>00010 <span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
<a name="l00011"></a>00011 <span class="comment"> * License as published by the Free Software Foundation; either</span>
<a name="l00012"></a>00012 <span class="comment"> * version 3 of the License, or (at your option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment"> * </span>
<a name="l00014"></a>00014 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00017"></a>00017 <span class="comment"> * Lesser General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> * </span>
<a name="l00019"></a>00019 <span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<a name="l00020"></a>00020 <span class="comment"> * License along with this library; if not, write to the Free Software</span>
<a name="l00021"></a>00021 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="l00022"></a>00022 <span class="comment"> * </span>
<a name="l00023"></a>00023 <span class="comment"> * ---------------------------------------</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00036"></a>00036 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#endif</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span>
<a name="l00040"></a>00040 <span class="preprocessor">#ifdef _SOLARIS</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#include &quot;solaris_port.h&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#endif</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>           <span class="comment">/* for having FNDELAY */</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;HashData.h&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;HashTable.h&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;ganesha_rpc.h&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;nfs4.h&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;nfs_core.h&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;nfs_proto_functions.h&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;nfs_tools.h&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;nfs_exports.h&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;nfs_file_handle.h&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;cache_inode.h&quot;</span>
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="group__NFSprocs.html#ga258f1eeb0cfc4284bc58148675cf3974">00061</a> <span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#ga258f1eeb0cfc4284bc58148675cf3974">nfs4_XattrToFattr</a>(<a class="code" href="structfattr4.html">fattr4</a> * Fattr,
<a name="l00062"></a>00062                       <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data, <a class="code" href="structnfs__fh4.html">nfs_fh4</a> * objFH, <a class="code" href="structbitmap4.html">bitmap4</a> * Bitmap)
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064   <a class="code" href="nfsv40_8h.html#a3a7fa6581b5a2a9e178e185038cf3040">fattr4_type</a> file_type;
<a name="l00065"></a>00065   <a class="code" href="nfsv40_8h.html#a70669df1ecb560c16276cf2be7677c43">fattr4_link_support</a> link_support;
<a name="l00066"></a>00066   <a class="code" href="nfsv40_8h.html#a2571d69ab47ae4f77715615eba6a08cc">fattr4_symlink_support</a> symlink_support;
<a name="l00067"></a>00067   <a class="code" href="nfsv40_8h.html#adff8a2989ac38c0d03880f57ba9303bc">fattr4_fh_expire_type</a> expire_type;
<a name="l00068"></a>00068   <a class="code" href="nfsv40_8h.html#a0caec3e1ed5926c96ef1ec1eee6235e8">fattr4_named_attr</a> named_attr;
<a name="l00069"></a>00069   <a class="code" href="nfsv40_8h.html#aa1e7e5291e1d6051d5c66bd1b1354430">fattr4_unique_handles</a> unique_handles;
<a name="l00070"></a>00070   <a class="code" href="nfsv40_8h.html#aa035fbdb57ad14ee5a53df3529e7c9da">fattr4_archive</a> archive;
<a name="l00071"></a>00071   <a class="code" href="nfsv40_8h.html#a5f1739eb4ec7b12be513c56ca8b70c66">fattr4_cansettime</a> cansettime;
<a name="l00072"></a>00072   <a class="code" href="nfsv40_8h.html#ac268d448d82099af657dacbc99dbc905">fattr4_case_insensitive</a> case_insensitive;
<a name="l00073"></a>00073   <a class="code" href="nfsv40_8h.html#aec0f2426d6bae8755ab1930bf5102658">fattr4_case_preserving</a> case_preserving;
<a name="l00074"></a>00074   <a class="code" href="nfsv40_8h.html#a116b6ba06a0d8cca6b57b7b7d9aa3349">fattr4_chown_restricted</a> chown_restricted;
<a name="l00075"></a>00075   <a class="code" href="nfsv40_8h.html#a8120e5f8df361c3ebeb1916c165078bc">fattr4_hidden</a> hidden;
<a name="l00076"></a>00076   <a class="code" href="nfsv40_8h.html#a2e828d4ef9dbc26b02c1d7bdd134f75a">fattr4_mode</a> file_mode;
<a name="l00077"></a>00077   <a class="code" href="nfsv40_8h.html#abe8fba0236debb7f0eab5c0253e2202b">fattr4_no_trunc</a> no_trunc;
<a name="l00078"></a>00078   <a class="code" href="nfsv40_8h.html#a5dcff0ef8b51f21c45fff7847ebb9458">fattr4_numlinks</a> file_numlinks;
<a name="l00079"></a>00079   <a class="code" href="structspecdata4.html">fattr4_rawdev</a> rawdev;
<a name="l00080"></a>00080   <a class="code" href="nfsv40_8h.html#a971609879b3ba95b8624e15ac8c583f5">fattr4_system</a> system;
<a name="l00081"></a>00081   <a class="code" href="nfsv40_8h.html#ae000375dc5e2bf5948e198baef0f6060">fattr4_size</a> file_size;
<a name="l00082"></a>00082   <a class="code" href="nfsv40_8h.html#ae058190bc78422118c9fe20cb0b2872d">fattr4_space_used</a> file_space_used;
<a name="l00083"></a>00083   <a class="code" href="structfsid4.html">fattr4_fsid</a> fsid;
<a name="l00084"></a>00084   <a class="code" href="structnfstime4.html">fattr4_time_access</a> time_access;
<a name="l00085"></a>00085   <a class="code" href="structnfstime4.html">fattr4_time_modify</a> time_modify;
<a name="l00086"></a>00086   <a class="code" href="structnfstime4.html">fattr4_time_metadata</a> time_metadata;
<a name="l00087"></a>00087   <a class="code" href="structnfstime4.html">fattr4_time_delta</a> time_delta;
<a name="l00088"></a>00088   <a class="code" href="structnfstime4.html">fattr4_time_backup</a> time_backup;
<a name="l00089"></a>00089   <a class="code" href="structnfstime4.html">fattr4_time_create</a> time_create;
<a name="l00090"></a>00090   <a class="code" href="nfsv40_8h.html#a71ffc916e5afbba5e732c8ebfd0f93f1">fattr4_change</a> file_change;
<a name="l00091"></a>00091   <a class="code" href="nfsv40_8h.html#a439aa2213ecdeca95541878dbac665ce">fattr4_fileid</a> file_id;
<a name="l00092"></a>00092   <a class="code" href="structutf8string.html">fattr4_owner</a> file_owner;
<a name="l00093"></a>00093   <a class="code" href="structutf8string.html">fattr4_owner_group</a> file_owner_group;
<a name="l00094"></a>00094   <a class="code" href="nfsv40_8h.html#af43e37c36a94d243a287d9ae382ea2c1">fattr4_space_avail</a> space_avail;
<a name="l00095"></a>00095   <a class="code" href="nfsv40_8h.html#aa1b93cee6fd181d4e37c78b60c36c7c0">fattr4_space_free</a> space_free;
<a name="l00096"></a>00096   <a class="code" href="nfsv40_8h.html#a8222d546e768d600afe234bdab099b68">fattr4_space_total</a> space_total;
<a name="l00097"></a>00097   <a class="code" href="nfsv40_8h.html#a2df3c0c622dbce1e4c73db0096b70213">fattr4_files_avail</a> files_avail;
<a name="l00098"></a>00098   <a class="code" href="nfsv40_8h.html#ae7ad78fb448db95b5545894156f9b996">fattr4_files_free</a> files_free;
<a name="l00099"></a>00099   <a class="code" href="nfsv40_8h.html#a8216d12a43183daaa6f924c45b1c5efd">fattr4_files_total</a> files_total;
<a name="l00100"></a>00100   <a class="code" href="nfsv40_8h.html#af8c7252d498e365e082a16fa6125353f">fattr4_lease_time</a> lease_time;
<a name="l00101"></a>00101   <a class="code" href="nfsv40_8h.html#a2f6b48cb1e1cb28f755ae82ae55a0091">fattr4_maxfilesize</a> max_filesize;
<a name="l00102"></a>00102   <a class="code" href="nfsv40_8h.html#a7b945f194e331ff1de1a1b504acd8653">fattr4_maxread</a> maxread;
<a name="l00103"></a>00103   <a class="code" href="nfsv40_8h.html#a97511d36675af4dccb1b13491ee7548f">fattr4_maxwrite</a> maxwrite;
<a name="l00104"></a>00104   <a class="code" href="nfsv40_8h.html#a670e98120e5313fcf9137bc1f8650572">fattr4_maxname</a> maxname;
<a name="l00105"></a>00105   <a class="code" href="nfsv40_8h.html#a53f35021913624dbc01dff3374d67534">fattr4_maxlink</a> maxlink;
<a name="l00106"></a>00106   <a class="code" href="nfsv40_8h.html#af62163d32be592400ddca7a03de92a12">fattr4_homogeneous</a> homogeneous;
<a name="l00107"></a>00107   <a class="code" href="structfattr4__acl.html">fattr4_acl</a> acl;
<a name="l00108"></a>00108   <a class="code" href="structutf8string.html">fattr4_mimetype</a> mimetype;
<a name="l00109"></a>00109   <a class="code" href="nfsv40_8h.html#a0c54ef8ddd13f9b3d9ffa0128c687075">fattr4_aclsupport</a> aclsupport;
<a name="l00110"></a>00110   <a class="code" href="nfsv40_8h.html#a3dc776327cdd947498a5b212f98269e7">fattr4_quota_avail_hard</a> quota_avail_hard;
<a name="l00111"></a>00111   <a class="code" href="nfsv40_8h.html#a05b31a0c0394721c59d731a4acc62b18">fattr4_quota_avail_soft</a> quota_avail_soft;
<a name="l00112"></a>00112   <a class="code" href="nfsv40_8h.html#af6c58c71fcfa900ceb25e27197cdf646">fattr4_quota_used</a> quota_used;
<a name="l00113"></a>00113   <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0a">fattr4_rdattr_error</a> rdattr_error;
<a name="l00114"></a>00114   <a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *pfile_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00115"></a>00115   <a class="code" href="structfsal__attrib__list____.html">fsal_attrib_list_t</a> fsalattr;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117   u_int fhandle_len = 0;
<a name="l00118"></a>00118   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> LastOffset;
<a name="l00119"></a>00119   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len = 0, off = 0;        <span class="comment">/* Use for XDR alignment */</span>
<a name="l00120"></a>00120   <span class="keywordtype">int</span> op_attr_success = 0;
<a name="l00121"></a>00121   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;
<a name="l00122"></a>00122   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0;
<a name="l00123"></a>00123   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> attrmasklen = 0;
<a name="l00124"></a>00124   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> attribute_to_set = 0;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> attrmasklist[<a class="code" href="nfsv40_8h.html#aee5e5c06f383e00c90378fabc96deaee">FATTR4_MOUNTED_ON_FILEID</a>];  <span class="comment">/* List cannot be longer than FATTR4_MOUNTED_ON_FILEID */</span>
<a name="l00127"></a>00127   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> attrvalslist[<a class="code" href="nfsv40_8h.html#aee5e5c06f383e00c90378fabc96deaee">FATTR4_MOUNTED_ON_FILEID</a>];  <span class="comment">/* List cannot be longer than FATTR4_MOUNTED_ON_FILEID */</span>
<a name="l00128"></a>00128   <span class="keywordtype">char</span> attrvalsBuffer[<a class="code" href="nfs__tools_8h.html#af43b31f46bb53819fcd39ae77c8fe9d1">ATTRVALS_BUFFLEN</a>];
<a name="l00129"></a>00129 
<a name="l00130"></a>00130   <span class="keywordtype">char</span> <a class="code" href="group__NFSprocs.html#ga7efec2b565bdbe409979ac657775eeaa">__attribute__</a> ((__unused__)) funcname[] = <span class="stringliteral">&quot;nfs4_XattrToFattr&quot;</span>;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132   pfile_handle = (<a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *) (objFH-&gt;<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   <span class="comment">/* memset to make sure the arrays are initiated to 0 */</span>
<a name="l00135"></a>00135   memset(attrvalsBuffer, 0, <a class="code" href="nfs__proto__functions_8h.html#ac4b92be64dea477ba31b26b2714e0ae4">NFS4_ATTRVALS_BUFFLEN</a>);
<a name="l00136"></a>00136   memset(&amp;attrmasklist, 0, <a class="code" href="nfsv40_8h.html#aee5e5c06f383e00c90378fabc96deaee">FATTR4_MOUNTED_ON_FILEID</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l00137"></a>00137   memset(&amp;attrvalslist, 0, <a class="code" href="nfsv40_8h.html#aee5e5c06f383e00c90378fabc96deaee">FATTR4_MOUNTED_ON_FILEID</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l00138"></a>00138 
<a name="l00139"></a>00139   <span class="comment">/* Convert the attribute bitmap to an attribute list */</span>
<a name="l00140"></a>00140   <a class="code" href="group__NFSprocs.html#gabd872db7513463c6ddadeec986c69051">nfs4_bitmap4_to_list</a>(Bitmap, &amp;attrmasklen, attrmasklist);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142   <span class="comment">/* Once the bitmap has been converted to a list of attribute, manage each attribute */</span>
<a name="l00143"></a>00143   Fattr-&gt;<a class="code" href="structfattr4.html#aaec7d166bce03e6cf76ce9d06f88540e">attr_vals</a>.<a class="code" href="structattrlist4.html#ad931f11e5a1224bb94fa4eaac78cfa13">attrlist4_len</a> = 0;
<a name="l00144"></a>00144   LastOffset = 0;
<a name="l00145"></a>00145   j = 0;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00148"></a>00148                <span class="stringliteral">&quot;Asked Attributes (Pseudo): Bitmap = (len=%d, val[0]=%d, val[1]=%d), %d item in list&quot;</span>,
<a name="l00149"></a>00149                Bitmap-&gt;<a class="code" href="structbitmap4.html#afd18333034a15d0d8427f6c58f2e110a">bitmap4_len</a>, Bitmap-&gt;<a class="code" href="structbitmap4.html#a6b68a1ee274affc9d8cd0a810a6a0164">bitmap4_val</a>[0], Bitmap-&gt;<a class="code" href="structbitmap4.html#a6b68a1ee274affc9d8cd0a810a6a0164">bitmap4_val</a>[1],
<a name="l00150"></a>00150                attrmasklen);
<a name="l00151"></a>00151 
<a name="l00152"></a>00152   <span class="keywordflow">for</span>(i = 0; i &lt; attrmasklen; i++)
<a name="l00153"></a>00153     {
<a name="l00154"></a>00154       attribute_to_set = attrmasklist[i];
<a name="l00155"></a>00155 
<a name="l00156"></a>00156       <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00157"></a>00157                    <span class="stringliteral">&quot;Flag for Operation (Pseudo) = %d|%d is ON,  name  = %s  reply_size = %d&quot;</span>,
<a name="l00158"></a>00158                    attrmasklist[i], fattr4tab[attribute_to_set].val,
<a name="l00159"></a>00159                    fattr4tab[attribute_to_set].<a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>,
<a name="l00160"></a>00160                    fattr4tab[attribute_to_set].size_fattr4);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162       op_attr_success = 0;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164       <span class="comment">/* compute the new size for the fattr4 reply */</span>
<a name="l00165"></a>00165       <span class="comment">/* This space is to be filled below in the big switch/case statement */</span>
<a name="l00166"></a>00166 
<a name="l00167"></a>00167       <span class="keywordflow">switch</span> (attribute_to_set)
<a name="l00168"></a>00168         {
<a name="l00169"></a>00169         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a0b40c74ec5d17a87e0e368b0517fe587">FATTR4_SUPPORTED_ATTRS</a>:
<a name="l00170"></a>00170           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00171"></a>00171                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_SUPPORTED_ATTRS&quot;</span>);
<a name="l00172"></a>00172           LastOffset += <a class="code" href="group__NFSprocs.html#gabfcce8a2830b3bf95455a1a08c32bae8">nfs4_supported_attrs_to_fattr</a>(attrvalsBuffer+LastOffset);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174           <span class="comment">/* This kind of operation is always a success */</span>
<a name="l00175"></a>00175           op_attr_success = 1;
<a name="l00176"></a>00176           <span class="keywordflow">break</span>;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#abb174f647b2425ed9d75aca5067395b8">FATTR4_TYPE</a>:
<a name="l00179"></a>00179           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00180"></a>00180                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_TYPE&quot;</span>);
<a name="l00181"></a>00181 
<a name="l00182"></a>00182           op_attr_success = 1;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184           <span class="keywordflow">if</span>(pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> == 1)
<a name="l00185"></a>00185             file_type = htonl(<a class="code" href="nfsv40_8h.html#a3a7fa6581b5a2a9e178e185038cf3040abe9a491648d379ed4349c4e14d05d861">NF4DIR</a>);  <span class="comment">/* There are only directories in the pseudo fs */</span>
<a name="l00186"></a>00186           <span class="keywordflow">else</span>
<a name="l00187"></a>00187             file_type = htonl(<a class="code" href="nfsv40_8h.html#a3a7fa6581b5a2a9e178e185038cf3040a239da84394e28d87d64fe16c4e741434">NF4REG</a>);
<a name="l00188"></a>00188 
<a name="l00189"></a>00189           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;file_type, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a3a7fa6581b5a2a9e178e185038cf3040">fattr4_type</a>));
<a name="l00190"></a>00190           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00191"></a>00191           <span class="keywordflow">break</span>;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a5ed19d3fb209db5890e88447460f285f">FATTR4_FH_EXPIRE_TYPE</a>:
<a name="l00194"></a>00194           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00195"></a>00195                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_FH_EXPIRE_TYPE&quot;</span>);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197           <span class="comment">/* For the moment, we handle only the persistent filehandle */</span>
<a name="l00198"></a>00198           <span class="comment">/* expire_type = htonl( FH4_VOLATILE_ANY ) ; */</span>
<a name="l00199"></a>00199           expire_type = htonl(<a class="code" href="nfsv40_8h.html#a8ca903d8fd4b74e4bb0d543292cec50a">FH4_PERSISTENT</a>);
<a name="l00200"></a>00200           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;expire_type,
<a name="l00201"></a>00201                  <span class="keyword">sizeof</span>(expire_type));
<a name="l00202"></a>00202           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00203"></a>00203           op_attr_success = 1;
<a name="l00204"></a>00204           <span class="keywordflow">break</span>;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a8691d62fc300ed27650afc28f7b3da15">FATTR4_CHANGE</a>:
<a name="l00207"></a>00207           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00208"></a>00208                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_CHANGE&quot;</span>);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210           <span class="comment">/* Use boot time as time value for every pseudo fs object */</span>
<a name="l00211"></a>00211           memset(&amp;file_change, 0, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a188972b4ccdd37df707acf964b3ef6c9">changeid4</a>));
<a name="l00212"></a>00212           file_change = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#a188972b4ccdd37df707acf964b3ef6c9">changeid4</a>) time(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));
<a name="l00213"></a>00213 
<a name="l00214"></a>00214           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;file_change,
<a name="l00215"></a>00215                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a71ffc916e5afbba5e732c8ebfd0f93f1">fattr4_change</a>));
<a name="l00216"></a>00216           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00217"></a>00217           op_attr_success = 1;
<a name="l00218"></a>00218           <span class="keywordflow">break</span>;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a08162b3359ba8b437d89090e76f9f079">FATTR4_SIZE</a>:
<a name="l00221"></a>00221           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00222"></a>00222                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_SIZE&quot;</span>);
<a name="l00223"></a>00223 
<a name="l00224"></a>00224           file_size = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#ae000375dc5e2bf5948e198baef0f6060">fattr4_size</a>) DEV_BSIZE);
<a name="l00225"></a>00225           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;file_size, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#ae000375dc5e2bf5948e198baef0f6060">fattr4_size</a>));
<a name="l00226"></a>00226           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00227"></a>00227           op_attr_success = 1;
<a name="l00228"></a>00228           <span class="keywordflow">break</span>;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#aec89ffab45626439fefb1e2651e48e63">FATTR4_LINK_SUPPORT</a>:
<a name="l00231"></a>00231           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00232"></a>00232                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_LINK_SUPPORT&quot;</span>);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234           <span class="comment">/* HPSS NameSpace support hard link */</span>
<a name="l00235"></a>00235           link_support = htonl(<a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00236"></a>00236           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;link_support,
<a name="l00237"></a>00237                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a70669df1ecb560c16276cf2be7677c43">fattr4_link_support</a>));
<a name="l00238"></a>00238           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00239"></a>00239           op_attr_success = 1;
<a name="l00240"></a>00240           <span class="keywordflow">break</span>;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a16e679badc58a66f4737098ca720539f">FATTR4_SYMLINK_SUPPORT</a>:
<a name="l00243"></a>00243           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00244"></a>00244                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_SYMLINK_SUPPORT&quot;</span>);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246           <span class="comment">/* HPSS NameSpace support symbolic link */</span>
<a name="l00247"></a>00247           symlink_support = htonl(<a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00248"></a>00248           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;symlink_support,
<a name="l00249"></a>00249                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a2571d69ab47ae4f77715615eba6a08cc">fattr4_symlink_support</a>));
<a name="l00250"></a>00250           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00251"></a>00251           op_attr_success = 1;
<a name="l00252"></a>00252           <span class="keywordflow">break</span>;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#affe2dfbefc8ff527b79a989860638c11">FATTR4_NAMED_ATTR</a>:
<a name="l00255"></a>00255           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00256"></a>00256                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_NAMED_ATTR&quot;</span>);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258           <span class="comment">/* For this version of the binary, named attributes is not supported */</span>
<a name="l00259"></a>00259           named_attr = htonl(<a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00260"></a>00260           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;named_attr,
<a name="l00261"></a>00261                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a0caec3e1ed5926c96ef1ec1eee6235e8">fattr4_named_attr</a>));
<a name="l00262"></a>00262           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00263"></a>00263           op_attr_success = 1;
<a name="l00264"></a>00264           <span class="keywordflow">break</span>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a8aafd7594d6a927a537b9d61e7cb2cb6">FATTR4_FSID</a>:
<a name="l00267"></a>00267           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00268"></a>00268                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_FSID&quot;</span>);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270           fsid.<a class="code" href="structfsid4.html#a0f882261ff714aef7afd1345b7599a38">major</a> = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a>) data-&gt;<a class="code" href="structcompoud__data.html#aa44e02b685a675a6beb59faac8c9dc78">pexport</a>-&gt;<a class="code" href="structexportlist____.html#a0f81c1008714a0ce0039397cd3fab832">filesystem_id</a>.<a class="code" href="structfsal__fsid____.html#a86fa6b41da5905b04e531bd530c1573c">major</a>);
<a name="l00271"></a>00271           fsid.<a class="code" href="structfsid4.html#a4d9ea90821395ccf80051508df943161">minor</a> = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a>) data-&gt;<a class="code" href="structcompoud__data.html#aa44e02b685a675a6beb59faac8c9dc78">pexport</a>-&gt;<a class="code" href="structexportlist____.html#a0f81c1008714a0ce0039397cd3fab832">filesystem_id</a>.<a class="code" href="structfsal__fsid____.html#a4af3ec4bf793f168471987221d477130">minor</a>);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;fsid, <span class="keyword">sizeof</span>(<a class="code" href="structfsid4.html">fattr4_fsid</a>));
<a name="l00274"></a>00274           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00275"></a>00275           op_attr_success = 1;
<a name="l00276"></a>00276           <span class="keywordflow">break</span>;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a4e770e15e93db6e2f74e2449b22e7024">FATTR4_UNIQUE_HANDLES</a>:
<a name="l00279"></a>00279           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00280"></a>00280                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_UNIQUE_HANDLES&quot;</span>);
<a name="l00281"></a>00281 
<a name="l00282"></a>00282           <span class="comment">/* Filehandles are unique */</span>
<a name="l00283"></a>00283           unique_handles = htonl(<a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00284"></a>00284           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;unique_handles,
<a name="l00285"></a>00285                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#aa1e7e5291e1d6051d5c66bd1b1354430">fattr4_unique_handles</a>));
<a name="l00286"></a>00286           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00287"></a>00287           op_attr_success = 1;
<a name="l00288"></a>00288           <span class="keywordflow">break</span>;
<a name="l00289"></a>00289 
<a name="l00290"></a>00290         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a27b8037bffddb4a7be7f389a174789a8">FATTR4_LEASE_TIME</a>:
<a name="l00291"></a>00291           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00292"></a>00292                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_LEASE_TIME&quot;</span>);
<a name="l00293"></a>00293 
<a name="l00294"></a>00294           lease_time = htonl(<a class="code" href="nfs__core_8h.html#aeb8fc46586993cf210777049fca03969">nfs_param</a>.<a class="code" href="structnfs__param____.html#aa230a949a9346563ed093e442cc1abad">nfsv4_param</a>.<a class="code" href="structnfs__version4__parameter____.html#a46d8cf96d383c3f7425e811c1cf80fbd">lease_lifetime</a>);
<a name="l00295"></a>00295           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;lease_time,
<a name="l00296"></a>00296                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#af8c7252d498e365e082a16fa6125353f">fattr4_lease_time</a>));
<a name="l00297"></a>00297           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00298"></a>00298           op_attr_success = 1;
<a name="l00299"></a>00299           <span class="keywordflow">break</span>;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a8bd8eefcde07a750a41d0fe967427619">FATTR4_RDATTR_ERROR</a>:
<a name="l00302"></a>00302           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00303"></a>00303                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_RDATTR_ERROR&quot;</span>);
<a name="l00304"></a>00304 
<a name="l00305"></a>00305           rdattr_error = htonl(<a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>);        <span class="comment">/* By default, READDIR call may use a different value */</span>
<a name="l00306"></a>00306           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;rdattr_error,
<a name="l00307"></a>00307                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0a">fattr4_rdattr_error</a>));
<a name="l00308"></a>00308           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00309"></a>00309           op_attr_success = 1;
<a name="l00310"></a>00310           <span class="keywordflow">break</span>;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a6d36bb670468c89070ab7f9c08ec940d">FATTR4_ACL</a>:
<a name="l00313"></a>00313           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00314"></a>00314                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_ACL&quot;</span>);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316           acl.<a class="code" href="structfattr4__acl.html#a80d25b542b983806f9a2e2a96f573c0e">fattr4_acl_len</a> = htonl(0);
<a name="l00317"></a>00317           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;acl, <span class="keyword">sizeof</span>(<a class="code" href="structfattr4__acl.html">fattr4_acl</a>));
<a name="l00318"></a>00318           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00319"></a>00319           op_attr_success = 1;
<a name="l00320"></a>00320           <span class="keywordflow">break</span>;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#acccdc7c8c20ea3eb28e277616b1304f2">FATTR4_ACLSUPPORT</a>:
<a name="l00323"></a>00323           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00324"></a>00324                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_ACL_SUPPORT&quot;</span>);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326           aclsupport = htonl(<a class="code" href="nfsv40_8h.html#a5ef48fc2224f621b9766fabb1b23f69f">ACL4_SUPPORT_DENY_ACL</a>);    <span class="comment">/* temporary, wanting for houston to give me information to implemente ACL&#39;s support */</span>
<a name="l00327"></a>00327           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;aclsupport,
<a name="l00328"></a>00328                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a0c54ef8ddd13f9b3d9ffa0128c687075">fattr4_aclsupport</a>));
<a name="l00329"></a>00329           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00330"></a>00330           op_attr_success = 1;
<a name="l00331"></a>00331           <span class="keywordflow">break</span>;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a8b3c56a49215fe985cf7c9a4df761709">FATTR4_ARCHIVE</a>:
<a name="l00334"></a>00334           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00335"></a>00335                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_ARCHIVE&quot;</span>);
<a name="l00336"></a>00336 
<a name="l00337"></a>00337           <span class="comment">/* Archive flag is not supported */</span>
<a name="l00338"></a>00338           archive = htonl(<a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00339"></a>00339           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;archive, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#aa035fbdb57ad14ee5a53df3529e7c9da">fattr4_archive</a>));
<a name="l00340"></a>00340           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00341"></a>00341           op_attr_success = 1;
<a name="l00342"></a>00342           <span class="keywordflow">break</span>;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a0b6b2c64419dac1453c982d1e8af6398">FATTR4_CANSETTIME</a>:
<a name="l00345"></a>00345           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00346"></a>00346                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_CANSETTIME&quot;</span>);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348           <span class="comment">/* The time can be set on files */</span>
<a name="l00349"></a>00349           cansettime = htonl(<a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00350"></a>00350           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;cansettime,
<a name="l00351"></a>00351                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a5f1739eb4ec7b12be513c56ca8b70c66">fattr4_cansettime</a>));
<a name="l00352"></a>00352           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00353"></a>00353           op_attr_success = 1;
<a name="l00354"></a>00354           <span class="keywordflow">break</span>;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a67d7fd4f682db8a9cfca18db5b6781d6">FATTR4_CASE_INSENSITIVE</a>:
<a name="l00357"></a>00357           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00358"></a>00358                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_CASE_INSENSITIVE&quot;</span>);
<a name="l00359"></a>00359 
<a name="l00360"></a>00360           <span class="comment">/* pseudofs is not case INSENSITIVE... it is Read-Only */</span>
<a name="l00361"></a>00361           case_insensitive = htonl(<a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00362"></a>00362           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;case_insensitive,
<a name="l00363"></a>00363                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#ac268d448d82099af657dacbc99dbc905">fattr4_case_insensitive</a>));
<a name="l00364"></a>00364           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00365"></a>00365           op_attr_success = 1;
<a name="l00366"></a>00366           <span class="keywordflow">break</span>;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a5b36d50d9150e9d231d3864ef4b5bcc6">FATTR4_CASE_PRESERVING</a>:
<a name="l00369"></a>00369           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00370"></a>00370                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_PRESERVING&quot;</span>);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372           <span class="comment">/* pseudofs is case preserving... it is Read-Only */</span>
<a name="l00373"></a>00373           case_preserving = htonl(<a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00374"></a>00374           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;case_preserving,
<a name="l00375"></a>00375                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#aec0f2426d6bae8755ab1930bf5102658">fattr4_case_preserving</a>));
<a name="l00376"></a>00376           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00377"></a>00377           op_attr_success = 1;
<a name="l00378"></a>00378           <span class="keywordflow">break</span>;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#ae9b99e276288b6673639d91bdf73e55e">FATTR4_CHOWN_RESTRICTED</a>:
<a name="l00381"></a>00381           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00382"></a>00382                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_CHOWN_RESTRICTED&quot;</span>);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384           <span class="comment">/* chown is restricted to root, but in fact no chown will be done on pseudofs */</span>
<a name="l00385"></a>00385           chown_restricted = htonl(<a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00386"></a>00386           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;chown_restricted,
<a name="l00387"></a>00387                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a116b6ba06a0d8cca6b57b7b7d9aa3349">fattr4_chown_restricted</a>));
<a name="l00388"></a>00388           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00389"></a>00389           op_attr_success = 1;
<a name="l00390"></a>00390           <span class="keywordflow">break</span>;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a1e31fb57ae65cd90ba2b2bd203a81c08">FATTR4_FILEHANDLE</a>:
<a name="l00393"></a>00393           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00394"></a>00394                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_FILEHANDLE&quot;</span>);
<a name="l00395"></a>00395 
<a name="l00396"></a>00396           <span class="comment">/* Return the file handle */</span>
<a name="l00397"></a>00397           fhandle_len = htonl(objFH-&gt;<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a>);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;fhandle_len, <span class="keyword">sizeof</span>(u_int));
<a name="l00400"></a>00400           LastOffset += <span class="keyword">sizeof</span>(u_int);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset),
<a name="l00403"></a>00403                  objFH-&gt;<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>, objFH-&gt;<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a>);
<a name="l00404"></a>00404           LastOffset += objFH-&gt;<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a>;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406           <span class="comment">/* XDR&#39;s special stuff for 32-bit alignment */</span>
<a name="l00407"></a>00407           len = objFH-&gt;<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a>;
<a name="l00408"></a>00408           off = 0;
<a name="l00409"></a>00409           <span class="keywordflow">while</span>((len + off) % 4 != 0)
<a name="l00410"></a>00410             {
<a name="l00411"></a>00411               <span class="keywordtype">char</span> c = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413               off += 1;
<a name="l00414"></a>00414               memset((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), c, 1);
<a name="l00415"></a>00415               LastOffset += 1;
<a name="l00416"></a>00416             }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418           op_attr_success = 1;
<a name="l00419"></a>00419           <span class="keywordflow">break</span>;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a12bda16e66cebbcd45fab2cae6b42667">FATTR4_FILEID</a>:
<a name="l00422"></a>00422           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00423"></a>00423                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_FILEID  xattr_pos=%u&quot;</span>,
<a name="l00424"></a>00424                  pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> + 1);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426           <span class="comment">/* The analog to the inode number. RFC3530 says &quot;a number uniquely identifying the file within the filesystem&quot; </span>
<a name="l00427"></a>00427 <span class="comment">           * In the case of a pseudofs entry, the entry&#39;s unique id is used */</span>
<a name="l00428"></a>00428           fsalattr = data-&gt;<a class="code" href="structcompoud__data.html#a68044da90b24d713271740a42f88838a">current_entry</a>-&gt;<a class="code" href="structcache__entry__t.html#aad2a56294dcb57329b3b9fcd56e31f27">attributes</a>;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 <span class="preprocessor">#ifndef _XATTR_D_USE_SAME_INUM  </span><span class="comment">/* I wrapped off this part of the code... Not sure it would be useful */</span>
<a name="l00431"></a>00431           file_id = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(~(fsalattr.<a class="code" href="structfsal__attrib__list____.html#a657a3efbc26891ced4b16f48791452c3">fileid</a>));
<a name="l00432"></a>00432 
<a name="l00433"></a>00433           file_id = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(~(fsalattr.<a class="code" href="structfsal__attrib__list____.html#a657a3efbc26891ced4b16f48791452c3">fileid</a>)) - pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a>;
<a name="l00434"></a>00434 <span class="preprocessor">#else</span>
<a name="l00435"></a>00435 <span class="preprocessor"></span>          file_id = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(fsalattr.<a class="code" href="structfsal__attrib__list____.html#a657a3efbc26891ced4b16f48791452c3">fileid</a>);
<a name="l00436"></a>00436 <span class="preprocessor">#endif</span>
<a name="l00437"></a>00437 <span class="preprocessor"></span>
<a name="l00438"></a>00438           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;file_id, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a439aa2213ecdeca95541878dbac665ce">fattr4_fileid</a>));
<a name="l00439"></a>00439           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00440"></a>00440           op_attr_success = 1;
<a name="l00441"></a>00441           <span class="keywordflow">break</span>;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#ad8f9f2cd5ae0847bb982010e5c3e3b29">FATTR4_FILES_AVAIL</a>:
<a name="l00444"></a>00444           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00445"></a>00445                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_FILES_AVAIL&quot;</span>);
<a name="l00446"></a>00446 
<a name="l00447"></a>00447           files_avail = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#a2df3c0c622dbce1e4c73db0096b70213">fattr4_files_avail</a>) 512);  <span class="comment">/* Fake value */</span>
<a name="l00448"></a>00448           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;files_avail,
<a name="l00449"></a>00449                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a2df3c0c622dbce1e4c73db0096b70213">fattr4_files_avail</a>));
<a name="l00450"></a>00450           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00451"></a>00451           op_attr_success = 1;
<a name="l00452"></a>00452           <span class="keywordflow">break</span>;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a7d5bb307c7d80c15ebd3308ce6ae1ad0">FATTR4_FILES_FREE</a>:
<a name="l00455"></a>00455           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00456"></a>00456                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_FILES_FREE&quot;</span>);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458           files_free = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#a2df3c0c622dbce1e4c73db0096b70213">fattr4_files_avail</a>) 512);   <span class="comment">/* Fake value */</span>
<a name="l00459"></a>00459           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;files_free,
<a name="l00460"></a>00460                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#ae7ad78fb448db95b5545894156f9b996">fattr4_files_free</a>));
<a name="l00461"></a>00461           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00462"></a>00462           op_attr_success = 1;
<a name="l00463"></a>00463           <span class="keywordflow">break</span>;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a60aa97a14a44928103710908dfcdb6f4">FATTR4_FILES_TOTAL</a>:
<a name="l00466"></a>00466           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00467"></a>00467                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_FILES_TOTAL&quot;</span>);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469           files_total = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#a2df3c0c622dbce1e4c73db0096b70213">fattr4_files_avail</a>) 512);  <span class="comment">/* Fake value */</span>
<a name="l00470"></a>00470           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;files_total,
<a name="l00471"></a>00471                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a8216d12a43183daaa6f924c45b1c5efd">fattr4_files_total</a>));
<a name="l00472"></a>00472           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00473"></a>00473           op_attr_success = 1;
<a name="l00474"></a>00474           <span class="keywordflow">break</span>;
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a3fd8a1bc152a73ba56daad1eed452e33">FATTR4_FS_LOCATIONS</a>:
<a name="l00477"></a>00477           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00478"></a>00478                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_FS_LOCATIONS&quot;</span>);
<a name="l00479"></a>00479 <span class="comment">/* RFC 3530: &quot;When the fs_locations attribute is interrogated and there are no</span>
<a name="l00480"></a>00480 <span class="comment">   alternate file system locations, the server SHOULD return a zero-</span>
<a name="l00481"></a>00481 <span class="comment">   length array of fs_location4 structures, together with a valid</span>
<a name="l00482"></a>00482 <span class="comment">   fs_root. The code below does not return a fs_root which causes client</span>
<a name="l00483"></a>00483 <span class="comment">   problems when they interrogate this attribute. For now moving attribute to</span>
<a name="l00484"></a>00484 <span class="comment">   unsupported.</span>
<a name="l00485"></a>00485 <span class="comment">          LastOffset += fattr4tab[attribute_to_set].size_fattr4;</span>
<a name="l00486"></a>00486 <span class="comment">          op_attr_success = 1;</span>
<a name="l00487"></a>00487 <span class="comment">*/</span>
<a name="l00488"></a>00488           op_attr_success = 0;
<a name="l00489"></a>00489           <span class="keywordflow">break</span>;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#aff8c11d90ab70e33fd064a98b0259a51">FATTR4_HIDDEN</a>:
<a name="l00492"></a>00492           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00493"></a>00493                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_HIDDEN&quot;</span>);
<a name="l00494"></a>00494 
<a name="l00495"></a>00495           <span class="comment">/* There are no hidden file in pseudofs */</span>
<a name="l00496"></a>00496           hidden = htonl(<a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00497"></a>00497           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;hidden, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a8120e5f8df361c3ebeb1916c165078bc">fattr4_hidden</a>));
<a name="l00498"></a>00498           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00499"></a>00499           op_attr_success = 1;
<a name="l00500"></a>00500           <span class="keywordflow">break</span>;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a3be8247bb6bf1239fe59f2b060497f8e">FATTR4_HOMOGENEOUS</a>:
<a name="l00503"></a>00503           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00504"></a>00504                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_HOMOGENEOUS&quot;</span>);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506           <span class="comment">/* Unix semantic is homogeneous (all objects have the same kind of attributes) */</span>
<a name="l00507"></a>00507           homogeneous = htonl(<a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00508"></a>00508           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;homogeneous,
<a name="l00509"></a>00509                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#af62163d32be592400ddca7a03de92a12">fattr4_homogeneous</a>));
<a name="l00510"></a>00510           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00511"></a>00511           op_attr_success = 1;
<a name="l00512"></a>00512           <span class="keywordflow">break</span>;
<a name="l00513"></a>00513 
<a name="l00514"></a>00514         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a8d77c1fa475fe6e4f59d67f5b16b0f49">FATTR4_MAXFILESIZE</a>:
<a name="l00515"></a>00515           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00516"></a>00516                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_MAXFILESIZE&quot;</span>);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518           max_filesize = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#a2f6b48cb1e1cb28f755ae82ae55a0091">fattr4_maxfilesize</a>) <a class="code" href="group__NFSprocs.html#ga4306ad45e3e66dda5ec5e9611d8bdd21">FSINFO_MAX_FILESIZE</a>);
<a name="l00519"></a>00519           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;max_filesize,
<a name="l00520"></a>00520                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a2f6b48cb1e1cb28f755ae82ae55a0091">fattr4_maxfilesize</a>));
<a name="l00521"></a>00521           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00522"></a>00522           op_attr_success = 1;
<a name="l00523"></a>00523           <span class="keywordflow">break</span>;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a152d29ee332cd4908f35a2397af1a80c">FATTR4_MAXLINK</a>:
<a name="l00526"></a>00526           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00527"></a>00527                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_MAXLINK&quot;</span>);
<a name="l00528"></a>00528 
<a name="l00529"></a>00529           maxlink = htonl(<a class="code" href="group__NFSprocs.html#gae42ec41ddb9b6501a3a1498a5d84d9cf">MAX_HARD_LINK_VALUE</a>);
<a name="l00530"></a>00530           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;maxlink, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a53f35021913624dbc01dff3374d67534">fattr4_maxlink</a>));
<a name="l00531"></a>00531           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00532"></a>00532           op_attr_success = 1;
<a name="l00533"></a>00533           <span class="keywordflow">break</span>;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#ac08ff6c8bf52d8c743c845df01cda82f">FATTR4_MAXNAME</a>:
<a name="l00536"></a>00536           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00537"></a>00537                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_MAXNAME&quot;</span>);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539           maxname = htonl((<a class="code" href="nfsv40_8h.html#a670e98120e5313fcf9137bc1f8650572">fattr4_maxname</a>) MAXNAMLEN);
<a name="l00540"></a>00540           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;maxname, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a670e98120e5313fcf9137bc1f8650572">fattr4_maxname</a>));
<a name="l00541"></a>00541           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00542"></a>00542           op_attr_success = 1;
<a name="l00543"></a>00543           <span class="keywordflow">break</span>;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#ad5baf95761d8da57bd659663839f78b9">FATTR4_MAXREAD</a>:
<a name="l00546"></a>00546           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00547"></a>00547                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_MAXREAD&quot;</span>);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549           maxread = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#a7b945f194e331ff1de1a1b504acd8653">fattr4_maxread</a>) <a class="code" href="group__NFSprocs.html#ga04b7bec47598fee3b0a60714879632de">NFS4_PSEUDOFS_MAX_READ_SIZE</a>);
<a name="l00550"></a>00550           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;maxread, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a7b945f194e331ff1de1a1b504acd8653">fattr4_maxread</a>));
<a name="l00551"></a>00551           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00552"></a>00552           op_attr_success = 1;
<a name="l00553"></a>00553           <span class="keywordflow">break</span>;
<a name="l00554"></a>00554 
<a name="l00555"></a>00555         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a279790f50a79f2e3d6c748dbebd0f566">FATTR4_MAXWRITE</a>:
<a name="l00556"></a>00556           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00557"></a>00557                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_MAXWRITE&quot;</span>);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559           maxwrite = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#a97511d36675af4dccb1b13491ee7548f">fattr4_maxwrite</a>) <a class="code" href="group__NFSprocs.html#ga06efc6532b1b168b4fbde401ab0405f7">NFS4_PSEUDOFS_MAX_WRITE_SIZE</a>);
<a name="l00560"></a>00560           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;maxwrite,
<a name="l00561"></a>00561                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a97511d36675af4dccb1b13491ee7548f">fattr4_maxwrite</a>));
<a name="l00562"></a>00562           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00563"></a>00563           op_attr_success = 1;
<a name="l00564"></a>00564           <span class="keywordflow">break</span>;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a4b941a38952bb3bc3e256aa9a5dca23f">FATTR4_MIMETYPE</a>:
<a name="l00567"></a>00567           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00568"></a>00568                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_MIMETYPE&quot;</span>);
<a name="l00569"></a>00569 
<a name="l00570"></a>00570           mimetype.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a> = htonl(0);
<a name="l00571"></a>00571           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;mimetype,
<a name="l00572"></a>00572                  <span class="keyword">sizeof</span>(<a class="code" href="structutf8string.html">fattr4_mimetype</a>));
<a name="l00573"></a>00573           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00574"></a>00574           op_attr_success = 1;  <span class="comment">/* No supported for the moment */</span>
<a name="l00575"></a>00575           <span class="keywordflow">break</span>;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a0ba8d7c6edcd31a2eb08bc084550e31c">FATTR4_MODE</a>:
<a name="l00578"></a>00578           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00579"></a>00579                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_MODE&quot;</span>);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581           <span class="keywordflow">if</span>(pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> == 1)
<a name="l00582"></a>00582             file_mode = htonl(0555);    <span class="comment">/* Every pseudo fs object is dr-xr-xr-x */</span>
<a name="l00583"></a>00583           <span class="keywordflow">else</span>
<a name="l00584"></a>00584             file_mode = htonl(0644);    <span class="comment">/* -rw-r--r-- */</span>
<a name="l00585"></a>00585 
<a name="l00586"></a>00586           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;file_mode, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a2e828d4ef9dbc26b02c1d7bdd134f75a">fattr4_mode</a>));
<a name="l00587"></a>00587           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00588"></a>00588           op_attr_success = 1;
<a name="l00589"></a>00589           <span class="keywordflow">break</span>;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#ad3f4dd873fc24cc72a4bd5ea4186984e">FATTR4_NO_TRUNC</a>:
<a name="l00592"></a>00592           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00593"></a>00593                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_NO_TRUNC&quot;</span>);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595           <span class="comment">/* File&#39;s names are not truncated, an error is returned is name is too long */</span>
<a name="l00596"></a>00596           no_trunc = htonl(<a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00597"></a>00597           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;no_trunc,
<a name="l00598"></a>00598                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#abe8fba0236debb7f0eab5c0253e2202b">fattr4_no_trunc</a>));
<a name="l00599"></a>00599           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00600"></a>00600           op_attr_success = 1;
<a name="l00601"></a>00601           <span class="keywordflow">break</span>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#afa964dbe7c4a85d4fa8801059fa83bdc">FATTR4_NUMLINKS</a>:
<a name="l00604"></a>00604           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00605"></a>00605                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_NUMLINKS&quot;</span>);
<a name="l00606"></a>00606 
<a name="l00607"></a>00607           <span class="comment">/* Reply the number of links found in vattr structure */</span>
<a name="l00608"></a>00608           file_numlinks = htonl((<a class="code" href="nfsv40_8h.html#a5dcff0ef8b51f21c45fff7847ebb9458">fattr4_numlinks</a>) 1);
<a name="l00609"></a>00609           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;file_numlinks,
<a name="l00610"></a>00610                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a5dcff0ef8b51f21c45fff7847ebb9458">fattr4_numlinks</a>));
<a name="l00611"></a>00611           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00612"></a>00612           op_attr_success = 1;
<a name="l00613"></a>00613           <span class="keywordflow">break</span>;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a1b417fc85e29777886744df6709723ef">FATTR4_OWNER</a>:
<a name="l00616"></a>00616           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00617"></a>00617                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_OWNER&quot;</span>);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619           <span class="comment">/* Return the uid as a human readable utf8 string */</span>
<a name="l00620"></a>00620           <span class="keywordflow">if</span>(<a class="code" href="group__NFSprocs.html#ga86b8d548095cb2b07ab6ee49d0f56b94">uid2utf8</a>(<a class="code" href="group__NFSprocs.html#ga8fabf4fd5d13178cc3fe716a5fb89d6a">NFS4_ROOT_UID</a>, &amp;file_owner) == 0)
<a name="l00621"></a>00621             {
<a name="l00622"></a>00622               u_int utf8len = 0;
<a name="l00623"></a>00623               u_int deltalen = 0;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625               <span class="comment">/* Take care of 32 bits alignment */</span>
<a name="l00626"></a>00626               <span class="keywordflow">if</span>(file_owner.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a> % 4 == 0)
<a name="l00627"></a>00627                 deltalen = 0;
<a name="l00628"></a>00628               <span class="keywordflow">else</span>
<a name="l00629"></a>00629                 deltalen = 4 - file_owner.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a> % 4;
<a name="l00630"></a>00630 <span class="comment">/* Following code used to add deltalen to utf8len which is wrong. It caused</span>
<a name="l00631"></a>00631 <span class="comment"> * clients verifying utf8 strings to reject the attribute.</span>
<a name="l00632"></a>00632 <span class="comment"> */</span>
<a name="l00633"></a>00633               utf8len = htonl(file_owner.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a>);
<a name="l00634"></a>00634               memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;utf8len, <span class="keyword">sizeof</span>(u_int));
<a name="l00635"></a>00635               LastOffset += <span class="keyword">sizeof</span>(u_int);
<a name="l00636"></a>00636 
<a name="l00637"></a>00637               memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset),
<a name="l00638"></a>00638                      file_owner.<a class="code" href="structutf8string.html#a72e3ba7aecf5547219953542a1c32271">utf8string_val</a>, file_owner.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a>);
<a name="l00639"></a>00639               LastOffset += file_owner.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a>;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641               <span class="comment">/* Free what was allocated by uid2utf8 */</span>
<a name="l00642"></a>00642               gsh_free(file_owner.<a class="code" href="structutf8string.html#a72e3ba7aecf5547219953542a1c32271">utf8string_val</a>);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644               <span class="comment">/* Pad with zero to keep xdr alignement */</span>
<a name="l00645"></a>00645               <span class="keywordflow">if</span>(deltalen != 0)
<a name="l00646"></a>00646                 memset((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), 0, deltalen);
<a name="l00647"></a>00647               LastOffset += deltalen;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649               op_attr_success = 1;
<a name="l00650"></a>00650             }
<a name="l00651"></a>00651           <span class="keywordflow">else</span>
<a name="l00652"></a>00652             op_attr_success = 0;
<a name="l00653"></a>00653           <span class="keywordflow">break</span>;
<a name="l00654"></a>00654 
<a name="l00655"></a>00655         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#ab2edd15bdc0df70213cb86ac63ca80d3">FATTR4_OWNER_GROUP</a>:
<a name="l00656"></a>00656           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00657"></a>00657                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_OWNER_GROUP&quot;</span>);
<a name="l00658"></a>00658 
<a name="l00659"></a>00659           <span class="comment">/* Return the uid as a human readable utf8 string */</span>
<a name="l00660"></a>00660           <span class="keywordflow">if</span>(<a class="code" href="group__NFSprocs.html#ga64205dca7faae60fdcd79f168eb7e5ed">gid2utf8</a>(2, &amp;file_owner_group) == 0)
<a name="l00661"></a>00661             {
<a name="l00662"></a>00662               u_int utf8len = 0;
<a name="l00663"></a>00663               u_int deltalen = 0;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665               <span class="comment">/* Take care of 32 bits alignment */</span>
<a name="l00666"></a>00666               <span class="keywordflow">if</span>(file_owner_group.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a> % 4 == 0)
<a name="l00667"></a>00667                 deltalen = 0;
<a name="l00668"></a>00668               <span class="keywordflow">else</span>
<a name="l00669"></a>00669                 deltalen = 4 - file_owner_group.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a> % 4;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="comment">/* Following code used to add deltalen to utf8len which is wrong. It caused</span>
<a name="l00672"></a>00672 <span class="comment"> * clients verifying utf8 strings to reject the attribute.</span>
<a name="l00673"></a>00673 <span class="comment"> */</span>
<a name="l00674"></a>00674               utf8len = htonl(file_owner_group.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a>);
<a name="l00675"></a>00675               memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;utf8len, <span class="keyword">sizeof</span>(u_int));
<a name="l00676"></a>00676               LastOffset += <span class="keyword">sizeof</span>(u_int);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678               memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset),
<a name="l00679"></a>00679                      file_owner_group.<a class="code" href="structutf8string.html#a72e3ba7aecf5547219953542a1c32271">utf8string_val</a>, file_owner_group.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a>);
<a name="l00680"></a>00680               LastOffset += file_owner_group.<a class="code" href="structutf8string.html#ab651a802af8217014ea648e43ac79b6f">utf8string_len</a>;
<a name="l00681"></a>00681 
<a name="l00682"></a>00682               <span class="comment">/* Free what was used for utf8 conversion */</span>
<a name="l00683"></a>00683               gsh_free(file_owner_group.<a class="code" href="structutf8string.html#a72e3ba7aecf5547219953542a1c32271">utf8string_val</a>);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685               <span class="comment">/* Pad with zero to keep xdr alignement */</span>
<a name="l00686"></a>00686               <span class="keywordflow">if</span>(deltalen != 0)
<a name="l00687"></a>00687                 memset((attrvalsBuffer + LastOffset), 0, deltalen);
<a name="l00688"></a>00688               LastOffset += deltalen;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690               op_attr_success = 1;
<a name="l00691"></a>00691             }
<a name="l00692"></a>00692           <span class="keywordflow">else</span>
<a name="l00693"></a>00693             op_attr_success = 0;
<a name="l00694"></a>00694           <span class="keywordflow">break</span>;
<a name="l00695"></a>00695 
<a name="l00696"></a>00696         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a25dad080fab7d195a71a7d664587af22">FATTR4_QUOTA_AVAIL_HARD</a>:
<a name="l00697"></a>00697           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00698"></a>00698                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_QUOTA_AVAIL_HARD&quot;</span>);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700           quota_avail_hard = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#a3dc776327cdd947498a5b212f98269e7">fattr4_quota_avail_hard</a>) <a class="code" href="nfs__core_8h.html#a8320ff8e228f7b7fb0dce29638676358">NFS_V4_MAX_QUOTA_HARD</a>);    
<a name="l00701"></a>00701           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;quota_avail_hard,
<a name="l00702"></a>00702                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a3dc776327cdd947498a5b212f98269e7">fattr4_quota_avail_hard</a>));
<a name="l00703"></a>00703           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00704"></a>00704           op_attr_success = 1;
<a name="l00705"></a>00705           <span class="keywordflow">break</span>;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a36b7f38832d1dfbd61c9dde55e67f092">FATTR4_QUOTA_AVAIL_SOFT</a>:
<a name="l00708"></a>00708           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00709"></a>00709                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_QUOTA_AVAIL_SOFT&quot;</span>);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711           quota_avail_soft = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#a05b31a0c0394721c59d731a4acc62b18">fattr4_quota_avail_soft</a>) <a class="code" href="nfs__core_8h.html#a5de1d652d7791273d995655b654d3809">NFS_V4_MAX_QUOTA_SOFT</a>);    
<a name="l00712"></a>00712           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;quota_avail_soft,
<a name="l00713"></a>00713                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a05b31a0c0394721c59d731a4acc62b18">fattr4_quota_avail_soft</a>));
<a name="l00714"></a>00714           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00715"></a>00715           op_attr_success = 1;
<a name="l00716"></a>00716           <span class="keywordflow">break</span>;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a6b4447e650b20373b01f7fce2167a333">FATTR4_QUOTA_USED</a>:
<a name="l00719"></a>00719           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00720"></a>00720                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_QUOTA_AVAIL_USED&quot;</span>);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722           quota_used = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#af6c58c71fcfa900ceb25e27197cdf646">fattr4_quota_used</a>) <a class="code" href="nfs__core_8h.html#a2e94e57fd1a4d5857859f64a609f6a02">NFS_V4_MAX_QUOTA</a>);
<a name="l00723"></a>00723           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;quota_used,
<a name="l00724"></a>00724                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#af6c58c71fcfa900ceb25e27197cdf646">fattr4_quota_used</a>));
<a name="l00725"></a>00725           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00726"></a>00726           op_attr_success = 1;
<a name="l00727"></a>00727           <span class="keywordflow">break</span>;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a89b12b6e52be105460ff2922ed361595">FATTR4_RAWDEV</a>:
<a name="l00730"></a>00730           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00731"></a>00731                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_RAWDEV&quot;</span>);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733           <span class="comment">/* Not usefull, there are no special block or character file in HPSS */</span>
<a name="l00734"></a>00734           <span class="comment">/* since FATTR4_TYPE will never be NFS4BLK or NFS4CHR, this value should not be used by the client */</span>
<a name="l00735"></a>00735           rawdev.<a class="code" href="structspecdata4.html#a293b8dcf62d8deb71f9fde80558237db">specdata1</a> = htonl(0);
<a name="l00736"></a>00736           rawdev.<a class="code" href="structspecdata4.html#a976f1631a7af968dbc574868918294d0">specdata2</a> = htonl(0);
<a name="l00737"></a>00737           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;rawdev, <span class="keyword">sizeof</span>(<a class="code" href="structspecdata4.html">fattr4_rawdev</a>));
<a name="l00738"></a>00738           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00739"></a>00739           op_attr_success = 1;
<a name="l00740"></a>00740           <span class="keywordflow">break</span>;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#af38700c788d488d1274949e56fcf3b2d">FATTR4_SPACE_AVAIL</a>:
<a name="l00743"></a>00743           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00744"></a>00744                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_SPACE_AVAIL&quot;</span>);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746           space_avail = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(512000LL);  <span class="comment">/* Fake value */</span>
<a name="l00747"></a>00747           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;space_avail,
<a name="l00748"></a>00748                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#af43e37c36a94d243a287d9ae382ea2c1">fattr4_space_avail</a>));
<a name="l00749"></a>00749           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00750"></a>00750           op_attr_success = 1;
<a name="l00751"></a>00751           <span class="keywordflow">break</span>;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a26d8cd485c39a59250e3f039df6a8867">FATTR4_SPACE_FREE</a>:
<a name="l00754"></a>00754           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00755"></a>00755                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_SPACE_FREE&quot;</span>);
<a name="l00756"></a>00756 
<a name="l00757"></a>00757           space_free = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(512000LL);   <span class="comment">/* Fake value */</span>
<a name="l00758"></a>00758           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;space_free,
<a name="l00759"></a>00759                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#aa1b93cee6fd181d4e37c78b60c36c7c0">fattr4_space_free</a>));
<a name="l00760"></a>00760           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00761"></a>00761           op_attr_success = 1;
<a name="l00762"></a>00762           <span class="keywordflow">break</span>;
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a5bed496cfda6933474ac3c18e93bc47f">FATTR4_SPACE_TOTAL</a>:
<a name="l00765"></a>00765           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00766"></a>00766                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_SPACE_TOTAL&quot;</span>);
<a name="l00767"></a>00767 
<a name="l00768"></a>00768           space_total = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(1024000LL); <span class="comment">/* Fake value */</span>
<a name="l00769"></a>00769           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;space_total,
<a name="l00770"></a>00770                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a8222d546e768d600afe234bdab099b68">fattr4_space_total</a>));
<a name="l00771"></a>00771           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00772"></a>00772           op_attr_success = 1;
<a name="l00773"></a>00773           <span class="keywordflow">break</span>;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#ab9058684dd550c9561b6928d58f00026">FATTR4_SPACE_USED</a>:
<a name="l00776"></a>00776           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00777"></a>00777                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_SPACE_USED&quot;</span>);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779           <span class="comment">/* the number of bytes on the filesystem used by the object, which is slightly different </span>
<a name="l00780"></a>00780 <span class="comment">           * from the file&#39;s size (there can be hole in the file) */</span>
<a name="l00781"></a>00781           file_space_used = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="nfsv40_8h.html#ae058190bc78422118c9fe20cb0b2872d">fattr4_space_used</a>) DEV_BSIZE);
<a name="l00782"></a>00782           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;file_space_used,
<a name="l00783"></a>00783                  <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#ae058190bc78422118c9fe20cb0b2872d">fattr4_space_used</a>));
<a name="l00784"></a>00784           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00785"></a>00785           op_attr_success = 1;
<a name="l00786"></a>00786           <span class="keywordflow">break</span>;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#ae07709aa5268f86bcdce2863188aea8f">FATTR4_SYSTEM</a>:
<a name="l00789"></a>00789           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00790"></a>00790                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_SYSTEM&quot;</span>);
<a name="l00791"></a>00791 
<a name="l00792"></a>00792           <span class="comment">/* This is not a windows system File-System with respect to the regarding API */</span>
<a name="l00793"></a>00793           system = htonl(<a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00794"></a>00794           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;system, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a971609879b3ba95b8624e15ac8c583f5">fattr4_system</a>));
<a name="l00795"></a>00795           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00796"></a>00796           op_attr_success = 1;
<a name="l00797"></a>00797           <span class="keywordflow">break</span>;
<a name="l00798"></a>00798 
<a name="l00799"></a>00799         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#ad74f48a420926a335bc6bb75e431ddb4">FATTR4_TIME_ACCESS</a>:
<a name="l00800"></a>00800           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00801"></a>00801                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_TIME_ACCESS&quot;</span>);
<a name="l00802"></a>00802 
<a name="l00803"></a>00803           <span class="comment">/* This will contain the object&#39;s time os last access, the &#39;atime&#39; in the Unix semantic */</span>
<a name="l00804"></a>00804           memset(&amp;(time_access.<a class="code" href="structnfstime4.html#ad46cdfc1412964d638b98aff64812200">seconds</a>), 0, <span class="keyword">sizeof</span>(<a class="code" href="extended__types_8h.html#a20c5e9a94aaa5a66a9f0165f027a8581">int64_t</a>));
<a name="l00805"></a>00805           time_access.<a class="code" href="structnfstime4.html#ad46cdfc1412964d638b98aff64812200">seconds</a> = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="extended__types_8h.html#a20c5e9a94aaa5a66a9f0165f027a8581">int64_t</a>) time(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));
<a name="l00806"></a>00806           time_access.<a class="code" href="structnfstime4.html#abf33417561dc5d91b5ed6a671936ecda">nseconds</a> = htonl(0);
<a name="l00807"></a>00807           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;time_access,
<a name="l00808"></a>00808                  fattr4tab[attribute_to_set].size_fattr4);
<a name="l00809"></a>00809           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00810"></a>00810           op_attr_success = 1;
<a name="l00811"></a>00811           <span class="keywordflow">break</span>;
<a name="l00812"></a>00812 
<a name="l00813"></a>00813         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a402863c5613762a8d4971acaa7a9d991">FATTR4_TIME_ACCESS_SET</a>:
<a name="l00814"></a>00814           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00815"></a>00815                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_TIME_ACCESS_SET&quot;</span>);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817           <span class="comment">/* To be used with NFS4_OP_SETATTR only */</span>
<a name="l00818"></a>00818           op_attr_success = 0;
<a name="l00819"></a>00819           <span class="keywordflow">break</span>;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#adadf5f190b82cffdfcfd0508bfe44931">FATTR4_TIME_BACKUP</a>:
<a name="l00822"></a>00822           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00823"></a>00823                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_TIME_BACKUP&quot;</span>);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825           <span class="comment">/* No time backup, return unix&#39;s beginning of time */</span>
<a name="l00826"></a>00826           time_backup.<a class="code" href="structnfstime4.html#ad46cdfc1412964d638b98aff64812200">seconds</a> = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(0LL);
<a name="l00827"></a>00827           time_backup.<a class="code" href="structnfstime4.html#abf33417561dc5d91b5ed6a671936ecda">nseconds</a> = htonl(0);
<a name="l00828"></a>00828           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;time_backup,
<a name="l00829"></a>00829                  fattr4tab[attribute_to_set].size_fattr4);
<a name="l00830"></a>00830           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00831"></a>00831           op_attr_success = 1;
<a name="l00832"></a>00832           <span class="keywordflow">break</span>;
<a name="l00833"></a>00833 
<a name="l00834"></a>00834         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a59b428c6296b4086d51c8575c0da9216">FATTR4_TIME_CREATE</a>:
<a name="l00835"></a>00835           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00836"></a>00836                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_TIME_CREATE&quot;</span>);
<a name="l00837"></a>00837 
<a name="l00838"></a>00838           <span class="comment">/* No time create, return unix&#39;s beginning of time */</span>
<a name="l00839"></a>00839           time_create.<a class="code" href="structnfstime4.html#ad46cdfc1412964d638b98aff64812200">seconds</a> = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(0LL);
<a name="l00840"></a>00840           time_create.<a class="code" href="structnfstime4.html#abf33417561dc5d91b5ed6a671936ecda">nseconds</a> = htonl(0);
<a name="l00841"></a>00841           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;time_create,
<a name="l00842"></a>00842                  fattr4tab[attribute_to_set].size_fattr4);
<a name="l00843"></a>00843           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00844"></a>00844           op_attr_success = 1;
<a name="l00845"></a>00845           <span class="keywordflow">break</span>;
<a name="l00846"></a>00846 
<a name="l00847"></a>00847         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a1256030125455df517cb22c3b98bf022">FATTR4_TIME_DELTA</a>:
<a name="l00848"></a>00848           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00849"></a>00849                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_TIME_DELTA&quot;</span>);
<a name="l00850"></a>00850 
<a name="l00851"></a>00851 
<a name="l00852"></a>00852           <span class="comment">/* According to RFC3530, this is &quot;the smallest usefull server time granularity&quot;, I set this to 1s */</span>
<a name="l00853"></a>00853           time_delta.<a class="code" href="structnfstime4.html#ad46cdfc1412964d638b98aff64812200">seconds</a> = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(1LL);
<a name="l00854"></a>00854           time_delta.<a class="code" href="structnfstime4.html#abf33417561dc5d91b5ed6a671936ecda">nseconds</a> = 0;
<a name="l00855"></a>00855           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;time_delta,
<a name="l00856"></a>00856                  fattr4tab[attribute_to_set].size_fattr4);
<a name="l00857"></a>00857           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00858"></a>00858           op_attr_success = 1;
<a name="l00859"></a>00859           <span class="keywordflow">break</span>;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a13c0c2b7994641285fe8cc9e130c91f3">FATTR4_TIME_METADATA</a>:
<a name="l00862"></a>00862           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00863"></a>00863                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_TIME_METADATA&quot;</span>);
<a name="l00864"></a>00864 
<a name="l00865"></a>00865 
<a name="l00866"></a>00866           <span class="comment">/* The time for the last metadata operation, the ctime in the unix&#39;s semantic */</span>
<a name="l00867"></a>00867           memset(&amp;(time_metadata.<a class="code" href="structnfstime4.html#ad46cdfc1412964d638b98aff64812200">seconds</a>), 0, <span class="keyword">sizeof</span>(<a class="code" href="extended__types_8h.html#a20c5e9a94aaa5a66a9f0165f027a8581">int64_t</a>));
<a name="l00868"></a>00868           time_metadata.<a class="code" href="structnfstime4.html#ad46cdfc1412964d638b98aff64812200">seconds</a> = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="extended__types_8h.html#a20c5e9a94aaa5a66a9f0165f027a8581">int64_t</a>) time(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));
<a name="l00869"></a>00869           time_metadata.<a class="code" href="structnfstime4.html#abf33417561dc5d91b5ed6a671936ecda">nseconds</a> = htonl(0);
<a name="l00870"></a>00870           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;time_metadata,
<a name="l00871"></a>00871                  fattr4tab[attribute_to_set].size_fattr4);
<a name="l00872"></a>00872           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00873"></a>00873           op_attr_success = 1;
<a name="l00874"></a>00874           <span class="keywordflow">break</span>;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#aca636cf87f02044b79a6911207579f7d">FATTR4_TIME_MODIFY</a>:
<a name="l00877"></a>00877           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00878"></a>00878                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_TIME_MODIFY&quot;</span>);
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 
<a name="l00881"></a>00881           <span class="comment">/* The time for the last modify operation, the mtime in the unix&#39;s semantic */</span>
<a name="l00882"></a>00882           memset(&amp;(time_modify.<a class="code" href="structnfstime4.html#ad46cdfc1412964d638b98aff64812200">seconds</a>), 0, <span class="keyword">sizeof</span>(<a class="code" href="extended__types_8h.html#a20c5e9a94aaa5a66a9f0165f027a8581">int64_t</a>));
<a name="l00883"></a>00883           time_modify.<a class="code" href="structnfstime4.html#ad46cdfc1412964d638b98aff64812200">seconds</a> = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>((<a class="code" href="extended__types_8h.html#a20c5e9a94aaa5a66a9f0165f027a8581">int64_t</a>) time(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));
<a name="l00884"></a>00884           time_modify.<a class="code" href="structnfstime4.html#abf33417561dc5d91b5ed6a671936ecda">nseconds</a> = htonl(0);
<a name="l00885"></a>00885           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;time_modify,
<a name="l00886"></a>00886                  fattr4tab[attribute_to_set].size_fattr4);
<a name="l00887"></a>00887           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00888"></a>00888           op_attr_success = 1;
<a name="l00889"></a>00889           <span class="keywordflow">break</span>;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a9d41d38182a69e76e8a51f3e99d4a232">FATTR4_TIME_MODIFY_SET</a>:
<a name="l00892"></a>00892           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00893"></a>00893                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_TIME_MODIFY_SET&quot;</span>);
<a name="l00894"></a>00894 
<a name="l00895"></a>00895 
<a name="l00896"></a>00896           op_attr_success = 0;  <span class="comment">/* should never be used here, only for setattr */</span>
<a name="l00897"></a>00897           <span class="keywordflow">break</span>;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#aee5e5c06f383e00c90378fabc96deaee">FATTR4_MOUNTED_ON_FILEID</a>:
<a name="l00900"></a>00900           <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00901"></a>00901                        <span class="stringliteral">&quot;-----&gt; Wanting FATTR4_MOUNTED_ON_FILEID&quot;</span>);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903           fsalattr = data-&gt;<a class="code" href="structcompoud__data.html#a68044da90b24d713271740a42f88838a">current_entry</a>-&gt;<a class="code" href="structcache__entry__t.html#aad2a56294dcb57329b3b9fcd56e31f27">attributes</a>;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905 <span class="preprocessor">#ifndef _XATTR_D_USE_SAME_INUM  </span><span class="comment">/* I wrapped off this part of the code... Not sure it would be useful */</span>
<a name="l00906"></a>00906           file_id = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(~(fsalattr.<a class="code" href="structfsal__attrib__list____.html#a657a3efbc26891ced4b16f48791452c3">fileid</a>));
<a name="l00907"></a>00907 
<a name="l00908"></a>00908           file_id = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(~(fsalattr.<a class="code" href="structfsal__attrib__list____.html#a657a3efbc26891ced4b16f48791452c3">fileid</a>)) - pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a>;
<a name="l00909"></a>00909 <span class="preprocessor">#else</span>
<a name="l00910"></a>00910 <span class="preprocessor"></span>          file_id = <a class="code" href="group__NFSprocs.html#gab52fdbc875109ccb84900a657877a23b">nfs_htonl64</a>(fsalattr.<a class="code" href="structfsal__attrib__list____.html#a657a3efbc26891ced4b16f48791452c3">fileid</a>);
<a name="l00911"></a>00911 <span class="preprocessor">#endif</span>
<a name="l00912"></a>00912 <span class="preprocessor"></span>
<a name="l00913"></a>00913           memcpy((<span class="keywordtype">char</span> *)(attrvalsBuffer + LastOffset), &amp;file_id, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a439aa2213ecdeca95541878dbac665ce">fattr4_fileid</a>));
<a name="l00914"></a>00914           LastOffset += fattr4tab[attribute_to_set].size_fattr4;
<a name="l00915"></a>00915           op_attr_success = 1;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917           <span class="keywordflow">break</span>;
<a name="l00918"></a>00918 
<a name="l00919"></a>00919         <span class="keywordflow">default</span>:
<a name="l00920"></a>00920           <a class="code" href="log_8h.html#a2f20da18afe4d5ea18fd717136b7f0d4">LogWarn</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>, <span class="stringliteral">&quot;Bad file attributes %d queried&quot;</span>,
<a name="l00921"></a>00921                   attribute_to_set);
<a name="l00922"></a>00922           <span class="comment">/* BUGAZOMEU : un traitement special ici */</span>
<a name="l00923"></a>00923           <span class="keywordflow">break</span>;
<a name="l00924"></a>00924         }                       <span class="comment">/* switch( attr_to_set ) */</span>
<a name="l00925"></a>00925 
<a name="l00926"></a>00926       <span class="comment">/* Increase the Offset for the next operation if this was a success */</span>
<a name="l00927"></a>00927       <span class="keywordflow">if</span>(op_attr_success)
<a name="l00928"></a>00928         {
<a name="l00929"></a>00929           <span class="comment">/* Set the returned bitmask */</span>
<a name="l00930"></a>00930           attrvalslist[j] = attribute_to_set;
<a name="l00931"></a>00931           j += 1;
<a name="l00932"></a>00932 
<a name="l00933"></a>00933           <span class="comment">/* Be carefull not to get out of attrvalsBuffer */</span>
<a name="l00934"></a>00934           <span class="keywordflow">if</span>(LastOffset &gt; <a class="code" href="nfs__proto__functions_8h.html#ac4b92be64dea477ba31b26b2714e0ae4">NFS4_ATTRVALS_BUFFLEN</a>)
<a name="l00935"></a>00935             <span class="keywordflow">return</span> -1;
<a name="l00936"></a>00936         }
<a name="l00937"></a>00937 
<a name="l00938"></a>00938     }                           <span class="comment">/* for i */</span>
<a name="l00939"></a>00939 
<a name="l00940"></a>00940   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00941"></a>00941                <span class="stringliteral">&quot;----------------------------------------&quot;</span>);
<a name="l00942"></a>00942 
<a name="l00943"></a>00943   <span class="comment">/* LastOffset contains the length of the attrvalsBuffer usefull data */</span>
<a name="l00944"></a>00944   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l00945"></a>00945                <span class="stringliteral">&quot;Fattr (pseudo) At the end LastOffset = %u, i=%d, j=%d&quot;</span>,
<a name="l00946"></a>00946                LastOffset, i, j);
<a name="l00947"></a>00947 
<a name="l00948"></a>00948   <span class="keywordflow">return</span> <a class="code" href="group__NFSprocs.html#ga03c63cf888bb6b4839155d46dd50c79f">nfs4_Fattr_Fill</a>(Fattr, j, attrvalslist, LastOffset, attrvalsBuffer);
<a name="l00949"></a>00949 }                               <span class="comment">/* nfs4_XattrToFattr */</span>
<a name="l00950"></a>00950 
<a name="l00960"></a><a class="code" href="group__NFSprocs.html#ga9f1ad95bb2399d13e8aa7c737aeab1b4">00960</a> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0a">nfsstat4</a> <a class="code" href="group__NFSprocs.html#ga9f1ad95bb2399d13e8aa7c737aeab1b4">nfs4_fh_to_xattrfh</a>(<a class="code" href="structnfs__fh4.html">nfs_fh4</a> * pfhin, <a class="code" href="structnfs__fh4.html">nfs_fh4</a> * pfhout)
<a name="l00961"></a>00961 {
<a name="l00962"></a>00962   <a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *pfile_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00963"></a>00963 
<a name="l00964"></a>00964   memcpy(pfhout-&gt;<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>, pfhin-&gt;<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>, pfhin-&gt;<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a>);
<a name="l00965"></a>00965 
<a name="l00966"></a>00966   pfile_handle = (<a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *) (pfhout-&gt;<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>);
<a name="l00967"></a>00967 
<a name="l00968"></a>00968   <span class="comment">/* the following choice is made for xattr: the field xattr_pos contains :</span>
<a name="l00969"></a>00969 <span class="comment">   * - 0 if the FH is related to an actual FH object</span>
<a name="l00970"></a>00970 <span class="comment">   * - 1 if the FH is the one for the xattr ghost directory</span>
<a name="l00971"></a>00971 <span class="comment">   * - a value greater than 1 if the fh is related to a ghost file in ghost xattr directory that represents a xattr. The value is then equal </span>
<a name="l00972"></a>00972 <span class="comment">   *   to the xattr_id + 1 (see how FSAL manages xattrs for meaning of this field). This limits the number of xattrs per object to 254. </span>
<a name="l00973"></a>00973 <span class="comment">   */</span>
<a name="l00974"></a>00974   pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> = 1;  
<a name="l00976"></a>00976   <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l00977"></a>00977 }                               <span class="comment">/* nfs4_fh_to_xattrfh */</span>
<a name="l00978"></a>00978 
<a name="l00988"></a><a class="code" href="group__NFSprocs.html#ga2baab3a67c6dd8e5760cb35b0ef12fc7">00988</a> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0a">nfsstat4</a> <a class="code" href="group__NFSprocs.html#ga2baab3a67c6dd8e5760cb35b0ef12fc7">nfs4_xattrfh_to_fh</a>(<a class="code" href="structnfs__fh4.html">nfs_fh4</a> * pfhin, <a class="code" href="structnfs__fh4.html">nfs_fh4</a> * pfhout)
<a name="l00989"></a>00989 {
<a name="l00990"></a>00990   <a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *pfile_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992   memcpy(pfhout-&gt;<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>, pfhin-&gt;<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>, pfhin-&gt;<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a>);
<a name="l00993"></a>00993 
<a name="l00994"></a>00994   pfile_handle = (<a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *) (pfhout-&gt;<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996   pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> = 0;  
<a name="l00998"></a>00998   <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l00999"></a>00999 }                               <span class="comment">/* nfs4_fh_to_xattrfh */</span>
<a name="l01000"></a>01000 
<a name="l01001"></a>01001 
<a name="l01015"></a><a class="code" href="nfs4__xattr_8c.html#a5ce87541595c65b874f54196e5e70cd3">01015</a> <span class="preprocessor">#define arg_GETATTR4 op-&gt;nfs_argop4_u.opgetattr</span>
<a name="l01016"></a><a class="code" href="nfs4__xattr_8c.html#ad58f615d903585b4f0cce273b9b9758c">01016</a> <span class="preprocessor"></span><span class="preprocessor">#define res_GETATTR4 resp-&gt;nfs_resop4_u.opgetattr</span>
<a name="l01017"></a>01017 <span class="preprocessor"></span>
<a name="l01018"></a><a class="code" href="group__NFSprocs.html#ga9a1131e8792aa8cc75043955f3748c2b">01018</a> <span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#ga9a1131e8792aa8cc75043955f3748c2b">nfs4_op_getattr_xattr</a>(<span class="keyword">struct</span> <a class="code" href="structnfs__argop4.html">nfs_argop4</a> *op,
<a name="l01019"></a>01019                           <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data, <span class="keyword">struct</span> <a class="code" href="structnfs__resop4.html">nfs_resop4</a> *resp)
<a name="l01020"></a>01020 {
<a name="l01021"></a>01021   <span class="keywordtype">char</span> <a class="code" href="group__NFSprocs.html#ga7efec2b565bdbe409979ac657775eeaa">__attribute__</a> ((__unused__)) funcname[] = <span class="stringliteral">&quot;nfs4_op_getattr&quot;</span>;
<a name="l01022"></a>01022 
<a name="l01023"></a>01023   resp-&gt;<a class="code" href="structnfs__resop4.html#a247bf08c00fa2bb81b26874cbbfa7f47">resop</a> = <a class="code" href="nfsv40_8h.html#a7d1e727fb25d4cf1f59ae923f665ff0cac666cb34090a56eff94d4dfccaaba675">NFS4_OP_GETATTR</a>;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025   <a class="code" href="nfs4__xattr_8c.html#ad58f615d903585b4f0cce273b9b9758c">res_GETATTR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01026"></a>01026 
<a name="l01027"></a>01027   <span class="keywordflow">if</span>(<a class="code" href="group__NFSprocs.html#ga258f1eeb0cfc4284bc58148675cf3974">nfs4_XattrToFattr</a>(&amp;(<a class="code" href="nfs4__xattr_8c.html#ad58f615d903585b4f0cce273b9b9758c">res_GETATTR4</a>.GETATTR4res_u.resok4.obj_attributes),
<a name="l01028"></a>01028                        data, &amp;(data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>), &amp;(<a class="code" href="nfs4__xattr_8c.html#a5ce87541595c65b874f54196e5e70cd3">arg_GETATTR4</a>.attr_request)) != 0)
<a name="l01029"></a>01029     <a class="code" href="nfs4__xattr_8c.html#ad58f615d903585b4f0cce273b9b9758c">res_GETATTR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aaf8c067759d4fef22cb97409d7a50c453">NFS4ERR_SERVERFAULT</a>;
<a name="l01030"></a>01030   <span class="keywordflow">else</span>
<a name="l01031"></a>01031     <a class="code" href="nfs4__xattr_8c.html#ad58f615d903585b4f0cce273b9b9758c">res_GETATTR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033   <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#ad58f615d903585b4f0cce273b9b9758c">res_GETATTR4</a>.status;
<a name="l01034"></a>01034 }                               <span class="comment">/* nfs4_op_getattr_xattr */</span>
<a name="l01035"></a>01035 
<a name="l01049"></a>01049 <span class="comment">/* Shorter notation to avoid typos */</span>
<a name="l01050"></a><a class="code" href="nfs4__xattr_8c.html#aa06ce04fe96f8619c09fd087d7e8d7bd">01050</a> <span class="preprocessor">#define res_ACCESS4 resp-&gt;nfs_resop4_u.opaccess</span>
<a name="l01051"></a><a class="code" href="nfs4__xattr_8c.html#ad9232202effe29cd7db08bde927ab9a8">01051</a> <span class="preprocessor"></span><span class="preprocessor">#define arg_ACCESS4 op-&gt;nfs_argop4_u.opaccess</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span>
<a name="l01053"></a><a class="code" href="group__NFSprocs.html#ga04157cf3a82ad856010e23efe9ba6b33">01053</a> <span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#ga04157cf3a82ad856010e23efe9ba6b33">nfs4_op_access_xattr</a>(<span class="keyword">struct</span> <a class="code" href="structnfs__argop4.html">nfs_argop4</a> *op,
<a name="l01054"></a>01054                          <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data, <span class="keyword">struct</span> <a class="code" href="structnfs__resop4.html">nfs_resop4</a> *resp)
<a name="l01055"></a>01055 {
<a name="l01056"></a>01056   <span class="keywordtype">char</span> <a class="code" href="group__NFSprocs.html#ga7efec2b565bdbe409979ac657775eeaa">__attribute__</a> ((__unused__)) funcname[] = <span class="stringliteral">&quot;nfs4_op_access_xattr&quot;</span>;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058   resp-&gt;<a class="code" href="structnfs__resop4.html#a247bf08c00fa2bb81b26874cbbfa7f47">resop</a> = <a class="code" href="nfsv40_8h.html#a7d1e727fb25d4cf1f59ae923f665ff0ca1ed99aca2be09666e809a557bf51109d">NFS4_OP_ACCESS</a>;
<a name="l01059"></a>01059 
<a name="l01060"></a>01060   <span class="comment">/* All access types are supported */</span>
<a name="l01062"></a>01062   <a class="code" href="nfs4__xattr_8c.html#aa06ce04fe96f8619c09fd087d7e8d7bd">res_ACCESS4</a>.ACCESS4res_u.resok4.supported = <a class="code" href="nfsv40_8h.html#a5ad44e8b1b7b265444ac6b0160da5a2d">ACCESS4_READ</a> | <a class="code" href="nfsv40_8h.html#ae48fe987a606789e70d7ac65eea1111d">ACCESS4_LOOKUP</a>;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064   <span class="comment">/* DELETE/MODIFY/EXTEND are not supported in the pseudo fs */</span>
<a name="l01065"></a>01065   <a class="code" href="nfs4__xattr_8c.html#aa06ce04fe96f8619c09fd087d7e8d7bd">res_ACCESS4</a>.ACCESS4res_u.resok4.access =
<a name="l01066"></a>01066       <a class="code" href="nfs4__xattr_8c.html#ad9232202effe29cd7db08bde927ab9a8">arg_ACCESS4</a>.access &amp; ~(<a class="code" href="nfsv40_8h.html#a53c4ffcdd76f9c2693096ef5f0598edd">ACCESS4_MODIFY</a> | <a class="code" href="nfsv40_8h.html#a451b85156eda745809cf13e3b52c6dc7">ACCESS4_EXTEND</a> | <a class="code" href="nfsv40_8h.html#af9f854db6fd280626564c1e082fdf3f2">ACCESS4_DELETE</a>);
<a name="l01067"></a>01067 
<a name="l01068"></a>01068   <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01069"></a>01069 }                               <span class="comment">/* nfs4_op_access_xattr */</span>
<a name="l01070"></a>01070 
<a name="l01084"></a>01084 <span class="comment">/* Shorter notation to avoid typos */</span>
<a name="l01085"></a><a class="code" href="nfs4__xattr_8c.html#a751d3df4ffd390f42b00b8cebf7e242f">01085</a> <span class="preprocessor">#define arg_LOOKUP4 op-&gt;nfs_argop4_u.oplookup</span>
<a name="l01086"></a><a class="code" href="nfs4__xattr_8c.html#a82f053cb92425d507861e3293ec5710a">01086</a> <span class="preprocessor"></span><span class="preprocessor">#define res_LOOKUP4 resp-&gt;nfs_resop4_u.oplookup</span>
<a name="l01087"></a>01087 <span class="preprocessor"></span>
<a name="l01088"></a><a class="code" href="group__NFSprocs.html#gaa2f190f37f1eec07721dda6cc4374c4a">01088</a> <span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#gaa2f190f37f1eec07721dda6cc4374c4a">nfs4_op_lookup_xattr</a>(<span class="keyword">struct</span> <a class="code" href="structnfs__argop4.html">nfs_argop4</a> *op,
<a name="l01089"></a>01089                          <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data, <span class="keyword">struct</span> <a class="code" href="structnfs__resop4.html">nfs_resop4</a> *resp)
<a name="l01090"></a>01090 {
<a name="l01091"></a>01091   <a class="code" href="structfsal__name____.html">fsal_name_t</a> <a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>;
<a name="l01092"></a>01092   <span class="keywordtype">char</span> strname[MAXNAMLEN];
<a name="l01093"></a>01093   <a class="code" href="structfsal__status____.html">fsal_status_t</a> fsal_status;
<a name="l01094"></a>01094   <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2">cache_inode_status_t</a> cache_status;
<a name="l01095"></a>01095   <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *pfsal_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01096"></a>01096   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> xattr_id = 0;
<a name="l01097"></a>01097   <a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *pfile_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01098"></a>01098 
<a name="l01099"></a>01099   <span class="keywordtype">char</span> <a class="code" href="group__NFSprocs.html#ga7efec2b565bdbe409979ac657775eeaa">__attribute__</a> ((__unused__)) funcname[] = <span class="stringliteral">&quot;nfs4_op_lookup_xattr&quot;</span>;
<a name="l01100"></a>01100 
<a name="l01101"></a>01101   <span class="comment">/* The xattr directory contains no subdirectory, lookup always returns ENOENT */</span>
<a name="l01102"></a>01102   <a class="code" href="nfs4__xattr_8c.html#a82f053cb92425d507861e3293ec5710a">res_LOOKUP4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01103"></a>01103 
<a name="l01104"></a>01104   <span class="comment">/* Get the FSAL Handle fo the current object */</span>
<a name="l01105"></a>01105   pfsal_handle = &amp;data-&gt;<a class="code" href="structcompoud__data.html#a68044da90b24d713271740a42f88838a">current_entry</a>-&gt;<a class="code" href="structcache__entry__t.html#aaa7abf75d0997dba12395a01c09be705">handle</a>;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107   <span class="comment">/* UTF8 strings may not end with \0, but they carry their length */</span>
<a name="l01108"></a>01108   <a class="code" href="group__NFSprocs.html#ga70018dcc6a707fd605a56100468242c8">utf82str</a>(strname, <span class="keyword">sizeof</span>(strname), &amp;<a class="code" href="nfs4__xattr_8c.html#a751d3df4ffd390f42b00b8cebf7e242f">arg_LOOKUP4</a>.objname);
<a name="l01109"></a>01109 
<a name="l01110"></a>01110   <span class="comment">/* Build the FSAL name */</span>
<a name="l01111"></a>01111   <span class="keywordflow">if</span>((cache_status = <a class="code" href="cache__inode__misc_8c.html#aaa50487b9b403fd85b4a845de1a3df69" title="Converts an FSAL error to the corresponding cache_inode error.">cache_inode_error_convert</a>(<a class="code" href="group__FSALNameFunctions.html#gac4feea8f73f08361426af099c6f3b9c8">FSAL_str2name</a>(strname,
<a name="l01112"></a>01112                                                              MAXNAMLEN,
<a name="l01113"></a>01113                                                              &amp;name))) !=
<a name="l01114"></a>01114      <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2a3fdbbb2367268ae84ac11d7b189643d8">CACHE_INODE_SUCCESS</a>)
<a name="l01115"></a>01115     {
<a name="l01116"></a>01116       <a class="code" href="nfs4__xattr_8c.html#a82f053cb92425d507861e3293ec5710a">res_LOOKUP4</a>.status = <a class="code" href="group__NFSprocs.html#gae5dbdad76b79459bab895e61f800278d">nfs4_Errno</a>(cache_status);
<a name="l01117"></a>01117       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a82f053cb92425d507861e3293ec5710a">res_LOOKUP4</a>.status;
<a name="l01118"></a>01118     }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120   <span class="comment">/* Try to get a FSAL_XAttr of that name */</span>
<a name="l01121"></a>01121   fsal_status = <a class="code" href="fsal__glue_8c.html#a6d09553817f066af47b906a588fe6e4c">FSAL_GetXAttrIdByName</a>(pfsal_handle, &amp;name, data-&gt;<a class="code" href="structcompoud__data.html#a7e30266eb1770e922a88cb7b11ac7f01">pcontext</a>, &amp;xattr_id);
<a name="l01122"></a>01122   <span class="keywordflow">if</span>(<a class="code" href="fsal_8h.html#a7c2a97ec2fa552dea8e497c7dd8a2b86">FSAL_IS_ERROR</a>(fsal_status))
<a name="l01123"></a>01123     {
<a name="l01124"></a>01124       <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aac491f4a9d0c1cbb7772f30c3270869ee">NFS4ERR_NOENT</a>;
<a name="l01125"></a>01125     }
<a name="l01126"></a>01126 
<a name="l01127"></a>01127   <span class="comment">/* Attribute was found */</span>
<a name="l01128"></a>01128   pfile_handle = (<a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *) (data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>.<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>);
<a name="l01129"></a>01129 
<a name="l01130"></a>01130   <span class="comment">/* for Xattr FH, we adopt the current convention:</span>
<a name="l01131"></a>01131 <span class="comment">   * xattr_pos = 0 ==&gt; the FH is the one of the actual FS object</span>
<a name="l01132"></a>01132 <span class="comment">   * xattr_pos = 1 ==&gt; the FH is the one of the xattr ghost directory </span>
<a name="l01133"></a>01133 <span class="comment">   * xattr_pos &gt; 1 ==&gt; The FH is the one for the xattr ghost file whose xattr_id = xattr_pos -2 */</span>
<a name="l01134"></a>01134   pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> = xattr_id + 2;
<a name="l01135"></a>01135 
<a name="l01136"></a>01136   <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01137"></a>01137 }                               <span class="comment">/* nfs4_op_lookup_xattr */</span>
<a name="l01138"></a>01138 
<a name="l01152"></a>01152 <span class="comment">/* Shorter notation to avoid typos */</span>
<a name="l01153"></a><a class="code" href="nfs4__xattr_8c.html#a3e374ea87d855694c238071c82f3e7b8">01153</a> <span class="preprocessor">#define arg_LOOKUPP4 op-&gt;nfs_argop4_u.oplookupp</span>
<a name="l01154"></a><a class="code" href="nfs4__xattr_8c.html#abd44d9268d20d51e6fc2896d890edd25">01154</a> <span class="preprocessor"></span><span class="preprocessor">#define res_LOOKUPP4 resp-&gt;nfs_resop4_u.oplookupp</span>
<a name="l01155"></a>01155 <span class="preprocessor"></span>
<a name="l01156"></a><a class="code" href="group__NFSprocs.html#gacd119997668ffec68db6ca1645a27b14">01156</a> <span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#gacd119997668ffec68db6ca1645a27b14">nfs4_op_lookupp_xattr</a>(<span class="keyword">struct</span> <a class="code" href="structnfs__argop4.html">nfs_argop4</a> *op,
<a name="l01157"></a>01157                           <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data, <span class="keyword">struct</span> <a class="code" href="structnfs__resop4.html">nfs_resop4</a> *resp)
<a name="l01158"></a>01158 {
<a name="l01159"></a>01159   <span class="keywordtype">char</span> <a class="code" href="group__NFSprocs.html#ga7efec2b565bdbe409979ac657775eeaa">__attribute__</a> ((__unused__)) funcname[] = <span class="stringliteral">&quot;nfs4_op_lookup_xattr&quot;</span>;
<a name="l01160"></a>01160 
<a name="l01161"></a>01161   resp-&gt;<a class="code" href="structnfs__resop4.html#a247bf08c00fa2bb81b26874cbbfa7f47">resop</a> = <a class="code" href="nfsv40_8h.html#a7d1e727fb25d4cf1f59ae923f665ff0ca886beaf13f26fcbf761cafe40fb8e336">NFS4_OP_LOOKUPP</a>;
<a name="l01162"></a>01162 
<a name="l01163"></a>01163   <a class="code" href="nfs4__xattr_8c.html#abd44d9268d20d51e6fc2896d890edd25">res_LOOKUPP4</a>.status = <a class="code" href="group__NFSprocs.html#ga2baab3a67c6dd8e5760cb35b0ef12fc7">nfs4_xattrfh_to_fh</a>(&amp;(data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>), &amp;(data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>));
<a name="l01164"></a>01164 
<a name="l01165"></a>01165   <a class="code" href="nfs4__xattr_8c.html#abd44d9268d20d51e6fc2896d890edd25">res_LOOKUPP4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01166"></a>01166   <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01167"></a>01167 }                               <span class="comment">/* nfs4_op_lookupp_xattr */</span>
<a name="l01168"></a>01168 
<a name="l01182"></a>01182 <span class="comment">/* shorter notation to avoid typo */</span>
<a name="l01183"></a><a class="code" href="nfs4__xattr_8c.html#a9d7f38a94db656e965133d2775db49cd">01183</a> <span class="preprocessor">#define arg_READDIR4 op-&gt;nfs_argop4_u.opreaddir</span>
<a name="l01184"></a><a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">01184</a> <span class="preprocessor"></span><span class="preprocessor">#define res_READDIR4 resp-&gt;nfs_resop4_u.opreaddir</span>
<a name="l01185"></a>01185 <span class="preprocessor"></span>
<a name="l01186"></a><a class="code" href="group__NFSprocs.html#gae47fe77dae380e7c731ba38042904249">01186</a> <span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#gae47fe77dae380e7c731ba38042904249">nfs4_op_readdir_xattr</a>(<span class="keyword">struct</span> <a class="code" href="structnfs__argop4.html">nfs_argop4</a> *op,
<a name="l01187"></a>01187                           <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data, <span class="keyword">struct</span> <a class="code" href="structnfs__resop4.html">nfs_resop4</a> *resp)
<a name="l01188"></a>01188 {
<a name="l01189"></a>01189   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> dircount = 0;
<a name="l01190"></a>01190   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> maxcount = 0;
<a name="l01191"></a>01191   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> estimated_num_entries = 0;
<a name="l01192"></a>01192   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i = 0;
<a name="l01193"></a>01193   <span class="keywordtype">int</span> eod_met = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01194"></a>01194   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nb_xattrs_read = 0;
<a name="l01195"></a>01195   <a class="code" href="structfsal__xattrent____.html">fsal_xattrent_t</a> xattrs_tab[255];
<a name="l01196"></a>01196   <a class="code" href="nfsv40_8h.html#ab84f13f675107bfc50709d06b22f60c1">nfs_cookie4</a> cookie;
<a name="l01197"></a>01197   <a class="code" href="nfsv40_8h.html#a11442bc5a79d08d82fa18205f01ae61d">verifier4</a> cookie_verifier;
<a name="l01198"></a>01198   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> space_used = 0;
<a name="l01199"></a>01199   <a class="code" href="structentry4.html">entry4</a> *entry_nfs_array = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01200"></a>01200   <a class="code" href="nfs__core_8h.html#a62324e94cf914f39285ae9931b6b85cd">entry_name_array_item_t</a> *entry_name_array = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01201"></a>01201   <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *pfsal_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01202"></a>01202   <a class="code" href="structfsal__status____.html">fsal_status_t</a> fsal_status;
<a name="l01203"></a>01203   <a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *file_handle;
<a name="l01204"></a>01204   <a class="code" href="structnfs__fh4.html">nfs_fh4</a> nfsfh;
<a name="l01205"></a>01205   <span class="keyword">struct </span><a class="code" href="structalloc__file__handle__v4.html">alloc_file_handle_v4</a> temp_handle;
<a name="l01206"></a>01206 
<a name="l01207"></a>01207   <span class="keywordtype">char</span> <a class="code" href="group__NFSprocs.html#ga7efec2b565bdbe409979ac657775eeaa">__attribute__</a> ((__unused__)) funcname[] = <span class="stringliteral">&quot;nfs4_op_readdir_xattr&quot;</span>;
<a name="l01208"></a>01208 
<a name="l01209"></a>01209   <a class="code" href="structbitmap4.html">bitmap4</a> RdAttrErrorBitmap = { 1, (<a class="code" href="extended__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> *) <span class="stringliteral">&quot;\0\0\0\b&quot;</span> };   <span class="comment">/* 0xB = 11 = FATTR4_RDATTR_ERROR */</span>
<a name="l01210"></a>01210   <a class="code" href="structattrlist4.html">attrlist4</a> RdAttrErrorVals = { 0, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> };      <span class="comment">/* Nothing to be seen here */</span>
<a name="l01211"></a>01211 
<a name="l01212"></a>01212   resp-&gt;<a class="code" href="structnfs__resop4.html#a247bf08c00fa2bb81b26874cbbfa7f47">resop</a> = <a class="code" href="nfsv40_8h.html#a7d1e727fb25d4cf1f59ae923f665ff0ca394c2c8b6dee8cbc54d7ea28a77304fd">NFS4_OP_READDIR</a>;
<a name="l01213"></a>01213   <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215   nfsfh.<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a> = (caddr_t) &amp;temp_handle;
<a name="l01216"></a>01216   nfsfh.<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structalloc__file__handle__v4.html">alloc_file_handle_v4</a>);  
<a name="l01217"></a>01217   memset(nfsfh.<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>, 0, nfsfh.<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a>);
<a name="l01218"></a>01218 
<a name="l01219"></a>01219   memcpy(nfsfh.<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>, data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>.<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>, data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>.<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a>);
<a name="l01220"></a>01220   nfsfh.<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a> = data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>.<a class="code" href="structnfs__fh4.html#a16f1d8d3eb38d12060bef0045f062f16">nfs_fh4_len</a>;
<a name="l01221"></a>01221 
<a name="l01222"></a>01222   file_handle = &amp;temp_handle.<a class="code" href="structalloc__file__handle__v4.html#ae54f5a019a413e76a906fbf02d9c71b2">handle</a>;
<a name="l01223"></a>01223 
<a name="l01224"></a>01224   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>, <span class="stringliteral">&quot;Entering NFS4_OP_READDIR_PSEUDO&quot;</span>);
<a name="l01225"></a>01225 
<a name="l01226"></a>01226   <span class="comment">/* get the caracteristic value for readdir operation */</span>
<a name="l01227"></a>01227   dircount = <a class="code" href="nfs4__xattr_8c.html#a9d7f38a94db656e965133d2775db49cd">arg_READDIR4</a>.dircount;
<a name="l01228"></a>01228   maxcount = <a class="code" href="nfs4__xattr_8c.html#a9d7f38a94db656e965133d2775db49cd">arg_READDIR4</a>.maxcount;
<a name="l01229"></a>01229   cookie = <a class="code" href="nfs4__xattr_8c.html#a9d7f38a94db656e965133d2775db49cd">arg_READDIR4</a>.cookie;
<a name="l01230"></a>01230   space_used = <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#ac66508222b94d2e0f7ffae24746fa330">entry4</a>);
<a name="l01231"></a>01231 
<a name="l01232"></a>01232   <span class="comment">/* dircount is considered meaningless by many nfsv4 client (like the CITI one). we use maxcount instead */</span>
<a name="l01233"></a>01233   estimated_num_entries = maxcount / <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#ac66508222b94d2e0f7ffae24746fa330">entry4</a>);
<a name="l01234"></a>01234 
<a name="l01235"></a>01235   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>,
<a name="l01236"></a>01236                <span class="stringliteral">&quot;PSEUDOFS READDIR: dircount=%lu, maxcount=%lu, cookie=%&quot;</span>PRIu64<span class="stringliteral">&quot;, sizeof(entry4)=%lu num_entries=%lu&quot;</span>,
<a name="l01237"></a>01237                dircount, maxcount, (<a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a>)cookie, space_used, estimated_num_entries);
<a name="l01238"></a>01238 
<a name="l01239"></a>01239   <span class="comment">/* If maxcount is too short, return NFS4ERR_TOOSMALL */</span>
<a name="l01240"></a>01240   <span class="keywordflow">if</span>(maxcount &lt; <span class="keyword">sizeof</span>(<a class="code" href="structentry4.html">entry4</a>) || estimated_num_entries == 0)
<a name="l01241"></a>01241     {
<a name="l01242"></a>01242       <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aa2a40ecaf15573910b6e26d4ea1204d9f">NFS4ERR_TOOSMALL</a>;
<a name="l01243"></a>01243       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status;
<a name="l01244"></a>01244     }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246   <span class="comment">/* Cookie delivered by the server and used by the client SHOULD not ne 0, 1 or 2 (cf RFC3530, page192)</span>
<a name="l01247"></a>01247 <span class="comment">   * because theses value are reserved for special use.</span>
<a name="l01248"></a>01248 <span class="comment">   *      0 - cookie for first READDIR</span>
<a name="l01249"></a>01249 <span class="comment">   *      1 - reserved for . on client handside</span>
<a name="l01250"></a>01250 <span class="comment">   *      2 - reserved for .. on client handside</span>
<a name="l01251"></a>01251 <span class="comment">   * Entries &#39;.&#39; and &#39;..&#39; are not returned also</span>
<a name="l01252"></a>01252 <span class="comment">   * For these reason, there will be an offset of 3 between NFS4 cookie and HPSS cookie */</span>
<a name="l01253"></a>01253 
<a name="l01254"></a>01254   <span class="comment">/* Do not use a cookie of 1 or 2 (reserved values) */</span>
<a name="l01255"></a>01255   <span class="keywordflow">if</span>(cookie == 1 || cookie == 2)
<a name="l01256"></a>01256     {
<a name="l01257"></a>01257       <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aa9df3847c77f73d59d1338b64329d2a28">NFS4ERR_BAD_COOKIE</a>;
<a name="l01258"></a>01258       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status;
<a name="l01259"></a>01259     }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261   <span class="keywordflow">if</span>(cookie != 0)
<a name="l01262"></a>01262     cookie = cookie - 3;        <span class="comment">/* 0,1 and 2 are reserved, there is a delta of &#39;3&#39; because of this */</span>
<a name="l01263"></a>01263 
<a name="l01264"></a>01264   <span class="comment">/* Get only attributes that are allowed to be read */</span>
<a name="l01265"></a>01265   <span class="keywordflow">if</span>(!<a class="code" href="group__NFSprocs.html#ga1b540b58ace7db01da59ffae1c434b7d">nfs4_Fattr_Check_Access_Bitmap</a>(&amp;<a class="code" href="nfs4__xattr_8c.html#a9d7f38a94db656e965133d2775db49cd">arg_READDIR4</a>.attr_request, <a class="code" href="group__NFSprocs.html#gae8ec85675a053c06aebacf637a994173">FATTR4_ATTR_READ</a>))
<a name="l01266"></a>01266     {
<a name="l01267"></a>01267       <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacd5ac22a1fa5139d3566ed06c20d9c7a">NFS4ERR_INVAL</a>;
<a name="l01268"></a>01268       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status;
<a name="l01269"></a>01269     }
<a name="l01270"></a>01270 
<a name="l01271"></a>01271   <span class="comment">/* If maxcount is too short, return NFS4ERR_TOOSMALL */</span>
<a name="l01272"></a>01272   <span class="keywordflow">if</span>(maxcount &lt; <span class="keyword">sizeof</span>(<a class="code" href="structentry4.html">entry4</a>) || estimated_num_entries == 0)
<a name="l01273"></a>01273     {
<a name="l01274"></a>01274       <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aa2a40ecaf15573910b6e26d4ea1204d9f">NFS4ERR_TOOSMALL</a>;
<a name="l01275"></a>01275       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status;
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277 
<a name="l01278"></a>01278   <span class="comment">/* Cookie verifier has the value of the Server Boot Time for pseudo fs */</span>
<a name="l01279"></a>01279   memset(cookie_verifier, 0, <a class="code" href="nfsv40_8h.html#a9008a5d72999d610aee7c794839c8aff">NFS4_VERIFIER_SIZE</a>);
<a name="l01280"></a>01280 <span class="preprocessor">#ifdef _WITH_COOKIE_VERIFIER</span>
<a name="l01281"></a>01281 <span class="preprocessor"></span>  <span class="comment">/* BUGAZOMEU: management of the cookie verifier */</span>
<a name="l01282"></a>01282   <span class="keywordflow">if</span>(NFS_SpecificConfig.UseCookieVerf == 1)
<a name="l01283"></a>01283     {
<a name="l01284"></a>01284       memcpy(cookie_verifier, &amp;<a class="code" href="Convert__FSAL__Handle_8c.html#a7b4df488832bc1f60082b16b51472dc5">ServerBootTime</a>, <span class="keyword">sizeof</span>(<a class="code" href="Convert__FSAL__Handle_8c.html#a7b4df488832bc1f60082b16b51472dc5">ServerBootTime</a>));
<a name="l01285"></a>01285       <span class="keywordflow">if</span>(cookie != 0)
<a name="l01286"></a>01286         {
<a name="l01287"></a>01287           <span class="keywordflow">if</span>(memcmp(cookie_verifier, <a class="code" href="nfs4__xattr_8c.html#a9d7f38a94db656e965133d2775db49cd">arg_READDIR4</a>.cookieverf, <a class="code" href="nfsv40_8h.html#a9008a5d72999d610aee7c794839c8aff">NFS4_VERIFIER_SIZE</a>) != 0)
<a name="l01288"></a>01288             {
<a name="l01289"></a>01289               <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aa9df3847c77f73d59d1338b64329d2a28">NFS4ERR_BAD_COOKIE</a>;
<a name="l01290"></a>01290               gsh_free(entry_nfs_array);
<a name="l01291"></a>01291               <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status;
<a name="l01292"></a>01292             }
<a name="l01293"></a>01293         }
<a name="l01294"></a>01294     }
<a name="l01295"></a>01295 <span class="preprocessor">#endif</span>
<a name="l01296"></a>01296 <span class="preprocessor"></span>
<a name="l01297"></a>01297   <span class="comment">/* The default behaviour is to consider that eof is not reached, the returned values by cache_inode_readdir </span>
<a name="l01298"></a>01298 <span class="comment">   * will let us know if eod was reached or not */</span>
<a name="l01299"></a>01299   <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.READDIR4res_u.resok4.reply.eof = <a class="code" href="HashTable_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301   <span class="comment">/* Get the fsal_handle */</span>
<a name="l01302"></a>01302   pfsal_handle = &amp;data-&gt;<a class="code" href="structcompoud__data.html#a68044da90b24d713271740a42f88838a">current_entry</a>-&gt;<a class="code" href="structcache__entry__t.html#aaa7abf75d0997dba12395a01c09be705">handle</a>;
<a name="l01303"></a>01303 
<a name="l01304"></a>01304   <span class="comment">/* Used FSAL extended attributes functions */</span>
<a name="l01305"></a>01305   fsal_status = <a class="code" href="fsal__glue_8c.html#aa03c82288bfeafb8dc7aff4ebd55aef3">FSAL_ListXAttrs</a>(pfsal_handle,
<a name="l01306"></a>01306                                 cookie,
<a name="l01307"></a>01307                                 data-&gt;<a class="code" href="structcompoud__data.html#a7e30266eb1770e922a88cb7b11ac7f01">pcontext</a>,
<a name="l01308"></a>01308                                 xattrs_tab,
<a name="l01309"></a>01309                                 estimated_num_entries, &amp;nb_xattrs_read, &amp;eod_met);
<a name="l01310"></a>01310   <span class="keywordflow">if</span>(<a class="code" href="fsal_8h.html#a7c2a97ec2fa552dea8e497c7dd8a2b86">FSAL_IS_ERROR</a>(fsal_status))
<a name="l01311"></a>01311     {
<a name="l01312"></a>01312       <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aaf8c067759d4fef22cb97409d7a50c453">NFS4ERR_SERVERFAULT</a>;
<a name="l01313"></a>01313       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status;
<a name="l01314"></a>01314     }
<a name="l01315"></a>01315 
<a name="l01316"></a>01316   <span class="keywordflow">if</span>(eod_met == <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l01317"></a>01317     {
<a name="l01318"></a>01318       <span class="comment">/* This is the end of the directory */</span>
<a name="l01319"></a>01319       <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.READDIR4res_u.resok4.reply.eof = <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01320"></a>01320       memcpy(<a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.READDIR4res_u.resok4.cookieverf, cookie_verifier,
<a name="l01321"></a>01321              <a class="code" href="nfsv40_8h.html#a9008a5d72999d610aee7c794839c8aff">NFS4_VERIFIER_SIZE</a>);
<a name="l01322"></a>01322     }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324   <span class="keywordflow">if</span>(nb_xattrs_read == 0)
<a name="l01325"></a>01325     {
<a name="l01326"></a>01326       <span class="comment">/* only . and .. */</span>
<a name="l01327"></a>01327       <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.READDIR4res_u.resok4.reply.entries = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01328"></a>01328       <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.READDIR4res_u.resok4.reply.eof = <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01329"></a>01329       memcpy(<a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.READDIR4res_u.resok4.cookieverf, cookie_verifier,
<a name="l01330"></a>01330              <a class="code" href="nfsv40_8h.html#a9008a5d72999d610aee7c794839c8aff">NFS4_VERIFIER_SIZE</a>);
<a name="l01331"></a>01331     }
<a name="l01332"></a>01332   <span class="keywordflow">else</span>
<a name="l01333"></a>01333     {
<a name="l01334"></a>01334       <span class="comment">/* Allocation of reply structures */</span>
<a name="l01335"></a>01335       <span class="keywordflow">if</span>((entry_name_array =
<a name="l01336"></a>01336           gsh_calloc(estimated_num_entries, (<a class="code" href="fsal__types_8h.html#ad026c47acb9681dca70066e06a9e6b50">FSAL_MAX_NAME_LEN</a> + 1))) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01337"></a>01337         {
<a name="l01338"></a>01338           <a class="code" href="log_8h.html#a367b67f5a0b29160763c3ce8efce0875">LogError</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>, <a class="code" href="log_8h.html#ad9f6cff569b8aaff581efed5a643f26a">ERR_SYS</a>, <a class="code" href="log_8h.html#af5644a8648341ffd4c34f7fb77bf1781">ERR_MALLOC</a>, errno);
<a name="l01339"></a>01339           <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aaf8c067759d4fef22cb97409d7a50c453">NFS4ERR_SERVERFAULT</a>;
<a name="l01340"></a>01340           <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status;
<a name="l01341"></a>01341         }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343       <span class="keywordflow">if</span>((entry_nfs_array =
<a name="l01344"></a>01344           gsh_calloc(estimated_num_entries, <span class="keyword">sizeof</span>(<a class="code" href="structentry4.html">entry4</a>))) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01345"></a>01345         {
<a name="l01346"></a>01346           <a class="code" href="log_8h.html#a367b67f5a0b29160763c3ce8efce0875">LogError</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556a332778fab5bbe8e71894de29785b8510">COMPONENT_NFS_V4_XATTR</a>, <a class="code" href="log_8h.html#ad9f6cff569b8aaff581efed5a643f26a">ERR_SYS</a>, <a class="code" href="log_8h.html#af5644a8648341ffd4c34f7fb77bf1781">ERR_MALLOC</a>, errno);
<a name="l01347"></a>01347           <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aaf8c067759d4fef22cb97409d7a50c453">NFS4ERR_SERVERFAULT</a>;
<a name="l01348"></a>01348           <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status;
<a name="l01349"></a>01349         }
<a name="l01350"></a>01350 
<a name="l01351"></a>01351       <span class="keywordflow">for</span>(i = 0; i &lt; nb_xattrs_read; i++)
<a name="l01352"></a>01352         {
<a name="l01353"></a>01353           entry_nfs_array[i].<a class="code" href="structentry4.html#aae84aeee9a2e40a7ef6797978d2ed016">name</a>.<a class="code" href="structutf8string.html#a72e3ba7aecf5547219953542a1c32271">utf8string_val</a> = entry_name_array[i];
<a name="l01354"></a>01354 
<a name="l01355"></a>01355           <span class="keywordflow">if</span>(<a class="code" href="group__NFSprocs.html#ga1113f595b919b5c955131797fcf8715f">str2utf8</a>(xattrs_tab[i].xattr_name.name, &amp;entry_nfs_array[i].<a class="code" href="structentry4.html#aae84aeee9a2e40a7ef6797978d2ed016">name</a>) == -1)
<a name="l01356"></a>01356             {
<a name="l01357"></a>01357               <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aaf8c067759d4fef22cb97409d7a50c453">NFS4ERR_SERVERFAULT</a>;
<a name="l01358"></a>01358               <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status;
<a name="l01359"></a>01359             }
<a name="l01360"></a>01360 
<a name="l01361"></a>01361           <span class="comment">/* Set the cookie value */</span>
<a name="l01362"></a>01362           entry_nfs_array[i].<a class="code" href="structentry4.html#aaa936cae6355676aa7a7ae1095ae8861">cookie</a> = cookie + i + 3;   <span class="comment">/* 0, 1 and 2 are reserved */</span>
<a name="l01363"></a>01363 
<a name="l01364"></a>01364           file_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> = xattrs_tab[i].<a class="code" href="structfsal__xattrent____.html#a621278119806c390c7ab9b11cd75a860">xattr_id</a> + 2;
<a name="l01365"></a>01365           <span class="keywordflow">if</span>(<a class="code" href="group__NFSprocs.html#ga258f1eeb0cfc4284bc58148675cf3974">nfs4_XattrToFattr</a>(&amp;(entry_nfs_array[i].attrs),
<a name="l01366"></a>01366                                data, &amp;nfsfh, &amp;(<a class="code" href="nfs4__xattr_8c.html#a9d7f38a94db656e965133d2775db49cd">arg_READDIR4</a>.attr_request)) != 0)
<a name="l01367"></a>01367             {
<a name="l01368"></a>01368               <span class="comment">/* Return the fattr4_rdattr_error , cf RFC3530, page 192 */</span>
<a name="l01369"></a>01369               entry_nfs_array[i].<a class="code" href="structentry4.html#a5ad6930a37a2c4249e2866bc2890947a">attrs</a>.<a class="code" href="structfattr4.html#ad00a59e5833c61e864df84d690d4a148">attrmask</a> = RdAttrErrorBitmap;
<a name="l01370"></a>01370               entry_nfs_array[i].<a class="code" href="structentry4.html#a5ad6930a37a2c4249e2866bc2890947a">attrs</a>.<a class="code" href="structfattr4.html#aaec7d166bce03e6cf76ce9d06f88540e">attr_vals</a> = RdAttrErrorVals;
<a name="l01371"></a>01371             }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373           <span class="comment">/* Chain the entries together */</span>
<a name="l01374"></a>01374           entry_nfs_array[i].<a class="code" href="structentry4.html#a5086f402592271af41bf2213b2b59c71">nextentry</a> = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01375"></a>01375           <span class="keywordflow">if</span>(i != 0)
<a name="l01376"></a>01376             entry_nfs_array[i - 1].<a class="code" href="structentry4.html#a5086f402592271af41bf2213b2b59c71">nextentry</a> = &amp;(entry_nfs_array[i]);
<a name="l01377"></a>01377 
<a name="l01378"></a>01378           <span class="comment">/* This test is there to avoid going further than the buffer provided by the client </span>
<a name="l01379"></a>01379 <span class="comment">           * the factor &quot;9/10&quot; is there for safety. Its value could be change as beta tests will be done */</span>
<a name="l01380"></a>01380           <span class="keywordflow">if</span>((caddr_t)
<a name="l01381"></a>01381              ((caddr_t) (&amp;entry_nfs_array[i]) - (caddr_t) (&amp;entry_nfs_array[0])) &gt;
<a name="l01382"></a>01382              (caddr_t) (maxcount * 9 / 10))
<a name="l01383"></a>01383             <span class="keywordflow">break</span>;
<a name="l01384"></a>01384 
<a name="l01385"></a>01385         }                       <span class="comment">/* for */</span>
<a name="l01386"></a>01386 
<a name="l01387"></a>01387     }                           <span class="comment">/* else */</span>
<a name="l01388"></a>01388 
<a name="l01389"></a>01389   <span class="comment">/* Build the reply */</span>
<a name="l01390"></a>01390   memcpy(<a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.READDIR4res_u.resok4.cookieverf, cookie_verifier,
<a name="l01391"></a>01391          <a class="code" href="nfsv40_8h.html#a9008a5d72999d610aee7c794839c8aff">NFS4_VERIFIER_SIZE</a>);
<a name="l01392"></a>01392   <span class="keywordflow">if</span>(i == 0)
<a name="l01393"></a>01393     <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.READDIR4res_u.resok4.reply.entries = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01394"></a>01394   <span class="keywordflow">else</span>
<a name="l01395"></a>01395     <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.READDIR4res_u.resok4.reply.entries = entry_nfs_array;
<a name="l01396"></a>01396 
<a name="l01397"></a>01397   <a class="code" href="nfs4__xattr_8c.html#a4431793853d48901cff825fcd7b56869">res_READDIR4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01398"></a>01398 
<a name="l01399"></a>01399   <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01400"></a>01400 
<a name="l01401"></a>01401 }                               <span class="comment">/* nfs4_op_readdir_xattr */</span>
<a name="l01402"></a>01402 
<a name="l01413"></a>01413 <span class="preprocessor">#define arg_READ4 op-&gt;nfs_argop4_u.opread</span>
<a name="l01414"></a>01414 <span class="preprocessor"></span><span class="preprocessor">#define res_READ4 resp-&gt;nfs_resop4_u.opread</span>
<a name="l01415"></a>01415 <span class="preprocessor"></span>
<a name="l01416"></a><a class="code" href="nfs4__xattr_8c.html#a1a1f3adcb1ed7da29c37839d099f4aa8">01416</a> <span class="preprocessor">#define arg_OPEN4 op-&gt;nfs_argop4_u.opopen</span>
<a name="l01417"></a><a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">01417</a> <span class="preprocessor"></span><span class="preprocessor">#define res_OPEN4 resp-&gt;nfs_resop4_u.opopen</span>
<a name="l01418"></a><a class="code" href="group__NFSprocs.html#gad45e627c0d0dc585fed2a9f351ffcf51">01418</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#gad45e627c0d0dc585fed2a9f351ffcf51">nfs4_op_open_xattr</a>(<span class="keyword">struct</span> <a class="code" href="structnfs__argop4.html">nfs_argop4</a> *op,
<a name="l01419"></a>01419                        <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data, <span class="keyword">struct</span> <a class="code" href="structnfs__resop4.html">nfs_resop4</a> *resp)
<a name="l01420"></a>01420 {
<a name="l01421"></a>01421   <a class="code" href="structfsal__name____.html">fsal_name_t</a> <a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>;
<a name="l01422"></a>01422   <span class="keywordtype">char</span> strname[MAXNAMLEN];
<a name="l01423"></a>01423   <a class="code" href="structfsal__status____.html">fsal_status_t</a> fsal_status;
<a name="l01424"></a>01424   <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2">cache_inode_status_t</a> cache_status;
<a name="l01425"></a>01425   <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *pfsal_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01426"></a>01426   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> xattr_id = 0;
<a name="l01427"></a>01427   <a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *pfile_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01428"></a>01428   <span class="keywordtype">char</span> empty_buff[16] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430   <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01431"></a>01431 
<a name="l01432"></a>01432   <span class="comment">/* Get the FSAL Handle fo the current object */</span>
<a name="l01433"></a>01433   pfsal_handle = &amp;data-&gt;<a class="code" href="structcompoud__data.html#a68044da90b24d713271740a42f88838a">current_entry</a>-&gt;<a class="code" href="structcache__entry__t.html#aaa7abf75d0997dba12395a01c09be705">handle</a>;
<a name="l01434"></a>01434 
<a name="l01435"></a>01435   <span class="comment">/* UTF8 strings may not end with \0, but they carry their length */</span>
<a name="l01436"></a>01436   <a class="code" href="group__NFSprocs.html#ga70018dcc6a707fd605a56100468242c8">utf82str</a>(strname, <span class="keyword">sizeof</span>(strname), &amp;<a class="code" href="nfs4__xattr_8c.html#a1a1f3adcb1ed7da29c37839d099f4aa8">arg_OPEN4</a>.claim.open_claim4_u.file);
<a name="l01437"></a>01437 
<a name="l01438"></a>01438   <span class="comment">/* Build the FSAL name */</span>
<a name="l01439"></a>01439   <span class="keywordflow">if</span>((cache_status = <a class="code" href="cache__inode__misc_8c.html#aaa50487b9b403fd85b4a845de1a3df69" title="Converts an FSAL error to the corresponding cache_inode error.">cache_inode_error_convert</a>(<a class="code" href="group__FSALNameFunctions.html#gac4feea8f73f08361426af099c6f3b9c8">FSAL_str2name</a>(strname,
<a name="l01440"></a>01440                                                              MAXNAMLEN,
<a name="l01441"></a>01441                                                              &amp;name))) !=
<a name="l01442"></a>01442      <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2a3fdbbb2367268ae84ac11d7b189643d8">CACHE_INODE_SUCCESS</a>)
<a name="l01443"></a>01443     {
<a name="l01444"></a>01444       <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status = <a class="code" href="group__NFSprocs.html#gae5dbdad76b79459bab895e61f800278d">nfs4_Errno</a>(cache_status);
<a name="l01445"></a>01445       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status;
<a name="l01446"></a>01446     }
<a name="l01447"></a>01447 
<a name="l01448"></a>01448   <span class="comment">/* we do not use the stateful logic for accessing xattrs */</span>
<a name="l01449"></a>01449   <span class="keywordflow">switch</span> (<a class="code" href="nfs4__xattr_8c.html#a1a1f3adcb1ed7da29c37839d099f4aa8">arg_OPEN4</a>.openhow.opentype)
<a name="l01450"></a>01450     {
<a name="l01451"></a>01451     <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a33c1485f210dd4bfd99e96f257f13b78a1ce9bbcc558fb7438339f387498b87c0">OPEN4_CREATE</a>:
<a name="l01452"></a>01452       <span class="comment">/* To be done later */</span>
<a name="l01453"></a>01453       <span class="comment">/* set empty attr */</span>
<a name="l01454"></a>01454       fsal_status = <a class="code" href="fsal__glue_8c.html#aa17bbc2609914810a9896d314da2dbae">FSAL_SetXAttrValue</a>(pfsal_handle,
<a name="l01455"></a>01455                                        &amp;name,
<a name="l01456"></a>01456                                        data-&gt;<a class="code" href="structcompoud__data.html#a7e30266eb1770e922a88cb7b11ac7f01">pcontext</a>, empty_buff, <span class="keyword">sizeof</span>(empty_buff),
<a name="l01457"></a>01457                                        <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01458"></a>01458 
<a name="l01459"></a>01459       <span class="keywordflow">if</span>(<a class="code" href="fsal_8h.html#a7c2a97ec2fa552dea8e497c7dd8a2b86">FSAL_IS_ERROR</a>(fsal_status))
<a name="l01460"></a>01460         {
<a name="l01461"></a>01461           <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status = <a class="code" href="group__NFSprocs.html#gae5dbdad76b79459bab895e61f800278d">nfs4_Errno</a>(<a class="code" href="cache__inode__misc_8c.html#aaa50487b9b403fd85b4a845de1a3df69" title="Converts an FSAL error to the corresponding cache_inode error.">cache_inode_error_convert</a>(fsal_status));
<a name="l01462"></a>01462           <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status;
<a name="l01463"></a>01463         }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465       <span class="comment">/* Now, getr the id */</span>
<a name="l01466"></a>01466       fsal_status = <a class="code" href="fsal__glue_8c.html#a6d09553817f066af47b906a588fe6e4c">FSAL_GetXAttrIdByName</a>(pfsal_handle, &amp;name, data-&gt;<a class="code" href="structcompoud__data.html#a7e30266eb1770e922a88cb7b11ac7f01">pcontext</a>, &amp;xattr_id);
<a name="l01467"></a>01467       <span class="keywordflow">if</span>(<a class="code" href="fsal_8h.html#a7c2a97ec2fa552dea8e497c7dd8a2b86">FSAL_IS_ERROR</a>(fsal_status))
<a name="l01468"></a>01468         {
<a name="l01469"></a>01469           <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aac491f4a9d0c1cbb7772f30c3270869ee">NFS4ERR_NOENT</a>;
<a name="l01470"></a>01470           <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status;
<a name="l01471"></a>01471         }
<a name="l01472"></a>01472 
<a name="l01473"></a>01473       <span class="comment">/* Attribute was found */</span>
<a name="l01474"></a>01474       pfile_handle = (<a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *) (data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>.<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>);
<a name="l01475"></a>01475 
<a name="l01476"></a>01476       <span class="comment">/* for Xattr FH, we adopt the current convention:</span>
<a name="l01477"></a>01477 <span class="comment">       * xattr_pos = 0 ==&gt; the FH is the one of the actual FS object</span>
<a name="l01478"></a>01478 <span class="comment">       * xattr_pos = 1 ==&gt; the FH is the one of the xattr ghost directory </span>
<a name="l01479"></a>01479 <span class="comment">       * xattr_pos &gt; 1 ==&gt; The FH is the one for the xattr ghost file whose xattr_id = xattr_pos -2 */</span>
<a name="l01480"></a>01480       pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> = xattr_id + 2;
<a name="l01481"></a>01481 
<a name="l01482"></a>01482       <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01483"></a>01483       <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01484"></a>01484 
<a name="l01485"></a>01485       <span class="keywordflow">break</span>;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a33c1485f210dd4bfd99e96f257f13b78ae8e081fb1fb0df3c89134ae14aae4d34">OPEN4_NOCREATE</a>:
<a name="l01488"></a>01488 
<a name="l01489"></a>01489       <span class="comment">/* Try to get a FSAL_XAttr of that name */</span>
<a name="l01490"></a>01490       fsal_status = <a class="code" href="fsal__glue_8c.html#a6d09553817f066af47b906a588fe6e4c">FSAL_GetXAttrIdByName</a>(pfsal_handle, &amp;name, data-&gt;<a class="code" href="structcompoud__data.html#a7e30266eb1770e922a88cb7b11ac7f01">pcontext</a>, &amp;xattr_id);
<a name="l01491"></a>01491       <span class="keywordflow">if</span>(<a class="code" href="fsal_8h.html#a7c2a97ec2fa552dea8e497c7dd8a2b86">FSAL_IS_ERROR</a>(fsal_status))
<a name="l01492"></a>01492         {
<a name="l01493"></a>01493           <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aac491f4a9d0c1cbb7772f30c3270869ee">NFS4ERR_NOENT</a>;
<a name="l01494"></a>01494           <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status;
<a name="l01495"></a>01495         }
<a name="l01496"></a>01496 
<a name="l01497"></a>01497       <span class="comment">/* Attribute was found */</span>
<a name="l01498"></a>01498       pfile_handle = (<a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *) (data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>.<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>);
<a name="l01499"></a>01499 
<a name="l01500"></a>01500       <span class="comment">/* for Xattr FH, we adopt the current convention:</span>
<a name="l01501"></a>01501 <span class="comment">       * xattr_pos = 0 ==&gt; the FH is the one of the actual FS object</span>
<a name="l01502"></a>01502 <span class="comment">       * xattr_pos = 1 ==&gt; the FH is the one of the xattr ghost directory </span>
<a name="l01503"></a>01503 <span class="comment">       * xattr_pos &gt; 1 ==&gt; The FH is the one for the xattr ghost file whose xattr_id = xattr_pos -2 */</span>
<a name="l01504"></a>01504       pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> = xattr_id + 2;
<a name="l01505"></a>01505 
<a name="l01506"></a>01506       <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01507"></a>01507       <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01508"></a>01508 
<a name="l01509"></a>01509       <span class="keywordflow">break</span>;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511     }                           <span class="comment">/* switch (arg_OPEN4.openhow.opentype) */</span>
<a name="l01512"></a>01512 
<a name="l01513"></a>01513   <a class="code" href="nfs4__xattr_8c.html#ac9edacbb8801cbf7a19ded2c78549716">res_OPEN4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01514"></a>01514   <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01515"></a>01515 }                               <span class="comment">/* nfs4_op_open_xattr */</span>
<a name="l01516"></a>01516 
<a name="l01527"></a><a class="code" href="nfs4__xattr_8c.html#a58b206bf59d7f3cfa743f3bc81a8a733">01527</a> <span class="preprocessor">#define arg_READ4 op-&gt;nfs_argop4_u.opread</span>
<a name="l01528"></a><a class="code" href="nfs4__xattr_8c.html#a2874585685e65663117a984c8e7d6ca2">01528</a> <span class="preprocessor"></span><span class="preprocessor">#define res_READ4 resp-&gt;nfs_resop4_u.opread</span>
<a name="l01529"></a>01529 <span class="preprocessor"></span>
<a name="l01530"></a><a class="code" href="group__NFSprocs.html#gab2e3cac242573d0e0be182d839ca1291">01530</a> <span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#gab2e3cac242573d0e0be182d839ca1291">nfs4_op_read_xattr</a>(<span class="keyword">struct</span> <a class="code" href="structnfs__argop4.html">nfs_argop4</a> *op,
<a name="l01531"></a>01531                        <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data, <span class="keyword">struct</span> <a class="code" href="structnfs__resop4.html">nfs_resop4</a> *resp)
<a name="l01532"></a>01532 {
<a name="l01533"></a>01533   <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *pfsal_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01534"></a>01534   <a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *pfile_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01535"></a>01535   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> xattr_id = 0;
<a name="l01536"></a>01536   <a class="code" href="structfsal__status____.html">fsal_status_t</a> fsal_status;
<a name="l01537"></a>01537   <span class="keywordtype">char</span> *buffer = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01538"></a>01538   <span class="keywordtype">size_t</span> size_returned;
<a name="l01539"></a>01539 
<a name="l01540"></a>01540   <span class="comment">/* Get the FSAL Handle fo the current object */</span>
<a name="l01541"></a>01541   pfsal_handle = &amp;data-&gt;<a class="code" href="structcompoud__data.html#a68044da90b24d713271740a42f88838a">current_entry</a>-&gt;<a class="code" href="structcache__entry__t.html#aaa7abf75d0997dba12395a01c09be705">handle</a>;
<a name="l01542"></a>01542 
<a name="l01543"></a>01543   <span class="comment">/* Get the xattr_id */</span>
<a name="l01544"></a>01544   pfile_handle = (<a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *) (data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>.<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>);
<a name="l01545"></a>01545 
<a name="l01546"></a>01546   <span class="comment">/* for Xattr FH, we adopt the current convention:</span>
<a name="l01547"></a>01547 <span class="comment">   * xattr_pos = 0 ==&gt; the FH is the one of the actual FS object</span>
<a name="l01548"></a>01548 <span class="comment">   * xattr_pos = 1 ==&gt; the FH is the one of the xattr ghost directory</span>
<a name="l01549"></a>01549 <span class="comment">   * xattr_pos &gt; 1 ==&gt; The FH is the one for the xattr ghost file whose xattr_id = xattr_pos -2 */</span>
<a name="l01550"></a>01550   xattr_id = pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> - 2;
<a name="l01551"></a>01551 
<a name="l01552"></a>01552   <span class="comment">/* Get the xattr related to this xattr_id */</span>
<a name="l01553"></a>01553   <span class="keywordflow">if</span>((buffer = gsh_calloc(1, <a class="code" href="nfs__core_8h.html#a816cc825757784d7cccf87569af96a90">XATTR_BUFFERSIZE</a>)) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01554"></a>01554     {
<a name="l01555"></a>01555       <a class="code" href="nfs4__op__read_8c.html#a2874585685e65663117a984c8e7d6ca2">res_READ4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aaf8c067759d4fef22cb97409d7a50c453">NFS4ERR_SERVERFAULT</a>;
<a name="l01556"></a>01556       <span class="keywordflow">return</span> <a class="code" href="nfs4__op__read_8c.html#a2874585685e65663117a984c8e7d6ca2">res_READ4</a>.status;
<a name="l01557"></a>01557     }
<a name="l01558"></a>01558 
<a name="l01559"></a>01559   fsal_status = <a class="code" href="fsal__glue_8c.html#a3fd37911eeee4f0bb898a1cb9e18b65a">FSAL_GetXAttrValueById</a>(pfsal_handle,
<a name="l01560"></a>01560                                        xattr_id,
<a name="l01561"></a>01561                                        data-&gt;<a class="code" href="structcompoud__data.html#a7e30266eb1770e922a88cb7b11ac7f01">pcontext</a>,
<a name="l01562"></a>01562                                        buffer, <a class="code" href="nfs__core_8h.html#a816cc825757784d7cccf87569af96a90">XATTR_BUFFERSIZE</a>, &amp;size_returned);
<a name="l01563"></a>01563 
<a name="l01564"></a>01564   <span class="keywordflow">if</span>(<a class="code" href="fsal_8h.html#a7c2a97ec2fa552dea8e497c7dd8a2b86">FSAL_IS_ERROR</a>(fsal_status))
<a name="l01565"></a>01565     {
<a name="l01566"></a>01566       <a class="code" href="nfs4__op__read_8c.html#a2874585685e65663117a984c8e7d6ca2">res_READ4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aaf8c067759d4fef22cb97409d7a50c453">NFS4ERR_SERVERFAULT</a>;
<a name="l01567"></a>01567       <span class="keywordflow">return</span> <a class="code" href="nfs4__op__read_8c.html#a2874585685e65663117a984c8e7d6ca2">res_READ4</a>.status;
<a name="l01568"></a>01568     }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570   <a class="code" href="nfs4__op__read_8c.html#a2874585685e65663117a984c8e7d6ca2">res_READ4</a>.READ4res_u.resok4.data.data_len = size_returned;
<a name="l01571"></a>01571   <a class="code" href="nfs4__op__read_8c.html#a2874585685e65663117a984c8e7d6ca2">res_READ4</a>.READ4res_u.resok4.data.data_val = buffer;
<a name="l01572"></a>01572 
<a name="l01573"></a>01573   <a class="code" href="nfs4__op__read_8c.html#a2874585685e65663117a984c8e7d6ca2">res_READ4</a>.READ4res_u.resok4.eof = <a class="code" href="HashTable_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01574"></a>01574 
<a name="l01575"></a>01575   <a class="code" href="nfs4__op__read_8c.html#a2874585685e65663117a984c8e7d6ca2">res_READ4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01576"></a>01576 
<a name="l01577"></a>01577   <span class="keywordflow">return</span> <a class="code" href="nfs4__op__read_8c.html#a2874585685e65663117a984c8e7d6ca2">res_READ4</a>.status;
<a name="l01578"></a>01578 }                               <span class="comment">/* nfs4_op_read_xattr */</span>
<a name="l01579"></a>01579 
<a name="l01590"></a><a class="code" href="nfs4__xattr_8c.html#accff831137cce95c2acb6cf67d13cc5b">01590</a> <span class="preprocessor">#define arg_WRITE4 op-&gt;nfs_argop4_u.opwrite</span>
<a name="l01591"></a><a class="code" href="nfs4__xattr_8c.html#aea1bf8859e2b84e5ba19941397275eca">01591</a> <span class="preprocessor"></span><span class="preprocessor">#define res_WRITE4 resp-&gt;nfs_resop4_u.opwrite</span>
<a name="l01592"></a>01592 <span class="preprocessor"></span>
<a name="l01593"></a><a class="code" href="group__NFSprocs.html#ga541032e1c77a5bd7c6a4c1ab92ddc031">01593</a> <span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#ga541032e1c77a5bd7c6a4c1ab92ddc031">nfs4_op_write_xattr</a>(<span class="keyword">struct</span> <a class="code" href="structnfs__argop4.html">nfs_argop4</a> *op,
<a name="l01594"></a>01594                         <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data, <span class="keyword">struct</span> <a class="code" href="structnfs__resop4.html">nfs_resop4</a> *resp)
<a name="l01595"></a>01595 {
<a name="l01596"></a>01596   <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *pfsal_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01597"></a>01597   <a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *pfile_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01598"></a>01598   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> xattr_id = 0;
<a name="l01599"></a>01599   <a class="code" href="structfsal__status____.html">fsal_status_t</a> fsal_status;
<a name="l01600"></a>01600 
<a name="l01601"></a>01601   <span class="comment">/* Get the FSAL Handle fo the current object */</span>
<a name="l01602"></a>01602   pfsal_handle = &amp;data-&gt;<a class="code" href="structcompoud__data.html#a68044da90b24d713271740a42f88838a">current_entry</a>-&gt;<a class="code" href="structcache__entry__t.html#aaa7abf75d0997dba12395a01c09be705">handle</a>;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604   <span class="comment">/* Get the xattr_id */</span>
<a name="l01605"></a>01605   pfile_handle = (<a class="code" href="structfile__handle__v4.html">file_handle_v4_t</a> *) (data-&gt;<a class="code" href="structcompoud__data.html#ab678a4d34551041e9b4ac9d2dfae4801">currentFH</a>.<a class="code" href="structnfs__fh4.html#a1bac9f2eb01597339d8c037776010a09">nfs_fh4_val</a>);
<a name="l01606"></a>01606 
<a name="l01607"></a>01607   <span class="comment">/* for Xattr FH, we adopt the current convention:</span>
<a name="l01608"></a>01608 <span class="comment">   * xattr_pos = 0 ==&gt; the FH is the one of the actual FS object</span>
<a name="l01609"></a>01609 <span class="comment">   * xattr_pos = 1 ==&gt; the FH is the one of the xattr ghost directory </span>
<a name="l01610"></a>01610 <span class="comment">   * xattr_pos &gt; 1 ==&gt; The FH is the one for the xattr ghost file whose xattr_id = xattr_pos -2 */</span>
<a name="l01611"></a>01611   xattr_id = pfile_handle-&gt;<a class="code" href="structfile__handle__v4.html#a2cb2790f0eda27f030b507981996da65">xattr_pos</a> - 2;
<a name="l01612"></a>01612 
<a name="l01613"></a>01613   fsal_status = <a class="code" href="fsal__glue_8c.html#a23c26b5ba4526252f2510d7c08b69f3a">FSAL_SetXAttrValueById</a>(pfsal_handle,
<a name="l01614"></a>01614                                        xattr_id,
<a name="l01615"></a>01615                                        data-&gt;<a class="code" href="structcompoud__data.html#a7e30266eb1770e922a88cb7b11ac7f01">pcontext</a>,
<a name="l01616"></a>01616                                        <a class="code" href="nfs4__xattr_8c.html#accff831137cce95c2acb6cf67d13cc5b">arg_WRITE4</a>.data.data_val,
<a name="l01617"></a>01617                                        <a class="code" href="nfs4__xattr_8c.html#accff831137cce95c2acb6cf67d13cc5b">arg_WRITE4</a>.data.data_len);
<a name="l01618"></a>01618 
<a name="l01619"></a>01619   <span class="keywordflow">if</span>(<a class="code" href="fsal_8h.html#a7c2a97ec2fa552dea8e497c7dd8a2b86">FSAL_IS_ERROR</a>(fsal_status))
<a name="l01620"></a>01620     {
<a name="l01621"></a>01621       <a class="code" href="nfs4__xattr_8c.html#aea1bf8859e2b84e5ba19941397275eca">res_WRITE4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aaf8c067759d4fef22cb97409d7a50c453">NFS4ERR_SERVERFAULT</a>;
<a name="l01622"></a>01622       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#aea1bf8859e2b84e5ba19941397275eca">res_WRITE4</a>.status;
<a name="l01623"></a>01623     }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625   <a class="code" href="nfs4__xattr_8c.html#aea1bf8859e2b84e5ba19941397275eca">res_WRITE4</a>.WRITE4res_u.resok4.committed = <a class="code" href="nfsv40_8h.html#a1f40221c0db0724d0664e71e04f11f8ea3d180de949d94206fcff93e2aca0e10f">FILE_SYNC4</a>;
<a name="l01626"></a>01626 
<a name="l01627"></a>01627   <a class="code" href="nfs4__xattr_8c.html#aea1bf8859e2b84e5ba19941397275eca">res_WRITE4</a>.WRITE4res_u.resok4.count = <a class="code" href="nfs4__xattr_8c.html#accff831137cce95c2acb6cf67d13cc5b">arg_WRITE4</a>.data.data_len;
<a name="l01628"></a>01628   memcpy(<a class="code" href="nfs4__xattr_8c.html#aea1bf8859e2b84e5ba19941397275eca">res_WRITE4</a>.WRITE4res_u.resok4.writeverf, <a class="code" href="nfs__core_8h.html#aba2f7cc065d516cd61fe9d1751df1aaf">NFS4_write_verifier</a>, <span class="keyword">sizeof</span>(<a class="code" href="nfsv40_8h.html#a11442bc5a79d08d82fa18205f01ae61d">verifier4</a>));
<a name="l01629"></a>01629 
<a name="l01630"></a>01630   <a class="code" href="nfs4__xattr_8c.html#aea1bf8859e2b84e5ba19941397275eca">res_WRITE4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01631"></a>01631 
<a name="l01632"></a>01632   <span class="keywordflow">return</span> <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01633"></a>01633 }                               <span class="comment">/* nfs4_op_write_xattr */</span>
<a name="l01634"></a>01634 
<a name="l01635"></a><a class="code" href="nfs4__xattr_8c.html#a8d99d173d72bbd4800adb26e9336c7e9">01635</a> <span class="preprocessor">#define arg_REMOVE4 op-&gt;nfs_argop4_u.opremove</span>
<a name="l01636"></a><a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">01636</a> <span class="preprocessor"></span><span class="preprocessor">#define res_REMOVE4 resp-&gt;nfs_resop4_u.opremove</span>
<a name="l01637"></a><a class="code" href="group__NFSprocs.html#ga228e6db52935a074d905402ce019aa39">01637</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="group__NFSprocs.html#ga228e6db52935a074d905402ce019aa39">nfs4_op_remove_xattr</a>(<span class="keyword">struct</span> <a class="code" href="structnfs__argop4.html">nfs_argop4</a> *op, <a class="code" href="structcompoud__data.html" title="Compound data.">compound_data_t</a> * data,
<a name="l01638"></a>01638                          <span class="keyword">struct</span> <a class="code" href="structnfs__resop4.html">nfs_resop4</a> *resp)
<a name="l01639"></a>01639 {
<a name="l01640"></a>01640   <a class="code" href="structfsal__status____.html">fsal_status_t</a> fsal_status;
<a name="l01641"></a>01641   <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2">cache_inode_status_t</a> cache_status;
<a name="l01642"></a>01642   <a class="code" href="structfsal__handle____.html">fsal_handle_t</a> *pfsal_handle = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01643"></a>01643   <a class="code" href="structfsal__name____.html">fsal_name_t</a> <a class="code" href="mount_8h.html#a2946c588fc7fa2fa5b43ac54b7872725">name</a>;
<a name="l01644"></a>01644 
<a name="l01645"></a>01645   <span class="comment">/* Check for name length */</span>
<a name="l01646"></a>01646   <span class="keywordflow">if</span>(<a class="code" href="nfs4__xattr_8c.html#a8d99d173d72bbd4800adb26e9336c7e9">arg_REMOVE4</a>.target.utf8string_len &gt; <a class="code" href="fsal__types_8h.html#ad026c47acb9681dca70066e06a9e6b50">FSAL_MAX_NAME_LEN</a>)
<a name="l01647"></a>01647     {
<a name="l01648"></a>01648       <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aa3514e6937072eb20f066bbc58992827a">NFS4ERR_NAMETOOLONG</a>;
<a name="l01649"></a>01649       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status;
<a name="l01650"></a>01650     }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652   <span class="comment">/* get the filename from the argument, it should not be empty */</span>
<a name="l01653"></a>01653   <span class="keywordflow">if</span>(<a class="code" href="nfs4__xattr_8c.html#a8d99d173d72bbd4800adb26e9336c7e9">arg_REMOVE4</a>.target.utf8string_len == 0)
<a name="l01654"></a>01654     {
<a name="l01655"></a>01655       <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacd5ac22a1fa5139d3566ed06c20d9c7a">NFS4ERR_INVAL</a>;
<a name="l01656"></a>01656       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status;
<a name="l01657"></a>01657     }
<a name="l01658"></a>01658 
<a name="l01659"></a>01659   <span class="comment">/* NFS4_OP_REMOVE can delete files as well as directory, it replaces NFS3_RMDIR and NFS3_REMOVE</span>
<a name="l01660"></a>01660 <span class="comment">   * because of this, we have to know if object is a directory or not */</span>
<a name="l01661"></a>01661   <span class="keywordflow">if</span>((cache_status =
<a name="l01662"></a>01662       <a class="code" href="cache__inode__misc_8c.html#aaa50487b9b403fd85b4a845de1a3df69" title="Converts an FSAL error to the corresponding cache_inode error.">cache_inode_error_convert</a>(<a class="code" href="group__FSALNameFunctions.html#ga46f91146c872ff335d8547f33203f3f7">FSAL_buffdesc2name</a>
<a name="l01663"></a>01663                                 ((<a class="code" href="structfsal__buffdesc____.html">fsal_buffdesc_t</a> *) &amp; <a class="code" href="nfs4__xattr_8c.html#a8d99d173d72bbd4800adb26e9336c7e9">arg_REMOVE4</a>.target,
<a name="l01664"></a>01664                                  &amp;name))) != <a class="code" href="cache__inode_8h.html#aa6929668cedf7463f35a22998b8e08d2a3fdbbb2367268ae84ac11d7b189643d8">CACHE_INODE_SUCCESS</a>)
<a name="l01665"></a>01665     {
<a name="l01666"></a>01666       <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status = <a class="code" href="group__NFSprocs.html#gae5dbdad76b79459bab895e61f800278d">nfs4_Errno</a>(cache_status);
<a name="l01667"></a>01667       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status;
<a name="l01668"></a>01668     }
<a name="l01669"></a>01669 
<a name="l01670"></a>01670   <span class="comment">/* Get the FSAL Handle fo the current object */</span>
<a name="l01671"></a>01671   pfsal_handle = &amp;data-&gt;<a class="code" href="structcompoud__data.html#a68044da90b24d713271740a42f88838a">current_entry</a>-&gt;<a class="code" href="structcache__entry__t.html#aaa7abf75d0997dba12395a01c09be705">handle</a>;
<a name="l01672"></a>01672 
<a name="l01673"></a>01673   <span class="comment">/* Test RM7: remiving &#39;.&#39; should return NFS4ERR_BADNAME */</span>
<a name="l01674"></a>01674   <span class="keywordflow">if</span>(!<a class="code" href="group__FSALNameFunctions.html#ga188880cdbe7d513d624c7b9861784ed5">FSAL_namecmp</a>(&amp;name, (<a class="code" href="structfsal__name____.html">fsal_name_t</a> *) &amp; FSAL_DOT)
<a name="l01675"></a>01675      || !<a class="code" href="group__FSALNameFunctions.html#ga188880cdbe7d513d624c7b9861784ed5">FSAL_namecmp</a>(&amp;name, (<a class="code" href="structfsal__name____.html">fsal_name_t</a> *) &amp; FSAL_DOT_DOT))
<a name="l01676"></a>01676     {
<a name="l01677"></a>01677       <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aa4aef55247db1a1390c8b8b62e3fd31ee">NFS4ERR_BADNAME</a>;
<a name="l01678"></a>01678       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status;
<a name="l01679"></a>01679     }
<a name="l01680"></a>01680 
<a name="l01681"></a>01681   fsal_status = <a class="code" href="fsal__glue_8c.html#ac901c70d37326e0142dd837ef982da1d">FSAL_RemoveXAttrByName</a>(pfsal_handle, data-&gt;<a class="code" href="structcompoud__data.html#a7e30266eb1770e922a88cb7b11ac7f01">pcontext</a>, &amp;name);
<a name="l01682"></a>01682   <span class="keywordflow">if</span>(<a class="code" href="fsal_8h.html#a7c2a97ec2fa552dea8e497c7dd8a2b86">FSAL_IS_ERROR</a>(fsal_status))
<a name="l01683"></a>01683     {
<a name="l01684"></a>01684       <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aaf8c067759d4fef22cb97409d7a50c453">NFS4ERR_SERVERFAULT</a>;
<a name="l01685"></a>01685       <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status;
<a name="l01686"></a>01686     }
<a name="l01687"></a>01687 
<a name="l01688"></a>01688   <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status = <a class="code" href="nfsv40_8h.html#aaef925ba78b4bc62effa8be298c23c0aacaca462c793854dd61337cf0b54fc166">NFS4_OK</a>;
<a name="l01689"></a>01689   <span class="keywordflow">return</span> <a class="code" href="nfs4__xattr_8c.html#aea41016bf84a5867a9adf61ab82b149d">res_REMOVE4</a>.status;
<a name="l01690"></a>01690 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 21 2012 for nfs-ganesha by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
